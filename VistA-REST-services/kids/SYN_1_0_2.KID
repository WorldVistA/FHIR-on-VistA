KIDS Distribution saved on May 08, 2019@23:19:28
OSEHRA kids build no 2
**KIDS**:SYNH*1.0*1^

**INSTALL NAME**
SYNH*1.0*1
"BLD",9711,0)
SYNH*1.0*1^^0^3190508^n
"BLD",9711,1,0)
^^2^2^3190214^^^^
"BLD",9711,1,1,0)
HealthConcourse plus synthetic data load build.
"BLD",9711,1,2,0)
Plus RGNET*
"BLD",9711,4,0)
^9.64PA^2002.1^3
"BLD",9711,4,996.5,0)
996.5
"BLD",9711,4,996.5,222)
y^y^f^^n^^y^o^n
"BLD",9711,4,996.52,0)
996.52
"BLD",9711,4,996.52,222)
y^y^f^^n^^y^o^n
"BLD",9711,4,2002.1,0)
2002.1
"BLD",9711,4,2002.1,222)
y^y^f^^n^^y^o^n
"BLD",9711,4,"B",996.5,996.5)

"BLD",9711,4,"B",996.52,996.52)

"BLD",9711,4,"B",2002.1,2002.1)

"BLD",9711,6.3)
53
"BLD",9711,"INI")
EN^SYNPRE1
"BLD",9711,"INID")
^n^n
"BLD",9711,"INIT")
EN^SYNGBLLD
"BLD",9711,"KRN",0)
^9.67PA^779.2^20
"BLD",9711,"KRN",.4,0)
.4
"BLD",9711,"KRN",.4,"NM",0)
^9.68A^^0
"BLD",9711,"KRN",.401,0)
.401
"BLD",9711,"KRN",.402,0)
.402
"BLD",9711,"KRN",.403,0)
.403
"BLD",9711,"KRN",.5,0)
.5
"BLD",9711,"KRN",.84,0)
.84
"BLD",9711,"KRN",3.6,0)
3.6
"BLD",9711,"KRN",3.8,0)
3.8
"BLD",9711,"KRN",9.2,0)
9.2
"BLD",9711,"KRN",9.8,0)
9.8
"BLD",9711,"KRN",9.8,"NM",0)
^9.68A^117^111
"BLD",9711,"KRN",9.8,"NM",1,0)
SYNDHP43^^0^B11341406
"BLD",9711,"KRN",9.8,"NM",2,0)
SYNDHP47^^0^B42834722
"BLD",9711,"KRN",9.8,"NM",3,0)
SYNDHP48^^0^B113334144
"BLD",9711,"KRN",9.8,"NM",4,0)
SYNDHP53^^0^B22563892
"BLD",9711,"KRN",9.8,"NM",5,0)
SYNDHP54^^0^B25313993
"BLD",9711,"KRN",9.8,"NM",6,0)
SYNDHP55^^0^B170944201
"BLD",9711,"KRN",9.8,"NM",7,0)
SYNDHP57^^0^B81356532
"BLD",9711,"KRN",9.8,"NM",8,0)
SYNDHP61^^0^B175435602
"BLD",9711,"KRN",9.8,"NM",9,0)
SYNDHP62^^0^B308344743
"BLD",9711,"KRN",9.8,"NM",10,0)
SYNDHP63^^0^B12371395
"BLD",9711,"KRN",9.8,"NM",11,0)
SYNDHP64^^0^B1748603
"BLD",9711,"KRN",9.8,"NM",12,0)
SYNDHP67^^0^B17235437
"BLD",9711,"KRN",9.8,"NM",13,0)
SYNDHP69^^0^B4950282
"BLD",9711,"KRN",9.8,"NM",14,0)
SYNDHP73^^0^B176773227
"BLD",9711,"KRN",9.8,"NM",15,0)
SYNDHP79^^0^B29692023
"BLD",9711,"KRN",9.8,"NM",16,0)
SYNDHP83^^0^B347144
"BLD",9711,"KRN",9.8,"NM",17,0)
SYNDHP89^^0^B401561
"BLD",9711,"KRN",9.8,"NM",18,0)
SYNDHPMAP^^0^B1254900
"BLD",9711,"KRN",9.8,"NM",20,0)
SYNDHPMP^^0^B33584325
"BLD",9711,"KRN",9.8,"NM",21,0)
SYNDHPPOS^^0^B1340966
"BLD",9711,"KRN",9.8,"NM",22,0)
SYNDHPPRV^^0^B335368
"BLD",9711,"KRN",9.8,"NM",23,0)
SYNFALG^^0^B126847670
"BLD",9711,"KRN",9.8,"NM",24,0)
SYNFALG2^^0^B58295470
"BLD",9711,"KRN",9.8,"NM",25,0)
SYNFAPT^^0^B89983171
"BLD",9711,"KRN",9.8,"NM",26,0)
SYNFCON^^0^B75078002
"BLD",9711,"KRN",9.8,"NM",27,0)
SYNFENC^^0^B161051849
"BLD",9711,"KRN",9.8,"NM",28,0)
SYNFGR^^0^B5992182
"BLD",9711,"KRN",9.8,"NM",29,0)
SYNFHIR^^0^B132718622
"BLD",9711,"KRN",9.8,"NM",30,0)
SYNFIMM^^0^B86411217
"BLD",9711,"KRN",9.8,"NM",31,0)
SYNFLAB^^0^B146417532
"BLD",9711,"KRN",9.8,"NM",32,0)
SYNFMED^^0^B217888743
"BLD",9711,"KRN",9.8,"NM",33,0)
SYNFMED2^^0^B111812418
"BLD",9711,"KRN",9.8,"NM",34,0)
SYNFMEDT^^0^B66688950
"BLD",9711,"KRN",9.8,"NM",35,0)
SYNFPAT^^0^B132681980
"BLD",9711,"KRN",9.8,"NM",36,0)
SYNFPR2^^0^B124320391
"BLD",9711,"KRN",9.8,"NM",37,0)
SYNFPRB^^0^B148551726
"BLD",9711,"KRN",9.8,"NM",38,0)
SYNFPUL^^0^B151812862
"BLD",9711,"KRN",9.8,"NM",39,0)
SYNFUTL^^0^B46964285
"BLD",9711,"KRN",9.8,"NM",40,0)
SYNFVF^^0^B37830226
"BLD",9711,"KRN",9.8,"NM",41,0)
SYNFVIT^^0^B133906664
"BLD",9711,"KRN",9.8,"NM",42,0)
SYNGRAPH^^0^B20344027
"BLD",9711,"KRN",9.8,"NM",43,0)
SYNINIT^^0^B143229486
"BLD",9711,"KRN",9.8,"NM",44,0)
SYNKIDS^^0^B91099127
"BLD",9711,"KRN",9.8,"NM",45,0)
SYNQLDM^^0^B141739825
"BLD",9711,"KRN",9.8,"NM",46,0)
SYNRGMON^^0^B2282303
"BLD",9711,"KRN",9.8,"NM",47,0)
SYNRGMON1^^0^B1845138
"BLD",9711,"KRN",9.8,"NM",48,0)
SYNVPR^^0^B140859789
"BLD",9711,"KRN",9.8,"NM",49,0)
SYNDHP56^^0^B92343991
"BLD",9711,"KRN",9.8,"NM",50,0)
SYNGBLLD^^0^B144653085
"BLD",9711,"KRN",9.8,"NM",51,0)
SYNDHP65^^0^B5073143
"BLD",9711,"KRN",9.8,"NM",52,0)
SYNFPROC^^0^B88197706
"BLD",9711,"KRN",9.8,"NM",53,0)
RGNETBAC^^0^B24620613
"BLD",9711,"KRN",9.8,"NM",54,0)
RGNETBAS^^0^B5697779
"BLD",9711,"KRN",9.8,"NM",55,0)
RGNETBEV^^0^B60190374
"BLD",9711,"KRN",9.8,"NM",56,0)
RGNETBIN^^0^B139662
"BLD",9711,"KRN",9.8,"NM",57,0)
RGNETBLG^^0^B10216441
"BLD",9711,"KRN",9.8,"NM",58,0)
RGNETBRK^^0^B6080317
"BLD",9711,"KRN",9.8,"NM",59,0)
RGNETBRP^^0^B64590541
"BLD",9711,"KRN",9.8,"NM",60,0)
RGNETBUT^^0^B38250970
"BLD",9711,"KRN",9.8,"NM",61,0)
RGNETOA^^0^B5024742
"BLD",9711,"KRN",9.8,"NM",62,0)
RGNETOAA^^0^B3929417
"BLD",9711,"KRN",9.8,"NM",63,0)
RGNETOAT^^0^B8374860
"BLD",9711,"KRN",9.8,"NM",64,0)
RGNETTCP^^0^B87620820
"BLD",9711,"KRN",9.8,"NM",65,0)
RGNETWRR^^0^B31409526
"BLD",9711,"KRN",9.8,"NM",66,0)
RGNETWWW^^0^B117759835
"BLD",9711,"KRN",9.8,"NM",67,0)
SYNDHP58^^0^B22472959
"BLD",9711,"KRN",9.8,"NM",68,0)
SYNDHP59^^0^B60059790
"BLD",9711,"KRN",9.8,"NM",72,0)
SYNDHP91^^0^B40944851
"BLD",9711,"KRN",9.8,"NM",73,0)
SYNDHPMU^^0^B9921526
"BLD",9711,"KRN",9.8,"NM",74,0)
SYNDHPUTL^^0^B31232465
"BLD",9711,"KRN",9.8,"NM",75,0)
SYNQOS5^^0^B31765838
"BLD",9711,"KRN",9.8,"NM",76,0)
SYNBSTS1^^0^B20431042
"BLD",9711,"KRN",9.8,"NM",77,0)
SYNDHPGEN^^0^B88669667
"BLD",9711,"KRN",9.8,"NM",78,0)
SYNFCP^^0^B312469407
"BLD",9711,"KRN",9.8,"NM",79,0)
SYNFHF^^0^B18591820
"BLD",9711,"KRN",9.8,"NM",80,0)
SYNFTIU^^0^B5720830
"BLD",9711,"KRN",9.8,"NM",82,0)
SYNDHP92^^0^B9874705
"BLD",9711,"KRN",9.8,"NM",83,0)
SYNFHIRU^^0^B98115799
"BLD",9711,"KRN",9.8,"NM",84,0)
SYNDHP99^^0^B15985554
"BLD",9711,"KRN",9.8,"NM",85,0)
SYNDHP10^^0^B79393775
"BLD",9711,"KRN",9.8,"NM",86,0)
SYNDHP11^^0^B65286288
"BLD",9711,"KRN",9.8,"NM",87,0)
SYNDHP12^^0^B125196184
"BLD",9711,"KRN",9.8,"NM",88,0)
SYNDHP13^^0^B130398518
"BLD",9711,"KRN",9.8,"NM",89,0)
SYNDHP14^^0^B68521679
"BLD",9711,"KRN",9.8,"NM",90,0)
SYNDHP15^^0^B159077808
"BLD",9711,"KRN",9.8,"NM",91,0)
SYNDHP16^^0^B128773413
"BLD",9711,"KRN",9.8,"NM",92,0)
SYNDHP17^^0^B47657021
"BLD",9711,"KRN",9.8,"NM",93,0)
SYNDHP18^^0^B118565363
"BLD",9711,"KRN",9.8,"NM",94,0)
SYNDHP19^^0^B43797002
"BLD",9711,"KRN",9.8,"NM",95,0)
SYNDHP20^^0^B137306202
"BLD",9711,"KRN",9.8,"NM",96,0)
SYNDHP01^^0^B22388996
"BLD",9711,"KRN",9.8,"NM",97,0)
SYNDHP02^^0^B18905167
"BLD",9711,"KRN",9.8,"NM",98,0)
SYNDHP06^^0^B14159682
"BLD",9711,"KRN",9.8,"NM",99,0)
SYNDHP07^^0^B20083819
"BLD",9711,"KRN",9.8,"NM",100,0)
SYNDHP08^^0^B14232287
"BLD",9711,"KRN",9.8,"NM",101,0)
SYNDHP09^^0^B50112432
"BLD",9711,"KRN",9.8,"NM",102,0)
SYNDHP03^^0^B23655386
"BLD",9711,"KRN",9.8,"NM",103,0)
SYNDHP04^^0^B11868381
"BLD",9711,"KRN",9.8,"NM",104,0)
SYNDHP05^^0^B117668361
"BLD",9711,"KRN",9.8,"NM",105,0)
SYNDHP21^^0^B55720482
"BLD",9711,"KRN",9.8,"NM",106,0)
SYNDHP40^^0^B22154311
"BLD",9711,"KRN",9.8,"NM",107,0)
SYNDHP41^^0^B11397025
"BLD",9711,"KRN",9.8,"NM",109,0)
SYNDHP22^^0^B41410082
"BLD",9711,"KRN",9.8,"NM",110,0)
SYNDHP23^^0^B15447210
"BLD",9711,"KRN",9.8,"NM",111,0)
SYNDTS89^^0^B37105881
"BLD",9711,"KRN",9.8,"NM",112,0)
SYNDHPIC^^0^B2165360
"BLD",9711,"KRN",9.8,"NM",113,0)
SYNTSTRS^^0^B106021021
"BLD",9711,"KRN",9.8,"NM",114,0)
SYNDHPTS1^^0^B11127832
"BLD",9711,"KRN",9.8,"NM",115,0)
SYNDHP24^^0^B129210012
"BLD",9711,"KRN",9.8,"NM",116,0)
SYNDHP25^^0^B68600664
"BLD",9711,"KRN",9.8,"NM",117,0)
SYNTSTAPI^^0^B11160876
"BLD",9711,"KRN",9.8,"NM","B","RGNETBAC",53)

"BLD",9711,"KRN",9.8,"NM","B","RGNETBAS",54)

"BLD",9711,"KRN",9.8,"NM","B","RGNETBEV",55)

"BLD",9711,"KRN",9.8,"NM","B","RGNETBIN",56)

"BLD",9711,"KRN",9.8,"NM","B","RGNETBLG",57)

"BLD",9711,"KRN",9.8,"NM","B","RGNETBRK",58)

"BLD",9711,"KRN",9.8,"NM","B","RGNETBRP",59)

"BLD",9711,"KRN",9.8,"NM","B","RGNETBUT",60)

"BLD",9711,"KRN",9.8,"NM","B","RGNETOA",61)

"BLD",9711,"KRN",9.8,"NM","B","RGNETOAA",62)

"BLD",9711,"KRN",9.8,"NM","B","RGNETOAT",63)

"BLD",9711,"KRN",9.8,"NM","B","RGNETTCP",64)

"BLD",9711,"KRN",9.8,"NM","B","RGNETWRR",65)

"BLD",9711,"KRN",9.8,"NM","B","RGNETWWW",66)

"BLD",9711,"KRN",9.8,"NM","B","SYNBSTS1",76)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP01",96)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP02",97)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP03",102)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP04",103)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP05",104)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP06",98)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP07",99)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP08",100)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP09",101)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP10",85)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP11",86)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP12",87)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP13",88)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP14",89)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP15",90)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP16",91)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP17",92)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP18",93)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP19",94)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP20",95)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP21",105)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP22",109)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP23",110)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP24",115)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP25",116)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP40",106)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP41",107)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP43",1)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP47",2)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP48",3)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP53",4)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP54",5)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP55",6)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP56",49)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP57",7)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP58",67)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP59",68)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP61",8)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP62",9)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP63",10)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP64",11)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP65",51)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP67",12)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP69",13)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP73",14)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP79",15)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP83",16)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP89",17)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP91",72)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP92",82)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHP99",84)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHPGEN",77)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHPIC",112)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHPMAP",18)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHPMP",20)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHPMU",73)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHPPOS",21)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHPPRV",22)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHPTS1",114)

"BLD",9711,"KRN",9.8,"NM","B","SYNDHPUTL",74)

"BLD",9711,"KRN",9.8,"NM","B","SYNDTS89",111)

"BLD",9711,"KRN",9.8,"NM","B","SYNFALG",23)

"BLD",9711,"KRN",9.8,"NM","B","SYNFALG2",24)

"BLD",9711,"KRN",9.8,"NM","B","SYNFAPT",25)

"BLD",9711,"KRN",9.8,"NM","B","SYNFCON",26)

"BLD",9711,"KRN",9.8,"NM","B","SYNFCP",78)

"BLD",9711,"KRN",9.8,"NM","B","SYNFENC",27)

"BLD",9711,"KRN",9.8,"NM","B","SYNFGR",28)

"BLD",9711,"KRN",9.8,"NM","B","SYNFHF",79)

"BLD",9711,"KRN",9.8,"NM","B","SYNFHIR",29)

"BLD",9711,"KRN",9.8,"NM","B","SYNFHIRU",83)

"BLD",9711,"KRN",9.8,"NM","B","SYNFIMM",30)

"BLD",9711,"KRN",9.8,"NM","B","SYNFLAB",31)

"BLD",9711,"KRN",9.8,"NM","B","SYNFMED",32)

"BLD",9711,"KRN",9.8,"NM","B","SYNFMED2",33)

"BLD",9711,"KRN",9.8,"NM","B","SYNFMEDT",34)

"BLD",9711,"KRN",9.8,"NM","B","SYNFPAT",35)

"BLD",9711,"KRN",9.8,"NM","B","SYNFPR2",36)

"BLD",9711,"KRN",9.8,"NM","B","SYNFPRB",37)

"BLD",9711,"KRN",9.8,"NM","B","SYNFPROC",52)

"BLD",9711,"KRN",9.8,"NM","B","SYNFPUL",38)

"BLD",9711,"KRN",9.8,"NM","B","SYNFTIU",80)

"BLD",9711,"KRN",9.8,"NM","B","SYNFUTL",39)

"BLD",9711,"KRN",9.8,"NM","B","SYNFVF",40)

"BLD",9711,"KRN",9.8,"NM","B","SYNFVIT",41)

"BLD",9711,"KRN",9.8,"NM","B","SYNGBLLD",50)

"BLD",9711,"KRN",9.8,"NM","B","SYNGRAPH",42)

"BLD",9711,"KRN",9.8,"NM","B","SYNINIT",43)

"BLD",9711,"KRN",9.8,"NM","B","SYNKIDS",44)

"BLD",9711,"KRN",9.8,"NM","B","SYNQLDM",45)

"BLD",9711,"KRN",9.8,"NM","B","SYNQOS5",75)

"BLD",9711,"KRN",9.8,"NM","B","SYNRGMON",46)

"BLD",9711,"KRN",9.8,"NM","B","SYNRGMON1",47)

"BLD",9711,"KRN",9.8,"NM","B","SYNTSTAPI",117)

"BLD",9711,"KRN",9.8,"NM","B","SYNTSTRS",113)

"BLD",9711,"KRN",9.8,"NM","B","SYNVPR",48)

"BLD",9711,"KRN",19,0)
19
"BLD",9711,"KRN",19,"NM",0)
^9.68A^^
"BLD",9711,"KRN",19.1,0)
19.1
"BLD",9711,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",9711,"KRN",101,0)
101
"BLD",9711,"KRN",101,"NM",0)
^9.68A^^
"BLD",9711,"KRN",409.61,0)
409.61
"BLD",9711,"KRN",771,0)
771
"BLD",9711,"KRN",779.2,0)
779.2
"BLD",9711,"KRN",870,0)
870
"BLD",9711,"KRN",8989.51,0)
8989.51
"BLD",9711,"KRN",8989.52,0)
8989.52
"BLD",9711,"KRN",8994,0)
8994
"BLD",9711,"KRN","B",.4,.4)

"BLD",9711,"KRN","B",.401,.401)

"BLD",9711,"KRN","B",.402,.402)

"BLD",9711,"KRN","B",.403,.403)

"BLD",9711,"KRN","B",.5,.5)

"BLD",9711,"KRN","B",.84,.84)

"BLD",9711,"KRN","B",3.6,3.6)

"BLD",9711,"KRN","B",3.8,3.8)

"BLD",9711,"KRN","B",9.2,9.2)

"BLD",9711,"KRN","B",9.8,9.8)

"BLD",9711,"KRN","B",19,19)

"BLD",9711,"KRN","B",19.1,19.1)

"BLD",9711,"KRN","B",101,101)

"BLD",9711,"KRN","B",409.61,409.61)

"BLD",9711,"KRN","B",771,771)

"BLD",9711,"KRN","B",779.2,779.2)

"BLD",9711,"KRN","B",870,870)

"BLD",9711,"KRN","B",8989.51,8989.51)

"BLD",9711,"KRN","B",8989.52,8989.52)

"BLD",9711,"KRN","B",8994,8994)

"BLD",9711,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",9711,"QUES",0)
^9.62^^
"BLD",9711,"REQB",0)
^9.611^^
"DATA",996.5,1,0)
HTTP ENDPOINT^8001^VEHU^0
"DATA",996.5,1,10)
NETSERV^RGNETWWW
"DATA",996.52,1,0)
CWF/*^GET
"DATA",996.52,1,10)
MGET^RGSER
"DATA",996.52,2,0)
DSTU#/*^GET^BASIC
"DATA",996.52,2,10)
MGET^RGSER
"DATA",996.52,3,0)
QVXTM/*^GET
"DATA",996.52,3,10)
PATVAL^SYNDHP73
"DATA",996.52,4,0)
oauth2/authorize^GET
"DATA",996.52,4,10)
MGET^RGNETOAA
"DATA",996.52,5,0)
oauth2/token^POST
"DATA",996.52,5,10)
MPOST^RGNETOAT
"DATA",996.52,6,0)
/^GET
"DATA",996.52,6,10)
GREETING^RGNETWWW
"DATA",996.52,6,99,0)
^996.52099^1^1^3150330.181114
"DATA",996.52,6,99,1,0)
This is the root endpoint for this service.
"DATA",996.52,7,0)
UTILITY/RTN^GET^BASIC
"DATA",996.52,7,10)
RTN^RGNETWRR
"DATA",996.52,8,0)
UTILITY/RPC^GET^BASIC
"DATA",996.52,8,10)
RPC^RGNETWRR
"DATA",996.52,9,0)
QVXTM/QVXTM^GET
"DATA",996.52,9,10)
PATVAL^SYNDHP73
"DATA",996.52,11,0)
DHPPATDEM/*^GET
"DATA",996.52,11,10)
PATDEM^SYNDHP73
"DATA",996.52,12,0)
DHPPATCON/*^GET
"DATA",996.52,12,10)
PATCON^SYNDHP73
"DATA",996.52,16,0)
DHPPATVIT/*^GET
"DATA",996.52,16,10)
PATVIT^SYNDHP73
"DATA",996.52,22,0)
DHPPATPRC/*^GET
"DATA",996.52,22,10)
PATPRC^SYNDHP73
"DATA",996.52,25,0)
DHPPATLAB^GET
"DATA",996.52,25,10)
PATLAB^SYNDHP73
"DATA",996.52,26,0)
DHPPATLABICN^GET
"DATA",996.52,26,10)
PATLABI^SYNDHP73
"DATA",996.52,26,99,0)
^^1^1^3190403^
"DATA",996.52,26,99,1,0)
Get patient laboratory tests
"DATA",996.52,27,0)
DHPPATPRVICN^GET
"DATA",996.52,27,10)
PATPRVI^SYNDHP73
"DATA",996.52,27,99,0)
^^1^1^3190403^
"DATA",996.52,27,99,1,0)
Get patient providers
"DATA",996.52,28,0)
DHPHLOCINSTHLOCNAM^GET
"DATA",996.52,28,10)
HLOCINST^SYNDHP73
"DATA",996.52,28,99,0)
^^1^1^3190403^
"DATA",996.52,28,99,1,0)
Get hospital location information
"DATA",996.52,29,0)
DHPPATAPTICN^GET
"DATA",996.52,29,10)
PATAPTI^SYNDHP73
"DATA",996.52,29,99,0)
^^1^1^3190403^
"DATA",996.52,29,99,1,0)
Get patient appointments
"DATA",996.52,30,0)
DHPPATFLGICN^GET
"DATA",996.52,30,10)
PATFLGI^SYNDHP73
"DATA",996.52,30,99,0)
^^1^1^3190403^
"DATA",996.52,30,99,1,0)
Get patient flags
"DATA",996.52,33,0)
DHPPATIMMICN^GET
"DATA",996.52,33,10)
PATIMMI^SYNDHP73
"DATA",996.52,33,99,0)
^^1^1^3190403^
"DATA",996.52,33,99,1,0)
Get patient immunizations
"DATA",996.52,35,0)
DHPPATGOLICN^GET
"DATA",996.52,35,10)
PATGOLI^SYNDHP73
"DATA",996.52,35,99,0)
^^1^1^3190403^
"DATA",996.52,35,99,1,0)
Get patient nursing care plans
"DATA",996.52,40,0)
DHPPATHLF^GET
"DATA",996.52,40,10)
PATHLF^SYNDHP73
"DATA",996.52,41,0)
DHPPATHLFINC^GET
"DATA",996.52,41,10)
PATHLFI^SYNDHP73
"DATA",996.52,41,99,0)
^^1^1^3190403^
"DATA",996.52,41,99,1,0)
Get patient health factors
"DATA",996.52,42,0)
DHPPATHLFICN^GET
"DATA",996.52,42,10)
PATHLFI^SYNDHP73
"DATA",996.52,42,99,0)
^^1^1^3190403^
"DATA",996.52,42,99,1,0)
Get patient health factors
"DATA",996.52,43,0)
DHPMAPSVC^GET
"DATA",996.52,43,10)
MAPSVC^SYNDHP73
"DATA",996.52,43,99,0)
^^1^1^3190403^
"DATA",996.52,43,99,1,0)
Terminology mapping service
"DATA",996.52,44,0)
DHPPATTIUICN^GET
"DATA",996.52,44,10)
PATTIUI^SYNDHP73
"DATA",996.52,44,99,0)
^^1^1^3190403^
"DATA",996.52,44,99,1,0)
Get patient notes
"DATA",996.52,45,0)
SYNGLOBAL^GET
"DATA",996.52,45,10)
wsGLOBAL^SYNVPR
"DATA",996.52,46,0)
SYNLOADSTAT^GET
"DATA",996.52,47,0)
DHPPATOBS^GET
"DATA",996.52,47,10)
PATOBS^SYNDHP73
"DATA",996.52,48,0)
DHPPATOBSICN^GET
"DATA",996.52,48,10)
PATOBSI^SYNDHP73
"DATA",996.52,48,99,0)
^^1^1^3190403^
"DATA",996.52,48,99,1,0)
Get patient observations
"DATA",996.52,49,0)
DHPCARETEAM^GET
"DATA",996.52,49,10)
CARETEAM^SYNDHP73
"DATA",996.52,49,99,0)
^^1^1^3190403^
"DATA",996.52,49,99,1,0)
Get one care team
"DATA",996.52,50,0)
DHPCARETEAMS^GET
"DATA",996.52,50,10)
CARETEAMS^SYNDHP73
"DATA",996.52,50,99,0)
^^1^1^3190403^
"DATA",996.52,50,99,1,0)
Get all care teams
"DATA",996.52,51,0)
DHPPATCP^GET
"DATA",996.52,51,10)
PATCP^SYNDHP73
"DATA",996.52,52,0)
DHPPATCPI^GET
"DATA",996.52,52,10)
PATCPI^SYNDHP73
"DATA",996.52,52,99,0)
^^1^1^3190403^
"DATA",996.52,52,99,1,0)
Get patient care plan(s) for a visit
"DATA",996.52,53,0)
DHPPATCPALL^GET
"DATA",996.52,53,10)
PATCPALL^SYNDHP73
"DATA",996.52,54,0)
DHPPATCPALLI^GET
"DATA",996.52,54,10)
PATCPALLI^SYNDHP73
"DATA",996.52,54,99,0)
^^1^1^3190403^
"DATA",996.52,54,99,1,0)
Get patient care plans
"DATA",996.52,55,0)
DHPPATIMMUPD^POST
"DATA",996.52,55,10)
PATIMUSV^SYNDHP79
"DATA",996.52,55,99,0)
^^1^1^3181130^
"DATA",996.52,55,99,1,0)
Update patient immunizations
"DATA",996.52,56,0)
DHPPATAPTCRE^POST
"DATA",996.52,56,10)
PATAPTCR^SYNDHP79
"DATA",996.52,56,99,0)
^^1^1^3181130^
"DATA",996.52,56,99,1,0)
Create patient appointment
"DATA",996.52,57,0)
DHPPATAPTCI^POST
"DATA",996.52,57,10)
PATAPTCI^SYNDHP79
"DATA",996.52,57,99,0)
^^1^1^3181130^
"DATA",996.52,57,99,1,0)
Check-in patient appointment
"DATA",996.52,58,0)
DHPPATLABUPD^POST
"DATA",996.52,58,10)
PATLABSV^SYNDHP79
"DATA",996.52,58,99,0)
^^1^1^3181130^
"DATA",996.52,58,99,1,0)
Update patient lab results
"DATA",996.52,59,0)
DHPSYSFACUPD^POST
"DATA",996.52,59,10)
SYSFAC^SYNDHP79
"DATA",996.52,60,0)
DHPSYSFACGET^GET
"DATA",996.52,60,10)
SYSFAC^SYNDHP73
"DATA",996.52,61,0)
DHPGETRESID^GET
"DATA",996.52,61,10)
GETRESID^SYNDHP73
"DATA",996.52,61,99,0)
^996.52099^1^1^3190207^^
"DATA",996.52,61,99,1,0)
Get the VistA record for a resource ID
"DATA",996.52,62,0)
DHPVPRLOGRST^GET
"DATA",996.52,62,10)
LOGRST^SYNDHP73
"DATA",996.52,63,0)
DHPPATVAL^GET
"DATA",996.52,63,10)
PATVAL^SYNDHP73
"DATA",996.52,63,99,0)
^^1^1^3190403^
"DATA",996.52,63,99,1,0)
Validate a patient and return ICN
"DATA",996.52,64,0)
DHPPATCONICN^GET
"DATA",996.52,64,10)
PATCONI^SYNDHP73
"DATA",996.52,64,99,0)
^^1^1^3190403^
"DATA",996.52,64,99,1,0)
Get patient conditions/problems
"DATA",996.52,65,0)
DHPPATDEMICN^GET
"DATA",996.52,65,10)
PATDEMI^SYNDHP73
"DATA",996.52,65,99,0)
^^1^1^3190403^
"DATA",996.52,65,99,1,0)
Get patient demographics
"DATA",996.52,66,0)
DHPPATS4CON^GET
"DATA",996.52,66,10)
PATCONAL^SYNDHP73
"DATA",996.52,66,99,0)
^^1^1^3190403^
"DATA",996.52,66,99,1,0)
Get patients with a condition/problem
"DATA",996.52,67,0)
DHPPATVITICN^GET
"DATA",996.52,67,10)
PATVITI^SYNDHP73
"DATA",996.52,67,99,0)
^^1^1^3190403^
"DATA",996.52,67,99,1,0)
Get patient vitals
"DATA",996.52,68,0)
DHPPATENCICN^GET
"DATA",996.52,68,10)
PATENCI^SYNDHP73
"DATA",996.52,68,99,0)
^^1^1^3190403^
"DATA",996.52,68,99,1,0)
Get patient encounters
"DATA",996.52,69,0)
DHPPATMEDSICN^GET
"DATA",996.52,69,10)
PATMEDS^SYNDHP73
"DATA",996.52,69,99,0)
^^1^1^3190403^
"DATA",996.52,69,99,1,0)
Get patient medication statement
"DATA",996.52,70,0)
DHPPATMEDDICN^GET
"DATA",996.52,70,10)
PATMEDD^SYNDHP73
"DATA",996.52,70,99,0)
^^1^1^3190403^
"DATA",996.52,70,99,1,0)
Get patient medication dispensed
"DATA",996.52,71,0)
DHPPATMEDAICN^GET
"DATA",996.52,71,10)
PATMEDA^SYNDHP73
"DATA",996.52,71,99,0)
^^1^1^3190403^
"DATA",996.52,71,99,1,0)
Get patient medication administration
"DATA",996.52,72,0)
DHPPATPRCICN^GET
"DATA",996.52,72,10)
PATPRCI^SYNDHP73
"DATA",996.52,72,99,0)
^^1^1^3190403^
"DATA",996.52,72,99,1,0)
Get patient procedures
"DATA",996.52,73,0)
DHPPATVITUPD^POST
"DATA",996.52,73,10)
PATVITSV^SYNDHP79
"DATA",996.52,73,99,0)
^996.52099^1^1^3190403^^
"DATA",996.52,73,99,1,0)
Update patient vitals
"DATA",996.52,74,0)
DHPPATDEMALL^GET
"DATA",996.52,74,10)
PATDEMAL^SYNDHP73
"DATA",996.52,74,99,0)
^^1^1^3190403^
"DATA",996.52,74,99,1,0)
Get all patients' demographics
"DATA",996.52,75,0)
DHPPATALLICN^GET
"DATA",996.52,75,10)
PATALLI^SYNDHP73
"DATA",996.52,75,99,0)
^^1^1^3190403^
"DATA",996.52,75,99,1,0)
Get patient allergies
"DATA",996.52,76,0)
DHPPATVITPST^POST
"DATA",996.52,76,10)
PATVITSV^SYNDHP79
"DATA",996.52,76,99,0)
^^1^1^3190403^
"DATA",996.52,76,99,1,0)
Update patient vitals
"DATA",996.52,77,0)
DHPPATPRBUPD^POST
"DATA",996.52,77,10)
PATPRBSV^SYNDHP79
"DATA",996.52,77,99,0)
^^1^1^3190403^
"DATA",996.52,77,99,1,0)
Update patient conditions/problems
"DATA",996.52,78,0)
DHPPATDEMUPD^POST
"DATA",996.52,78,10)
PATDEMSV^SYNDHP79
"DATA",996.52,78,99,0)
^^1^1^3190403^
"DATA",996.52,78,99,1,0)
Update patient demographics
"DATA",996.52,79,0)
DHPPATDXRICN^GET
"DATA",996.52,79,10)
PATDXREP^SYNDHP73
"DATA",996.52,79,99,0)
^^1^1^3190403^
"DATA",996.52,79,99,1,0)
Get patient diagnostic reports
"DATA",996.52,80,0)
DHPPATDEMRNG^GET
"DATA",996.52,80,10)
PATDEMRG^SYNDHP73
"DATA",996.52,80,99,0)
^^1^1^3190403^
"DATA",996.52,80,99,1,0)
Get range of patients' demographics
"DATA",996.52,81,0)
ZZATTESTLAB^GET
"DATA",996.52,81,10)
PATLABS^ZZATLABS
"DATA",996.52,82,0)
DHPPATICNALL^GET
"DATA",996.52,82,10)
PATICNS^SYNDHP73
"DATA",996.52,82,99,0)
^^1^1^3190403^
"DATA",996.52,82,99,1,0)
Get ICNs for all patients
"DATA",2002.1,1,0)
http://localhost:8001/DHPPATALLICN^F
"DATA",2002.1,2,0)
http://localhost:8001/DHPPATALLICN?ICN=10111V153702^F
"DATA",2002.1,3,0)
http://localhost:8001/DHPPATALLICN?ICN=10111V183702^P
"DATA",2002.1,4,0)
http://localhost:8001/DHPPATALLICN?ICN=10111V183702&FRDAT=20060101&TODAT=20050101^F
"DATA",2002.1,5,0)
http://localhost:8001/DHPPATALLICN?ICN=10111V183702&FRDAT=20000101&TODAT=20050101^P
"DATA",2002.1,6,0)
http://localhost:8001/DHPPATALLICN?ICN=1435855215V947437^P
"DATA",2002.1,7,0)
http://localhost:8001/DHPPATALLICN?JSON=J^F
"DATA",2002.1,8,0)
http://localhost:8001/DHPPATALLICN?ICN=10111V153702&JSON=J^F
"DATA",2002.1,9,0)
http://localhost:8001/DHPPATALLICN?ICN=10111V183702&JSON=J^P
"DATA",2002.1,10,0)
http://localhost:8001/DHPPATALLICN?ICN=10111V183702&FRDAT=20060101&TODAT=20050101&JSON=J^F
"DATA",2002.1,11,0)
http://localhost:8001/DHPPATALLICN?ICN=10111V183702&FRDAT=20000101&TODAT=20050101&JSON=J^P
"DATA",2002.1,12,0)
http://localhost:8001/DHPPATALLICN?ICN=1435855215V947437&JSON=J^P
"DATA",2002.1,13,0)
http://localhost:8001/DHPPATAPTICN^F
"DATA",2002.1,14,0)
http://localhost:8001/DHPPATAPTICN?ICN=1198453374V588739^F
"DATA",2002.1,15,0)
http://localhost:8001/DHPPATAPTICN?ICN=1198013374V588739^P
"DATA",2002.1,16,0)
http://localhost:8001/DHPPATAPTICN?ICN=10111V183702^P
"DATA",2002.1,17,0)
http://localhost:8001/DHPPATAPTICN?ICN=1198013374V588739&FRDAT=20070101&TODAT=20050101^F
"DATA",2002.1,18,0)
http://localhost:8001/DHPPATAPTICN?ICN=1198013374V588739&FRDAT=20110101&TODAT=20150101^P
"DATA",2002.1,19,0)
http://localhost:8001/DHPPATAPTICN?ICN=10111V183702&FRDAT=20050101^P
"DATA",2002.1,20,0)
http://localhost:8001/DHPPATCONICN^F
"DATA",2002.1,21,0)
http://localhost:8001/DHPPATCONICN?ICN=2677504935V204585^F
"DATA",2002.1,22,0)
http://localhost:8001/DHPPATCONICN?ICN=2676604935V204585^P
"DATA",2002.1,23,0)
http://localhost:8001/DHPPATCONICN?ICN=5000001533V676621^P
"DATA",2002.1,24,0)
http://localhost:8001/DHPPATCONICN?ICN=10112V399621^P
"DATA",2002.1,25,0)
http://localhost:8001/DHPPATCONICN?ICN=10112V399621&FRDAT=20070101&TODAT=20051231^F
"DATA",2002.1,26,0)
http://localhost:8001/DHPPATCONICN?ICN=10112V399621&FRDAT=20000101&TODAT=20051231^P
"DATA",2002.1,27,0)
http://localhost:8001/DHPPATS4CON^F
"DATA",2002.1,28,0)
http://localhost:8001/DHPPATS4CON?SCT=99^F
"DATA",2002.1,29,0)
http://localhost:8001/DHPPATS4CON?SCT=10509002^P
"DATA",2002.1,30,0)
http://localhost:8001/DHPPATS4CON?SCT=47505003^P
"DATA",2002.1,31,0)
http://localhost:8001/DHPPATCPALLI^F
"DATA",2002.1,32,0)
http://localhost:8001/DHPPATCPALLI?ICN=2434634569V691690^F
"DATA",2002.1,33,0)
http://localhost:8001/DHPPATCPALLI?ICN=2434609669V691690^P
"DATA",2002.1,34,0)
http://localhost:8001/DHPPATCPALLI?ICN=5000001533V676621^P
"DATA",2002.1,35,0)
http://localhost:8001/DHPPATCPALLI?ICN=1435855215V947437^P
"DATA",2002.1,36,0)
http://localhost:8001/DHPPATCPALLI?ICN=1435855215V947437&FRDAT=20130101&TODAT=20120101^F
"DATA",2002.1,37,0)
http://localhost:8001/DHPPATCPALLI?ICN=1435855215V947437&FRDAT=20000101&TODAT=20120101^P
"DATA",2002.1,38,0)
http://localhost:8001/DHPPATCPALLI?JSON=J^F
"DATA",2002.1,39,0)
http://localhost:8001/DHPPATCPALLI?ICN=2434634569V691690&JSON=J^F
"DATA",2002.1,40,0)
http://localhost:8001/DHPPATCPALLI?ICN=2434609669V691690&JSON=J^P
"DATA",2002.1,41,0)
http://localhost:8001/DHPPATCPALLI?ICN=5000001533V676621&JSON=J^P
"DATA",2002.1,42,0)
http://localhost:8001/DHPPATCPALLI?ICN=1435855215V947437&JSON=J^P
"DATA",2002.1,43,0)
http://localhost:8001/DHPPATCPALLI?ICN=1435855215V947437&FRDAT=20130101&TODAT=20120101&JSON=J^F
"DATA",2002.1,44,0)
http://localhost:8001/DHPPATCPALLI?ICN=1435855215V947437&FRDAT=20000101&TODAT=20120101&JSON=J^P
"DATA",2002.1,45,0)
http://localhost:8001/DHPPATCPI?VRESID=V_500_1000010_34486^F
"DATA",2002.1,46,0)
http://localhost:8001/DHPPATCPI?ICN=2434609669V691690^F
"DATA",2002.1,47,0)
http://localhost:8001/DHPPATCPI?ICN=2434609669V622290&VRESID=V_500_1000010_34486^F
"DATA",2002.1,48,0)
http://localhost:8001/DHPPATCPI?ICN=2434609669V691690&VRESID=V_500_1000010_34486^P
"DATA",2002.1,49,0)
http://localhost:8001/DHPPATCPI?ICN=5000001533V676621&VRESID=V_500_1000010_34486^P
"DATA",2002.1,50,0)
http://localhost:8001/DHPPATCPI?VRESID=V_500_1000010_34486&JSON=J^F
"DATA",2002.1,51,0)
http://localhost:8001/DHPPATCPI?ICN=2434609669V691690&JSON=J^F
"DATA",2002.1,52,0)
http://localhost:8001/DHPPATCPI?ICN=2434609669V333690&VRESID=V_500_1000010_34486&JSON=J^F
"DATA",2002.1,53,0)
http://localhost:8001/DHPPATCPI?ICN=2434609669V691690&VRESID=V_500_1000010_34486&JSON=J^P
"DATA",2002.1,54,0)
http://localhost:8001/DHPPATCPI?ICN=5000001533V676621&VRESID=V_500_1000010_34486&JSON=J^P
"DATA",2002.1,55,0)
http://localhost:8001/DHPPATDEMICN^F
"DATA",2002.1,56,0)
http://localhost:8001/DHPPATDEMICN?ICN=1705550833V176438^F
"DATA",2002.1,57,0)
http://localhost:8001/DHPPATDEMICN?ICN=1703280833V176438^P
"DATA",2002.1,58,0)
http://localhost:8001/DHPPATDEMICN?ICN=5000001533V676621^P
"DATA",2002.1,59,0)
http://localhost:8001/DHPPATDEMICN?JSON=J^F
"DATA",2002.1,60,0)
http://localhost:8001/DHPPATDEMICN?ICN=2803777648V106941&JSON=J^F
"DATA",2002.1,61,0)
http://localhost:8001/DHPPATDEMICN?ICN=2803239648V106941&JSON=J^P
"DATA",2002.1,62,0)
http://localhost:8001/DHPPATDEMICN?ICN=5000001533V676621&JSON=J^P
"DATA",2002.1,63,0)
http://localhost:8001/DHPPATDXRICN^F
"DATA",2002.1,64,0)
http://localhost:8001/DHPPATDXRICN?ICN=11111V964144^F
"DATA",2002.1,65,0)
http://localhost:8001/DHPPATDXRICN?ICN=10101V964144^P
"DATA",2002.1,66,0)
http://localhost:8001/DHPPATDXRICN?ICN=10101V964144&FRDAT=20120101&TODAT=20100101^F
"DATA",2002.1,67,0)
http://localhost:8001/DHPPATDXRICN?ICN=10101V964144&FRDAT=20000101&TODAT=20100101^P
"DATA",2002.1,68,0)
http://localhost:8001/DHPPATDXRICN?ICN=2434609669V691690^P
"DATA",2002.1,69,0)
http://localhost:8001/DHPPATDXRICN?JSON=J^F
"DATA",2002.1,70,0)
http://localhost:8001/DHPPATDXRICN?ICN=11111V964144&JSON=J^F
"DATA",2002.1,71,0)
http://localhost:8001/DHPPATDXRICN?ICN=10101V964144&JSON=J^P
"DATA",2002.1,72,0)
http://localhost:8001/DHPPATDXRICN?ICN=10101V964144&FRDAT=20120101&TODAT=20100101&JSON=J^F
"DATA",2002.1,73,0)
http://localhost:8001/DHPPATDXRICN?ICN=10101V964144&FRDAT=20000101&TODAT=20100101&JSON=J^P
"DATA",2002.1,74,0)
http://localhost:8001/DHPPATDXRICN?ICN=2434609669V691690&JSON=J^P
"DATA",2002.1,75,0)
http://localhost:8001/DHPPATENCICN^F
"DATA",2002.1,76,0)
http://localhost:8001/DHPPATENCICN?ICN=2676604935V204555^F
"DATA",2002.1,77,0)
http://localhost:8001/DHPPATENCICN?ICN=2676604935V204585^P
"DATA",2002.1,78,0)
http://localhost:8001/DHPPATENCICN?ICN=2434609669V691690^P
"DATA",2002.1,79,0)
http://localhost:8001/DHPPATENCICN?ICN=5000000109V646500^P
"DATA",2002.1,80,0)
http://localhost:8001/DHPPATENCICN?ICN=5000000109V646500&FRDAT=20151001&TODAT=20141031^F
"DATA",2002.1,81,0)
http://localhost:8001/DHPPATENCICN?ICN=5000000109V646500&FRDAT=20151001&TODAT=20151031^P
"DATA",2002.1,82,0)
http://localhost:8001/DHPPATFLGICN^F
"DATA",2002.1,83,0)
http://localhost:8001/DHPPATFLGICN?ICN=10118V588553^F
"DATA",2002.1,84,0)
http://localhost:8001/DHPPATFLGICN?ICN=10118V572553^P
"DATA",2002.1,85,0)
http://localhost:8001/DHPPATFLGICN?ICN=2434609669V691690^P
"DATA",2002.1,86,0)
http://localhost:8001/DHPPATFLGICN?JSON=J^F
"DATA",2002.1,87,0)
http://localhost:8001/DHPPATFLGICN?ICN=10118V588553&JSON=J^F
"DATA",2002.1,88,0)
http://localhost:8001/DHPPATFLGICN?ICN=10118V572553&JSON=J^P
"DATA",2002.1,89,0)
http://localhost:8001/DHPPATFLGICN?ICN=2434609669V691690&JSON=J^P
"DATA",2002.1,90,0)
http://localhost:8001/DHPPATGOLICN^F
"DATA",2002.1,91,0)
http://localhost:8001/DHPPATGOLICN?ICN=1964446818V742124^F
"DATA",2002.1,92,0)
http://localhost:8001/DHPPATGOLICN?ICN=1967316818V742124^P
"DATA",2002.1,93,0)
http://localhost:8001/DHPPATGOLICN?ICN=1967316818V742124&FRDAT=20151001&TODAT=20141031^F
"DATA",2002.1,94,0)
http://localhost:8001/DHPPATGOLICN?ICN=1967316818V742124&FRDAT=19930220^P
"DATA",2002.1,95,0)
http://localhost:8001/DHPPATGOLICN?ICN=1967316818V742124&TODAT=19930220^P
"DATA",2002.1,96,0)
http://localhost:8001/DHPPATGOLICN?ICN=2434609669V691690^P
"DATA",2002.1,97,0)
http://localhost:8001/DHPPATGOLICN?JSON=J^F
"DATA",2002.1,98,0)
http://localhost:8001/DHPPATGOLICN?ICN=1964446818V742124&JSON=J^F
"DATA",2002.1,99,0)
http://localhost:8001/DHPPATGOLICN?ICN=1967316818V742124&JSON=J^P
"DATA",2002.1,100,0)
http://localhost:8001/DHPPATGOLICN?ICN=1967316818V742124&FRDAT=20151001&TODAT=20141031&JSON=J^F
"DATA",2002.1,101,0)
http://localhost:8001/DHPPATGOLICN?ICN=1967316818V742124&FRDAT=19930220&JSON=J^P
"DATA",2002.1,102,0)
http://localhost:8001/DHPPATGOLICN?ICN=1967316818V742124&TODAT=19930220&JSON=J^P
"DATA",2002.1,103,0)
http://localhost:8001/DHPPATGOLICN?ICN=2434609669V691690&JSON=J^P
"DATA",2002.1,104,0)
http://localhost:8001/DHPPATHLFICN^F
"DATA",2002.1,105,0)
http://localhost:8001/DHPPATHLFICN?ICN=5006601536V889384^F
"DATA",2002.1,106,0)
http://localhost:8001/DHPPATHLFICN?ICN=5000001536V889384^P
"DATA",2002.1,107,0)
http://localhost:8001/DHPPATHLFICN?ICN=2434609669V691690^P
"DATA",2002.1,108,0)
http://localhost:8001/DHPPATHLFICN?ICN=10101V964144^P
"DATA",2002.1,109,0)
http://localhost:8001/DHPPATHLFICN?ICN=10101V964144&FRDAT=20131101&TODAT=20131028^F
"DATA",2002.1,110,0)
http://localhost:8001/DHPPATHLFICN?ICN=10101V964144&FRDAT=20131001&TODAT=20131028^P
"DATA",2002.1,111,0)
http://localhost:8001/DHPPATHLFICN?JSON=J^F
"DATA",2002.1,112,0)
http://localhost:8001/DHPPATHLFICN?ICN=5006601536V889384&JSON=J^F
"DATA",2002.1,113,0)
http://localhost:8001/DHPPATHLFICN?ICN=5000001536V889384&JSON=J^P
"DATA",2002.1,114,0)
http://localhost:8001/DHPPATHLFICN?ICN=2434609669V691690&JSON=J^P
"DATA",2002.1,115,0)
http://localhost:8001/DHPPATHLFICN?ICN=10101V964144&JSON=J^P
"DATA",2002.1,116,0)
http://localhost:8001/DHPPATHLFICN?ICN=10101V964144&FRDAT=20131101&TODAT=20131028&JSON=J^F
"DATA",2002.1,117,0)
http://localhost:8001/DHPPATHLFICN?ICN=10101V964144&FRDAT=20131001&TODAT=20131028&JSON=J^P
"DATA",2002.1,118,0)
http://localhost:8001/DHPPATIMMICN^F
"DATA",2002.1,119,0)
http://localhost:8001/DHPPATIMMICN?ICN=1345112108V473342^F
"DATA",2002.1,120,0)
http://localhost:8001/DHPPATIMMICN?ICN=1345112108V472042^P
"DATA",2002.1,121,0)
http://localhost:8001/DHPPATIMMICN?ICN=1345112108V472042&FRDAT=20140101&TODAT=20131231^F
"DATA",2002.1,122,0)
http://localhost:8001/DHPPATIMMICN?ICN=1345112108V472042&FRDAT=20120101&TODAT=20131231^P
"DATA",2002.1,123,0)
http://localhost:8001/DHPPATIMMICN?ICN=10110V004877^P
"DATA",2002.1,124,0)
http://localhost:8001/DHPPATIMMICN?JSON=J^F
"DATA",2002.1,125,0)
http://localhost:8001/DHPPATIMMICN?ICN=1345112108V473342&JSON=J^F
"DATA",2002.1,126,0)
http://localhost:8001/DHPPATIMMICN?ICN=1345112108V472042&JSON=J^P
"DATA",2002.1,127,0)
http://localhost:8001/DHPPATIMMICN?ICN=10110V004877&JSON=J^P
"DATA",2002.1,128,0)
http://localhost:8001/DHPPATIMMICN?ICN=1345112108V472042&FRDAT=20140101&TODAT=20131231&JSON=J^F
"DATA",2002.1,129,0)
http://localhost:8001/DHPPATIMMICN?ICN=1345112108V472042&FRDAT=20120101&TODAT=20131231&JSON=J^P
"DATA",2002.1,130,0)
http://localhost:8001/DHPPATLABICN^F
"DATA",2002.1,131,0)
http://localhost:8001/DHPPATLABICN?ICN=1224989029V875306^F
"DATA",2002.1,132,0)
http://localhost:8001/DHPPATLABICN?ICN=1034989029V875306^P
"DATA",2002.1,133,0)
http://localhost:8001/DHPPATLABICN?ICN=5000001533V676621^P
"DATA",2002.1,134,0)
http://localhost:8001/DHPPATLABICN?ICN=1841089454V309194&FRDAT=20150101&TODAT=20131231&JSON=J^F
"DATA",2002.1,135,0)
http://localhost:8001/DHPPATLABICN?ICN=1841089454V309194&FRDAT=20150101^P
"DATA",2002.1,136,0)
http://localhost:8001/DHPPATLABICN?ICN=1841089454V309194&TODAT=20150101^P
"DATA",2002.1,137,0)
http://localhost:8001/DHPPATMEDAICN^F
"DATA",2002.1,138,0)
http://localhost:8001/DHPPATMEDAICN?ICN=5004300341V359724^F
"DATA",2002.1,139,0)
http://localhost:8001/DHPPATMEDAICN?ICN=5000000341V359724^P
"DATA",2002.1,140,0)
http://localhost:8001/DHPPATMEDAICN?ICN=5000000341V359724&FRDAT=20150101&TODAT=20131231^F
"DATA",2002.1,141,0)
http://localhost:8001/DHPPATMEDAICN?ICN=5000000341V359724&FRDAT=20100101&TODAT=20150101^P
"DATA",2002.1,142,0)
http://localhost:8001/DHPPATMEDAICN?ICN=2434609669V691690^P
"DATA",2002.1,143,0)
http://localhost:8001/DHPPATMEDDICN^F
"DATA",2002.1,144,0)
http://localhost:8001/DHPPATMEDDICN?ICN=5034000341V359724^F
"DATA",2002.1,145,0)
http://localhost:8001/DHPPATMEDDICN?ICN=5000000341V359724^P
"DATA",2002.1,146,0)
http://localhost:8001/DHPPATMEDDICN?ICN=5000000341V359724&FRDAT=20150121&TODAT=20131231^F
"DATA",2002.1,147,0)
http://localhost:8001/DHPPATMEDDICN?ICN=5000000341V359724&FRDAT=20100101&TODAT=20150101^P
"DATA",2002.1,148,0)
http://localhost:8001/DHPPATMEDDICN?ICN=2434609669V691690^P
"DATA",2002.1,149,0)
http://localhost:8001/DHPPATMEDSICN^F
"DATA",2002.1,150,0)
http://localhost:8001/DHPPATMEDSICN?ICN=5000430341V359724^F
"DATA",2002.1,151,0)
http://localhost:8001/DHPPATMEDSICN?ICN=5000000341V359724^P
"DATA",2002.1,152,0)
http://localhost:8001/DHPPATMEDSICN?ICN=5000000341V359724&FRDAT=20150201&TODAT=20131231^F
"DATA",2002.1,153,0)
http://localhost:8001/DHPPATMEDSICN?ICN=5000000341V359724&FRDAT=20100101&TODAT=20150101^P
"DATA",2002.1,154,0)
http://localhost:8001/DHPPATMEDSICN?ICN=2434609669V691690^P
"DATA",2002.1,155,0)
http://localhost:8001/DHPPATMEDSICN?ICN=1401380732V262134^P
"DATA",2002.1,156,0)
http://localhost:8001/DHPPATMEDSICN?ICN=2434609669V691690^P
"DATA",2002.1,157,0)
http://localhost:8001/DHPPATOBSICN^F
"DATA",2002.1,158,0)
http://localhost:8001/DHPPATOBSICN?ICN=5008800352V586511^F
"DATA",2002.1,159,0)
http://localhost:8001/DHPPATOBSICN?ICN=5000000352V586511^P
"DATA",2002.1,160,0)
http://localhost:8001/DHPPATOBSICN?ICN=5000000352V586511&FRDAT=19990101&TODAT=19981231^F
"DATA",2002.1,161,0)
http://localhost:8001/DHPPATOBSICN?ICN=5000000352V586511&FRDAT=20140901^P
"DATA",2002.1,162,0)
http://localhost:8001/DHPPATOBSICN?ICN=5000000352V586511&TODAT=20140901^P
"DATA",2002.1,163,0)
http://localhost:8001/DHPPATOBSICN?ICN=2434609669V691690^P
"DATA",2002.1,164,0)
http://localhost:8001/DHPPATPRCICN^F
"DATA",2002.1,165,0)
http://localhost:8001/DHPPATPRCICN?ICN=1401399732V262134^F
"DATA",2002.1,166,0)
http://localhost:8001/DHPPATPRCICN?ICN=1401380732V262134^P
"DATA",2002.1,167,0)
http://localhost:8001/DHPPATPRCICN?ICN=5000000107V310212^P
"DATA",2002.1,168,0)
http://localhost:8001/DHPPATPRCICN?ICN=5000000107V310212&FRDAT=19990101&TODAT=19981231^F
"DATA",2002.1,169,0)
http://localhost:8001/DHPPATPRCICN?ICN=5000000107V310212&FRDAT=19980101&TODAT=19981231^P
"DATA",2002.1,170,0)
http://localhost:8001/DHPPATPRVICN^F
"DATA",2002.1,171,0)
http://localhost:8001/DHPPATPRVICN?ICN=1095759922V866498^F
"DATA",2002.1,172,0)
http://localhost:8001/DHPPATPRVICN?ICN=1095759922V858498^P
"DATA",2002.1,173,0)
http://localhost:8001/DHPPATPRVICN?ICN=5000000107V310212^P
"DATA",2002.1,174,0)
http://localhost:8001/DHPPATPRVICN?ICN=1435855215V947437^P
"DATA",2002.1,175,0)
http://localhost:8001/DHPPATPRVICN?ICN=1435855215V947437&FRDAT=20150401&TODAT=20150301^F
"DATA",2002.1,176,0)
http://localhost:8001/DHPPATPRVICN?ICN=1435855215V947437&FRDAT=20150101&TODAT=20150301^P
"DATA",2002.1,177,0)
http://localhost:8001/DHPPATPRVICN?JSON=J^F
"DATA",2002.1,178,0)
http://localhost:8001/DHPPATPRVICN?ICN=1095759922V888498&JSON=J^F
"DATA",2002.1,179,0)
http://localhost:8001/DHPPATPRVICN?ICN=1095759922V858498&JSON=J^P
"DATA",2002.1,180,0)
http://localhost:8001/DHPPATPRVICN?ICN=5000000107V310212&JSON=J^P
"DATA",2002.1,181,0)
http://localhost:8001/DHPPATPRVICN?ICN=1435855215V947437&JSON=J^P
"DATA",2002.1,182,0)
http://localhost:8001/DHPPATPRVICN?ICN=1435855215V947437&FRDAT=20150401&TODAT=20150301&JSON=J^F
"DATA",2002.1,183,0)
http://localhost:8001/DHPPATPRVICN?ICN=1435855215V947437&FRDAT=20150101&TODAT=20150301&JSON=J^P
"DATA",2002.1,184,0)
http://localhost:8001/DHPPATTIUICN^F
"DATA",2002.1,185,0)
http://localhost:8001/DHPPATTIUICN?ICN=9009373208V844454^F
"DATA",2002.1,186,0)
http://localhost:8001/DHPPATTIUICN?ICN=9009373208V847154^P
"DATA",2002.1,187,0)
http://localhost:8001/DHPPATTIUICN?ICN=9009373208V847154&FRDAT=19980101&TODAT=19970101^F
"DATA",2002.1,188,0)
http://localhost:8001/DHPPATTIUICN?ICN=9009373208V847154&FRDAT=19960401&TODAT=19970101^P
"DATA",2002.1,189,0)
http://localhost:8001/DHPPATTIUICN?ICN=1095759922V858498^P
"DATA",2002.1,190,0)
http://localhost:8001/DHPPATVITICN^F
"DATA",2002.1,191,0)
http://localhost:8001/DHPPATVITICN?ICN=2176288883V515136^F
"DATA",2002.1,192,0)
http://localhost:8001/DHPPATVITICN?ICN=2176287883V515136^P
"DATA",2002.1,193,0)
http://localhost:8001/DHPPATVITICN?ICN=1095759922V858498^P
"DATA",2002.1,194,0)
http://localhost:8001/DHPPATVITICN?ICN=5000000211V385910^P
"DATA",2002.1,195,0)
http://localhost:8001/DHPPATVITICN?ICN=5000000211V385910&FRDAT=20160220&TODAT=20150223^F
"DATA",2002.1,196,0)
http://localhost:8001/DHPPATVITICN?ICN=5000000211V385910&FRDAT=20150220&TODAT=20150223^P
"DATA",2002.1,197,0)
http://localhost:8001/DHPPATVITICN?JSON=J^F
"DATA",2002.1,198,0)
http://localhost:8001/DHPPATVITICN?ICN=2176288883V515136&JSON=J^F
"DATA",2002.1,199,0)
http://localhost:8001/DHPPATVITICN?ICN=2176287883V515136&JSON=J^P
"DATA",2002.1,200,0)
http://localhost:8001/DHPPATVITICN?ICN=1095759922V858498&JSON=J^P
"DATA",2002.1,201,0)
http://localhost:8001/DHPPATVITICN?ICN=5000000211V385910&JSON=J^P
"DATA",2002.1,202,0)
http://localhost:8001/DHPPATVITICN?ICN=5000000211V385910&FRDAT=20150220&TODAT=20150101&JSON=J^F
"DATA",2002.1,203,0)
http://localhost:8001/DHPPATVITICN?ICN=5000000211V385910&FRDAT=20150220&TODAT=20150223&JSON=J^P
"DATA",2002.1,204,0)
http://localhost:8001/DHPPATVAL^F
"DATA",2002.1,205,0)
http://localhost:8001/DHPPATVAL?SSN=666000010^F
"DATA",2002.1,206,0)
http://localhost:8001/DHPPATVAL?SSN=666000010&NAME=TEN,PATIENT^F
"DATA",2002.1,207,0)
http://localhost:8001/DHPPATVAL?NAME=TEN,PATIENT&SSN=666000010&DOB=19290514^F
"DATA",2002.1,208,0)
http://localhost:8001/DHPPATVAL?NAME=TEN,PATIENT&SSN=666XXX010&DOB=19290514&GENDER=M^F
"DATA",2002.1,209,0)
http://localhost:8001/DHPPATVAL?NAME=TEN,PATIENT&SSN=666000010&DOB=19340514&GENDER=M^F
"DATA",2002.1,210,0)
http://localhost:8001/DHPPATVAL?NAME=TEN,PATIENT&SSN=666000010&DOB=19290514&GENDER=F^F
"DATA",2002.1,211,0)
http://localhost:8001/DHPPATVAL?NAME=TEN,PATIENT&SSN=666000010&DOB=19290514&GENDER=U^F
"DATA",2002.1,212,0)
http://localhost:8001/DHPPATVAL?NAME=TENXXX,PATIENT&SSN=666000010&DOB=19290514&GENDER=M^F
"DATA",2002.1,213,0)
http://localhost:8001/DHPPATVAL?NAME=TEN,PATIENT&SSN=666000010&DOB=19290514&GENDER=M^P
"DATA",2002.1,214,0)
http://localhost:8001/DHPPATVAL?NAME=COPD,PATIENT%20MALE&SSN=666111957&DOB=19800530&GENDER=M^P
"DATA",2002.1,215,0)
http://localhost:8001/DHPCARETEAM^F
"DATA",2002.1,216,0)
http://localhost:8001/DHPCARETEAM?TEAM=BLUEXX^F
"DATA",2002.1,217,0)
http://localhost:8001/DHPCARETEAM?TEAM=BLUE^P
"DATA",2002.1,218,0)
http://localhost:8001/DHPCARETEAM?TEAM=999^F
"DATA",2002.1,219,0)
http://localhost:8001/DHPCARETEAM?TEAM=5^P
"DATA",2002.1,220,0)
http://localhost:8001/DHPCARETEAM?JSON=J^F
"DATA",2002.1,221,0)
http://localhost:8001/DHPCARETEAM?TEAM=BLUEXX&JSON=J^F
"DATA",2002.1,222,0)
http://localhost:8001/DHPCARETEAM?TEAM=BLUE&JSON=J^P
"DATA",2002.1,223,0)
http://localhost:8001/DHPCARETEAM?TEAM=999&JSON=J^F
"DATA",2002.1,224,0)
http://localhost:8001/DHPCARETEAM?TEAM=5&JSON=J^P
"DATA",2002.1,225,0)
http://localhost:8001/DHPCARETEAMS^P
"DATA",2002.1,226,0)
http://localhost:8001/DHPCARETEAMS?FRDAT=20151231&TODAT=20141231^F
"DATA",2002.1,227,0)
http://localhost:8001/DHPCARETEAMS?FRDAT=20121231&TODAT=20141231^P
"DATA",2002.1,228,0)
http://localhost:8001/DHPCARETEAMS?JSON=J^P
"DATA",2002.1,229,0)
http://localhost:8001/DHPCARETEAMS?FRDAT=20151231&TODAT=20141231&JSON=J^F
"DATA",2002.1,230,0)
http://localhost:8001/DHPCARETEAMS?FRDAT=20121231&TODAT=20141231&JSON=J^P
"DATA",2002.1,231,0)
http://localhost:8001/DHPCARETEAMS?JSON=X^P
"DATA",2002.1,232,0)
http://localhost:8001/DHPHLOCINSTHLOCNAM^F
"DATA",2002.1,233,0)
http://localhost:8001/DHPHLOCINSTHLOCNAM?HLOC=ZYXW^F
"DATA",2002.1,234,0)
http://localhost:8001/DHPHLOCINSTHLOCNAM?HLOC=GENERAL%20MEDICINE^P
"DATA",2002.1,235,0)
http://localhost:8001/DHPHLOCINSTHLOCNAM?JSON=J^F
"DATA",2002.1,236,0)
http://localhost:8001/DHPHLOCINSTHLOCNAM?HLOC=ZYXW&JSON=J^F
"DATA",2002.1,237,0)
http://localhost:8001/DHPHLOCINSTHLOCNAM?HLOC=GENERAL%20MEDICINE&JSON=J^P
"DATA",2002.1,238,0)
http://localhost:8001/DHPMAPSVC?MAP=mh2sct&CODE=PHQ9^P
"DATA",2002.1,239,0)
http://localhost:8001/DHPMAPSVC?MAP=mh2sct&CODE=PHQ9&DIR=D^P
"DATA",2002.1,240,0)
http://localhost:8001/DHPMAPSVC?MAP=mh2sct&CODE=PHQ9&DIR=D&IOE=A^F
"DATA",2002.1,241,0)
http://localhost:8001/DHPMAPSVC?MAP=mh2sct&CODE=ZYXW&DIR=D&IOE=I^F
"DATA",2002.1,242,0)
http://localhost:8001/DHPMAPSVC?MAP=mh2sct&CODE=PHQ9&DIR=D&IOE=I^P
"DATA",2002.1,243,0)
http://localhost:8001/DHPMAPSVC?MAP=mh2sct&CODE=42&DIR=D^P
"DATA",2002.1,244,0)
http://localhost:8001/DHPMAPSVC?MAP=mh2sct&CODE=42&DIR=D&IOE=A^F
"DATA",2002.1,245,0)
http://localhost:8001/DHPMAPSVC?MAP=mh2sct&CODE=9999&DIR=D&IOE=I^F
"DATA",2002.1,246,0)
http://localhost:8001/DHPMAPSVC?MAP=mh2sct&CODE=42&DIR=D&IOE=I^P
"DATA",2002.1,247,0)
http://localhost:8001/DHPMAPSVC?MAP=mh2sct&CODE=715252007&DIR=I^P
"DATA",2002.1,248,0)
http://localhost:8001/DHPMAPSVC?MAP=mh2sct&CODE=715252007&DIR=I&IOE=A^F
"DATA",2002.1,249,0)
http://localhost:8001/DHPMAPSVC?MAP=mh2sct&CODE=999999999&DIR=I&IOE=I^F
"DATA",2002.1,250,0)
http://localhost:8001/DHPMAPSVC?MAP=mh2sct&CODE=715252007&DIR=I&IOE=I^P
"DATA",2002.1,251,0)
http://localhost:8001/DHPGETRESID^F
"DATA",2002.1,252,0)
http://localhost:8001/DHPGETRESID?RESID=S_500_2_110^F
"DATA",2002.1,253,0)
http://localhost:8001/DHPGETRESID?RESID=V^F
"DATA",2002.1,254,0)
http://localhost:8001/DHPGETRESID?RESID=V_555^F
"DATA",2002.1,255,0)
http://localhost:8001/DHPGETRESID?RESID=V_500^F
"DATA",2002.1,256,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_V^F
"DATA",2002.1,257,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_999999999999^F
"DATA",2002.1,258,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_2^F
"DATA",2002.1,259,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_2_V^F
"DATA",2002.1,260,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_2_999999999999^F
"DATA",2002.1,261,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_2_110^P
"DATA",2002.1,262,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_2.98_999999999999^F
"DATA",2002.1,263,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_2.98_24^P
"DATA",2002.1,264,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_4_999999999999^F
"DATA",2002.1,265,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_4_500^P
"DATA",2002.1,266,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_26.13_999999999999^F
"DATA",2002.1,267,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_26.13_110^P
"DATA",2002.1,268,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_44_999999999999^F
"DATA",2002.1,269,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_44_23^P
"DATA",2002.1,270,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_63_999999999999^F
"DATA",2002.1,271,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_63_1236^P
"DATA",2002.1,272,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_120.5_999999999999^F
"DATA",2002.1,273,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_120.5_110^P
"DATA",2002.1,274,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_120.8_999999999999^F
"DATA",2002.1,275,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_120.8_110^P
"DATA",2002.1,276,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_124.3_999999999999^F
"DATA",2002.1,277,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_124.3_10^P
"DATA",2002.1,278,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_216.8_999999999999^F
"DATA",2002.1,279,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_216.8_6^P
"DATA",2002.1,280,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_404.51_999999999999^F
"DATA",2002.1,281,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_404.51_5^P
"DATA",2002.1,282,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_404.52_999999999999^F
"DATA",2002.1,283,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_404.52_1^P
"DATA",2002.1,284,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_404.53_999999999999^F
"DATA",2002.1,285,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_404.53_1^F
"DATA",2002.1,286,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_404.57_999999999999^F
"DATA",2002.1,287,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_404.57_23^P
"DATA",2002.1,288,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_404.58_999999999999^F
"DATA",2002.1,289,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_404.58_4^P
"DATA",2002.1,290,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_404.59_999999999999^F
"DATA",2002.1,291,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_404.59_5^P
"DATA",2002.1,292,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_627.8_999999999999^F
"DATA",2002.1,293,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_627.8_169^P
"DATA",2002.1,294,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_8925_999999999999^F
"DATA",2002.1,295,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_8925_278^P
"DATA",2002.1,296,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_9000010_999999999999^F
"DATA",2002.1,297,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_9000010_110^P
"DATA",2002.1,298,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_9000010.06_999999999999^F
"DATA",2002.1,299,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_9000010.06_110^P
"DATA",2002.1,300,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_9000010.07_999999999999^F
"DATA",2002.1,301,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_9000010.07_110^P
"DATA",2002.1,302,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_9000010.11_999999999999^F
"DATA",2002.1,303,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_9000010.11_110^P
"DATA",2002.1,304,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_9000010.18_999999999999^F
"DATA",2002.1,305,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_9000010.18_110^P
"DATA",2002.1,306,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_9000010.23_999999999999^F
"DATA",2002.1,307,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_9000010.23_110^P
"DATA",2002.1,308,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_9000010.71_999999999999^F
"DATA",2002.1,309,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_9000010.71_110^P
"DATA",2002.1,310,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_9000011_999999999999^F
"DATA",2002.1,311,0)
http://localhost:8001/DHPGETRESID?RESID=V_500_9000011_110^P
"DATA",2002.1,312,0)
http://localhost:8001/DHPPATICNALL^P
"DATA",2002.1,313,0)
http://localhost:8001/DHPPATICNALL?CNT=x&JSON=A^P
"DATA",2002.1,314,0)
http://localhost:8001/DHPPATICNALL?CNT=5&JSON=T^P
"DATA",2002.1,315,0)
http://localhost:8001/DHPPATICNALL?CNT=5&JSON=J^P
"DATA",2002.1,316,0)
http://localhost:8001/DHPPATICNALL?CNT=x^P
"DATA",2002.1,317,0)
http://localhost:8001/DHPPATICNALL?CNT=5^P
"DATA",2002.1,318,0)
http://localhost:8001/DHPPATCP^F
"DATA",2002.1,319,0)
http://localhost:8001/DHPPATCPALL^F
"DATA",2002.1,320,0)
http://localhost:8001/DHPPATHLF^F
"DATA",2002.1,321,0)
http://localhost:8001/DHPPATLAB^F
"DATA",2002.1,322,0)
http://localhost:8001/DHPPATOBS^F
"DATA",2002.1,323,0)
http://localhost:8001/^P
"DATA",2002.1,324,0)
http://localhost:8001/WXYZ^F
"DATA",2002.1,325,0)
http://localhost:8001/DHPPATDEMRNG^F
"DATA",2002.1,326,0)
http://localhost:8001/DHPPATDEMRNG?ICN=10S20^F
"DATA",2002.1,327,0)
http://localhost:8001/DHPPATDEMRNG?ICN=R20^F
"DATA",2002.1,328,0)
http://localhost:8001/DHPPATDEMRNG?ICN=10R^F
"DATA",2002.1,329,0)
http://localhost:8001/DHPPATDEMRNG?ICN=100R20^F
"DATA",2002.1,330,0)
http://localhost:8001/DHPPATDEMRNG?ICN=10R2000^P
"DATA",2002.1,331,0)
http://localhost:8001/DHPPATDEMRNG?JSON=J^F
"DATA",2002.1,332,0)
http://localhost:8001/DHPPATDEMRNG?ICN=10S20&JSON=J^F
"DATA",2002.1,333,0)
http://localhost:8001/DHPPATDEMRNG?ICN=R20&JSON=J^F
"DATA",2002.1,334,0)
http://localhost:8001/DHPPATDEMRNG?ICN=10R&JSON=J^F
"DATA",2002.1,335,0)
http://localhost:8001/DHPPATDEMRNG?ICN=100R20&JSON=J^F
"DATA",2002.1,336,0)
http://localhost:8001/DHPPATDEMRNG?ICN=10R2000&JSON=J^F
"DATA",2002.1,337,0)
http://localhost:8001/DHPPATDEMRNG?ICN=10R20&JSON=J^P
"DATA",2002.1,338,0)
http://localhost:8001/DHPPATDEMALL^F
"DATA",2002.1,339,0)
http://localhost:8001/DHPPATDEMALL?ICN=SOM^F
"DATA",2002.1,340,0)
http://localhost:8001/DHPPATDEMALL?ICN=ALL^P
"DATA",2002.1,341,0)
http://localhost:8001/DHPPATDEMALL?JSON=J^F
"DATA",2002.1,342,0)
http://localhost:8001/DHPPATDEMALL?ICN=SOM&JSON=J^F
"DATA",2002.1,343,0)
http://localhost:8001/DHPPATDEMALL?ICN=ALL&JSON=J^F
"FIA",996.5)
NETSERV TCP LISTENER
"FIA",996.5,0)
^RGNET(996.5,
"FIA",996.5,0,0)
996.5
"FIA",996.5,0,1)
y^y^f^^n^^y^o^n
"FIA",996.5,0,10)

"FIA",996.5,0,11)

"FIA",996.5,0,"RLRO")

"FIA",996.5,996.5)
0
"FIA",996.52)
NETSERV HTTP ENDPOINT
"FIA",996.52,0)
^RGNET(996.52,
"FIA",996.52,0,0)
996.52
"FIA",996.52,0,1)
y^y^f^^n^^y^o^n
"FIA",996.52,0,10)

"FIA",996.52,0,11)

"FIA",996.52,0,"RLRO")

"FIA",996.52,996.52)
0
"FIA",996.52,996.52099)
0
"FIA",2002.1)
SYN REST UNIT TESTS
"FIA",2002.1,0)
^SYN(2002.1,
"FIA",2002.1,0,0)
2002.1
"FIA",2002.1,0,1)
y^y^f^^n^^y^o^n
"FIA",2002.1,0,10)

"FIA",2002.1,0,11)

"FIA",2002.1,0,"RLRO")

"FIA",2002.1,2002.1)
0
"INI")
EN^SYNPRE1
"INIT")
EN^SYNGBLLD
"IX",996.52,996.52,"C",0)
996.52^C^Compound index by METHOD and URL.^MU^^R^IR^I^996.52^^^^^LS
"IX",996.52,996.52,"C",1)
S ^RGNET(996.52,"C",X(1),X(2),DA)=$$TOPTRN^RGNETWWW(X(2))
"IX",996.52,996.52,"C",2)
K ^RGNET(996.52,"C",X(1),X(2),DA)
"IX",996.52,996.52,"C",2.5)
K ^RGNET(996.52,"C")
"IX",996.52,996.52,"C",11.1,0)
^.114IA^2^2
"IX",996.52,996.52,"C",11.1,1,0)
1^F^996.52^1^10^1^F
"IX",996.52,996.52,"C",11.1,2,0)
2^F^996.52^.01^150^2^F
"MBREQ")
0
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
112
"RTN","RGNETBAC")
0^53^B24620613
"RTN","RGNETBAC",1,0)
RGNETBAC ;RI/CBMI/DKM - NETSERV RPC Broker Actions;20-May-2015 22:15;AA
"RTN","RGNETBAC",2,0)
 ;;1.0;NETWORK SERVICES;;01-Apr-2015;Build 53
"RTN","RGNETBAC",3,0)
 ;=================================================================
"RTN","RGNETBAC",4,0)
 ; Connect action
"RTN","RGNETBAC",5,0)
 ; Data is returned to client as:
"RTN","RGNETBAC",6,0)
 ;   debug flag^authentication method^server version^case sensitive^cipher key
"RTN","RGNETBAC",7,0)
ACTC N X,Y,VOL,UCI,VER,AUTH,CAPS,CS,CK
"RTN","RGNETBAC",8,0)
 S Y=$$GETUCI,UCI(0)=Y,UCI=$$UP^XLFSTR($G(RGNETB("UCI"),Y)),VOL=$P(UCI,",",2),VER=$P($T(+2),";",3)
"RTN","RGNETBAC",9,0)
 S:'$L(UCI) UCI=Y
"RTN","RGNETBAC",10,0)
 S:'$L(VOL) VOL=$P(Y,",",2),$P(UCI,",",2)=VOL
"RTN","RGNETBAC",11,0)
 I UCI'=UCI(0),$$ERRCHK(0[$$UCICHECK^%ZOSV(UCI),14,UCI) Q
"RTN","RGNETBAC",12,0)
 Q:$$ERRCHK('$L(VOL),11)
"RTN","RGNETBAC",13,0)
 S AUTH=$$AUTHMETH(UCI),CS=$$GET^XPAR("SYS","XU VC CASE SENSITIVE"),CK=$E($P($T(Z+1^XUSRB1),";;",2,999),1,4)
"RTN","RGNETBAC",14,0)
 I '$G(RGNETB("LEGACY")) S CAPS=(RGMODE=3)_U_AUTH_U_VER_U_CS_U_CK
"RTN","RGNETBAC",15,0)
 E  S CAPS="1^"_AUTH_U_VER_U_CS_"^1^"
"RTN","RGNETBAC",16,0)
 Q:$$ERRCHK('$L(AUTH),24,UCI)
"RTN","RGNETBAC",17,0)
 I $D(^%ZOSF("ACTJ")) D  Q:$$ERRCHK(X'>Y&X,10,Y,X)
"RTN","RGNETBAC",18,0)
 .; Y=# active jobs, X=max active jobs
"RTN","RGNETBAC",19,0)
 .X ^%ZOSF("ACTJ")
"RTN","RGNETBAC",20,0)
 .S X=+$O(^XTV(8989.3,1,4,"B",VOL,0)),X=$S(X:+$P($G(^XTV(8989.3,1,4,X,0)),U,3),1:0)
"RTN","RGNETBAC",21,0)
 D INTRO^XUS1A("RGDATA"),MONSTART^RGNETBEV
"RTN","RGNETBAC",22,0)
 S RGDATA=CAPS
"RTN","RGNETBAC",23,0)
 Q
"RTN","RGNETBAC",24,0)
 ; Disconnect action
"RTN","RGNETBAC",25,0)
ACTD D RESET^RGNETBRP(),LOGOUT^XUSRB:$G(DUZ)
"RTN","RGNETBAC",26,0)
 S RGDATA=1,RGQUIT=1
"RTN","RGNETBAC",27,0)
 Q
"RTN","RGNETBAC",28,0)
 ; Query action
"RTN","RGNETBAC",29,0)
ACTQ Q:$$ASYCHK^RGNETBAS
"RTN","RGNETBAC",30,0)
 Q:$$EVTCHK^RGNETBEV
"RTN","RGNETBAC",31,0)
 ; Ping action
"RTN","RGNETBAC",32,0)
ACTP S DT=$$NOW^XLFDT,RGDATA=$$PARAM^RGNETBUT("RGNETB POLLING INTERVAL",1,60)_U_DT,DT=DT\1
"RTN","RGNETBAC",33,0)
 Q
"RTN","RGNETBAC",34,0)
 ; Subscribe action
"RTN","RGNETBAC",35,0)
ACTS S RGDATA=1
"RTN","RGNETBAC",36,0)
 Q:$$ERRCHK('$$SUBSCR^RGNETBEV(RGNETB("EVT"),1),13,RGNETB("EVT"))
"RTN","RGNETBAC",37,0)
 Q
"RTN","RGNETBAC",38,0)
 ; Unsubscribe action
"RTN","RGNETBAC",39,0)
ACTU S RGDATA=$$SUBSCR^RGNETBEV(RGNETB("EVT"),0)
"RTN","RGNETBAC",40,0)
 Q
"RTN","RGNETBAC",41,0)
 ; RPC action
"RTN","RGNETBAC",42,0)
ACTR N RPC,RTN,RGD,XWBWRAP,XWBPTYPE,I
"RTN","RGNETBAC",43,0)
 I '$D(RGNETB("CTX")) S RGNETB("CTX")=$$GETVAR^RGNETBUT("CTX")
"RTN","RGNETBAC",44,0)
 E  D SETVAR^RGNETBUT("CTX",RGNETB("CTX"))
"RTN","RGNETBAC",45,0)
 S:RGNETB("CTX")="" RGNETB("CTX")=$$GETVAR^RGNETBUT("AID")
"RTN","RGNETBAC",46,0)
 S RPC=$G(RGNETB("RPC"))
"RTN","RGNETBAC",47,0)
 I $G(RGNETB("LEGACY")),$E(RPC,1,5)="CIANB" S (RPC,RGNETB("RPC"))="RGNETB"_$E(RPC,6,7)_$E(RPC,9,999)
"RTN","RGNETBAC",48,0)
 S RPC=$$FIND1^DIC(8994,,"QX",RPC)
"RTN","RGNETBAC",49,0)
 Q:$$ERRCHK('RPC,3)
"RTN","RGNETBAC",50,0)
 S I=$G(^XWB(8994,RPC,0)),RTN=$P(I,U,2,3),XWBWRAP=+$P(I,U,8),XWBPTYPE=$P(I,U,4)
"RTN","RGNETBAC",51,0)
 Q:$$ERRCHK($S($E($P(RTN,U,2),1,6)="RGNETB":0,1:'$$CANRUN(RPC,RGNETB("CTX"))),4,RGNETB("RPC"),RGNETB("CTX"))
"RTN","RGNETBAC",52,0)
 Q:$$ERRCHK("03"'[$P(I,U,6),5)
"RTN","RGNETBAC",53,0)
 Q:$$ERRCHK(RTN'?.8AN1"^"1.8AN,6)
"RTN","RGNETBAC",54,0)
 Q:$$ERRCHK("^1^2^3^4^5^H^"'[(U_XWBPTYPE_U),6)
"RTN","RGNETBAC",55,0)
 Q:$$ERRCHK(ARG>40,7,,ARG,40)
"RTN","RGNETBAC",56,0)
 I $G(RGNETB("ASY")) D
"RTN","RGNETBAC",57,0)
 .N RD
"RTN","RGNETBAC",58,0)
 .S RD="RGNETB THREAD RESOURCE #"_$$GETVAR^RGNETBUT("RDEV")
"RTN","RGNETBAC",59,0)
 .S RGD=$$QUEUE^RGUTTSK("TASK^RGNETBAS","ASYNC RPC: "_RGNETB("RPC"),,"RTN^XWBWRAP^XWBPTYPE^ARG^ARG(^RGNETB(^XWBOS^P*",RD)
"RTN","RGNETBAC",60,0)
 .Q:$$ERRCHK(RGD<1,8)
"RTN","RGNETBAC",61,0)
 .S ^XTMP("RGNETB",RGNETB("UID"),"T",RGD)=""
"RTN","RGNETBAC",62,0)
 .D REPLY^RGNETBRK(RGD)
"RTN","RGNETBAC",63,0)
 E  D
"RTN","RGNETBAC",64,0)
 .S:XWBPTYPE=4 RGD=$$TMPGBL^RGNETBRP("X")
"RTN","RGNETBAC",65,0)
 .D STREST^RGNETTCP(1),DORPC,DATAOUT
"RTN","RGNETBAC",66,0)
 Q
"RTN","RGNETBAC",67,0)
 ; Builds the RPC entry code and executes it
"RTN","RGNETBAC",68,0)
DORPC N I,P,XWBAPVER,XQY,RGQUIT,ALOG,$ET
"RTN","RGNETBAC",69,0)
 S RTN=RTN_"(.RGD",XWBAPVER=$G(RGNETB("VER")),XQY=$$GETVAR^RGNETBUT("AID0")
"RTN","RGNETBAC",70,0)
 S ALOG=$$ISACTIVE^RGNETBLG,ALOG(0)=$S(ALOG:$$LOG^RGNETBLG(ALOG,1,RGNETB("RPC")),1:0)
"RTN","RGNETBAC",71,0)
 F I=1:1:ARG D
"RTN","RGNETBAC",72,0)
 .S RTN=RTN_","
"RTN","RGNETBAC",73,0)
 .Q:'$D(ARG(I))
"RTN","RGNETBAC",74,0)
 .S P="P"_I,RTN=RTN_"."_P
"RTN","RGNETBAC",75,0)
 .S:$D(@P)=10 @P=""
"RTN","RGNETBAC",76,0)
 .D:ALOG(0) ADD^RGNETBLG(ALOG,ALOG(0),P,1)
"RTN","RGNETBAC",77,0)
 S RTN=RTN_")"
"RTN","RGNETBAC",78,0)
 D
"RTN","RGNETBAC",79,0)
 .N ALOG
"RTN","RGNETBAC",80,0)
 .D @RTN
"RTN","RGNETBAC",81,0)
 I ALOG(0) D
"RTN","RGNETBAC",82,0)
 .N VAL,ARY
"RTN","RGNETBAC",83,0)
 .S VAL=$C(13)_"Return Data:"_$C(13)
"RTN","RGNETBAC",84,0)
 .D ADD^RGNETBLG(ALOG,ALOG(0),"VAL")
"RTN","RGNETBAC",85,0)
 .I XWBPTYPE=1 S VAL=$G(RGD),ARY="VAL"
"RTN","RGNETBAC",86,0)
 .E  I XWBPTYPE=2 S ARY="RGD"
"RTN","RGNETBAC",87,0)
 .E  I XWBPTYPE=3 S ARY="RGD"
"RTN","RGNETBAC",88,0)
 .E  I XWBPTYPE=4 S ARY=RGD
"RTN","RGNETBAC",89,0)
 .E  I XWBPTYPE=5 S VAL=$G(@RGD),ARY="VAL"
"RTN","RGNETBAC",90,0)
 .E  I XWBPTYPE="H" S VAL=RGD,ARY="VAL"
"RTN","RGNETBAC",91,0)
 .E  Q
"RTN","RGNETBAC",92,0)
 .D ADD^RGNETBLG(ALOG,ALOG(0),ARY)
"RTN","RGNETBAC",93,0)
 Q
"RTN","RGNETBAC",94,0)
 ; Test for error condition
"RTN","RGNETBAC",95,0)
 ; TEST = If true, setup the error
"RTN","RGNETBAC",96,0)
 ; ERR  = Error code
"RTN","RGNETBAC",97,0)
 ; Pn   = Optional parameters (up to 3)
"RTN","RGNETBAC",98,0)
ERRCHK(TEST,ERR,P1,P2,P3) ;
"RTN","RGNETBAC",99,0)
 I TEST,'$G(RGERR(0)) D
"RTN","RGNETBAC",100,0)
 .D GETDLG^RGNETBUT(ERR,.RGERR,.P1,.P2,.P3)
"RTN","RGNETBAC",101,0)
 .S RGERR(0)=ERR
"RTN","RGNETBAC",102,0)
 Q:$Q +$G(RGERR(0))
"RTN","RGNETBAC",103,0)
 Q
"RTN","RGNETBAC",104,0)
 ; Writes return data to TCP stream
"RTN","RGNETBAC",105,0)
DATAOUT D TCPWRITE^RGNETTCP($C(0))
"RTN","RGNETBAC",106,0)
 I XWBPTYPE=1 D TCPWRITE^RGNETTCP($G(RGD)) Q
"RTN","RGNETBAC",107,0)
 I XWBPTYPE=2 D ARYOUT^RGNETBRK("RGD",1,1) Q
"RTN","RGNETBAC",108,0)
 I XWBPTYPE=3 D ARYOUT^RGNETBRK("RGD",XWBWRAP,1) Q
"RTN","RGNETBAC",109,0)
 I XWBPTYPE=4 D ARYOUT^RGNETBRK(RGD,XWBWRAP,1) Q
"RTN","RGNETBAC",110,0)
 I XWBPTYPE=5 D TCPWRITE^RGNETTCP($G(@RGD)) Q
"RTN","RGNETBAC",111,0)
 I XWBPTYPE="H" D FILOUT^RGNETTCP(RGD,XWBWRAP) Q
"RTN","RGNETBAC",112,0)
 Q
"RTN","RGNETBAC",113,0)
 ; Returns true if RPC can run in current context
"RTN","RGNETBAC",114,0)
CANRUN(RPC,CTX) ;
"RTN","RGNETBAC",115,0)
 Q:'$G(DUZ)!'RPC 0
"RTN","RGNETBAC",116,0)
 S CTX(0)=$$OPTLKP^RGNETBUT(CTX)
"RTN","RGNETBAC",117,0)
 Q:$$ERRCHK('$L(CTX(0)),2,CTX) 0
"RTN","RGNETBAC",118,0)
 D:'$G(^XTMP("RGNETB",RGNETB("UID"),"C",CTX(0))) BLDCTX(CTX(0))
"RTN","RGNETBAC",119,0)
 Q:$$KCHK^XUSRB("XUPROGMODE") 1
"RTN","RGNETBAC",120,0)
 Q $D(^XTMP("RGNETB",RGNETB("UID"),"C",CTX(0),RPC))
"RTN","RGNETBAC",121,0)
 ; Build RPC context table
"RTN","RGNETBAC",122,0)
BLDCTX(OPT,CTX) ;
"RTN","RGNETBAC",123,0)
 N X
"RTN","RGNETBAC",124,0)
 I '$D(CTX) K ^XTMP("RGNETB",RGNETB("UID"),"C",OPT) S ^(OPT)=1,CTX=OPT
"RTN","RGNETBAC",125,0)
 Q:$D(^XTMP("RGNETB",RGNETB("UID"),"C",CTX,0,OPT))  S ^(OPT)=""
"RTN","RGNETBAC",126,0)
 Q:$$OPTCHK^RGNETBUT(OPT,"B")
"RTN","RGNETBAC",127,0)
 M ^XTMP("RGNETB",RGNETB("UID"),"C",CTX)=^DIC(19,OPT,"RPC","B")
"RTN","RGNETBAC",128,0)
 F X=0:0 S X=$O(^DIC(19,OPT,10,"B",X)) Q:'X  D BLDCTX(X,CTX)
"RTN","RGNETBAC",129,0)
 K:CTX=OPT ^XTMP("RGNETB",RGNETB("UID"),"C",CTX,0)
"RTN","RGNETBAC",130,0)
 Q
"RTN","RGNETBAC",131,0)
 ; Return current UCI
"RTN","RGNETBAC",132,0)
GETUCI() N Y
"RTN","RGNETBAC",133,0)
 D UCI^%ZOSV
"RTN","RGNETBAC",134,0)
 Q Y
"RTN","RGNETBAC",135,0)
 ; Change UCI
"RTN","RGNETBAC",136,0)
SETUCI(X) D SWAP^%XUCI
"RTN","RGNETBAC",137,0)
 Q
"RTN","RGNETBAC",138,0)
 ; Get authentication method for target UCI
"RTN","RGNETBAC",139,0)
AUTHMETH(UCI) ;
"RTN","RGNETBAC",140,0)
 N X,PC
"RTN","RGNETBAC",141,0)
 F PC=2,1 D  Q:$L(X)
"RTN","RGNETBAC",142,0)
 .S X=$$GET^XPAR("ALL","RGNETB AUTHENTICATION",$P(UCI,",",1,PC))
"RTN","RGNETBAC",143,0)
 Q X
"RTN","RGNETBAS")
0^54^B5697779
"RTN","RGNETBAS",1,0)
RGNETBAS ;RI/CBMI/DKM - Asynchronous RPC calls ;13-Apr-2015 05:33;DKM
"RTN","RGNETBAS",2,0)
 ;;1.0;NETWORK SERVICES;;01-Apr-2015;Build 53
"RTN","RGNETBAS",3,0)
 ;=================================================================
"RTN","RGNETBAS",4,0)
 ; Background task for executing an asynchronous RPC
"RTN","RGNETBAS",5,0)
TASK N RGD,TGT,$ET,$ES
"RTN","RGNETBAS",6,0)
 S $ET="D ERROR^RGNETBAS",ZTREQ="@"
"RTN","RGNETBAS",7,0)
 K ^XTMP("RGNETB",RGNETB("UID"),"T",ZTSK)
"RTN","RGNETBAS",8,0)
 Q:$$S^%ZTLOAD
"RTN","RGNETBAS",9,0)
 S ^XTMP("RGNETB",RGNETB("UID"),"T",ZTSK)=0,TGT=$NA(^(ZTSK,0))
"RTN","RGNETBAS",10,0)
 S:XWBPTYPE=4 RGD=TGT
"RTN","RGNETBAS",11,0)
 D DORPC^RGNETBAC
"RTN","RGNETBAS",12,0)
 I XWBPTYPE=1 S @TGT@(0)=RGD
"RTN","RGNETBAS",13,0)
 E  I XWBPTYPE>1,XWBPTYPE<4 M @TGT=RGD S:XWBPTYPE=2 XWBWRAP=1
"RTN","RGNETBAS",14,0)
 E  I XWBPTYPE=4,$L(RGD),RGD'=TGT M @TGT=@RGD K @RGD
"RTN","RGNETBAS",15,0)
 E  I XWBPTYPE=5 S @TGT@(0)=$G(@RGD)
"RTN","RGNETBAS",16,0)
 E  I XWBPTYPE="H" D
"RTN","RGNETBAS",17,0)
 .N X,Y,FIL,DIR
"RTN","RGNETBAS",18,0)
 .S X=$E($$DIRDLM^RGUTOS,3),Y=$L(RGD,X),DIR=$P(RGD,X,1,Y-1),FIL=$P(RGD,X,Y)
"RTN","RGNETBAS",19,0)
 .I '$$FTG^%ZISH(DIR,FIL,$NA(@TGT@(0)),$QL(TGT)+1)
"RTN","RGNETBAS",20,0)
 .D DELETE^RGUTOS(RGD)
"RTN","RGNETBAS",21,0)
 I $$S^%ZTLOAD K ^XTMP("RGNETB",RGNETB("UID"),"T",ZTSK)
"RTN","RGNETBAS",22,0)
 E  S ^XTMP("RGNETB",RGNETB("UID"),"T",ZTSK)=ZTSK_"^0^"_XWBWRAP
"RTN","RGNETBAS",23,0)
 Q
"RTN","RGNETBAS",24,0)
ERROR D SETERR(-1,$$EC^%ZOSV)
"RTN","RGNETBAS",25,0)
 D ^%ZTER,UNWIND^%ZTER
"RTN","RGNETBAS",26,0)
 Q
"RTN","RGNETBAS",27,0)
 ; Retrieve specified routine line
"RTN","RGNETBAS",28,0)
RTNTEXT(RTN) ;
"RTN","RGNETBAS",29,0)
 N TAG
"RTN","RGNETBAS",30,0)
 S TAG=$P(RTN,U),RTN=$P(RTN,U,2)
"RTN","RGNETBAS",31,0)
 Q $S('$L(RTN):$T(^@TAG),$L(TAG):$T(@TAG^@RTN),1:$T(^@RTN))
"RTN","RGNETBAS",32,0)
 ; Set error info to return to client
"RTN","RGNETBAS",33,0)
SETERR(CODE,TEXT) ;
"RTN","RGNETBAS",34,0)
 K ^XTMP("RGNETB",RGNETB("UID"),"T",ZTSK) M ^(ZTSK,0,0)=TEXT
"RTN","RGNETBAS",35,0)
 S ^XTMP("RGNETB",RGNETB("UID"),"T",ZTSK)=ZTSK_U_CODE_"^1"
"RTN","RGNETBAS",36,0)
 Q
"RTN","RGNETBAS",37,0)
 ; RPC to check for completed tasks
"RTN","RGNETBAS",38,0)
 ; Results[0] at the client end will contain the TaskMan ID of the
"RTN","RGNETBAS",39,0)
 ; completed RPC. The remainder of the Result will be the data
"RTN","RGNETBAS",40,0)
 ; returned by the RPC.
"RTN","RGNETBAS",41,0)
ASYCHK() N ZTSK,RGD,X
"RTN","RGNETBAS",42,0)
 S ZTSK=0
"RTN","RGNETBAS",43,0)
 F  S ZTSK=+$O(^XTMP("RGNETB",RGNETB("UID"),"T",ZTSK)) Q:'ZTSK  S X=$G(^(ZTSK)),RGD=$NA(^(ZTSK,0)) I X D  Q
"RTN","RGNETBAS",44,0)
 .D TCPWRITE^RGNETTCP($C(2)_X_$C(13))
"RTN","RGNETBAS",45,0)
 .D ARYOUT^RGNETBRK(RGD,$P(X,U,3),1)
"RTN","RGNETBAS",46,0)
 .K ^XTMP("RGNETB",RGNETB("UID"),"T",ZTSK)
"RTN","RGNETBAS",47,0)
 Q ZTSK
"RTN","RGNETBAS",48,0)
 ; RPC: Stop a task
"RTN","RGNETBAS",49,0)
 ; Signals to a backround task that it should stop running.  Cleans up
"RTN","RGNETBAS",50,0)
 ; any output generated by completed tasks.
"RTN","RGNETBAS",51,0)
STOP(RGD,ZTSK) ;
"RTN","RGNETBAS",52,0)
 S RGD=''$D(^XTMP("RGNETB",RGNETB("UID"),"T",ZTSK)) K:RGD ^(ZTSK)
"RTN","RGNETBAS",53,0)
 Q:'$D(^%ZTSK(ZTSK))
"RTN","RGNETBAS",54,0)
 S $P(^%ZTSK(ZTSK,.1),U,10)=$P($G(^VA(200,DUZ,0)),U)
"RTN","RGNETBAS",55,0)
 D DQ^%ZTLOAD
"RTN","RGNETBAS",56,0)
 I $G(ZTSK(0)) D KILL^%ZTLOAD
"RTN","RGNETBAS",57,0)
 Q
"RTN","RGNETBAS",58,0)
 ; Stop all tasks in task list
"RTN","RGNETBAS",59,0)
STOPALL N ZTSK
"RTN","RGNETBAS",60,0)
 S ZTSK=0
"RTN","RGNETBAS",61,0)
 F  S ZTSK=$O(^XTMP("RGNETB",RGNETB("UID"),"T",ZTSK)) Q:'ZTSK  D STOP(,ZTSK)
"RTN","RGNETBAS",62,0)
 K ^XTMP("RGNETB",RGNETB("UID"),"T")
"RTN","RGNETBAS",63,0)
 Q
"RTN","RGNETBEV")
0^55^B60190374
"RTN","RGNETBEV",1,0)
RGNETBEV ;RI/CBMI/DKM - Event Support ;19-May-2015 09:09;DKM
"RTN","RGNETBEV",2,0)
 ;;1.0;NETWORK SERVICES;;01-Apr-2015;Build 53
"RTN","RGNETBEV",3,0)
 ;=================================================================
"RTN","RGNETBEV",4,0)
 ; Check for the occurrence of host events
"RTN","RGNETBEV",5,0)
EVTCHK() ;EP
"RTN","RGNETBEV",6,0)
 N RTN,$ET,X
"RTN","RGNETBEV",7,0)
 S $ET="",X="ERR1^RGNETBEV",@^%ZOSF("TRAP")
"RTN","RGNETBEV",8,0)
 L +^XTMP("RGNETB",RGNETB("UID"),"E"):0
"RTN","RGNETBEV",9,0)
 E  Q 0
"RTN","RGNETBEV",10,0)
 S RTN=+$O(^XTMP("RGNETB",RGNETB("UID"),"E",0)),X=$NA(^(RTN))
"RTN","RGNETBEV",11,0)
 I RTN D
"RTN","RGNETBEV",12,0)
 .D TCPWRITE^RGNETTCP($C(3))
"RTN","RGNETBEV",13,0)
 .D ARYOUT^RGNETBRK(X,,1)
"RTN","RGNETBEV",14,0)
ERR1 L -^XTMP("RGNETB",RGNETB("UID"),"E")
"RTN","RGNETBEV",15,0)
 Q $G(RTN)
"RTN","RGNETBEV",16,0)
 ; Start monitor in background if not already running
"RTN","RGNETBEV",17,0)
MONSTART ;EP
"RTN","RGNETBEV",18,0)
 I '$$MONCHECK,$$QUEUE^RGUTTSK("MONITOR^RGNETBEV","NETSERV Broker Event Monitor")
"RTN","RGNETBEV",19,0)
 Q
"RTN","RGNETBEV",20,0)
 ; Returns true if event monitor is running
"RTN","RGNETBEV",21,0)
 ;   LOCK = If specified and true, do not release lock.
"RTN","RGNETBEV",22,0)
MONCHECK(LOCK) ;EP
"RTN","RGNETBEV",23,0)
 L +^XTMP("RGNETBEV MONITOR"):0
"RTN","RGNETBEV",24,0)
 E  Q 1
"RTN","RGNETBEV",25,0)
 L:'$G(LOCK) -^XTMP("RGNETBEV MONITOR")
"RTN","RGNETBEV",26,0)
 Q 0
"RTN","RGNETBEV",27,0)
 ; Taskman entry point for background event monitor
"RTN","RGNETBEV",28,0)
MONITOR ;EP
"RTN","RGNETBEV",29,0)
 N IEN,TYPE,EXE,IDLE,PMETH,X
"RTN","RGNETBEV",30,0)
 S ZTREQ="@",IDLE=360
"RTN","RGNETBEV",31,0)
 Q:$$MONCHECK(1)
"RTN","RGNETBEV",32,0)
 F  D  Q:IDLE<1!$$S^%ZTLOAD
"RTN","RGNETBEV",33,0)
 .H 5
"RTN","RGNETBEV",34,0)
 .F IEN=0:0 S IEN=$O(^RGNET(996.51,IEN)) Q:'IEN  D
"RTN","RGNETBEV",35,0)
 ..S X=$G(^(IEN,0)),TYPE=$P(X,U),PMETH=$P(X,U,6),EXE=$G(^(1))          ; Note: NR set above
"RTN","RGNETBEV",36,0)
 ..I $L(EXE),'$P(X,U,2),$$CHKINT(+$P(X,U,3)) D
"RTN","RGNETBEV",37,0)
 ...I PMETH D EXEMON Q
"RTN","RGNETBEV",38,0)
 ...N UID
"RTN","RGNETBEV",39,0)
 ...F  Q:'$$NXTUID^RGNETBUT(.UID)  D EXEUID(UID,TYPE)
"RTN","RGNETBEV",40,0)
 .S IDLE=$S($$NXTUID^RGNETBUT:360,1:IDLE-1)
"RTN","RGNETBEV",41,0)
 L -^XTMP("RGNETBEV MONITOR")
"RTN","RGNETBEV",42,0)
 Q
"RTN","RGNETBEV",43,0)
 ; Execute an event monitor in session context
"RTN","RGNETBEV",44,0)
EXEUID(UID,TYPE) ;EP
"RTN","RGNETBEV",45,0)
 Q:'$$ISSUBSCR(UID,TYPE)
"RTN","RGNETBEV",46,0)
 N RG,DUZ
"RTN","RGNETBEV",47,0)
 S RGNETB("UID")=UID,DUZ=$$EXEVAR("DUZ"),DUZ(0)=$$EXEVAR("DUZ0"),DUZ(2)=$$EXEVAR("DUZ2")
"RTN","RGNETBEV",48,0)
 D EXEMON
"RTN","RGNETBEV",49,0)
 Q
"RTN","RGNETBEV",50,0)
 ; Execute the event monitor
"RTN","RGNETBEV",51,0)
EXEMON N X,$ET
"RTN","RGNETBEV",52,0)
 S X="EXEERR^RGNETBEV",@^%ZOSF("TRAP"),$ET=""
"RTN","RGNETBEV",53,0)
 D EXERUN
"RTN","RGNETBEV",54,0)
 Q
"RTN","RGNETBEV",55,0)
EXERUN N IEN,IDLE
"RTN","RGNETBEV",56,0)
 X EXE
"RTN","RGNETBEV",57,0)
 Q
"RTN","RGNETBEV",58,0)
 ; Log any errors
"RTN","RGNETBEV",59,0)
EXEERR N ERT,ERD,X
"RTN","RGNETBEV",60,0)
 S ERT=$TR($$EC^%ZOSV,U,"~"),ERD=$$NOW^XLFDT
"RTN","RGNETBEV",61,0)
 S X=$G(^RGNET(996.51,IEN,100)),^(100)=ERD_U_ERT
"RTN","RGNETBEV",62,0)
 D:(ERD\1'=(X\1))!($P(X,U,2)'=ERT) ^%ZTER
"RTN","RGNETBEV",63,0)
 Q
"RTN","RGNETBEV",64,0)
EXEVAR(VAR) ;
"RTN","RGNETBEV",65,0)
 Q $$GETVAR^RGNETBUT(VAR,,,UID)
"RTN","RGNETBEV",66,0)
 ; Check nominal polling interval.  Return true if event needs to be polled.
"RTN","RGNETBEV",67,0)
CHKINT(INT) ;EP
"RTN","RGNETBEV",68,0)
 Q:'INT 1
"RTN","RGNETBEV",69,0)
 N NXT,NOW,CHK
"RTN","RGNETBEV",70,0)
 S NOW=$H,NOW=NOW*86400+$P(NOW,",",2)
"RTN","RGNETBEV",71,0)
 S NXT=$G(IEN(IEN),NOW),CHK=NOW'<NXT
"RTN","RGNETBEV",72,0)
 S:CHK IEN(IEN)=NOW+INT
"RTN","RGNETBEV",73,0)
 Q CHK
"RTN","RGNETBEV",74,0)
 ; RPC: Broadcast an event to some or all active users
"RTN","RGNETBEV",75,0)
BCAST(DATA,EVENT,STUB,LST,AID) ;
"RTN","RGNETBEV",76,0)
 S DATA=$$BRDCAST(.EVENT,.STUB,.LST,.AID)
"RTN","RGNETBEV",77,0)
 Q
"RTN","RGNETBEV",78,0)
 ; Called by event monitor to signal an event to client
"RTN","RGNETBEV",79,0)
SIGNAL(STUB) ;
"RTN","RGNETBEV",80,0)
 D QUEUE(TYPE,.STUB)
"RTN","RGNETBEV",81,0)
 Q
"RTN","RGNETBEV",82,0)
 ; Add an event to a process event queue
"RTN","RGNETBEV",83,0)
QUEUE(TYPE,STUB,UID,MON) ;EP
"RTN","RGNETBEV",84,0)
 N Q
"RTN","RGNETBEV",85,0)
 S:'$D(UID) UID=$G(RGNETB("UID"))
"RTN","RGNETBEV",86,0)
 I '$$ISSUBSCR(UID,TYPE) Q:$Q 0 Q
"RTN","RGNETBEV",87,0)
 L +^XTMP("RGNETB",UID,"E"):5
"RTN","RGNETBEV",88,0)
 E  Q:$Q 0 Q
"RTN","RGNETBEV",89,0)
 S Q=1+$O(^XTMP("RGNETB",UID,"E",$C(1)),-1),^(Q,0)=TYPE_$C(13) M ^(1)=STUB
"RTN","RGNETBEV",90,0)
 L -^XTMP("RGNETB",UID,"E")
"RTN","RGNETBEV",91,0)
 D:$G(MON,1) MONSTART
"RTN","RGNETBEV",92,0)
 Q:$Q 1
"RTN","RGNETBEV",93,0)
 Q
"RTN","RGNETBEV",94,0)
 ; Lookup event type, returning IEN
"RTN","RGNETBEV",95,0)
EVENTIEN(TYPE) ;EP
"RTN","RGNETBEV",96,0)
 N X,Y
"RTN","RGNETBEV",97,0)
 Q:TYPE=+TYPE!'$L(TYPE) +TYPE
"RTN","RGNETBEV",98,0)
 S X=$E(TYPE,1,30),Y=0
"RTN","RGNETBEV",99,0)
 F  S Y=+$O(^RGNET(996.51,"B",X,Y)) Q:'Y!($P($G(^RGNET(996.51,Y,0)),U)=TYPE)
"RTN","RGNETBEV",100,0)
 Q $S(Y:Y,1:$$EVENTIEN($P(TYPE,".",1,$L(TYPE,".")-1)))
"RTN","RGNETBEV",101,0)
 ; Return event name, given IEN
"RTN","RGNETBEV",102,0)
EVENTNAM(IEN) ;EP
"RTN","RGNETBEV",103,0)
 Q $P($G(^RGNET(996.51,+IEN,0)),U)
"RTN","RGNETBEV",104,0)
 ; Check to see if an event type is disabled
"RTN","RGNETBEV",105,0)
DISABLED(TYPE) ;EP
"RTN","RGNETBEV",106,0)
 N X,Y
"RTN","RGNETBEV",107,0)
 S X=$$EVENTIEN(TYPE),Y=$G(^RGNET(996.51,+X,0)),TYPE=$P(Y,U),Y=+$P(Y,U,2)
"RTN","RGNETBEV",108,0)
 S:'Y Y=$$KEYCHECK(X,20)
"RTN","RGNETBEV",109,0)
 Q $S(Y:Y,'X:0,1:$$DISABLED($P(TYPE,".",1,$L(TYPE,".")-1)))
"RTN","RGNETBEV",110,0)
 ; Check to see if event type is protected by security key(s)
"RTN","RGNETBEV",111,0)
 ; Returns true if user does not have required keys
"RTN","RGNETBEV",112,0)
 ;   SB=20: Publication keys; SB=21: Subscription keys
"RTN","RGNETBEV",113,0)
KEYCHECK(TYPE,SB) ;EP
"RTN","RGNETBEV",114,0)
 N X,Y,Z
"RTN","RGNETBEV",115,0)
 S X=$$EVENTIEN(TYPE),(Y,Z)=0
"RTN","RGNETBEV",116,0)
 F  S Z=$O(^RGNET(996.51,X,SB,"B",Z)) Q:'Z  D  Q:'Y
"RTN","RGNETBEV",117,0)
 .S Y='$$HASKEY(Z)
"RTN","RGNETBEV",118,0)
 Q Y
"RTN","RGNETBEV",119,0)
 ; Return true if user has key
"RTN","RGNETBEV",120,0)
HASKEY(KEY) ;EP
"RTN","RGNETBEV",121,0)
 S:KEY=+KEY KEY=$$LKUP^XPDKEY(KEY)
"RTN","RGNETBEV",122,0)
 Q $S($L(KEY):''$$KCHK^XUSRB(KEY),1:0)
"RTN","RGNETBEV",123,0)
 ; Signal an event to all or selected sessions
"RTN","RGNETBEV",124,0)
 ; If called as extrinsic, returns # of events broadcast
"RTN","RGNETBEV",125,0)
BRDCAST(TYPE,STUB,USR,AID) ;EP
"RTN","RGNETBEV",126,0)
 N X,C
"RTN","RGNETBEV",127,0)
 S C=0
"RTN","RGNETBEV",128,0)
 I '$$DISABLED(TYPE) D
"RTN","RGNETBEV",129,0)
 .I $D(USR("DUZ"))>1 D
"RTN","RGNETBEV",130,0)
 ..F  Q:'$$NXTUID^RGNETBUT(.X,-1,.AID)  D
"RTN","RGNETBEV",131,0)
 ...S:$D(USR("DUZ",+$$GETVAR^RGNETBUT("DUZ",,,X))) USR("UID",X)=""
"RTN","RGNETBEV",132,0)
 .S X=""
"RTN","RGNETBEV",133,0)
 .F  D  Q:'X
"RTN","RGNETBEV",134,0)
 ..I $D(USR)>1 S X=$O(USR("UID",X))
"RTN","RGNETBEV",135,0)
 ..E  D NXTUID^RGNETBUT(.X,-1,.AID)
"RTN","RGNETBEV",136,0)
 ..S:X C=C+$$QUEUE(.TYPE,.STUB,X,0)
"RTN","RGNETBEV",137,0)
 .D LOG(TYPE,.STUB)
"RTN","RGNETBEV",138,0)
 .D FPRTCOL(TYPE,.STUB)
"RTN","RGNETBEV",139,0)
 .D MONSTART
"RTN","RGNETBEV",140,0)
 Q:$Q C
"RTN","RGNETBEV",141,0)
 Q
"RTN","RGNETBEV",142,0)
 ; Fire Associated Event Protocol
"RTN","RGNETBEV",143,0)
FPRTCOL(TYPE,STUB) ;
"RTN","RGNETBEV",144,0)
 N EVT,X
"RTN","RGNETBEV",145,0)
 S EVT=$$EVENTIEN(TYPE)
"RTN","RGNETBEV",146,0)
 Q:'EVT
"RTN","RGNETBEV",147,0)
 S X=$P($G(^RGNET(996.51,+EVT,0)),U,7)_";ORD(101,"
"RTN","RGNETBEV",148,0)
 D:X EN^XQOR
"RTN","RGNETBEV",149,0)
 Q
"RTN","RGNETBEV",150,0)
 ; Subscribe to / unsubscribe from a named event
"RTN","RGNETBEV",151,0)
 ; Returns new subscription state
"RTN","RGNETBEV",152,0)
SUBSCR(TYPE,SUBSCR) ;EP
"RTN","RGNETBEV",153,0)
 I '$L(TYPE) Q:$Q 0 Q
"RTN","RGNETBEV",154,0)
 N CURRNT
"RTN","RGNETBEV",155,0)
 S CURRNT=''$D(^XTMP("RGNETB",RGNETB("UID"),"S",TYPE)),SUBSCR=''$G(SUBSCR)
"RTN","RGNETBEV",156,0)
 I CURRNT'=SUBSCR D
"RTN","RGNETBEV",157,0)
 .I SUBSCR D  Q:'SUBSCR
"RTN","RGNETBEV",158,0)
 ..I $$KEYCHECK(TYPE,21) S SUBSCR=0
"RTN","RGNETBEV",159,0)
 ..E  S ^XTMP("RGNETB",RGNETB("UID"),"S",TYPE)=""
"RTN","RGNETBEV",160,0)
 .E  D
"RTN","RGNETBEV",161,0)
 ..K ^XTMP("RGNETB",RGNETB("UID"),"S",TYPE)
"RTN","RGNETBEV",162,0)
 ..D CLRVAR^RGNETBUT("EVENT."_TYPE)
"RTN","RGNETBEV",163,0)
 .D BRDCAST($S(SUBSCR:"",1:"UN")_"SUBSCRIBE."_TYPE,$$SESSION^RGNETBUT)
"RTN","RGNETBEV",164,0)
 Q:$Q SUBSCR
"RTN","RGNETBEV",165,0)
 Q
"RTN","RGNETBEV",166,0)
 ; Unsubscribe from all events (done at logout)
"RTN","RGNETBEV",167,0)
UNSUBALL ;EP
"RTN","RGNETBEV",168,0)
 N TYPE
"RTN","RGNETBEV",169,0)
 S TYPE=""
"RTN","RGNETBEV",170,0)
 F  S TYPE=$O(^XTMP("RGNETB",RGNETB("UID"),"S",TYPE)) Q:'$L(TYPE)  D
"RTN","RGNETBEV",171,0)
 .D SUBSCR(TYPE,0)
"RTN","RGNETBEV",172,0)
 Q
"RTN","RGNETBEV",173,0)
 ; Returns true if session is a subscriber
"RTN","RGNETBEV",174,0)
ISSUBSCR(UID,TYPE) ;EP
"RTN","RGNETBEV",175,0)
 Q $S('$$ISACTIVE^RGNETBUT(UID):0,1:$$ISSUBX(TYPE))
"RTN","RGNETBEV",176,0)
ISSUBX(TYPE) ;
"RTN","RGNETBEV",177,0)
 Q $S('$L(TYPE):0,$D(^XTMP("RGNETB",UID,"S",TYPE)):1,1:$$ISSUBX($P(TYPE,".",1,$L(TYPE,".")-1)))
"RTN","RGNETBEV",178,0)
 ; Returns list of subscribers to a given event type
"RTN","RGNETBEV",179,0)
GETSUBSC(DATA,TYPE) ;EP
"RTN","RGNETBEV",180,0)
 N Z
"RTN","RGNETBEV",181,0)
 D GETSESSN^RGNETBRP(.DATA)
"RTN","RGNETBEV",182,0)
 F Z=0:0 S Z=$O(@DATA@(Z)) Q:'Z  K:'$$ISSUBSCR(+@DATA@(Z),TYPE) @DATA@(Z)
"RTN","RGNETBEV",183,0)
 Q
"RTN","RGNETBEV",184,0)
 ; Returns number of days to retain log entries for an event type.
"RTN","RGNETBEV",185,0)
ISLOGGED(TYPE) ;EP
"RTN","RGNETBEV",186,0)
 N X,Y
"RTN","RGNETBEV",187,0)
 S TYPE=$$EVENTIEN(TYPE)
"RTN","RGNETBEV",188,0)
 S:TYPE X=^RGNET(996.51,TYPE,0),Y=$P(X,U,4),X=$P(X,U)
"RTN","RGNETBEV",189,0)
 Q $S('TYPE:0,'$L(Y):$$ISLOGGED($P(X,".",$L(X,".")-1)),1:Y)
"RTN","RGNETBEV",190,0)
 ; Log an event
"RTN","RGNETBEV",191,0)
LOG(TYPE,STUB) ;EP
"RTN","RGNETBEV",192,0)
 N IEN,FDA,ERR,STB,X
"RTN","RGNETBEV",193,0)
 S IEN=$$ISACTIVE^RGNETBLG
"RTN","RGNETBEV",194,0)
 I IEN D
"RTN","RGNETBEV",195,0)
 .S X=$$LOG^RGNETBLG(IEN,2,TYPE)
"RTN","RGNETBEV",196,0)
 .D:X ADD^RGNETBLG(IEN,X,"STUB")
"RTN","RGNETBEV",197,0)
 Q:'$$ISLOGGED(TYPE)
"RTN","RGNETBEV",198,0)
 S FDA=$NA(FDA(996.511,"+1,")),STB="STUB",X=0
"RTN","RGNETBEV",199,0)
 F  D  Q:'$L(STB)
"RTN","RGNETBEV",200,0)
 .S:$D(@STB)#2 X=X+1,STB(X)=@STB
"RTN","RGNETBEV",201,0)
 .S STB=$Q(@STB)
"RTN","RGNETBEV",202,0)
 S @FDA@(.01)=$$NOW^XLFDT
"RTN","RGNETBEV",203,0)
 S @FDA@(1)=TYPE
"RTN","RGNETBEV",204,0)
 S @FDA@(2)=DUZ
"RTN","RGNETBEV",205,0)
 S @FDA@(3)=$$GETUID^RGNETBUT
"RTN","RGNETBEV",206,0)
 S:X @FDA@(10)="STB"
"RTN","RGNETBEV",207,0)
 D UPDATE^DIE("U","FDA",,"ERR")
"RTN","RGNETBEV",208,0)
 Q
"RTN","RGNETBEV",209,0)
 ; Purge event log.  Specify at least one of:
"RTN","RGNETBEV",210,0)
 ;   DATE = Date before which entries will be purged.
"RTN","RGNETBEV",211,0)
 ;   TYPE = Event type to be purged.
"RTN","RGNETBEV",212,0)
 ;   FLAG = If set, purges child events as well.
"RTN","RGNETBEV",213,0)
PURGELOG(DATE,TYPE,FLAG) ;EP
"RTN","RGNETBEV",214,0)
 N IEN,CNT
"RTN","RGNETBEV",215,0)
 S CNT=0,TYPE=$G(TYPE),FLAG=$S($G(FLAG):12,1:1)
"RTN","RGNETBEV",216,0)
 S:TYPE=+TYPE TYPE=$$EVENTNAM(TYPE)
"RTN","RGNETBEV",217,0)
 I $G(DATE) D
"RTN","RGNETBEV",218,0)
 .F  S DATE=$O(^RGNET(996.511,"B",DATE),-1),IEN=0 Q:'DATE  D
"RTN","RGNETBEV",219,0)
 ..F  S IEN=$O(^RGNET(996.511,"B",DATE,IEN)) Q:'IEN  D
"RTN","RGNETBEV",220,0)
 ...I $L(TYPE),FLAG'[$$RELATES(TYPE,$P(^RGNET(996.511,IEN,0),U,2)) Q
"RTN","RGNETBEV",221,0)
 ...S CNT=CNT+$$DELLOG(IEN)
"RTN","RGNETBEV",222,0)
 E  D
"RTN","RGNETBEV",223,0)
 .N TYP
"RTN","RGNETBEV",224,0)
 .S IEN=0,TYP=TYPE
"RTN","RGNETBEV",225,0)
 .F  Q:'$L(TYPE)  D
"RTN","RGNETBEV",226,0)
 ..F  S IEN=$O(^RGNET(996.511,"C",TYPE,IEN)) Q:'IEN  S CNT=CNT+$$DELLOG(IEN)
"RTN","RGNETBEV",227,0)
 ..S TYPE=$O(^RGNET(996.511,"C",TYPE))
"RTN","RGNETBEV",228,0)
 ..S:FLAG'[$$RELATES(TYP,TYPE) TYPE=""
"RTN","RGNETBEV",229,0)
 Q:$Q CNT
"RTN","RGNETBEV",230,0)
 Q
"RTN","RGNETBEV",231,0)
 ; Delete log entry corresponding to IEN
"RTN","RGNETBEV",232,0)
DELLOG(IEN) ;EP
"RTN","RGNETBEV",233,0)
 N FDA,ERR
"RTN","RGNETBEV",234,0)
 S FDA(996.511,IEN_",",.01)="@"
"RTN","RGNETBEV",235,0)
 D FILE^DIE(,"FDA","ERR")
"RTN","RGNETBEV",236,0)
 Q:$Q '$D(ERR)
"RTN","RGNETBEV",237,0)
 Q
"RTN","RGNETBEV",238,0)
 ; Task purge in background
"RTN","RGNETBEV",239,0)
TASKPRG ;EP
"RTN","RGNETBEV",240,0)
 N ZTSK
"RTN","RGNETBEV",241,0)
 S ZTSK=$$QUEUE^RGUTTSK("DOPURGE^RGNETBEV(1)","Purge RG EVENT LOG")
"RTN","RGNETBEV",242,0)
 I ZTSK>0 W !,"RG EVENT LOG purge submitted as task #",ZTSK,!!
"RTN","RGNETBEV",243,0)
 E  W !,"Error submitting RG EVENT LOG purge.",!!
"RTN","RGNETBEV",244,0)
 Q
"RTN","RGNETBEV",245,0)
 ; Purges event log according to retention settings
"RTN","RGNETBEV",246,0)
DOPURGE(SILENT) ;EP
"RTN","RGNETBEV",247,0)
 N IEN,TPNM,TPEN,DATE,CNT,TOT
"RTN","RGNETBEV",248,0)
 S TPNM="",SILENT=+$G(SILENT),TOT=0
"RTN","RGNETBEV",249,0)
 F  S TPNM=$O(^RGNET(996.511,"C",TPNM)) Q:'$L(TPNM)  D
"RTN","RGNETBEV",250,0)
 .S TPEN=$$EVENTIEN(TPNM),DATE=+$P($G(^RGNET(996.51,TPEN,0)),U,5)
"RTN","RGNETBEV",251,0)
 .S DATE=$$FMADD^XLFDT(DT,$S(DATE:1-DATE,1:-13))
"RTN","RGNETBEV",252,0)
 .S CNT=$$PURGELOG(DATE,TPNM),TOT=TOT+CNT
"RTN","RGNETBEV",253,0)
 .I CNT,'SILENT W $$SNGPLR^RGUT(CNT,"event")," purged for ",TPNM,!
"RTN","RGNETBEV",254,0)
 W:'SILENT !,"Total events purged: ",TOT,!!
"RTN","RGNETBEV",255,0)
 S:$D(ZTQUEUED) ZTREQ="@"
"RTN","RGNETBEV",256,0)
 Q
"RTN","RGNETBEV",257,0)
 ; Returns the relationship between event types
"RTN","RGNETBEV",258,0)
 ;   0 = none
"RTN","RGNETBEV",259,0)
 ;   1 = same
"RTN","RGNETBEV",260,0)
 ;   2 = A is parent of B
"RTN","RGNETBEV",261,0)
 ;   3 = B is parent of A
"RTN","RGNETBEV",262,0)
RELATES(EVA,EVB) ;EP
"RTN","RGNETBEV",263,0)
 N SWP,X
"RTN","RGNETBEV",264,0)
 S:EVA=+EVA EVA=$$EVENTNAM(EVA)
"RTN","RGNETBEV",265,0)
 S:EVB=+EVB EVB=$$EVENTNAM(EVB)
"RTN","RGNETBEV",266,0)
 S:$L(EVA)>$L(EVB) SWP=EVA,EVA=EVB,EVB=SWP
"RTN","RGNETBEV",267,0)
 Q:EVA=EVB 1
"RTN","RGNETBEV",268,0)
 F  D  Q:'$L(EVB)!(EVA=EVB)
"RTN","RGNETBEV",269,0)
 .S EVB=$P(EVB,".",1,$L(EVB,".")-1)
"RTN","RGNETBEV",270,0)
 Q $S(EVA'=EVB:0,$D(SWP):3,1:2)
"RTN","RGNETBIN")
0^56^B139662
"RTN","RGNETBIN",1,0)
RGNETBIN ;RI/CBMI/DKM - NETSERV RPC Broker Inits ;09-Apr-2015 19:22;DKM
"RTN","RGNETBIN",2,0)
 ;;1.0;NETWORK SERVICES;;01-Apr-2015;Build 53
"RTN","RGNETBIN",3,0)
 ;=================================================================
"RTN","RGNETBIN",4,0)
 ; Environment check
"RTN","RGNETBIN",5,0)
EC Q
"RTN","RGNETBIN",6,0)
 ; Pre-init
"RTN","RGNETBIN",7,0)
PRE Q
"RTN","RGNETBIN",8,0)
 ; Post-init
"RTN","RGNETBIN",9,0)
POST N Y
"RTN","RGNETBIN",10,0)
 X ^%ZOSF("UCI")
"RTN","RGNETBIN",11,0)
 D ADD^XPAR("SYS","RGNETB AUTHENTICATION",Y,0)
"RTN","RGNETBIN",12,0)
 Q
"RTN","RGNETBLG")
0^57^B10216441
"RTN","RGNETBLG",1,0)
RGNETBLG ;RI/CBMI/DKM - NETSERV RPC Broker Activity Log Support ;15-Apr-2015 07:25;DKM
"RTN","RGNETBLG",2,0)
 ;;1.0;NETWORK SERVICES;;Jan 3, 2008;Build 53
"RTN","RGNETBLG",3,0)
 ;=================================================================
"RTN","RGNETBLG",4,0)
 ; Open a log entry.  The return value is the IEN of the new entry.
"RTN","RGNETBLG",5,0)
 ;   UID  = Unique session id
"RTN","RGNETBLG",6,0)
 ;   USER = User IEN
"RTN","RGNETBLG",7,0)
 ;   WID  = Workstation id
"RTN","RGNETBLG",8,0)
OPEN(UID,USER,WID) ;EP
"RTN","RGNETBLG",9,0)
 N IEN,NOW,X
"RTN","RGNETBLG",10,0)
 S NOW=$$NOW^XLFDT
"RTN","RGNETBLG",11,0)
 S:$G(WID)="" WID="UNKNOWN"
"RTN","RGNETBLG",12,0)
 L +^RGNET(996.512,0):2
"RTN","RGNETBLG",13,0)
 S X=1+$P(^RGNET(996.512,0),U,3),IEN=$O(^($C(1)),-1)+1,$P(^(0),U,3,4)=X_U_IEN,^(IEN,0)=UID_U_USER_U_WID_U_NOW_U_U_DUZ(2)
"RTN","RGNETBLG",14,0)
 L -^RGNET(996.512,0)
"RTN","RGNETBLG",15,0)
 S ^RGNET(996.512,"B",UID,IEN)=""
"RTN","RGNETBLG",16,0)
 S ^RGNET(996.512,"BUSER",USER,IEN)=""
"RTN","RGNETBLG",17,0)
 S ^RGNET(996.512,"BWID",WID,IEN)=""
"RTN","RGNETBLG",18,0)
 S ^RGNET(996.512,"BLOGIN",NOW,IEN)=""
"RTN","RGNETBLG",19,0)
 S ^RGNET(996.512,"BDIV",DUZ(2),IEN)=""
"RTN","RGNETBLG",20,0)
 Q IEN
"RTN","RGNETBLG",21,0)
 ; Close a log entry.
"RTN","RGNETBLG",22,0)
 ;  IEN = IEN of the entry.
"RTN","RGNETBLG",23,0)
CLOSE(IEN) ;EP
"RTN","RGNETBLG",24,0)
 N NOW
"RTN","RGNETBLG",25,0)
 S NOW=$$NOW^XLFDT
"RTN","RGNETBLG",26,0)
 S:$D(^RGNET(996.512,+IEN,0)) $P(^(0),U,5)=NOW,^RGNET(996.512,"BLOGOUT",NOW,IEN)=""
"RTN","RGNETBLG",27,0)
 Q
"RTN","RGNETBLG",28,0)
 ; Log an activity
"RTN","RGNETBLG",29,0)
 ;  IEN  = IEN of log entry
"RTN","RGNETBLG",30,0)
 ;  TYPE = Type of log entry (1=RPC, 2=Event)
"RTN","RGNETBLG",31,0)
 ;  NAME = Text name associated with activity
"RTN","RGNETBLG",32,0)
 ;  Returns subfile IEN
"RTN","RGNETBLG",33,0)
LOG(IEN,TYPE,NAME) ;EP
"RTN","RGNETBLG",34,0)
 N SUB,NOW
"RTN","RGNETBLG",35,0)
 Q:'$D(^RGNET(996.512,IEN)) 0
"RTN","RGNETBLG",36,0)
 S NOW=$$NOW^XLFDT
"RTN","RGNETBLG",37,0)
 S SUB=$O(^RGNET(996.512,IEN,10,$C(1)),-1)+1,^(0)="^996.5121D^"_SUB_U_SUB,^(SUB,0)=NOW_U_TYPE_U_NAME
"RTN","RGNETBLG",38,0)
 Q SUB
"RTN","RGNETBLG",39,0)
 ; Add an entry to the specified activity
"RTN","RGNETBLG",40,0)
 ;  IEN = IEN of log entry
"RTN","RGNETBLG",41,0)
 ;  SUB = IEN of subfile entry
"RTN","RGNETBLG",42,0)
 ;  ARY = Array or global root
"RTN","RGNETBLG",43,0)
 ;  INC = Include variable name with output (optional)
"RTN","RGNETBLG",44,0)
ADD(IEN,SUB,ARY,INC) ;EP
"RTN","RGNETBLG",45,0)
 N ROOT,WP,A,L,P,X,Y,Z
"RTN","RGNETBLG",46,0)
 S ROOT=$NA(^RGNET(996.512,IEN,10,SUB,10))
"RTN","RGNETBLG",47,0)
 S WP=$O(@ROOT@($C(1)),-1),WP(0)=WP,INC=+$G(INC),(A,ARY)=$NA(@ARY),L=$QL(ARY)
"RTN","RGNETBLG",48,0)
 F  D:$D(@A)#2  S A=$Q(@A) Q:'$L(A)  Q:$NA(@A,L)'=ARY
"RTN","RGNETBLG",49,0)
 .S X=@A,P=$S(INC:A_" = ",1:"")
"RTN","RGNETBLG",50,0)
 .F  Q:'$L(X)  D
"RTN","RGNETBLG",51,0)
 ..S Y=$F(X,$C(13))
"RTN","RGNETBLG",52,0)
 ..S:'Y!(Y>200) Y=200
"RTN","RGNETBLG",53,0)
 ..S Z=$TR($E(X,1,Y-1),$C(13,10)),X=$E(X,Y,999999)
"RTN","RGNETBLG",54,0)
 ..S WP=WP+1,@ROOT@(WP,0)=P_Z,P=$S(INC:">>> ",1:"")
"RTN","RGNETBLG",55,0)
 S:WP'=WP(0) @ROOT@(0)="^^"_WP_U_WP_U_$$NOW^XLFDT
"RTN","RGNETBLG",56,0)
 Q
"RTN","RGNETBLG",57,0)
 ; Delete a log entry
"RTN","RGNETBLG",58,0)
DELETE(DA) ;
"RTN","RGNETBLG",59,0)
 Q:'$D(^RGNET(996.512,DA))
"RTN","RGNETBLG",60,0)
 N DIK
"RTN","RGNETBLG",61,0)
 S DIK="^RGNET(996.512,"
"RTN","RGNETBLG",62,0)
 D ^DIK
"RTN","RGNETBLG",63,0)
 Q
"RTN","RGNETBLG",64,0)
 ; Task purge in background
"RTN","RGNETBLG",65,0)
TASKPRG N ZTSK
"RTN","RGNETBLG",66,0)
 S ZTSK=$$QUEUE^RGUTTSK("DOPURGE^RGNETBLG","Purge RG ACTIVITY LOG")
"RTN","RGNETBLG",67,0)
 I ZTSK>0 W !,"RG ACTIVITY LOG purge submitted as task #",ZTSK,!!
"RTN","RGNETBLG",68,0)
 E  W !,"Error submitting RG ACTIVITY LOG purge.",!!
"RTN","RGNETBLG",69,0)
 Q
"RTN","RGNETBLG",70,0)
 ; Purge log entries according to retention criteria
"RTN","RGNETBLG",71,0)
DOPURGE N DAYS,LP,IEN
"RTN","RGNETBLG",72,0)
 S DAYS=$$GET^XPAR("ALL","RGNETB ACTIVITY RETENTION")
"RTN","RGNETBLG",73,0)
 Q:'DAYS
"RTN","RGNETBLG",74,0)
 S LP=$$FMADD^XLFDT(DT,-DAYS)
"RTN","RGNETBLG",75,0)
 F  S LP=$O(^RGNET(996.512,"BLOGIN",LP),-1) Q:'LP  D
"RTN","RGNETBLG",76,0)
 .S IEN=0
"RTN","RGNETBLG",77,0)
 .F  S IEN=$O(^RGNET(996.512,"BLOGIN",LP,IEN)) Q:'IEN  D
"RTN","RGNETBLG",78,0)
 ..D DELETE(IEN)
"RTN","RGNETBLG",79,0)
 Q
"RTN","RGNETBLG",80,0)
 ; Returns true if activity logging is active
"RTN","RGNETBLG",81,0)
 ; Creates a log entry if one does not already exist
"RTN","RGNETBLG",82,0)
ISACTIVE() ;
"RTN","RGNETBLG",83,0)
 N RTN,DUZ2
"RTN","RGNETBLG",84,0)
 Q:'$D(RGNETB("UID")) 0
"RTN","RGNETBLG",85,0)
 Q:'RGNETB("UID") 0
"RTN","RGNETBLG",86,0)
 S DUZ2=$$GETVAR^RGNETBUT("DUZ2")
"RTN","RGNETBLG",87,0)
 S RTN=$$GETVAR^RGNETBUT("ALOG"_$S(DUZ2:":"_DUZ2,1:""))
"RTN","RGNETBLG",88,0)
 I RTN="" D
"RTN","RGNETBLG",89,0)
 .S RTN=+$$GET^XPAR("ALL","RGNETB ACTIVITY LOGGING","`"_$$GETVAR^RGNETBUT("AID0"))
"RTN","RGNETBLG",90,0)
 .S:RTN RTN=$$OPEN(RGNETB("UID"),DUZ,$$GETVAR^RGNETBUT("WID"))
"RTN","RGNETBLG",91,0)
 .D SETVAR^RGNETBUT("ALOG"_$S(DUZ2:":"_DUZ2,1:""),RTN)
"RTN","RGNETBLG",92,0)
 Q RTN
"RTN","RGNETBRK")
0^58^B6080317
"RTN","RGNETBRK",1,0)
RGNETBRK ;RI/CBMI/DKM - NETSERV RPC Broker ;08-Jun-2015 10:16;AA
"RTN","RGNETBRK",2,0)
 ;;1.0;NETWORK SERVICES;;01-Apr-2015;Build 53
"RTN","RGNETBRK",3,0)
 ;=================================================================
"RTN","RGNETBRK",4,0)
 ; Handler for broker I/O
"RTN","RGNETBRK",5,0)
NETSERV(RGNETB) ;
"RTN","RGNETBRK",6,0)
 S:$$DOACTION($S($D(RGNETB):"DPQRSU",1:"C")) RGRETRY=0
"RTN","RGNETBRK",7,0)
 Q
"RTN","RGNETBRK",8,0)
 ; Read action and params
"RTN","RGNETBRK",9,0)
 ;  VAC = List of valid action codes
"RTN","RGNETBRK",10,0)
 ; Returns true if valid inputs
"RTN","RGNETBRK",11,0)
DOACTION(VAC) ;
"RTN","RGNETBRK",12,0)
 N NM,SB,RT,VL,PR,ACT,SEQ,ARG,RGERR,RGDATA,X
"RTN","RGNETBRK",13,0)
 S RGERR(0)=0
"RTN","RGNETBRK",14,0)
 S X=$$TCPREAD^RGNETTCP(8,300)
"RTN","RGNETBRK",15,0)
 I '$L(X),RGMODE'=3 D ACTD^RGNETBAC Q 0
"RTN","RGNETBRK",16,0)
 S ARG=0,PR=$E(X,1,5),RGNETB("EOD")=$E(X,6),SEQ=$E(X,7),ACT=$E(X,8)
"RTN","RGNETBRK",17,0)
 I PR="{CIA}" S RGNETB("LEGACY")=1
"RTN","RGNETBRK",18,0)
 E  Q:PR'="{RGN}" 0
"RTN","RGNETBRK",19,0)
 F  S NM=$$TCPREADL Q:'$L(NM)  S PR=NM=+NM,RT=$S(PR:"P"_NM,1:"RGNETB("""_NM_"""") N:PR&'$D(ARG(NM)) @RT D
"RTN","RGNETBRK",20,0)
 .S:PR ARG=$S(NM>ARG:NM,1:ARG),ARG(NM)=""
"RTN","RGNETBRK",21,0)
 .S SB=$$TCPREADL,VL=$$TCPREADL
"RTN","RGNETBRK",22,0)
 .I $L(SB) S RT=RT_$S(PR:"(",1:",")_SB_")"
"RTN","RGNETBRK",23,0)
 .E  S:'PR RT=RT_")"
"RTN","RGNETBRK",24,0)
 .S @RT=VL
"RTN","RGNETBRK",25,0)
 D TCPWRITE^RGNETTCP(SEQ)
"RTN","RGNETBRK",26,0)
 I '$$ERRCHK^RGNETBAC(VAC'[ACT,9,ACT) D
"RTN","RGNETBRK",27,0)
 .N $ET,$ES
"RTN","RGNETBRK",28,0)
 .S $ET="D ETRAP2^RGNETBRK"
"RTN","RGNETBRK",29,0)
 .D @("ACT"_ACT_"^RGNETBAC")
"RTN","RGNETBRK",30,0)
 I RGERR(0) D
"RTN","RGNETBRK",31,0)
 .D SNDERR
"RTN","RGNETBRK",32,0)
 E  I $D(RGDATA) D
"RTN","RGNETBRK",33,0)
 .D REPLY(.RGDATA)
"RTN","RGNETBRK",34,0)
 E  D SNDEOD
"RTN","RGNETBRK",35,0)
 Q 1
"RTN","RGNETBRK",36,0)
 ; Read length-prefixed data from input stream
"RTN","RGNETBRK",37,0)
TCPREADL() ;
"RTN","RGNETBRK",38,0)
 N X,L,I,N
"RTN","RGNETBRK",39,0)
 S X=$$TCPREADB^RGNETTCP
"RTN","RGNETBRK",40,0)
 Q:$C(X)=RGNETB("EOD") ""
"RTN","RGNETBRK",41,0)
 S N=X#16,X=$$TCPREAD^RGNETTCP(X\16),L=0
"RTN","RGNETBRK",42,0)
 F I=1:1:$L(X) S L=L*256+$A(X,I)
"RTN","RGNETBRK",43,0)
 Q $$TCPREAD^RGNETTCP(L*16+N)
"RTN","RGNETBRK",44,0)
 ; Raise an exception
"RTN","RGNETBRK",45,0)
RAISE(MSG,P1,P2) ;
"RTN","RGNETBRK",46,0)
 D GETDLG^RGNETBUT(MSG,.MSG,.P1,.P2)
"RTN","RGNETBRK",47,0)
 S $EC=MSG(1)
"RTN","RGNETBRK",48,0)
 Q
"RTN","RGNETBRK",49,0)
 ; Trapped error, send error info to client
"RTN","RGNETBRK",50,0)
ETRAP2 N ECSAV
"RTN","RGNETBRK",51,0)
 S $ET="D UNWIND^RGNETBRK Q:$Q 0 Q",ECSAV=$$EC^%ZOSV,RGRETRY=RGRETRY+1
"RTN","RGNETBRK",52,0)
 D:RGRETRY=1 ^%ZTER,ERRCHK^RGNETBAC(1,1,ECSAV)
"RTN","RGNETBRK",53,0)
 S $EC=ECSAV
"RTN","RGNETBRK",54,0)
 Q
"RTN","RGNETBRK",55,0)
 ; Unwind stack
"RTN","RGNETBRK",56,0)
UNWIND Q:$ES>1
"RTN","RGNETBRK",57,0)
 S $EC=""
"RTN","RGNETBRK",58,0)
 Q
"RTN","RGNETBRK",59,0)
 ; Send a reply
"RTN","RGNETBRK",60,0)
REPLY(DATA,ACK) ;
"RTN","RGNETBRK",61,0)
 N MORE
"RTN","RGNETBRK",62,0)
 S MORE=$D(DATA)\10
"RTN","RGNETBRK",63,0)
 D TCPWRITE^RGNETTCP($C(+$G(ACK))_$G(DATA)_$S(MORE:$C(13),1:""))
"RTN","RGNETBRK",64,0)
 D:MORE ARYOUT("DATA",1,1)
"RTN","RGNETBRK",65,0)
 D SNDEOD
"RTN","RGNETBRK",66,0)
 K DATA
"RTN","RGNETBRK",67,0)
 Q
"RTN","RGNETBRK",68,0)
 ; Send error information
"RTN","RGNETBRK",69,0)
SNDERR N X
"RTN","RGNETBRK",70,0)
 D TCPWRITE^RGNETTCP($C(1))
"RTN","RGNETBRK",71,0)
 D ARYOUT("RGERR",1,1),SNDEOD
"RTN","RGNETBRK",72,0)
 S RGERR(0)=0
"RTN","RGNETBRK",73,0)
 Q
"RTN","RGNETBRK",74,0)
SNDEOD D TCPWRITE^RGNETTCP($$CTL("EOD"))
"RTN","RGNETBRK",75,0)
 Q
"RTN","RGNETBRK",76,0)
 ; Send data from an array.
"RTN","RGNETBRK",77,0)
 ;  ARY  = Array to send
"RTN","RGNETBRK",78,0)
 ;  EOL  = If true, append line terminator
"RTN","RGNETBRK",79,0)
 ;  KILL = If true, kill the array after sending
"RTN","RGNETBRK",80,0)
ARYOUT(ARY,EOL,KILL) ;
"RTN","RGNETBRK",81,0)
 D ARYOUT^RGNETTCP(ARY,$S($G(EOL):$C(13),1:""))
"RTN","RGNETBRK",82,0)
 K:$G(KILL) @ARY
"RTN","RGNETBRK",83,0)
 Q
"RTN","RGNETBRK",84,0)
 ; Return control byte
"RTN","RGNETBRK",85,0)
CTL(X) I $D(RGNETB(X)) N Y S Y=RGNETB(X) K RGNETB(X) Q Y
"RTN","RGNETBRK",86,0)
 Q ""
"RTN","RGNETBRP")
0^59^B64590541
"RTN","RGNETBRP",1,0)
RGNETBRP ;RI/CBMI/DKM - NETSERV RPC Broker Privileged RPCs;16-Jun-2015 21:51;DKM
"RTN","RGNETBRP",2,0)
 ;;1.0;NETWORK SERVICES;;01-Apr-2015;Build 53
"RTN","RGNETBRP",3,0)
 ;=================================================================
"RTN","RGNETBRP",4,0)
 ; RPC: User authentication
"RTN","RGNETBRP",5,0)
 ; AID = Application ID
"RTN","RGNETBRP",6,0)
 ; WID = Workstation ID
"RTN","RGNETBRP",7,0)
 ; SID = NT Security ID
"RTN","RGNETBRP",8,0)
 ; AVC = AV Code
"RTN","RGNETBRP",9,0)
 ; WIP = Workstation IP address
"RTN","RGNETBRP",10,0)
 ; DIV = Login division (optional)
"RTN","RGNETBRP",11,0)
 ; Returns:
"RTN","RGNETBRP",12,0)
 ;  DATA(0)=Status code^Status text
"RTN","RGNETBRP",13,0)
 ;  where Status code is one of:
"RTN","RGNETBRP",14,0)
 ;   0 = success                 (Params=UID^net name^div name^DUZ)
"RTN","RGNETBRP",15,0)
 ;   1 = success, verify expired (Params=same as success)
"RTN","RGNETBRP",16,0)
 ;   2 = logins inhibited        (Params=null)
"RTN","RGNETBRP",17,0)
 ;   3 = locked                  (Params=null)
"RTN","RGNETBRP",18,0)
 ;   4 = authentication failure  (Params=server^volume^UCI^port)
"RTN","RGNETBRP",19,0)
 ;   5 = other error             (Params=null)
"RTN","RGNETBRP",20,0)
 ;  DATA(1)=Params
"RTN","RGNETBRP",21,0)
 ;  DATA(2,n)=Greeting message
"RTN","RGNETBRP",22,0)
AUTH(DATA,AID,WID,SID,AVC,WIP,DIV) ;
"RTN","RGNETBRP",23,0)
 N XOPT,XUT,XUTEXT,XOPT,XUEON,XUEOFF,XUTT,XUDEV,XUSER,XUNOW,X
"RTN","RGNETBRP",24,0)
 K DUZ,DATA,^TMP($J),^UTILITY($J)
"RTN","RGNETBRP",25,0)
 D SET1^XUS(0)
"RTN","RGNETBRP",26,0)
 S (DUZ,XUT)=0,DUZ(0)="",XUDEV=0,DATA(0)=4,DATA(1)=""
"RTN","RGNETBRP",27,0)
 S AID(0)=$$OPTLKP^RGNETBUT(.AID),WID=$$ID(.WID),SID=$G(SID),WIP=$G(WIP)
"RTN","RGNETBRP",28,0)
 I '$L(AID(0)),$$CHK(18,5,.AID) Q
"RTN","RGNETBRP",29,0)
 S X=$$OPTMSG^RGNETBUT(AID(0))
"RTN","RGNETBRP",30,0)
 I $L(X),$$CHK(19,2,X) Q
"RTN","RGNETBRP",31,0)
 I '$L($G(AVC)) S DUZ=+$$AUTOLOG(SID),RGXUT=0
"RTN","RGNETBRP",32,0)
 E  D
"RTN","RGNETBRP",33,0)
 .I $E(AVC,1,2)="~1" S DUZ=$$CHKASH^XUSRB4(AVC)
"RTN","RGNETBRP",34,0)
 .S:'DUZ DUZ=$$CHECKAV^XUS($$DECRYP^XUSRB1(AVC)),RGXUT=$G(RGXUT)+1
"RTN","RGNETBRP",35,0)
 .I 'DUZ,RGXUT>$P(XOPT,U,2),$$CHK(-7,3) Q
"RTN","RGNETBRP",36,0)
 .I 'DUZ,$$CHK(-4,4)
"RTN","RGNETBRP",37,0)
 I DUZ D
"RTN","RGNETBRP",38,0)
 .S DATA(0)=0,XUNOW=$$NOW^XLFDT,X=$$OPTCHK^RGNETBUT(AID)
"RTN","RGNETBRP",39,0)
 .Q:$$CHK(+X,2,$P(X,U,2),$P(X,U,3),$P(X,U,4))
"RTN","RGNETBRP",40,0)
 .Q:$$CHK(-$$INHIBIT^XUSRB,2)
"RTN","RGNETBRP",41,0)
 .I XUT>$P(XOPT,U,2),$$CHK(-7,3) Q
"RTN","RGNETBRP",42,0)
 .D USER^XUS(DUZ)
"RTN","RGNETBRP",43,0)
 .Q:$$CHK(-$$UVALID^XUS(),4)
"RTN","RGNETBRP",44,0)
 .Q:$$CHK(-$$USER^XUS1A,4)
"RTN","RGNETBRP",45,0)
 .F X=0:0 S X=$O(XUTEXT(X)) Q:'X  S DATA(2,X)=$E(XUTEXT(X),2,9999)
"RTN","RGNETBRP",46,0)
 .D DUZ^XUS1A,SAVE^XUS1,LOG^XUS1,ABT^XQ12
"RTN","RGNETBRP",47,0)
 .I $$VCVALID^XUSRB,$$CHK(-12,1)
"RTN","RGNETBRP",48,0)
 .I $G(RGNETB("UID")) D
"RTN","RGNETBRP",49,0)
 ..N UID
"RTN","RGNETBRP",50,0)
 ..S UID=RGNETB("UID"),RGNETB("UID")=0
"RTN","RGNETBRP",51,0)
 ..I '$D(^XTMP("RGNETB",UID)),$$CHK(25,5,UID) Q
"RTN","RGNETBRP",52,0)
 ..I $$SESSION^RGNETBUT(UID,"DUZ")'=DUZ,$$CHK(27,4,UID) Q
"RTN","RGNETBRP",53,0)
 ..I $$ISACTIVE^RGNETBUT(UID,1,60),$$CHK(26,4,UID) Q
"RTN","RGNETBRP",54,0)
 ..S RGNETB("UID")=UID
"RTN","RGNETBRP",55,0)
 ..D RESVAR^RGNETBUT,SETVAR^RGNETBUT("JOB",$J)
"RTN","RGNETBRP",56,0)
 ..D BRDCAST^RGNETBEV("LOGIN",$$SESSION^RGNETBUT)
"RTN","RGNETBRP",57,0)
 .E  D
"RTN","RGNETBRP",58,0)
 ..S RGNETB("UID")=$$UID^RGNETBUT
"RTN","RGNETBRP",59,0)
 ..D:$G(DIV) DIVSET(,DIV)
"RTN","RGNETBRP",60,0)
 ..D RESET(1)
"RTN","RGNETBRP",61,0)
 .S DATA(1)=RGNETB("UID")_U_$G(^XMB("NETNAME"))_U_$$GET1^DIQ(4,DUZ(2),".01")_U_DUZ
"RTN","RGNETBRP",62,0)
 .S:AID(0) ^XUTL("XQ",$J,1)=AID(0)_U_$G(^DIC(19,AID(0),0)),^("T")=1
"RTN","RGNETBRP",63,0)
 .D AUTOSET(SID),STSAVE^RGNETTCP(1)
"RTN","RGNETBRP",64,0)
 I +DATA(0)=4 D
"RTN","RGNETBRP",65,0)
 .S DATA(1)=$P(XUENV,U,3)_U_$P(XUVOL,U)_U_XUCI_U_+RGCFG("port")
"RTN","RGNETBRP",66,0)
 .D:$G(RGNETB("LEGACY")) INTRO^XUS1A("DATA(2)")
"RTN","RGNETBRP",67,0)
 Q
"RTN","RGNETBRP",68,0)
 ; Transform ID values
"RTN","RGNETBRP",69,0)
ID(ID) Q $E($TR($G(ID),U,"~"),1,40)
"RTN","RGNETBRP",70,0)
 ; RPC: Change verify code
"RTN","RGNETBRP",71,0)
CVC(DATA,OLD,NEW) ;
"RTN","RGNETBRP",72,0)
 S DATA=$$BRCVC^XUS2($$DECRYP^XUSRB1(OLD),$$DECRYP^XUSRB1(NEW))
"RTN","RGNETBRP",73,0)
 S:'DATA DATA="0^Your verify code has been changed."
"RTN","RGNETBRP",74,0)
 Q
"RTN","RGNETBRP",75,0)
 ; RPC: Get division list and default
"RTN","RGNETBRP",76,0)
DIVGET(DATA) ;
"RTN","RGNETBRP",77,0)
 N DIV,DEF,PRI,GBL,USR
"RTN","RGNETBRP",78,0)
 S (DIV,PRI)=0,USR=+$G(DUZ),GBL=$S(USR:$NA(^VA(200,USR,2)),1:$NA(^DG(40.8,"AD")))
"RTN","RGNETBRP",79,0)
 S DEF=+$S(USR:$G(DUZ(2)),1:$P($G(^XTV(8989.3,1,"XUS")),U,17))
"RTN","RGNETBRP",80,0)
 F  S DIV=$O(@GBL@(DIV)) Q:'DIV  S:USR PRI=$P(^(DIV,0),U,2) D
"RTN","RGNETBRP",81,0)
 .S DATA(DIV)=$$DIVINFO(DIV)
"RTN","RGNETBRP",82,0)
 .S:PRI DEF=DIV
"RTN","RGNETBRP",83,0)
 S:'DEF DEF=+$O(DATA(0))
"RTN","RGNETBRP",84,0)
 I DEF,'$D(DATA(DEF)) S DATA(DEF)=$$DIVINFO(DEF)
"RTN","RGNETBRP",85,0)
 S DATA(0)=DEF
"RTN","RGNETBRP",86,0)
 D:DEF DIVSET(,DIV)
"RTN","RGNETBRP",87,0)
 Q
"RTN","RGNETBRP",88,0)
 ; Return division info as
"RTN","RGNETBRP",89,0)
 ; IEN ^ NAME ^ STATION # ^ SHORT NAME
"RTN","RGNETBRP",90,0)
DIVINFO(DIV) ;
"RTN","RGNETBRP",91,0)
 N X0,X99
"RTN","RGNETBRP",92,0)
 S X0=$G(^DIC(4,DIV,0)),X99=$G(^(99))
"RTN","RGNETBRP",93,0)
 Q DIV_U_$P(X0,U)_U_$P(X99,U)_U_$P(X0,U,5)
"RTN","RGNETBRP",94,0)
 ; RPC: Set division
"RTN","RGNETBRP",95,0)
DIVSET(DATA,DIV) ;
"RTN","RGNETBRP",96,0)
 S DUZ(2)=+DIV,DATA=1
"RTN","RGNETBRP",97,0)
 D SETVAR^RGNETBUT("DUZ2",DUZ(2))
"RTN","RGNETBRP",98,0)
 D SETVAR^RGNETBUT("DUZ(2)",DUZ(2),-1)
"RTN","RGNETBRP",99,0)
 Q
"RTN","RGNETBRP",100,0)
 ; RPC: Get dialog text
"RTN","RGNETBRP",101,0)
DIALOG(DATA,DLG,P1,P2,P3) ;
"RTN","RGNETBRP",102,0)
 D GETDLG^RGNETBUT(DLG,.DATA,.P1,.P2,.P3)
"RTN","RGNETBRP",103,0)
 Q
"RTN","RGNETBRP",104,0)
 ; RPC: Reset session
"RTN","RGNETBRP",105,0)
RESET(LOGIN) ;
"RTN","RGNETBRP",106,0)
 Q:'$G(RGNETB("UID"))
"RTN","RGNETBRP",107,0)
 D STOPALL^RGNETBAS,UNSUBALL^RGNETBEV
"RTN","RGNETBRP",108,0)
 S LOGIN=+$G(LOGIN)
"RTN","RGNETBRP",109,0)
 N DUZ2
"RTN","RGNETBRP",110,0)
 S DUZ2=$$GETVAR^RGNETBUT("DUZ2")
"RTN","RGNETBRP",111,0)
 I 'LOGIN D
"RTN","RGNETBRP",112,0)
 .D CLOSE^RGNETBLG($$GETVAR^RGNETBUT("ALOG"_$S(DUZ2:":"_DUZ2,1:"")))
"RTN","RGNETBRP",113,0)
 .S IO("IP")=$$GETVAR^RGNETBUT("WIP")
"RTN","RGNETBRP",114,0)
 .D BRDCAST^RGNETBEV("LOGOUT",$$SESSION^RGNETBUT)
"RTN","RGNETBRP",115,0)
 .K ^XTMP("RGNETB",RGNETB("UID"))
"RTN","RGNETBRP",116,0)
 .L -^XTMP("RGNETB",RGNETB("UID"),0)
"RTN","RGNETBRP",117,0)
 .D BYE^XUSCLEAN
"RTN","RGNETBRP",118,0)
 E  D
"RTN","RGNETBRP",119,0)
 .N ENV,X,Y,V
"RTN","RGNETBRP",120,0)
 .K ^XTMP("RGNETB",RGNETB("UID"))
"RTN","RGNETBRP",121,0)
 .F ENV=0:1 S X=$P($T(ENVDATA+ENV),";;",2) Q:'$L(X)  D
"RTN","RGNETBRP",122,0)
 ..S V=$P(X,";",2),@("Y="_V)
"RTN","RGNETBRP",123,0)
 ..D SETVAR^RGNETBUT($P(X,";"),Y)
"RTN","RGNETBRP",124,0)
 ..D:$P(X,";",3) SETVAR^RGNETBUT(V,Y,-1)
"RTN","RGNETBRP",125,0)
 .D BRDCAST^RGNETBEV("LOGIN",$$SESSION^RGNETBUT)
"RTN","RGNETBRP",126,0)
 .S IO("IP")=$$GETVAR^RGNETBUT("WIP")
"RTN","RGNETBRP",127,0)
 .I $$ISACTIVE^RGNETBLG
"RTN","RGNETBRP",128,0)
 .D LOG^XUS1                                                           ;creates handle with client agent
"RTN","RGNETBRP",129,0)
 Q
"RTN","RGNETBRP",130,0)
 ; Environment data to save
"RTN","RGNETBRP",131,0)
 ;;Name;Value;Local
"RTN","RGNETBRP",132,0)
ENVDATA ;;DUZ;DUZ
"RTN","RGNETBRP",133,0)
 ;;DUZ0;DUZ(0);1
"RTN","RGNETBRP",134,0)
 ;;DUZ2;DUZ(2);1
"RTN","RGNETBRP",135,0)
 ;;USER;$P($G(^VA(200,DUZ,0)),U)
"RTN","RGNETBRP",136,0)
 ;;RDEV;$$RESDEV^RGNETBUT
"RTN","RGNETBRP",137,0)
 ;;LDT;$H
"RTN","RGNETBRP",138,0)
 ;;JOB;$J
"RTN","RGNETBRP",139,0)
 ;;AID;AID
"RTN","RGNETBRP",140,0)
 ;;AID0;AID(0)
"RTN","RGNETBRP",141,0)
 ;;WID;WID
"RTN","RGNETBRP",142,0)
 ;;WIP;WIP
"RTN","RGNETBRP",143,0)
 ;;UID;RGNETB("UID")
"RTN","RGNETBRP",144,0)
 ;;
"RTN","RGNETBRP",145,0)
 ; Check error code
"RTN","RGNETBRP",146,0)
CHK(ERR,RTN,P1,P2,P3) ;
"RTN","RGNETBRP",147,0)
 I ERR S DATA(0)=RTN_U_$S(ERR<0:$$TXT^XUS3(-ERR),1:$$GETDLG^RGNETBUT(ERR,,.P1,.P2,.P3)) S:RTN>1 DUZ=0
"RTN","RGNETBRP",148,0)
 Q ERR
"RTN","RGNETBRP",149,0)
 ; Attempt autoauthenticate using SID
"RTN","RGNETBRP",150,0)
 ; Returns DUZ if SID has been authenticated, 0 if prohibited from
"RTN","RGNETBRP",151,0)
 ; being authenticated, or null if never been authenticated.
"RTN","RGNETBRP",152,0)
AUTOLOG(SID) ;
"RTN","RGNETBRP",153,0)
 S SID=$S($L($G(SID))<3:"",1:$$DECRYP^XUSRB1(SID))
"RTN","RGNETBRP",154,0)
 Q:$E(SID,1,9)'="S-1-5-21-" 0
"RTN","RGNETBRP",155,0)
 S SID=$E(SID,10,999)
"RTN","RGNETBRP",156,0)
 Q:SID<1000 0
"RTN","RGNETBRP",157,0)
 N X
"RTN","RGNETBRP",158,0)
 S X=$$FIND1^DIC(996.513,"","QX",SID)
"RTN","RGNETBRP",159,0)
 Q $S(X:+$P($G(^RGNET(996.513,X,0)),U,2),1:"")
"RTN","RGNETBRP",160,0)
 ; Cache NT authentication information
"RTN","RGNETBRP",161,0)
AUTOSET(SID) ;
"RTN","RGNETBRP",162,0)
 Q:$$AUTOLOG(.SID)'=""
"RTN","RGNETBRP",163,0)
 N FLD
"RTN","RGNETBRP",164,0)
 S FLD(996.513,"+1,",.01)=SID
"RTN","RGNETBRP",165,0)
 S FLD(996.513,"+1,",1)=DUZ
"RTN","RGNETBRP",166,0)
 S FLD(996.513,"+1,",2)=$$NOW^XLFDT
"RTN","RGNETBRP",167,0)
 D UPDATE^DIE("","FLD")
"RTN","RGNETBRP",168,0)
 Q
"RTN","RGNETBRP",169,0)
 ; RPC: Get list of active RPCs
"RTN","RGNETBRP",170,0)
GETRPCS(DATA) ;
"RTN","RGNETBRP",171,0)
 N X
"RTN","RGNETBRP",172,0)
 D LIST^DIC(8994,,".01","Q",,,,,"I ""03""[$P(^(0),U,6)",,.DATA)
"RTN","RGNETBRP",173,0)
 S X=""
"RTN","RGNETBRP",174,0)
 F  S X=$O(@DATA@(X)) Q:'$L(X)  K:X'="ID" @DATA@(X)
"RTN","RGNETBRP",175,0)
 Q
"RTN","RGNETBRP",176,0)
 ; RPC: Can RPC be executed in current context
"RTN","RGNETBRP",177,0)
CANRUN(DATA,RPC) ;
"RTN","RGNETBRP",178,0)
 S DATA=$$CANRUN^RGNETBAC($$FIND1^DIC(8994,,"QX",RPC),RGNETB("CTX"))
"RTN","RGNETBRP",179,0)
 Q
"RTN","RGNETBRP",180,0)
 ; RPC: Retrieve list of active sessions
"RTN","RGNETBRP",181,0)
GETSESSN(DATA,VAR,AID) ;
"RTN","RGNETBRP",182,0)
 N X,Z,C
"RTN","RGNETBRP",183,0)
 S DATA=$$TMPGBL
"RTN","RGNETBRP",184,0)
 F C=1:1 Q:'$$NXTUID^RGNETBUT(.X,,.AID)  S @DATA@(C)=$$SESSION^RGNETBUT(X,.VAR)
"RTN","RGNETBRP",185,0)
 Q
"RTN","RGNETBRP",186,0)
 ; RPC: Get stored variable(s)
"RTN","RGNETBRP",187,0)
GETVAR(DATA,LIST,NMSP) ;
"RTN","RGNETBRP",188,0)
 N CNT
"RTN","RGNETBRP",189,0)
 S:$L($G(LIST)) LIST(-99)=LIST
"RTN","RGNETBRP",190,0)
 S LIST="",CNT=0
"RTN","RGNETBRP",191,0)
 S:0[$G(NMSP) NMSP="@"
"RTN","RGNETBRP",192,0)
 F  S LIST=$O(LIST(LIST)) Q:'$L(LIST)  D
"RTN","RGNETBRP",193,0)
 .S CNT=CNT+1,DATA(CNT)=LIST(LIST)_"="_$$GETVAR^RGNETBUT(LIST(LIST),,NMSP)
"RTN","RGNETBRP",194,0)
 Q
"RTN","RGNETBRP",195,0)
 ; RPC: Set stored variable(s)
"RTN","RGNETBRP",196,0)
SETVAR(DATA,LIST,NMSP,RESET) ;
"RTN","RGNETBRP",197,0)
 S:$L($G(LIST)) LIST(-99)=LIST
"RTN","RGNETBRP",198,0)
 S LIST="",DATA=0
"RTN","RGNETBRP",199,0)
 S:0[$G(NMSP) NMSP="@"
"RTN","RGNETBRP",200,0)
 D:$G(RESET) CLRVAR^RGNETBUT(NMSP)
"RTN","RGNETBRP",201,0)
 F  S LIST=$O(LIST(LIST)) Q:'$L(LIST)  D
"RTN","RGNETBRP",202,0)
 .S DATA=DATA+1
"RTN","RGNETBRP",203,0)
 .D SETVAR^RGNETBUT($P(LIST(LIST),"="),$P(LIST(LIST),"=",2,9999),NMSP)
"RTN","RGNETBRP",204,0)
 Q
"RTN","RGNETBRP",205,0)
 ; RPC: Get requested session info
"RTN","RGNETBRP",206,0)
 ; TYPE = 0=subscriptions, 1=local vars, 2=session vars, 3=locks, 4=pending async RPCs
"RTN","RGNETBRP",207,0)
 ; UID  = Session ID (defaults to current session)
"RTN","RGNETBRP",208,0)
GETINFO(DATA,TYPE,UID) ;
"RTN","RGNETBRP",209,0)
 S UID=$G(UID,$G(RGNETB("UID")))
"RTN","RGNETBRP",210,0)
 I TYPE=0 D  Q
"RTN","RGNETBRP",211,0)
 .N EV,CN
"RTN","RGNETBRP",212,0)
 .S EV="",CN=0
"RTN","RGNETBRP",213,0)
 .F  S EV=$O(^XTMP("RGNETB",UID,"S",EV)) Q:'$L(EV)  D
"RTN","RGNETBRP",214,0)
 ..S CN=CN+1,@DATA@(CN)=EV
"RTN","RGNETBRP",215,0)
 I TYPE=1 D  Q
"RTN","RGNETBRP",216,0)
 .D CAPTURE^RGUTHFS("ZWRITE  N X F X=""$ET"",""$EC"",""$ES"",""$J"",""$ZE"",""$ZT"" W !,X,""="",@X",DATA,99999)
"RTN","RGNETBRP",217,0)
 I TYPE=2 D  Q
"RTN","RGNETBRP",218,0)
 .N NS,VN,VL,CN
"RTN","RGNETBRP",219,0)
 .S NS="",CN=0
"RTN","RGNETBRP",220,0)
 .F  S NS=$O(^XTMP("RGNETB",UID,"V",NS)),VN="" Q:'$L(NS)  D
"RTN","RGNETBRP",221,0)
 ..F  S VN=$O(^XTMP("RGNETB",UID,"V",NS,VN)) Q:'$L(VN)  S VL=$G(^(VN)) D
"RTN","RGNETBRP",222,0)
 ...S CN=CN+1,@DATA@(CN)=$S(NS=0:"<default>",NS=-1:"<mapped>",1:NS)_U_VN_U_VL
"RTN","RGNETBRP",223,0)
 I TYPE=3 D  Q
"RTN","RGNETBRP",224,0)
 .N GBL,CN,VL
"RTN","RGNETBRP",225,0)
 .S GBL="",CN=0
"RTN","RGNETBRP",226,0)
 .F  S GBL=$O(^XTMP("RGNETB",UID,"L",GBL)) Q:'$L(GBL)  S VL=$G(^(GBL)) D
"RTN","RGNETBRP",227,0)
 ..S CN=CN+1,@DATA@(CN)=$TR(GBL,U,"~")_U_VL
"RTN","RGNETBRP",228,0)
 I TYPE=4 D  Q
"RTN","RGNETBRP",229,0)
 .N TSK,CN
"RTN","RGNETBRP",230,0)
 .S (TSK,CN)=0
"RTN","RGNETBRP",231,0)
 .F  S TSK=$O(^XTMP("RGNETB",UID,"T",TSK)) Q:'TSK  D
"RTN","RGNETBRP",232,0)
 ..S CN=CN+1,@DATA@(CN)=TSK_U_$G(^%ZTSK(TSK,.03),"Unknown")
"RTN","RGNETBRP",233,0)
 S @DATA@(1)="Unknown request type: "_TYPE
"RTN","RGNETBRP",234,0)
 Q
"RTN","RGNETBRP",235,0)
 ; Lock/unlock global reference
"RTN","RGNETBRP",236,0)
 ; GBL  = Global reference
"RTN","RGNETBRP",237,0)
 ; OPR  = Operation to perform:
"RTN","RGNETBRP",238,0)
 ;        >=0: Value is timeout for lock operation.  Returns success.
"RTN","RGNETBRP",239,0)
 ;         <0: Returns # of active locks for node.
"RTN","RGNETBRP",240,0)
 ;    missing: Performs unlock operation.  Returns success.
"RTN","RGNETBRP",241,0)
 ; DATA = Returns status according to value of OPR.
"RTN","RGNETBRP",242,0)
LOCK(DATA,GBL,OPR) ;
"RTN","RGNETBRP",243,0)
 N LCK
"RTN","RGNETBRP",244,0)
 S LCK=$D(OPR),OPR=+$G(OPR),GBL=$NA(@GBL)
"RTN","RGNETBRP",245,0)
 I OPR<0 S DATA=$$LOCKCNT(GBL)
"RTN","RGNETBRP",246,0)
 E  I LCK D
"RTN","RGNETBRP",247,0)
 .L +@GBL:OPR
"RTN","RGNETBRP",248,0)
 .S DATA=$T
"RTN","RGNETBRP",249,0)
 .I DATA,$$LOCKCNT(GBL,1)
"RTN","RGNETBRP",250,0)
 E  D
"RTN","RGNETBRP",251,0)
 .S DATA=''$$LOCKCNT(GBL,-1)
"RTN","RGNETBRP",252,0)
 .L:DATA -@GBL
"RTN","RGNETBRP",253,0)
 Q
"RTN","RGNETBRP",254,0)
 ; RPC: Restore locks (after reconnect)
"RTN","RGNETBRP",255,0)
 ; Data returns list of locks that could not be restored.
"RTN","RGNETBRP",256,0)
LOCKRES(DATA) ;
"RTN","RGNETBRP",257,0)
 N GBL,CNT,X
"RTN","RGNETBRP",258,0)
 S GBL="",X=0
"RTN","RGNETBRP",259,0)
 F  S GBL=$O(^XTMP("RGNETB",RGNETB("UID"),"L",GBL)) Q:'$L(GBL)  S CNT=+$G(^(GBL))  D
"RTN","RGNETBRP",260,0)
 .F CNT=CNT:-1:1 L +@GBL:1 E  D  Q
"RTN","RGNETBRP",261,0)
 ..S X=X+1,@DATA@(X)=GBL
"RTN","RGNETBRP",262,0)
 ..K ^XTMP("RGNETB",RGNETB("UID"),"L",GBL)
"RTN","RGNETBRP",263,0)
 Q
"RTN","RGNETBRP",264,0)
 ; Return lock count.  Optionally increment/decrement afterwards.
"RTN","RGNETBRP",265,0)
 ; Note use of naked reference.
"RTN","RGNETBRP",266,0)
LOCKCNT(GBL,INC) ;
"RTN","RGNETBRP",267,0)
 N X,Y
"RTN","RGNETBRP",268,0)
 S X=+$G(^XTMP("RGNETB",RGNETB("UID"),"L",GBL)),Y=X+$G(INC)            ; Sets naked reference
"RTN","RGNETBRP",269,0)
 I Y>0 S ^(GBL)=Y
"RTN","RGNETBRP",270,0)
 E  K ^(GBL)
"RTN","RGNETBRP",271,0)
 Q X
"RTN","RGNETBRP",272,0)
 ; RPC: Process an HTTP request via broker call
"RTN","RGNETBRP",273,0)
HTTPREQ(DATA,REQUEST) ;
"RTN","RGNETBRP",274,0)
 S:$D(REQUEST)=1 REQUEST(1)=REQUEST
"RTN","RGNETBRP",275,0)
 S DATA=$$ENTRYARY^RGNETWWW(.REQUEST)
"RTN","RGNETBRP",276,0)
 Q
"RTN","RGNETBRP",277,0)
 ; Get temp global reference
"RTN","RGNETBRP",278,0)
TMPGBL(X) ;
"RTN","RGNETBRP",279,0)
 K ^TMP("RGNETBTMP"_$G(X),$J) Q $NA(^($J))
"RTN","RGNETBUT")
0^60^B38250970
"RTN","RGNETBUT",1,0)
RGNETBUT ;RI/CBMI/DKM - NETSERV RPC Broker Utilities ;01-Apr-2015 14:12;DKM
"RTN","RGNETBUT",2,0)
 ;;1.0;NETWORK SERVICES;;01-Apr-2015;Build 53
"RTN","RGNETBUT",3,0)
 ;=================================================================
"RTN","RGNETBUT",4,0)
 ; Cleanup stray global nodes
"RTN","RGNETBUT",5,0)
CLEANUP ;EP
"RTN","RGNETBUT",6,0)
 N UID
"RTN","RGNETBUT",7,0)
 F  Q:'$$NXTUID(.UID,0)  K ^XTMP("RGNETB",UID)
"RTN","RGNETBUT",8,0)
 Q
"RTN","RGNETBUT",9,0)
 ; Force RPC context tables to be rebuilt for all active sessions
"RTN","RGNETBUT",10,0)
REBLDCTX ;EP
"RTN","RGNETBUT",11,0)
 N UID,CTX
"RTN","RGNETBUT",12,0)
 F  Q:'$$NXTUID(.UID)  D
"RTN","RGNETBUT",13,0)
 .F CTX=0:0 S CTX=$O(^XTMP("RGNETB",UID,"C",CTX)) Q:'CTX  S ^(CTX)=0
"RTN","RGNETBUT",14,0)
 Q
"RTN","RGNETBUT",15,0)
 ; Get globally unique instance ID
"RTN","RGNETBUT",16,0)
UID() N UID,FLG
"RTN","RGNETBUT",17,0)
 L +^XTMP("RGNETB",0):5
"RTN","RGNETBUT",18,0)
 E  Q "-3^Cannot initialize environment"
"RTN","RGNETBUT",19,0)
 S FLG=0
"RTN","RGNETBUT",20,0)
 F UID=$P($G(^XTMP("RGNETB",0)),U,3)+1:1 D  Q:(UID<1)!(FLG=2)
"RTN","RGNETBUT",21,0)
 .I (UID<1)!(UID>999999) D  Q:UID<1
"RTN","RGNETBUT",22,0)
 ..S UID=$S('FLG:1,1:"-4^Lock table is full"),FLG=1
"RTN","RGNETBUT",23,0)
 .S:'$$ISACTIVE(UID,1) FLG=2
"RTN","RGNETBUT",24,0)
 S:UID>0 ^XTMP("RGNETB",0)=(DT+10000)_U_DT_U_UID
"RTN","RGNETBUT",25,0)
 L -^XTMP("RGNETB",0)
"RTN","RGNETBUT",26,0)
 Q UID
"RTN","RGNETBUT",27,0)
 ; Verifies that a session is truly active
"RTN","RGNETBUT",28,0)
 ;   UID = Unique id of session
"RTN","RGNETBUT",29,0)
 ;   LCK = If nonzero, leave lock active (defaults to 0)
"RTN","RGNETBUT",30,0)
 ;   TMO = Optional lock timeout (defaults to 0)
"RTN","RGNETBUT",31,0)
ISACTIVE(UID,LCK,TMO) ;EP
"RTN","RGNETBUT",32,0)
 Q:'$G(UID) 0
"RTN","RGNETBUT",33,0)
 Q:UID=$G(RGNETB("UID")) 1
"RTN","RGNETBUT",34,0)
 L +^XTMP("RGNETB",UID,0):+$G(TMO)
"RTN","RGNETBUT",35,0)
 E  Q 1
"RTN","RGNETBUT",36,0)
 L:'$G(LCK) -^XTMP("RGNETB",UID,0)
"RTN","RGNETBUT",37,0)
 Q 0
"RTN","RGNETBUT",38,0)
 ; Gets the session ID associated with this process
"RTN","RGNETBUT",39,0)
 ; If not in session context, attempt answerback from client
"RTN","RGNETBUT",40,0)
GETUID() ;EP
"RTN","RGNETBUT",41,0)
 I '$D(RGNETB("UID")) D
"RTN","RGNETBUT",42,0)
 .S RGNETB("UID")=""
"RTN","RGNETBUT",43,0)
 .Q:$D(ZTQUEUED)
"RTN","RGNETBUT",44,0)
 .N X,UID,I
"RTN","RGNETBUT",45,0)
 .S I=$I,UID=""
"RTN","RGNETBUT",46,0)
 .U $S($D(IO(0)):IO(0),1:$P)                                           ; Use home device
"RTN","RGNETBUT",47,0)
 .X ^%ZOSF("EOFF")                                                     ; Suppress echo
"RTN","RGNETBUT",48,0)
 .F  R X#1:0 Q:'$T                                                     ; Flush keyboard buffer
"RTN","RGNETBUT",49,0)
 .W $C(5)                                                              ; Send answerback request
"RTN","RGNETBUT",50,0)
 .F  R X:4 Q:'$T&'$L(X)  S UID=UID_X                                   ; Listen for response
"RTN","RGNETBUT",51,0)
 .S UID=$P(UID,"RG#",2)
"RTN","RGNETBUT",52,0)
 .X ^%ZOSF("EON")                                                      ; Restore echo
"RTN","RGNETBUT",53,0)
 .U I                                                                  ; Restore previous device
"RTN","RGNETBUT",54,0)
 .I $$ISACTIVE(UID),$$GETVAR("DUZ",,,UID)=DUZ S RGNETB("UID")=UID
"RTN","RGNETBUT",55,0)
 .E  S RGNETB("UID")=""
"RTN","RGNETBUT",56,0)
 Q:$Q RGNETB("UID")
"RTN","RGNETBUT",57,0)
 Q
"RTN","RGNETBUT",58,0)
 ; Retrieve next session ID from list
"RTN","RGNETBUT",59,0)
 ;   UID passed as last ID processed, returned as next ID or null
"RTN","RGNETBUT",60,0)
 ;   FLT = <0=all; 0=inactive only; >0=active only (default)
"RTN","RGNETBUT",61,0)
 ;   AID = Application ID (optional)
"RTN","RGNETBUT",62,0)
 ;   Return value is true if ID found
"RTN","RGNETBUT",63,0)
NXTUID(UID,FLT,AID) ;EP
"RTN","RGNETBUT",64,0)
 N PFX,FND,ALL,ACT
"RTN","RGNETBUT",65,0)
 S FLT=+$G(FLT,1),FND=0,ALL=FLT<0,ACT=FLT>0,AID=$$OPTLKP(.AID),UID=+$G(UID)
"RTN","RGNETBUT",66,0)
 I $L(AID) F  S UID=$O(^XTMP("RGNETB",UID)) Q:'UID  D  Q:FND
"RTN","RGNETBUT",67,0)
 .I AID,$$GETVAR("AID0",,,UID)'=AID Q
"RTN","RGNETBUT",68,0)
 .I 'ALL,$$ISACTIVE(UID)'=ACT Q
"RTN","RGNETBUT",69,0)
 .S FND=1
"RTN","RGNETBUT",70,0)
 S:'FND UID=""
"RTN","RGNETBUT",71,0)
 Q:$Q FND
"RTN","RGNETBUT",72,0)
 Q
"RTN","RGNETBUT",73,0)
 ; Retrieve a package parameter value
"RTN","RGNETBUT",74,0)
PARAM(PAR,MIN,MAX) ;EP
"RTN","RGNETBUT",75,0)
 S VAL=+$$GET^XPAR("ALL",PAR)
"RTN","RGNETBUT",76,0)
 S:VAL<MIN VAL=MIN
"RTN","RGNETBUT",77,0)
 S:VAL>MAX VAL=MAX
"RTN","RGNETBUT",78,0)
 Q VAL
"RTN","RGNETBUT",79,0)
 ; Return free resource device
"RTN","RGNETBUT",80,0)
RESDEV() ;EP
"RTN","RGNETBUT",81,0)
 N RD,MX,SL,UID,X,C
"RTN","RGNETBUT",82,0)
 S MX=$$PARAM("RGNETB RESOURCE DEVICE COUNT",1,20)
"RTN","RGNETBUT",83,0)
 S SL=$$PARAM("RGNETB RESOURCE DEVICE SLOTS",1,20)
"RTN","RGNETBUT",84,0)
 F  Q:'$$NXTUID(.UID)  D
"RTN","RGNETBUT",85,0)
 .S RD=$$GETVAR("RDEV",,,UID)
"RTN","RGNETBUT",86,0)
 .S:RD RD(RD)=$G(RD(RD))+1
"RTN","RGNETBUT",87,0)
 S RD=1,C=999999
"RTN","RGNETBUT",88,0)
 F X=1:1:MX S:+$G(RD(X))<C RD=X,C=+$G(RD(X))
"RTN","RGNETBUT",89,0)
 S X=$$RES^XUDHSET("RGNETB THREAD RESOURCE #"_RD,,SL,"RG Broker Asynchronous Callbacks")
"RTN","RGNETBUT",90,0)
 Q RD
"RTN","RGNETBUT",91,0)
 ; Set maximum slots for resource devices
"RTN","RGNETBUT",92,0)
SETSLOTS(CNT) ;EP
"RTN","RGNETBUT",93,0)
 N RES,IEN,FDA,X,Y
"RTN","RGNETBUT",94,0)
 Q:CNT<2!(CNT>20)
"RTN","RGNETBUT",95,0)
 D FIND^DIC(3.5,,"@","UP","RGNETB THREAD RESOURCE #",,"B")
"RTN","RGNETBUT",96,0)
 F RES=0:0 S RES=$O(^TMP("DILIST",$J,RES)) Q:'RES  S IEN=+$G(^(RES,0)) D:IEN
"RTN","RGNETBUT",97,0)
 .S FDA(3.5,IEN_",",35)=CNT
"RTN","RGNETBUT",98,0)
 D FILE^DIE("K","FDA")
"RTN","RGNETBUT",99,0)
 K ^TMP("DILIST",$J),^TMP("DIERR",$J)
"RTN","RGNETBUT",100,0)
 Q
"RTN","RGNETBUT",101,0)
 ; Return info for session
"RTN","RGNETBUT",102,0)
SESSION(UID,VAR) ;EP
"RTN","RGNETBUT",103,0)
 N X,Y,Z
"RTN","RGNETBUT",104,0)
 S (X,Y)=""
"RTN","RGNETBUT",105,0)
 S:'$L($G(VAR)) VAR="UID^WID^AID^DUZ^USER^LDT^JOB"
"RTN","RGNETBUT",106,0)
 F Z=1:1:$L(VAR,U) S X=X_Y_$$GETVAR($P(VAR,U,Z),,,.UID),Y=U
"RTN","RGNETBUT",107,0)
 Q X
"RTN","RGNETBUT",108,0)
 ; Show active sessions
"RTN","RGNETBUT",109,0)
 ;   AID = optional application id
"RTN","RGNETBUT",110,0)
 ;   FLT = <0=all; 0=inactive only; >0=active only (default)
"RTN","RGNETBUT",111,0)
SHOWSESS(AID,FLT) ;EP
"RTN","RGNETBUT",112,0)
 N C,X,Z
"RTN","RGNETBUT",113,0)
 F C=0:1 Q:'$$NXTUID(.X,.FLT,.AID)  D
"RTN","RGNETBUT",114,0)
 .W "#",X,?10,$$HTE^XLFDT($$GETVAR("LDT",,,X)),?40,$$GETVAR("WID",,,X),?60,$$GETVAR("USER",,,X),!
"RTN","RGNETBUT",115,0)
 W !,$S('C:"No sessions are",C=1:"One session is",1:C_" sessions are")," ",$S(FLT>0:"active",FLT<0:"present",1:"inactive"),".",!
"RTN","RGNETBUT",116,0)
 Q:$Q C
"RTN","RGNETBUT",117,0)
 Q
"RTN","RGNETBUT",118,0)
 ; Fetch an environment variable
"RTN","RGNETBUT",119,0)
 ;   NAME = Variable name
"RTN","RGNETBUT",120,0)
 ;   DFLT = Optional default value
"RTN","RGNETBUT",121,0)
 ;   NMSP = Optional namespace (defaults to global)
"RTN","RGNETBUT",122,0)
 ;   UID  = Optional session id (default to current)
"RTN","RGNETBUT",123,0)
GETVAR(NAME,DFLT,NMSP,UID) ;EP
"RTN","RGNETBUT",124,0)
 D FMTVAR(.UID,.NMSP,.NAME)
"RTN","RGNETBUT",125,0)
 Q $S('UID:"",1:$G(^XTMP("RGNETB",UID,"V",NMSP,NAME),$G(DFLT)))
"RTN","RGNETBUT",126,0)
 ; Save an environment variable
"RTN","RGNETBUT",127,0)
 ;   NAME = Variable name
"RTN","RGNETBUT",128,0)
 ;   VALUE = Value to be assigned (if not specified, entry is deleted)
"RTN","RGNETBUT",129,0)
 ;   NMSP = Optional namespace (defaults to global)
"RTN","RGNETBUT",130,0)
SETVAR(NAME,VALUE,NMSP,UID) ;EP
"RTN","RGNETBUT",131,0)
 N $ET
"RTN","RGNETBUT",132,0)
 S $ET="S $EC="""" G ERRVAR^RGNETBUT"
"RTN","RGNETBUT",133,0)
 D FMTVAR(.UID,.NMSP,.NAME)
"RTN","RGNETBUT",134,0)
 I 'UID Q:$Q 0 Q
"RTN","RGNETBUT",135,0)
 L +^XTMP("RGNETB",UID,"V",NMSP,NAME):1
"RTN","RGNETBUT",136,0)
 ;E  Q:$Q 0 Q
"RTN","RGNETBUT",137,0)
 I $D(VALUE) S:NMSP=-1 @NAME=VALUE S ^XTMP("RGNETB",UID,"V",NMSP,NAME)=VALUE
"RTN","RGNETBUT",138,0)
 E  K:NMSP=-1 @NAME K ^XTMP("RGNETB",UID,"V",NMSP,NAME)
"RTN","RGNETBUT",139,0)
 L -^XTMP("RGNETB",UID,"V",NMSP,NAME)
"RTN","RGNETBUT",140,0)
 Q:$Q 1
"RTN","RGNETBUT",141,0)
 Q
"RTN","RGNETBUT",142,0)
 ; Clear all variables in a namespace
"RTN","RGNETBUT",143,0)
CLRVAR(NMSP,UID) ;EP
"RTN","RGNETBUT",144,0)
 N NAME,RES
"RTN","RGNETBUT",145,0)
 D FMTVAR(.UID,.NMSP)
"RTN","RGNETBUT",146,0)
 L +^XTMP("RGNETB",UID,"V",NMSP):1
"RTN","RGNETBUT",147,0)
 ;E  Q:$Q 0 Q
"RTN","RGNETBUT",148,0)
 S NAME="",RES=1
"RTN","RGNETBUT",149,0)
 F  S NAME=$O(^XTMP("RGNETB",UID,"V",NMSP,NAME)) Q:'$L(NAME)  S RES=RES&$$SETVAR(NAME,,NMSP,UID)
"RTN","RGNETBUT",150,0)
 L -^XTMP("RGNETB",UID,"V",NMSP)
"RTN","RGNETBUT",151,0)
 Q:$Q RES
"RTN","RGNETBUT",152,0)
 Q
"RTN","RGNETBUT",153,0)
 ; Restore variables from local variable namespace
"RTN","RGNETBUT",154,0)
RESVAR N NAME,UID
"RTN","RGNETBUT",155,0)
 D FMTVAR(.UID)
"RTN","RGNETBUT",156,0)
 S NAME=""
"RTN","RGNETBUT",157,0)
 F  S NAME=$O(^XTMP("RGNETB",UID,"V",-1,NAME)) Q:'$L(NAME)  S @NAME=^(NAME)
"RTN","RGNETBUT",158,0)
 Q
"RTN","RGNETBUT",159,0)
 ; Error handler for var calls
"RTN","RGNETBUT",160,0)
ERRVAR L -^XTMP("RGNETB",UID,"V",NMSP,NAME)
"RTN","RGNETBUT",161,0)
 Q:$Q 0
"RTN","RGNETBUT",162,0)
 Q
"RTN","RGNETBUT",163,0)
 ; Format arguments for var calls
"RTN","RGNETBUT",164,0)
FMTVAR(UID,NMSP,NAME) ;
"RTN","RGNETBUT",165,0)
 S UID=$G(UID,$G(RGNETB("UID")))
"RTN","RGNETBUT",166,0)
 S NMSP=$$UP^XLFSTR($G(NMSP,0))
"RTN","RGNETBUT",167,0)
 S NAME=$$UP^XLFSTR($G(NAME))
"RTN","RGNETBUT",168,0)
 S:NMSP=-1&$L(NAME) NAME=$NA(@NAME)
"RTN","RGNETBUT",169,0)
 Q
"RTN","RGNETBUT",170,0)
 ; Retrieve dialog text
"RTN","RGNETBUT",171,0)
 ;  NUM = Dialog number (relative or absolute)
"RTN","RGNETBUT",172,0)
 ; .DLG = Array to receive text
"RTN","RGNETBUT",173,0)
 ;  Pn  = Optional parameters (up to 3)
"RTN","RGNETBUT",174,0)
GETDLG(NUM,DLG,P1,P2,P3) ;
"RTN","RGNETBUT",175,0)
 N X
"RTN","RGNETBUT",176,0)
 S:NUM<100 NUM=NUM+9965400
"RTN","RGNETBUT",177,0)
 S P1=$G(P1,$G(RGNETB("RPC")))
"RTN","RGNETBUT",178,0)
 S X=$$GETDLG^RGUT(NUM,.DLG,.P1,.P2,.P3)
"RTN","RGNETBUT",179,0)
 Q:$Q X
"RTN","RGNETBUT",180,0)
 Q
"RTN","RGNETBUT",181,0)
 ; Lookup option, returning IEN
"RTN","RGNETBUT",182,0)
OPTLKP(OPT) ;EP
"RTN","RGNETBUT",183,0)
 Q $S('$L($G(OPT)):0,OPT=+OPT:OPT,1:$O(^DIC(19,"B",OPT,0)))
"RTN","RGNETBUT",184,0)
 ; Get/set out-of-order message for option
"RTN","RGNETBUT",185,0)
 ;   MSG = New message (if passed, a set is performed, otherwise a get)
"RTN","RGNETBUT",186,0)
 ;   Returns current message text
"RTN","RGNETBUT",187,0)
OPTMSG(OPT,MSG) ;EP
"RTN","RGNETBUT",188,0)
 S OPT=+$$OPTLKP(.OPT)
"RTN","RGNETBUT",189,0)
 I OPT,$D(^DIC(19,OPT,0)) D                                            ; Sets naked ref
"RTN","RGNETBUT",190,0)
 .I $D(MSG) S $P(^(0),U,3)=MSG
"RTN","RGNETBUT",191,0)
 .E  S MSG=$P(^(0),U,3)
"RTN","RGNETBUT",192,0)
 E  S MSG=""
"RTN","RGNETBUT",193,0)
 Q:$Q MSG
"RTN","RGNETBUT",194,0)
 Q
"RTN","RGNETBUT",195,0)
 ; Check option for valid access
"RTN","RGNETBUT",196,0)
 ;   OPT=Option IEN or name
"RTN","RGNETBUT",197,0)
 ;   TYP=Optional option type to check
"RTN","RGNETBUT",198,0)
 ;   Returns 0 if OK, <err code>^<err param> otherwise
"RTN","RGNETBUT",199,0)
OPTCHK(OPT,TYP) ;EP
"RTN","RGNETBUT",200,0)
 N XQY,X,Y,Z
"RTN","RGNETBUT",201,0)
 S XQY=$S(OPT=+OPT:OPT,1:$$OPTLKP(OPT))
"RTN","RGNETBUT",202,0)
 Q:XQY'>0 "2^"_OPT
"RTN","RGNETBUT",203,0)
 S X=$G(^DIC(19,XQY,0)),Y=$P($G(^(3)),U),Z=$P(X,U,3)
"RTN","RGNETBUT",204,0)
 Q:$L(Z) "19^"_Z
"RTN","RGNETBUT",205,0)
 I $L($G(TYP)),$P(X,U,4)'=TYP Q "20^"_OPT_U_TYP
"RTN","RGNETBUT",206,0)
 I $P(X,U,16),$L(Y),$$KCHK^XUSRB(Y) Q "21^"_OPT_U_Y
"RTN","RGNETBUT",207,0)
 S Y=$P(X,U,6)
"RTN","RGNETBUT",208,0)
 I $L(Y),'$$KCHK^XUSRB(Y) Q "22^"_OPT_U_Y
"RTN","RGNETBUT",209,0)
 S X=$$NOW^XLFDT
"RTN","RGNETBUT",210,0)
 D ENTRY^XQ92
"RTN","RGNETBUT",211,0)
 Q:'X "23^"_OPT
"RTN","RGNETBUT",212,0)
 Q 0
"RTN","RGNETBUT",213,0)
 ; Nightly task to perform various cleanup procedures.
"RTN","RGNETBUT",214,0)
NIGHTLY ;EP
"RTN","RGNETBUT",215,0)
 D CLEANUP
"RTN","RGNETBUT",216,0)
 D DOPURGE^RGNETBEV(1)
"RTN","RGNETBUT",217,0)
 D DOPURGE^RGNETBLG
"RTN","RGNETBUT",218,0)
 Q
"RTN","RGNETOA")
0^61^B5024742
"RTN","RGNETOA",1,0)
RGNETOA ;RI/CBMI/DKM - OAuth2 Support ;17-Apr-2015 12:41;DKM
"RTN","RGNETOA",2,0)
 ;;1.0;NETWORK SERVICES;;14-March-2014;Build 53
"RTN","RGNETOA",3,0)
 ;=================================================================
"RTN","RGNETOA",4,0)
 ; Register a client application
"RTN","RGNETOA",5,0)
 ; Returns client id^client secret
"RTN","RGNETOA",6,0)
REGAPP(APPNAME,REDIRECT) ;
"RTN","RGNETOA",7,0)
 N IENS,FDA,ID,SECRET
"RTN","RGNETOA",8,0)
 S IENS=$O(^RGNET(996.53,"B",APPNAME,0))
"RTN","RGNETOA",9,0)
 S IENS=$S(IENS:IENS_",",1:"+1,")
"RTN","RGNETOA",10,0)
 S ID=$$UUID^RGUT,SECRET=$$UUID^RGUT
"RTN","RGNETOA",11,0)
 S FDA=$NA(FDA(996.53,IENS))
"RTN","RGNETOA",12,0)
 S @FDA@(.01)=APPNAME
"RTN","RGNETOA",13,0)
 S @FDA@(1)=ID
"RTN","RGNETOA",14,0)
 S @FDA@(2)=SECRET
"RTN","RGNETOA",15,0)
 S @FDA@(3)=3600
"RTN","RGNETOA",16,0)
 S @FDA@(10)=REDIRECT
"RTN","RGNETOA",17,0)
 D UPDATE^DIE("E","FDA")
"RTN","RGNETOA",18,0)
 Q:$Q ID_U_SECRET
"RTN","RGNETOA",19,0)
 Q
"RTN","RGNETOA",20,0)
 ; Lookup client by id
"RTN","RGNETOA",21,0)
 ; Returns true if successful
"RTN","RGNETOA",22,0)
GETCLNT(CLIENT) ;
"RTN","RGNETOA",23,0)
 Q:'$D(CLIENT) 0
"RTN","RGNETOA",24,0)
 Q:$D(CLIENT)=11 1
"RTN","RGNETOA",25,0)
 N IEN,N0,RU
"RTN","RGNETOA",26,0)
 S IEN=$S('$L(CLIENT):0,1:$O(^RGNET(996.53,"C",CLIENT,0)))
"RTN","RGNETOA",27,0)
 Q:'IEN 0
"RTN","RGNETOA",28,0)
 S N0=$G(^RGNET(996.53,IEN,0)),RU=$G(^(10))
"RTN","RGNETOA",29,0)
 S CLIENT=$P(N0,U,2),CLIENT("redirect_uri")=RU,CLIENT("name")=$P(N0,U)
"RTN","RGNETOA",30,0)
 S CLIENT("secret")=$P(N0,U,3),CLIENT("lifespan")=$P(N0,U,4),CLIENT("flow")=$P(N0,U,5)
"RTN","RGNETOA",31,0)
 S:'CLIENT("lifespan") CLIENT("lifespan")=3600
"RTN","RGNETOA",32,0)
 Q 1
"RTN","RGNETOA",33,0)
 ; Get root of OAUTH data store
"RTN","RGNETOA",34,0)
STORE(NODE) ;
"RTN","RGNETOA",35,0)
 N X
"RTN","RGNETOA",36,0)
 S X=$NA(^XTMP("RGNET_OAUTH"))
"RTN","RGNETOA",37,0)
 Q $S($D(NODE):$NA(@X@(NODE)),1:X)
"RTN","RGNETOA",38,0)
 ; Fetches an object of the given type from the data store
"RTN","RGNETOA",39,0)
GETOBJ(OBJ,TYPE,REMOVE) ;
"RTN","RGNETOA",40,0)
 Q:'$L($G(OBJ))
"RTN","RGNETOA",41,0)
 N STORE
"RTN","RGNETOA",42,0)
 S STORE=$$STORE(TYPE)
"RTN","RGNETOA",43,0)
 M OBJ=@STORE@(OBJ)
"RTN","RGNETOA",44,0)
 K:$G(REMOVE) @STORE@(OBJ)
"RTN","RGNETOA",45,0)
 Q
"RTN","RGNETOA",46,0)
 ; Writes an object of the given type to the data store
"RTN","RGNETOA",47,0)
SETOBJ(OBJ,TYPE) ;
"RTN","RGNETOA",48,0)
 N STORE
"RTN","RGNETOA",49,0)
 S STORE=$$STORE(TYPE)
"RTN","RGNETOA",50,0)
 K @STORE@(OBJ)
"RTN","RGNETOA",51,0)
 M @STORE@(OBJ)=OBJ
"RTN","RGNETOA",52,0)
 Q
"RTN","RGNETOA",53,0)
 ; Removes an object of the given type from the data store
"RTN","RGNETOA",54,0)
DELOBJ(OBJ,TYPE) ;
"RTN","RGNETOA",55,0)
 K:$L($G(OBJ)) @$$STORE(TYPE)@(OBJ)
"RTN","RGNETOA",56,0)
 Q
"RTN","RGNETOA",57,0)
 ; Builds a response
"RTN","RGNETOA",58,0)
BLDRSP(ATKN,RTKN) ;
"RTN","RGNETOA",59,0)
 N PF
"RTN","RGNETOA",60,0)
 S PF="{"
"RTN","RGNETOA",61,0)
 D GETATKN^RGNETOAT(.ATKN)
"RTN","RGNETOA",62,0)
 D PUT("access_token",ATKN,.PF)
"RTN","RGNETOA",63,0)
 D PUT("token_type","bearer",.PF)
"RTN","RGNETOA",64,0)
 D PUT("expires_in",ATKN("lifespan"),.PF)
"RTN","RGNETOA",65,0)
 D PUT("scope",ATKN("scope"),.PF)
"RTN","RGNETOA",66,0)
 D PUT("refresh_token",.RTKN,.PF)
"RTN","RGNETOA",67,0)
 D ADD^RGNETWWW("}")
"RTN","RGNETOA",68,0)
 Q
"RTN","RGNETOA",69,0)
 ; Wrap a value in quotes
"RTN","RGNETOA",70,0)
QT(X) Q """"_X_""""
"RTN","RGNETOA",71,0)
 ; Writes a name / value pair to output buffer
"RTN","RGNETOA",72,0)
PUT(PN,VL,PF) ;
"RTN","RGNETOA",73,0)
 Q:'$L($G(VL))
"RTN","RGNETOA",74,0)
 D ADD^RGNETWWW(PF_$$QT(PN)_":"_$$QT(VL))
"RTN","RGNETOA",75,0)
 S PF=","
"RTN","RGNETOA",76,0)
 Q
"RTN","RGNETOAA")
0^62^B3929417
"RTN","RGNETOAA",1,0)
RGNETOAA ;RI/CBMI/DKM - OAuth2 Authorization Endpoint ;17-Apr-2015 12:34;DKM
"RTN","RGNETOAA",2,0)
 ;;1.0;NETWORK SERVICES;;14-March-2014;Build 53
"RTN","RGNETOAA",3,0)
 ;=================================================================
"RTN","RGNETOAA",4,0)
 ; GET method handler
"RTN","RGNETOAA",5,0)
MGET N RT,GT,FLOW,CLIENT
"RTN","RGNETOAA",6,0)
 S RT=$$GETPARAM^RGNETWWW("response_type")
"RTN","RGNETOAA",7,0)
 S GT=$$GETPARAM^RGNETWWW("grant_type")
"RTN","RGNETOAA",8,0)
 S CLIENT=$$GETPARAM^RGNETWWW("client_id")
"RTN","RGNETOAA",9,0)
 I '$$GETCLNT^RGNETOA(.CLIENT) D SETSTAT^RGNETWWW(404) Q
"RTN","RGNETOAA",10,0)
 S FLOW=$S(RT="code":"W",RT="token":"U",GT="password":"P",GT="client_credentials":"C",1:"?")
"RTN","RGNETOAA",11,0)
 I FLOW'=CLIENT("flow") D SETSTAT^RGNETWWW(403) Q
"RTN","RGNETOAA",12,0)
 D @("AUTH"_FLOW)
"RTN","RGNETOAA",13,0)
 Q
"RTN","RGNETOAA",14,0)
 ; Web server flow: authorization code grant
"RTN","RGNETOAA",15,0)
AUTHW N CODE,LOCATION,STATE
"RTN","RGNETOAA",16,0)
 Q:'$$VALIDRDU
"RTN","RGNETOAA",17,0)
 Q:'$$AUTH^RGNETWWW(1)
"RTN","RGNETOAA",18,0)
 D SETSTAT^RGNETWWW(302)
"RTN","RGNETOAA",19,0)
 S CODE=$$NEWAUTH(.CLIENT,DUZ)
"RTN","RGNETOAA",20,0)
 S STATE=$$GETPARAM^RGNETWWW("state")
"RTN","RGNETOAA",21,0)
 S LOCATION=CLIENT("redirect_uri")_"?code="_CODE
"RTN","RGNETOAA",22,0)
 S:$L(STATE) LOCATION=LOCATION_"&state="_STATE
"RTN","RGNETOAA",23,0)
 D ADDHDR^RGNETWWW("Location: "_LOCATION)
"RTN","RGNETOAA",24,0)
 Q
"RTN","RGNETOAA",25,0)
 ; User-agent flow: implicit grant
"RTN","RGNETOAA",26,0)
AUTHU N ATKN
"RTN","RGNETOAA",27,0)
 Q:'$$VALIDRDU
"RTN","RGNETOAA",28,0)
 Q:'$$AUTH^RGNETWWW(1)
"RTN","RGNETOAA",29,0)
 S ATKN=$$NEWATKN^RGNETOAT(.CLIENT,DUZ,$$GETPARAM^RGNETWWW("scope"))
"RTN","RGNETOAA",30,0)
 D BLDRSP^RGNETOA(ATKN)
"RTN","RGNETOAA",31,0)
 Q
"RTN","RGNETOAA",32,0)
 ; Username and password flow
"RTN","RGNETOAA",33,0)
AUTHP D SETSTAT^RGNETWWW(501)
"RTN","RGNETOAA",34,0)
 Q
"RTN","RGNETOAA",35,0)
 ; Client credentials flow: access token
"RTN","RGNETOAA",36,0)
AUTHC D SETSTAT^RGNETWWW(501)
"RTN","RGNETOAA",37,0)
 Q
"RTN","RGNETOAA",38,0)
 ; Generate a new authorization code
"RTN","RGNETOAA",39,0)
NEWAUTH(CLIENT,USER) ;
"RTN","RGNETOAA",40,0)
 N AUTH
"RTN","RGNETOAA",41,0)
 S AUTH=$$UUID^RGUT,AUTH("user")=USER,AUTH("client")=CLIENT
"RTN","RGNETOAA",42,0)
 D SETOBJ^RGNETOA(.AUTH,"AUTH")
"RTN","RGNETOAA",43,0)
 Q AUTH
"RTN","RGNETOAA",44,0)
 ; Fetches (and removes) an authorization from the data store
"RTN","RGNETOAA",45,0)
GETAUTH(AUTH) ;
"RTN","RGNETOAA",46,0)
 D GETOBJ^RGNETOA(.AUTH,"AUTH",1)
"RTN","RGNETOAA",47,0)
 Q
"RTN","RGNETOAA",48,0)
 ; Validates the redirect uri
"RTN","RGNETOAA",49,0)
VALIDRDU() ;
"RTN","RGNETOAA",50,0)
 I CLIENT("redirect_uri")'=$$GETPARAM^RGNETWWW("redirect_uri") D SETSTAT^RGNETWWW(404) Q 0
"RTN","RGNETOAA",51,0)
 Q 1
"RTN","RGNETOAT")
0^63^B8374860
"RTN","RGNETOAT",1,0)
RGNETOAT ;RI/CBMI/DKM - OAuth2 Token Endpoint ;17-Apr-2015 12:37;DKM
"RTN","RGNETOAT",2,0)
 ;;1.0;NETWORK SERVICES;;14-March-2014;Build 53
"RTN","RGNETOAT",3,0)
 ;=================================================================
"RTN","RGNETOAT",4,0)
 ; POST method
"RTN","RGNETOAT",5,0)
MPOST N GT,POST
"RTN","RGNETOAT",6,0)
 D PARSEBD^RGNETWWW(.POST)
"RTN","RGNETOAT",7,0)
 S GT=$G(POST("grant_type",1,1))
"RTN","RGNETOAT",8,0)
 G GTAC:GT="authorization_code",GTRT:GT="refresh_token"
"RTN","RGNETOAT",9,0)
 D SETSTAT^RGNETWWW(501)
"RTN","RGNETOAT",10,0)
 Q
"RTN","RGNETOAT",11,0)
 ; Grant type = authorization_code
"RTN","RGNETOAT",12,0)
GTAC N CLIENT,AUTH,REDIRECT,SECRET,ATKN,RTKN
"RTN","RGNETOAT",13,0)
 S CLIENT=$G(POST("client_id",1,1)),AUTH=$G(POST("code",1,1))
"RTN","RGNETOAT",14,0)
 S REDIRECT=$G(POST("redirect_uri",1,1)),SECRET=$G(POST("client_secret",1,1))
"RTN","RGNETOAT",15,0)
 I '$L(CLIENT)!'$L(AUTH)!'$L(REDIRECT)!'$L(SECRET) D SETSTAT^RGNETWWW(400) Q
"RTN","RGNETOAT",16,0)
 D GETAUTH^RGNETOAA(.AUTH)
"RTN","RGNETOAT",17,0)
 I $D(AUTH)'>1 D SETSTAT^RGNETWWW(404) Q
"RTN","RGNETOAT",18,0)
 I AUTH("secret")'=SECRET D SETSTAT^RGNETWWW(403)
"RTN","RGNETOAT",19,0)
 S RTKN=$$NEWRTKN(.CLIENT,AUTH("user"),AUTH("scope"))
"RTN","RGNETOAT",20,0)
 I '$L(RTKN) D SETSTAT^RGNETWWW(403) Q
"RTN","RGNETOAT",21,0)
 S ATKN=$$REFATKN(.RTKN)
"RTN","RGNETOAT",22,0)
 D BLDRSP^RGNETOA(.ATKN,.RTKN)
"RTN","RGNETOAT",23,0)
 Q
"RTN","RGNETOAT",24,0)
 ; Grant type = refresh_token
"RTN","RGNETOAT",25,0)
GTRT N RTKN,ATKN
"RTN","RGNETOAT",26,0)
 S RTKN=$G(POST("refresh_token",1,1))
"RTN","RGNETOAT",27,0)
 S ATKN=$$REFATKN(RTKN)
"RTN","RGNETOAT",28,0)
 I '$L(ATKN) D SETSTAT^RGNETWWW(404) Q
"RTN","RGNETOAT",29,0)
 D BLDRSP^RGNETOA(.ATKN)
"RTN","RGNETOAT",30,0)
 Q
"RTN","RGNETOAT",31,0)
 ; Fetches an access token from the data store
"RTN","RGNETOAT",32,0)
GETATKN(ATKN) ;
"RTN","RGNETOAT",33,0)
 D GETOBJ^RGNETOA(.ATKN,"ATKN")
"RTN","RGNETOAT",34,0)
 Q
"RTN","RGNETOAT",35,0)
 ; Fetches a refresh token from the data store
"RTN","RGNETOAT",36,0)
GETRTKN(RTKN) ;
"RTN","RGNETOAT",37,0)
 D GETOBJ^RGNETOA(.RTKN,"RTKN")
"RTN","RGNETOAT",38,0)
 Q
"RTN","RGNETOAT",39,0)
 ; Writes an access token to the data store
"RTN","RGNETOAT",40,0)
SETATKN(ATKN) ;
"RTN","RGNETOAT",41,0)
 D SETOBJ^RGNETOA(.ATKN,"ATKN")
"RTN","RGNETOAT",42,0)
 Q
"RTN","RGNETOAT",43,0)
 ; Writes a refresh token to the data store
"RTN","RGNETOAT",44,0)
SETRTKN(RTKN) ;
"RTN","RGNETOAT",45,0)
 D SETOBJ^RGNETOA(.RTKN,"RTKN")
"RTN","RGNETOAT",46,0)
 Q
"RTN","RGNETOAT",47,0)
 ; Generate an access token
"RTN","RGNETOAT",48,0)
NEWATKN(CLIENT,USER,SCOPE) ;
"RTN","RGNETOAT",49,0)
 Q:'$$GETCLNT^RGNETOA(.CLIENT) ""
"RTN","RGNETOAT",50,0)
 N ATKN,EXP
"RTN","RGNETOAT",51,0)
 S ATKN=$$UUID^RGUT,EXP=$$FMADD^XLFDT($$NOW^XLFDT,0,0,0,CLIENT("lifespan"))
"RTN","RGNETOAT",52,0)
 S ATKN("user")=USER,ATKN("expiry")=EXP,ATKN("client")=CLIENT
"RTN","RGNETOAT",53,0)
 S ATKN("lifespan")=CLIENT("lifespan"),ATKN("scope")=SCOPE
"RTN","RGNETOAT",54,0)
 D SETATKN(.ATKN)
"RTN","RGNETOAT",55,0)
 Q ATKN
"RTN","RGNETOAT",56,0)
 ; Generate a refresh token
"RTN","RGNETOAT",57,0)
NEWRTKN(CLIENT,USER,SCOPE) ;
"RTN","RGNETOAT",58,0)
 N RTKN
"RTN","RGNETOAT",59,0)
 S RTKN=$$UUID^RGUT,RTKN("client")=CLIENT,RTKN("user")=USER
"RTN","RGNETOAT",60,0)
 S RTKN("scope")=SCOPE,RTKN("access_token")=""
"RTN","RGNETOAT",61,0)
 D SETRTKN(.RTKN)
"RTN","RGNETOAT",62,0)
 Q RTKN
"RTN","RGNETOAT",63,0)
 ; Revoke access token
"RTN","RGNETOAT",64,0)
REVATKN(ATKN) ;
"RTN","RGNETOAT",65,0)
 D DELOBJ^RGNETOA(.ATKN,"ATKN")
"RTN","RGNETOAT",66,0)
 Q
"RTN","RGNETOAT",67,0)
 ; Refresh access token
"RTN","RGNETOAT",68,0)
REFATKN(RTKN) ;
"RTN","RGNETOAT",69,0)
 N ATKN,CLIENT
"RTN","RGNETOAT",70,0)
 D GETRTKN(.RTKN)
"RTN","RGNETOAT",71,0)
 I $D(RTKN)>1 D
"RTN","RGNETOAT",72,0)
 .S ATKN=RTKN("access_token"),CLIENT=RTKN("client")
"RTN","RGNETOAT",73,0)
 .D:$L(ATKN) REVATKN(ATKN)
"RTN","RGNETOAT",74,0)
 .S ATKN=$$NEWATKN(.CLIENT,RTKN("user"),RTKN("scope"))
"RTN","RGNETOAT",75,0)
 .S RTKN("access_token")=ATKN
"RTN","RGNETOAT",76,0)
 .D SETRTKN(.RTKN)
"RTN","RGNETOAT",77,0)
 Q $G(ATKN)
"RTN","RGNETOAT",78,0)
 ; Returns the user DUZ if access token is valid
"RTN","RGNETOAT",79,0)
 ; Revokes any expired tokens
"RTN","RGNETOAT",80,0)
ISVALID(ATKN) ;
"RTN","RGNETOAT",81,0)
 N EXP,VALID
"RTN","RGNETOAT",82,0)
 D GETATKN(.ATKN)
"RTN","RGNETOAT",83,0)
 S EXP=$G(ATKN("expiry")),VALID=$S('EXP:0,1:$$NOW^XLFDT>EXP)
"RTN","RGNETOAT",84,0)
 I EXP,'VALID D REVATKN(ATKN)
"RTN","RGNETOAT",85,0)
 Q $S(VALID:ATKN("user"),1:0)
"RTN","RGNETTCP")
0^64^B87620820
"RTN","RGNETTCP",1,0)
RGNETTCP ;RI/CBMI/DKM - TCP Connection Manager ;05-Oct-2015 10:31;DKM
"RTN","RGNETTCP",2,0)
 ;;1.0;NETWORK SERVICES;;29-Mar-2015;Build 53
"RTN","RGNETTCP",3,0)
 ;=================================================================
"RTN","RGNETTCP",4,0)
 ; Start a primary listener
"RTN","RGNETTCP",5,0)
START(RGCFG) ;
"RTN","RGNETTCP",6,0)
 D SSLIS(RGCFG,1)
"RTN","RGNETTCP",7,0)
 Q
"RTN","RGNETTCP",8,0)
 ; Stop a primary listener
"RTN","RGNETTCP",9,0)
STOP(RGCFG) ;
"RTN","RGNETTCP",10,0)
 D SSLIS(RGCFG,0)
"RTN","RGNETTCP",11,0)
 Q
"RTN","RGNETTCP",12,0)
 ; Restart a primary listener
"RTN","RGNETTCP",13,0)
RESTART(RGCFG) ;
"RTN","RGNETTCP",14,0)
 D STOP(.RGCFG),START(.RGCFG)
"RTN","RGNETTCP",15,0)
 Q
"RTN","RGNETTCP",16,0)
 ; Start all primary listeners
"RTN","RGNETTCP",17,0)
STARTALL D SSALL(1)
"RTN","RGNETTCP",18,0)
 Q
"RTN","RGNETTCP",19,0)
 ; Stop all primary listeners
"RTN","RGNETTCP",20,0)
STOPALL D SSALL(0)
"RTN","RGNETTCP",21,0)
 Q
"RTN","RGNETTCP",22,0)
 ; Restart all primary listeners
"RTN","RGNETTCP",23,0)
RESTALL D STOPALL,STARTALL
"RTN","RGNETTCP",24,0)
 Q
"RTN","RGNETTCP",25,0)
 ; List the status of all primary listeners
"RTN","RGNETTCP",26,0)
LISTALL N RGCFG,LP,X
"RTN","RGNETTCP",27,0)
 F LP=0:0 S LP=$O(^RGNET(996.5,LP)) Q:'LP  D
"RTN","RGNETTCP",28,0)
 .K RGCFG
"RTN","RGNETTCP",29,0)
 .S RGCFG=LP
"RTN","RGNETTCP",30,0)
 .D GETCFG(.RGCFG)
"RTN","RGNETTCP",31,0)
 .S X=$$STATE
"RTN","RGNETTCP",32,0)
 .W RGCFG("name")," (",RGCFG("port"),") is",$S(X:"",1:" not")," running.",!!
"RTN","RGNETTCP",33,0)
 Q
"RTN","RGNETTCP",34,0)
 ; Start/stop all registered listeners
"RTN","RGNETTCP",35,0)
 ; SS - 1 = start, 0 = stop
"RTN","RGNETTCP",36,0)
 ; SL - true = silent mode
"RTN","RGNETTCP",37,0)
SSALL(SS,SL) ;
"RTN","RGNETTCP",38,0)
 N RGCFG
"RTN","RGNETTCP",39,0)
 F RGCFG=0:0 S RGCFG=$O(^RGNET(996.5,RGCFG)) Q:'RGCFG  D SSLIS(RGCFG,SS,.SL)
"RTN","RGNETTCP",40,0)
 Q
"RTN","RGNETTCP",41,0)
 ; Start/stop primary listener
"RTN","RGNETTCP",42,0)
 ; SS - 1 = start, 0 = stop
"RTN","RGNETTCP",43,0)
 ; SL - true = silent mode
"RTN","RGNETTCP",44,0)
SSLIS(RGCFG,SS,SL) ;
"RTN","RGNETTCP",45,0)
 N $ET,SAME,RGMODE
"RTN","RGNETTCP",46,0)
 Q:'$$GETCFG(.RGCFG)
"RTN","RGNETTCP",47,0)
 S SL=$G(SL,$D(ZTQUEUED))
"RTN","RGNETTCP",48,0)
 S:'SL $ET="D SSERR^RGNETTCP"
"RTN","RGNETTCP",49,0)
 W:'SL RGCFG("name")," (",RGCFG("port"),"): "
"RTN","RGNETTCP",50,0)
 S SAME=$$STATE=SS
"RTN","RGNETTCP",51,0)
 S:'SS @$$LOCKNODE(.RGCFG)=1
"RTN","RGNETTCP",52,0)
 I SAME W:'SL $S(SS:"already",1:"not")," running.",!!  Q
"RTN","RGNETTCP",53,0)
 I SS,RGCFG("disabled") W:'SL "disabled.",!! Q
"RTN","RGNETTCP",54,0)
 D:SS JOB(0,.RGCFG)
"RTN","RGNETTCP",55,0)
 Q:SL
"RTN","RGNETTCP",56,0)
 N P1,P2,LP
"RTN","RGNETTCP",57,0)
 S P1=$S(SS:"start",1:"stop"),P2=P1_$S(SS:"ed",1:"ped")
"RTN","RGNETTCP",58,0)
 W "waiting for ",P1," signal..."
"RTN","RGNETTCP",59,0)
 F LP=1:1:5 D
"RTN","RGNETTCP",60,0)
 .H 2
"RTN","RGNETTCP",61,0)
 .W "."
"RTN","RGNETTCP",62,0)
 .S:$$STATE=SS LP=99
"RTN","RGNETTCP",63,0)
 I LP<99 W " failed to ",P1,".",!!
"RTN","RGNETTCP",64,0)
 E  W " ",P2,".",!!
"RTN","RGNETTCP",65,0)
 Q
"RTN","RGNETTCP",66,0)
SSERR W "failed: ",$$EC^%ZOSV,!!
"RTN","RGNETTCP",67,0)
 D UNWIND^%ZTER
"RTN","RGNETTCP",68,0)
 Q
"RTN","RGNETTCP",69,0)
 ; Fetch listener configuration
"RTN","RGNETTCP",70,0)
 ; Populates RGCFG with configuration data.
"RTN","RGNETTCP",71,0)
 ; Returns listener IEN
"RTN","RGNETTCP",72,0)
GETCFG(RGCFG) ;
"RTN","RGNETTCP",73,0)
 Q:$D(RGCFG)=11 RGCFG
"RTN","RGNETTCP",74,0)
 S U="^"
"RTN","RGNETTCP",75,0)
 S:RGCFG'=+RGCFG RGCFG=+$O(^RGNET(996.5,"B",RGCFG,0))
"RTN","RGNETTCP",76,0)
 I RGCFG D
"RTN","RGNETTCP",77,0)
 .N N0,LP
"RTN","RGNETTCP",78,0)
 .S N0=^RGNET(996.5,RGCFG,0),RGCFG("handler")=$G(^(10))
"RTN","RGNETTCP",79,0)
 .F LP=1:1:5 S RGCFG($P("name^port^uci^disabled^maximum",U,LP))=$P(N0,U,LP)
"RTN","RGNETTCP",80,0)
 Q:$Q RGCFG
"RTN","RGNETTCP",81,0)
 Q
"RTN","RGNETTCP",82,0)
 ; Entry point for GT.M socket dispatch
"RTN","RGNETTCP",83,0)
GTMEP D EN(2,$ZCM)
"RTN","RGNETTCP",84,0)
 Q
"RTN","RGNETTCP",85,0)
 ; Start listener as background process
"RTN","RGNETTCP",86,0)
 ; Returns true if operation was successful.
"RTN","RGNETTCP",87,0)
JOB(RGMODE,RGCFG) ;
"RTN","RGNETTCP",88,0)
 N SUCCESS
"RTN","RGNETTCP",89,0)
 I RGMODE>1 S SUCCESS=0
"RTN","RGNETTCP",90,0)
 E  I '$$GETCFG(.RGCFG) S SUCCESS=0
"RTN","RGNETTCP",91,0)
 E  I RGMODE=1 D
"RTN","RGNETTCP",92,0)
 .I RGOS D
"RTN","RGNETTCP",93,0)
 ..N SOCK
"RTN","RGNETTCP",94,0)
 ..S SOCK=$P($KEY,"|",2)
"RTN","RGNETTCP",95,0)
 ..X "U RGTDEV:detach=SOCK"
"RTN","RGNETTCP",96,0)
 ..S SOCK="""SOCKET:"_SOCK_""""
"RTN","RGNETTCP",97,0)
 ..X "J EN^RGNETTCP(RGMODE,RGCFG):(input="_SOCK_":output="_SOCK_")"
"RTN","RGNETTCP",98,0)
 ..S SUCCESS=$T
"RTN","RGNETTCP",99,0)
 .E  D
"RTN","RGNETTCP",100,0)
 ..X "J EN^RGNETTCP(RGMODE,RGCFG):(:4:RGTDEV:RGTDEV):15"
"RTN","RGNETTCP",101,0)
 ..S SUCCESS=$T
"RTN","RGNETTCP",102,0)
 E  I $L(RGCFG("uci")) D
"RTN","RGNETTCP",103,0)
 .X "J EN^RGNETTCP(RGMODE,RGCFG)[RGCFG(""uci"")]"
"RTN","RGNETTCP",104,0)
 .S SUCCESS=$T
"RTN","RGNETTCP",105,0)
 E  D
"RTN","RGNETTCP",106,0)
 .J EN^RGNETTCP(RGMODE,RGCFG)
"RTN","RGNETTCP",107,0)
 .S SUCCESS=$T
"RTN","RGNETTCP",108,0)
 Q:$Q SUCCESS
"RTN","RGNETTCP",109,0)
 Q
"RTN","RGNETTCP",110,0)
 ; Start listener process (primary and secondary)
"RTN","RGNETTCP",111,0)
 ;   RGMODE = Connection type:
"RTN","RGNETTCP",112,0)
 ;     0: primary listener   - dispatches connections
"RTN","RGNETTCP",113,0)
 ;     1: secondary listener - dispatched by primary listener
"RTN","RGNETTCP",114,0)
 ;     2: secondary listener - dispatched by OS
"RTN","RGNETTCP",115,0)
 ;     3: debug listener     - debug mode listener
"RTN","RGNETTCP",116,0)
 ;   RGCFG = Listener name or IEN
"RTN","RGNETTCP",117,0)
EN(RGMODE,RGCFG) ;
"RTN","RGNETTCP",118,0)
 N RGTDEV,RGQUIT,RGRETRY,RGOS,DUZ,$ET,$ES
"RTN","RGNETTCP",119,0)
 S DT=$$DT^XLFDT,$ET="D ETRAP1^RGNETTCP"
"RTN","RGNETTCP",120,0)
 D:'$$GETCFG(.RGCFG) RAISE("Unknown listener.")
"RTN","RGNETTCP",121,0)
 Q:RGCFG("disabled")
"RTN","RGNETTCP",122,0)
 S (RGQUIT,RGRETRY)=0,RGOS=$$OS
"RTN","RGNETTCP",123,0)
 D:RGOS<0 RAISE("Unsupported operating system.")
"RTN","RGNETTCP",124,0)
 I 'RGOS,RGMODE=2 D BADMODE                                            ; Cache does not support mode 2
"RTN","RGNETTCP",125,0)
 Q:$$STATE                                                             ; Quit if listener already running
"RTN","RGNETTCP",126,0)
 D CLEANUP,STSAVE(0),NULLOPEN,STSAVE(1)                                ; Initialize environment
"RTN","RGNETTCP",127,0)
 D CHPRN(.RGCFG)                                                       ; Change process name
"RTN","RGNETTCP",128,0)
 F  D LISTEN Q:RGQUIT>0!RGMODE                                         ; Main loop
"RTN","RGNETTCP",129,0)
 D STATE(0),STREST(1),^%ZISC,STREST(0),CLEANUP
"RTN","RGNETTCP",130,0)
 Q
"RTN","RGNETTCP",131,0)
 ; Entry point for interactive debugging
"RTN","RGNETTCP",132,0)
DEBUG N PORT,CFG
"RTN","RGNETTCP",133,0)
 D TITLE^RGUT("Debug Mode Support",$P($T(+2),";",3))
"RTN","RGNETTCP",134,0)
 F  D  Q:$D(CFG)
"RTN","RGNETTCP",135,0)
 .S CFG=$$ENTRY^RGUTLKP(996.5,,"Enter listener name: ")
"RTN","RGNETTCP",136,0)
 .W !
"RTN","RGNETTCP",137,0)
 .Q:CFG'>0
"RTN","RGNETTCP",138,0)
 .D GETCFG(.CFG)
"RTN","RGNETTCP",139,0)
 .I CFG("disabled") W "That listener is disabled.  Try again.",! K CFG
"RTN","RGNETTCP",140,0)
 Q:CFG'>0
"RTN","RGNETTCP",141,0)
 S PORT=$$PMPT("Port","Enter listener port.",CFG("port"))
"RTN","RGNETTCP",142,0)
 Q:U[PORT
"RTN","RGNETTCP",143,0)
 S CFG("port")=PORT
"RTN","RGNETTCP",144,0)
 I $L($T(^%Serenji)),$$ASK^RGUT("Use Serenji Debugger","Y") D  Q
"RTN","RGNETTCP",145,0)
 .N SRJIP,SRJPORT
"RTN","RGNETTCP",146,0)
 .S SRJIP=$$PMPT("Serenji Listener Addr","Enter Serenji listener address",IP)
"RTN","RGNETTCP",147,0)
 .Q:U[SRJIP
"RTN","RGNETTCP",148,0)
 .S SRJPORT=$$PMPT("Serenji Listener Port","Enter Serenji listener port",4321)
"RTN","RGNETTCP",149,0)
 .Q:U[SRJPORT
"RTN","RGNETTCP",150,0)
 .D DEBUG^%Serenji("EN^RGNETTCP(3,.CFG)",SRJIP,SRJPORT)
"RTN","RGNETTCP",151,0)
 W !,"Now listening on port ",CFG("port"),!
"RTN","RGNETTCP",152,0)
 D EN(3,.CFG)
"RTN","RGNETTCP",153,0)
 Q
"RTN","RGNETTCP",154,0)
 ; Prompt for user input
"RTN","RGNETTCP",155,0)
PMPT(PMPT,HELP,DFLT) ;
"RTN","RGNETTCP",156,0)
 N RET
"RTN","RGNETTCP",157,0)
 F  D  Q:$D(RET)
"RTN","RGNETTCP",158,0)
 .W PMPT,": ",$S($D(DFLT):DFLT_"// ",1:"")
"RTN","RGNETTCP",159,0)
 .R RET:$G(DTIME,30)
"RTN","RGNETTCP",160,0)
 .E  S RET=U
"RTN","RGNETTCP",161,0)
 .I $D(DFLT),'$L(RET) S RET=DFLT W DFLT
"RTN","RGNETTCP",162,0)
 .W !
"RTN","RGNETTCP",163,0)
 .I RET["?" W !,HELP,!! K RET
"RTN","RGNETTCP",164,0)
 Q RET
"RTN","RGNETTCP",165,0)
 ; Determine operating system
"RTN","RGNETTCP",166,0)
 ; Returns 0 = Cache, 1 = GT.M, -1 = unknown
"RTN","RGNETTCP",167,0)
OS() N OS
"RTN","RGNETTCP",168,0)
 S U="^",OS=$P($G(^%ZOSF("OS")),U)
"RTN","RGNETTCP",169,0)
 Q $S(OS["OpenM":0,OS["GT.M":1,1:-1)
"RTN","RGNETTCP",170,0)
 ; Main loop
"RTN","RGNETTCP",171,0)
LISTEN N $ET,$ES,RGOUT,RGSTATE,HNDLR
"RTN","RGNETTCP",172,0)
 S $ET="D ETRAP2^RGNETTCP",RGQUIT='$$TCPOPEN,RGOUT=""
"RTN","RGNETTCP",173,0)
 Q:RGQUIT
"RTN","RGNETTCP",174,0)
 Q:'$$STATE(1)
"RTN","RGNETTCP",175,0)
 S HNDLR=RGCFG("handler")_"(.RGSTATE)"
"RTN","RGNETTCP",176,0)
 F  Q:$$QUIT  D
"RTN","RGNETTCP",177,0)
 .D TCPUSE
"RTN","RGNETTCP",178,0)
 .D:RGMODE @HNDLR
"RTN","RGNETTCP",179,0)
 .D:'RGMODE WAIT
"RTN","RGNETTCP",180,0)
 .D TCPFLUSH
"RTN","RGNETTCP",181,0)
 D TCPCLOSE
"RTN","RGNETTCP",182,0)
 Q
"RTN","RGNETTCP",183,0)
 ; Wait for connection request, then spawn handler (RGMODE = 0)
"RTN","RGNETTCP",184,0)
WAIT N X,OK
"RTN","RGNETTCP",185,0)
 I RGOS D
"RTN","RGNETTCP",186,0)
 .X "W /WAIT(10)"
"RTN","RGNETTCP",187,0)
 .S OK=$P($KEY,"|")="CONNECT"
"RTN","RGNETTCP",188,0)
 E  D
"RTN","RGNETTCP",189,0)
 .R X:10
"RTN","RGNETTCP",190,0)
 .S OK=$T
"RTN","RGNETTCP",191,0)
 D:OK JOB(1,.RGCFG)
"RTN","RGNETTCP",192,0)
 Q
"RTN","RGNETTCP",193,0)
 ; Return temp global root
"RTN","RGNETTCP",194,0)
TMPGBL() Q $NA(^TMP("RGNETTCP",$J))
"RTN","RGNETTCP",195,0)
 ; Cleanup environment
"RTN","RGNETTCP",196,0)
CLEANUP K @$$TMPGBL,@$$LOCKNODE(.RGCFG)
"RTN","RGNETTCP",197,0)
 D XUTL^XUSCLEAN
"RTN","RGNETTCP",198,0)
 Q
"RTN","RGNETTCP",199,0)
 ; Returns true if listener should quit
"RTN","RGNETTCP",200,0)
QUIT() S:'RGQUIT RGQUIT=RGRETRY>5
"RTN","RGNETTCP",201,0)
 S:'RGQUIT RGQUIT=+$G(@$$LOCKNODE(.RGCFG))
"RTN","RGNETTCP",202,0)
 I 'RGQUIT,RGMODE=3 S RGQUIT=$$QUIT3
"RTN","RGNETTCP",203,0)
 Q RGQUIT
"RTN","RGNETTCP",204,0)
 ; Allows user to request quit in debug mode
"RTN","RGNETTCP",205,0)
QUIT3() N X
"RTN","RGNETTCP",206,0)
 U $P
"RTN","RGNETTCP",207,0)
 R X#1:0
"RTN","RGNETTCP",208,0)
 D TCPUSE
"RTN","RGNETTCP",209,0)
 B:X="B"!(X="b")
"RTN","RGNETTCP",210,0)
 Q X=U
"RTN","RGNETTCP",211,0)
 ; Save application state
"RTN","RGNETTCP",212,0)
STSAVE(ST) ;
"RTN","RGNETTCP",213,0)
 D SAVEVAR^%ZIS
"RTN","RGNETTCP",214,0)
 K @$$TMPGBL@(ST)
"RTN","RGNETTCP",215,0)
 M @$$TMPGBL@(ST)=^XUTL("XQ",$J)
"RTN","RGNETTCP",216,0)
 Q
"RTN","RGNETTCP",217,0)
 ; Restore application state
"RTN","RGNETTCP",218,0)
STREST(ST) ;
"RTN","RGNETTCP",219,0)
 K ^XUTL("XQ",$J)
"RTN","RGNETTCP",220,0)
 M ^XUTL("XQ",$J)=@$$TMPGBL@(ST)
"RTN","RGNETTCP",221,0)
 K IO
"RTN","RGNETTCP",222,0)
 D RESETVAR^%ZIS
"RTN","RGNETTCP",223,0)
 I ST,$D(IO)#2 D
"RTN","RGNETTCP",224,0)
 .N $ET
"RTN","RGNETTCP",225,0)
 .S $ET="S $EC="""" D NULLOPEN^RGNETTCP"
"RTN","RGNETTCP",226,0)
 .U IO
"RTN","RGNETTCP",227,0)
 Q
"RTN","RGNETTCP",228,0)
 ; Establish null device as default IO device
"RTN","RGNETTCP",229,0)
NULLOPEN N %ZIS,IOP,POP
"RTN","RGNETTCP",230,0)
 S %ZIS="0H",IOP="NULL"
"RTN","RGNETTCP",231,0)
 D ^%ZIS,RAISE("Failed to open null device."):POP
"RTN","RGNETTCP",232,0)
 U IO
"RTN","RGNETTCP",233,0)
 Q
"RTN","RGNETTCP",234,0)
 ; Open TCP listener port
"RTN","RGNETTCP",235,0)
 ; Returns true if successful
"RTN","RGNETTCP",236,0)
TCPOPEN() ;
"RTN","RGNETTCP",237,0)
 N POP
"RTN","RGNETTCP",238,0)
 S POP=0
"RTN","RGNETTCP",239,0)
 I RGMODE=3 D
"RTN","RGNETTCP",240,0)
 .I RGOS D
"RTN","RGNETTCP",241,0)
 ..S RGTDEV="server$"_RGCFG("port")
"RTN","RGNETTCP",242,0)
 ..X "O RGTDEV:(ZLISTEN=RGCFG(""port"")_"":TCP"":attach=""server""):9999:""socket"""
"RTN","RGNETTCP",243,0)
 ..X:$T "U RGTDEV:(nowrap:nodelimiter:ioerror=""ETRAP2^RGNETTCP"")"
"RTN","RGNETTCP",244,0)
 ..S POP='$T
"RTN","RGNETTCP",245,0)
 .E  D
"RTN","RGNETTCP",246,0)
 ..S RGTDEV="|TCP|"_RGCFG("port")
"RTN","RGNETTCP",247,0)
 ..X "O RGTDEV:(:RGCFG(""port""):""DS""):9999"
"RTN","RGNETTCP",248,0)
 ..S POP='$T
"RTN","RGNETTCP",249,0)
 E  I RGMODE D
"RTN","RGNETTCP",250,0)
 .S RGTDEV=$P
"RTN","RGNETTCP",251,0)
 .I RGOS D
"RTN","RGNETTCP",252,0)
 ..S @"$ZINTERRUPT=""I $$JOBEXAM^ZU($ZPOSITION)"""
"RTN","RGNETTCP",253,0)
 ..X "U RGTDEV:(nowrap:nodelimiter:ioerror=""ETRAP2^RGNETTCP"")"
"RTN","RGNETTCP",254,0)
 E  D
"RTN","RGNETTCP",255,0)
 .I RGOS D
"RTN","RGNETTCP",256,0)
 ..S @"$ZINTERRUPT=""I $$JOBEXAM^ZU($ZPOSITION)"""
"RTN","RGNETTCP",257,0)
 ..S RGTDEV="SCK$"_RGCFG("port")
"RTN","RGNETTCP",258,0)
 ..X "O RGTDEV:(zlisten=RGCFG(""port"")_"":TCP"":nowrap:nodelimiter:attach=""server""):5:""socket"""
"RTN","RGNETTCP",259,0)
 ..S POP='$T
"RTN","RGNETTCP",260,0)
 ..X:'POP "U RGTDEV W /LISTEN(5)"
"RTN","RGNETTCP",261,0)
 .E  D
"RTN","RGNETTCP",262,0)
 ..S RGTDEV="|TCP|"_RGCFG("port")
"RTN","RGNETTCP",263,0)
 ..X "O RGTDEV:(:RGCFG(""port""):""ADS""):5"
"RTN","RGNETTCP",264,0)
 ..S POP='$T
"RTN","RGNETTCP",265,0)
 Q 'POP
"RTN","RGNETTCP",266,0)
 ; Use TCP listener port
"RTN","RGNETTCP",267,0)
TCPUSE U RGTDEV
"RTN","RGNETTCP",268,0)
 Q
"RTN","RGNETTCP",269,0)
 ; Close TCP listener port
"RTN","RGNETTCP",270,0)
TCPCLOSE C:$D(RGTDEV) RGTDEV
"RTN","RGNETTCP",271,0)
 Q
"RTN","RGNETTCP",272,0)
 ; Return CNT characters from input buffer
"RTN","RGNETTCP",273,0)
 ; CNT = # of characters to return
"RTN","RGNETTCP",274,0)
 ; TMO = Optional timeout in seconds
"RTN","RGNETTCP",275,0)
 ; USE = If true or not specified, call TCPUSE before read
"RTN","RGNETTCP",276,0)
TCPREAD(CNT,TMO,USE) ;
"RTN","RGNETTCP",277,0)
 Q:CNT'>0 ""
"RTN","RGNETTCP",278,0)
 N X
"RTN","RGNETTCP",279,0)
 D:$G(USE,1) TCPUSE
"RTN","RGNETTCP",280,0)
 S TMO=+$G(TMO)
"RTN","RGNETTCP",281,0)
 R X#CNT:TMO
"RTN","RGNETTCP",282,0)
 Q X
"RTN","RGNETTCP",283,0)
 ; Read up to termination sequence
"RTN","RGNETTCP",284,0)
 ; TRM = Read termination sequence (included in returned value)
"RTN","RGNETTCP",285,0)
 ; TMO = Optional timeout in seconds
"RTN","RGNETTCP",286,0)
TCPREADT(TRM,TMO) ;
"RTN","RGNETTCP",287,0)
 N ST,L,X,USE
"RTN","RGNETTCP",288,0)
 S LN="",L=$L(TRM)-1,USE=1
"RTN","RGNETTCP",289,0)
 F  S X=$$TCPREAD(1,.TMO,USE) Q:'$L(X)  D  Q:L<0
"RTN","RGNETTCP",290,0)
 .S LN=LN_X,(TMO,USE)=0
"RTN","RGNETTCP",291,0)
 .S:$E(LN,$L(LN)-L,$L(LN))=TRM L=-1
"RTN","RGNETTCP",292,0)
 Q LN
"RTN","RGNETTCP",293,0)
 ; Read one byte from socket
"RTN","RGNETTCP",294,0)
 ; TMO = Optional timeout in seconds
"RTN","RGNETTCP",295,0)
TCPREADB(TMO) ;
"RTN","RGNETTCP",296,0)
 Q $A($$TCPREAD(1,.TMO))
"RTN","RGNETTCP",297,0)
 ; Write data to socket
"RTN","RGNETTCP",298,0)
 ; All write operations must be done via this method.
"RTN","RGNETTCP",299,0)
 ; This operation is buffered with a write threshold at 1024 bytes.
"RTN","RGNETTCP",300,0)
 ; DATA = Date to write
"RTN","RGNETTCP",301,0)
TCPWRITE(DATA) ;
"RTN","RGNETTCP",302,0)
 S RGOUT=RGOUT_DATA
"RTN","RGNETTCP",303,0)
 D:$L(RGOUT)>1024 TCPFLUSH
"RTN","RGNETTCP",304,0)
 Q
"RTN","RGNETTCP",305,0)
 ; Flush the output buffer
"RTN","RGNETTCP",306,0)
TCPFLUSH Q:'$L(RGOUT)
"RTN","RGNETTCP",307,0)
 D TCPUSE
"RTN","RGNETTCP",308,0)
 W RGOUT,!
"RTN","RGNETTCP",309,0)
 S RGOUT=""
"RTN","RGNETTCP",310,0)
 Q
"RTN","RGNETTCP",311,0)
 ; Write array (local or global) to TCP stream
"RTN","RGNETTCP",312,0)
 ; ARY  = Local or global array reference
"RTN","RGNETTCP",313,0)
 ; EOL  = Line terminator to add (optional)
"RTN","RGNETTCP",314,0)
 ; KILL = If true, kill array after writing (default is false)
"RTN","RGNETTCP",315,0)
ARYOUT(ARY,EOL,KILL) ;
"RTN","RGNETTCP",316,0)
 N ND,LN
"RTN","RGNETTCP",317,0)
 Q:'$L(ARY)
"RTN","RGNETTCP",318,0)
 S ARY=$NA(@ARY)
"RTN","RGNETTCP",319,0)
 S ND=ARY,LN=$QL(ARY),EOL=$G(EOL)
"RTN","RGNETTCP",320,0)
 F  S ND=$Q(@ND) Q:'$L(ND)  Q:$NA(@ND,LN)'=ARY  D TCPWRITE(@ND_EOL)
"RTN","RGNETTCP",321,0)
 K:$G(KILL) @ARY
"RTN","RGNETTCP",322,0)
 Q
"RTN","RGNETTCP",323,0)
 ; Write contents of a file to TCP stream
"RTN","RGNETTCP",324,0)
 ; FIL  = File path
"RTN","RGNETTCP",325,0)
 ; EOL  = Line terminator to add (optional)
"RTN","RGNETTCP",326,0)
 ; KILL = If true, delete the file after writing (default is false)
"RTN","RGNETTCP",327,0)
FILOUT(FIL,EOL,KILL) ;
"RTN","RGNETTCP",328,0)
 N LN
"RTN","RGNETTCP",329,0)
 S EOL=$G(EOL)
"RTN","RGNETTCP",330,0)
 D OPEN^RGUTOS(.FIL,"R")
"RTN","RGNETTCP",331,0)
 F  Q:$$READ^RGUTOS(.LN,FIL)  D TCPWRITE(LN_EOL)
"RTN","RGNETTCP",332,0)
 D CLOSE^RGUTOS(.FIL)
"RTN","RGNETTCP",333,0)
 D:$G(KILL) DELETE^RGUTOS(FIL)
"RTN","RGNETTCP",334,0)
 Q
"RTN","RGNETTCP",335,0)
 ; Throw a bad mode exception
"RTN","RGNETTCP",336,0)
BADMODE D RAISE("Mode not supported for OS.")
"RTN","RGNETTCP",337,0)
 Q
"RTN","RGNETTCP",338,0)
 ; Raise an exception
"RTN","RGNETTCP",339,0)
RAISE(MSG) ;
"RTN","RGNETTCP",340,0)
 D RAISE^RGUTOS(MSG)
"RTN","RGNETTCP",341,0)
 Q
"RTN","RGNETTCP",342,0)
 ; Startup error
"RTN","RGNETTCP",343,0)
ETRAP1 S RGQUIT=1
"RTN","RGNETTCP",344,0)
 D ^%ZTER,UNWIND^%ZTER
"RTN","RGNETTCP",345,0)
 Q
"RTN","RGNETTCP",346,0)
 ; Communication error
"RTN","RGNETTCP",347,0)
ETRAP2 S RGRETRY=RGRETRY+1
"RTN","RGNETTCP",348,0)
 S:RGQUIT'>0 RGQUIT=$S(RGRETRY>5:1,'RGMODE:-1,1:0)
"RTN","RGNETTCP",349,0)
 D:RGRETRY=1 ^%ZTER
"RTN","RGNETTCP",350,0)
 D UNWIND^%ZTER
"RTN","RGNETTCP",351,0)
 Q
"RTN","RGNETTCP",352,0)
 ; Lock/Unlock listener
"RTN","RGNETTCP",353,0)
 ; ACT:  1 = lock, 0 = unlock, missing = return status
"RTN","RGNETTCP",354,0)
 ; Returns true if locked, false if not.
"RTN","RGNETTCP",355,0)
STATE(ACT) ;
"RTN","RGNETTCP",356,0)
 N RES,LN
"RTN","RGNETTCP",357,0)
 S LN=$$LOCKNODE(.RGCFG)
"RTN","RGNETTCP",358,0)
 I '$D(ACT) D
"RTN","RGNETTCP",359,0)
 .L +@LN:0
"RTN","RGNETTCP",360,0)
 .S RES='$T
"RTN","RGNETTCP",361,0)
 .L:'RES -@LN
"RTN","RGNETTCP",362,0)
 E  I ACT D
"RTN","RGNETTCP",363,0)
 .L +@LN:1
"RTN","RGNETTCP",364,0)
 .S RES=$T
"RTN","RGNETTCP",365,0)
 E  D
"RTN","RGNETTCP",366,0)
 .L -@LN
"RTN","RGNETTCP",367,0)
 .S RES=0
"RTN","RGNETTCP",368,0)
 Q:$Q RES
"RTN","RGNETTCP",369,0)
 Q
"RTN","RGNETTCP",370,0)
 ; Get global reference for lock node
"RTN","RGNETTCP",371,0)
LOCKNODE(RGCFG) ;
"RTN","RGNETTCP",372,0)
 Q:'$$GETCFG(.RGCFG) ""
"RTN","RGNETTCP",373,0)
 Q $NA(^[RGCFG("uci")]XTMP("RGNETTCP","LN",RGCFG,$S($G(RGMODE):$J,1:0)))
"RTN","RGNETTCP",374,0)
 ; Change process name to reflect active listener
"RTN","RGNETTCP",375,0)
CHPRN(RGCFG) ;
"RTN","RGNETTCP",376,0)
 D SETNM^%ZOSV("RGNETTCP_"_RGCFG("port"))
"RTN","RGNETTCP",377,0)
 Q
"RTN","RGNETWRR")
0^65^B31409526
"RTN","RGNETWRR",1,0)
RGNETWRR ;RI/CBMI/DKM - Web endpoint for RPC and routine lookup ;03-Feb-2017 14:22;DKM
"RTN","RGNETWRR",2,0)
 ;;1.0;RGSERV WEB SERVER;;1-Apr-2015;Build 53
"RTN","RGNETWRR",3,0)
 ;=================================================================
"RTN","RGNETWRR",4,0)
 ; RPC lookup entry point
"RTN","RGNETWRR",5,0)
RPC N RPC,RPCX,RTN,TAG,IEN,CCH,LN,X,Y,Z
"RTN","RGNETWRR",6,0)
 S Y="Remote Procedure Inquiry ("_$$UCI^RGUTOS(1)_")"
"RTN","RGNETWRR",7,0)
 D ADDCSS
"RTN","RGNETWRR",8,0)
 D BODY("<title>"_Y_"</title>")
"RTN","RGNETWRR",9,0)
 D BODY("<h1>"_Y_"</h1><br>")
"RTN","RGNETWRR",10,0)
 D BODY("<form method=GET action='RPC'>")
"RTN","RGNETWRR",11,0)
 D BODY("RPC Name: ")
"RTN","RGNETWRR",12,0)
 D BODY("<input name='NAME' type=text autofocus></input>")
"RTN","RGNETWRR",13,0)
 D BODY("<input type=submit value='Search'>")
"RTN","RGNETWRR",14,0)
 D BODY("</form>")
"RTN","RGNETWRR",15,0)
 D BODY("<br><div class='content'/>")
"RTN","RGNETWRR",16,0)
 S RPC=$$GETPARAM^RGNETWWW("NAME"),RPCX=RPC,LN=$L(RPCX)
"RTN","RGNETWRR",17,0)
 Q:'LN
"RTN","RGNETWRR",18,0)
 D BODY("<table>")
"RTN","RGNETWRR",19,0)
 F X="NAME","ENTRY POINT","RETURN TYPE","WRAP","DESCRIPTION" D
"RTN","RGNETWRR",20,0)
 .D BODY("<th>"_X_"</th>")
"RTN","RGNETWRR",21,0)
 F  D  S RPCX=$O(^XWB(8994,"B",RPCX)) Q:$E(RPCX,1,LN)'=RPC
"RTN","RGNETWRR",22,0)
 .F IEN=0:0 S IEN=$O(^XWB(8994,"B",RPCX,IEN)) Q:'IEN  D
"RTN","RGNETWRR",23,0)
 ..D BODY("<tr bgcolor=#"_$$COLOR(.CCH)_">")
"RTN","RGNETWRR",24,0)
 ..S Y=$G(^XWB(8994,IEN,0)),RTN=$P(Y,U,3),TAG=$P(Y,U,2)
"RTN","RGNETWRR",25,0)
 ..D CELL($P(Y,U))
"RTN","RGNETWRR",26,0)
 ..D CELL("<a target='"_$$UCI^RGUTOS(1)_":RTN' href='RTN?NAME="_TAG_U_RTN_$S($L(TAG):"#"_TAG,1:"")_"'>"_$P(Y,U,2,3)_"</a>",1)
"RTN","RGNETWRR",27,0)
 ..D SET($P(Y,U,4),8994,.04)
"RTN","RGNETWRR",28,0)
 ..D SET($P(Y,U,8),8994,.08)
"RTN","RGNETWRR",29,0)
 ..D BODY("<td>")
"RTN","RGNETWRR",30,0)
 ..; Output RPC Description
"RTN","RGNETWRR",31,0)
 ..S Z=0
"RTN","RGNETWRR",32,0)
 ..F X=0:0 S X=$O(^XWB(8994,IEN,1,X)) Q:'X  S Y=$$ESCAPE(^(X,0)) D
"RTN","RGNETWRR",33,0)
 ...I 'Z D
"RTN","RGNETWRR",34,0)
 ....D BODY("<table><tr><td><br><pre>")
"RTN","RGNETWRR",35,0)
 ....S Z=1
"RTN","RGNETWRR",36,0)
 ...D BODY(Y)
"RTN","RGNETWRR",37,0)
 ..D:Z BODY("</pre></td></tr></table>")
"RTN","RGNETWRR",38,0)
 ..; Output Parameter Descriptions
"RTN","RGNETWRR",39,0)
 ..S Z=0
"RTN","RGNETWRR",40,0)
 ..F X=0:0 S X=$O(^XWB(8994,IEN,2,X)) Q:'X  S Y=$$ESCAPE(^(X,0)) D
"RTN","RGNETWRR",41,0)
 ...I 'Z D
"RTN","RGNETWRR",42,0)
 ....D BODY("<table>")
"RTN","RGNETWRR",43,0)
 ....F Z="NAME","TYPE","DESCRIPTION" D BODY("<th>"_Z_"</th>")
"RTN","RGNETWRR",44,0)
 ....S Z=1
"RTN","RGNETWRR",45,0)
 ...D BODY("<tr>")
"RTN","RGNETWRR",46,0)
 ...D CELL($P(Y,U),1)
"RTN","RGNETWRR",47,0)
 ...D SET($P(Y,U,2),8994.02,.02)
"RTN","RGNETWRR",48,0)
 ...D BODY("<td><br><pre>")
"RTN","RGNETWRR",49,0)
 ...F Y=0:0 S Y=$O(^XWB(8994,IEN,2,X,1,Y)) Q:'Y  D BODY($$ESCAPE(^(Y,0))) S Z=2
"RTN","RGNETWRR",50,0)
 ...D:Z'=2 BODY("none")
"RTN","RGNETWRR",51,0)
 ...D BODY("</pre></td></tr>")
"RTN","RGNETWRR",52,0)
 ..D:Z BODY("</table>")
"RTN","RGNETWRR",53,0)
 ..; Output Return Description
"RTN","RGNETWRR",54,0)
 ..S Z=0
"RTN","RGNETWRR",55,0)
 ..F X=0:0 S X=$O(^XWB(8994,IEN,3,X)) Q:'X  S Y=$$ESCAPE(^(X,0)) D
"RTN","RGNETWRR",56,0)
 ...I 'Z D
"RTN","RGNETWRR",57,0)
 ....D BODY("<table><th>RETURN VALUE</th><tr><td><br><pre>")
"RTN","RGNETWRR",58,0)
 ....S Z=1
"RTN","RGNETWRR",59,0)
 ...D BODY(Y)
"RTN","RGNETWRR",60,0)
 ..D:Z BODY("</pre></td></tr></table>")
"RTN","RGNETWRR",61,0)
 ..D BODY("</td></tr>")
"RTN","RGNETWRR",62,0)
 D BODY("</table></div>")
"RTN","RGNETWRR",63,0)
 Q
"RTN","RGNETWRR",64,0)
 ; Routine lookup endpoint
"RTN","RGNETWRR",65,0)
RTN N RTN,TAG,BLD,LN,X,X1,X2,XL,XP,Y
"RTN","RGNETWRR",66,0)
 S Y=$$UCI^RGUTOS(1),X="Routine Inquiry ("_Y_")"
"RTN","RGNETWRR",67,0)
 S RTN=$$GETPARAM^RGNETWWW("NAME"),TAG=" "
"RTN","RGNETWRR",68,0)
 D ADDCSS
"RTN","RGNETWRR",69,0)
 D:'$L(RTN) BODY("<title>"_X_"</title>")
"RTN","RGNETWRR",70,0)
 D:$L(RTN) BODY("<title>"_Y_": "_RTN_"</title>")
"RTN","RGNETWRR",71,0)
 D BODY("<h1>"_X_"</h1><br>")
"RTN","RGNETWRR",72,0)
 D BODY("<form method=GET action='RTN'>")
"RTN","RGNETWRR",73,0)
 D BODY("Routine Name: ")
"RTN","RGNETWRR",74,0)
 D BODY("<input name='NAME' type=text autofocus value='"_RTN_"'></input>")
"RTN","RGNETWRR",75,0)
 D BODY("<input type=submit value='Search'>")
"RTN","RGNETWRR",76,0)
 D BODY("</form>")
"RTN","RGNETWRR",77,0)
 D BODY("<br><div class='content highlight'>")
"RTN","RGNETWRR",78,0)
 Q:'$L(RTN)
"RTN","RGNETWRR",79,0)
 S:RTN[U TAG=$P(RTN,U),RTN=$P(RTN,U,2)
"RTN","RGNETWRR",80,0)
 I '$$TEST^RGUTRTN(RTN) D  Q
"RTN","RGNETWRR",81,0)
 .D BODY("<h2>Routine not found.</h2>")
"RTN","RGNETWRR",82,0)
 I '$L($T(+1^@RTN)) D  Q
"RTN","RGNETWRR",83,0)
 .D BODY("<h2>Source code not found.</h2>")
"RTN","RGNETWRR",84,0)
 D BODY("<pre>")
"RTN","RGNETWRR",85,0)
 F LN=1:1 S X=$T(+LN^@RTN) Q:'$L(X)  D
"RTN","RGNETWRR",86,0)
 .S X1=$P(X," "),X2=$P(X," ",2,9999)
"RTN","RGNETWRR",87,0)
 .S XP=$P(X1,"(",2,999),X1=$P(X1,"("),XL=$L(X1),BLD=X1=TAG
"RTN","RGNETWRR",88,0)
 .S:$L(XP) XP="("_XP
"RTN","RGNETWRR",89,0)
 .D:XL BODY("<a NAME='"_X1_"'></a>")
"RTN","RGNETWRR",90,0)
 .S X1=$$LJ^XLFSTR(X1_XP,8)
"RTN","RGNETWRR",91,0)
 .S:BLD X1="<span class='bold'>"_$E(X1,1,XL)_"</span>"_$E(X1,XL+1,999)
"RTN","RGNETWRR",92,0)
 .D ADDLNK(.X2)
"RTN","RGNETWRR",93,0)
 .S X2=$TR($$ESCAPE^RGNETWWW(X2),$C(1,2),"<>")
"RTN","RGNETWRR",94,0)
 .D BODY(X1_" "_X2)
"RTN","RGNETWRR",95,0)
 D BODY("</pre></div>")
"RTN","RGNETWRR",96,0)
 Q
"RTN","RGNETWRR",97,0)
ADDCSS D BODY("<style>")
"RTN","RGNETWRR",98,0)
 D BODY("body {overflow:hidden}")
"RTN","RGNETWRR",99,0)
 D BODY("input[type=submit] {background:none}")
"RTN","RGNETWRR",100,0)
 D BODY("td {vertical-align: middle}")
"RTN","RGNETWRR",101,0)
 D BODY(".content {position:absolute;top:120px;bottom:0;left:0;right:0;overflow:auto;padding:2px;margin:5px}")
"RTN","RGNETWRR",102,0)
 D BODY(".bold {font-weight:bold;color:red}")
"RTN","RGNETWRR",103,0)
 D BODY(".highlight {background:antiquewhite}")
"RTN","RGNETWRR",104,0)
 D BODY("table {width:100%}")
"RTN","RGNETWRR",105,0)
 D BODY("table, th, td, .highlight {border:1px solid black}")
"RTN","RGNETWRR",106,0)
 D BODY("</style>")
"RTN","RGNETWRR",107,0)
 Q
"RTN","RGNETWRR",108,0)
ADDLNK(TXT) ;
"RTN","RGNETWRR",109,0)
 N P,R,S,C,Q,E,E1,B,PC
"RTN","RGNETWRR",110,0)
 S S=0,Q=0,R=0,E=""
"RTN","RGNETWRR",111,0)
 F P=1:1 D  Q:'$L(C)
"RTN","RGNETWRR",112,0)
 .S C=$E(TXT,P)
"RTN","RGNETWRR",113,0)
 .I C="""" D  Q
"RTN","RGNETWRR",114,0)
 ..I Q,$E(TXT,P+1)="""" S P=P+1 Q
"RTN","RGNETWRR",115,0)
 ..S Q='Q
"RTN","RGNETWRR",116,0)
 .Q:Q
"RTN","RGNETWRR",117,0)
 .I C=";" S P=99999 Q
"RTN","RGNETWRR",118,0)
 .I C="(" S R=R+1
"RTN","RGNETWRR",119,0)
 .I C=")",R S R=R-1
"RTN","RGNETWRR",120,0)
 .D @("AL"_S)
"RTN","RGNETWRR",121,0)
 Q
"RTN","RGNETWRR",122,0)
 ; Looking for branch command
"RTN","RGNETWRR",123,0)
AL0 S B="DGdg"[C
"RTN","RGNETWRR",124,0)
 S:" ."'[C S=1
"RTN","RGNETWRR",125,0)
 Q
"RTN","RGNETWRR",126,0)
 ; Postconditional?
"RTN","RGNETWRR",127,0)
AL1 S PC=C=":",S=$S(PC:3,C=" ":3-B,1:99)
"RTN","RGNETWRR",128,0)
 Q
"RTN","RGNETWRR",129,0)
 ; Collect branch target
"RTN","RGNETWRR",130,0)
AL2 S:'$L(E) E1=P
"RTN","RGNETWRR",131,0)
 I $L(C),"^%"[C!(C?1AN) S E=E_C Q
"RTN","RGNETWRR",132,0)
 D ALX
"RTN","RGNETWRR",133,0)
 S S=$S(R:3,C=",":2,C=" ":0,1:99)
"RTN","RGNETWRR",134,0)
 Q
"RTN","RGNETWRR",135,0)
 ; Expression
"RTN","RGNETWRR",136,0)
AL3 I C=" ",PC S PC=0,S=$S(B:2,1:3)
"RTN","RGNETWRR",137,0)
 E  S S=$S(C="$":4,C=" ":0,1:3)
"RTN","RGNETWRR",138,0)
 Q
"RTN","RGNETWRR",139,0)
 ; Extrinsic?
"RTN","RGNETWRR",140,0)
AL4 S S=$S(C="$":5,C=" ":0,1:3)
"RTN","RGNETWRR",141,0)
 Q
"RTN","RGNETWRR",142,0)
 ; Extrinsic EP
"RTN","RGNETWRR",143,0)
AL5 S:'$L(E) E1=P
"RTN","RGNETWRR",144,0)
 I "^%"[C!(C?1AN) S E=E_C Q
"RTN","RGNETWRR",145,0)
 D ALX
"RTN","RGNETWRR",146,0)
 S S=$S(C=" ":0,1:3)
"RTN","RGNETWRR",147,0)
 Q
"RTN","RGNETWRR",148,0)
 ; Bad syntax
"RTN","RGNETWRR",149,0)
AL99 S P=99999
"RTN","RGNETWRR",150,0)
 Q
"RTN","RGNETWRR",151,0)
 ; Add a link
"RTN","RGNETWRR",152,0)
ALX Q:'$L(E)
"RTN","RGNETWRR",153,0)
 S E=$S(E[U:$P(E,U,1,2),1:E_U_RTN)
"RTN","RGNETWRR",154,0)
 S:E["%" E=$$SUBST^RGUT(E,"%","%25")
"RTN","RGNETWRR",155,0)
 S E=$C(1)_"a href='RTN?NAME="_E_"#"_$P(E,U)_"'"_$C(2),TXT=$E(TXT,1,E1-1)_E_$E(TXT,E1,P-1)_$C(1)_"/a"_$C(2)_$E(TXT,P,9999),P=P+$L(E)+4,E=""
"RTN","RGNETWRR",156,0)
 Q
"RTN","RGNETWRR",157,0)
BODY(X) D ADD^RGNETWWW(X_$C(13,10))
"RTN","RGNETWRR",158,0)
 Q
"RTN","RGNETWRR",159,0)
CELL(X,C) ;
"RTN","RGNETWRR",160,0)
 D BODY("<td align="_$S($G(C):"center",1:"left")_">")
"RTN","RGNETWRR",161,0)
 D BODY(X)
"RTN","RGNETWRR",162,0)
 D BODY("</td>")
"RTN","RGNETWRR",163,0)
 Q
"RTN","RGNETWRR",164,0)
SET(VAL,FIL,FLD) ;
"RTN","RGNETWRR",165,0)
 D CELL($$SET^RGUT(+VAL,$P($G(^DD(FIL,FLD,0)),U,3)_";0:UNKNOWN"),1)
"RTN","RGNETWRR",166,0)
 Q
"RTN","RGNETWRR",167,0)
 ; Return a rotating palette of pastel colors
"RTN","RGNETWRR",168,0)
 ;   CCH = Last color used.
"RTN","RGNETWRR",169,0)
 ;   Returns next color in sequence.
"RTN","RGNETWRR",170,0)
COLOR(CCH) ;
"RTN","RGNETWRR",171,0)
 ;S CCH=$S($G(CCH)="":"FFFFCC",CCH="FFCCFF":"FFCCCC",CCH="CCCCFF":"FFFFCC",1:$E(CCH,5,6)_$E(CCH,1,4))
"RTN","RGNETWRR",172,0)
 ;S CCH=$S($G(CCH)="":"FFFFCC",1:$E(CCH,5,6)_$E(CCH,1,4))
"RTN","RGNETWRR",173,0)
 S CCH=$S($G(CCH)="":"CCFFFF",CCH="FFFFCC":"CCCCFF",CCH="FFCCCC":"CCFFFF",1:$E(CCH,5,6)_$E(CCH,1,4))
"RTN","RGNETWRR",174,0)
 Q CCH
"RTN","RGNETWRR",175,0)
ESCAPE(X) ;
"RTN","RGNETWRR",176,0)
 Q $$ESCAPE^RGNETWWW(X)
"RTN","RGNETWWW")
0^66^B117759835
"RTN","RGNETWWW",1,0)
RGNETWWW ;RI/CBMI/DKM - HTTP support ;03-Feb-2017 14:22;DKM
"RTN","RGNETWWW",2,0)
 ;;1.0;NETWORK SERVICES;;14-March-2014;Build 53
"RTN","RGNETWWW",3,0)
 ;=================================================================
"RTN","RGNETWWW",4,0)
 ; This is the TCP I/O handler entry point
"RTN","RGNETWWW",5,0)
NETSERV(DUMMY) ;
"RTN","RGNETWWW",6,0)
 D WRITEALL($$PROCESS("$$TCPSTRM(.LN)"))
"RTN","RGNETWWW",7,0)
 S RGQUIT=RGMODE'=3
"RTN","RGNETWWW",8,0)
 Q
"RTN","RGNETWWW",9,0)
 ; Entry point where request is in an array.
"RTN","RGNETWWW",10,0)
 ;  SRCARY = Array reference.  Note that the array contents will be destroyed.
"RTN","RGNETWWW",11,0)
 ;  Returns the global reference where the response is stored.
"RTN","RGNETWWW",12,0)
ENTRYARY(SRCARY) ;
"RTN","RGNETWWW",13,0)
 Q $$PROCESS("$$ARYSTRM(.LN,""SRCARY"")")
"RTN","RGNETWWW",14,0)
 ; Entry point for processing a request.  By using a stream,
"RTN","RGNETWWW",15,0)
 ; we can process requests from sources other than a TCP
"RTN","RGNETWWW",16,0)
 ; stream.
"RTN","RGNETWWW",17,0)
 ;   SOURCE = Extrinsic that will act as an input stream for reading the request.
"RTN","RGNETWWW",18,0)
PROCESS(SOURCE) ;
"RTN","RGNETWWW",19,0)
 N RGNETREQ,RGNETRSP
"RTN","RGNETWWW",20,0)
 D INIT,PROCX,ENDRSP,CLEANUP
"RTN","RGNETWWW",21,0)
 Q:$Q RGNETRSP
"RTN","RGNETWWW",22,0)
 Q
"RTN","RGNETWWW",23,0)
PROCX N HANDLER,EP,AUTH,ACE,X,$ET,$ES
"RTN","RGNETWWW",24,0)
 S $ET="D ETRAP^RGNETWWW"
"RTN","RGNETWWW",25,0)
 S X=$$PARSEREQ(SOURCE,.RGNETREQ)
"RTN","RGNETWWW",26,0)
 I X D SETSTAT(X) Q
"RTN","RGNETWWW",27,0)
 S HANDLER=$$URL2EP(RGNETREQ("METHOD"),RGNETREQ("PATH"))
"RTN","RGNETWWW",28,0)
 I 'HANDLER D SETSTAT(404,"No Endpoint") Q
"RTN","RGNETWWW",29,0)
 S EP=$G(^RGNET(996.52,HANDLER,10)),AUTH=$P(^(0),U,3),ACE=$G(^(20,"ACE"))
"RTN","RGNETWWW",30,0)
 I '$L(EP) D SETSTAT(404,"No Handler") Q
"RTN","RGNETWWW",31,0)
 Q:'$$AUTH(AUTH,$L(AUTH)&'$G(DUZ))
"RTN","RGNETWWW",32,0)
 I $L(ACE),'$$ACEEVAL(ACE) D SETSTAT(403) Q
"RTN","RGNETWWW",33,0)
 D @EP
"RTN","RGNETWWW",34,0)
 Q
"RTN","RGNETWWW",35,0)
 ; Trap an expected error, returning it as a 500 status code.
"RTN","RGNETWWW",36,0)
ETRAP D SETSTAT(500,$P($EC,",",2)),^%ZTER,UNWIND^%ZTER
"RTN","RGNETWWW",37,0)
 Q
"RTN","RGNETWWW",38,0)
 ; Writes the contents of the buffer to the TCP socket.
"RTN","RGNETWWW",39,0)
 ;  BUFFER = Array reference containing buffered output.
"RTN","RGNETWWW",40,0)
WRITEALL(BUFFER) ;
"RTN","RGNETWWW",41,0)
 N LP1,LP2
"RTN","RGNETWWW",42,0)
 S LP1=""
"RTN","RGNETWWW",43,0)
 F  S LP1=$O(@BUFFER@(LP1)) Q:'$L(LP1)  D
"RTN","RGNETWWW",44,0)
 .D:$D(@BUFFER@(LP1))#2 TCPWRITE^RGNETTCP(@BUFFER@(LP1))
"RTN","RGNETWWW",45,0)
 .S LP2=""
"RTN","RGNETWWW",46,0)
 .F  S LP2=$O(@BUFFER@(LP1,LP2)) Q:'$L(LP2)  D
"RTN","RGNETWWW",47,0)
 ..D TCPWRITE^RGNETTCP(@BUFFER@(LP1,LP2))
"RTN","RGNETWWW",48,0)
 Q
"RTN","RGNETWWW",49,0)
 ; Extrinsic to act as a TCP input stream
"RTN","RGNETWWW",50,0)
 ;  .LN = Single line returned from input stream.
"RTN","RGNETWWW",51,0)
TCPSTRM(LN) ;
"RTN","RGNETWWW",52,0)
 N L,TMO
"RTN","RGNETWWW",53,0)
 S TMO=$S('$D(LN):10,1:0)
"RTN","RGNETWWW",54,0)
 S LN=$$TCPREADT^RGNETTCP($C(13,10),TMO),L=$L(LN)
"RTN","RGNETWWW",55,0)
 I L,$E(LN,L-1,L)=$C(13,10) S LN=$E(LN,1,L-2)
"RTN","RGNETWWW",56,0)
 Q L
"RTN","RGNETWWW",57,0)
 ; Extrinsic to act as an array stream source
"RTN","RGNETWWW",58,0)
 ;  .LN = Single line returned from input stream.
"RTN","RGNETWWW",59,0)
 ;  ARYREF = Contains arrary reference.  Note: input array will be killed.
"RTN","RGNETWWW",60,0)
ARYSTRM(LN,ARYREF) ;
"RTN","RGNETWWW",61,0)
 N X,L
"RTN","RGNETWWW",62,0)
 S X=$Q(@ARYREF),L=$QL(ARYREF)
"RTN","RGNETWWW",63,0)
 Q:'$L(X) 0
"RTN","RGNETWWW",64,0)
 Q:$NA(@X,L)'=ARYREF 0
"RTN","RGNETWWW",65,0)
 S LN=@X
"RTN","RGNETWWW",66,0)
 K @X
"RTN","RGNETWWW",67,0)
 Q 1
"RTN","RGNETWWW",68,0)
 ; Parse the HTTP request
"RTN","RGNETWWW",69,0)
 ;  STREAM  = Input stream (an extrinsic for returning successive lines)
"RTN","RGNETWWW",70,0)
 ; .RGNETREQ = Array to receive the parsed results
"RTN","RGNETWWW",71,0)
 ; Parsed components are stored under the following nodes:
"RTN","RGNETWWW",72,0)
 ;  HDR    = Headers
"RTN","RGNETWWW",73,0)
 ;  METHOD = Method
"RTN","RGNETWWW",74,0)
 ;  PARAMS = Query parameters
"RTN","RGNETWWW",75,0)
 ;  PATH   = Request path
"RTN","RGNETWWW",76,0)
 ;  HOST   = Request URL (less protocol)
"RTN","RGNETWWW",77,0)
PARSEREQ(STREAM,RGNETREQ) ;
"RTN","RGNETWWW",78,0)
 N METHOD,PATH,HEADERS,NEXT,LP,LN,CNT,QRY,X
"RTN","RGNETWWW",79,0)
 S CNT=0,NEXT="X="_STREAM
"RTN","RGNETWWW",80,0)
 F  S @NEXT Q:'X  D
"RTN","RGNETWWW",81,0)
 .I '$D(METHOD) S METHOD=LN Q
"RTN","RGNETWWW",82,0)
 .I 'CNT S CNT='$L(LN) Q:CNT
"RTN","RGNETWWW",83,0)
 .I 'CNT D PARSEHDR(LN) Q
"RTN","RGNETWWW",84,0)
 .S RGNETREQ("BODY",CNT)=LN,CNT=CNT+1
"RTN","RGNETWWW",85,0)
 I '$D(METHOD) Q 400
"RTN","RGNETWWW",86,0)
 S PATH=$P(METHOD," ",2),METHOD=$P(METHOD," ")
"RTN","RGNETWWW",87,0)
 I '$L(METHOD) Q 405
"RTN","RGNETWWW",88,0)
 I PATH["?" D
"RTN","RGNETWWW",89,0)
 .S QRY=$P(PATH,"?",2,9999),PATH=$P(PATH,"?")
"RTN","RGNETWWW",90,0)
 .D PARSEQS(QRY)
"RTN","RGNETWWW",91,0)
 S:$E(PATH)="/" PATH=$E(PATH,2,9999)
"RTN","RGNETWWW",92,0)
 S:$E(PATH,$L(PATH))="/" PATH=$E(PATH,1,$L(PATH)-1)
"RTN","RGNETWWW",93,0)
 S PATH=$$UNESCURL(PATH)
"RTN","RGNETWWW",94,0)
 S RGNETREQ("METHOD")=METHOD
"RTN","RGNETWWW",95,0)
 S RGNETREQ("PATH")=PATH
"RTN","RGNETWWW",96,0)
 S RGNETREQ("HOST")=$G(RGNETREQ("HDR","host"))_"/"_$P(PATH,"/")
"RTN","RGNETWWW",97,0)
 Q 0
"RTN","RGNETWWW",98,0)
 ; Parse query string into array named in PREF.
"RTN","RGNETWWW",99,0)
 ;  QS = Query string
"RTN","RGNETWWW",100,0)
 ;  PREF = Array reference to receive data.  Defaults to RGNETREQ("PARAMS").
"RTN","RGNETWWW",101,0)
PARSEQS(QS,PREF) ;
"RTN","RGNETWWW",102,0)
 N X,Y,Z,N,V,M
"RTN","RGNETWWW",103,0)
 S PREF=$G(PREF,$NA(RGNETREQ("PARAMS")))
"RTN","RGNETWWW",104,0)
 F X=1:1:$L(QS,"&") D
"RTN","RGNETWWW",105,0)
 .S Y=$P(QS,"&",X),N=$$UNESCURL($P(Y,"=")),V=$$UNESCURL($P(Y,"=",2,9999)),M=""
"RTN","RGNETWWW",106,0)
 .I $L(N) D
"RTN","RGNETWWW",107,0)
 ..S Z=$L(N,":")
"RTN","RGNETWWW",108,0)
 ..I Z>1 D
"RTN","RGNETWWW",109,0)
 ...S Y=$P(N,":",Z)
"RTN","RGNETWWW",110,0)
 ...S M=$S(Y="missing":"m",Y="exact":"e",Y="text":"t",1:"")
"RTN","RGNETWWW",111,0)
 ...S:$L(M) N=$P(N,":",1,Z-1)
"RTN","RGNETWWW",112,0)
 ..S Y=1+$O(@PREF@(N,""),-1)
"RTN","RGNETWWW",113,0)
 ..F Z=1:1:$L(V,",") D
"RTN","RGNETWWW",114,0)
 ...S @PREF@(N,Y,Z)=$P(V,",",Z)
"RTN","RGNETWWW",115,0)
 ...S @PREF@(N,Y,Z,"OPR")=M
"RTN","RGNETWWW",116,0)
 Q
"RTN","RGNETWWW",117,0)
 ; Parse body as query string values
"RTN","RGNETWWW",118,0)
PARSEBD(PARAMS) ;
"RTN","RGNETWWW",119,0)
 N X
"RTN","RGNETWWW",120,0)
 F X=0:0 S X=$O(RGNETREQ("BODY",X)) Q:'X  D PARSEQS(RGNETREQ("BODY",X),"PARAMS")
"RTN","RGNETWWW",121,0)
 Q
"RTN","RGNETWWW",122,0)
 ; Parse http header into array named in HREF.
"RTN","RGNETWWW",123,0)
PARSEHDR(VALUE,HREF) ;
"RTN","RGNETWWW",124,0)
 N N,V
"RTN","RGNETWWW",125,0)
 S HREF=$G(HREF,$NA(RGNETREQ("HDR")))
"RTN","RGNETWWW",126,0)
 S N=$$LOW^XLFSTR($P(VALUE,":")),V=$$TRIM^XLFSTR($P(VALUE,":",2,999))
"RTN","RGNETWWW",127,0)
 S:$L(N) @HREF@(N)=V
"RTN","RGNETWWW",128,0)
 Q
"RTN","RGNETWWW",129,0)
 ; Replace escaped characters in URL
"RTN","RGNETWWW",130,0)
UNESCURL(X) ;
"RTN","RGNETWWW",131,0)
 I X["%"!(X["+") D
"RTN","RGNETWWW",132,0)
 .N P,C,H
"RTN","RGNETWWW",133,0)
 .F P=1:1 S C=$E(X,P) Q:'$L(C)  D
"RTN","RGNETWWW",134,0)
 ..I C="+" S $E(X,P)=" "
"RTN","RGNETWWW",135,0)
 ..E  I C="%" S H=$E(X,P+1,P+2),$E(X,P,P+2)=$C($$DEC^XLFUTL(H,16))
"RTN","RGNETWWW",136,0)
 Q X
"RTN","RGNETWWW",137,0)
 ; Escape reserved characters
"RTN","RGNETWWW",138,0)
ESCAPE(VALUE) ;
"RTN","RGNETWWW",139,0)
 N LP
"RTN","RGNETWWW",140,0)
 F LP="&;amp","<;lt",">;gt",$C(9)_";nbsp","|TAB|;nbsp" D
"RTN","RGNETWWW",141,0)
 .S VALUE=$$SUBST^RGUT(VALUE,$P(LP,";"),"&"_$P(LP,";",2)_";")
"RTN","RGNETWWW",142,0)
 Q VALUE
"RTN","RGNETWWW",143,0)
 ; Returns true if the status code represents an error
"RTN","RGNETWWW",144,0)
 ;  STATUS = If not specified, the current status code is checked.
"RTN","RGNETWWW",145,0)
ISERROR(STATUS) ;
"RTN","RGNETWWW",146,0)
 S:'$D(STATUS) STATUS=+$G(RGNETRSP("STATUS"))
"RTN","RGNETWWW",147,0)
 Q STATUS'<400
"RTN","RGNETWWW",148,0)
 ; Sets http status code
"RTN","RGNETWWW",149,0)
 ;  STATUS = HTTP status code
"RTN","RGNETWWW",150,0)
 ;  INFO  = Informational text for display (by default uses the status text)
"RTN","RGNETWWW",151,0)
 ;  RESET = If true, clear the output buffer.  If not specified, the output
"RTN","RGNETWWW",152,0)
 ;          buffer is cleared only if the status code represents an error.
"RTN","RGNETWWW",153,0)
SETSTAT(STATUS,INFO,RESET) ;
"RTN","RGNETWWW",154,0)
 N TEXT
"RTN","RGNETWWW",155,0)
 S TEXT=$P(^RGNET(996.521,STATUS,0),U,2),RGNETRSP("STATUS")=""
"RTN","RGNETWWW",156,0)
 D:$G(RESET,$$ISERROR(STATUS)) RESET,ADD("<h1>"_$G(INFO,TEXT)_"</h1>")
"RTN","RGNETWWW",157,0)
 S RGNETRSP("STATUS")=STATUS_" "_TEXT
"RTN","RGNETWWW",158,0)
 Q
"RTN","RGNETWWW",159,0)
 ; Sets the content type
"RTN","RGNETWWW",160,0)
SETCTYPE(CTYPE) ;
"RTN","RGNETWWW",161,0)
 S RGNETRSP("CTYPE")=CTYPE
"RTN","RGNETWWW",162,0)
 Q
"RTN","RGNETWWW",163,0)
 ; Finishes a response by adding the necessary headers
"RTN","RGNETWWW",164,0)
ENDRSP D ADDHDR("HTTP/1.1 "_$G(RGNETRSP("STATUS"),"200 OK"),-999)
"RTN","RGNETWWW",165,0)
 D ADDHDR("Date: "_$$WWWDATE,-998)
"RTN","RGNETWWW",166,0)
 D:$D(RGNETRSP("CTYPE"))#2 ADDHDR("Content-Type: "_RGNETRSP("CTYPE")_"; charset=utf-8",-998)
"RTN","RGNETWWW",167,0)
 D ADDHDR("Content-Length: "_+$G(RGNETRSP("LEN")),-998)
"RTN","RGNETWWW",168,0)
 D ADDHDR("",0)
"RTN","RGNETWWW",169,0)
 Q
"RTN","RGNETWWW",170,0)
 ; Add to response buffer
"RTN","RGNETWWW",171,0)
ADD(X) N Y
"RTN","RGNETWWW",172,0)
 S:'$$ISERROR Y=$O(@RGNETRSP@(""),-1)+1,@RGNETRSP@(Y)=X,RGNETRSP("LEN")=RGNETRSP("LEN")+$L(X),RGNETRSP("LAST")=Y
"RTN","RGNETWWW",173,0)
 Q
"RTN","RGNETWWW",174,0)
 ; Add array to output buffer
"RTN","RGNETWWW",175,0)
 ; RT  = Array root
"RTN","RGNETWWW",176,0)
 ; EOL = End of line character(s)
"RTN","RGNETWWW",177,0)
ADDARY(RT,EOL) ;
"RTN","RGNETWWW",178,0)
 N LP
"RTN","RGNETWWW",179,0)
 S EOL=$G(EOL),LP=0
"RTN","RGNETWWW",180,0)
 F  S LP=$O(@RT@(LP)) Q:'LP  D
"RTN","RGNETWWW",181,0)
 .D ADD($G(@RT@(LP))_$G(@RT@(LP,0))_EOL)
"RTN","RGNETWWW",182,0)
 Q
"RTN","RGNETWWW",183,0)
 ; Add HTTP response header to output buffer
"RTN","RGNETWWW",184,0)
 ;  HDR = Properly formatted header
"RTN","RGNETWWW",185,0)
 ;  SB  = Affects the position of the header in the output.  Typically, not specified.
"RTN","RGNETWWW",186,0)
ADDHDR(HDR,SB) ;
"RTN","RGNETWWW",187,0)
 N NXT
"RTN","RGNETWWW",188,0)
 S SB=+$G(SB,-1)
"RTN","RGNETWWW",189,0)
 S:SB>0 SB=-SB
"RTN","RGNETWWW",190,0)
 S NXT=$O(@RGNETRSP@(SB,""),-1)+1,@RGNETRSP@(SB,NXT)=HDR_$C(13,10)
"RTN","RGNETWWW",191,0)
 Q
"RTN","RGNETWWW",192,0)
 ; Replace buffer contents at specified index, adjusting content length accordingly.
"RTN","RGNETWWW",193,0)
REPLACE(IDX,X) ;
"RTN","RGNETWWW",194,0)
 N Y
"RTN","RGNETWWW",195,0)
 S Y=$L(X)-$L(@RGNETRSP@(IDX)),@RGNETRSP@(IDX)=X,RGNETRSP("LEN")=RGNETRSP("LEN")+Y
"RTN","RGNETWWW",196,0)
 Q
"RTN","RGNETWWW",197,0)
 ; Returns the specified query parameter
"RTN","RGNETWWW",198,0)
 ; PN = Parameter name
"RTN","RGNETWWW",199,0)
 ; P1 = Parameter series - for duplicate parameters, specifies which among them (defaults to 1)
"RTN","RGNETWWW",200,0)
 ; P2 = Parameter value  - for multivalued parameters, specifies which value (defaults to 1)
"RTN","RGNETWWW",201,0)
GETPARAM(PN,P1,P2) ;
"RTN","RGNETWWW",202,0)
 Q $G(RGNETREQ("PARAMS",PN,$G(P1,1),$G(P2,1)))
"RTN","RGNETWWW",203,0)
 ; Initialize environment
"RTN","RGNETWWW",204,0)
INIT S:'($D(RGNETRSP)#2) RGNETRSP=$$TMPGBL
"RTN","RGNETWWW",205,0)
 D RESET
"RTN","RGNETWWW",206,0)
 Q
"RTN","RGNETWWW",207,0)
 ; Reset the output buffer
"RTN","RGNETWWW",208,0)
RESET K @RGNETRSP
"RTN","RGNETWWW",209,0)
 S (RGNETRSP("LAST"),RGNETRSP("LEN"))=0
"RTN","RGNETWWW",210,0)
 Q
"RTN","RGNETWWW",211,0)
 ; Returns the host url (e.g., www.xyz.net)
"RTN","RGNETWWW",212,0)
HOST(PATH,DFLT) ;
"RTN","RGNETWWW",213,0)
 N URL
"RTN","RGNETWWW",214,0)
 S URL=$G(PATH)
"RTN","RGNETWWW",215,0)
 S:$E(URL)="*" URL=$G(DFLT)_$E(URL,2,9999)
"RTN","RGNETWWW",216,0)
 Q $$CONCAT(RGNETREQ("HOST"),URL)
"RTN","RGNETWWW",217,0)
 ; Returns host URL including the transport protocol (e.g., http://www.xyz.net)
"RTN","RGNETWWW",218,0)
HOSTURL(PATH) ;
"RTN","RGNETWWW",219,0)
 Q $G(RGNETREQ("HDR","x-forwarded-proto"),"http")_"://"_$$HOST(.PATH)
"RTN","RGNETWWW",220,0)
 ; Prepend local system root to path
"RTN","RGNETWWW",221,0)
LOCALSYS(PATH) ;
"RTN","RGNETWWW",222,0)
 Q $$CONCAT("http://"_$$LOW^XLFSTR($$KSP^XUPARAM("WHERE")),.PATH)
"RTN","RGNETWWW",223,0)
 ; Return UUID for this system
"RTN","RGNETWWW",224,0)
SYSUUID() ;
"RTN","RGNETWWW",225,0)
 S:'$L($G(^RGNET("SYS"))) ^("SYS")=$$UUID^RGUT
"RTN","RGNETWWW",226,0)
 Q ^("SYS")
"RTN","RGNETWWW",227,0)
 ; Concatenate path to url.
"RTN","RGNETWWW",228,0)
CONCAT(URL,PATH) ;
"RTN","RGNETWWW",229,0)
 Q:'$D(PATH) URL
"RTN","RGNETWWW",230,0)
 F  Q:$E(URL,$L(URL))'="/"  S $E(URL,$L(URL))=""
"RTN","RGNETWWW",231,0)
 F  Q:$E(PATH)'="/"  S $E(PATH)=""
"RTN","RGNETWWW",232,0)
 Q $S($L(PATH):URL_"/"_PATH,1:URL)
"RTN","RGNETWWW",233,0)
 ; Date (format per RFC 1123)
"RTN","RGNETWWW",234,0)
WWWDATE(DT) ;
"RTN","RGNETWWW",235,0)
 N TZ,H,M,SN
"RTN","RGNETWWW",236,0)
 S:'$G(DT) DT=$$NOW^XLFDT
"RTN","RGNETWWW",237,0)
 S TZ=$$TZ^XLFDT,H=+$E(TZ,2,3),M=+$E(TZ,4,5),SN=$S(TZ<0:1,1:-1)
"RTN","RGNETWWW",238,0)
 S DT=$$FMADD^XLFDT(DT,0,H*SN,M*SN,0)
"RTN","RGNETWWW",239,0)
 Q $$FMTDATE^RGUTDATF(DT,"EEE, dd MMM YYYY HH:mm:ss 'GMT'")
"RTN","RGNETWWW",240,0)
 ; Returns true if request came from a browser
"RTN","RGNETWWW",241,0)
ISBROWSR() ;
"RTN","RGNETWWW",242,0)
 Q $G(RGNETREQ("HDR","user-agent"))["Mozilla"
"RTN","RGNETWWW",243,0)
 ; Attempt authentication if credentials available
"RTN","RGNETWWW",244,0)
 ; If REQUIRED is true, authentication must succeed.
"RTN","RGNETWWW",245,0)
 ; Returns true if successful
"RTN","RGNETWWW",246,0)
AUTH(TYPE,REQUIRED) ;
"RTN","RGNETWWW",247,0)
 N TP,CRED
"RTN","RGNETWWW",248,0)
 S TP=$G(RGNETREQ("HDR","authorization")),CRED=$P(TP," ",2),TP=$$UP^XLFSTR($P(TP," "))
"RTN","RGNETWWW",249,0)
 I '$L(TP),'REQUIRED Q 1
"RTN","RGNETWWW",250,0)
 K RGNETREQ("HDR","authorization"),DUZ
"RTN","RGNETWWW",251,0)
 S DUZ=0
"RTN","RGNETWWW",252,0)
 I '$$AUTH1 D  Q 0
"RTN","RGNETWWW",253,0)
 .D SETSTAT(403,"Logins Disabled")
"RTN","RGNETWWW",254,0)
 I '$$AUTH2 D  Q 0
"RTN","RGNETWWW",255,0)
 .D SETSTAT(401)
"RTN","RGNETWWW",256,0)
 .S:'$L(TYPE) TYPE="BASIC^BEARER"
"RTN","RGNETWWW",257,0)
 .F TP=1:1:$L(TYPE,U) D ADDHDR("WWW-Authenticate: "_$P(TYPE,U,TP))
"RTN","RGNETWWW",258,0)
 I '$$AUTH3 D  Q 0
"RTN","RGNETWWW",259,0)
 .D SETSTAT(403,"Credentials Expired")
"RTN","RGNETWWW",260,0)
 S DUZ(2)=+$$CHKDIV^XUS1
"RTN","RGNETWWW",261,0)
 S:'DUZ(2) DUZ(2)=$P(^XTV(8989.3,1,"XUS"),U,17)
"RTN","RGNETWWW",262,0)
 Q 1
"RTN","RGNETWWW",263,0)
AUTH1() N X,Y
"RTN","RGNETWWW",264,0)
 D XUVOL^XUS,XOPT^XUS
"RTN","RGNETWWW",265,0)
 Q '$$INHIBIT^XUSRB
"RTN","RGNETWWW",266,0)
AUTH2() S:TYPE="ANY" TYPE=""
"RTN","RGNETWWW",267,0)
 I $L(TYPE),TP'=TYPE Q 0
"RTN","RGNETWWW",268,0)
 I TP="BASIC" D
"RTN","RGNETWWW",269,0)
 .S CRED=$$DECODE^RGUTUU(CRED),CRED=$P(CRED,":")_";"_$P(CRED,":",2,9999)
"RTN","RGNETWWW",270,0)
 .S DUZ=$$CHECKAV^XUSRB(CRED),TYPE=TP
"RTN","RGNETWWW",271,0)
 E  I TP="BEARER" D
"RTN","RGNETWWW",272,0)
 .S DUZ=$$ISVALID^RGNETOAT(CRED),TYPE=TP
"RTN","RGNETWWW",273,0)
 Q DUZ
"RTN","RGNETWWW",274,0)
AUTH3() N XUSER
"RTN","RGNETWWW",275,0)
 Q '$$VCHG^XUS1
"RTN","RGNETWWW",276,0)
 ; Convert to pattern (Used for URL matching)
"RTN","RGNETWWW",277,0)
TOPTRN(NM) ;
"RTN","RGNETWWW",278,0)
 N P,C,X,L
"RTN","RGNETWWW",279,0)
 S (L,P)=""
"RTN","RGNETWWW",280,0)
 F X=1:1:$L(NM) D
"RTN","RGNETWWW",281,0)
 .S C=$E(NM,X)
"RTN","RGNETWWW",282,0)
 .I C="*" D TOPTRN2(".E") Q
"RTN","RGNETWWW",283,0)
 .I C="#" D TOPTRN2("1.N") Q
"RTN","RGNETWWW",284,0)
 .S L=L_C
"RTN","RGNETWWW",285,0)
 D:$L(P) TOPTRN2("")
"RTN","RGNETWWW",286,0)
 Q P
"RTN","RGNETWWW",287,0)
TOPTRN2(X) ;
"RTN","RGNETWWW",288,0)
 S:$L(L) P=P_"1"""_L_"""",L=""
"RTN","RGNETWWW",289,0)
 S P=P_X
"RTN","RGNETWWW",290,0)
 Q
"RTN","RGNETWWW",291,0)
 ; Compiles an access constraint expression
"RTN","RGNETWWW",292,0)
 ;  ACE    = An access constraint expression
"RTN","RGNETWWW",293,0)
 ;  SILENT = If true, suppress error output
"RTN","RGNETWWW",294,0)
ACECOMP(ACE,SILENT) ;
"RTN","RGNETWWW",295,0)
 Q:";"[$E(ACE) ""
"RTN","RGNETWWW",296,0)
 N POS,EXP,TKN,RES,ERR,C
"RTN","RGNETWWW",297,0)
 S (EXP,TKN)="",(ST,PRN)=0,SILENT=$G(SILENT)!$G(DIQUIET)
"RTN","RGNETWWW",298,0)
 F POS=1:1:$L(ACE)+1 D  Q:$D(ERR)
"RTN","RGNETWWW",299,0)
 .S C=$E(ACE,POS)
"RTN","RGNETWWW",300,0)
 .I C="\" S POS=POS+1,TKN=TKN_$E(ACE,POS)
"RTN","RGNETWWW",301,0)
 .E  I "()&!'"[C S EXP=EXP_$$ACECOMP2(TKN,.ERR)_C,TKN=""
"RTN","RGNETWWW",302,0)
 .E  S TKN=TKN_C
"RTN","RGNETWWW",303,0)
 I '$D(ERR) D
"RTN","RGNETWWW",304,0)
 .S RES=$$ENTRY^RGUTSTX("I "_EXP)
"RTN","RGNETWWW",305,0)
 .S:RES ERR=$P(RES,U,3)_" @ "_$P(RES,U,2)
"RTN","RGNETWWW",306,0)
 I $D(ERR) D
"RTN","RGNETWWW",307,0)
 .W:'SILENT ERR,!
"RTN","RGNETWWW",308,0)
 .S ACE=";"_ACE,EXP=""
"RTN","RGNETWWW",309,0)
 Q EXP
"RTN","RGNETWWW",310,0)
 ; Process a name token
"RTN","RGNETWWW",311,0)
 ;  TKN = A name token of the form <type>.<name> where <type> is one of
"RTN","RGNETWWW",312,0)
 ;         K = security key, O = option, P = parameter
"RTN","RGNETWWW",313,0)
 ;  ERR = Set to error text if an error occurs.
"RTN","RGNETWWW",314,0)
ACECOMP2(TKN,ERR) ;
"RTN","RGNETWWW",315,0)
 Q:'$L(TKN) ""
"RTN","RGNETWWW",316,0)
 N TP,NM,FN,RT
"RTN","RGNETWWW",317,0)
 S TP=$P(TKN,"."),NM=$P(TKN,".",2,999)
"RTN","RGNETWWW",318,0)
 S:'$L(NM) NM="?"
"RTN","RGNETWWW",319,0)
 S FN=$S(TP="K":"HASKEY^DIC(19.1)",TP="O":"HASOPT^DIC(19)",TP="P":"HASPRM^XTV(8989.51)",1:"")
"RTN","RGNETWWW",320,0)
 I '$L(FN) S ERR="Unrecognized token: "_TKN Q ""
"RTN","RGNETWWW",321,0)
 S RT=U_$P(FN,U,2),FN=$P(FN,U)
"RTN","RGNETWWW",322,0)
 I '$D(@RT@("B",NM)) S ERR=$P(@RT@(0),U)_" "_NM_" not found." Q ""
"RTN","RGNETWWW",323,0)
 Q "$$"_FN_"("""_NM_""")"
"RTN","RGNETWWW",324,0)
 ; Evaluates a compiled access constraint expression
"RTN","RGNETWWW",325,0)
 ;  EXP = compiled expression
"RTN","RGNETWWW",326,0)
 ; Returns true if access is granted
"RTN","RGNETWWW",327,0)
ACEEVAL(EXP) ;
"RTN","RGNETWWW",328,0)
 I $G(DUZ),@EXP
"RTN","RGNETWWW",329,0)
 Q $T
"RTN","RGNETWWW",330,0)
 ; Returns true if the user possesses the specified security key.
"RTN","RGNETWWW",331,0)
HASKEY(VL) ;
"RTN","RGNETWWW",332,0)
 Q $D(^XUSEC(VL,DUZ))
"RTN","RGNETWWW",333,0)
 ; Returns true if the user has access to the specified option.
"RTN","RGNETWWW",334,0)
HASOPT(VL) ;
"RTN","RGNETWWW",335,0)
 Q $$ACCESS^XQCHK(DUZ,VL)>0
"RTN","RGNETWWW",336,0)
 ; Returns true if the user has a setting of true for the specified
"RTN","RGNETWWW",337,0)
 ; parameter.
"RTN","RGNETWWW",338,0)
HASPRM(VL) ;
"RTN","RGNETWWW",339,0)
 Q ''$$GET^XPAR("USR^PKG^SYS",VL,,"Q")
"RTN","RGNETWWW",340,0)
 ; Looks up endpoint for URL
"RTN","RGNETWWW",341,0)
 ; Returns IEN of endpoint
"RTN","RGNETWWW",342,0)
URL2EP(METHOD,URL) ;
"RTN","RGNETWWW",343,0)
 N IEN
"RTN","RGNETWWW",344,0)
 S:'$L(URL) URL="/"
"RTN","RGNETWWW",345,0)
 S IEN=$$URL2EPX(METHOD,URL)
"RTN","RGNETWWW",346,0)
 S:'IEN IEN=$$URL2EPX(METHOD,URL,$E(URL))
"RTN","RGNETWWW",347,0)
 S:'IEN IEN=$$URL2EPX(METHOD,URL,"#")
"RTN","RGNETWWW",348,0)
 S:'IEN IEN=$$URL2EPX(METHOD,URL,"*")
"RTN","RGNETWWW",349,0)
 Q IEN
"RTN","RGNETWWW",350,0)
URL2EPX(METHOD,URL,URLX) ;
"RTN","RGNETWWW",351,0)
 N RT,FND,PTRN,IEN,URL2
"RTN","RGNETWWW",352,0)
 S:$E(URL,$L(URL))'="/" URL2=URL_"/"
"RTN","RGNETWWW",353,0)
 I '$D(URLX) D
"RTN","RGNETWWW",354,0)
 .S FND=$O(^RGNET(996.52,"C",METHOD,URL,0))
"RTN","RGNETWWW",355,0)
 .I 'FND,$D(URL2) S FND=$O(^RGNET(996.52,"C",METHOD,URL2,0))
"RTN","RGNETWWW",356,0)
 E  D
"RTN","RGNETWWW",357,0)
 .S RT=URLX,FND=0
"RTN","RGNETWWW",358,0)
 .F  S URLX=$O(^RGNET(996.52,"C",METHOD,URLX)) Q:$E(URLX)'=RT  D  Q:FND
"RTN","RGNETWWW",359,0)
 ..F IEN=0:0 S IEN=$O(^RGNET(996.52,"C",METHOD,URLX,IEN)) Q:'IEN  S PTRN=^(IEN) D:$L(PTRN)  Q:FND
"RTN","RGNETWWW",360,0)
 ...S:URL?@PTRN FND=IEN
"RTN","RGNETWWW",361,0)
 ...I 'FND,$D(URL2),URL2?@PTRN S FND=IEN
"RTN","RGNETWWW",362,0)
 Q FND
"RTN","RGNETWWW",363,0)
 ; Returns the weighted value if content type matches an accepted type,
"RTN","RGNETWWW",364,0)
 ; or 0 if no match.
"RTN","RGNETWWW",365,0)
ISCTYPE(MTYPE,ACCPT) ;
"RTN","RGNETWWW",366,0)
 N AT,LP,MT,R,X,Q
"RTN","RGNETWWW",367,0)
 S ACCPT=$TR(ACCPT," "),MTYPE=$TR(MTYPE," ")
"RTN","RGNETWWW",368,0)
 F LP=1:1:$L(ACCPT,",") D
"RTN","RGNETWWW",369,0)
 .S X=$P(ACCPT,",",LP),Q=$P(X,";",2),X=$P(X,";")
"RTN","RGNETWWW",370,0)
 .S Q=$S($E(Q,1,2)="q=":+$E(Q,3,99),1:1)
"RTN","RGNETWWW",371,0)
 .S:$L(X) AT(Q,X)=""
"RTN","RGNETWWW",372,0)
 Q:'$D(AT) 1
"RTN","RGNETWWW",373,0)
 S Q=""
"RTN","RGNETWWW",374,0)
 F  S Q=$O(AT(Q),-1) Q:'Q  D  Q:$D(R)
"RTN","RGNETWWW",375,0)
 .S AT=""
"RTN","RGNETWWW",376,0)
 .F  S AT=$O(AT(Q,AT)) Q:'$L(AT)  D  Q:$D(R)
"RTN","RGNETWWW",377,0)
 ..I AT="*/*" S R=Q Q
"RTN","RGNETWWW",378,0)
 ..F LP=1:1:$L(MTYPE,",") D  Q:$D(R)
"RTN","RGNETWWW",379,0)
 ...S MT=$P(MTYPE,",",LP)
"RTN","RGNETWWW",380,0)
 ...I AT=MT S R=Q Q
"RTN","RGNETWWW",381,0)
 ...I AT["/*",$P(AT,"/")=$P(MT,"/") S R=Q Q
"RTN","RGNETWWW",382,0)
 ...I AT["*/",$P(AT,"/",2)=$P(MT,"/",2) S R=Q Q
"RTN","RGNETWWW",383,0)
 Q $S($D(R):R,1:0)
"RTN","RGNETWWW",384,0)
 ; Return unique temp global reference
"RTN","RGNETWWW",385,0)
 ; If X is specified, returns the temp global at that index.
"RTN","RGNETWWW",386,0)
 ; Otherwise, returns the next available global reference.
"RTN","RGNETWWW",387,0)
TMPGBL(X) ;
"RTN","RGNETWWW",388,0)
 Q:$G(X) $NA(^TMP("RGNETWWW",$J,X))
"RTN","RGNETWWW",389,0)
 F  S X=$G(^TMP("RGNETWWW",$J))+1,^($J)=X,X=$NA(^($J,X)) Q:'$D(@X)
"RTN","RGNETWWW",390,0)
 Q X
"RTN","RGNETWWW",391,0)
 ; Cleanup temp globals on completion
"RTN","RGNETWWW",392,0)
CLEANUP N LP,TMP,EXC
"RTN","RGNETWWW",393,0)
 S TMP=$NA(^TMP("RGNETWWW",$J))
"RTN","RGNETWWW",394,0)
 I TMP'=$NA(@RGNETRSP,2) K @TMP Q
"RTN","RGNETWWW",395,0)
 S (@TMP,EXC)=$QS(RGNETRSP,3)
"RTN","RGNETWWW",396,0)
 F LP=0:0 S LP=$O(@TMP@(LP)) Q:'LP  K:LP'=EXC @TMP@(LP)
"RTN","RGNETWWW",397,0)
 Q
"RTN","RGNETWWW",398,0)
 ; Returns description
"RTN","RGNETWWW",399,0)
GREETING D ADDARY($NA(^RGNET(996.52,HANDLER,99)))
"RTN","RGNETWWW",400,0)
 Q
"RTN","SYNBSTS1")
0^76^B20431042
"RTN","SYNBSTS1",1,0)
SYNBSTS1 ;ven/gpl - fhir loader utilities ;2018-08-17  3:22 PM
"RTN","SYNBSTS1",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNBSTS1",3,0)
 ;
"RTN","SYNBSTS1",4,0)
 ; Authored by George P. Lilly 2017-2018
"RTN","SYNBSTS1",5,0)
 ;
"RTN","SYNBSTS1",6,0)
 q
"RTN","SYNBSTS1",7,0)
 ;
"RTN","SYNBSTS1",8,0)
ICD9ROOT() ; returns the root of the snomed to icd9 graph
"RTN","SYNBSTS1",9,0)
 n root s root=$$setroot^%wd("icd9tosnomed")
"RTN","SYNBSTS1",10,0)
 q:root=""
"RTN","SYNBSTS1",11,0)
 s root=$na(@root@("graph","icd9tosnomed.csv"))
"RTN","SYNBSTS1",12,0)
 q root
"RTN","SYNBSTS1",13,0)
 ;
"RTN","SYNBSTS1",14,0)
ICD10ROOT() ; returns the root of the snomed to icd10 graph
"RTN","SYNBSTS1",15,0)
 n root s root=$$setroot^%wd("sct2icd")
"RTN","SYNBSTS1",16,0)
 s root=$na(@root@("graph","sct2icd"))
"RTN","SYNBSTS1",17,0)
 q root
"RTN","SYNBSTS1",18,0)
 ;
"RTN","SYNBSTS1",19,0)
match ; try matching snomed codes between icd9 and icd10 graphs
"RTN","SYNBSTS1",20,0)
 n zi,gicd9,gicd10
"RTN","SYNBSTS1",21,0)
 s gicd9=$$ICD9ROOT
"RTN","SYNBSTS1",22,0)
 s gicd10=$$ICD10ROOT
"RTN","SYNBSTS1",23,0)
 s zi=0
"RTN","SYNBSTS1",24,0)
 n cnt s cnt=0
"RTN","SYNBSTS1",25,0)
 f  s zi=$o(@gicd9@(zi)) q:+zi=0  d  ;
"RTN","SYNBSTS1",26,0)
 . q:'$d(@gicd9@(zi))
"RTN","SYNBSTS1",27,0)
 . n sct,icd9,icd10
"RTN","SYNBSTS1",28,0)
 . s sct=$g(@gicd9@(zi,"SNOMED"))
"RTN","SYNBSTS1",29,0)
 . i sct="" d  q
"RTN","SYNBSTS1",30,0)
 . . w !,"error, Snomed code not found ",zi," ",$g(@gicd9@(zi,"ICD9"))
"RTN","SYNBSTS1",31,0)
 . s icd9=$g(@gicd9@(zi,"ICD9"))
"RTN","SYNBSTS1",32,0)
 . i icd9="" d  q
"RTN","SYNBSTS1",33,0)
 . . w !,"error, ICD9 code not found ",zi
"RTN","SYNBSTS1",34,0)
 . n icd10dx
"RTN","SYNBSTS1",35,0)
 . s icd10dx=$o(@gicd10@("ops",sct,"snomedCode",""))
"RTN","SYNBSTS1",36,0)
 . i icd10dx="" d  q  ;
"RTN","SYNBSTS1",37,0)
 . . w !,"error, snomed code not found in ICD10 graph ",zi," icd9= ",icd9
"RTN","SYNBSTS1",38,0)
 . s icd10=$g(@gicd10@(icd10dx,"icd10code"))
"RTN","SYNBSTS1",39,0)
 . i icd10="" d  q  ;
"RTN","SYNBSTS1",40,0)
 . . w !,"error, icd10 code not found ",zi," icd9= ",icd9
"RTN","SYNBSTS1",41,0)
 . i icd10["?" s icd10=$tr(icd10,"?","")
"RTN","SYNBSTS1",42,0)
 . ;w !,"zi= ",zi," snomed= ",sct," icd10= ",icd10 
"RTN","SYNBSTS1",43,0)
 . s cnt=cnt+1
"RTN","SYNBSTS1",44,0)
 w !,"count= ",cnt
"RTN","SYNBSTS1",45,0)
 q
"RTN","SYNBSTS1",46,0)
 ;
"RTN","SYNBSTS1",47,0)
count ; count the unique snomed codes in the icd10 graph
"RTN","SYNBSTS1",48,0)
 n sct,gicd9,gicd10
"RTN","SYNBSTS1",49,0)
 s gicd9=$$ICD9ROOT
"RTN","SYNBSTS1",50,0)
 s gicd10=$$ICD10ROOT
"RTN","SYNBSTS1",51,0)
 s sct=""
"RTN","SYNBSTS1",52,0)
 n cnt s cnt=0
"RTN","SYNBSTS1",53,0)
 f  s sct=$o(@gicd10@("pos","snomedCode",sct)) q:sct=""  d  ;
"RTN","SYNBSTS1",54,0)
 . s cnt=cnt+1
"RTN","SYNBSTS1",55,0)
 w !,"count of snomed codes in icd10 graph= ",cnt
"RTN","SYNBSTS1",56,0)
 q
"RTN","SYNBSTS1",57,0)
 ;
"RTN","SYNBSTS1",58,0)
matchbsts ; try matching snomed codes between icd9 and icd10 graphs and bsts
"RTN","SYNBSTS1",59,0)
 n zi,gicd9,gicd10
"RTN","SYNBSTS1",60,0)
 s gicd9=$$ICD9ROOT
"RTN","SYNBSTS1",61,0)
 s gicd10=$$ICD10ROOT
"RTN","SYNBSTS1",62,0)
 s zi=0
"RTN","SYNBSTS1",63,0)
 n bsts9success,bsts10success,bstsSctSuccess,bstsSctError
"RTN","SYNBSTS1",64,0)
 s (bsts9success,bsts10success,bstsSctSuccess,bstsSctError)=0
"RTN","SYNBSTS1",65,0)
 n cnt s cnt=0
"RTN","SYNBSTS1",66,0)
 f  s zi=$o(@gicd9@(zi)) q:+zi=0  d  ;
"RTN","SYNBSTS1",67,0)
 . q:'$d(@gicd9@(zi))
"RTN","SYNBSTS1",68,0)
 . n sct,icd9,icd10,bstsicd9,bstsicd10
"RTN","SYNBSTS1",69,0)
 . s sct=$g(@gicd9@(zi,"SNOMED"))
"RTN","SYNBSTS1",70,0)
 . i sct="" d  q
"RTN","SYNBSTS1",71,0)
 . . w !,"error, Snomed code not found ",zi," ",$g(@gicd9@(zi,"ICD9"))
"RTN","SYNBSTS1",72,0)
 . s icd9=$g(@gicd9@(zi,"ICD9"))
"RTN","SYNBSTS1",73,0)
 . i icd9="" d  q
"RTN","SYNBSTS1",74,0)
 . . w !,"error, ICD9 code not found ",zi
"RTN","SYNBSTS1",75,0)
 . s bstsicd9=$$SCT2ICD9^C0TSUTL(sct)
"RTN","SYNBSTS1",76,0)
 . i bstsicd9=-1 d  ;
"RTN","SYNBSTS1",77,0)
 . . w !,"bsts_error, SCT code not found: ",sct
"RTN","SYNBSTS1",78,0)
 . . s bstsSctError=bstsSctError+1
"RTN","SYNBSTS1",79,0)
 . e  s bstsSctSuccess=bstsSctSuccess+1
"RTN","SYNBSTS1",80,0)
 . i bstsicd9="" d  ;q
"RTN","SYNBSTS1",81,0)
 . . w !,"bsts_error, ICD9 code not found ",zi," for SCT code ",sct
"RTN","SYNBSTS1",82,0)
 . i bstsicd9>0 s bsts9success=bsts9success+1
"RTN","SYNBSTS1",83,0)
 . n icd10dx
"RTN","SYNBSTS1",84,0)
 . s icd10dx=$o(@gicd10@("ops",sct,"snomedCode",""))
"RTN","SYNBSTS1",85,0)
 . i icd10dx="" d  q  ;
"RTN","SYNBSTS1",86,0)
 . . w !,"error, snomed code not found in ICD10 graph ",zi," icd9= ",icd9
"RTN","SYNBSTS1",87,0)
 . s icd10=$g(@gicd10@(icd10dx,"icd10code"))
"RTN","SYNBSTS1",88,0)
 . i icd10="" d  ;q  ;
"RTN","SYNBSTS1",89,0)
 . . w !,"error, icd10 code not found ",zi," icd9= ",icd9
"RTN","SYNBSTS1",90,0)
 . i icd10["?" s icd10=$tr(icd10,"?","")
"RTN","SYNBSTS1",91,0)
 . ;w !,"zi= ",zi," snomed= ",sct," icd10= ",icd10 
"RTN","SYNBSTS1",92,0)
 . s bstsicd10=$$SCT2ICD10^C0TSUTL(sct)
"RTN","SYNBSTS1",93,0)
 . i bstsicd10=-1 d  ;
"RTN","SYNBSTS1",94,0)
 . . w !,"bsts_error, SCT code not found: ",sct
"RTN","SYNBSTS1",95,0)
 . . s bstsSctError=bstsSctError+1
"RTN","SYNBSTS1",96,0)
 . i bstsicd10="" d  ;q
"RTN","SYNBSTS1",97,0)
 . . w !,"bsts_error, ICD10 code not found ",zi," for SCT code ",sct," ",$$grsct2icd10(sct)
"RTN","SYNBSTS1",98,0)
 . i $l(bstsicd10)>2 s bsts10success=bsts10success+1
"RTN","SYNBSTS1",99,0)
 . s cnt=cnt+1
"RTN","SYNBSTS1",100,0)
 w !,"count= ",cnt
"RTN","SYNBSTS1",101,0)
 w !,"bsts ICD9 codes found: ",bsts9success
"RTN","SYNBSTS1",102,0)
 w !,"bsts ICD10 codes found: ",bsts10success
"RTN","SYNBSTS1",103,0)
 w !,"bsts SCT codes not found: ",bstsSctError
"RTN","SYNBSTS1",104,0)
 w !,"bsts SCT codes found: ",bstsSctSuccess
"RTN","SYNBSTS1",105,0)
 q
"RTN","SYNBSTS1",106,0)
 ;
"RTN","SYNBSTS1",107,0)
grsct2icd10(cde) ; extrinsic returns snomed to icd10 map from the graph
"RTN","SYNBSTS1",108,0)
 ;
"RTN","SYNBSTS1",109,0)
 q $$graphmap^SYNGRAPH("sct2icd",cde,"icd10code")
"RTN","SYNBSTS1",110,0)
 ;
"RTN","SYNBSTS1",111,0)
grsct2icd9(cde) ; extrinsic returns snomed to icd9 map from the graph
"RTN","SYNBSTS1",112,0)
 ;
"RTN","SYNBSTS1",113,0)
 q $$graphmap^SYNGRAPH("icd9tosnomed",cde,"ICD9")
"RTN","SYNBSTS1",114,0)
 ;
"RTN","SYNDHP01")
0^96^B22388996
"RTN","SYNDHP01",1,0)
SYNDHP01 ; HC/fjf/art - HealthConcourse - get patient vitals ;05/04/2019
"RTN","SYNDHP01",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP01",3,0)
 ;;
"RTN","SYNDHP01",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP01",5,0)
 ;
"RTN","SYNDHP01",6,0)
 QUIT
"RTN","SYNDHP01",7,0)
 ;
"RTN","SYNDHP01",8,0)
 ; ---------------- Get patient vitals ------------------------------
"RTN","SYNDHP01",9,0)
 ;
"RTN","SYNDHP01",10,0)
PATVIT(RETSTA,NAME,SSN,DOB,GENDER,FRDAT,TODAT,RETJSON) ; get vitals for a patient by traits
"RTN","SYNDHP01",11,0)
 S RETSTA="-1^This service has been retired"
"RTN","SYNDHP01",12,0)
 QUIT
"RTN","SYNDHP01",13,0)
 ; Return patient vitals for name, SSN, DOB, and gender
"RTN","SYNDHP01",14,0)
 ;
"RTN","SYNDHP01",15,0)
 ; Input:
"RTN","SYNDHP01",16,0)
 ;   NAME    - patient name
"RTN","SYNDHP01",17,0)
 ;   SSN     - social security number
"RTN","SYNDHP01",18,0)
 ;   DOB     - date of birth
"RTN","SYNDHP01",19,0)
 ;   GENDER  - gender
"RTN","SYNDHP01",20,0)
 ;   FRDAT   - from date (inclusive), optional, compared to .01 DATE/TIME VITALS TAKEN
"RTN","SYNDHP01",21,0)
 ;   TODAT   - to date (inclusive), optional, compared to .01 DATE/TIME VITALS TAKEN
"RTN","SYNDHP01",22,0)
 ;   RETJSON - J = Return JSON
"RTN","SYNDHP01",23,0)
 ;             F = Return FHIR
"RTN","SYNDHP01",24,0)
 ;             0 or null = Return string (default)
"RTN","SYNDHP01",25,0)
 ; Output:
"RTN","SYNDHP01",26,0)
 ;   RETSTA  - a delimited string that lists the vitals for a patient
"RTN","SYNDHP01",27,0)
 ;           - ICN^SCT code for vital|SCT description of vital|value of vital|date|resource id^...
"RTN","SYNDHP01",28,0)
 ;          or patient vitals in JSON format
"RTN","SYNDHP01",29,0)
 ;              
"RTN","SYNDHP01",30,0)
 ;     note:resource identifier will be:
"RTN","SYNDHP01",31,0)
 ;             "V"_SITE ID_FILE #_FILE IEN   e.g. V_500_120.5_930
"RTN","SYNDHP01",32,0)
 ;
"RTN","SYNDHP01",33,0)
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
"RTN","SYNDHP01",34,0)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
"RTN","SYNDHP01",35,0)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
"RTN","SYNDHP01",36,0)
 ;
"RTN","SYNDHP01",37,0)
 N ICNST
"RTN","SYNDHP01",38,0)
 D PATVAL^SYNDHP43(.ICNST,NAME,SSN,DOB,GENDER)
"RTN","SYNDHP01",39,0)
 I +ICNST'=1 S RETSTA=ICNST QUIT
"RTN","SYNDHP01",40,0)
 ; if we are here we are dealing with a valid patient
"RTN","SYNDHP01",41,0)
 N DHPIEN S DHPICN=$P(ICNST,U,3)
"RTN","SYNDHP01",42,0)
 ; get patient IEN from ICN
"RTN","SYNDHP01",43,0)
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP01",44,0)
 ;
"RTN","SYNDHP01",45,0)
 I PATIEN="" S RETSTA="-1^Patient ICN not found" QUIT
"RTN","SYNDHP01",46,0)
 ;
"RTN","SYNDHP01",47,0)
 N VARRAY
"RTN","SYNDHP01",48,0)
 S RETSTA=$$VITS(.VARRAY,PATIEN,DHPIEN,FRDAT,TODAT)
"RTN","SYNDHP01",49,0)
 ;
"RTN","SYNDHP01",50,0)
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
"RTN","SYNDHP01",51,0)
 . S RETSTA=""
"RTN","SYNDHP01",52,0)
 . D TOJASON^SYNDHPUTL(.VARRAY,.RETSTA)
"RTN","SYNDHP01",53,0)
 ;
"RTN","SYNDHP01",54,0)
 QUIT
"RTN","SYNDHP01",55,0)
 ;
"RTN","SYNDHP01",56,0)
PATVITI(RETSTA,DHPICN,FRDAT,TODAT,RETJSON) ; Patient vitals for ICN
"RTN","SYNDHP01",57,0)
 ;
"RTN","SYNDHP01",58,0)
 ; Return patient vitals for a given patient ICN
"RTN","SYNDHP01",59,0)
 ;
"RTN","SYNDHP01",60,0)
 ; Input:
"RTN","SYNDHP01",61,0)
 ;   ICN     - unique patient identifier across all VistA systems
"RTN","SYNDHP01",62,0)
 ;   FRDAT   - from date (inclusive), optional, compared to .01 DATE/TIME VITALS TAKEN
"RTN","SYNDHP01",63,0)
 ;   TODAT   - to date (inclusive), optional, compared to .01 DATE/TIME VITALS TAKEN
"RTN","SYNDHP01",64,0)
 ;   RETJSON - J = Return JSON
"RTN","SYNDHP01",65,0)
 ;             F = Return FHIR
"RTN","SYNDHP01",66,0)
 ;             0 or null = Return string (default)
"RTN","SYNDHP01",67,0)
 ; Output:
"RTN","SYNDHP01",68,0)
 ;   RETSTA  - a delimited string that lists the vitals for a patient
"RTN","SYNDHP01",69,0)
 ;           - ICN^SCT code for vital|SCT description of vital|value of vital|date|resource id^...
"RTN","SYNDHP01",70,0)
 ;          or patient vitals in JSON format
"RTN","SYNDHP01",71,0)
 ;              
"RTN","SYNDHP01",72,0)
 ;     note:resource identifier will be:
"RTN","SYNDHP01",73,0)
 ;             "V"_SITE ID_FILE #_FILE IEN   e.g. V_500_120.5_930
"RTN","SYNDHP01",74,0)
 ;
"RTN","SYNDHP01",75,0)
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
"RTN","SYNDHP01",76,0)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
"RTN","SYNDHP01",77,0)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
"RTN","SYNDHP01",78,0)
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
"RTN","SYNDHP01",79,0)
 ;
"RTN","SYNDHP01",80,0)
 ; validate ICN
"RTN","SYNDHP01",81,0)
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
"RTN","SYNDHP01",82,0)
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" QUIT
"RTN","SYNDHP01",83,0)
 ; get patient IEN from ICN
"RTN","SYNDHP01",84,0)
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP01",85,0)
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
"RTN","SYNDHP01",86,0)
 ;
"RTN","SYNDHP01",87,0)
 N VARRAY
"RTN","SYNDHP01",88,0)
 S RETSTA=$$VITS(.VARRAY,PATIEN,DHPICN,FRDAT,TODAT)
"RTN","SYNDHP01",89,0)
 ;
"RTN","SYNDHP01",90,0)
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
"RTN","SYNDHP01",91,0)
 ;
"RTN","SYNDHP01",92,0)
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
"RTN","SYNDHP01",93,0)
 . S RETSTA=""
"RTN","SYNDHP01",94,0)
 . D TOJASON^SYNDHPUTL(.VARRAY,.RETSTA)
"RTN","SYNDHP01",95,0)
 ;
"RTN","SYNDHP01",96,0)
 QUIT
"RTN","SYNDHP01",97,0)
 ;
"RTN","SYNDHP01",98,0)
VITS(PATVIT,PATIEN,DHPICN,FRDAT,TODAT) ; get vitals for a patient
"RTN","SYNDHP01",99,0)
 ; build the array of SNOMED CT codes that correspond to vitals
"RTN","SYNDHP01",100,0)
 ;
"RTN","SYNDHP01",101,0)
 N VITALS,VID,VTYPE,VOBS,VTIEN,VDATEFM,VDATE,SCT,SCTPT,VIT,ZARR
"RTN","SYNDHP01",102,0)
 N C S C=","
"RTN","SYNDHP01",103,0)
 N P S P="|"
"RTN","SYNDHP01",104,0)
 N S S S="_"
"RTN","SYNDHP01",105,0)
 N FN S FN=120.5
"RTN","SYNDHP01",106,0)
 ;
"RTN","SYNDHP01",107,0)
 ; scan vitals "C" index for IEN
"RTN","SYNDHP01",108,0)
 N VIEN S VIEN=""
"RTN","SYNDHP01",109,0)
 F  S VIEN=$O(^GMR(FN,"C",PATIEN,VIEN)) Q:VIEN=""  D
"RTN","SYNDHP01",110,0)
 . N VITALS
"RTN","SYNDHP01",111,0)
 . D GET1VITALS^SYNDHP16(.VITALS,VIEN,0)
"RTN","SYNDHP01",112,0)
 . I $D(VITALS("Vitals","ERROR")) M PATVIT("Vitals",VIEN)=VITALS QUIT
"RTN","SYNDHP01",113,0)
 . S VDATEFM=VITALS("Vitals","dateTimeVitalsTakenFM")
"RTN","SYNDHP01",114,0)
 . QUIT:((VDATEFM\1)<FRDAT)!((VDATEFM\1)>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP01",115,0)
 . S VID=VITALS("Vitals","resourceId")
"RTN","SYNDHP01",116,0)
 . S VTYPE=VITALS("Vitals","vitalType")
"RTN","SYNDHP01",117,0)
 . S VOBS=VITALS("Vitals","rate")
"RTN","SYNDHP01",118,0)
 . S VTIEN=VITALS("Vitals","vitalTypeId")
"RTN","SYNDHP01",119,0)
 . S VDATE=VITALS("Vitals","dateTimeVitalsTakenHL7")
"RTN","SYNDHP01",120,0)
 . S SCT=VITALS("Vitals","vitalTypeSCT")
"RTN","SYNDHP01",121,0)
 . S SCTPT=$$SENTENCE^XLFSTR(VITALS("Vitals","vitalType"))
"RTN","SYNDHP01",122,0)
 . S ZARR(DHPICN,SCT,VIEN)=SCTPT_P_VOBS_P_VDATE_P_VID
"RTN","SYNDHP01",123,0)
 . M PATVIT("Vitals",VIEN)=VITALS ;
"RTN","SYNDHP01",124,0)
 ;
"RTN","SYNDHP01",125,0)
 ; serialize data
"RTN","SYNDHP01",126,0)
 S (SCT,VIEN)=""
"RTN","SYNDHP01",127,0)
 N VITALRTN S VITALRTN=DHPICN
"RTN","SYNDHP01",128,0)
 F  S SCT=$O(ZARR(DHPICN,SCT)) Q:SCT=""  D
"RTN","SYNDHP01",129,0)
 . F  S VIEN=$O(ZARR(DHPICN,SCT,VIEN)) Q:VIEN=""  D
"RTN","SYNDHP01",130,0)
 . . S VIT=ZARR(DHPICN,SCT,VIEN)
"RTN","SYNDHP01",131,0)
 . . S VITALRTN=VITALRTN_U_SCT_P_VIT
"RTN","SYNDHP01",132,0)
 ;
"RTN","SYNDHP01",133,0)
 Q VITALRTN
"RTN","SYNDHP01",134,0)
 ;
"RTN","SYNDHP01",135,0)
 ; ----------- Unit Test -----------
"RTN","SYNDHP01",136,0)
T1 ;
"RTN","SYNDHP01",137,0)
 N ICN S ICN="2176287883V515136"
"RTN","SYNDHP01",138,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP01",139,0)
 N TODAT S TODAT=""
"RTN","SYNDHP01",140,0)
 N JSON S JSON=""
"RTN","SYNDHP01",141,0)
 N RETSTA
"RTN","SYNDHP01",142,0)
 D PATVITI(.RETSTA,ICN,FRDAT,TODAT,JSON)
"RTN","SYNDHP01",143,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP01",144,0)
 QUIT
"RTN","SYNDHP01",145,0)
 ;
"RTN","SYNDHP01",146,0)
T2 ;
"RTN","SYNDHP01",147,0)
 N ICN S ICN="2176287883V515136"
"RTN","SYNDHP01",148,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP01",149,0)
 N TODAT S TODAT=""
"RTN","SYNDHP01",150,0)
 N JSON S JSON="J"
"RTN","SYNDHP01",151,0)
 N RETSTA
"RTN","SYNDHP01",152,0)
 D PATVITI(.RETSTA,ICN,FRDAT,TODAT,JSON)
"RTN","SYNDHP01",153,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP01",154,0)
 QUIT
"RTN","SYNDHP01",155,0)
 ;
"RTN","SYNDHP02")
0^97^B18905167
"RTN","SYNDHP02",1,0)
SYNDHP02 ; HC/rbd/art - HealthConcourse - get patient immunization data ;05/04/2019
"RTN","SYNDHP02",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP02",3,0)
 ;;
"RTN","SYNDHP02",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP02",5,0)
 ;
"RTN","SYNDHP02",6,0)
 QUIT
"RTN","SYNDHP02",7,0)
 ;
"RTN","SYNDHP02",8,0)
 ; ---------------- Get patient immunizations information ------------------------------
"RTN","SYNDHP02",9,0)
 ;
"RTN","SYNDHP02",10,0)
PATIMMI(RETSTA,DHPICN,FRDAT,TODAT,RETJSON) ; Patient immunizations for ICN
"RTN","SYNDHP02",11,0)
 ;
"RTN","SYNDHP02",12,0)
 ; Return patient immunizations for a given patient ICN
"RTN","SYNDHP02",13,0)
 ;
"RTN","SYNDHP02",14,0)
 ; Input:
"RTN","SYNDHP02",15,0)
 ;   ICN     - unique patient identifier across all VistA systems
"RTN","SYNDHP02",16,0)
 ;   FRDAT   - from date (inclusive), optional, compared to Visit Date/Time
"RTN","SYNDHP02",17,0)
 ;   TODAT   - to date (inclusive), optional, compared to Visit Date/Time
"RTN","SYNDHP02",18,0)
 ;   RETJSON - J = Return JSON
"RTN","SYNDHP02",19,0)
 ;             F = Return FHIR
"RTN","SYNDHP02",20,0)
 ;             0 or null = Return string (default)
"RTN","SYNDHP02",21,0)
 ; Output:
"RTN","SYNDHP02",22,0)
 ;   RETSTA  - a delimited string that lists patient immunization information
"RTN","SYNDHP02",23,0)
 ;               Resource ID |Imm. Enc. Visit Dt | Imm. CVX Code | Imm. Description | Series Indicator ; Description |
"RTN","SYNDHP02",24,0)
 ;               Imm. Given Date  | Loc. of Enc. | Reaction Indicator ; Description | Imm. Provider
"RTN","SYNDHP02",25,0)
 ;          or patient immunizations in JSON format
"RTN","SYNDHP02",26,0)
 ;
"RTN","SYNDHP02",27,0)
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
"RTN","SYNDHP02",28,0)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
"RTN","SYNDHP02",29,0)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
"RTN","SYNDHP02",30,0)
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
"RTN","SYNDHP02",31,0)
 ;
"RTN","SYNDHP02",32,0)
 ; validate ICN
"RTN","SYNDHP02",33,0)
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
"RTN","SYNDHP02",34,0)
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" Q
"RTN","SYNDHP02",35,0)
 ; 
"RTN","SYNDHP02",36,0)
 ; get patient IEN from ICN
"RTN","SYNDHP02",37,0)
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP02",38,0)
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
"RTN","SYNDHP02",39,0)
 ;
"RTN","SYNDHP02",40,0)
 N IMMARR
"RTN","SYNDHP02",41,0)
 S RETSTA=$$IMMS(.IMMARR,PATIEN,DHPICN,FRDAT,TODAT)
"RTN","SYNDHP02",42,0)
 ;
"RTN","SYNDHP02",43,0)
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
"RTN","SYNDHP02",44,0)
 ;
"RTN","SYNDHP02",45,0)
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
"RTN","SYNDHP02",46,0)
 . S RETSTA=""
"RTN","SYNDHP02",47,0)
 . D TOJASON^SYNDHPUTL(.IMMARR,.RETSTA)
"RTN","SYNDHP02",48,0)
 ;
"RTN","SYNDHP02",49,0)
 Q
"RTN","SYNDHP02",50,0)
 ;
"RTN","SYNDHP02",51,0)
IMMS(IMMARR,PATIEN,DHPICN,FRDAT,TODAT) ; get immunizations for a patient
"RTN","SYNDHP02",52,0)
 ;
"RTN","SYNDHP02",53,0)
 N C,P,S,HLFCTS,VSTDT,PTIMMIEN,IMMREC
"RTN","SYNDHP02",54,0)
 N PTIMMID,IMMDESC,LOCENC,SERIES,IMMGIVEN,REACTID,REACTION,IMMPROV,ZARR
"RTN","SYNDHP02",55,0)
 N SERIESID,VIEN
"RTN","SYNDHP02",56,0)
 S C=",",P="|",S="_"
"RTN","SYNDHP02",57,0)
 N FNUM S FNUM=9000010.11      ;  file
"RTN","SYNDHP02",58,0)
 ; scan PXRMINDX 9000010.11 "CVX" "PI" index for Immunizations
"RTN","SYNDHP02",59,0)
 ; Example of such an entry - ^PXRMINDX(9000010.11,"CVX","PI",69,109,3000425.113046,64)=""
"RTN","SYNDHP02",60,0)
 ;S DHPICN=PATIEN
"RTN","SYNDHP02",61,0)
 N IMCVXCOD S IMCVXCOD=""
"RTN","SYNDHP02",62,0)
 F  S IMCVXCOD=$O(^PXRMINDX(FNUM,"CVX","PI",PATIEN,IMCVXCOD)) Q:IMCVXCOD=""  D
"RTN","SYNDHP02",63,0)
 .S VSTDT=""
"RTN","SYNDHP02",64,0)
 .F  S VSTDT=$O(^PXRMINDX(FNUM,"CVX","PI",PATIEN,IMCVXCOD,VSTDT)) Q:VSTDT=""  D
"RTN","SYNDHP02",65,0)
 ..QUIT:((VSTDT\1)<FRDAT)!((VSTDT\1)>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP02",66,0)
 ..S PTIMMIEN=""
"RTN","SYNDHP02",67,0)
 ..F  S PTIMMIEN=$O(^PXRMINDX(FNUM,"CVX","PI",PATIEN,IMCVXCOD,VSTDT,PTIMMIEN)) Q:PTIMMIEN=""  D
"RTN","SYNDHP02",68,0)
 ...N IMMUNIZE
"RTN","SYNDHP02",69,0)
 ...D GET1IMMUN^SYNDHP12(.IMMUNIZE,PTIMMIEN,0)
"RTN","SYNDHP02",70,0)
 ...I $D(IMMUNIZE("Immunize","ERROR")) M IMMARR("Immunizations",PTIMMIEN)=IMMUNIZE QUIT
"RTN","SYNDHP02",71,0)
 ...S PTIMMID=IMMUNIZE("Immunize","resourceId")
"RTN","SYNDHP02",72,0)
 ...S IMMDESC=IMMUNIZE("Immunize","immunization")
"RTN","SYNDHP02",73,0)
 ...S VIEN=IMMUNIZE("Immunize","visitId")
"RTN","SYNDHP02",74,0)
 ...S LOCENC=$$GET1^DIQ(9000010,VIEN,.06)
"RTN","SYNDHP02",75,0)
 ...S SERIES=IMMUNIZE("Immunize","series")
"RTN","SYNDHP02",76,0)
 ...S SERIESID=IMMUNIZE("Immunize","seriesCd")
"RTN","SYNDHP02",77,0)
 ...S IMMGIVEN=IMMUNIZE("Immunize","eventDateAndTimeHL7")
"RTN","SYNDHP02",78,0)
 ...S REACTID=IMMUNIZE("Immunize","reactionCd")
"RTN","SYNDHP02",79,0)
 ...S REACTION=IMMUNIZE("Immunize","reaction")
"RTN","SYNDHP02",80,0)
 ...S IMMPROV=IMMUNIZE("Immunize","encounterProvider")
"RTN","SYNDHP02",81,0)
 ...S IMMREC=PTIMMID_P_$$FMTHL7^XLFDT(VSTDT)_P_IMCVXCOD_P_IMMDESC_P_SERIESID_";"_SERIES_P_IMMGIVEN_P_LOCENC
"RTN","SYNDHP02",82,0)
 ...S IMMREC=IMMREC_P_REACTID_";"_REACTION_P_IMMPROV
"RTN","SYNDHP02",83,0)
 ...S ZARR(DHPICN,VSTDT,IMCVXCOD)=IMMREC
"RTN","SYNDHP02",84,0)
 ...M IMMARR("Immunizations",PTIMMIEN)=IMMUNIZE ;
"RTN","SYNDHP02",85,0)
 ;
"RTN","SYNDHP02",86,0)
 ; serialize data
"RTN","SYNDHP02",87,0)
 S VSTDT=""
"RTN","SYNDHP02",88,0)
 S HLFCTS=DHPICN
"RTN","SYNDHP02",89,0)
 F  S VSTDT=$O(ZARR(DHPICN,VSTDT)) Q:VSTDT=""  D
"RTN","SYNDHP02",90,0)
 .S IMCVXCOD="" F  S IMCVXCOD=$O(ZARR(DHPICN,VSTDT,IMCVXCOD)) Q:IMCVXCOD=""  D
"RTN","SYNDHP02",91,0)
 ..S IMMREC=ZARR(DHPICN,VSTDT,IMCVXCOD)
"RTN","SYNDHP02",92,0)
 ..S HLFCTS=HLFCTS_U_IMMREC
"RTN","SYNDHP02",93,0)
 ;
"RTN","SYNDHP02",94,0)
 Q HLFCTS
"RTN","SYNDHP02",95,0)
 ; for a given pt, returns Unique ID |Imm. Enc. Visit Dt | Imm. CVX Code | Imm. Description | Series Indicator ; Description |
"RTN","SYNDHP02",96,0)
 ;                            Imm. Given Date  | Loc. of Enc. | Reaction Indicator ; Description | Imm. Provider
"RTN","SYNDHP02",97,0)
 ; 
"RTN","SYNDHP02",98,0)
 ;  Series can be:   'P' FOR PARTIALLY COMPLETE 
"RTN","SYNDHP02",99,0)
 ;                   'C' FOR COMPLETE 
"RTN","SYNDHP02",100,0)
 ;                   'B' FOR BOOSTER 
"RTN","SYNDHP02",101,0)
 ;                   '1' FOR SERIES 1 
"RTN","SYNDHP02",102,0)
 ;                   '2' FOR SERIES 2 
"RTN","SYNDHP02",103,0)
 ;                   '3' FOR SERIES 3 
"RTN","SYNDHP02",104,0)
 ;                   '4' FOR SERIES 4 
"RTN","SYNDHP02",105,0)
 ;                   '5' FOR SERIES 5 
"RTN","SYNDHP02",106,0)
 ;                   '6' FOR SERIES 6 
"RTN","SYNDHP02",107,0)
 ;                   '7' FOR SERIES 7 
"RTN","SYNDHP02",108,0)
 ;                   '8' FOR SERIES 8
"RTN","SYNDHP02",109,0)
 ;
"RTN","SYNDHP02",110,0)
 ;  Reactions can be:  '1' FOR FEVER
"RTN","SYNDHP02",111,0)
 ;                     '2' FOR IRRITABILITY; 
"RTN","SYNDHP02",112,0)
 ;                     '3' FOR LOCAL REACTION OR SWELLING; 
"RTN","SYNDHP02",113,0)
 ;                     '4' FOR VOMITING; 
"RTN","SYNDHP02",114,0)
 ;                     '5' FOR RASH OR ITCHING; 
"RTN","SYNDHP02",115,0)
 ;                     '6' FOR LETHARGY; 
"RTN","SYNDHP02",116,0)
 ;                     '7' FOR CONVULSIONS; 
"RTN","SYNDHP02",117,0)
 ;                     '8' FOR ARTHRITIS OR ARTHRALGIAS; 
"RTN","SYNDHP02",118,0)
 ;                     '9' FOR ANAPHYLAXIS OR COLLAPSE; 
"RTN","SYNDHP02",119,0)
 ;                     '10' FOR RESPIRATORY DISTRESS; 
"RTN","SYNDHP02",120,0)
 ;                     '11' FOR OTHER; 
"RTN","SYNDHP02",121,0)
 ;                     '0' FOR NONE;
"RTN","SYNDHP02",122,0)
 ;
"RTN","SYNDHP02",123,0)
 ; ----------- Unit Test -----------
"RTN","SYNDHP02",124,0)
T1 ;
"RTN","SYNDHP02",125,0)
 N ICN S ICN="10110V004877"
"RTN","SYNDHP02",126,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP02",127,0)
 N TODAT S TODAT=""
"RTN","SYNDHP02",128,0)
 N JSON S JSON=""
"RTN","SYNDHP02",129,0)
 N RETSTA
"RTN","SYNDHP02",130,0)
 D PATIMMI(.RETSTA,ICN,FRDAT,TODAT,JSON)
"RTN","SYNDHP02",131,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP02",132,0)
 QUIT
"RTN","SYNDHP02",133,0)
 ;
"RTN","SYNDHP02",134,0)
T2 ;
"RTN","SYNDHP02",135,0)
 N ICN S ICN="10110V004877"
"RTN","SYNDHP02",136,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP02",137,0)
 N TODAT S TODAT=""
"RTN","SYNDHP02",138,0)
 N JSON S JSON="J"
"RTN","SYNDHP02",139,0)
 N RETSTA
"RTN","SYNDHP02",140,0)
 D PATIMMI(.RETSTA,ICN,FRDAT,TODAT,JSON)
"RTN","SYNDHP02",141,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP02",142,0)
 QUIT
"RTN","SYNDHP02",143,0)
 ;
"RTN","SYNDHP03")
0^102^B23655386
"RTN","SYNDHP03",1,0)
SYNDHP03 ; HC/rbd/art - HealthConcourse - get patient condition/problem data ;05/04/2019
"RTN","SYNDHP03",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP03",3,0)
 ;;
"RTN","SYNDHP03",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP03",5,0)
 ;
"RTN","SYNDHP03",6,0)
 QUIT
"RTN","SYNDHP03",7,0)
 ;
"RTN","SYNDHP03",8,0)
 ;----------------  Get Patient Conditions  ---------------------- 
"RTN","SYNDHP03",9,0)
 ;
"RTN","SYNDHP03",10,0)
PATCONDS(RETSTA,NAME,SSN,DOB,GENDER) ; get condition SCT codes for a patient by traits
"RTN","SYNDHP03",11,0)
 S RETSTA="-1^This service has been retired"
"RTN","SYNDHP03",12,0)
 QUIT
"RTN","SYNDHP03",13,0)
 ; Return list of active conditions (problems) for name, SSN, DOB, and gender
"RTN","SYNDHP03",14,0)
 ;   conditions without a SNOMED CT code are not be reported
"RTN","SYNDHP03",15,0)
 ;
"RTN","SYNDHP03",16,0)
 ; Input:
"RTN","SYNDHP03",17,0)
 ;   NAME    - patient name
"RTN","SYNDHP03",18,0)
 ;   SSN     - social security number
"RTN","SYNDHP03",19,0)
 ;   DOB     - date of birth
"RTN","SYNDHP03",20,0)
 ;   GENDER  - gender
"RTN","SYNDHP03",21,0)
 ; Output:
"RTN","SYNDHP03",22,0)
 ;   RETSTA  - a delimited string that lists SNOMED CDT codes for the patient conditions
"RTN","SYNDHP03",23,0)
 ;           - ICN^SCT code1^SCT code2^...^SCT coden
"RTN","SYNDHP03",24,0)
 ;
"RTN","SYNDHP03",25,0)
 N C,ACU,ICNST,DHPICN,PATIEN,SCT
"RTN","SYNDHP03",26,0)
 S C=","
"RTN","SYNDHP03",27,0)
 N SCTA
"RTN","SYNDHP03",28,0)
 ;
"RTN","SYNDHP03",29,0)
 D PATVAL^SYNDHP43(.ICNST,NAME,SSN,DOB,GENDER)
"RTN","SYNDHP03",30,0)
 I +ICNST'=1 S RETSTA=ICNST Q
"RTN","SYNDHP03",31,0)
 ; if we are here we are dealing with a valid patient
"RTN","SYNDHP03",32,0)
 S DHPICN=$P(ICNST,U,3)
"RTN","SYNDHP03",33,0)
 ; get patient IEN from ICN
"RTN","SYNDHP03",34,0)
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP03",35,0)
 ;
"RTN","SYNDHP03",36,0)
 S (ACU,SCT)=""
"RTN","SYNDHP03",37,0)
 F  S ACU=$O(^PXRMINDX(9000011,"SCT","PSPI",PATIEN,"A",ACU)) Q:ACU=""  D
"RTN","SYNDHP03",38,0)
 .F  S SCT=$O(^PXRMINDX(9000011,"SCT","PSPI",PATIEN,"A",ACU,SCT)) Q:SCT=""  D
"RTN","SYNDHP03",39,0)
 ..S SCTA(SCT)=""
"RTN","SYNDHP03",40,0)
 S RETSTA=DHPICN
"RTN","SYNDHP03",41,0)
 S SCT=""
"RTN","SYNDHP03",42,0)
 F  S SCT=$O(SCTA(SCT)) Q:SCT=""  S RETSTA=RETSTA_U_SCT
"RTN","SYNDHP03",43,0)
 Q
"RTN","SYNDHP03",44,0)
 ;
"RTN","SYNDHP03",45,0)
 ;
"RTN","SYNDHP03",46,0)
PATCONI(RETSTA,DHPICN,FRDAT,TODAT) ; Patient conditions for ICN
"RTN","SYNDHP03",47,0)
 ;
"RTN","SYNDHP03",48,0)
 ; Return patient conditions (problems) for a given patient ICN
"RTN","SYNDHP03",49,0)
 ;
"RTN","SYNDHP03",50,0)
 ; Input:
"RTN","SYNDHP03",51,0)
 ;   ICN     - unique patient identifier across all VistA systems
"RTN","SYNDHP03",52,0)
 ;   FRDATE  - from date (inclusive), optional, compared to .13 DATE OF ONSET
"RTN","SYNDHP03",53,0)
 ;   TODATE  - to date (inclusive), optional, compared to .13 DATE OF ONSET
"RTN","SYNDHP03",54,0)
 ; Output:
"RTN","SYNDHP03",55,0)
 ;   RETSTA  - a delimited string that lists the following information
"RTN","SYNDHP03",56,0)
 ;      PatientICN ^ resourceId ^ DiagnosisCode ; DiagnosisName ^ DateOfOnset ^ SNOMED CT Code ; SNOMED CT Name |
"RTN","SYNDHP03",57,0)
 ;      and continue this for every diagnosis for a particular patient ICN
"RTN","SYNDHP03",58,0)
 ;
"RTN","SYNDHP03",59,0)
 ;  Identifier will be "V_"_SITE ID_"_"_FILE #_"_"_FILE IEN   i.e. V_500_9000011_930
"RTN","SYNDHP03",60,0)
 ;
"RTN","SYNDHP03",61,0)
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
"RTN","SYNDHP03",62,0)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
"RTN","SYNDHP03",63,0)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
"RTN","SYNDHP03",64,0)
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
"RTN","SYNDHP03",65,0)
 ;
"RTN","SYNDHP03",66,0)
 ; validate ICN
"RTN","SYNDHP03",67,0)
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
"RTN","SYNDHP03",68,0)
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" QUIT
"RTN","SYNDHP03",69,0)
 ;
"RTN","SYNDHP03",70,0)
 N C,ACU,P,S,ONSET,DONSET,DIEN,RETDESC,SITE,SCTA
"RTN","SYNDHP03",71,0)
 N PATIEN
"RTN","SYNDHP03",72,0)
 S C=",",P="|",S=";"
"RTN","SYNDHP03",73,0)
 ;
"RTN","SYNDHP03",74,0)
 ; get patient IEN from ICN
"RTN","SYNDHP03",75,0)
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP03",76,0)
 I $G(DEBUG) W "PATIEN: ",PATIEN,!
"RTN","SYNDHP03",77,0)
 S RETSTA=DHPICN
"RTN","SYNDHP03",78,0)
 S RETDESC=""
"RTN","SYNDHP03",79,0)
 S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP03",80,0)
 ;
"RTN","SYNDHP03",81,0)
 S DIEN=""
"RTN","SYNDHP03",82,0)
 F  S DIEN=$O(^AUPNPROB("AC",PATIEN,DIEN)) Q:DIEN=""  D
"RTN","SYNDHP03",83,0)
 . N PROBX,PROBE
"RTN","SYNDHP03",84,0)
 . D GETS^DIQ(9000011,DIEN_",",".01;.02;.13;80001","EIN","PROBX","PROBE")
"RTN","SYNDHP03",85,0)
 . QUIT:$D(PROBE)
"RTN","SYNDHP03",86,0)
 . N DIAGC,DIAGN,ONSET,DONSET,SNOMEDC,SNOMEDN,IDENT
"RTN","SYNDHP03",87,0)
 . I $D(PROBX(9000011,DIEN_",",.01,"E")) D
"RTN","SYNDHP03",88,0)
 . . S DIAGC=PROBX(9000011,DIEN_",",.01,"E")
"RTN","SYNDHP03",89,0)
 . . S DIAGN=$G(^ICD9(PROBX(9000011,DIEN_",",.01,"I"),68,1,1))
"RTN","SYNDHP03",90,0)
 . S DONSET=""
"RTN","SYNDHP03",91,0)
 . S ONSET=""
"RTN","SYNDHP03",92,0)
 . I $D(PROBX(9000011,DIEN_",",.13,"I")) D
"RTN","SYNDHP03",93,0)
 . . S ONSET=PROBX(9000011,DIEN_",",.13,"I")
"RTN","SYNDHP03",94,0)
 . . ; if no month or day of month is set, default to 01
"RTN","SYNDHP03",95,0)
 . . S:$E(ONSET,4,5)="00" $E(ONSET,4,5)="01"
"RTN","SYNDHP03",96,0)
 . . S:$E(ONSET,6,7)="00" $E(ONSET,6,7)="01"
"RTN","SYNDHP03",97,0)
 . . S DONSET=$$FMTHL7^XLFDT(ONSET)  ;date of onset set to HL7 format
"RTN","SYNDHP03",98,0)
 . QUIT:DONSET'=""&(((ONSET\1)<FRDAT)!((ONSET\1)>TODAT))  ;quit if outside of requested date range
"RTN","SYNDHP03",99,0)
 . I $D(PROBX(9000011,DIEN_",",80001,"E")) D
"RTN","SYNDHP03",100,0)
 . . S SNOMEDC=PROBX(9000011,DIEN_",",80001,"E")
"RTN","SYNDHP03",101,0)
 . . S SNOMEDN=$$USCTPT^SYNDHPUTL(SNOMEDC)
"RTN","SYNDHP03",102,0)
 . S IDENT=$$RESID^SYNDHP69("V",SITE)_"_9000011_"_DIEN
"RTN","SYNDHP03",103,0)
 . S RETDESC=RETDESC_IDENT_U_$G(DIAGC)_S_$G(DIAGN)_U_$G(DONSET)_U_$G(SNOMEDC)_S_$G(SNOMEDN)_P
"RTN","SYNDHP03",104,0)
 S RETSTA=RETSTA_U_RETDESC
"RTN","SYNDHP03",105,0)
 ;
"RTN","SYNDHP03",106,0)
 QUIT
"RTN","SYNDHP03",107,0)
 ;
"RTN","SYNDHP03",108,0)
 ;  ----------------  Patients for a given active condition  -------------- 
"RTN","SYNDHP03",109,0)
 ;
"RTN","SYNDHP03",110,0)
PATCONAL(RETSTA,DHPSCT) ; Patients for a given active condition
"RTN","SYNDHP03",111,0)
 ;
"RTN","SYNDHP03",112,0)
 ; Return list of all patients who have a particular active condition (problem)
"RTN","SYNDHP03",113,0)
 ;
"RTN","SYNDHP03",114,0)
 ; Input:
"RTN","SYNDHP03",115,0)
 ;   DHPSCT - SNOMED CT code  (mandatory)
"RTN","SYNDHP03",116,0)
 ; Output:
"RTN","SYNDHP03",117,0)
 ;   RETSTA  - a delimited string that lists SNOMED CDT codes for active  patient conditions
"RTN","SYNDHP03",118,0)
 ;           - SCT^ICN 1|patient name 1^ICN 2|patient name 2^...^ICN n|patient name n 
"RTN","SYNDHP03",119,0)
 ;           - -1 - error
"RTN","SYNDHP03",120,0)
 ; 
"RTN","SYNDHP03",121,0)
 ; validate SNOMED CT code
"RTN","SYNDHP03",122,0)
 I $G(DHPSCT)="" S RETSTA="-1^What code?" QUIT
"RTN","SYNDHP03",123,0)
 I +$$CODE^LEXTRAN(DHPSCT,"SCT")'=1 S RETSTA="-1^SNOMED CT code not recognised" Q
"RTN","SYNDHP03",124,0)
 ;
"RTN","SYNDHP03",125,0)
 N C,ACU,P,PATA,PATIEN,PAT
"RTN","SYNDHP03",126,0)
 S C=",",P="|"
"RTN","SYNDHP03",127,0)
 S (ACU,PATIEN)=""
"RTN","SYNDHP03",128,0)
 F  S ACU=$O(^PXRMINDX(9000011,"SCT","ISPP",DHPSCT,"A",ACU)) Q:ACU=""  D
"RTN","SYNDHP03",129,0)
 .F  S PATIEN=$O(^PXRMINDX(9000011,"SCT","ISPP",DHPSCT,"A",ACU,PATIEN)) Q:PATIEN=""  D
"RTN","SYNDHP03",130,0)
 ..S PATA($$UICN^SYNDHPUTL(PATIEN))=$$GET1^DIQ(2,PATIEN_C,.01)
"RTN","SYNDHP03",131,0)
 S RETSTA=DHPSCT
"RTN","SYNDHP03",132,0)
 S PAT=""
"RTN","SYNDHP03",133,0)
 F  S PAT=$O(PATA(PAT)) Q:PAT=""  S RETSTA=RETSTA_U_PAT_P_PATA(PAT)
"RTN","SYNDHP03",134,0)
 Q
"RTN","SYNDHP03",135,0)
 ;
"RTN","SYNDHP03",136,0)
 ; ----------- Unit Test -----------
"RTN","SYNDHP03",137,0)
T1 ;
"RTN","SYNDHP03",138,0)
 N ICN S ICN="10111V183702"
"RTN","SYNDHP03",139,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP03",140,0)
 N TODAT S TODAT=""
"RTN","SYNDHP03",141,0)
 N RETSTA
"RTN","SYNDHP03",142,0)
 D PATCONI(.RETSTA,ICN,FRDAT,TODAT)
"RTN","SYNDHP03",143,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP03",144,0)
 QUIT
"RTN","SYNDHP03",145,0)
 ;
"RTN","SYNDHP03",146,0)
T2 ;
"RTN","SYNDHP03",147,0)
 N SNOMED S SNOMED=47505003
"RTN","SYNDHP03",148,0)
 N RETSTA
"RTN","SYNDHP03",149,0)
 D PATCONAL(.RETSTA,SNOMED)
"RTN","SYNDHP03",150,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP03",151,0)
 QUIT
"RTN","SYNDHP03",152,0)
 ;
"RTN","SYNDHP03",153,0)
T3 ;
"RTN","SYNDHP03",154,0)
 N SNOMED S SNOMED=10509002
"RTN","SYNDHP03",155,0)
 N RETSTA
"RTN","SYNDHP03",156,0)
 D PATCONAL(.RETSTA,SNOMED)
"RTN","SYNDHP03",157,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP03",158,0)
 QUIT
"RTN","SYNDHP03",159,0)
 ;
"RTN","SYNDHP04")
0^103^B11868381
"RTN","SYNDHP04",1,0)
SYNDHP04 ; HC/fjf/art - HealthConcourse - retrieve patient procedures ;05/04/2019
"RTN","SYNDHP04",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP04",3,0)
 ;;
"RTN","SYNDHP04",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP04",5,0)
 ;
"RTN","SYNDHP04",6,0)
 QUIT
"RTN","SYNDHP04",7,0)
 ;
"RTN","SYNDHP04",8,0)
 ; ---------------- Get patient procedures ----------------------
"RTN","SYNDHP04",9,0)
 ;
"RTN","SYNDHP04",10,0)
PATPRC(RETSTA,NAME,SSN,DOB,GENDER,FRDAT,TODAT) ; get procedures for a patient by traits
"RTN","SYNDHP04",11,0)
 S RETSTA="-1^This service has been retired"
"RTN","SYNDHP04",12,0)
 QUIT
"RTN","SYNDHP04",13,0)
 ; Return patient procedures for name, SSN, DOB, and gender
"RTN","SYNDHP04",14,0)
 ;
"RTN","SYNDHP04",15,0)
 ; Input:
"RTN","SYNDHP04",16,0)
 ;   NAME    - patient name
"RTN","SYNDHP04",17,0)
 ;   SSN     - social security number
"RTN","SYNDHP04",18,0)
 ;   DOB     - date of birth
"RTN","SYNDHP04",19,0)
 ;   GENDER  - gender
"RTN","SYNDHP04",20,0)
 ;   FRDATE  - from date (inclusive), optional
"RTN","SYNDHP04",21,0)
 ;   TODATE  - to date (inclusive), optional
"RTN","SYNDHP04",22,0)
 ; Output:
"RTN","SYNDHP04",23,0)
 ;   RETSTA  - a delimited string that lists SNOMED CT codes for the patient procedures
"RTN","SYNDHP04",24,0)
 ;           - ICN^SCT code|description|CPT code|date|identifier^...
"RTN","SYNDHP04",25,0)
 ;
"RTN","SYNDHP04",26,0)
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
"RTN","SYNDHP04",27,0)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
"RTN","SYNDHP04",28,0)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
"RTN","SYNDHP04",29,0)
 ;
"RTN","SYNDHP04",30,0)
 N C,P,S,ZARR,ICNST,DHPICN,PATIEN
"RTN","SYNDHP04",31,0)
 ;
"RTN","SYNDHP04",32,0)
 S C=",",P="|",S="_"
"RTN","SYNDHP04",33,0)
 N USER S USER=$$DUZ^SYNDHP69
"RTN","SYNDHP04",34,0)
 D PATVAL^SYNDHP43(.ICNST,NAME,SSN,DOB,GENDER)
"RTN","SYNDHP04",35,0)
 I +ICNST'=1 S RETSTA=ICNST QUIT
"RTN","SYNDHP04",36,0)
 ; if we are here we are dealing with a valid patient
"RTN","SYNDHP04",37,0)
 S DHPICN=$P(ICNST,U,3)
"RTN","SYNDHP04",38,0)
 ; get patient IEN from ICN
"RTN","SYNDHP04",39,0)
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP04",40,0)
 I PATIEN="" S RETSTA="-1^Patient ICN not found" QUIT
"RTN","SYNDHP04",41,0)
 ;
"RTN","SYNDHP04",42,0)
 S RETSTA=DHPICN
"RTN","SYNDHP04",43,0)
 ;
"RTN","SYNDHP04",44,0)
 ;Surgical Procedures
"RTN","SYNDHP04",45,0)
 S RETSTA=RETSTA_$$SRPRCS^SYNDHP55(PATIEN,FRDAT,TODAT)
"RTN","SYNDHP04",46,0)
 ;
"RTN","SYNDHP04",47,0)
 ;Visit Procedures
"RTN","SYNDHP04",48,0)
 S RETSTA=RETSTA_$$VSTPRCS^SYNDHP55(PATIEN,FRDAT,TODAT)
"RTN","SYNDHP04",49,0)
 ;
"RTN","SYNDHP04",50,0)
 ;Radiology Procedures
"RTN","SYNDHP04",51,0)
 S RETSTA=RETSTA_$$RADPRCS^SYNDHP55(PATIEN,FRDAT,TODAT)
"RTN","SYNDHP04",52,0)
 ;
"RTN","SYNDHP04",53,0)
 QUIT
"RTN","SYNDHP04",54,0)
 ;
"RTN","SYNDHP04",55,0)
 ; ---------------- Get patient procedures ----------------------
"RTN","SYNDHP04",56,0)
 ;
"RTN","SYNDHP04",57,0)
PATPRCI(RETSTA,DHPICN,FRDAT,TODAT) ; Patient procedures for ICN
"RTN","SYNDHP04",58,0)
 ;
"RTN","SYNDHP04",59,0)
 ; Return patient procedures for a given patient ICN
"RTN","SYNDHP04",60,0)
 ;  currently returns:
"RTN","SYNDHP04",61,0)
 ;    -Surgical
"RTN","SYNDHP04",62,0)
 ;    -Visit (V CPT)
"RTN","SYNDHP04",63,0)
 ;    -Radiology
"RTN","SYNDHP04",64,0)
 ;
"RTN","SYNDHP04",65,0)
 ; Input:
"RTN","SYNDHP04",66,0)
 ;   DHPICN  - unique patient identifier across all VistA systems
"RTN","SYNDHP04",67,0)
 ;   FRDATE  - from date (inclusive), optional
"RTN","SYNDHP04",68,0)
 ;   TODATE  - to date (inclusive), optional
"RTN","SYNDHP04",69,0)
 ; Output:
"RTN","SYNDHP04",70,0)
 ;   RETSTA  - a delimited string that lists SNOMED CT codes for the patient procedures
"RTN","SYNDHP04",71,0)
 ;           - ICN^SCT code|description|CPT code|date|identifier^...
"RTN","SYNDHP04",72,0)
 ;
"RTN","SYNDHP04",73,0)
 ; bypass for CQM
"RTN","SYNDHP04",74,0)
 ; 
"RTN","SYNDHP04",75,0)
 ; ***********
"RTN","SYNDHP04",76,0)
 ; *********** Important Note for open source community
"RTN","SYNDHP04",77,0)
 ; ***********
"RTN","SYNDHP04",78,0)
 ; *********** Perspecta - who developed this source code and have released it to the open source
"RTN","SYNDHP04",79,0)
 ; *********** need the following six lines to remain intact
"RTN","SYNDHP04",80,0)
 ; 
"RTN","SYNDHP04",81,0)
 I DHPICN="1899632336V236254" D  QUIT
"RTN","SYNDHP04",82,0)
 .S RETSTA="1899632336V236254^71388002|Mammogram|77056|20170101|442_130_101"
"RTN","SYNDHP04",83,0)
 ;I DHPICN="2495309561V670720" D  QUIT
"RTN","SYNDHP04",84,0)
 ;.S RETSTA="2495309561V670720^24165007|Alcohol Counseling and Treatment||20170101|442_130_101"
"RTN","SYNDHP04",85,0)
 ;
"RTN","SYNDHP04",86,0)
 ; *********** the above lines will be redacted by Perspecta at some suitable juncture to 
"RTN","SYNDHP04",87,0)
 ; *********** be determined by Perspecta
"RTN","SYNDHP04",88,0)
 ; ***********
"RTN","SYNDHP04",89,0)
 ; *********** End of Important Note for open source community
"RTN","SYNDHP04",90,0)
 ;
"RTN","SYNDHP04",91,0)
 ; validate ICN
"RTN","SYNDHP04",92,0)
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
"RTN","SYNDHP04",93,0)
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" QUIT
"RTN","SYNDHP04",94,0)
 ; 
"RTN","SYNDHP04",95,0)
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
"RTN","SYNDHP04",96,0)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
"RTN","SYNDHP04",97,0)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
"RTN","SYNDHP04",98,0)
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
"RTN","SYNDHP04",99,0)
 ;
"RTN","SYNDHP04",100,0)
 N C,P,S,PATIEN
"RTN","SYNDHP04",101,0)
 S C=",",P="|",S="_"
"RTN","SYNDHP04",102,0)
 N USER S USER=$$DUZ^SYNDHP69
"RTN","SYNDHP04",103,0)
 ; get patient IEN from ICN
"RTN","SYNDHP04",104,0)
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP04",105,0)
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
"RTN","SYNDHP04",106,0)
 ;
"RTN","SYNDHP04",107,0)
 S RETSTA=DHPICN
"RTN","SYNDHP04",108,0)
 ;
"RTN","SYNDHP04",109,0)
 ;Surgical Procedures
"RTN","SYNDHP04",110,0)
 S RETSTA=RETSTA_$$SRPRCS^SYNDHP55(PATIEN,FRDAT,TODAT)
"RTN","SYNDHP04",111,0)
 ;
"RTN","SYNDHP04",112,0)
 ;Visit Procedures
"RTN","SYNDHP04",113,0)
 S RETSTA=RETSTA_$$VSTPRCS^SYNDHP55(PATIEN,FRDAT,TODAT)
"RTN","SYNDHP04",114,0)
 ;
"RTN","SYNDHP04",115,0)
 ;Radiology Procedures
"RTN","SYNDHP04",116,0)
 S RETSTA=RETSTA_$$RADPRCS^SYNDHP55(PATIEN,FRDAT,TODAT)
"RTN","SYNDHP04",117,0)
 ;
"RTN","SYNDHP04",118,0)
 QUIT
"RTN","SYNDHP04",119,0)
 ;
"RTN","SYNDHP04",120,0)
 ; ----------- Unit Test -----------
"RTN","SYNDHP04",121,0)
T1 ;
"RTN","SYNDHP04",122,0)
 N ICN S ICN="5000000107V310212"
"RTN","SYNDHP04",123,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP04",124,0)
 N TODAT S TODAT=""
"RTN","SYNDHP04",125,0)
 N RETSTA
"RTN","SYNDHP04",126,0)
 D PATPRCI(.RETSTA,ICN,FRDAT,TODAT)
"RTN","SYNDHP04",127,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP04",128,0)
 QUIT
"RTN","SYNDHP04",129,0)
 ;
"RTN","SYNDHP05")
0^104^B117668361
"RTN","SYNDHP05",1,0)
SYNDHP05 ; HC/fjf/art - HealthConcourse - retrieve patient diagnostic reports ;05/08/2019
"RTN","SYNDHP05",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP05",3,0)
 ;;
"RTN","SYNDHP05",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP05",5,0)
 ;
"RTN","SYNDHP05",6,0)
 QUIT
"RTN","SYNDHP05",7,0)
 ;
"RTN","SYNDHP05",8,0)
 ; ---------------- Patient diagnostic reports ----------------------
"RTN","SYNDHP05",9,0)
 ;
"RTN","SYNDHP05",10,0)
PATDXRI(RETSTA,DHPICN,FRDAT,TODAT,RETJSON) ; Patient diagnostic report for ICN
"RTN","SYNDHP05",11,0)
 ;
"RTN","SYNDHP05",12,0)
 ; Return patient diagnostic report for a given patient ICN
"RTN","SYNDHP05",13,0)
 ;
"RTN","SYNDHP05",14,0)
 ; Input:
"RTN","SYNDHP05",15,0)
 ;   ICN     - unique patient identifier across all VistA systems
"RTN","SYNDHP05",16,0)
 ;   FRDAT   - from date (inclusive), optional
"RTN","SYNDHP05",17,0)
 ;   TODAT   - to date (inclusive), optional
"RTN","SYNDHP05",18,0)
 ;   RETJSON - J = Return JSON
"RTN","SYNDHP05",19,0)
 ;             F = Return FHIR
"RTN","SYNDHP05",20,0)
 ;             0 or null = Return diagnostic report string (default)
"RTN","SYNDHP05",21,0)
 ; Output:
"RTN","SYNDHP05",22,0)
 ;   RETSTA  - ICN^"IMG"|status|dateTime|provider|identifier|CPT|SCT|desc|primary dx|dx SCT|conclusion^...
"RTN","SYNDHP05",23,0)
 ;                ^"MHDX"|status|dateTime|provider|identifier|diag code|SCT|decription^...
"RTN","SYNDHP05",24,0)
 ;                ^"VISIT"|status|dateTime|provider|identifier|ICD|SCT|diag desc^...
"RTN","SYNDHP05",25,0)
 ;          or patient diagnostic report data in JSON format
"RTN","SYNDHP05",26,0)
 ;
"RTN","SYNDHP05",27,0)
 ; bypass for CQM
"RTN","SYNDHP05",28,0)
 ; 
"RTN","SYNDHP05",29,0)
 ; ***********
"RTN","SYNDHP05",30,0)
 ; *********** Important Note for open source community
"RTN","SYNDHP05",31,0)
 ; ***********
"RTN","SYNDHP05",32,0)
 ; *********** Perspecta - who developed this source code and have released it to the open source
"RTN","SYNDHP05",33,0)
 ; *********** need the following six lines to remain intact
"RTN","SYNDHP05",34,0)
 ; 
"RTN","SYNDHP05",35,0)
 I DHPICN="2608649748V030771" D  QUIT
"RTN","SYNDHP05",36,0)
 . S RETSTA="2608649748V030771^IMG|final|20170101|PROVIDER,ONE|V_500_74_608|44388||Colon Endoscopy||| there are no previous colonoscopy."
"RTN","SYNDHP05",37,0)
 . S RETSTA=RETSTA_" Impression: There is no definite colonoscopic evidence of malignancy.2. Comparison to previous colonoscopy would be helpful to assure stability."
"RTN","SYNDHP05",38,0)
 ;
"RTN","SYNDHP05",39,0)
 I DHPICN="2627244030V292232" D  QUIT
"RTN","SYNDHP05",40,0)
 . S RETSTA="2627244030V292232^IMG|final|20170101|PROVIDER,ONE|V_500_74_608|88147||Cytopath C/V Automated||| there are no previous cervical cancer screening report."
"RTN","SYNDHP05",41,0)
 . S RETSTA=RETSTA_" Impression: There is no definite CCS evidence of malignancy.2. Comparison to previous CCS would be helpful to assure stability."
"RTN","SYNDHP05",42,0)
 ;
"RTN","SYNDHP05",43,0)
 I DHPICN="1686299845V246594" D  QUIT
"RTN","SYNDHP05",44,0)
 . S RETSTA="1686299845V246594^MHDX|final|20170101|PROVIDER,ONE|V_500_74_608|F32.0|70747007|Major depressive disorder, single episode, mild"
"RTN","SYNDHP05",45,0)
 ;
"RTN","SYNDHP05",46,0)
 ; *********** the above lines will be redacted by Perspecta at some suitable juncture to 
"RTN","SYNDHP05",47,0)
 ; *********** be determined by Perspecta
"RTN","SYNDHP05",48,0)
 ; ***********
"RTN","SYNDHP05",49,0)
 ; *********** End of Important Note for open source community
"RTN","SYNDHP05",50,0)
 ;
"RTN","SYNDHP05",51,0)
 ; validate ICN
"RTN","SYNDHP05",52,0)
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
"RTN","SYNDHP05",53,0)
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" QUIT
"RTN","SYNDHP05",54,0)
 ; 
"RTN","SYNDHP05",55,0)
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
"RTN","SYNDHP05",56,0)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
"RTN","SYNDHP05",57,0)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
"RTN","SYNDHP05",58,0)
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
"RTN","SYNDHP05",59,0)
 ;
"RTN","SYNDHP05",60,0)
 N C,P,PATIEN
"RTN","SYNDHP05",61,0)
 ;
"RTN","SYNDHP05",62,0)
 N USER S USER=$$DUZ^SYNDHP69
"RTN","SYNDHP05",63,0)
 S C=",",P="|"
"RTN","SYNDHP05",64,0)
 ; get patient IEN from ICN
"RTN","SYNDHP05",65,0)
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP05",66,0)
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
"RTN","SYNDHP05",67,0)
 ;
"RTN","SYNDHP05",68,0)
 S RETSTA=DHPICN
"RTN","SYNDHP05",69,0)
 ;
"RTN","SYNDHP05",70,0)
 N DXRPTS
"RTN","SYNDHP05",71,0)
 ;Radology Diagnosis
"RTN","SYNDHP05",72,0)
 N DXARRAY,RETVAL
"RTN","SYNDHP05",73,0)
 S RETVAL=$$DXRAD(.DXARRAY,PATIEN,FRDAT,TODAT)
"RTN","SYNDHP05",74,0)
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
"RTN","SYNDHP05",75,0)
 . M DXRPTS=DXARRAY
"RTN","SYNDHP05",76,0)
 E  D
"RTN","SYNDHP05",77,0)
 . S RETSTA=RETSTA_RETVAL
"RTN","SYNDHP05",78,0)
 ;
"RTN","SYNDHP05",79,0)
 ;Mental Health Diagnosis
"RTN","SYNDHP05",80,0)
 N DXARRAY,RETVAL
"RTN","SYNDHP05",81,0)
 S RETVAL=$$DXMH(.DXARRAY,PATIEN,FRDAT,TODAT)
"RTN","SYNDHP05",82,0)
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
"RTN","SYNDHP05",83,0)
 . M DXRPTS=DXARRAY
"RTN","SYNDHP05",84,0)
 E  D
"RTN","SYNDHP05",85,0)
 . S RETSTA=RETSTA_RETVAL
"RTN","SYNDHP05",86,0)
 ;
"RTN","SYNDHP05",87,0)
 ;Visit Diagnosis
"RTN","SYNDHP05",88,0)
 N DXARRAY,RETVAL
"RTN","SYNDHP05",89,0)
 S RETVAL=$$DXVISIT(.DXARRAY,PATIEN,FRDAT,TODAT)
"RTN","SYNDHP05",90,0)
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
"RTN","SYNDHP05",91,0)
 . M DXRPTS=DXARRAY
"RTN","SYNDHP05",92,0)
 E  D
"RTN","SYNDHP05",93,0)
 . S RETSTA=RETSTA_RETVAL
"RTN","SYNDHP05",94,0)
 ;
"RTN","SYNDHP05",95,0)
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
"RTN","SYNDHP05",96,0)
 ;
"RTN","SYNDHP05",97,0)
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
"RTN","SYNDHP05",98,0)
 . S RETSTA=""
"RTN","SYNDHP05",99,0)
 . D TOJASON^SYNDHPUTL(.DXRPTS,.RETSTA)
"RTN","SYNDHP05",100,0)
 ;
"RTN","SYNDHP05",101,0)
 QUIT
"RTN","SYNDHP05",102,0)
 ;
"RTN","SYNDHP05",103,0)
DXRAD(DXRPTRAD,PATIEN,FRDAT,TODAT) ; get radiology diagnostic report
"RTN","SYNDHP05",104,0)
 ;
"RTN","SYNDHP05",105,0)
 N SEQ S SEQ=0
"RTN","SYNDHP05",106,0)
 N DXRRAD S DXRRAD=""
"RTN","SYNDHP05",107,0)
 I $G(DEBUG) W !,"Radiology Diagnoses",!
"RTN","SYNDHP05",108,0)
 N RADEX
"RTN","SYNDHP05",109,0)
 D RADEXAM^SYNDHP55(.RADEX,PATIEN,1,FRDAT,TODAT)
"RTN","SYNDHP05",110,0)
 ;             1      2        3       4            5            6         7        8     9     10     11                 12      13        14        15       16          17
"RTN","SYNDHP05",111,0)
 ; RADEX(SEQ)=PID_U_PatDfn_U_CatEx_U_ExamDate_U_ExamDateHl7_U_caseNbr_U_PROCIEN_U_PROC_U_CPT_U_SCT_U_primaryDiagnosis_U_REQPHYS_U_PIRES_U_PISTAFF_U_VISITDT_U_VISITHL_U_EnteringUser
"RTN","SYNDHP05",112,0)
 ;               1     2        3         4        5         6               7                        8
"RTN","SYNDHP05",113,0)
 ; RADEX(SEQ,1)=PID^dayCase^dateTime^dateTimeHL7^status id^status^verifying physician id^verifying physician name
"RTN","SYNDHP05",114,0)
 ; RADEX(SEQ,"REPORT")=report
"RTN","SYNDHP05",115,0)
 ; RADEX(SEQ,"IMPRESSION")=impression
"RTN","SYNDHP05",116,0)
 ;
"RTN","SYNDHP05",117,0)
 D BLDARRAY(.RADEX,.DXRPTRAD)
"RTN","SYNDHP05",118,0)
 ;
"RTN","SYNDHP05",119,0)
 N PRSTA,PDATE,PDATEHL,PPROV,PID,PRCPT,SCT,DESC,PRIMEDX,DXSCT,TEXT
"RTN","SYNDHP05",120,0)
 N IDX S IDX=""
"RTN","SYNDHP05",121,0)
 F  S IDX=$O(RADEX(IDX)) QUIT:IDX=""  D
"RTN","SYNDHP05",122,0)
 . QUIT:'$D(RADEX(IDX,1))  ;there is no rad diag rpt for this exam
"RTN","SYNDHP05",123,0)
 . S PRSTA="final" ;status
"RTN","SYNDHP05",124,0)
 . S PDATE=$P($G(RADEX(IDX,1)),U,3) ;exam date (FM)
"RTN","SYNDHP05",125,0)
 . QUIT:((PDATE\1)<FRDAT)!((PDATE\1)>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP05",126,0)
 . S PDATEHL=$P($G(RADEX(IDX,1)),U,4) ;exam date (HL7)
"RTN","SYNDHP05",127,0)
 . S PPROV=$P($G(RADEX(IDX,1)),U,8) ;verifying provider
"RTN","SYNDHP05",128,0)
 . S PID=$P($G(RADEX(IDX,1)),U,1) ;resource id
"RTN","SYNDHP05",129,0)
 . S PRCPT=$P($G(RADEX(IDX)),U,9) ;procedure cpt
"RTN","SYNDHP05",130,0)
 . S SCT=$P($G(RADEX(IDX)),U,10) ;procedure sct
"RTN","SYNDHP05",131,0)
 . S DESC=$P($G(RADEX(IDX)),U,8) ;procedure desc
"RTN","SYNDHP05",132,0)
 . S PRIMEDX=$P($G(RADEX(IDX)),U,11) ;primary diagnosis
"RTN","SYNDHP05",133,0)
 . S DXSCT="" ;                              <<<<<<<<<<<<<<<< rad diagnoses are text, no associated SCT
"RTN","SYNDHP05",134,0)
 . S TEXT=$G(RADEX(IDX,"REPORT"))
"RTN","SYNDHP05",135,0)
 . S DXRRAD=DXRRAD_U_"IMG"_P_PRSTA_P_PDATEHL_P_PPROV_P_PID_P_PRCPT_P_SCT_P_DESC_P_PRIMEDX_P_DXSCT_P_TEXT
"RTN","SYNDHP05",136,0)
 ;
"RTN","SYNDHP05",137,0)
 ;I $G(DEBUG) W ! ZWRITE DXRRAD
"RTN","SYNDHP05",138,0)
 ;I $G(DEBUG) W ! ZWRITE DXRPTRAD
"RTN","SYNDHP05",139,0)
 ;
"RTN","SYNDHP05",140,0)
 QUIT DXRRAD
"RTN","SYNDHP05",141,0)
 ;   RETSTA  - ICN^"IMG"|status|dateTime|provider|identifier|CPT|SCT|desc|primary dx|dx SCT|conclusion^...
"RTN","SYNDHP05",142,0)
 ;
"RTN","SYNDHP05",143,0)
BLDARRAY(RADEX,DXRPTRAD) ;Build an array from data returned by RADEXAM^SYNDHP55
"RTN","SYNDHP05",144,0)
 ;
"RTN","SYNDHP05",145,0)
 ;             1      2        3          4            5            6         7        8     9     10     11                 12      13        14        15       16           17
"RTN","SYNDHP05",146,0)
 ; RADEX(SEQ)=PID_U_PatDfn_U_Category_U_ExamDate_U_ExamDateHl7_U_caseNbr_U_PROCIEN_U_PROC_U_CPT_U_SCT_U_primaryDiagnosis_U_REQPHYS_U_PIRES_U_PISTAFF_U_VISITDT_U_VISITHL_U_EnteringUser
"RTN","SYNDHP05",147,0)
 ;               1     2        3         4        5         6               7                        8
"RTN","SYNDHP05",148,0)
 ; RADEX(SEQ,1)=PID^dayCase^dateTime^dateTimeHL7^status id^status^verifying physician id^verifying physician name
"RTN","SYNDHP05",149,0)
 ; RADEX(SEQ,"REPORT")=report
"RTN","SYNDHP05",150,0)
 ; RADEX(SEQ,"IMPRESSION")=impression
"RTN","SYNDHP05",151,0)
 ;
"RTN","SYNDHP05",152,0)
 N IDX S IDX=""
"RTN","SYNDHP05",153,0)
 F  S IDX=$O(RADEX(IDX)) QUIT:IDX=""  D
"RTN","SYNDHP05",154,0)
 . QUIT:'$D(RADEX(IDX,1))  ;there is no rad diag rpt for this exam
"RTN","SYNDHP05",155,0)
 . S PDATE=$P($G(RADEX(IDX,1)),U,3) ;exam date (FM)
"RTN","SYNDHP05",156,0)
 . QUIT:(PDATE<FRDAT)!(PDATE>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP05",157,0)
 . N RADEXAM S RADEXAM=$NA(DXRPTRAD("DxReportRad",IDX,"RadExam"))
"RTN","SYNDHP05",158,0)
 . S @RADEXAM@("resourceType")="DiagnosticReport"
"RTN","SYNDHP05",159,0)
 . S @RADEXAM@("resourceId")=$P($G(RADEX(IDX)),U,1)
"RTN","SYNDHP05",160,0)
 . S @RADEXAM@("status")="final"
"RTN","SYNDHP05",161,0)
 . S @RADEXAM@("patientId")=$P($G(RADEX(IDX)),U,2)
"RTN","SYNDHP05",162,0)
 . S @RADEXAM@("category")=$P($G(RADEX(IDX)),U,3)
"RTN","SYNDHP05",163,0)
 . S @RADEXAM@("ExamDateFM")=$P($G(RADEX(IDX)),U,4)
"RTN","SYNDHP05",164,0)
 . S @RADEXAM@("ExamDateHL7")=$P($G(RADEX(IDX)),U,5)
"RTN","SYNDHP05",165,0)
 . S @RADEXAM@("ExamDateFHIR")=$$FMTFHIR^SYNDHPUTL($P($G(RADEX(IDX)),U,4))
"RTN","SYNDHP05",166,0)
 . S @RADEXAM@("caseNbr")=$P($G(RADEX(IDX)),U,6)
"RTN","SYNDHP05",167,0)
 . S @RADEXAM@("procedureId")=$P($G(RADEX(IDX)),U,7)
"RTN","SYNDHP05",168,0)
 . S @RADEXAM@("procedure")=$P($G(RADEX(IDX)),U,8)
"RTN","SYNDHP05",169,0)
 . S @RADEXAM@("procedureCPT")=$P($G(RADEX(IDX)),U,9)
"RTN","SYNDHP05",170,0)
 . S @RADEXAM@("procedureSCT")=$P($G(RADEX(IDX)),U,10)
"RTN","SYNDHP05",171,0)
 . S @RADEXAM@("primaryDiagnosis")=$P($G(RADEX(IDX)),U,11)
"RTN","SYNDHP05",172,0)
 . S @RADEXAM@("primaryDiagnosisSCT")="" ;           <<<<<<<<<<<<<<<<<no icd to map
"RTN","SYNDHP05",173,0)
 . S @RADEXAM@("requestingPhysician")=$P($G(RADEX(IDX)),U,12)
"RTN","SYNDHP05",174,0)
 . S @RADEXAM@("primaryInterpretingResident")=$P($G(RADEX(IDX)),U,13)
"RTN","SYNDHP05",175,0)
 . S @RADEXAM@("primaryInterpretingStaff")=$P($G(RADEX(IDX)),U,14)
"RTN","SYNDHP05",176,0)
 . S @RADEXAM@("visitDateFM")=$P($G(RADEX(IDX)),U,15)
"RTN","SYNDHP05",177,0)
 . S @RADEXAM@("visitDateHL7")=$P($G(RADEX(IDX)),U,16)
"RTN","SYNDHP05",178,0)
 . S @RADEXAM@("visitDateFHIR")=$$FMTFHIR^SYNDHPUTL($P($G(RADEX(IDX)),U,15))
"RTN","SYNDHP05",179,0)
 . S @RADEXAM@("EnteringUser")=$P($G(RADEX(IDX)),U,17)
"RTN","SYNDHP05",180,0)
 . N RADRPT S RADRPT=$NA(DXRPTRAD("DxReportRad",IDX,"RadReport"))
"RTN","SYNDHP05",181,0)
 . S @RADRPT@("resourceId")=$P($G(RADEX(IDX,1)),U,1)
"RTN","SYNDHP05",182,0)
 . S @RADRPT@("dayCase")=$P($G(RADEX(IDX,1)),U,2)
"RTN","SYNDHP05",183,0)
 . S @RADRPT@("dateTimeFM")=$P($G(RADEX(IDX,1)),U,3)
"RTN","SYNDHP05",184,0)
 . S @RADRPT@("dateTimeHL7")=$P($G(RADEX(IDX,1)),U,4)
"RTN","SYNDHP05",185,0)
 . S @RADRPT@("dateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($P($G(RADEX(IDX,1)),U,3))
"RTN","SYNDHP05",186,0)
 . S @RADRPT@("statusId")=$P($G(RADEX(IDX,1)),U,5)
"RTN","SYNDHP05",187,0)
 . S @RADRPT@("status")=$P($G(RADEX(IDX,1)),U,6)
"RTN","SYNDHP05",188,0)
 . S @RADRPT@("verifyingPhysicianId")=$P($G(RADEX(IDX,1)),U,7)
"RTN","SYNDHP05",189,0)
 . S @RADRPT@("verifyingPhysicianName")=$P($G(RADEX(IDX,1)),U,8)
"RTN","SYNDHP05",190,0)
 . S @RADRPT@("conclusion")=$G(RADEX(IDX,"REPORT"))
"RTN","SYNDHP05",191,0)
 . S @RADRPT@("impression")=$G(RADEX(IDX,"IMPRESSION"))
"RTN","SYNDHP05",192,0)
 ;
"RTN","SYNDHP05",193,0)
 QUIT
"RTN","SYNDHP05",194,0)
 ;$$FMTFHIR^SYNDHPUTL(
"RTN","SYNDHP05",195,0)
DXMH(DXRPTMH,PATIEN,FRDAT,TODAT) ;get Mental Health Diagnosis
"RTN","SYNDHP05",196,0)
 ;
"RTN","SYNDHP05",197,0)
 N MHDXRS,SERMHDXRS,MHIEN,IENS,MAPPING
"RTN","SYNDHP05",198,0)
 N STATUS,DXDTFM,DXDTHL,DXBY,PID,STATUS,DXCODE,SDESC
"RTN","SYNDHP05",199,0)
 ;
"RTN","SYNDHP05",200,0)
 N SNOMED S SNOMED=""
"RTN","SYNDHP05",201,0)
 N S,P
"RTN","SYNDHP05",202,0)
 S S="_",P="|"
"RTN","SYNDHP05",203,0)
 ;
"RTN","SYNDHP05",204,0)
 I $G(DEBUG) W !,"Mental Health Diagnosis",!
"RTN","SYNDHP05",205,0)
 N MHDXRS S MHDXRS=""
"RTN","SYNDHP05",206,0)
 N FNBR1 S FNBR1=627.8 ;Diagnostic Results-Mental Health
"RTN","SYNDHP05",207,0)
 N SEQ S SEQ=0
"RTN","SYNDHP05",208,0)
 ;
"RTN","SYNDHP05",209,0)
 S MHIEN=""
"RTN","SYNDHP05",210,0)
 F  S MHIEN=$O(^YSD(627.8,"C",PATIEN,MHIEN)) QUIT:MHIEN=""  D
"RTN","SYNDHP05",211,0)
 . S IENS=MHIEN_","
"RTN","SYNDHP05",212,0)
 . S DXCODE=$$GET1^DIQ(FNBR1,IENS,1) ;diagnosis
"RTN","SYNDHP05",213,0)
 . QUIT:DXCODE=""
"RTN","SYNDHP05",214,0)
 . N DXMH
"RTN","SYNDHP05",215,0)
 . D GET1MHDX^SYNDHP17(.DXMH,MHIEN,0)
"RTN","SYNDHP05",216,0)
 . QUIT:$D(DXMH("Mhdiag","ERROR"))
"RTN","SYNDHP05",217,0)
 . I $D(DXMH("Mhdiag","ERROR")) M DXRPTMH("DxReportMH",MHIEN)=DXMH QUIT
"RTN","SYNDHP05",218,0)
 . ;I $G(DEBUG) ZWRITE DXMH
"RTN","SYNDHP05",219,0)
 . S DXDTFM=DXMH("Mhdiag","dateTimeOfDiagnosisFM") ;date/time of diagnosis fm format
"RTN","SYNDHP05",220,0)
 . QUIT:((DXDTFM\1)<FRDAT)!((DXDTFM\1)>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP05",221,0)
 . S DXDTHL=DXMH("Mhdiag","dateTimeOfDiagnosisHL7") ;hl7 format date/time of diagnosis
"RTN","SYNDHP05",222,0)
 . S DXBY=DXMH("Mhdiag","diagnosisBy") ;diagnosed by
"RTN","SYNDHP05",223,0)
 . S DXCODE=DXMH("Mhdiag","diagnosis") ;diagnosis
"RTN","SYNDHP05",224,0)
 . S SDESC=$P($$ICDDX^ICDEX(DXCODE),U,4)
"RTN","SYNDHP05",225,0)
 . S STATUS=$$LOW^XLFSTR(DXMH("Mhdiag","statusVPRINRu")) ;status
"RTN","SYNDHP05",226,0)
 . S PID=DXMH("Mhdiag","resourceId")
"RTN","SYNDHP05",227,0)
 . S SNOMED=DXMH("Mhdiag","diagnosisSCT")
"RTN","SYNDHP05",228,0)
 . ;
"RTN","SYNDHP05",229,0)
 . ;^category|status|dateTime|provider|identifier|diag code|SCT|diag desc^...
"RTN","SYNDHP05",230,0)
 . S SEQ=SEQ+1
"RTN","SYNDHP05",231,0)
 . S MHDXRS(SEQ)=U_"MHDX"_P_STATUS_P_DXDTHL_P_DXBY_P_PID_P_DXCODE_P_SNOMED_P_SDESC
"RTN","SYNDHP05",232,0)
 . ;I $G(DEBUG) ZWRITE MHDXRS(SEQ)
"RTN","SYNDHP05",233,0)
 . M DXRPTMH("DxReportMH",MHIEN)=DXMH ;
"RTN","SYNDHP05",234,0)
 ;
"RTN","SYNDHP05",235,0)
 ;I $G(DEBUG) W ! ZWRITE MHDXRS
"RTN","SYNDHP05",236,0)
 ;I $G(DEBUG) W ! ZWRITE DXRPTMH
"RTN","SYNDHP05",237,0)
 ;
"RTN","SYNDHP05",238,0)
 ;serialize data
"RTN","SYNDHP05",239,0)
 S SERMHDXRS=""
"RTN","SYNDHP05",240,0)
 S SEQ=""
"RTN","SYNDHP05",241,0)
 F  S SEQ=$O(MHDXRS(SEQ)) QUIT:SEQ=""  D
"RTN","SYNDHP05",242,0)
 . S SERMHDXRS=SERMHDXRS_MHDXRS(SEQ)
"RTN","SYNDHP05",243,0)
 ;
"RTN","SYNDHP05",244,0)
 ;I $G(DEBUG) W ! ZWRITE SERMHDXRS
"RTN","SYNDHP05",245,0)
 ;
"RTN","SYNDHP05",246,0)
 QUIT SERMHDXRS
"RTN","SYNDHP05",247,0)
 ;
"RTN","SYNDHP05",248,0)
DXVISIT(DXRPTV,PATIEN,FRDAT,TODAT) ; get visit diagnostic report
"RTN","SYNDHP05",249,0)
 ;
"RTN","SYNDHP05",250,0)
 N STATUS,DXDTHL,PROV,SERPOV,RESID,DXCODE,SNOMED,SDESC,MAPPING,SNOMED
"RTN","SYNDHP05",251,0)
 N SEQ S SEQ=0
"RTN","SYNDHP05",252,0)
 N DXVISIT S DXVISIT=""
"RTN","SYNDHP05",253,0)
 I $G(DEBUG) W !,"Visit Diagnosis",!
"RTN","SYNDHP05",254,0)
 ;patient - ^AUPNVPOV("C",
"RTN","SYNDHP05",255,0)
 N POVIEN S POVIEN=""
"RTN","SYNDHP05",256,0)
 F  S POVIEN=$O(^AUPNVPOV("C",PATIEN,POVIEN)) QUIT:POVIEN=""  D
"RTN","SYNDHP05",257,0)
 . N VPOV
"RTN","SYNDHP05",258,0)
 . D GET1VPOV^SYNDHP13(.VPOV,POVIEN,0)
"RTN","SYNDHP05",259,0)
 . I $D(VPOV("V POV","ERROR")) M DXRPTV("DxReportVisit",POVIEN)=VPOV QUIT
"RTN","SYNDHP05",260,0)
 . S VPOV("V POV","resourceType")="DiagnosticReport"
"RTN","SYNDHP05",261,0)
 . S STATUS="final"
"RTN","SYNDHP05",262,0)
 . S DXDTFM=VPOV("V POV","visitFM")
"RTN","SYNDHP05",263,0)
 . QUIT:((DXDTFM\1)<FRDAT)!((DXDTFM\1)>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP05",264,0)
 . S DXDTHL=VPOV("V POV","visitHL7")
"RTN","SYNDHP05",265,0)
 . S PROV=VPOV("V POV","encounterProvider")
"RTN","SYNDHP05",266,0)
 . S RESID=VPOV("V POV","resourceId")
"RTN","SYNDHP05",267,0)
 . S DXCODE=VPOV("V POV","pov")
"RTN","SYNDHP05",268,0)
 . S SDESC=$P($$ICDDX^ICDEX(DXCODE),U,4)
"RTN","SYNDHP05",269,0)
 . S SNOMED=VPOV("V POV","povSCT")
"RTN","SYNDHP05",270,0)
 . ;^category|status|dateTime|provider|identifier|ICD|SCT|diag desc^...
"RTN","SYNDHP05",271,0)
 . S SEQ=SEQ+1
"RTN","SYNDHP05",272,0)
 . S DXVISIT(SEQ)=U_"VISIT"_P_STATUS_P_DXDTHL_P_PROV_P_RESID_P_DXCODE_P_SNOMED_P_SDESC
"RTN","SYNDHP05",273,0)
 . M DXRPTV("DxReportVisit",POVIEN)=VPOV ;
"RTN","SYNDHP05",274,0)
 ;serialize data
"RTN","SYNDHP05",275,0)
 S SERPOV=""
"RTN","SYNDHP05",276,0)
 S SEQ=""
"RTN","SYNDHP05",277,0)
 F  S SEQ=$O(DXVISIT(SEQ)) QUIT:SEQ=""  D
"RTN","SYNDHP05",278,0)
 . S SERPOV=SERPOV_DXVISIT(SEQ)
"RTN","SYNDHP05",279,0)
 ;
"RTN","SYNDHP05",280,0)
 ;I $G(DEBUG) W ! ZWRITE SERPOV
"RTN","SYNDHP05",281,0)
 ;I $G(DEBUG) W ! ZWRITE DXRPTV
"RTN","SYNDHP05",282,0)
 ;
"RTN","SYNDHP05",283,0)
 QUIT SERPOV
"RTN","SYNDHP05",284,0)
 ;
"RTN","SYNDHP05",285,0)
 ; ----------- Unit Test -----------
"RTN","SYNDHP05",286,0)
T1 ;
"RTN","SYNDHP05",287,0)
 N ICN S ICN="10101V964144"
"RTN","SYNDHP05",288,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP05",289,0)
 N TODAT S TODAT=""
"RTN","SYNDHP05",290,0)
 N JSON S JSON=""
"RTN","SYNDHP05",291,0)
 N RETSTA
"RTN","SYNDHP05",292,0)
 D PATDXRI(.RETSTA,ICN,FRDAT,TODAT,JSON)
"RTN","SYNDHP05",293,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP05",294,0)
 QUIT
"RTN","SYNDHP05",295,0)
 ;
"RTN","SYNDHP05",296,0)
T2 ;
"RTN","SYNDHP05",297,0)
 N ICN S ICN="10101V964144"
"RTN","SYNDHP05",298,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP05",299,0)
 N TODAT S TODAT=""
"RTN","SYNDHP05",300,0)
 N JSON S JSON="J"
"RTN","SYNDHP05",301,0)
 N RETSTA
"RTN","SYNDHP05",302,0)
 D PATDXRI(.RETSTA,ICN,FRDAT,TODAT,JSON)
"RTN","SYNDHP05",303,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP05",304,0)
 QUIT
"RTN","SYNDHP05",305,0)
 ;
"RTN","SYNDHP06")
0^98^B14159682
"RTN","SYNDHP06",1,0)
SYNDHP06 ; HC/rbd/art - HealthConcourse - get hospital location and institution data ;05/07/2019
"RTN","SYNDHP06",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP06",3,0)
 ;;
"RTN","SYNDHP06",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP06",5,0)
 ;
"RTN","SYNDHP06",6,0)
 QUIT
"RTN","SYNDHP06",7,0)
 ;
"RTN","SYNDHP06",8,0)
 ; ---------------- Get institution details for hospital location ------------------------------
"RTN","SYNDHP06",9,0)
 ;
"RTN","SYNDHP06",10,0)
HOSINSTI(RETSTA,HLOCNAME,RETJSON) ; takes Hospital Location name and returns Institution and Inst. details
"RTN","SYNDHP06",11,0)
 ;
"RTN","SYNDHP06",12,0)
 ; Return Institution and Inst. details for a given Hospital Location name
"RTN","SYNDHP06",13,0)
 ;
"RTN","SYNDHP06",14,0)
 ; Input:
"RTN","SYNDHP06",15,0)
 ;   HLOCNAME  - Hospital Location name
"RTN","SYNDHP06",16,0)
 ;   RETJSON - J = Return JSON
"RTN","SYNDHP06",17,0)
 ;             F = Return FHIR
"RTN","SYNDHP06",18,0)
 ;             0 or null = Return Location string (default)
"RTN","SYNDHP06",19,0)
 ; Output:
"RTN","SYNDHP06",20,0)
 ;   RETSTA  - a delimited string that lists institution details for hospital location name
"RTN","SYNDHP06",21,0)
 ;             LocName^LocIEN|institutionName|instIEN|instStreet1|instStreet2|instCity|instState|instZip|contactName1_Phone1*repeats|resourceId
"RTN","SYNDHP06",22,0)
 ;          or hospital location & institution data in JSON format
"RTN","SYNDHP06",23,0)
 ;
"RTN","SYNDHP06",24,0)
 ; validate Hospital Location name
"RTN","SYNDHP06",25,0)
 I $G(HLOCNAME)="" S RETSTA="-1^What location?" QUIT
"RTN","SYNDHP06",26,0)
 I '$D(^SC("B",HLOCNAME)) S RETSTA="-1^Hospital Location name not recognised^"_HLOCNAME Q
"RTN","SYNDHP06",27,0)
 ;
"RTN","SYNDHP06",28,0)
 N HLOCARR
"RTN","SYNDHP06",29,0)
 S RETSTA=$$INSTS(HLOCNAME,.HLOCARR)
"RTN","SYNDHP06",30,0)
 ;
"RTN","SYNDHP06",31,0)
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
"RTN","SYNDHP06",32,0)
 ;
"RTN","SYNDHP06",33,0)
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
"RTN","SYNDHP06",34,0)
 . S RETSTA=""
"RTN","SYNDHP06",35,0)
 . D TOJASON^SYNDHPUTL(.HLOCARR,.RETSTA)
"RTN","SYNDHP06",36,0)
 ;
"RTN","SYNDHP06",37,0)
 QUIT
"RTN","SYNDHP06",38,0)
 ;
"RTN","SYNDHP06",39,0)
INSTS(HLOCNAME,HLOCARR) ; get locations for encounters for a patient
"RTN","SYNDHP06",40,0)
 ;
"RTN","SYNDHP06",41,0)
 N C,P,S,A,ZARR
"RTN","SYNDHP06",42,0)
 N CONTNAM,CONTPH,CONTSTR,HSLOCID,INSTCITY,INSTIEN,INSTNAM,INSTST1,INSTST2,INSTSTAT,INSTZIP
"RTN","SYNDHP06",43,0)
 S C=",",P="|",S="_",A="*"
"RTN","SYNDHP06",44,0)
 N FNUM S FNUM=44        ; HOSPITAL LOCATION file
"RTN","SYNDHP06",45,0)
 ; scan hospital location "B" index for HLIEN
"RTN","SYNDHP06",46,0)
 N HLIEN S HLIEN=""
"RTN","SYNDHP06",47,0)
 F  S HLIEN=$O(^SC("B",HLOCNAME,HLIEN)) Q:HLIEN=""  D
"RTN","SYNDHP06",48,0)
 .N HOSPLOC
"RTN","SYNDHP06",49,0)
 .D GETHLOC^SYNDHP22(.HOSPLOC,HLIEN)
"RTN","SYNDHP06",50,0)
 .I $D(HOSPLOC("Hosploc","ERROR")) M HLOCARR("Location",HLIEN)=HOSPLOC QUIT
"RTN","SYNDHP06",51,0)
 .S INSTNAM=HOSPLOC("Hosploc","institution")
"RTN","SYNDHP06",52,0)
 .S INSTIEN=HOSPLOC("Hosploc","institutionId")
"RTN","SYNDHP06",53,0)
 .S HSLOCID=HOSPLOC("Hosploc","resourceId")
"RTN","SYNDHP06",54,0)
 .N SITE
"RTN","SYNDHP06",55,0)
 .D GET1SITE^SYNDHP10(.SITE,INSTIEN,0)
"RTN","SYNDHP06",56,0)
 .I $D(SITE("Site","ERROR")) M HLOCARR("Location",HLIEN)=SITE QUIT
"RTN","SYNDHP06",57,0)
 .S INSTST1=SITE("Site","streetAddr1")
"RTN","SYNDHP06",58,0)
 .S INSTST2=SITE("Site","streetAddr2")
"RTN","SYNDHP06",59,0)
 .S INSTCITY=SITE("Site","city")
"RTN","SYNDHP06",60,0)
 .S INSTZIP=SITE("Site","zip")
"RTN","SYNDHP06",61,0)
 .S INSTSTAT=SITE("Site","state")
"RTN","SYNDHP06",62,0)
 .S CONTSTR=""
"RTN","SYNDHP06",63,0)
 .N IENS2 S IENS2=""
"RTN","SYNDHP06",64,0)
 .F  S IENS2=$O(SITE("Site","contacts","contact",IENS2)) QUIT:IENS2=""  D
"RTN","SYNDHP06",65,0)
 ..N CONTACT S CONTACT=$NA(SITE("Site","contacts","contact",+IENS2))
"RTN","SYNDHP06",66,0)
 ..S CONTNAM=@CONTACT@("contact")
"RTN","SYNDHP06",67,0)
 ..S CONTPH=@CONTACT@("phone")
"RTN","SYNDHP06",68,0)
 ..S CONTSTR=CONTSTR_CONTNAM_S_CONTPH_A
"RTN","SYNDHP06",69,0)
 .S:CONTSTR]"" CONTSTR=$E(CONTSTR,1,$L(CONTSTR)-1)
"RTN","SYNDHP06",70,0)
 .I $G(DEBUG) W !,HLOCNAME,A,HLIEN,A,INSTNAM,A,INSTIEN,A,INSTST1,A,INSTST2,A,INSTCITY,A,INSTSTAT,A,INSTZIP,A,CONTSTR,A,HSLOCID,!!
"RTN","SYNDHP06",71,0)
 .S ZARR(HLOCNAME,HLIEN)=INSTNAM_P_INSTIEN_P_INSTST1_P_INSTST2_P_INSTCITY_P_INSTSTAT_P_INSTZIP_P_CONTSTR_P_HSLOCID
"RTN","SYNDHP06",72,0)
 .M HLOCARR("Location",HLIEN)=HOSPLOC
"RTN","SYNDHP06",73,0)
 .M HLOCARR("Location",HLIEN,"institution")=SITE("Site")
"RTN","SYNDHP06",74,0)
 ;
"RTN","SYNDHP06",75,0)
 ; serialize data
"RTN","SYNDHP06",76,0)
 N HLREC,VSTDT,VIEN
"RTN","SYNDHP06",77,0)
 N HLOC S HLOC=HLOCNAME
"RTN","SYNDHP06",78,0)
 S (VSTDT,VIEN)=""
"RTN","SYNDHP06",79,0)
 F  S HLIEN=$O(ZARR(HLOCNAME,HLIEN)) Q:HLIEN=""  D
"RTN","SYNDHP06",80,0)
 .S HLREC=ZARR(HLOCNAME,HLIEN)
"RTN","SYNDHP06",81,0)
 .S HLOC=HLOC_U_HLIEN_P_HLREC
"RTN","SYNDHP06",82,0)
 ;
"RTN","SYNDHP06",83,0)
 Q HLOC
"RTN","SYNDHP06",84,0)
 ;
"RTN","SYNDHP06",85,0)
 ; ----------- Unit Test -----------
"RTN","SYNDHP06",86,0)
T1 ;
"RTN","SYNDHP06",87,0)
 N LOCNAME S LOCNAME="GENERAL MEDICINE"
"RTN","SYNDHP06",88,0)
 N JSON S JSON=""
"RTN","SYNDHP06",89,0)
 N RETSTA
"RTN","SYNDHP06",90,0)
 D HOSINSTI(.RETSTA,LOCNAME,JSON)
"RTN","SYNDHP06",91,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP06",92,0)
 QUIT
"RTN","SYNDHP06",93,0)
 ;
"RTN","SYNDHP06",94,0)
T2 ;
"RTN","SYNDHP06",95,0)
 N LOCNAME S LOCNAME="GENERAL MEDICINE"
"RTN","SYNDHP06",96,0)
 N JSON S JSON="J"
"RTN","SYNDHP06",97,0)
 N RETSTA
"RTN","SYNDHP06",98,0)
 D HOSINSTI(.RETSTA,LOCNAME,JSON)
"RTN","SYNDHP06",99,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP06",100,0)
 QUIT
"RTN","SYNDHP06",101,0)
 ;
"RTN","SYNDHP07")
0^99^B20083819
"RTN","SYNDHP07",1,0)
SYNDHP07 ; HC/rbd/art - HealthConcourse - get patient's nursing care plan data ;05/04/2019
"RTN","SYNDHP07",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP07",3,0)
 ;;
"RTN","SYNDHP07",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP07",5,0)
 ;
"RTN","SYNDHP07",6,0)
 QUIT
"RTN","SYNDHP07",7,0)
 ;
"RTN","SYNDHP07",8,0)
 ;
"RTN","SYNDHP07",9,0)
 ; ---------------- Get patient nursing care plan goals information ------------------------
"RTN","SYNDHP07",10,0)
 ;
"RTN","SYNDHP07",11,0)
PATGOLI(RETSTA,DHPICN,FRDAT,TODAT,RETJSON) ; Patient goals for ICN
"RTN","SYNDHP07",12,0)
 ;
"RTN","SYNDHP07",13,0)
 ; Return patient nursing care plan goals for a given patient ICN
"RTN","SYNDHP07",14,0)
 ;
"RTN","SYNDHP07",15,0)
 ; Input:
"RTN","SYNDHP07",16,0)
 ;   ICN     - unique patient identifier across all VistA systems
"RTN","SYNDHP07",17,0)
 ;   FRDAT   - from date (inclusive), optional, compares to date/time entered
"RTN","SYNDHP07",18,0)
 ;   TODAT   - to date (inclusive), optional, compares to date/time entered
"RTN","SYNDHP07",19,0)
 ;   RETJSON - J = Return JSON
"RTN","SYNDHP07",20,0)
 ;             F = Return FHIR
"RTN","SYNDHP07",21,0)
 ;             0 or null = Return patient goals string (default)
"RTN","SYNDHP07",22,0)
 ; Output:
"RTN","SYNDHP07",23,0)
 ;   RETSTA  - a delimited string that lists patient goals information
"RTN","SYNDHP07",24,0)
 ;             ICN ^ Resource ID | Date/Time Entered | Goal/Expected Outcome | Target Date | User Who Entered | code ; Status of Goal ^ ...
"RTN","SYNDHP07",25,0)
 ;          or patient nursing care plans in JSON format
"RTN","SYNDHP07",26,0)
 ;
"RTN","SYNDHP07",27,0)
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
"RTN","SYNDHP07",28,0)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
"RTN","SYNDHP07",29,0)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
"RTN","SYNDHP07",30,0)
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
"RTN","SYNDHP07",31,0)
 ;
"RTN","SYNDHP07",32,0)
 ; validate ICN
"RTN","SYNDHP07",33,0)
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
"RTN","SYNDHP07",34,0)
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" Q
"RTN","SYNDHP07",35,0)
 ; 
"RTN","SYNDHP07",36,0)
 ; get patient IEN from ICN
"RTN","SYNDHP07",37,0)
 N NCPARR
"RTN","SYNDHP07",38,0)
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP07",39,0)
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
"RTN","SYNDHP07",40,0)
 ;
"RTN","SYNDHP07",41,0)
 S RETSTA=$$GOALS(.NCPARR,PATIEN,DHPICN,FRDAT,TODAT)
"RTN","SYNDHP07",42,0)
 ;
"RTN","SYNDHP07",43,0)
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
"RTN","SYNDHP07",44,0)
 ;
"RTN","SYNDHP07",45,0)
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
"RTN","SYNDHP07",46,0)
 . S RETSTA=""
"RTN","SYNDHP07",47,0)
 . D TOJASON^SYNDHPUTL(.NCPARR,.RETSTA)
"RTN","SYNDHP07",48,0)
 ;
"RTN","SYNDHP07",49,0)
 QUIT
"RTN","SYNDHP07",50,0)
 ;
"RTN","SYNDHP07",51,0)
GOALS(NCPARR,PATIEN,DHPICN,FRDAT,TODAT) ; get goals for a patient
"RTN","SYNDHP07",52,0)
 ;
"RTN","SYNDHP07",53,0)
 N FNUM S FNUM=216.8      ;  file
"RTN","SYNDHP07",54,0)
 N S S S="_"
"RTN","SYNDHP07",55,0)
 N P S P="|"
"RTN","SYNDHP07",56,0)
 ; scan PATIENT "TARG" index in Nursing Care Plan file for Goals
"RTN","SYNDHP07",57,0)
 N TARGNUM,PTGOLID,ENTRYDT,ENTRYDTFM,ENTRDISP,GOAL,TARGDISP,ENTUSER,GOALSTAT,ZARR,GOALREC
"RTN","SYNDHP07",58,0)
 N MRECIEN S MRECIEN=""
"RTN","SYNDHP07",59,0)
 F  S MRECIEN=$O(^GMR(124.3,"C",PATIEN,MRECIEN)) QUIT:MRECIEN=""  D
"RTN","SYNDHP07",60,0)
 . N NCP
"RTN","SYNDHP07",61,0)
 . D GET1NCP^SYNDHP15(.NCP,MRECIEN,0)
"RTN","SYNDHP07",62,0)
 . I $D(NCP("NurseCarePlan","ERROR")) M NCPARR("NCPS",MRECIEN)=NCP QUIT
"RTN","SYNDHP07",63,0)
 . S TARGNUM=""
"RTN","SYNDHP07",64,0)
 . F  S TARGNUM=$O(NCP("NurseCarePlan","targetDates","targetDate",TARGNUM)) QUIT:TARGNUM=""  D
"RTN","SYNDHP07",65,0)
 . . S PTGOLID=NCP("NurseCarePlan","targetDates","targetDate",TARGNUM,"resourceId")
"RTN","SYNDHP07",66,0)
 . . S ENTRYDT=NCP("NurseCarePlan","targetDates","targetDate",TARGNUM,"dateTimeEntered")
"RTN","SYNDHP07",67,0)
 . . S ENTRYDTFM=NCP("NurseCarePlan","targetDates","targetDate",TARGNUM,"dateTimeEnteredFM")
"RTN","SYNDHP07",68,0)
 . . QUIT:((ENTRYDTFM\1)<FRDAT)!((ENTRYDTFM\1)>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP07",69,0)
 . . S ENTRDISP=NCP("NurseCarePlan","targetDates","targetDate",TARGNUM,"dateTimeEnteredHL7")
"RTN","SYNDHP07",70,0)
 . . S GOAL=NCP("NurseCarePlan","targetDates","targetDate",TARGNUM,"goalExpectedOutcome")
"RTN","SYNDHP07",71,0)
 . . S TARGDISP=NCP("NurseCarePlan","targetDates","targetDate",TARGNUM,"targetDateHL7")
"RTN","SYNDHP07",72,0)
 . . S ENTUSER=NCP("NurseCarePlan","targetDates","targetDate",TARGNUM,"userWhoEntered")
"RTN","SYNDHP07",73,0)
 . . S GOALSTAT=NCP("NurseCarePlan","targetDates","targetDate",TARGNUM,"goalMetDcdCd")_";"_NCP("NurseCarePlan","targetDates","targetDate",TARGNUM,"goalMetDcd")
"RTN","SYNDHP07",74,0)
 . . S ZARR(DHPICN,ENTRYDTFM,GOAL)=PTGOLID_P_ENTRDISP_P_GOAL_P_TARGDISP_P_ENTUSER_P_GOALSTAT
"RTN","SYNDHP07",75,0)
 . M NCPARR("NCPS",MRECIEN)=NCP ;
"RTN","SYNDHP07",76,0)
 ;
"RTN","SYNDHP07",77,0)
 ; serialize data
"RTN","SYNDHP07",78,0)
 S ENTRYDT=""
"RTN","SYNDHP07",79,0)
 N GOALS S GOALS=DHPICN
"RTN","SYNDHP07",80,0)
 F  S ENTRYDT=$O(ZARR(DHPICN,ENTRYDT)) Q:ENTRYDT=""  D
"RTN","SYNDHP07",81,0)
 . S GOAL=""
"RTN","SYNDHP07",82,0)
 . F  S GOAL=$O(ZARR(DHPICN,ENTRYDT,GOAL)) Q:GOAL=""  D
"RTN","SYNDHP07",83,0)
 . . S GOALREC=ZARR(DHPICN,ENTRYDT,GOAL)
"RTN","SYNDHP07",84,0)
 . . S GOALS=GOALS_U_GOALREC
"RTN","SYNDHP07",85,0)
 ;
"RTN","SYNDHP07",86,0)
 QUIT GOALS
"RTN","SYNDHP07",87,0)
 ;
"RTN","SYNDHP07",88,0)
 ; ----------- Unit Test -----------
"RTN","SYNDHP07",89,0)
T1 ;
"RTN","SYNDHP07",90,0)
 N ICN S ICN="1967316818V742124"
"RTN","SYNDHP07",91,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP07",92,0)
 N TODAT S TODAT=""
"RTN","SYNDHP07",93,0)
 N JSON S JSON=""
"RTN","SYNDHP07",94,0)
 N RETSTA
"RTN","SYNDHP07",95,0)
 D PATGOLI(.RETSTA,ICN,FRDAT,TODAT,JSON)
"RTN","SYNDHP07",96,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP07",97,0)
 QUIT
"RTN","SYNDHP07",98,0)
 ;
"RTN","SYNDHP07",99,0)
T2 ;
"RTN","SYNDHP07",100,0)
 N ICN S ICN="1967316818V742124"
"RTN","SYNDHP07",101,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP07",102,0)
 N TODAT S TODAT=""
"RTN","SYNDHP07",103,0)
 N JSON S JSON="J"
"RTN","SYNDHP07",104,0)
 N RETSTA
"RTN","SYNDHP07",105,0)
 D PATGOLI(.RETSTA,ICN,FRDAT,TODAT,JSON)
"RTN","SYNDHP07",106,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP07",107,0)
 QUIT
"RTN","SYNDHP07",108,0)
 ;
"RTN","SYNDHP08")
0^100^B14232287
"RTN","SYNDHP08",1,0)
SYNDHP08 ; HC/rbd/art - HealthConcourse - get patient flag data ;05/04/2019
"RTN","SYNDHP08",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP08",3,0)
 ;;
"RTN","SYNDHP08",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP08",5,0)
 ;
"RTN","SYNDHP08",6,0)
 QUIT
"RTN","SYNDHP08",7,0)
 ;
"RTN","SYNDHP08",8,0)
 ; ---------------- Get patient flag information ------------------------------
"RTN","SYNDHP08",9,0)
 ;
"RTN","SYNDHP08",10,0)
PATFLGI(RETSTA,DHPICN,FRDAT,TODAT,RETJSON) ; Patient flags for ICN
"RTN","SYNDHP08",11,0)
 ;
"RTN","SYNDHP08",12,0)
 ; Return patient flags for a given patient ICN
"RTN","SYNDHP08",13,0)
 ;
"RTN","SYNDHP08",14,0)
 ; Input:
"RTN","SYNDHP08",15,0)
 ;   ICN     - unique patient identifier across all VistA systems
"RTN","SYNDHP08",16,0)
 ;   FRDAT   - from date (inclusive), optional, not used, no logical date to compare
"RTN","SYNDHP08",17,0)
 ;   TODAT   - to date (inclusive), optional, not used, no logical date to compare
"RTN","SYNDHP08",18,0)
 ;   RETJSON - J = Return JSON
"RTN","SYNDHP08",19,0)
 ;             F = Return FHIR
"RTN","SYNDHP08",20,0)
 ;             0 or null = Return patient flags string (default)
"RTN","SYNDHP08",21,0)
 ; Output:
"RTN","SYNDHP08",22,0)
 ;   RETSTA  - a delimited string that lists patient flag information
"RTN","SYNDHP08",23,0)
 ;             ICN^flag name|SNOMED CT code|flag record IEN|national or local|status|owner site|originating site|review date|resource id^...
"RTN","SYNDHP08",24,0)
 ;          or patient flags in JSON format
"RTN","SYNDHP08",25,0)
 ;
"RTN","SYNDHP08",26,0)
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
"RTN","SYNDHP08",27,0)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
"RTN","SYNDHP08",28,0)
 I $G(DEBUG) W !,"DHPICN: ",DHPICN,"   FRDAT: ",FRDAT,"   TODAT: ",TODAT,"   RETJSON: ",RETJSON,!
"RTN","SYNDHP08",29,0)
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
"RTN","SYNDHP08",30,0)
 ;patient flag data does not contain a date to compare to TODAT or FRDAT
"RTN","SYNDHP08",31,0)
 ;
"RTN","SYNDHP08",32,0)
 ; validate ICN
"RTN","SYNDHP08",33,0)
 I $G(DHPICN)="" S RETSTA="-1^What Patient?" QUIT
"RTN","SYNDHP08",34,0)
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" QUIT
"RTN","SYNDHP08",35,0)
 ; 
"RTN","SYNDHP08",36,0)
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP08",37,0)
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
"RTN","SYNDHP08",38,0)
 ;
"RTN","SYNDHP08",39,0)
 N FLAGARR
"RTN","SYNDHP08",40,0)
 S RETSTA=$$FLAGS(.FLAGARR,PATIEN,DHPICN,FRDAT,TODAT)
"RTN","SYNDHP08",41,0)
 ;
"RTN","SYNDHP08",42,0)
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
"RTN","SYNDHP08",43,0)
 ;
"RTN","SYNDHP08",44,0)
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
"RTN","SYNDHP08",45,0)
 . S RETSTA=""
"RTN","SYNDHP08",46,0)
 . D TOJASON^SYNDHPUTL(.FLAGARR,.RETSTA)
"RTN","SYNDHP08",47,0)
 ;
"RTN","SYNDHP08",48,0)
 QUIT
"RTN","SYNDHP08",49,0)
 ;
"RTN","SYNDHP08",50,0)
FLAGS(FLAGARR,PATIEN,DHPICN,FRDAT,TODAT) ; get flags for a patient
"RTN","SYNDHP08",51,0)
 ;
"RTN","SYNDHP08",52,0)
 N FLAGREC,ZARR
"RTN","SYNDHP08",53,0)
 N PTFLGID,FLAGDESC,NATLOC,STATUS,OWNSITE,ORIGSITE,RVWDT,RVWDTDSP,FLAGSCT
"RTN","SYNDHP08",54,0)
 N C,P,S S C=",",P="|",S="_"
"RTN","SYNDHP08",55,0)
 ;
"RTN","SYNDHP08",56,0)
 N FNUM S FNUM=26.13      ;  file
"RTN","SYNDHP08",57,0)
 ; scan PATIENT "B" index for Flags
"RTN","SYNDHP08",58,0)
 ;S DHPICN=PATIEN
"RTN","SYNDHP08",59,0)
 N FLAGIEN S FLAGIEN=0
"RTN","SYNDHP08",60,0)
 F  S FLAGIEN=$O(^DGPF(26.13,"B",PATIEN,FLAGIEN)) QUIT:FLAGIEN=""  D
"RTN","SYNDHP08",61,0)
 . N FLAG
"RTN","SYNDHP08",62,0)
 . D GET1FLAG^SYNDHP17(.FLAG,FLAGIEN,0)
"RTN","SYNDHP08",63,0)
 . I $D(FLAG("Flag","ERROR")) M FLAGARR("Flags",FLAGIEN)=FLAG QUIT
"RTN","SYNDHP08",64,0)
 . ;I $G(DEBUG) W ! ZWRITE FLAG
"RTN","SYNDHP08",65,0)
 . S PTFLGID=FLAG("Flag","resourceId")
"RTN","SYNDHP08",66,0)
 . S FLAGDESC=FLAG("Flag","flagName") ;flag name
"RTN","SYNDHP08",67,0)
 . S NATLOC=$S(FLAG("Flag","flagNameId")["26.15":"National",1:"Local")
"RTN","SYNDHP08",68,0)
 . S STATUS=FLAG("Flag","status") ;status
"RTN","SYNDHP08",69,0)
 . S OWNSITE=FLAG("Flag","ownerSite") ;owner site
"RTN","SYNDHP08",70,0)
 . S ORIGSITE=FLAG("Flag","originatingSite") ;originating site
"RTN","SYNDHP08",71,0)
 . S RVWDT=FLAG("Flag","reviewDateFM") ;review date
"RTN","SYNDHP08",72,0)
 . S RVWDTDSP=FLAG("Flag","reviewDateHL7")
"RTN","SYNDHP08",73,0)
 . S FLAGSCT=FLAG("Flag","flagSCT")
"RTN","SYNDHP08",74,0)
 . ;S ASSNARR=FLAG("Flag","assignmentNarrative")
"RTN","SYNDHP08",75,0)
 . S ZARR(DHPICN,FLAGDESC)=FLAGSCT_P_FLAGIEN_P_NATLOC_P_STATUS_P_OWNSITE_P_ORIGSITE_P_RVWDTDSP_P_PTFLGID
"RTN","SYNDHP08",76,0)
 . M FLAGARR("Flags",FLAGIEN)=FLAG ;
"RTN","SYNDHP08",77,0)
 ;
"RTN","SYNDHP08",78,0)
 ; serialize data
"RTN","SYNDHP08",79,0)
 N FLAGDESC S FLAGDESC=""
"RTN","SYNDHP08",80,0)
 N FLAGS S FLAGS=DHPICN
"RTN","SYNDHP08",81,0)
 F  S FLAGDESC=$O(ZARR(DHPICN,FLAGDESC)) QUIT:FLAGDESC=""  D
"RTN","SYNDHP08",82,0)
 . S FLAGREC=ZARR(DHPICN,FLAGDESC)
"RTN","SYNDHP08",83,0)
 . S FLAGS=FLAGS_U_FLAGDESC_P_FLAGREC
"RTN","SYNDHP08",84,0)
 ;
"RTN","SYNDHP08",85,0)
 QUIT FLAGS
"RTN","SYNDHP08",86,0)
 ;
"RTN","SYNDHP08",87,0)
 ; ----------- Unit Test -----------
"RTN","SYNDHP08",88,0)
T1 ;
"RTN","SYNDHP08",89,0)
 N ICN S ICN="10189V514254"
"RTN","SYNDHP08",90,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP08",91,0)
 N TODAT S TODAT=""
"RTN","SYNDHP08",92,0)
 N JSON S JSON=""
"RTN","SYNDHP08",93,0)
 N RETSTA
"RTN","SYNDHP08",94,0)
 D PATFLGI(.RETSTA,ICN,FRDAT,TODAT,JSON)
"RTN","SYNDHP08",95,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP08",96,0)
 QUIT
"RTN","SYNDHP08",97,0)
 ;
"RTN","SYNDHP08",98,0)
T2 ;
"RTN","SYNDHP08",99,0)
 N ICN S ICN="10189V514254"
"RTN","SYNDHP08",100,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP08",101,0)
 N TODAT S TODAT=""
"RTN","SYNDHP08",102,0)
 N JSON S JSON="J"
"RTN","SYNDHP08",103,0)
 N RETSTA
"RTN","SYNDHP08",104,0)
 D PATFLGI(.RETSTA,ICN,FRDAT,TODAT,JSON)
"RTN","SYNDHP08",105,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP08",106,0)
 QUIT
"RTN","SYNDHP08",107,0)
 ;
"RTN","SYNDHP09")
0^101^B50112432
"RTN","SYNDHP09",1,0)
SYNDHP09 ; HC/fjf/art - HealthConcourse - get patient health factors ;05/04/2019
"RTN","SYNDHP09",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP09",3,0)
 ;;
"RTN","SYNDHP09",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP09",5,0)
 ;
"RTN","SYNDHP09",6,0)
 QUIT
"RTN","SYNDHP09",7,0)
 ;
"RTN","SYNDHP09",8,0)
 ; ---------------- Get patient health factors ------------------------------
"RTN","SYNDHP09",9,0)
 ;
"RTN","SYNDHP09",10,0)
PATHLF(RETSTA,NAME,SSN,DOB,GENDER,FRDAT,TODAT,RETJSON) ; get health factors for a patient by traits
"RTN","SYNDHP09",11,0)
 S RETSTA="-1^This service has been retired"
"RTN","SYNDHP09",12,0)
 QUIT
"RTN","SYNDHP09",13,0)
 ;
"RTN","SYNDHP09",14,0)
 ; Return patient health factors for name, SSN, DOB, and gender
"RTN","SYNDHP09",15,0)
 ;
"RTN","SYNDHP09",16,0)
 ; Input:
"RTN","SYNDHP09",17,0)
 ;   NAME    - patient name
"RTN","SYNDHP09",18,0)
 ;   SSN     - social security number
"RTN","SYNDHP09",19,0)
 ;   DOB     - date of birth
"RTN","SYNDHP09",20,0)
 ;   GENDER  - gender
"RTN","SYNDHP09",21,0)
 ;   FRDAT   - from date (inclusive), optional, compared to Visit Date/Time
"RTN","SYNDHP09",22,0)
 ;   TODAT   - to date (inclusive), optional, compared to Visit Date/Time
"RTN","SYNDHP09",23,0)
 ;   RETJSON - J = Return JSON
"RTN","SYNDHP09",24,0)
 ;             F = Return FHIR
"RTN","SYNDHP09",25,0)
 ;             0 or null = Return health factors string (default)
"RTN","SYNDHP09",26,0)
 ; Output:
"RTN","SYNDHP09",27,0)
 ;   RETSTA  - a delimited string that lists SNOMED CDT codes for the patient health factors
"RTN","SYNDHP09",28,0)
 ;           - ICN^SCT code|HF Name|Resource ID|HF Severity|Encounter Provider|Visit Date^SCT code...   
"RTN","SYNDHP09",29,0)
 ;          or patient health factors in JSON format
"RTN","SYNDHP09",30,0)
 ;
"RTN","SYNDHP09",31,0)
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
"RTN","SYNDHP09",32,0)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
"RTN","SYNDHP09",33,0)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
"RTN","SYNDHP09",34,0)
 ;
"RTN","SYNDHP09",35,0)
 N ICNST
"RTN","SYNDHP09",36,0)
 D PATVAL^SYNDHP43(.ICNST,NAME,SSN,DOB,GENDER)
"RTN","SYNDHP09",37,0)
 I +ICNST'=1 S RETSTA=ICNST QUIT
"RTN","SYNDHP09",38,0)
 N DHPICN S DHPICN=$P(ICNST,U,3)
"RTN","SYNDHP09",39,0)
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP09",40,0)
 ;
"RTN","SYNDHP09",41,0)
 N HFARRAY
"RTN","SYNDHP09",42,0)
 S RETSTA=$$HLFS(.HFARRAY,PATIEN,DHPICN,FRDAT,TODAT)
"RTN","SYNDHP09",43,0)
 ;
"RTN","SYNDHP09",44,0)
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
"RTN","SYNDHP09",45,0)
 ;
"RTN","SYNDHP09",46,0)
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
"RTN","SYNDHP09",47,0)
 . S RETSTA=""
"RTN","SYNDHP09",48,0)
 . D TOJASON^SYNDHPUTL(.HFARRAY,.RETSTA)
"RTN","SYNDHP09",49,0)
 ;
"RTN","SYNDHP09",50,0)
 QUIT
"RTN","SYNDHP09",51,0)
 ;
"RTN","SYNDHP09",52,0)
 ; ---------------- Get patient health factors ------------------------------
"RTN","SYNDHP09",53,0)
 ;
"RTN","SYNDHP09",54,0)
PATHLFI(RETSTA,DHPICN,FRDAT,TODAT,RETJSON) ; Patient health factors for ICN
"RTN","SYNDHP09",55,0)
 ;
"RTN","SYNDHP09",56,0)
 ; Return patient vitals for a given patient ICN
"RTN","SYNDHP09",57,0)
 ;
"RTN","SYNDHP09",58,0)
 ; Input:
"RTN","SYNDHP09",59,0)
 ;   ICN     - unique patient identifier across all VistA systems
"RTN","SYNDHP09",60,0)
 ;   FRDAT   - from date (inclusive), optional, compared to Visit Date/Time
"RTN","SYNDHP09",61,0)
 ;   TODAT   - to date (inclusive), optional, compared to Visit Date/Time
"RTN","SYNDHP09",62,0)
 ;   RETJSON - J = Return JSON
"RTN","SYNDHP09",63,0)
 ;             F = Return FHIR
"RTN","SYNDHP09",64,0)
 ;             0 or null = Return health factors string (default)
"RTN","SYNDHP09",65,0)
 ; Output:
"RTN","SYNDHP09",66,0)
 ;   RETSTA  - a delimited string that list the health factors for the patient
"RTN","SYNDHP09",67,0)
 ;           - ICN^SCT code|HF Name|Resource ID|HF Severity|Encounter Provider|Visit Date^...
"RTN","SYNDHP09",68,0)
 ;          or patient health factors in JSON format
"RTN","SYNDHP09",69,0)
 ;
"RTN","SYNDHP09",70,0)
 ; bypass for CQM
"RTN","SYNDHP09",71,0)
 ; 
"RTN","SYNDHP09",72,0)
 ; ***********
"RTN","SYNDHP09",73,0)
 ; *********** Important Note for open source community
"RTN","SYNDHP09",74,0)
 ; ***********
"RTN","SYNDHP09",75,0)
 ; *********** Perspecta - who developed this source code and have released it to the open source
"RTN","SYNDHP09",76,0)
 ; *********** need the following six lines to remain intact
"RTN","SYNDHP09",77,0)
 ; 
"RTN","SYNDHP09",78,0)
 I DHPICN="2495309561V670720" D  QUIT
"RTN","SYNDHP09",79,0)
 . S RETSTA="2495309561V670720^75624-7|5 or more drinks|442_130_1014|9|9990000033|20170101^24165007|Alcohol Counseling and Treatment|442_130_101||9990000033|20170101"
"RTN","SYNDHP09",80,0)
 I DHPICN="1686299845V246594" D  QUIT
"RTN","SYNDHP09",81,0)
 . S RETSTA="1686299845V246594^44249-1|PHQ-9|442_130_1014|4.0|9990000033|20170101"
"RTN","SYNDHP09",82,0)
 ;I DHPICN="2495309561V670720" D  QUIT
"RTN","SYNDHP09",83,0)
 ;. S RETSTA="2495309561V670720^24165007|Alcohol Counseling and Treatment|442_130_101||9990000033|20170101"
"RTN","SYNDHP09",84,0)
 ;
"RTN","SYNDHP09",85,0)
 ; *********** the above lines will be redacted by Perspecta at some suitable juncture to 
"RTN","SYNDHP09",86,0)
 ; *********** be determined by Perspecta
"RTN","SYNDHP09",87,0)
 ; ***********
"RTN","SYNDHP09",88,0)
 ; *********** End of Important Note for open source community
"RTN","SYNDHP09",89,0)
 ;
"RTN","SYNDHP09",90,0)
 ;HLFCTS_U_SCT_P_HLF
"RTN","SYNDHP09",91,0)
 ;SCTPT_P_HID_P_HFSEV_P_HFPROV_P_HFDATE=HLF
"RTN","SYNDHP09",92,0)
 ;
"RTN","SYNDHP09",93,0)
 ; validate ICN
"RTN","SYNDHP09",94,0)
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
"RTN","SYNDHP09",95,0)
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" QUIT
"RTN","SYNDHP09",96,0)
 ; 
"RTN","SYNDHP09",97,0)
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
"RTN","SYNDHP09",98,0)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
"RTN","SYNDHP09",99,0)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
"RTN","SYNDHP09",100,0)
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
"RTN","SYNDHP09",101,0)
 ;
"RTN","SYNDHP09",102,0)
 ; get patient IEN from ICN
"RTN","SYNDHP09",103,0)
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP09",104,0)
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
"RTN","SYNDHP09",105,0)
 ;
"RTN","SYNDHP09",106,0)
 N HFARRAY
"RTN","SYNDHP09",107,0)
 S RETSTA=$$HLFS(.HFARRAY,PATIEN,DHPICN,FRDAT,TODAT)
"RTN","SYNDHP09",108,0)
 ;
"RTN","SYNDHP09",109,0)
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
"RTN","SYNDHP09",110,0)
 ;
"RTN","SYNDHP09",111,0)
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
"RTN","SYNDHP09",112,0)
 . S RETSTA=""
"RTN","SYNDHP09",113,0)
 . D TOJASON^SYNDHPUTL(.HFARRAY,.RETSTA)
"RTN","SYNDHP09",114,0)
 ;
"RTN","SYNDHP09",115,0)
 QUIT
"RTN","SYNDHP09",116,0)
 ;
"RTN","SYNDHP09",117,0)
HLFS(HFARRAY,PATIEN,DHPICN,FRDAT,TODAT) ; get health factors for a patient
"RTN","SYNDHP09",118,0)
 ; build the array of SNOMED CT codes that correspond to health factors
"RTN","SYNDHP09",119,0)
 ;
"RTN","SYNDHP09",120,0)
 N USER S USER=$$DUZ^SYNDHP69
"RTN","SYNDHP09",121,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP09",122,0)
 N P S P="|"
"RTN","SYNDHP09",123,0)
 N FNUM S FNUM=9000010.23
"RTN","SYNDHP09",124,0)
 N FNBR2 S FNBR2=9000010 ;visit
"RTN","SYNDHP09",125,0)
 I $G(DEBUG) W !,"Health Factors",!
"RTN","SYNDHP09",126,0)
 ;
"RTN","SYNDHP09",127,0)
 ; scan Health Factors C index for DFN
"RTN","SYNDHP09",128,0)
 N VISITID,VISITDT,VISITHL,HID,HFACT,HFACTOR,HFSEV,HFDATE,HFDATEHL
"RTN","SYNDHP09",129,0)
 N HFOPRVNM,HFEPRVNM,HFOPROV,HFEPROV,SCTPT,SCT,ZARR,HLFCTS
"RTN","SYNDHP09",130,0)
 N HIEN S HIEN=""
"RTN","SYNDHP09",131,0)
 F  S HIEN=$O(^AUPNVHF("C",PATIEN,HIEN)) QUIT:HIEN=""  D
"RTN","SYNDHP09",132,0)
 . N HLFACT
"RTN","SYNDHP09",133,0)
 . D GET1HLF^SYNDHP15(.HLFACT,HIEN,0)
"RTN","SYNDHP09",134,0)
 . I $D(HLFACT("HealthFactor","ERROR")) M HFARRAY("HealthFactors",HIEN)=HLFACT QUIT
"RTN","SYNDHP09",135,0)
 . S VISITID=HLFACT("HealthFactor","visitId") ;visit ien
"RTN","SYNDHP09",136,0)
 . S VISITDT=$$GET1^DIQ(FNBR2,VISITID_",",.01,"I") ;visit/admit date&time
"RTN","SYNDHP09",137,0)
 . QUIT:((VISITDT\1)<FRDAT)!((VISITDT\1)>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP09",138,0)
 . S VISITHL=$$FMTHL7^XLFDT(VISITDT) ;hl7 format visit/admit date&time
"RTN","SYNDHP09",139,0)
 . S HID=HLFACT("HealthFactor","resourceId")
"RTN","SYNDHP09",140,0)
 . S HFACT=HLFACT("HealthFactor","hlfNameId") ;health factor ien
"RTN","SYNDHP09",141,0)
 . S HFACTOR=HLFACT("HealthFactor","hlfName") ;health factor name
"RTN","SYNDHP09",142,0)
 . S HFSEV=HLFACT("HealthFactor","levelSeverity") ;level/severity
"RTN","SYNDHP09",143,0)
 . S HFDATE=HLFACT("HealthFactor","eventDateTime") ;event date and time
"RTN","SYNDHP09",144,0)
 . S HFDATEHL=$$FMTHL7^XLFDT(HFDATE) ;event date and time in HL7 format
"RTN","SYNDHP09",145,0)
 . S HFOPROV=HLFACT("HealthFactor","orderingProviderId") ;ordering provider ien
"RTN","SYNDHP09",146,0)
 . S HFOPRVNM=HLFACT("HealthFactor","orderingProvider") ;ordering provider
"RTN","SYNDHP09",147,0)
 . S HFEPROV=HLFACT("HealthFactor","encounterProviderId") ;encounter provider ien
"RTN","SYNDHP09",148,0)
 . S HFEPRVNM=HLFACT("HealthFactor","encounterProvider") ;encounter provider
"RTN","SYNDHP09",149,0)
 . S SCT=HLFACT("HealthFactor","hlfNameSCT")
"RTN","SYNDHP09",150,0)
 . S SCTPT=HFACTOR
"RTN","SYNDHP09",151,0)
 . M HFARRAY("HealthFactors",HIEN)=HLFACT ;
"RTN","SYNDHP09",152,0)
 . ;
"RTN","SYNDHP09",153,0)
 . ; if care plan HF, get SCT from name string
"RTN","SYNDHP09",154,0)
 . I $E(HLFACT("HealthFactor","hlfName"),1,4)="SYN " D
"RTN","SYNDHP09",155,0)
 . . S SCT=$P($P(HLFACT("HealthFactor","hlfName"),"SCT:",2),")",1)
"RTN","SYNDHP09",156,0)
 . ;
"RTN","SYNDHP09",157,0)
 . S ZARR(HIEN)=SCT_P_SCTPT_P_HID_P_HFSEV_P_HFEPRVNM_P_VISITHL
"RTN","SYNDHP09",158,0)
 . ;
"RTN","SYNDHP09",159,0)
 . I $G(DEBUG)=1 D
"RTN","SYNDHP09",160,0)
 . . W !,"Record IEN:",?21,HIEN,!
"RTN","SYNDHP09",161,0)
 . . W "Health Factor:",?21,HFACT,"     ",HFACTOR,!
"RTN","SYNDHP09",162,0)
 . . W "Visit IEN:",?21,VISITID,!
"RTN","SYNDHP09",163,0)
 . . W "Visit Date:",?21,VISITDT,"     ",VISITHL,!
"RTN","SYNDHP09",164,0)
 . . W "Level/Severity:",?21,HFSEV,!
"RTN","SYNDHP09",165,0)
 . . W "Event Date:",?21,HFDATE,"     ",HFDATEHL,!
"RTN","SYNDHP09",166,0)
 . . W "Ordering Provider: ",?21,HFOPROV,"     ",HFOPRVNM,!
"RTN","SYNDHP09",167,0)
 . . W "Encounter Provider:",?21,HFEPROV,"     ",HFEPRVNM,!
"RTN","SYNDHP09",168,0)
 . . W "SCT:",?21,SCT,"     ",SCTPT,!!
"RTN","SYNDHP09",169,0)
 ;
"RTN","SYNDHP09",170,0)
 ; serialize data
"RTN","SYNDHP09",171,0)
 S HIEN=""
"RTN","SYNDHP09",172,0)
 S HLFCTS=DHPICN
"RTN","SYNDHP09",173,0)
 F  S HIEN=$O(ZARR(HIEN)) QUIT:HIEN=""  D
"RTN","SYNDHP09",174,0)
 . S HLFCTS=HLFCTS_U_ZARR(HIEN)
"RTN","SYNDHP09",175,0)
 ;
"RTN","SYNDHP09",176,0)
 QUIT HLFCTS
"RTN","SYNDHP09",177,0)
 ;
"RTN","SYNDHP09",178,0)
 ; ----------- Unit Test -----------
"RTN","SYNDHP09",179,0)
T1 ;
"RTN","SYNDHP09",180,0)
 N ICN S ICN="5000001536V889384"
"RTN","SYNDHP09",181,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP09",182,0)
 N TODAT S TODAT=""
"RTN","SYNDHP09",183,0)
 N JSON S JSON=""
"RTN","SYNDHP09",184,0)
 N RETSTA
"RTN","SYNDHP09",185,0)
 D PATHLFI(.RETSTA,ICN,FRDAT,TODAT,JSON)
"RTN","SYNDHP09",186,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP09",187,0)
 QUIT
"RTN","SYNDHP09",188,0)
 ;
"RTN","SYNDHP09",189,0)
T2 ;
"RTN","SYNDHP09",190,0)
 N ICN S ICN="5000001536V889384"
"RTN","SYNDHP09",191,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP09",192,0)
 N TODAT S TODAT=""
"RTN","SYNDHP09",193,0)
 N JSON S JSON="J"
"RTN","SYNDHP09",194,0)
 N RETSTA
"RTN","SYNDHP09",195,0)
 D PATHLFI(.RETSTA,ICN,FRDAT,TODAT,JSON)
"RTN","SYNDHP09",196,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP09",197,0)
 QUIT
"RTN","SYNDHP09",198,0)
 ;
"RTN","SYNDHP09",199,0)
HLFTEST0 ; all pass ICN
"RTN","SYNDHP09",200,0)
 N ICN S ICN=""
"RTN","SYNDHP09",201,0)
 F  S ICN=$O(^DPT("AFICN",ICN)) Q:ICN=""  D
"RTN","SYNDHP09",202,0)
 .D PATHLFI(.RETSTA,ICN) W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP09",203,0)
 Q
"RTN","SYNDHP09",204,0)
HLFTEST1 ; all pass ICN return those with data
"RTN","SYNDHP09",205,0)
 N ICN S ICN=""
"RTN","SYNDHP09",206,0)
 F  S ICN=$O(^DPT("AFICN",ICN)) Q:ICN=""  D
"RTN","SYNDHP09",207,0)
 .D PATHLFI(.RETSTA,ICN)
"RTN","SYNDHP09",208,0)
 .I $L(RETSTA,"|")>1 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP09",209,0)
 Q
"RTN","SYNDHP10")
0^85^B79393775
"RTN","SYNDHP10",1,0)
SYNDHP10 ; HC/art - HealthConcourse - get institution data ;03/26/2019
"RTN","SYNDHP10",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP10",3,0)
 ;;
"RTN","SYNDHP10",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP10",5,0)
 ;
"RTN","SYNDHP10",6,0)
 QUIT
"RTN","SYNDHP10",7,0)
 ;
"RTN","SYNDHP10",8,0)
 ;-------------------------------------------------------------
"RTN","SYNDHP10",9,0)
 ;
"RTN","SYNDHP10",10,0)
GET1SITE(SITE,SITEIEN,RETJSON,SITEJ) ;get one Institution record
"RTN","SYNDHP10",11,0)
 ;inputs: SITEIEN - Institution IEN
"RTN","SYNDHP10",12,0)
 ;        RETJSON - J = Return JSON
"RTN","SYNDHP10",13,0)
 ;output: SITE  - array of Institution data, by reference
"RTN","SYNDHP10",14,0)
 ;        SITEJ - JSON structure of Institution data, by reference
"RTN","SYNDHP10",15,0)
 ;
"RTN","SYNDHP10",16,0)
 I $G(DEBUG) W !,"--------------------------- Institution -----------------------------",!
"RTN","SYNDHP10",17,0)
 N S S S="_"
"RTN","SYNDHP10",18,0)
 N SITEID S SITEID=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP10",19,0)
 N FNBR1 S FNBR1=4 ;INSTITUTION
"RTN","SYNDHP10",20,0)
 N FNBR2 S FNBR2=4.03 ;CONTACT
"RTN","SYNDHP10",21,0)
 N FNBR3 S FNBR3=4.014 ;ASSOCIATIONS
"RTN","SYNDHP10",22,0)
 N FNBR4 S FNBR4=4.042 ;EFFECTIVE DATE/TIME
"RTN","SYNDHP10",23,0)
 N FNBR5 S FNBR5=4.043 ;TAXONOMY CODE
"RTN","SYNDHP10",24,0)
 N FNBR6 S FNBR6=4.999 ;HISTORY
"RTN","SYNDHP10",25,0)
 N FNBR7 S FNBR7=4.05 ;INSTITUTION ASSOCIATION TYPES
"RTN","SYNDHP10",26,0)
 N FNBR8 S FNBR8=4.9999 ;IDENTIFIER
"RTN","SYNDHP10",27,0)
 N IENS1 S IENS1=SITEIEN_","
"RTN","SYNDHP10",28,0)
 ;
"RTN","SYNDHP10",29,0)
 N SITEARR,SITEERR
"RTN","SYNDHP10",30,0)
 D GETS^DIQ(FNBR1,IENS1,"**","EI","SITEARR","SITEERR")
"RTN","SYNDHP10",31,0)
 ;I $G(DEBUG) W ! ZWRITE SITEARR
"RTN","SYNDHP10",32,0)
 ;I $G(DEBUG),$D(SITEERR) W !,">>ERROR<<" ZWRITE SITEERR
"RTN","SYNDHP10",33,0)
 I $D(SITEERR) D  QUIT
"RTN","SYNDHP10",34,0)
 . S SITE("Site","ERROR")=SITEIEN
"RTN","SYNDHP10",35,0)
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.SITE,.SITEJ)
"RTN","SYNDHP10",36,0)
 S SITE("Site","siteIen")=SITEIEN
"RTN","SYNDHP10",37,0)
 S SITE("Site","resourceType")="Organization"
"RTN","SYNDHP10",38,0)
 S SITE("Site","resourceId")=$$RESID^SYNDHP69("V",SITEID)_S_FNBR1_S_SITEIEN
"RTN","SYNDHP10",39,0)
 S SITE("Site","siteName")=$G(SITEARR(FNBR1,IENS1,.01,"E"))
"RTN","SYNDHP10",40,0)
 S SITE("Site","state")=$G(SITEARR(FNBR1,IENS1,.02,"E"))
"RTN","SYNDHP10",41,0)
 S SITE("Site","stateId")=$G(SITEARR(FNBR1,IENS1,.02,"I"))
"RTN","SYNDHP10",42,0)
 S SITE("Site","district")=$G(SITEARR(FNBR1,IENS1,.03,"E"))
"RTN","SYNDHP10",43,0)
 S SITE("Site","shortName")=$G(SITEARR(FNBR1,IENS1,.05,"E"))
"RTN","SYNDHP10",44,0)
 S SITE("Site","vaTypeCode")=$G(SITEARR(FNBR1,IENS1,.06,"E"))
"RTN","SYNDHP10",45,0)
 S SITE("Site","vaTypeCodeCd")=$G(SITEARR(FNBR1,IENS1,.06,"I"))
"RTN","SYNDHP10",46,0)
 S SITE("Site","region")=$G(SITEARR(FNBR1,IENS1,.07,"E"))
"RTN","SYNDHP10",47,0)
 S SITE("Site","streetAddr1")=$G(SITEARR(FNBR1,IENS1,1.01,"E"))
"RTN","SYNDHP10",48,0)
 S SITE("Site","streetAddr2")=$G(SITEARR(FNBR1,IENS1,1.02,"E"))
"RTN","SYNDHP10",49,0)
 S SITE("Site","city")=$G(SITEARR(FNBR1,IENS1,1.03,"E"))
"RTN","SYNDHP10",50,0)
 S SITE("Site","zip")=$G(SITEARR(FNBR1,IENS1,1.04,"E"))
"RTN","SYNDHP10",51,0)
 S SITE("Site","stAddr1Mailing")=$G(SITEARR(FNBR1,IENS1,4.01,"E"))
"RTN","SYNDHP10",52,0)
 S SITE("Site","stAddr2Mailing")=$G(SITEARR(FNBR1,IENS1,4.02,"E"))
"RTN","SYNDHP10",53,0)
 S SITE("Site","cityMailing")=$G(SITEARR(FNBR1,IENS1,4.03,"E"))
"RTN","SYNDHP10",54,0)
 S SITE("Site","stateMailing")=$G(SITEARR(FNBR1,IENS1,4.04,"E"))
"RTN","SYNDHP10",55,0)
 S SITE("Site","stateMailingId")=$G(SITEARR(FNBR1,IENS1,4.04,"I"))
"RTN","SYNDHP10",56,0)
 S SITE("Site","zipMailing")=$G(SITEARR(FNBR1,IENS1,4.05,"E"))
"RTN","SYNDHP10",57,0)
 S SITE("Site","multiDivisionFacility")=$G(SITEARR(FNBR1,IENS1,5,"E"))
"RTN","SYNDHP10",58,0)
 S SITE("Site","multiDivisionFacilityCd")=$G(SITEARR(FNBR1,IENS1,5,"I"))
"RTN","SYNDHP10",59,0)
 S SITE("Site","status")=$G(SITEARR(FNBR1,IENS1,11,"E"))
"RTN","SYNDHP10",60,0)
 S SITE("Site","statusCd")=$G(SITEARR(FNBR1,IENS1,11,"I"))
"RTN","SYNDHP10",61,0)
 S SITE("Site","facilityType")=$G(SITEARR(FNBR1,IENS1,13,"E"))
"RTN","SYNDHP10",62,0)
 S SITE("Site","facilityTypeId")=$G(SITEARR(FNBR1,IENS1,13,"I"))
"RTN","SYNDHP10",63,0)
 S SITE("Site","npi")=$G(SITEARR(FNBR1,IENS1,41.99,"E"))
"RTN","SYNDHP10",64,0)
 S SITE("Site","acosHospitalId")=$G(SITEARR(FNBR1,IENS1,51,"E"))
"RTN","SYNDHP10",65,0)
 S SITE("Site","facilityDeaNumber")=$G(SITEARR(FNBR1,IENS1,52,"E"))
"RTN","SYNDHP10",66,0)
 S SITE("Site","facilityDeaExpirationDate")=$G(SITEARR(FNBR1,IENS1,52.1,"E"))
"RTN","SYNDHP10",67,0)
 S SITE("Site","facilityDeaExpirationDateFM")=$G(SITEARR(FNBR1,IENS1,52.1,"I"))
"RTN","SYNDHP10",68,0)
 S SITE("Site","facilityDeaExpirationDateHL7")=$$FMTHL7^XLFDT($G(SITEARR(FNBR1,IENS1,52.1,"I")))
"RTN","SYNDHP10",69,0)
 S SITE("Site","facilityDeaExpirationDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SITEARR(FNBR1,IENS1,52.1,"I")))
"RTN","SYNDHP10",70,0)
 S SITE("Site","domain")=$G(SITEARR(FNBR1,IENS1,60,"E"))
"RTN","SYNDHP10",71,0)
 S SITE("Site","domainId")=$G(SITEARR(FNBR1,IENS1,60,"I"))
"RTN","SYNDHP10",72,0)
 S SITE("Site","agencyCode")=$G(SITEARR(FNBR1,IENS1,95,"E"))
"RTN","SYNDHP10",73,0)
 S SITE("Site","agencyCodeCd")=$G(SITEARR(FNBR1,IENS1,95,"I"))
"RTN","SYNDHP10",74,0)
 S SITE("Site","reportingStation")=$G(SITEARR(FNBR1,IENS1,96,"E"))
"RTN","SYNDHP10",75,0)
 S SITE("Site","reportingStationId")=$G(SITEARR(FNBR1,IENS1,96,"I"))
"RTN","SYNDHP10",76,0)
 S SITE("Site","pointerToAgency")=$G(SITEARR(FNBR1,IENS1,97,"E"))
"RTN","SYNDHP10",77,0)
 S SITE("Site","pointerToAgencyId")=$G(SITEARR(FNBR1,IENS1,97,"I"))
"RTN","SYNDHP10",78,0)
 S SITE("Site","stationNumber")=$G(SITEARR(FNBR1,IENS1,99,"E"))
"RTN","SYNDHP10",79,0)
 S SITE("Site","officialVaName")=$G(SITEARR(FNBR1,IENS1,100,"E"))
"RTN","SYNDHP10",80,0)
 S SITE("Site","inactiveFacilityFlag")=$G(SITEARR(FNBR1,IENS1,101,"E"))
"RTN","SYNDHP10",81,0)
 S SITE("Site","inactiveFacilityFlagCd")=$G(SITEARR(FNBR1,IENS1,101,"I"))
"RTN","SYNDHP10",82,0)
 S SITE("Site","billingFacilityName")=$G(SITEARR(FNBR1,IENS1,200,"E"))
"RTN","SYNDHP10",83,0)
 S SITE("Site","currentLocation")=$G(SITEARR(FNBR1,IENS1,720,"E"))
"RTN","SYNDHP10",84,0)
 S SITE("Site","currentLocationCd")=$G(SITEARR(FNBR1,IENS1,720,"I"))
"RTN","SYNDHP10",85,0)
 S SITE("Site","locationTimezone")=$G(SITEARR(FNBR1,IENS1,800,"E"))
"RTN","SYNDHP10",86,0)
 S SITE("Site","locationTimezoneId")=$G(SITEARR(FNBR1,IENS1,800,"I"))
"RTN","SYNDHP10",87,0)
 S SITE("Site","country")=$G(SITEARR(FNBR1,IENS1,801,"E"))
"RTN","SYNDHP10",88,0)
 S SITE("Site","countryId")=$G(SITEARR(FNBR1,IENS1,801,"I"))
"RTN","SYNDHP10",89,0)
 S SITE("Site","timezoneException")=$G(SITEARR(FNBR1,IENS1,802,"E"))
"RTN","SYNDHP10",90,0)
 S SITE("Site","timezoneExceptionCd")=$G(SITEARR(FNBR1,IENS1,802,"I"))
"RTN","SYNDHP10",91,0)
 N IENS2 S IENS2=""
"RTN","SYNDHP10",92,0)
 F  S IENS2=$O(SITEARR(FNBR2,IENS2)) QUIT:IENS2=""  D
"RTN","SYNDHP10",93,0)
 . N CONTACT S CONTACT=$NA(SITE("Site","contacts","contact",+IENS2))
"RTN","SYNDHP10",94,0)
 . S @CONTACT@("contact")=$G(SITEARR(FNBR2,IENS2,.01,"E"))
"RTN","SYNDHP10",95,0)
 . S @CONTACT@("area")=$G(SITEARR(FNBR2,IENS2,.02,"E"))
"RTN","SYNDHP10",96,0)
 . S @CONTACT@("areaId")=$G(SITEARR(FNBR2,IENS2,.02,"I"))
"RTN","SYNDHP10",97,0)
 . S @CONTACT@("phone")=$G(SITEARR(FNBR2,IENS2,.03,"E"))
"RTN","SYNDHP10",98,0)
 . S @CONTACT@("resourceId")=$$RESID^SYNDHP69("V",SITEID)_S_FNBR1_S_SITEIEN_S_FNBR2_S_+IENS2
"RTN","SYNDHP10",99,0)
 N IENS3 S IENS3=""
"RTN","SYNDHP10",100,0)
 F  S IENS3=$O(SITEARR(FNBR3,IENS3)) QUIT:IENS3=""  D
"RTN","SYNDHP10",101,0)
 . N ASSOC S ASSOC=$NA(SITE("Site","associationss","associations",+IENS3))
"RTN","SYNDHP10",102,0)
 . S @ASSOC@("associations")=$G(SITEARR(FNBR3,IENS3,.01,"E"))
"RTN","SYNDHP10",103,0)
 . S @ASSOC@("associationsId")=$G(SITEARR(FNBR3,IENS3,.01,"I"))
"RTN","SYNDHP10",104,0)
 . S @ASSOC@("parentOfAssociation")=$G(SITEARR(FNBR3,IENS3,1,"E"))
"RTN","SYNDHP10",105,0)
 . S @ASSOC@("parentOfAssociationId")=$G(SITEARR(FNBR3,IENS3,1,"I"))
"RTN","SYNDHP10",106,0)
 . S @ASSOC@("resourceId")=$$RESID^SYNDHP69("V",SITEID)_S_FNBR1_S_SITEIEN_S_FNBR3_S_+IENS3
"RTN","SYNDHP10",107,0)
 N IENS4 S IENS4=""
"RTN","SYNDHP10",108,0)
 F  S IENS4=$O(SITEARR(FNBR4,IENS4)) QUIT:IENS4=""  D
"RTN","SYNDHP10",109,0)
 . N EFFDATE S EFFDATE=$NA(SITE("Site","effectiveDateTimes","effectiveDateTime",+IENS4))
"RTN","SYNDHP10",110,0)
 . S @EFFDATE@("effectiveDateTime")=$G(SITEARR(FNBR4,IENS4,.01,"E"))
"RTN","SYNDHP10",111,0)
 . S @EFFDATE@("effectiveDateTimeFM")=$G(SITEARR(FNBR4,IENS4,.01,"I"))
"RTN","SYNDHP10",112,0)
 . S @EFFDATE@("effectiveDateTimeHL7")=$$FMTHL7^XLFDT($G(SITEARR(FNBR4,IENS4,.01,"I")))
"RTN","SYNDHP10",113,0)
 . S @EFFDATE@("effectiveDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(SITEARR(FNBR4,IENS4,.01,"I")))
"RTN","SYNDHP10",114,0)
 . S @EFFDATE@("status")=$G(SITEARR(FNBR4,IENS4,.02,"E"))
"RTN","SYNDHP10",115,0)
 . S @EFFDATE@("statusCd")=$G(SITEARR(FNBR4,IENS4,.02,"I"))
"RTN","SYNDHP10",116,0)
 . S @EFFDATE@("npi")=$G(SITEARR(FNBR4,IENS4,.03,"E"))
"RTN","SYNDHP10",117,0)
 . S @EFFDATE@("resourceId")=$$RESID^SYNDHP69("V",SITEID)_S_FNBR1_S_SITEIEN_S_FNBR4_S_+IENS4
"RTN","SYNDHP10",118,0)
 N IENS5 S IENS5=""
"RTN","SYNDHP10",119,0)
 F  S IENS5=$O(SITEARR(FNBR5,IENS5)) QUIT:IENS5=""  D
"RTN","SYNDHP10",120,0)
 . N TAXON S TAXON=$NA(SITE("Site","taxonomyCodes","taxonomyCode",+IENS5))
"RTN","SYNDHP10",121,0)
 . S @TAXON@("taxonomyCode")=$G(SITEARR(FNBR5,IENS5,.01,"E"))
"RTN","SYNDHP10",122,0)
 . S @TAXON@("taxonomyCodeId")=$G(SITEARR(FNBR5,IENS5,.01,"I"))
"RTN","SYNDHP10",123,0)
 . S @TAXON@("primaryCode")=$G(SITEARR(FNBR5,IENS5,.02,"E"))
"RTN","SYNDHP10",124,0)
 . S @TAXON@("primaryCodeCd")=$G(SITEARR(FNBR5,IENS5,.02,"I"))
"RTN","SYNDHP10",125,0)
 . S @TAXON@("status")=$G(SITEARR(FNBR5,IENS5,.03,"E"))
"RTN","SYNDHP10",126,0)
 . S @TAXON@("statusCd")=$G(SITEARR(FNBR5,IENS5,.03,"I"))
"RTN","SYNDHP10",127,0)
 . S @TAXON@("resourceId")=$$RESID^SYNDHP69("V",SITEID)_S_FNBR1_S_SITEIEN_S_FNBR5_S_+IENS5
"RTN","SYNDHP10",128,0)
 N IENS6 S IENS6=""
"RTN","SYNDHP10",129,0)
 F  S IENS6=$O(SITEARR(FNBR6,IENS6)) QUIT:IENS6=""  D
"RTN","SYNDHP10",130,0)
 . N HISTORY S HISTORY=$NA(SITE("Site","historys","history",+IENS6))
"RTN","SYNDHP10",131,0)
 . S @HISTORY@("effectiveDate")=$G(SITEARR(FNBR6,IENS6,.01,"E"))
"RTN","SYNDHP10",132,0)
 . S @HISTORY@("effectiveDateFM")=$G(SITEARR(FNBR6,IENS6,.01,"I"))
"RTN","SYNDHP10",133,0)
 . S @HISTORY@("effectiveDateHL7")=$$FMTHL7^XLFDT($G(SITEARR(FNBR6,IENS6,.01,"I")))
"RTN","SYNDHP10",134,0)
 . S @HISTORY@("effectiveDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(SITEARR(FNBR6,IENS6,.01,"I")))
"RTN","SYNDHP10",135,0)
 . S @HISTORY@("nameChangedFrom")=$G(SITEARR(FNBR6,IENS6,.02,"E"))
"RTN","SYNDHP10",136,0)
 . S @HISTORY@("officalVaNameChangedFrom")=$G(SITEARR(FNBR6,IENS6,.03,"E"))
"RTN","SYNDHP10",137,0)
 . S @HISTORY@("realignedTo")=$G(SITEARR(FNBR6,IENS6,.05,"E"))
"RTN","SYNDHP10",138,0)
 . S @HISTORY@("realignedToId")=$G(SITEARR(FNBR6,IENS6,.05,"I"))
"RTN","SYNDHP10",139,0)
 . S @HISTORY@("realignedFrom")=$G(SITEARR(FNBR6,IENS6,.06,"E"))
"RTN","SYNDHP10",140,0)
 . S @HISTORY@("realignedFromId")=$G(SITEARR(FNBR6,IENS6,.06,"I"))
"RTN","SYNDHP10",141,0)
 . S @HISTORY@("deactivatedFacilitySta")=$G(SITEARR(FNBR6,IENS6,.07,"E"))
"RTN","SYNDHP10",142,0)
 . S @HISTORY@("deactivatedFacilityStaCd")=$G(SITEARR(FNBR6,IENS6,.07,"I"))
"RTN","SYNDHP10",143,0)
 . S @HISTORY@("activatedFacility")=$G(SITEARR(FNBR6,IENS6,.08,"E"))
"RTN","SYNDHP10",144,0)
 . S @HISTORY@("activatedFacilityCd")=$G(SITEARR(FNBR6,IENS6,.08,"I"))
"RTN","SYNDHP10",145,0)
 . S @HISTORY@("resourceId")=$$RESID^SYNDHP69("V",SITEID)_S_FNBR1_S_SITEIEN_S_FNBR6_S_+IENS6
"RTN","SYNDHP10",146,0)
 N IENS7 S IENS7=""
"RTN","SYNDHP10",147,0)
 F  S IENS7=$O(SITEARR(FNBR7,IENS7)) QUIT:IENS7=""  D
"RTN","SYNDHP10",148,0)
 . N ASSTYPE S ASSTYPE=$NA(SITE("Site","institutionAssociationTypess","institutionAssociationTypes",+IENS7))
"RTN","SYNDHP10",149,0)
 . S @ASSTYPE@("number")=$G(SITEARR(FNBR7,IENS7,.001,"E"))
"RTN","SYNDHP10",150,0)
 . S @ASSTYPE@("name")=$G(SITEARR(FNBR7,IENS7,.01,"E"))
"RTN","SYNDHP10",151,0)
 . S @ASSTYPE@("resourceId")=$$RESID^SYNDHP69("V",SITEID)_S_FNBR1_S_SITEIEN_S_FNBR7_S_+IENS7
"RTN","SYNDHP10",152,0)
 N IENS8 S IENS8=""
"RTN","SYNDHP10",153,0)
 F  S IENS8=$O(SITEARR(FNBR8,IENS8)) QUIT:IENS8=""  D
"RTN","SYNDHP10",154,0)
 . N IDENT S IDENT=$NA(SITE("Site","identifiers","identifier",+IENS8))
"RTN","SYNDHP10",155,0)
 . S @IDENT@("codingSystem")=$G(SITEARR(FNBR8,IENS8,.01,"E"))
"RTN","SYNDHP10",156,0)
 . S @IDENT@("id")=$G(SITEARR(FNBR8,IENS8,.02,"E"))
"RTN","SYNDHP10",157,0)
 . S @IDENT@("effectiveDateTime")=$G(SITEARR(FNBR8,IENS8,.03,"E"))
"RTN","SYNDHP10",158,0)
 . S @IDENT@("effectiveDateTimeFM")=$G(SITEARR(FNBR8,IENS8,.03,"I"))
"RTN","SYNDHP10",159,0)
 . S @IDENT@("effectiveDateTimeHL7")=$$FMTHL7^XLFDT($G(SITEARR(FNBR8,IENS8,.03,"I")))
"RTN","SYNDHP10",160,0)
 . S @IDENT@("effectiveDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(SITEARR(FNBR8,IENS8,.03,"I")))
"RTN","SYNDHP10",161,0)
 . S @IDENT@("status")=$G(SITEARR(FNBR8,IENS8,.04,"E"))
"RTN","SYNDHP10",162,0)
 . S @IDENT@("statusCd")=$G(SITEARR(FNBR8,IENS8,.04,"I"))
"RTN","SYNDHP10",163,0)
 . S @IDENT@("resourceId")=$$RESID^SYNDHP69("V",SITEID)_S_FNBR1_S_SITEIEN_S_FNBR8_S_+IENS8
"RTN","SYNDHP10",164,0)
 ;
"RTN","SYNDHP10",165,0)
 ;I $G(DEBUG) W ! ZWRITE SITE
"RTN","SYNDHP10",166,0)
 ;
"RTN","SYNDHP10",167,0)
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.SITE,.SITEJ)
"RTN","SYNDHP10",168,0)
 ;
"RTN","SYNDHP10",169,0)
 QUIT
"RTN","SYNDHP10",170,0)
 ;
"RTN","SYNDHP11")
0^86^B65286288
"RTN","SYNDHP11",1,0)
SYNDHP11 ; HC/art - HealthConcourse - get problem record ;03/01/2019
"RTN","SYNDHP11",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP11",3,0)
 ;;
"RTN","SYNDHP11",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP11",5,0)
 ;
"RTN","SYNDHP11",6,0)
 QUIT
"RTN","SYNDHP11",7,0)
 ;
"RTN","SYNDHP11",8,0)
 ;-------------------------------------------------------------
"RTN","SYNDHP11",9,0)
 ;
"RTN","SYNDHP11",10,0)
GET1PROB(PROBLEM,PROBIEN,RETJSON,PROBLEMJ) ;get one Patient Problem (Condition) record
"RTN","SYNDHP11",11,0)
 ;inputs: PROBIEN - Problem IEN
"RTN","SYNDHP11",12,0)
 ;        RETJSON - J = Return JSON
"RTN","SYNDHP11",13,0)
 ;output: PROBLEM  - array of problem data, by reference
"RTN","SYNDHP11",14,0)
 ;        PROBLEMJ - JSON structure of problem data, by reference
"RTN","SYNDHP11",15,0)
 ;
"RTN","SYNDHP11",16,0)
 I $G(DEBUG) W !,"----------------------------- Problem -----------------------------",!
"RTN","SYNDHP11",17,0)
 N FNBR1 S FNBR1=9000011 ;PROBLEM
"RTN","SYNDHP11",18,0)
 N FNBR2 S FNBR2=9000011.11 ;PROBLEM:NOTE FACILITY
"RTN","SYNDHP11",19,0)
 N FNBR3 S FNBR3=9000011.1111 ;PROBLEM:NOTE FACILITY:NOTE
"RTN","SYNDHP11",20,0)
 N FNBR4 S FNBR4=9000011.803 ;PROBLEM:MAPPING TARGETS
"RTN","SYNDHP11",21,0)
 N S S S="_"
"RTN","SYNDHP11",22,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP11",23,0)
 N IENS S IENS=PROBIEN_","
"RTN","SYNDHP11",24,0)
 N PROBARR,PROBERR
"RTN","SYNDHP11",25,0)
 D GETS^DIQ(FNBR1,IENS,"**","EI","PROBARR","PROBERR")
"RTN","SYNDHP11",26,0)
 ;I $G(DEBUG) W ! ZWRITE PROBARR
"RTN","SYNDHP11",27,0)
 ;I $G(DEBUG),$D(PROBERR) W ">>ERROR<<",! ZWRITE PROBERR
"RTN","SYNDHP11",28,0)
 I $D(PROBERR) D  QUIT
"RTN","SYNDHP11",29,0)
 . S PROBLEM("Problem","ERROR")=PROBIEN
"RTN","SYNDHP11",30,0)
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.PROBLEM,.PROBLEMJ)
"RTN","SYNDHP11",31,0)
 N PROBCOND S PROBCOND=$NA(PROBLEM("Problem"))
"RTN","SYNDHP11",32,0)
 S @PROBCOND@("problemIen")=PROBIEN
"RTN","SYNDHP11",33,0)
 S @PROBCOND@("resourceType")="Condition"
"RTN","SYNDHP11",34,0)
 S @PROBCOND@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_PROBIEN
"RTN","SYNDHP11",35,0)
 S @PROBCOND@("diagnosisId")=$G(PROBARR(FNBR1,IENS,.01,"I"))
"RTN","SYNDHP11",36,0)
 S @PROBCOND@("diagnosis")=$G(PROBARR(FNBR1,IENS,.01,"E"))
"RTN","SYNDHP11",37,0)
 S @PROBCOND@("patientNameId")=$G(PROBARR(FNBR1,IENS,.02,"I"))
"RTN","SYNDHP11",38,0)
 S @PROBCOND@("patientName")=$G(PROBARR(FNBR1,IENS,.02,"E"))
"RTN","SYNDHP11",39,0)
 S @PROBCOND@("patientICN")=$$GET1^DIQ(2,@PROBCOND@("patientNameId")_",",991.1)
"RTN","SYNDHP11",40,0)
 S @PROBCOND@("dateLastModified")=$G(PROBARR(FNBR1,IENS,.03,"E"))
"RTN","SYNDHP11",41,0)
 S @PROBCOND@("dateLastModifiedFM")=$G(PROBARR(FNBR1,IENS,.03,"I"))
"RTN","SYNDHP11",42,0)
 S @PROBCOND@("dateLastModifiedHL7")=$$FMTHL7^XLFDT($G(PROBARR(FNBR1,IENS,.03,"I")))
"RTN","SYNDHP11",43,0)
 S @PROBCOND@("dateLastModifiedFHIR")=$$FMTFHIR^SYNDHPUTL($G(PROBARR(FNBR1,IENS,.03,"I")))
"RTN","SYNDHP11",44,0)
 S @PROBCOND@("classCd")=$G(PROBARR(FNBR1,IENS,.04,"I"))
"RTN","SYNDHP11",45,0)
 S @PROBCOND@("class")=$G(PROBARR(FNBR1,IENS,.04,"E"))
"RTN","SYNDHP11",46,0)
 S @PROBCOND@("providerNarativeId")=$G(PROBARR(FNBR1,IENS,.05,"I"))
"RTN","SYNDHP11",47,0)
 S @PROBCOND@("providerNarative")=$G(PROBARR(FNBR1,IENS,.05,"E"))
"RTN","SYNDHP11",48,0)
 S @PROBCOND@("facilityId")=$G(PROBARR(FNBR1,IENS,.06,"I"))
"RTN","SYNDHP11",49,0)
 S @PROBCOND@("facility")=$G(PROBARR(FNBR1,IENS,.06,"E"))
"RTN","SYNDHP11",50,0)
 S @PROBCOND@("nmbr")=$G(PROBARR(FNBR1,IENS,.07,"E"))
"RTN","SYNDHP11",51,0)
 S @PROBCOND@("dateEntered")=$G(PROBARR(FNBR1,IENS,.08,"E"))
"RTN","SYNDHP11",52,0)
 S @PROBCOND@("dateEnteredFM")=$G(PROBARR(FNBR1,IENS,.08,"I"))
"RTN","SYNDHP11",53,0)
 S @PROBCOND@("dateEnteredHL7")=$$FMTHL7^XLFDT($G(PROBARR(FNBR1,IENS,.08,"I")))
"RTN","SYNDHP11",54,0)
 S @PROBCOND@("dateEnteredFHIR")=$$FMTFHIR^SYNDHPUTL($G(PROBARR(FNBR1,IENS,.08,"I")))
"RTN","SYNDHP11",55,0)
 S @PROBCOND@("statusCd")=$G(PROBARR(FNBR1,IENS,.12,"I"))
"RTN","SYNDHP11",56,0)
 S @PROBCOND@("status")=$G(PROBARR(FNBR1,IENS,.12,"E"))
"RTN","SYNDHP11",57,0)
 S @PROBCOND@("dateOfOnset")=$G(PROBARR(FNBR1,IENS,.13,"E"))
"RTN","SYNDHP11",58,0)
 S @PROBCOND@("dateOfOnsetFM")=$G(PROBARR(FNBR1,IENS,.13,"I"))
"RTN","SYNDHP11",59,0)
 S @PROBCOND@("dateOfOnsetHL7")=$$FMTHL7^XLFDT($G(PROBARR(FNBR1,IENS,.13,"I")))
"RTN","SYNDHP11",60,0)
 S @PROBCOND@("dateOfOnsetFHIR")=$$FMTFHIR^SYNDHPUTL($G(PROBARR(FNBR1,IENS,.13,"I")))
"RTN","SYNDHP11",61,0)
 S @PROBCOND@("problemId")=$G(PROBARR(FNBR1,IENS,1.01,"I"))
"RTN","SYNDHP11",62,0)
 S @PROBCOND@("problem")=$G(PROBARR(FNBR1,IENS,1.01,"E"))
"RTN","SYNDHP11",63,0)
 S @PROBCOND@("conditionCd")=$G(PROBARR(FNBR1,IENS,1.02,"I"))
"RTN","SYNDHP11",64,0)
 S @PROBCOND@("condition")=$G(PROBARR(FNBR1,IENS,1.02,"E"))
"RTN","SYNDHP11",65,0)
 S @PROBCOND@("enteredById")=$G(PROBARR(FNBR1,IENS,1.03,"I"))
"RTN","SYNDHP11",66,0)
 S @PROBCOND@("enteredBy")=$G(PROBARR(FNBR1,IENS,1.03,"E"))
"RTN","SYNDHP11",67,0)
 S @PROBCOND@("recordingProviderId")=$G(PROBARR(FNBR1,IENS,1.04,"I"))
"RTN","SYNDHP11",68,0)
 S @PROBCOND@("recordingProvider")=$G(PROBARR(FNBR1,IENS,1.04,"E"))
"RTN","SYNDHP11",69,0)
 S @PROBCOND@("responsibleProviderId")=$G(PROBARR(FNBR1,IENS,1.05,"I"))
"RTN","SYNDHP11",70,0)
 S @PROBCOND@("responsibleProvider")=$G(PROBARR(FNBR1,IENS,1.05,"E"))
"RTN","SYNDHP11",71,0)
 S @PROBCOND@("serviceId")=$G(PROBARR(FNBR1,IENS,1.06,"I"))
"RTN","SYNDHP11",72,0)
 S @PROBCOND@("service")=$G(PROBARR(FNBR1,IENS,1.06,"E"))
"RTN","SYNDHP11",73,0)
 S @PROBCOND@("dateResolved")=$G(PROBARR(FNBR1,IENS,1.07,"E"))
"RTN","SYNDHP11",74,0)
 S @PROBCOND@("dateResolvedFM")=$G(PROBARR(FNBR1,IENS,1.07,"I"))
"RTN","SYNDHP11",75,0)
 S @PROBCOND@("dateResolvedHL7")=$$FMTHL7^XLFDT($G(PROBARR(FNBR1,IENS,1.07,"I")))
"RTN","SYNDHP11",76,0)
 S @PROBCOND@("dateResolvedFHIR")=$$FMTFHIR^SYNDHPUTL($G(PROBARR(FNBR1,IENS,1.07,"I")))
"RTN","SYNDHP11",77,0)
 S @PROBCOND@("clinicId")=$G(PROBARR(FNBR1,IENS,1.08,"I"))
"RTN","SYNDHP11",78,0)
 S @PROBCOND@("clinic")=$G(PROBARR(FNBR1,IENS,1.08,"E"))
"RTN","SYNDHP11",79,0)
 S @PROBCOND@("dateRecorded")=$G(PROBARR(FNBR1,IENS,1.09,"E"))
"RTN","SYNDHP11",80,0)
 S @PROBCOND@("dateRecordedFM")=$G(PROBARR(FNBR1,IENS,1.09,"I"))
"RTN","SYNDHP11",81,0)
 S @PROBCOND@("dateRecordedHL7")=$$FMTHL7^XLFDT($G(PROBARR(FNBR1,IENS,1.09,"I")))
"RTN","SYNDHP11",82,0)
 S @PROBCOND@("dateRecordedFHIR")=$$FMTFHIR^SYNDHPUTL($G(PROBARR(FNBR1,IENS,1.09,"I")))
"RTN","SYNDHP11",83,0)
 S @PROBCOND@("serviceConnectedCd")=$G(PROBARR(FNBR1,IENS,1.1,"I"))
"RTN","SYNDHP11",84,0)
 S @PROBCOND@("serviceConnected")=$G(PROBARR(FNBR1,IENS,1.1,"E"))
"RTN","SYNDHP11",85,0)
 S @PROBCOND@("agentOrangeExposureCd")=$G(PROBARR(FNBR1,IENS,1.11,"I"))
"RTN","SYNDHP11",86,0)
 S @PROBCOND@("agentOrangeExposure")=$G(PROBARR(FNBR1,IENS,1.11,"E"))
"RTN","SYNDHP11",87,0)
 S @PROBCOND@("ionizingRadiationExposureCd")=$G(PROBARR(FNBR1,IENS,1.12,"I"))
"RTN","SYNDHP11",88,0)
 S @PROBCOND@("ionizingRadiationExposure")=$G(PROBARR(FNBR1,IENS,1.12,"E"))
"RTN","SYNDHP11",89,0)
 S @PROBCOND@("persianGulfExposureCd")=$G(PROBARR(FNBR1,IENS,1.13,"I"))
"RTN","SYNDHP11",90,0)
 S @PROBCOND@("persianGulfExposure")=$G(PROBARR(FNBR1,IENS,1.13,"E"))
"RTN","SYNDHP11",91,0)
 S @PROBCOND@("priorityCd")=$G(PROBARR(FNBR1,IENS,1.14,"I"))
"RTN","SYNDHP11",92,0)
 S @PROBCOND@("priority")=$G(PROBARR(FNBR1,IENS,1.14,"E"))
"RTN","SYNDHP11",93,0)
 S @PROBCOND@("headAndOrNeckCancerCd")=$G(PROBARR(FNBR1,IENS,1.15,"I"))
"RTN","SYNDHP11",94,0)
 S @PROBCOND@("headAndOrNeckCancer")=$G(PROBARR(FNBR1,IENS,1.15,"E"))
"RTN","SYNDHP11",95,0)
 S @PROBCOND@("militarySexualTraumaCd")=$G(PROBARR(FNBR1,IENS,1.16,"I"))
"RTN","SYNDHP11",96,0)
 S @PROBCOND@("militarySexualTrauma")=$G(PROBARR(FNBR1,IENS,1.16,"E"))
"RTN","SYNDHP11",97,0)
 S @PROBCOND@("combatVeteranCd")=$G(PROBARR(FNBR1,IENS,1.17,"I"))
"RTN","SYNDHP11",98,0)
 S @PROBCOND@("combatVeteran")=$G(PROBARR(FNBR1,IENS,1.17,"E"))
"RTN","SYNDHP11",99,0)
 S @PROBCOND@("shipboardHazardDefenseCd")=$G(PROBARR(FNBR1,IENS,1.18,"I"))
"RTN","SYNDHP11",100,0)
 S @PROBCOND@("shipboardHazardDefense")=$G(PROBARR(FNBR1,IENS,1.18,"E"))
"RTN","SYNDHP11",101,0)
 N FACNOTE
"RTN","SYNDHP11",102,0)
 N IENS2 S IENS2=""
"RTN","SYNDHP11",103,0)
 F  S IENS2=$O(PROBARR(FNBR2,IENS2)) QUIT:IENS2=""  D
"RTN","SYNDHP11",104,0)
 . S FACNOTE=$NA(PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2))
"RTN","SYNDHP11",105,0)
 . S @FACNOTE@("noteFacilityId")=$G(PROBARR(FNBR2,IENS2,.01,"I"))
"RTN","SYNDHP11",106,0)
 . S @FACNOTE@("noteFacility")=$G(PROBARR(FNBR2,IENS2,.01,"E"))
"RTN","SYNDHP11",107,0)
 . S @FACNOTE@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_PROBIEN_S_FNBR2_S_+IENS2
"RTN","SYNDHP11",108,0)
 . N NOTE
"RTN","SYNDHP11",109,0)
 . N IENS3 S IENS3=""
"RTN","SYNDHP11",110,0)
 . F  S IENS3=$O(PROBARR(FNBR3,IENS3)) QUIT:IENS3=""  D
"RTN","SYNDHP11",111,0)
 . . S NOTE=$NA(PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"notes","note",+IENS3))
"RTN","SYNDHP11",112,0)
 . . S @NOTE@("noteNmbr")=$G(PROBARR(FNBR3,IENS3,.01,"E"))
"RTN","SYNDHP11",113,0)
 . . S @NOTE@("noteNarrative")=$G(PROBARR(FNBR3,IENS3,.03,"E"))
"RTN","SYNDHP11",114,0)
 . . S @NOTE@("statusCd")=$G(PROBARR(FNBR3,IENS3,.04,"I"))
"RTN","SYNDHP11",115,0)
 . . S @NOTE@("status")=$G(PROBARR(FNBR3,IENS3,.04,"E"))
"RTN","SYNDHP11",116,0)
 . . S @NOTE@("dateNoteAdded")=$G(PROBARR(FNBR3,IENS3,.05,"E"))
"RTN","SYNDHP11",117,0)
 . . S @NOTE@("dateNoteAddedFM")=$G(PROBARR(FNBR3,IENS3,.05,"I"))
"RTN","SYNDHP11",118,0)
 . . S @NOTE@("dateNoteAddedHL7")=$$FMTHL7^XLFDT($G(PROBARR(FNBR3,IENS3,.05,"I")))
"RTN","SYNDHP11",119,0)
 . . S @NOTE@("dateNoteAddedFHIR")=$$FMTFHIR^SYNDHPUTL($G(PROBARR(FNBR3,IENS3,.05,"I")))
"RTN","SYNDHP11",120,0)
 . . S @NOTE@("authorId")=$G(PROBARR(FNBR3,IENS3,.06,"I"))
"RTN","SYNDHP11",121,0)
 . . S @NOTE@("author")=$G(PROBARR(FNBR3,IENS3,.06,"E"))
"RTN","SYNDHP11",122,0)
 . . S @NOTE@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_PROBIEN_S_FNBR2_S_+IENS2_S_FNBR3_S_+IENS3
"RTN","SYNDHP11",123,0)
 S @PROBCOND@("snomedCTconceptCode")=$G(PROBARR(FNBR1,IENS,80001,"E"))
"RTN","SYNDHP11",124,0)
 S @PROBCOND@("snomedCTdesignationCode")=$G(PROBARR(FNBR1,IENS,80002,"E"))
"RTN","SYNDHP11",125,0)
 S @PROBCOND@("vhatConceptVuid")=$G(PROBARR(FNBR1,IENS,80003,"E"))
"RTN","SYNDHP11",126,0)
 S @PROBCOND@("vhatDesignationVuid")=$G(PROBARR(FNBR1,IENS,80004,"E"))
"RTN","SYNDHP11",127,0)
 S @PROBCOND@("snomedCtToIcdMapStatusCd")=$G(PROBARR(FNBR1,IENS,80005,"E"))
"RTN","SYNDHP11",128,0)
 S @PROBCOND@("snomedCtToIcdMapStatus")=$G(PROBARR(FNBR1,IENS,80005,"E"))
"RTN","SYNDHP11",129,0)
 S @PROBCOND@("uniqueNewTermRequestedCd")=$G(PROBARR(FNBR1,IENS,80101,"E"))
"RTN","SYNDHP11",130,0)
 S @PROBCOND@("uniqueNewTermRequested")=$G(PROBARR(FNBR1,IENS,80101,"E"))
"RTN","SYNDHP11",131,0)
 S @PROBCOND@("uniqueTermRequestComment")=$G(PROBARR(FNBR1,IENS,80102,"E"))
"RTN","SYNDHP11",132,0)
 S @PROBCOND@("dateOfInterestFM")=$G(PROBARR(FNBR1,IENS,80201,"E"))
"RTN","SYNDHP11",133,0)
 S @PROBCOND@("dateOfInterestHL7")=$G(PROBARR(FNBR1,IENS,80201,"E"))
"RTN","SYNDHP11",134,0)
 S @PROBCOND@("codingSystem")=$G(PROBARR(FNBR1,IENS,80202,"E"))
"RTN","SYNDHP11",135,0)
 N MAPTARG
"RTN","SYNDHP11",136,0)
 N IENS4 S IENS4=""
"RTN","SYNDHP11",137,0)
 F  S IENS4=$O(PROBARR(FNBR4,IENS4)) QUIT:IENS4=""  D
"RTN","SYNDHP11",138,0)
 . S MAPTARG=$NA(PROBLEM("Problem","mappingTargets","mappingTarget",+IENS4))
"RTN","SYNDHP11",139,0)
 . S @MAPTARG@("code")=$G(PROBARR(FNBR4,IENS4,.01,"E"))
"RTN","SYNDHP11",140,0)
 . S @MAPTARG@("codingSystem")=$G(PROBARR(FNBR4,IENS4,.02,"E"))
"RTN","SYNDHP11",141,0)
 . S @MAPTARG@("codeDate")=$G(PROBARR(FNBR4,IENS4,.03,"E"))
"RTN","SYNDHP11",142,0)
 . S @MAPTARG@("codeDateFM")=$G(PROBARR(FNBR4,IENS4,.03,"I"))
"RTN","SYNDHP11",143,0)
 . S @MAPTARG@("codeDateHL7")=$$FMTHL7^XLFDT($G(PROBARR(FNBR4,IENS4,.03,"I")))
"RTN","SYNDHP11",144,0)
 . S @MAPTARG@("codeDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PROBARR(FNBR4,IENS4,.03,"I")))
"RTN","SYNDHP11",145,0)
 . S @MAPTARG@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_PROBIEN_S_FNBR4_S_+IENS4
"RTN","SYNDHP11",146,0)
 ;
"RTN","SYNDHP11",147,0)
 ;icd -> snomed
"RTN","SYNDHP11",148,0)
 ; PROBLEM("Problem","diagnosis")=$G(PROBARR(FNBR1,IENS,.01,"E"))
"RTN","SYNDHP11",149,0)
 ;
"RTN","SYNDHP11",150,0)
 ;I $G(DEBUG) W ! ZWRITE PROBLEM
"RTN","SYNDHP11",151,0)
 ;
"RTN","SYNDHP11",152,0)
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.PROBLEM,.PROBLEMJ)
"RTN","SYNDHP11",153,0)
 ;
"RTN","SYNDHP11",154,0)
 QUIT
"RTN","SYNDHP11",155,0)
 ;
"RTN","SYNDHP12")
0^87^B125196184
"RTN","SYNDHP12",1,0)
SYNDHP12 ; HC/art - HealthConcourse - get immunization record ;03/23/2019
"RTN","SYNDHP12",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP12",3,0)
 ;;
"RTN","SYNDHP12",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP12",5,0)
 ;
"RTN","SYNDHP12",6,0)
 QUIT
"RTN","SYNDHP12",7,0)
 ;
"RTN","SYNDHP12",8,0)
 ;-------------------------------------------------------------
"RTN","SYNDHP12",9,0)
 ;
"RTN","SYNDHP12",10,0)
GET1IMMUN(IMMUNIZE,IMMUNIEN,RETJSON,IMMUNIZEJ) ;get one Immunization record
"RTN","SYNDHP12",11,0)
 ;inputs: IMMUNIEN - Immunization IEN
"RTN","SYNDHP12",12,0)
 ;        RETJSON - J = Return JSON
"RTN","SYNDHP12",13,0)
 ;output: IMMUNIZE  - array of Immunization data, by reference
"RTN","SYNDHP12",14,0)
 ;        IMMUNIZEJ - JSON structure of Immunization data, by reference
"RTN","SYNDHP12",15,0)
 ;
"RTN","SYNDHP12",16,0)
 I $G(DEBUG) W !,"--------------------------- Immunize -----------------------------",!
"RTN","SYNDHP12",17,0)
 N S S S="_"
"RTN","SYNDHP12",18,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP12",19,0)
 N FNBR1 S FNBR1=9000010.11 ;V IMMUNIZATION
"RTN","SYNDHP12",20,0)
 N FNBR2 S FNBR2=9000010.112 ;VIS OFFERED/GIVEN TO PATIENT
"RTN","SYNDHP12",21,0)
 N FNBR3 S FNBR3=9000010.113 ;OTHER DIAGNOSIS
"RTN","SYNDHP12",22,0)
 N FNBR4 S FNBR4=9000010.1182 ;DISCLOSED TO
"RTN","SYNDHP12",23,0)
 N FNBR5 S FNBR5=9000010.1111 ;REMARKS
"RTN","SYNDHP12",24,0)
 N FNBR6 S FNBR6=9000010.1126 ;SNOMED CT
"RTN","SYNDHP12",25,0)
 N FNBR7 S FNBR7=9000010.1127 ;LOINC CODES
"RTN","SYNDHP12",26,0)
 N IENS1 S IENS1=IMMUNIEN_","
"RTN","SYNDHP12",27,0)
 ;
"RTN","SYNDHP12",28,0)
 N IMMUNIZEARR,IMMUNIZEERR
"RTN","SYNDHP12",29,0)
 D GETS^DIQ(FNBR1,IENS1,"**","EI","IMMUNIZEARR","IMMUNIZEERR")
"RTN","SYNDHP12",30,0)
 ;I $G(DEBUG) W ! ZWRITE IMMUNIZEARR
"RTN","SYNDHP12",31,0)
 ;I $G(DEBUG),$D(IMMUNIZEERR) W ">>ERROR<<",! ZWRITE IMMUNIZEERR
"RTN","SYNDHP12",32,0)
 I $D(IMMUNIZEERR) D  QUIT
"RTN","SYNDHP12",33,0)
 . S IMMUNIZE("Immunize","ERROR")=IMMUNIEN
"RTN","SYNDHP12",34,0)
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.IMMUNIZE,.IMMUNIZEJ)
"RTN","SYNDHP12",35,0)
 N IMMUNE S IMMUNE=$NA(IMMUNIZE("Immunize"))
"RTN","SYNDHP12",36,0)
 S @IMMUNE@("immunizeIen")=IMMUNIEN
"RTN","SYNDHP12",37,0)
 S @IMMUNE@("resourceType")="Immunization"
"RTN","SYNDHP12",38,0)
 S @IMMUNE@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_IMMUNIEN
"RTN","SYNDHP12",39,0)
 S @IMMUNE@("immunization")=$G(IMMUNIZEARR(FNBR1,IENS1,.01,"E"))
"RTN","SYNDHP12",40,0)
 S @IMMUNE@("immunizationId")=$G(IMMUNIZEARR(FNBR1,IENS1,.01,"I"))
"RTN","SYNDHP12",41,0)
 S @IMMUNE@("patientName")=$G(IMMUNIZEARR(FNBR1,IENS1,.02,"E"))
"RTN","SYNDHP12",42,0)
 S @IMMUNE@("patientNameId")=$G(IMMUNIZEARR(FNBR1,IENS1,.02,"I"))
"RTN","SYNDHP12",43,0)
 S @IMMUNE@("patientICN")=$$GET1^DIQ(2,@IMMUNE@("patientNameId")_",",991.1)
"RTN","SYNDHP12",44,0)
 S @IMMUNE@("visit")=$G(IMMUNIZEARR(FNBR1,IENS1,.03,"E"))
"RTN","SYNDHP12",45,0)
 S @IMMUNE@("visitId")=$G(IMMUNIZEARR(FNBR1,IENS1,.03,"I"))
"RTN","SYNDHP12",46,0)
 S @IMMUNE@("visitFM")=$$GET1^DIQ(9000010,@IMMUNE@("visitId")_",",.01,"I")
"RTN","SYNDHP12",47,0)
 S @IMMUNE@("visitHL7")=$$FMTHL7^XLFDT(@IMMUNE@("visitFM"))
"RTN","SYNDHP12",48,0)
 S @IMMUNE@("visitFHIR")=$$FMTFHIR^SYNDHPUTL(@IMMUNE@("visitFM"))
"RTN","SYNDHP12",49,0)
 S @IMMUNE@("series")=$G(IMMUNIZEARR(FNBR1,IENS1,.04,"E"))
"RTN","SYNDHP12",50,0)
 S @IMMUNE@("seriesCd")=$G(IMMUNIZEARR(FNBR1,IENS1,.04,"I"))
"RTN","SYNDHP12",51,0)
 S @IMMUNE@("lot")=$G(IMMUNIZEARR(FNBR1,IENS1,.05,"E"))
"RTN","SYNDHP12",52,0)
 S @IMMUNE@("lotId")=$G(IMMUNIZEARR(FNBR1,IENS1,.05,"I"))
"RTN","SYNDHP12",53,0)
 S @IMMUNE@("reaction")=$G(IMMUNIZEARR(FNBR1,IENS1,.06,"E"))
"RTN","SYNDHP12",54,0)
 S @IMMUNE@("reactionCd")=$G(IMMUNIZEARR(FNBR1,IENS1,.06,"I"))
"RTN","SYNDHP12",55,0)
 S @IMMUNE@("contraindicated")=$G(IMMUNIZEARR(FNBR1,IENS1,.07,"E"))
"RTN","SYNDHP12",56,0)
 S @IMMUNE@("contraindicatedCd")=$G(IMMUNIZEARR(FNBR1,IENS1,.07,"I"))
"RTN","SYNDHP12",57,0)
 S @IMMUNE@("doseOverride")=$G(IMMUNIZEARR(FNBR1,IENS1,.08,"E"))
"RTN","SYNDHP12",58,0)
 S @IMMUNE@("doseOverrideCd")=$G(IMMUNIZEARR(FNBR1,IENS1,.08,"I"))
"RTN","SYNDHP12",59,0)
 S @IMMUNE@("injectionSite")=$G(IMMUNIZEARR(FNBR1,IENS1,.09,"E"))
"RTN","SYNDHP12",60,0)
 S @IMMUNE@("injectionSiteCd")=$G(IMMUNIZEARR(FNBR1,IENS1,.09,"I"))
"RTN","SYNDHP12",61,0)
 S @IMMUNE@("volume")=$G(IMMUNIZEARR(FNBR1,IENS1,.11,"E"))
"RTN","SYNDHP12",62,0)
 S @IMMUNE@("dateOfVacInfoStatement")=$G(IMMUNIZEARR(FNBR1,IENS1,.12,"E"))
"RTN","SYNDHP12",63,0)
 S @IMMUNE@("dateOfVacInfoStatementFM")=$G(IMMUNIZEARR(FNBR1,IENS1,.12,"I"))
"RTN","SYNDHP12",64,0)
 S @IMMUNE@("dateOfVacInfoStatementHL7")=$$FMTHL7^XLFDT($G(IMMUNIZEARR(FNBR1,IENS1,.12,"I")))
"RTN","SYNDHP12",65,0)
 S @IMMUNE@("dateOfVacInfoStatementFHIR")=$$FMTFHIR^SYNDHPUTL($G(IMMUNIZEARR(FNBR1,IENS1,.12,"I")))
"RTN","SYNDHP12",66,0)
 S @IMMUNE@("createdByVCptEntry")=$G(IMMUNIZEARR(FNBR1,IENS1,.13,"E"))
"RTN","SYNDHP12",67,0)
 S @IMMUNE@("vacEligibility")=$G(IMMUNIZEARR(FNBR1,IENS1,.14,"E"))
"RTN","SYNDHP12",68,0)
 S @IMMUNE@("vacEligibilityId")=$G(IMMUNIZEARR(FNBR1,IENS1,.14,"I"))
"RTN","SYNDHP12",69,0)
 S @IMMUNE@("importFromOutsideRegistry")=$G(IMMUNIZEARR(FNBR1,IENS1,.15,"E"))
"RTN","SYNDHP12",70,0)
 S @IMMUNE@("importFromOutsideRegistryCd")=$G(IMMUNIZEARR(FNBR1,IENS1,.15,"I"))
"RTN","SYNDHP12",71,0)
 S @IMMUNE@("ndc")=$G(IMMUNIZEARR(FNBR1,IENS1,.16,"E"))
"RTN","SYNDHP12",72,0)
 S @IMMUNE@("ndcId")=$G(IMMUNIZEARR(FNBR1,IENS1,.16,"I"))
"RTN","SYNDHP12",73,0)
 S @IMMUNE@("administrativeNotes")=$G(IMMUNIZEARR(FNBR1,IENS1,1,"E"))
"RTN","SYNDHP12",74,0)
 S @IMMUNE@("remarks")=""
"RTN","SYNDHP12",75,0)
 N Z S Z=""
"RTN","SYNDHP12",76,0)
 F  S Z=$O(IMMUNIZEARR(FNBR1,IENS1,1101,Z)) QUIT:'+Z  D
"RTN","SYNDHP12",77,0)
 . S @IMMUNE@("remarks")=@IMMUNE@("remarks")_$G(IMMUNIZEARR(FNBR1,IENS1,1101,Z))
"RTN","SYNDHP12",78,0)
 S @IMMUNE@("eventDateAndTime")=$G(IMMUNIZEARR(FNBR1,IENS1,1201,"E"))
"RTN","SYNDHP12",79,0)
 S @IMMUNE@("eventDateAndTimeFM")=$G(IMMUNIZEARR(FNBR1,IENS1,1201,"I"))
"RTN","SYNDHP12",80,0)
 S @IMMUNE@("eventDateAndTimeHL7")=$$FMTHL7^XLFDT($G(IMMUNIZEARR(FNBR1,IENS1,1201,"I")))
"RTN","SYNDHP12",81,0)
 S @IMMUNE@("eventDateAndTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(IMMUNIZEARR(FNBR1,IENS1,1201,"I")))
"RTN","SYNDHP12",82,0)
 S @IMMUNE@("orderingProvider")=$G(IMMUNIZEARR(FNBR1,IENS1,1202,"E"))
"RTN","SYNDHP12",83,0)
 S @IMMUNE@("orderingProviderId")=$G(IMMUNIZEARR(FNBR1,IENS1,1202,"I"))
"RTN","SYNDHP12",84,0)
 S @IMMUNE@("clinic")=$G(IMMUNIZEARR(FNBR1,IENS1,1203,"E"))
"RTN","SYNDHP12",85,0)
 S @IMMUNE@("clinicId")=$G(IMMUNIZEARR(FNBR1,IENS1,1203,"I"))
"RTN","SYNDHP12",86,0)
 S @IMMUNE@("encounterProvider")=$G(IMMUNIZEARR(FNBR1,IENS1,1204,"E"))
"RTN","SYNDHP12",87,0)
 S @IMMUNE@("encounterProviderId")=$G(IMMUNIZEARR(FNBR1,IENS1,1204,"I"))
"RTN","SYNDHP12",88,0)
 S @IMMUNE@("dateTimeRecorded")=$G(IMMUNIZEARR(FNBR1,IENS1,1205,"E"))
"RTN","SYNDHP12",89,0)
 S @IMMUNE@("dateTimeRecordedFM")=$G(IMMUNIZEARR(FNBR1,IENS1,1205,"I"))
"RTN","SYNDHP12",90,0)
 S @IMMUNE@("dateTimeRecordedHL7")=$$FMTHL7^XLFDT($G(IMMUNIZEARR(FNBR1,IENS1,1205,"I")))
"RTN","SYNDHP12",91,0)
 S @IMMUNE@("dateTimeRecordedFHIR")=$$FMTFHIR^SYNDHPUTL($G(IMMUNIZEARR(FNBR1,IENS1,1205,"I")))
"RTN","SYNDHP12",92,0)
 S @IMMUNE@("immunizationDocumenter")=$G(IMMUNIZEARR(FNBR1,IENS1,1206,"E"))
"RTN","SYNDHP12",93,0)
 S @IMMUNE@("immunizationDocumenterId")=$G(IMMUNIZEARR(FNBR1,IENS1,1206,"I"))
"RTN","SYNDHP12",94,0)
 S @IMMUNE@("lotNumber")=$G(IMMUNIZEARR(FNBR1,IENS1,1207,"E"))
"RTN","SYNDHP12",95,0)
 S @IMMUNE@("lotNumberId")=$G(IMMUNIZEARR(FNBR1,IENS1,1207,"I"))
"RTN","SYNDHP12",96,0)
 S @IMMUNE@("parent")=$G(IMMUNIZEARR(FNBR1,IENS1,1208,"E"))
"RTN","SYNDHP12",97,0)
 S @IMMUNE@("parentId")=$G(IMMUNIZEARR(FNBR1,IENS1,1208,"I"))
"RTN","SYNDHP12",98,0)
 S @IMMUNE@("externalKey")=$G(IMMUNIZEARR(FNBR1,IENS1,1209,"E"))
"RTN","SYNDHP12",99,0)
 S @IMMUNE@("outsideProviderName")=$G(IMMUNIZEARR(FNBR1,IENS1,1210,"E"))
"RTN","SYNDHP12",100,0)
 S @IMMUNE@("ancillaryPov")=$G(IMMUNIZEARR(FNBR1,IENS1,1213,"E"))
"RTN","SYNDHP12",101,0)
 S @IMMUNE@("ancillaryPovId")=$G(IMMUNIZEARR(FNBR1,IENS1,1213,"I"))
"RTN","SYNDHP12",102,0)
 S @IMMUNE@("userLastUpdate")=$G(IMMUNIZEARR(FNBR1,IENS1,1214,"E"))
"RTN","SYNDHP12",103,0)
 S @IMMUNE@("userLastUpdateId")=$G(IMMUNIZEARR(FNBR1,IENS1,1214,"I"))
"RTN","SYNDHP12",104,0)
 S @IMMUNE@("orderingLocation")=$G(IMMUNIZEARR(FNBR1,IENS1,1215,"E"))
"RTN","SYNDHP12",105,0)
 S @IMMUNE@("orderingLocationId")=$G(IMMUNIZEARR(FNBR1,IENS1,1215,"I"))
"RTN","SYNDHP12",106,0)
 S @IMMUNE@("dateTimeEntered")=$G(IMMUNIZEARR(FNBR1,IENS1,1216,"E"))
"RTN","SYNDHP12",107,0)
 S @IMMUNE@("dateTimeEnteredFM")=$G(IMMUNIZEARR(FNBR1,IENS1,1216,"I"))
"RTN","SYNDHP12",108,0)
 S @IMMUNE@("dateTimeEnteredHL7")=$$FMTHL7^XLFDT($G(IMMUNIZEARR(FNBR1,IENS1,1216,"I")))
"RTN","SYNDHP12",109,0)
 S @IMMUNE@("dateTimeEnteredFHIR")=$$FMTFHIR^SYNDHPUTL($G(IMMUNIZEARR(FNBR1,IENS1,1216,"I")))
"RTN","SYNDHP12",110,0)
 S @IMMUNE@("enteredBy")=$G(IMMUNIZEARR(FNBR1,IENS1,1217,"E"))
"RTN","SYNDHP12",111,0)
 S @IMMUNE@("enteredById")=$G(IMMUNIZEARR(FNBR1,IENS1,1217,"I"))
"RTN","SYNDHP12",112,0)
 S @IMMUNE@("dateTimeLastModified")=$G(IMMUNIZEARR(FNBR1,IENS1,1218,"E"))
"RTN","SYNDHP12",113,0)
 S @IMMUNE@("dateTimeLastModifiedFM")=$G(IMMUNIZEARR(FNBR1,IENS1,1218,"I"))
"RTN","SYNDHP12",114,0)
 S @IMMUNE@("dateTimeLastModifiedHL7")=$$FMTHL7^XLFDT($G(IMMUNIZEARR(FNBR1,IENS1,1218,"I")))
"RTN","SYNDHP12",115,0)
 S @IMMUNE@("dateTimeLastModifiedFHIR")=$$FMTFHIR^SYNDHPUTL($G(IMMUNIZEARR(FNBR1,IENS1,1218,"I")))
"RTN","SYNDHP12",116,0)
 S @IMMUNE@("lastModifiedBy")=$G(IMMUNIZEARR(FNBR1,IENS1,1219,"E"))
"RTN","SYNDHP12",117,0)
 S @IMMUNE@("lastModifiedById")=$G(IMMUNIZEARR(FNBR1,IENS1,1219,"I"))
"RTN","SYNDHP12",118,0)
 S @IMMUNE@("warningAcknowledged")=$G(IMMUNIZEARR(FNBR1,IENS1,1220,"E"))
"RTN","SYNDHP12",119,0)
 S @IMMUNE@("warningAcknowledgedCd")=$G(IMMUNIZEARR(FNBR1,IENS1,1220,"I"))
"RTN","SYNDHP12",120,0)
 S @IMMUNE@("timestamp")=$G(IMMUNIZEARR(FNBR1,IENS1,1221,"E"))
"RTN","SYNDHP12",121,0)
 S @IMMUNE@("timestampFM")=$G(IMMUNIZEARR(FNBR1,IENS1,1221,"I"))
"RTN","SYNDHP12",122,0)
 S @IMMUNE@("timestampHL7")=$$FMTHL7^XLFDT($G(IMMUNIZEARR(FNBR1,IENS1,1221,"I")))
"RTN","SYNDHP12",123,0)
 S @IMMUNE@("timestampFHIR")=$$FMTFHIR^SYNDHPUTL($G(IMMUNIZEARR(FNBR1,IENS1,1221,"I")))
"RTN","SYNDHP12",124,0)
 S @IMMUNE@("eventInformationSource")=$G(IMMUNIZEARR(FNBR1,IENS1,1301,"E"))
"RTN","SYNDHP12",125,0)
 S @IMMUNE@("eventInformationSourceId")=$G(IMMUNIZEARR(FNBR1,IENS1,1301,"I"))
"RTN","SYNDHP12",126,0)
 S @IMMUNE@("routeOfAdministration")=$G(IMMUNIZEARR(FNBR1,IENS1,1302,"E"))
"RTN","SYNDHP12",127,0)
 S @IMMUNE@("routeOfAdministrationId")=$G(IMMUNIZEARR(FNBR1,IENS1,1302,"I"))
"RTN","SYNDHP12",128,0)
 S @IMMUNE@("siteOfAdministrationBody")=$G(IMMUNIZEARR(FNBR1,IENS1,1303,"E"))
"RTN","SYNDHP12",129,0)
 S @IMMUNE@("siteOfAdministrationBodyId")=$G(IMMUNIZEARR(FNBR1,IENS1,1303,"I"))
"RTN","SYNDHP12",130,0)
 S @IMMUNE@("primaryDiagnosis")=$G(IMMUNIZEARR(FNBR1,IENS1,1304,"E"))
"RTN","SYNDHP12",131,0)
 S @IMMUNE@("primaryDiagnosisId")=$G(IMMUNIZEARR(FNBR1,IENS1,1304,"I"))
"RTN","SYNDHP12",132,0)
 S @IMMUNE@("dose")=$G(IMMUNIZEARR(FNBR1,IENS1,1312,"E"))
"RTN","SYNDHP12",133,0)
 S @IMMUNE@("dosage")=$G(IMMUNIZEARR(FNBR1,IENS1,1312.5,"E"))
"RTN","SYNDHP12",134,0)
 S @IMMUNE@("doseUnits")=$G(IMMUNIZEARR(FNBR1,IENS1,1313,"E"))
"RTN","SYNDHP12",135,0)
 S @IMMUNE@("doseUnitsId")=$G(IMMUNIZEARR(FNBR1,IENS1,1313,"I"))
"RTN","SYNDHP12",136,0)
 S @IMMUNE@("results")=$G(IMMUNIZEARR(FNBR1,IENS1,1401,"E"))
"RTN","SYNDHP12",137,0)
 S @IMMUNE@("resultsCd")=$G(IMMUNIZEARR(FNBR1,IENS1,1401,"I"))
"RTN","SYNDHP12",138,0)
 S @IMMUNE@("reading")=$G(IMMUNIZEARR(FNBR1,IENS1,1402,"E"))
"RTN","SYNDHP12",139,0)
 S @IMMUNE@("dateTimeRead")=$G(IMMUNIZEARR(FNBR1,IENS1,1403,"E"))
"RTN","SYNDHP12",140,0)
 S @IMMUNE@("dateTimeReadFM")=$G(IMMUNIZEARR(FNBR1,IENS1,1403,"I"))
"RTN","SYNDHP12",141,0)
 S @IMMUNE@("dateTimeReadHL7")=$$FMTHL7^XLFDT($G(IMMUNIZEARR(FNBR1,IENS1,1403,"I")))
"RTN","SYNDHP12",142,0)
 S @IMMUNE@("dateTimeReadFHIR")=$$FMTFHIR^SYNDHPUTL($G(IMMUNIZEARR(FNBR1,IENS1,1403,"I")))
"RTN","SYNDHP12",143,0)
 S @IMMUNE@("reader")=$G(IMMUNIZEARR(FNBR1,IENS1,1404,"E"))
"RTN","SYNDHP12",144,0)
 S @IMMUNE@("readerId")=$G(IMMUNIZEARR(FNBR1,IENS1,1404,"I"))
"RTN","SYNDHP12",145,0)
 S @IMMUNE@("readingRecorded")=$G(IMMUNIZEARR(FNBR1,IENS1,1405,"E"))
"RTN","SYNDHP12",146,0)
 S @IMMUNE@("readingRecordedFM")=$G(IMMUNIZEARR(FNBR1,IENS1,1405,"I"))
"RTN","SYNDHP12",147,0)
 S @IMMUNE@("readingRecordedHL7")=$$FMTHL7^XLFDT($G(IMMUNIZEARR(FNBR1,IENS1,1405,"I")))
"RTN","SYNDHP12",148,0)
 S @IMMUNE@("readingRecordedFHIR")=$$FMTFHIR^SYNDHPUTL($G(IMMUNIZEARR(FNBR1,IENS1,1405,"I")))
"RTN","SYNDHP12",149,0)
 S @IMMUNE@("hoursReadPostInoculation")=$G(IMMUNIZEARR(FNBR1,IENS1,1406,"E"))
"RTN","SYNDHP12",150,0)
 S @IMMUNE@("readingComment")=$G(IMMUNIZEARR(FNBR1,IENS1,1501,"E"))
"RTN","SYNDHP12",151,0)
 S @IMMUNE@("warningOverrideReason")=$G(IMMUNIZEARR(FNBR1,IENS1,1601,"E"))
"RTN","SYNDHP12",152,0)
 S @IMMUNE@("editedFlag")=$G(IMMUNIZEARR(FNBR1,IENS1,80101,"E"))
"RTN","SYNDHP12",153,0)
 S @IMMUNE@("editedFlagCd")=$G(IMMUNIZEARR(FNBR1,IENS1,80101,"I"))
"RTN","SYNDHP12",154,0)
 S @IMMUNE@("auditTrail")=$G(IMMUNIZEARR(FNBR1,IENS1,80102,"E"))
"RTN","SYNDHP12",155,0)
 S @IMMUNE@("comments")=$G(IMMUNIZEARR(FNBR1,IENS1,81101,"E"))
"RTN","SYNDHP12",156,0)
 S @IMMUNE@("verified")=$G(IMMUNIZEARR(FNBR1,IENS1,81201,"E"))
"RTN","SYNDHP12",157,0)
 S @IMMUNE@("verifiedCd")=$G(IMMUNIZEARR(FNBR1,IENS1,81201,"I"))
"RTN","SYNDHP12",158,0)
 S @IMMUNE@("package")=$G(IMMUNIZEARR(FNBR1,IENS1,81202,"E"))
"RTN","SYNDHP12",159,0)
 S @IMMUNE@("packageId")=$G(IMMUNIZEARR(FNBR1,IENS1,81202,"I"))
"RTN","SYNDHP12",160,0)
 S @IMMUNE@("dataSource")=$G(IMMUNIZEARR(FNBR1,IENS1,81203,"E"))
"RTN","SYNDHP12",161,0)
 S @IMMUNE@("dataSourceId")=$G(IMMUNIZEARR(FNBR1,IENS1,81203,"I"))
"RTN","SYNDHP12",162,0)
 N OFFER
"RTN","SYNDHP12",163,0)
 N IENS2 S IENS2=""
"RTN","SYNDHP12",164,0)
 F  S IENS2=$O(IMMUNIZEARR(FNBR2,IENS2)) QUIT:IENS2=""  D
"RTN","SYNDHP12",165,0)
 . S OFFER=$NA(IMMUNIZE("Immunize","visOfferedGivenToPatients","visOfferedGivenToPatient",+IENS2))
"RTN","SYNDHP12",166,0)
 . S @OFFER@("visOfferedGivenToPatient")=$G(IMMUNIZEARR(FNBR2,IENS2,.01,"E"))
"RTN","SYNDHP12",167,0)
 . S @OFFER@("visOfferedGivenToPatientId")=$G(IMMUNIZEARR(FNBR2,IENS2,.01,"I"))
"RTN","SYNDHP12",168,0)
 . S @OFFER@("dateVisOfferedGiven")=$G(IMMUNIZEARR(FNBR2,IENS2,.02,"E"))
"RTN","SYNDHP12",169,0)
 . S @OFFER@("dateVisOfferedGivenFM")=$G(IMMUNIZEARR(FNBR2,IENS2,.02,"I"))
"RTN","SYNDHP12",170,0)
 . S @OFFER@("dateVisOfferedGivenHL7")=$$FMTHL7^XLFDT($G(IMMUNIZEARR(FNBR2,IENS2,.02,"I")))
"RTN","SYNDHP12",171,0)
 . S @OFFER@("dateVisOfferedGivenFHIR")=$$FMTFHIR^SYNDHPUTL($G(IMMUNIZEARR(FNBR2,IENS2,.02,"I")))
"RTN","SYNDHP12",172,0)
 . S @OFFER@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_IMMUNIEN_S_FNBR2_S_+IENS2
"RTN","SYNDHP12",173,0)
 N OTHERDX
"RTN","SYNDHP12",174,0)
 N IENS3 S IENS3=""
"RTN","SYNDHP12",175,0)
 F  S IENS3=$O(IMMUNIZEARR(FNBR3,IENS3)) QUIT:IENS3=""  D
"RTN","SYNDHP12",176,0)
 . S OTHERDX=$NA(IMMUNIZE("Immunize","otherDiagnosiss","otherDiagnosis",+IENS3))
"RTN","SYNDHP12",177,0)
 . S @OTHERDX@("otherDiagnosis")=$G(IMMUNIZEARR(FNBR3,IENS3,.01,"E"))
"RTN","SYNDHP12",178,0)
 . S @OTHERDX@("otherDiagnosisId")=$G(IMMUNIZEARR(FNBR3,IENS3,.01,"I"))
"RTN","SYNDHP12",179,0)
 . S @OTHERDX@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_IMMUNIEN_S_FNBR3_S_+IENS3
"RTN","SYNDHP12",180,0)
 N DISCLOSE
"RTN","SYNDHP12",181,0)
 N IENS4 S IENS4=""
"RTN","SYNDHP12",182,0)
 F  S IENS4=$O(IMMUNIZEARR(FNBR4,IENS4)) QUIT:IENS4=""  D
"RTN","SYNDHP12",183,0)
 . S DISCLOSE=$NA(IMMUNIZE("Immunize","disclosedTos","disclosedTo",+IENS4))
"RTN","SYNDHP12",184,0)
 . S @DISCLOSE@("agency")=$G(IMMUNIZEARR(FNBR4,IENS4,.01,"E"))
"RTN","SYNDHP12",185,0)
 . S @DISCLOSE@("agencyId")=$G(IMMUNIZEARR(FNBR4,IENS4,.01,"I"))
"RTN","SYNDHP12",186,0)
 . S @DISCLOSE@("disclosureDateTime")=$G(IMMUNIZEARR(FNBR4,IENS4,.02,"E"))
"RTN","SYNDHP12",187,0)
 . S @DISCLOSE@("disclosureDateTimeFM")=$G(IMMUNIZEARR(FNBR4,IENS4,.02,"I"))
"RTN","SYNDHP12",188,0)
 . S @DISCLOSE@("disclosureDateTimeHL7")=$$FMTHL7^XLFDT($G(IMMUNIZEARR(FNBR4,IENS4,.02,"I")))
"RTN","SYNDHP12",189,0)
 . S @DISCLOSE@("disclosureDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(IMMUNIZEARR(FNBR4,IENS4,.02,"I")))
"RTN","SYNDHP12",190,0)
 . S @DISCLOSE@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_IMMUNIEN_S_FNBR4_S_+IENS4
"RTN","SYNDHP12",191,0)
 ;N IENS5 S IENS5="" ;Word processing field 1101 above
"RTN","SYNDHP12",192,0)
 ;F  S IENS5=$O(IMMUNIZEARR(FNBR5,IENS5)) QUIT:IENS5=""  D
"RTN","SYNDHP12",193,0)
 ;. S IMMUNIZE("Immunize","remarkss","remarks",+IENS5,"remarks")=$G(IMMUNIZEARR(FNBR5,IENS5,.01,"E"))
"RTN","SYNDHP12",194,0)
 N SNOMED
"RTN","SYNDHP12",195,0)
 N IENS6 S IENS6=""
"RTN","SYNDHP12",196,0)
 F  S IENS6=$O(IMMUNIZEARR(FNBR6,IENS6)) QUIT:IENS6=""  D
"RTN","SYNDHP12",197,0)
 . S SNOMED=$NA(IMMUNIZE("Immunize","snomedCts","snomedCt",+IENS6))
"RTN","SYNDHP12",198,0)
 . S @SNOMED@("snomedCt")=$G(IMMUNIZEARR(FNBR6,IENS6,.01,"E"))
"RTN","SYNDHP12",199,0)
 . S @SNOMED@("snomedPreferredTerm")=$G(IMMUNIZEARR(FNBR6,IENS6,.019,"E"))
"RTN","SYNDHP12",200,0)
 . S @SNOMED@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_IMMUNIEN_S_FNBR6_S_+IENS6
"RTN","SYNDHP12",201,0)
 N LOINC
"RTN","SYNDHP12",202,0)
 N IENS7 S IENS7=""
"RTN","SYNDHP12",203,0)
 F  S IENS7=$O(IMMUNIZEARR(FNBR7,IENS7)) QUIT:IENS7=""  D
"RTN","SYNDHP12",204,0)
 . S LOINC=$NA(IMMUNIZE("Immunize","loincCodess","loincCodes",+IENS7))
"RTN","SYNDHP12",205,0)
 . S @LOINC@("loincCodes")=$G(IMMUNIZEARR(FNBR7,IENS7,.01,"E"))
"RTN","SYNDHP12",206,0)
 . S @LOINC@("loincText")=$G(IMMUNIZEARR(FNBR7,IENS7,.019,"E"))
"RTN","SYNDHP12",207,0)
 . S @LOINC@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_IMMUNIEN_S_FNBR7_S_+IENS7
"RTN","SYNDHP12",208,0)
 ;
"RTN","SYNDHP12",209,0)
 ;I $G(DEBUG) W ! ZWRITE IMMUNIZE
"RTN","SYNDHP12",210,0)
 ;
"RTN","SYNDHP12",211,0)
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.IMMUNIZE,.IMMUNIZEJ)
"RTN","SYNDHP12",212,0)
 ;
"RTN","SYNDHP12",213,0)
 QUIT
"RTN","SYNDHP12",214,0)
 ;
"RTN","SYNDHP13")
0^88^B130398518
"RTN","SYNDHP13",1,0)
SYNDHP13 ; HC/art - HealthConcourse - get visit and pov data ;03/26/2019
"RTN","SYNDHP13",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP13",3,0)
 ;;
"RTN","SYNDHP13",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP13",5,0)
 ;
"RTN","SYNDHP13",6,0)
 QUIT
"RTN","SYNDHP13",7,0)
 ;
"RTN","SYNDHP13",8,0)
 ;-------------------------------------------------------------
"RTN","SYNDHP13",9,0)
 ;
"RTN","SYNDHP13",10,0)
GET1VISIT(VISIT,VISITIEN,RETJSON,VISITJ) ;get one Visit record
"RTN","SYNDHP13",11,0)
 ;inputs: VISITIEN - Visit IEN
"RTN","SYNDHP13",12,0)
 ;        RETJSON - J = Return JSON
"RTN","SYNDHP13",13,0)
 ;output: VISIT  - array of Visit data, by reference
"RTN","SYNDHP13",14,0)
 ;        VISITJ - JSON structure of Visit data, by reference
"RTN","SYNDHP13",15,0)
 ;
"RTN","SYNDHP13",16,0)
 I $G(DEBUG) W !,"--------------------------- Visit -----------------------------",!
"RTN","SYNDHP13",17,0)
 N S S S="_"
"RTN","SYNDHP13",18,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP13",19,0)
 N FNBR1 S FNBR1=9000010 ;VISIT
"RTN","SYNDHP13",20,0)
 N IENS1 S IENS1=VISITIEN_","
"RTN","SYNDHP13",21,0)
 N VISITARR,VISITERR
"RTN","SYNDHP13",22,0)
 D GETS^DIQ(FNBR1,IENS1,"**","EI","VISITARR","VISITERR")
"RTN","SYNDHP13",23,0)
 ;I $G(DEBUG) W ! ZWRITE VISITARR
"RTN","SYNDHP13",24,0)
 ;I $G(DEBUG),$D(VISITERR) W ">>ERROR<<",! ZWRITE VISITERR
"RTN","SYNDHP13",25,0)
 I $D(VISITERR) D  QUIT
"RTN","SYNDHP13",26,0)
 . S VISIT("Visit","ERROR")=VISITIEN
"RTN","SYNDHP13",27,0)
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.VISIT,.VISITJ)
"RTN","SYNDHP13",28,0)
 S VISIT("Visit","visitIen")=VISITIEN
"RTN","SYNDHP13",29,0)
 S VISIT("Visit","resourceType")="Encounter"
"RTN","SYNDHP13",30,0)
 S VISIT("Visit","resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_VISITIEN
"RTN","SYNDHP13",31,0)
 S VISIT("Visit","visitAdmitDateTime")=$G(VISITARR(FNBR1,IENS1,.01,"E"))
"RTN","SYNDHP13",32,0)
 S VISIT("Visit","visitAdmitDateTimeFM")=$G(VISITARR(FNBR1,IENS1,.01,"I"))
"RTN","SYNDHP13",33,0)
 S VISIT("Visit","visitAdmitDateTimeHL7")=$$FMTHL7^XLFDT($G(VISITARR(FNBR1,IENS1,.01,"I")))
"RTN","SYNDHP13",34,0)
 S VISIT("Visit","visitAdmitDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(VISITARR(FNBR1,IENS1,.01,"I")))
"RTN","SYNDHP13",35,0)
 S VISIT("Visit","dateVisitCreated")=$G(VISITARR(FNBR1,IENS1,.02,"E"))
"RTN","SYNDHP13",36,0)
 S VISIT("Visit","dateVisitCreatedFM")=$G(VISITARR(FNBR1,IENS1,.02,"I"))
"RTN","SYNDHP13",37,0)
 S VISIT("Visit","dateVisitCreatedHL7")=$$FMTHL7^XLFDT($G(VISITARR(FNBR1,IENS1,.02,"I")))
"RTN","SYNDHP13",38,0)
 S VISIT("Visit","dateVisitCreatedFHIR")=$$FMTFHIR^SYNDHPUTL($G(VISITARR(FNBR1,IENS1,.02,"I")))
"RTN","SYNDHP13",39,0)
 S VISIT("Visit","type")=$G(VISITARR(FNBR1,IENS1,.03,"E"))
"RTN","SYNDHP13",40,0)
 S VISIT("Visit","typeCd")=$G(VISITARR(FNBR1,IENS1,.03,"I"))
"RTN","SYNDHP13",41,0)
 S VISIT("Visit","patientName")=$G(VISITARR(FNBR1,IENS1,.05,"E"))
"RTN","SYNDHP13",42,0)
 S VISIT("Visit","patientNameId")=$G(VISITARR(FNBR1,IENS1,.05,"I"))
"RTN","SYNDHP13",43,0)
 S VISIT("Visit","patientICN")=$$GET1^DIQ(2,VISIT("Visit","patientNameId")_",",991.1)
"RTN","SYNDHP13",44,0)
 S VISIT("Visit","locOfEncounter")=$G(VISITARR(FNBR1,IENS1,.06,"E"))
"RTN","SYNDHP13",45,0)
 S VISIT("Visit","locOfEncounterId")=$G(VISITARR(FNBR1,IENS1,.06,"I"))
"RTN","SYNDHP13",46,0)
 S VISIT("Visit","serviceCategory")=$G(VISITARR(FNBR1,IENS1,.07,"E"))
"RTN","SYNDHP13",47,0)
 S VISIT("Visit","serviceCategoryCd")=$G(VISITARR(FNBR1,IENS1,.07,"I"))
"RTN","SYNDHP13",48,0)
 S VISIT("Visit","dssId")=$G(VISITARR(FNBR1,IENS1,.08,"E"))
"RTN","SYNDHP13",49,0)
 S VISIT("Visit","dssIdId")=$G(VISITARR(FNBR1,IENS1,.08,"I"))
"RTN","SYNDHP13",50,0)
 S VISIT("Visit","dependentEntryCount")=$G(VISITARR(FNBR1,IENS1,.09,"E"))
"RTN","SYNDHP13",51,0)
 S VISIT("Visit","deleteFlag")=$G(VISITARR(FNBR1,IENS1,.11,"E"))
"RTN","SYNDHP13",52,0)
 S VISIT("Visit","deleteFlagCd")=$G(VISITARR(FNBR1,IENS1,.11,"I"))
"RTN","SYNDHP13",53,0)
 S VISIT("Visit","parentVisitLink")=$G(VISITARR(FNBR1,IENS1,.12,"E"))
"RTN","SYNDHP13",54,0)
 S VISIT("Visit","parentVisitLinkId")=$G(VISITARR(FNBR1,IENS1,.12,"I"))
"RTN","SYNDHP13",55,0)
 S VISIT("Visit","dateLastModified")=$G(VISITARR(FNBR1,IENS1,.13,"E"))
"RTN","SYNDHP13",56,0)
 S VISIT("Visit","dateLastModifiedFM")=$G(VISITARR(FNBR1,IENS1,.13,"I"))
"RTN","SYNDHP13",57,0)
 S VISIT("Visit","dateLastModifiedHL7")=$$FMTHL7^XLFDT($G(VISITARR(FNBR1,IENS1,.13,"I")))
"RTN","SYNDHP13",58,0)
 S VISIT("Visit","dateLastModifiedFHIR")=$$FMTFHIR^SYNDHPUTL($G(VISITARR(FNBR1,IENS1,.13,"I")))
"RTN","SYNDHP13",59,0)
 S VISIT("Visit","checkOutDateTime")=$G(VISITARR(FNBR1,IENS1,.18,"E"))
"RTN","SYNDHP13",60,0)
 S VISIT("Visit","checkOutDateTimeFM")=$G(VISITARR(FNBR1,IENS1,.18,"I"))
"RTN","SYNDHP13",61,0)
 S VISIT("Visit","checkOutDateTimeHL7")=$$FMTHL7^XLFDT($G(VISITARR(FNBR1,IENS1,.18,"I")))
"RTN","SYNDHP13",62,0)
 S VISIT("Visit","checkOutDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(VISITARR(FNBR1,IENS1,.18,"I")))
"RTN","SYNDHP13",63,0)
 S VISIT("Visit","eligibility")=$G(VISITARR(FNBR1,IENS1,.21,"E"))
"RTN","SYNDHP13",64,0)
 S VISIT("Visit","eligibilityId")=$G(VISITARR(FNBR1,IENS1,.21,"I"))
"RTN","SYNDHP13",65,0)
 S VISIT("Visit","hospitalLocation")=$G(VISITARR(FNBR1,IENS1,.22,"E"))
"RTN","SYNDHP13",66,0)
 S VISIT("Visit","hospitalLocationId")=$G(VISITARR(FNBR1,IENS1,.22,"I"))
"RTN","SYNDHP13",67,0)
 S VISIT("Visit","createdByUser")=$G(VISITARR(FNBR1,IENS1,.23,"E"))
"RTN","SYNDHP13",68,0)
 S VISIT("Visit","createdByUserId")=$G(VISITARR(FNBR1,IENS1,.23,"I"))
"RTN","SYNDHP13",69,0)
 S VISIT("Visit","optionUsedToCreate")=$G(VISITARR(FNBR1,IENS1,.24,"E"))
"RTN","SYNDHP13",70,0)
 S VISIT("Visit","optionUsedToCreateId")=$G(VISITARR(FNBR1,IENS1,.24,"I"))
"RTN","SYNDHP13",71,0)
 S VISIT("Visit","protocol")=$G(VISITARR(FNBR1,IENS1,.25,"E"))
"RTN","SYNDHP13",72,0)
 S VISIT("Visit","protocolId")=$G(VISITARR(FNBR1,IENS1,.25,"I"))
"RTN","SYNDHP13",73,0)
 S VISIT("Visit","pfssAccountReference")=$G(VISITARR(FNBR1,IENS1,.26,"E"))
"RTN","SYNDHP13",74,0)
 S VISIT("Visit","pfssAccountReferenceId")=$G(VISITARR(FNBR1,IENS1,.26,"I"))
"RTN","SYNDHP13",75,0)
 S VISIT("Visit","outsideLocation")=$G(VISITARR(FNBR1,IENS1,2101,"E"))
"RTN","SYNDHP13",76,0)
 S VISIT("Visit","visitId")=$G(VISITARR(FNBR1,IENS1,15001,"E"))
"RTN","SYNDHP13",77,0)
 S VISIT("Visit","patientStatusInOut")=$G(VISITARR(FNBR1,IENS1,15002,"E"))
"RTN","SYNDHP13",78,0)
 S VISIT("Visit","patientStatusInOutCd")=$G(VISITARR(FNBR1,IENS1,15002,"I"))
"RTN","SYNDHP13",79,0)
 S VISIT("Visit","encounterType")=$G(VISITARR(FNBR1,IENS1,15003,"E"))
"RTN","SYNDHP13",80,0)
 S VISIT("Visit","encounterTypeCd")=$G(VISITARR(FNBR1,IENS1,15003,"I"))
"RTN","SYNDHP13",81,0)
 S VISIT("Visit","serviceConnected")=$G(VISITARR(FNBR1,IENS1,80001,"E"))
"RTN","SYNDHP13",82,0)
 S VISIT("Visit","serviceConnectedCd")=$G(VISITARR(FNBR1,IENS1,80001,"I"))
"RTN","SYNDHP13",83,0)
 S VISIT("Visit","agentOrangeExposure")=$G(VISITARR(FNBR1,IENS1,80002,"E"))
"RTN","SYNDHP13",84,0)
 S VISIT("Visit","agentOrangeExposureCd")=$G(VISITARR(FNBR1,IENS1,80002,"I"))
"RTN","SYNDHP13",85,0)
 S VISIT("Visit","ionizingRadiationExposure")=$G(VISITARR(FNBR1,IENS1,80003,"E"))
"RTN","SYNDHP13",86,0)
 S VISIT("Visit","ionizingRadiationExposureCd")=$G(VISITARR(FNBR1,IENS1,80003,"I"))
"RTN","SYNDHP13",87,0)
 S VISIT("Visit","swAsiaConditions")=$G(VISITARR(FNBR1,IENS1,80004,"E"))
"RTN","SYNDHP13",88,0)
 S VISIT("Visit","swAsiaConditionsCd")=$G(VISITARR(FNBR1,IENS1,80004,"I"))
"RTN","SYNDHP13",89,0)
 S VISIT("Visit","militarySexualTrauma")=$G(VISITARR(FNBR1,IENS1,80005,"E"))
"RTN","SYNDHP13",90,0)
 S VISIT("Visit","militarySexualTraumaCd")=$G(VISITARR(FNBR1,IENS1,80005,"I"))
"RTN","SYNDHP13",91,0)
 S VISIT("Visit","headAndOrNeckCancer")=$G(VISITARR(FNBR1,IENS1,80006,"E"))
"RTN","SYNDHP13",92,0)
 S VISIT("Visit","headAndOrNeckCancerCd")=$G(VISITARR(FNBR1,IENS1,80006,"I"))
"RTN","SYNDHP13",93,0)
 S VISIT("Visit","combatVeteran")=$G(VISITARR(FNBR1,IENS1,80007,"E"))
"RTN","SYNDHP13",94,0)
 S VISIT("Visit","combatVeteranCd")=$G(VISITARR(FNBR1,IENS1,80007,"I"))
"RTN","SYNDHP13",95,0)
 S VISIT("Visit","proj112Shad")=$G(VISITARR(FNBR1,IENS1,80008,"E"))
"RTN","SYNDHP13",96,0)
 S VISIT("Visit","proj112ShadCd")=$G(VISITARR(FNBR1,IENS1,80008,"I"))
"RTN","SYNDHP13",97,0)
 S VISIT("Visit","serviceConnectionEditFlag")=$G(VISITARR(FNBR1,IENS1,80011,"E"))
"RTN","SYNDHP13",98,0)
 S VISIT("Visit","serviceConnectionEditFlagCd")=$G(VISITARR(FNBR1,IENS1,80011,"I"))
"RTN","SYNDHP13",99,0)
 S VISIT("Visit","agentOrangeEditFlag")=$G(VISITARR(FNBR1,IENS1,80012,"E"))
"RTN","SYNDHP13",100,0)
 S VISIT("Visit","agentOrangeEditFlagCd")=$G(VISITARR(FNBR1,IENS1,80012,"I"))
"RTN","SYNDHP13",101,0)
 S VISIT("Visit","ionizingRadiationEditFlag")=$G(VISITARR(FNBR1,IENS1,80013,"E"))
"RTN","SYNDHP13",102,0)
 S VISIT("Visit","ionizingRadiationEditFlagCd")=$G(VISITARR(FNBR1,IENS1,80013,"I"))
"RTN","SYNDHP13",103,0)
 S VISIT("Visit","swAsiaConditionsEditFlag")=$G(VISITARR(FNBR1,IENS1,80014,"E"))
"RTN","SYNDHP13",104,0)
 S VISIT("Visit","swAsiaConditionsEditFlagCd")=$G(VISITARR(FNBR1,IENS1,80014,"I"))
"RTN","SYNDHP13",105,0)
 S VISIT("Visit","mstEditFlag")=$G(VISITARR(FNBR1,IENS1,80015,"E"))
"RTN","SYNDHP13",106,0)
 S VISIT("Visit","mstEditFlagCd")=$G(VISITARR(FNBR1,IENS1,80015,"I"))
"RTN","SYNDHP13",107,0)
 S VISIT("Visit","headAndNeckCancerEditFlag")=$G(VISITARR(FNBR1,IENS1,80016,"E"))
"RTN","SYNDHP13",108,0)
 S VISIT("Visit","headAndNeckCancerEditFlagCd")=$G(VISITARR(FNBR1,IENS1,80016,"I"))
"RTN","SYNDHP13",109,0)
 S VISIT("Visit","combatVeteranEditFlag")=$G(VISITARR(FNBR1,IENS1,80017,"E"))
"RTN","SYNDHP13",110,0)
 S VISIT("Visit","combatVeteranEditFlagCd")=$G(VISITARR(FNBR1,IENS1,80017,"I"))
"RTN","SYNDHP13",111,0)
 S VISIT("Visit","proj112ShadEditFlag")=$G(VISITARR(FNBR1,IENS1,80018,"E"))
"RTN","SYNDHP13",112,0)
 S VISIT("Visit","proj112ShadEditFlagCd")=$G(VISITARR(FNBR1,IENS1,80018,"I"))
"RTN","SYNDHP13",113,0)
 S VISIT("Visit","comments")=$G(VISITARR(FNBR1,IENS1,81101,"E"))
"RTN","SYNDHP13",114,0)
 S VISIT("Visit","package")=$G(VISITARR(FNBR1,IENS1,81202,"E"))
"RTN","SYNDHP13",115,0)
 S VISIT("Visit","packageId")=$G(VISITARR(FNBR1,IENS1,81202,"I"))
"RTN","SYNDHP13",116,0)
 S VISIT("Visit","dataSource")=$G(VISITARR(FNBR1,IENS1,81203,"E"))
"RTN","SYNDHP13",117,0)
 S VISIT("Visit","dataSourceId")=$G(VISITARR(FNBR1,IENS1,81203,"I"))
"RTN","SYNDHP13",118,0)
 ;
"RTN","SYNDHP13",119,0)
 ;I $G(DEBUG) W ! ZWRITE VISIT
"RTN","SYNDHP13",120,0)
 ;
"RTN","SYNDHP13",121,0)
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.VISIT,.VISITJ)
"RTN","SYNDHP13",122,0)
 ;
"RTN","SYNDHP13",123,0)
 QUIT
"RTN","SYNDHP13",124,0)
 ;
"RTN","SYNDHP13",125,0)
 ;-------------------------------------------------------------
"RTN","SYNDHP13",126,0)
 ;
"RTN","SYNDHP13",127,0)
GET1VPOV(VPOV,VPOVIEN,RETJSON,VPOVJ) ;get one V POV record
"RTN","SYNDHP13",128,0)
 ;inputs: VPOVIEN - Vpov IEN
"RTN","SYNDHP13",129,0)
 ;        RETJSON - J = Return JSON
"RTN","SYNDHP13",130,0)
 ;output: VPOV  - array of V POV data, by reference
"RTN","SYNDHP13",131,0)
 ;        VPOVJ - JSON structure of V POV data, by reference
"RTN","SYNDHP13",132,0)
 ;
"RTN","SYNDHP13",133,0)
 I $G(DEBUG) W !,"--------------------------- V POV -----------------------------",!
"RTN","SYNDHP13",134,0)
 N S S S="_"
"RTN","SYNDHP13",135,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP13",136,0)
 N FNBR1 S FNBR1=9000010.07 ;V POV
"RTN","SYNDHP13",137,0)
 N IENS1 S IENS1=VPOVIEN_","
"RTN","SYNDHP13",138,0)
 N VPOVARR,VPOVERR
"RTN","SYNDHP13",139,0)
 D GETS^DIQ(FNBR1,IENS1,"**","EI","VPOVARR","VPOVERR")
"RTN","SYNDHP13",140,0)
 ;I $G(DEBUG) W ! ZWRITE VPOVARR
"RTN","SYNDHP13",141,0)
 ;I $G(DEBUG),$D(VPOVERR) W ">>ERROR<<",! ZWRITE VPOVERR
"RTN","SYNDHP13",142,0)
 I $D(VPOVERR) D  QUIT
"RTN","SYNDHP13",143,0)
 . S VPOV("V POV","ERROR")=VPOVIEN
"RTN","SYNDHP13",144,0)
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.VPOV,.VPOVJ)
"RTN","SYNDHP13",145,0)
 S VPOV("V POV","vpovIen")=VPOVIEN
"RTN","SYNDHP13",146,0)
 S VPOV("V POV","resourceType")="Encounter"
"RTN","SYNDHP13",147,0)
 S VPOV("V POV","resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_VPOVIEN
"RTN","SYNDHP13",148,0)
 S VPOV("V POV","pov")=$G(VPOVARR(FNBR1,IENS1,.01,"E"))
"RTN","SYNDHP13",149,0)
 S VPOV("V POV","povId")=$G(VPOVARR(FNBR1,IENS1,.01,"I"))
"RTN","SYNDHP13",150,0)
 S VPOV("V POV","povDesc")=$P($$ICDDX^ICDEX(VPOV("V POV","pov")),U,4)
"RTN","SYNDHP13",151,0)
 S VPOV("V POV","icdNarrative")=$G(VPOVARR(FNBR1,IENS1,.019,"E"))
"RTN","SYNDHP13",152,0)
 S VPOV("V POV","patientName")=$G(VPOVARR(FNBR1,IENS1,.02,"E"))
"RTN","SYNDHP13",153,0)
 S VPOV("V POV","patientNameId")=$G(VPOVARR(FNBR1,IENS1,.02,"I"))
"RTN","SYNDHP13",154,0)
 S VPOV("V POV","patientICN")=$$GET1^DIQ(2,VPOV("V POV","patientNameId")_",",991.1)
"RTN","SYNDHP13",155,0)
 S VPOV("V POV","visit")=$G(VPOVARR(FNBR1,IENS1,.03,"E"))
"RTN","SYNDHP13",156,0)
 S VPOV("V POV","visitId")=$G(VPOVARR(FNBR1,IENS1,.03,"I"))
"RTN","SYNDHP13",157,0)
 S VPOV("V POV","visitFM")=$$GET1^DIQ(9000010,VPOV("V POV","visitId")_",",.01,"I")
"RTN","SYNDHP13",158,0)
 S VPOV("V POV","visitHL7")=$$FMTHL7^XLFDT(VPOV("V POV","visitFM"))
"RTN","SYNDHP13",159,0)
 S VPOV("V POV","visitFHIR")=$$FMTFHIR^SYNDHPUTL(VPOV("V POV","visitFM"))
"RTN","SYNDHP13",160,0)
 S VPOV("V POV","providerNarrative")=$G(VPOVARR(FNBR1,IENS1,.04,"E"))
"RTN","SYNDHP13",161,0)
 S VPOV("V POV","providerNarrativeId")=$G(VPOVARR(FNBR1,IENS1,.04,"I"))
"RTN","SYNDHP13",162,0)
 S VPOV("V POV","modifier")=$G(VPOVARR(FNBR1,IENS1,.06,"E"))
"RTN","SYNDHP13",163,0)
 S VPOV("V POV","modifierCd")=$G(VPOVARR(FNBR1,IENS1,.06,"I"))
"RTN","SYNDHP13",164,0)
 S VPOV("V POV","primarySecondary")=$G(VPOVARR(FNBR1,IENS1,.12,"E"))
"RTN","SYNDHP13",165,0)
 S VPOV("V POV","primarySecondaryCd")=$G(VPOVARR(FNBR1,IENS1,.12,"I"))
"RTN","SYNDHP13",166,0)
 S VPOV("V POV","dateOfInjury")=$G(VPOVARR(FNBR1,IENS1,.13,"E"))
"RTN","SYNDHP13",167,0)
 S VPOV("V POV","dateOfInjuryFM")=$G(VPOVARR(FNBR1,IENS1,.13,"I"))
"RTN","SYNDHP13",168,0)
 S VPOV("V POV","dateOfInjuryHL7")=$$FMTHL7^XLFDT($G(VPOVARR(FNBR1,IENS1,.13,"I")))
"RTN","SYNDHP13",169,0)
 S VPOV("V POV","dateOfInjuryFHIR")=$$FMTFHIR^SYNDHPUTL($G(VPOVARR(FNBR1,IENS1,.13,"I")))
"RTN","SYNDHP13",170,0)
 S VPOV("V POV","clinicalTerm")=$G(VPOVARR(FNBR1,IENS1,.15,"E"))
"RTN","SYNDHP13",171,0)
 S VPOV("V POV","clinicalTermId")=$G(VPOVARR(FNBR1,IENS1,.15,"I"))
"RTN","SYNDHP13",172,0)
 S VPOV("V POV","problemListEntry")=$G(VPOVARR(FNBR1,IENS1,.16,"E"))
"RTN","SYNDHP13",173,0)
 S VPOV("V POV","problemListEntryId")=$G(VPOVARR(FNBR1,IENS1,.16,"I"))
"RTN","SYNDHP13",174,0)
 S VPOV("V POV","orderingResulting")=$G(VPOVARR(FNBR1,IENS1,.17,"E"))
"RTN","SYNDHP13",175,0)
 S VPOV("V POV","orderingResultingCd")=$G(VPOVARR(FNBR1,IENS1,.17,"I"))
"RTN","SYNDHP13",176,0)
 S VPOV("V POV","mappedSource")=$G(VPOVARR(FNBR1,IENS1,300,"E"))
"RTN","SYNDHP13",177,0)
 S VPOV("V POV","eventDateAndTime")=$G(VPOVARR(FNBR1,IENS1,1201,"E"))
"RTN","SYNDHP13",178,0)
 S VPOV("V POV","eventDateAndTimeFM")=$G(VPOVARR(FNBR1,IENS1,1201,"I"))
"RTN","SYNDHP13",179,0)
 S VPOV("V POV","eventDateAndTimeHL7")=$$FMTHL7^XLFDT($G(VPOVARR(FNBR1,IENS1,1201,"I")))
"RTN","SYNDHP13",180,0)
 S VPOV("V POV","eventDateAndTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(VPOVARR(FNBR1,IENS1,1201,"I")))
"RTN","SYNDHP13",181,0)
 S VPOV("V POV","orderingProvider")=$G(VPOVARR(FNBR1,IENS1,1202,"E"))
"RTN","SYNDHP13",182,0)
 S VPOV("V POV","orderingProviderId")=$G(VPOVARR(FNBR1,IENS1,1202,"I"))
"RTN","SYNDHP13",183,0)
 S VPOV("V POV","encounterProvider")=$G(VPOVARR(FNBR1,IENS1,1204,"E"))
"RTN","SYNDHP13",184,0)
 S VPOV("V POV","encounterProviderId")=$G(VPOVARR(FNBR1,IENS1,1204,"I"))
"RTN","SYNDHP13",185,0)
 S VPOV("V POV","serviceConnected")=$G(VPOVARR(FNBR1,IENS1,80001,"E"))
"RTN","SYNDHP13",186,0)
 S VPOV("V POV","serviceConnectedCd")=$G(VPOVARR(FNBR1,IENS1,80001,"I"))
"RTN","SYNDHP13",187,0)
 S VPOV("V POV","agentOrangeExposure")=$G(VPOVARR(FNBR1,IENS1,80002,"E"))
"RTN","SYNDHP13",188,0)
 S VPOV("V POV","agentOrangeExposureCd")=$G(VPOVARR(FNBR1,IENS1,80002,"I"))
"RTN","SYNDHP13",189,0)
 S VPOV("V POV","ionizingRadiationExposure")=$G(VPOVARR(FNBR1,IENS1,80003,"E"))
"RTN","SYNDHP13",190,0)
 S VPOV("V POV","ionizingRadiationExposureCd")=$G(VPOVARR(FNBR1,IENS1,80003,"I"))
"RTN","SYNDHP13",191,0)
 S VPOV("V POV","swAsiaConditions")=$G(VPOVARR(FNBR1,IENS1,80004,"E"))
"RTN","SYNDHP13",192,0)
 S VPOV("V POV","swAsiaConditionsCd")=$G(VPOVARR(FNBR1,IENS1,80004,"I"))
"RTN","SYNDHP13",193,0)
 S VPOV("V POV","militarySexualTrauma")=$G(VPOVARR(FNBR1,IENS1,80005,"E"))
"RTN","SYNDHP13",194,0)
 S VPOV("V POV","militarySexualTraumaCd")=$G(VPOVARR(FNBR1,IENS1,80005,"I"))
"RTN","SYNDHP13",195,0)
 S VPOV("V POV","headAndOrNeckCancer")=$G(VPOVARR(FNBR1,IENS1,80006,"E"))
"RTN","SYNDHP13",196,0)
 S VPOV("V POV","headAndOrNeckCancerCd")=$G(VPOVARR(FNBR1,IENS1,80006,"I"))
"RTN","SYNDHP13",197,0)
 S VPOV("V POV","combatVeteran")=$G(VPOVARR(FNBR1,IENS1,80007,"E"))
"RTN","SYNDHP13",198,0)
 S VPOV("V POV","combatVeteranCd")=$G(VPOVARR(FNBR1,IENS1,80007,"I"))
"RTN","SYNDHP13",199,0)
 S VPOV("V POV","proj112Shad")=$G(VPOVARR(FNBR1,IENS1,80008,"E"))
"RTN","SYNDHP13",200,0)
 S VPOV("V POV","proj112ShadCd")=$G(VPOVARR(FNBR1,IENS1,80008,"I"))
"RTN","SYNDHP13",201,0)
 S VPOV("V POV","editedFlag")=$G(VPOVARR(FNBR1,IENS1,80101,"E"))
"RTN","SYNDHP13",202,0)
 S VPOV("V POV","editedFlagCd")=$G(VPOVARR(FNBR1,IENS1,80101,"I"))
"RTN","SYNDHP13",203,0)
 S VPOV("V POV","auditTrail")=$G(VPOVARR(FNBR1,IENS1,80102,"E"))
"RTN","SYNDHP13",204,0)
 S VPOV("V POV","providerNarrativeCategory")=$G(VPOVARR(FNBR1,IENS1,80201,"E"))
"RTN","SYNDHP13",205,0)
 S VPOV("V POV","providerNarrativeCategoryId")=$G(VPOVARR(FNBR1,IENS1,80201,"I"))
"RTN","SYNDHP13",206,0)
 S VPOV("V POV","comments")=$G(VPOVARR(FNBR1,IENS1,81101,"E"))
"RTN","SYNDHP13",207,0)
 S VPOV("V POV","verified")=$G(VPOVARR(FNBR1,IENS1,81201,"E"))
"RTN","SYNDHP13",208,0)
 S VPOV("V POV","verifiedCd")=$G(VPOVARR(FNBR1,IENS1,81201,"I"))
"RTN","SYNDHP13",209,0)
 S VPOV("V POV","package")=$G(VPOVARR(FNBR1,IENS1,81202,"E"))
"RTN","SYNDHP13",210,0)
 S VPOV("V POV","packageId")=$G(VPOVARR(FNBR1,IENS1,81202,"I"))
"RTN","SYNDHP13",211,0)
 S VPOV("V POV","dataSource")=$G(VPOVARR(FNBR1,IENS1,81203,"E"))
"RTN","SYNDHP13",212,0)
 S VPOV("V POV","dataSourceId")=$G(VPOVARR(FNBR1,IENS1,81203,"I"))
"RTN","SYNDHP13",213,0)
 ;
"RTN","SYNDHP13",214,0)
 ;get SCT code
"RTN","SYNDHP13",215,0)
 N MAPPING S MAPPING=$S(VPOV("V POV","visitFM")>3150930:"sct2icd",1:"sct2icdnine")
"RTN","SYNDHP13",216,0)
 N SNOMED S SNOMED=$$MAP^SYNDHPMP(MAPPING,VPOV("V POV","pov"),"I")
"RTN","SYNDHP13",217,0)
 S VPOV("V POV","povSCT")=$S(+SNOMED=-1:"",1:$P(SNOMED,U,2))
"RTN","SYNDHP13",218,0)
 ;
"RTN","SYNDHP13",219,0)
 ;I $G(DEBUG) W ! ZWRITE VPOV
"RTN","SYNDHP13",220,0)
 ;
"RTN","SYNDHP13",221,0)
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.VPOV,.VPOVJ)
"RTN","SYNDHP13",222,0)
 ;
"RTN","SYNDHP13",223,0)
 QUIT
"RTN","SYNDHP13",224,0)
 ;
"RTN","SYNDHP14")
0^89^B68521679
"RTN","SYNDHP14",1,0)
SYNDHP14 ; HC/art - HealthConcourse - get visit data ;03/21/2019
"RTN","SYNDHP14",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP14",3,0)
 ;;
"RTN","SYNDHP14",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP14",5,0)
 ;
"RTN","SYNDHP14",6,0)
 QUIT
"RTN","SYNDHP14",7,0)
 ;
"RTN","SYNDHP14",8,0)
 ;-------------------------------------------------------------
"RTN","SYNDHP14",9,0)
 ;
"RTN","SYNDHP14",10,0)
GET1VSCODE(VSCODE,VSCODEIEN,RETJSON,VSCODEJ) ;get one V Standard Codes record
"RTN","SYNDHP14",11,0)
 ;inputs: VSCODEIEN - V Standard Codes IEN
"RTN","SYNDHP14",12,0)
 ;        RETJSON - J = Return JSON
"RTN","SYNDHP14",13,0)
 ;output: VSCODE  - array of V Standard Codes data, by reference
"RTN","SYNDHP14",14,0)
 ;        VSCODEJ - JSON structure of V Standard Codes data, by reference
"RTN","SYNDHP14",15,0)
 ;
"RTN","SYNDHP14",16,0)
 I $G(DEBUG) W !,"V Standard Codes",!
"RTN","SYNDHP14",17,0)
 N S S S="_"
"RTN","SYNDHP14",18,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP14",19,0)
 N FNBR1 S FNBR1=9000010.71 ;V STANDARD CODES
"RTN","SYNDHP14",20,0)
 N IENS1 S IENS1=VSCODEIEN_","
"RTN","SYNDHP14",21,0)
 ;
"RTN","SYNDHP14",22,0)
 N VSCODEARR,VSCODEERR
"RTN","SYNDHP14",23,0)
 D GETS^DIQ(FNBR1,IENS1,"**","EI","VSCODEARR","VSCODEERR")
"RTN","SYNDHP14",24,0)
 ;I $G(DEBUG) W ! ZWRITE VSCODEARR
"RTN","SYNDHP14",25,0)
 ;I $G(DEBUG),$D(VSCODEERR) W ">>ERROR<<",! ZWRITE VSCODEERR
"RTN","SYNDHP14",26,0)
 I $D(VSCODEERR) S VSCODE("Vscode","ERROR")=VSCODEIEN QUIT
"RTN","SYNDHP14",27,0)
 I $D(VSCODEERR) D  QUIT
"RTN","SYNDHP14",28,0)
 . S VSCODE("Vscode","ERROR")=VSCODEIEN
"RTN","SYNDHP14",29,0)
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.VSCODE,.VSCODEJ)
"RTN","SYNDHP14",30,0)
 S VSCODE("Vscode","vscodeIen")=VSCODEIEN
"RTN","SYNDHP14",31,0)
 S VSCODE("Vscode","resourceType")="Encounter"
"RTN","SYNDHP14",32,0)
 S VSCODE("Vscode","resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_VSCODEIEN
"RTN","SYNDHP14",33,0)
 S VSCODE("Vscode","code")=$G(VSCODEARR(FNBR1,IENS1,.01,"E"))
"RTN","SYNDHP14",34,0)
 S VSCODE("Vscode","patientName")=$G(VSCODEARR(FNBR1,IENS1,.02,"E"))
"RTN","SYNDHP14",35,0)
 S VSCODE("Vscode","patientNameId")=$G(VSCODEARR(FNBR1,IENS1,.02,"I"))
"RTN","SYNDHP14",36,0)
 S VSCODE("Vscode","patientICN")=$$GET1^DIQ(2,VSCODE("Vscode","patientNameId")_",",991.1)
"RTN","SYNDHP14",37,0)
 S VSCODE("Vscode","visit")=$G(VSCODEARR(FNBR1,IENS1,.03,"E"))
"RTN","SYNDHP14",38,0)
 S VSCODE("Vscode","visitId")=$G(VSCODEARR(FNBR1,IENS1,.03,"I"))
"RTN","SYNDHP14",39,0)
 S VSCODE("Vscode","visitFM")=$$GET1^DIQ(9000010,VSCODE("Vscode","visitId")_",",.01,"I")
"RTN","SYNDHP14",40,0)
 S VSCODE("Vscode","visitHL7")=$$FMTHL7^XLFDT(VSCODE("Vscode","visitFM"))
"RTN","SYNDHP14",41,0)
 S VSCODE("Vscode","visitFHIR")=$$FMTFHIR^SYNDHPUTL(VSCODE("Vscode","visitFM"))
"RTN","SYNDHP14",42,0)
 S VSCODE("Vscode","codingSystem")=$G(VSCODEARR(FNBR1,IENS1,.05,"E"))
"RTN","SYNDHP14",43,0)
 S VSCODE("Vscode","problemListEntry")=$G(VSCODEARR(FNBR1,IENS1,.06,"E"))
"RTN","SYNDHP14",44,0)
 S VSCODE("Vscode","problemListEntryId")=$G(VSCODEARR(FNBR1,IENS1,.06,"I"))
"RTN","SYNDHP14",45,0)
 S VSCODE("Vscode","magnitude")=$G(VSCODEARR(FNBR1,IENS1,220,"E"))
"RTN","SYNDHP14",46,0)
 S VSCODE("Vscode","ucumCode")=$G(VSCODEARR(FNBR1,IENS1,221,"E"))
"RTN","SYNDHP14",47,0)
 S VSCODE("Vscode","ucumCodeId")=$G(VSCODEARR(FNBR1,IENS1,221,"I"))
"RTN","SYNDHP14",48,0)
 S VSCODE("Vscode","mappedSource")=$G(VSCODEARR(FNBR1,IENS1,300,"E"))
"RTN","SYNDHP14",49,0)
 S VSCODE("Vscode","eventDateAndTime")=$G(VSCODEARR(FNBR1,IENS1,1201,"E"))
"RTN","SYNDHP14",50,0)
 S VSCODE("Vscode","eventDateAndTimeFM")=$G(VSCODEARR(FNBR1,IENS1,1201,"I"))
"RTN","SYNDHP14",51,0)
 S VSCODE("Vscode","eventDateAndTimeHL7")=$$FMTHL7^XLFDT($G(VSCODEARR(FNBR1,IENS1,1201,"I")))
"RTN","SYNDHP14",52,0)
 S VSCODE("Vscode","eventDateAndTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(VSCODEARR(FNBR1,IENS1,1201,"I")))
"RTN","SYNDHP14",53,0)
 S VSCODE("Vscode","orderingProvider")=$G(VSCODEARR(FNBR1,IENS1,1202,"E"))
"RTN","SYNDHP14",54,0)
 S VSCODE("Vscode","orderingProviderId")=$G(VSCODEARR(FNBR1,IENS1,1202,"I"))
"RTN","SYNDHP14",55,0)
 S VSCODE("Vscode","encounterProvider")=$G(VSCODEARR(FNBR1,IENS1,1204,"E"))
"RTN","SYNDHP14",56,0)
 S VSCODE("Vscode","encounterProviderId")=$G(VSCODEARR(FNBR1,IENS1,1204,"I"))
"RTN","SYNDHP14",57,0)
 S VSCODE("Vscode","editedFlag")=$G(VSCODEARR(FNBR1,IENS1,80101,"E"))
"RTN","SYNDHP14",58,0)
 S VSCODE("Vscode","editedFlagCd")=$G(VSCODEARR(FNBR1,IENS1,80101,"I"))
"RTN","SYNDHP14",59,0)
 S VSCODE("Vscode","auditTrail")=$G(VSCODEARR(FNBR1,IENS1,80102,"E"))
"RTN","SYNDHP14",60,0)
 S VSCODE("Vscode","comments")=$G(VSCODEARR(FNBR1,IENS1,81101,"E"))
"RTN","SYNDHP14",61,0)
 S VSCODE("Vscode","verified")=$G(VSCODEARR(FNBR1,IENS1,81201,"E"))
"RTN","SYNDHP14",62,0)
 S VSCODE("Vscode","verifiedCd")=$G(VSCODEARR(FNBR1,IENS1,81201,"I"))
"RTN","SYNDHP14",63,0)
 S VSCODE("Vscode","package")=$G(VSCODEARR(FNBR1,IENS1,81202,"E"))
"RTN","SYNDHP14",64,0)
 S VSCODE("Vscode","packageId")=$G(VSCODEARR(FNBR1,IENS1,81202,"I"))
"RTN","SYNDHP14",65,0)
 S VSCODE("Vscode","dataSource")=$G(VSCODEARR(FNBR1,IENS1,81203,"E"))
"RTN","SYNDHP14",66,0)
 S VSCODE("Vscode","dataSourceId")=$G(VSCODEARR(FNBR1,IENS1,81203,"I"))
"RTN","SYNDHP14",67,0)
 ;
"RTN","SYNDHP14",68,0)
 ;I $G(DEBUG) W ! ZWRITE VSCODE
"RTN","SYNDHP14",69,0)
 ;
"RTN","SYNDHP14",70,0)
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.VSCODE,.VSCODEJ)
"RTN","SYNDHP14",71,0)
 ;
"RTN","SYNDHP14",72,0)
 QUIT
"RTN","SYNDHP14",73,0)
 ;
"RTN","SYNDHP14",74,0)
 ;-------------------------------------------------------------
"RTN","SYNDHP14",75,0)
 ;
"RTN","SYNDHP14",76,0)
GET1VCPT(VCPT,VCPTIEN,RETJSON,VCPTJ) ;get one V CPT record
"RTN","SYNDHP14",77,0)
 ;inputs: VCPTIEN - V CPT IEN
"RTN","SYNDHP14",78,0)
 ;        RETJSON - J = Return JSON
"RTN","SYNDHP14",79,0)
 ;output: VCPT  - array of V CPT data, by reference
"RTN","SYNDHP14",80,0)
 ;        VCPTJ - JSON structure of V CPT data, by reference
"RTN","SYNDHP14",81,0)
 ;
"RTN","SYNDHP14",82,0)
 I $G(DEBUG) W !,"V CPT",!
"RTN","SYNDHP14",83,0)
 N S S S="_"
"RTN","SYNDHP14",84,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP14",85,0)
 N FNBR1 S FNBR1=9000010.18 ;V CPT
"RTN","SYNDHP14",86,0)
 N FNBR2 S FNBR2=9000010.181 ;CPT MODIFIER
"RTN","SYNDHP14",87,0)
 N IENS1 S IENS1=VCPTIEN_","
"RTN","SYNDHP14",88,0)
 ;
"RTN","SYNDHP14",89,0)
 N VCPTARR,VCPTERR
"RTN","SYNDHP14",90,0)
 D GETS^DIQ(FNBR1,IENS1,"**","EI","VCPTARR","VCPTERR")
"RTN","SYNDHP14",91,0)
 ;I $G(DEBUG) W ! ZWRITE VCPTARR
"RTN","SYNDHP14",92,0)
 ;I $G(DEBUG),$D(VCPTERR) W ">>ERROR<<",! ZWRITE VCPTERR
"RTN","SYNDHP14",93,0)
 I $D(VCPTERR) D  QUIT
"RTN","SYNDHP14",94,0)
 . S VCPT("Vcpt","ERROR")=VCPTIEN
"RTN","SYNDHP14",95,0)
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.VCPT,.VCPTJ)
"RTN","SYNDHP14",96,0)
 S VCPT("Vcpt","vcptIen")=VCPTIEN
"RTN","SYNDHP14",97,0)
 S VCPT("Vcpt","resourceType")="Encounter"
"RTN","SYNDHP14",98,0)
 S VCPT("Vcpt","resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_VCPTIEN
"RTN","SYNDHP14",99,0)
 S VCPT("Vcpt","cpt")=$G(VCPTARR(FNBR1,IENS1,.01,"E"))
"RTN","SYNDHP14",100,0)
 S VCPT("Vcpt","cptId")=$G(VCPTARR(FNBR1,IENS1,.01,"I"))
"RTN","SYNDHP14",101,0)
 S VCPT("Vcpt","cptName")=$$GET1^DIQ(81,VCPT("Vcpt","cptId")_",",2)
"RTN","SYNDHP14",102,0)
 S VCPT("Vcpt","patientName")=$G(VCPTARR(FNBR1,IENS1,.02,"E"))
"RTN","SYNDHP14",103,0)
 S VCPT("Vcpt","patientNameId")=$G(VCPTARR(FNBR1,IENS1,.02,"I"))
"RTN","SYNDHP14",104,0)
 S VCPT("Vcpt","patientICN")=$$GET1^DIQ(2,VCPT("Vcpt","patientNameId")_",",991.1)
"RTN","SYNDHP14",105,0)
 S VCPT("Vcpt","visit")=$G(VCPTARR(FNBR1,IENS1,.03,"E"))
"RTN","SYNDHP14",106,0)
 S VCPT("Vcpt","visitId")=$G(VCPTARR(FNBR1,IENS1,.03,"I"))
"RTN","SYNDHP14",107,0)
 S VCPT("Vcpt","visitFM")=$$GET1^DIQ(9000010,VCPT("Vcpt","visitId")_",",.01,"I")
"RTN","SYNDHP14",108,0)
 S VCPT("Vcpt","visitHL7")=$$FMTHL7^XLFDT(VCPT("Vcpt","visitFM"))
"RTN","SYNDHP14",109,0)
 S VCPT("Vcpt","visitFHIR")=$$FMTFHIR^SYNDHPUTL(VCPT("Vcpt","visitFM"))
"RTN","SYNDHP14",110,0)
 S VCPT("Vcpt","providerNarrative")=$G(VCPTARR(FNBR1,IENS1,.04,"E"))
"RTN","SYNDHP14",111,0)
 S VCPT("Vcpt","providerNarrativeId")=$G(VCPTARR(FNBR1,IENS1,.04,"I"))
"RTN","SYNDHP14",112,0)
 S VCPT("Vcpt","diagnosis")=$G(VCPTARR(FNBR1,IENS1,.05,"E"))
"RTN","SYNDHP14",113,0)
 S VCPT("Vcpt","diagnosisId")=$G(VCPTARR(FNBR1,IENS1,.05,"I"))
"RTN","SYNDHP14",114,0)
 S VCPT("Vcpt","principalProcedure")=$G(VCPTARR(FNBR1,IENS1,.07,"E"))
"RTN","SYNDHP14",115,0)
 S VCPT("Vcpt","principalProcedureCd")=$G(VCPTARR(FNBR1,IENS1,.07,"I"))
"RTN","SYNDHP14",116,0)
 S VCPT("Vcpt","diagnosis2")=$G(VCPTARR(FNBR1,IENS1,.09,"E"))
"RTN","SYNDHP14",117,0)
 S VCPT("Vcpt","diagnosis2Id")=$G(VCPTARR(FNBR1,IENS1,.09,"I"))
"RTN","SYNDHP14",118,0)
 S VCPT("Vcpt","diagnosis3")=$G(VCPTARR(FNBR1,IENS1,.1,"E"))
"RTN","SYNDHP14",119,0)
 S VCPT("Vcpt","diagnosis3Id")=$G(VCPTARR(FNBR1,IENS1,.1,"I"))
"RTN","SYNDHP14",120,0)
 S VCPT("Vcpt","diagnosis4")=$G(VCPTARR(FNBR1,IENS1,.11,"E"))
"RTN","SYNDHP14",121,0)
 S VCPT("Vcpt","diagnosis4Id")=$G(VCPTARR(FNBR1,IENS1,.11,"I"))
"RTN","SYNDHP14",122,0)
 S VCPT("Vcpt","diagnosis5")=$G(VCPTARR(FNBR1,IENS1,.12,"E"))
"RTN","SYNDHP14",123,0)
 S VCPT("Vcpt","diagnosis5Id")=$G(VCPTARR(FNBR1,IENS1,.12,"I"))
"RTN","SYNDHP14",124,0)
 S VCPT("Vcpt","diagnosis6")=$G(VCPTARR(FNBR1,IENS1,.13,"E"))
"RTN","SYNDHP14",125,0)
 S VCPT("Vcpt","diagnosis6Id")=$G(VCPTARR(FNBR1,IENS1,.13,"I"))
"RTN","SYNDHP14",126,0)
 S VCPT("Vcpt","diagnosis7")=$G(VCPTARR(FNBR1,IENS1,.14,"E"))
"RTN","SYNDHP14",127,0)
 S VCPT("Vcpt","diagnosis7Id")=$G(VCPTARR(FNBR1,IENS1,.14,"I"))
"RTN","SYNDHP14",128,0)
 S VCPT("Vcpt","diagnosis8")=$G(VCPTARR(FNBR1,IENS1,.15,"E"))
"RTN","SYNDHP14",129,0)
 S VCPT("Vcpt","diagnosis8Id")=$G(VCPTARR(FNBR1,IENS1,.15,"I"))
"RTN","SYNDHP14",130,0)
 S VCPT("Vcpt","quantity")=$G(VCPTARR(FNBR1,IENS1,.16,"E"))
"RTN","SYNDHP14",131,0)
 S VCPT("Vcpt","orderReference")=$G(VCPTARR(FNBR1,IENS1,.17,"E"))
"RTN","SYNDHP14",132,0)
 S VCPT("Vcpt","orderReferenceId")=$G(VCPTARR(FNBR1,IENS1,.17,"I"))
"RTN","SYNDHP14",133,0)
 S VCPT("Vcpt","departmentCode")=$G(VCPTARR(FNBR1,IENS1,.19,"E"))
"RTN","SYNDHP14",134,0)
 S VCPT("Vcpt","pfssChargeId")=$G(VCPTARR(FNBR1,IENS1,.2,"E"))
"RTN","SYNDHP14",135,0)
 S VCPT("Vcpt","mappedSource")=$G(VCPTARR(FNBR1,IENS1,300,"E"))
"RTN","SYNDHP14",136,0)
 S VCPT("Vcpt","eventDateAndTime")=$G(VCPTARR(FNBR1,IENS1,1201,"E"))
"RTN","SYNDHP14",137,0)
 S VCPT("Vcpt","eventDateAndTimeFM")=$G(VCPTARR(FNBR1,IENS1,1201,"I"))
"RTN","SYNDHP14",138,0)
 S VCPT("Vcpt","eventDateAndTimeHL7")=$$FMTHL7^XLFDT($G(VCPTARR(FNBR1,IENS1,1201,"I")))
"RTN","SYNDHP14",139,0)
 S VCPT("Vcpt","eventDateAndTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(VCPTARR(FNBR1,IENS1,1201,"I")))
"RTN","SYNDHP14",140,0)
 S VCPT("Vcpt","orderingProvider")=$G(VCPTARR(FNBR1,IENS1,1202,"E"))
"RTN","SYNDHP14",141,0)
 S VCPT("Vcpt","orderingProviderId")=$G(VCPTARR(FNBR1,IENS1,1202,"I"))
"RTN","SYNDHP14",142,0)
 S VCPT("Vcpt","encounterProvider")=$G(VCPTARR(FNBR1,IENS1,1204,"E"))
"RTN","SYNDHP14",143,0)
 S VCPT("Vcpt","encounterProviderId")=$G(VCPTARR(FNBR1,IENS1,1204,"I"))
"RTN","SYNDHP14",144,0)
 S VCPT("Vcpt","editedFlag")=$G(VCPTARR(FNBR1,IENS1,80101,"E"))
"RTN","SYNDHP14",145,0)
 S VCPT("Vcpt","editedFlagCd")=$G(VCPTARR(FNBR1,IENS1,80101,"I"))
"RTN","SYNDHP14",146,0)
 S VCPT("Vcpt","auditTrail")=$G(VCPTARR(FNBR1,IENS1,80102,"E"))
"RTN","SYNDHP14",147,0)
 S VCPT("Vcpt","providerNarrativeCategory")=$G(VCPTARR(FNBR1,IENS1,80201,"E"))
"RTN","SYNDHP14",148,0)
 S VCPT("Vcpt","providerNarrativeCategoryId")=$G(VCPTARR(FNBR1,IENS1,80201,"I"))
"RTN","SYNDHP14",149,0)
 S VCPT("Vcpt","comments")=$G(VCPTARR(FNBR1,IENS1,81101,"E"))
"RTN","SYNDHP14",150,0)
 S VCPT("Vcpt","verified")=$G(VCPTARR(FNBR1,IENS1,81201,"E"))
"RTN","SYNDHP14",151,0)
 S VCPT("Vcpt","verifiedCd")=$G(VCPTARR(FNBR1,IENS1,81201,"I"))
"RTN","SYNDHP14",152,0)
 S VCPT("Vcpt","package")=$G(VCPTARR(FNBR1,IENS1,81202,"E"))
"RTN","SYNDHP14",153,0)
 S VCPT("Vcpt","packageId")=$G(VCPTARR(FNBR1,IENS1,81202,"I"))
"RTN","SYNDHP14",154,0)
 S VCPT("Vcpt","dataSource")=$G(VCPTARR(FNBR1,IENS1,81203,"E"))
"RTN","SYNDHP14",155,0)
 S VCPT("Vcpt","dataSourceId")=$G(VCPTARR(FNBR1,IENS1,81203,"I"))
"RTN","SYNDHP14",156,0)
 N CPTMOD
"RTN","SYNDHP14",157,0)
 N IENS2 S IENS2=""
"RTN","SYNDHP14",158,0)
 F  S IENS2=$O(VCPTARR(FNBR2,IENS2)) QUIT:IENS2=""  D
"RTN","SYNDHP14",159,0)
 . S CPTMOD=$NA(VCPT("Vcpt","cptModifiers","cptModifier",+IENS2))
"RTN","SYNDHP14",160,0)
 . S @CPTMOD@("cptModifier")=$G(VCPTARR(FNBR2,IENS2,.01,"E"))
"RTN","SYNDHP14",161,0)
 . S @CPTMOD@("cptModifierId")=$G(VCPTARR(FNBR2,IENS2,.01,"I"))
"RTN","SYNDHP14",162,0)
 . S @CPTMOD@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_VCPTIEN_S_FNBR2_S_+IENS2
"RTN","SYNDHP14",163,0)
 ;
"RTN","SYNDHP14",164,0)
 ;I $G(DEBUG) W ! ZWRITE VCPT
"RTN","SYNDHP14",165,0)
 ;
"RTN","SYNDHP14",166,0)
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.VCPT,.VCPTJ)
"RTN","SYNDHP14",167,0)
 ;
"RTN","SYNDHP14",168,0)
 QUIT
"RTN","SYNDHP14",169,0)
 ;
"RTN","SYNDHP15")
0^90^B159077808
"RTN","SYNDHP15",1,0)
SYNDHP15 ; HC/art - HealthConcourse - get care plan data ;03/01/2019
"RTN","SYNDHP15",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP15",3,0)
 ;;
"RTN","SYNDHP15",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP15",5,0)
 ;
"RTN","SYNDHP15",6,0)
 QUIT
"RTN","SYNDHP15",7,0)
 ;
"RTN","SYNDHP15",8,0)
 ;-------------------------------------------------------------
"RTN","SYNDHP15",9,0)
 ;
"RTN","SYNDHP15",10,0)
GET1HLF(HLFACT,HLFIEN,CP,RETJSON,HLFACTJ) ;get one Health Factor
"RTN","SYNDHP15",11,0)
 ;inputs: HLFIEN - Health Factor IEN
"RTN","SYNDHP15",12,0)
 ;        CP     - 0=get all records
"RTN","SYNDHP15",13,0)
 ;                 1= + SYN care plan data elements
"RTN","SYNDHP15",14,0)
 ;        RETJSON - J or F = Return JSON
"RTN","SYNDHP15",15,0)
 ;output: HLFACT  - array of Health Factor data, by reference
"RTN","SYNDHP15",16,0)
 ;        HLFACTJ - JSON structure of Health Factor data, by reference
"RTN","SYNDHP15",17,0)
 ;
"RTN","SYNDHP15",18,0)
 I $G(DEBUG) W !,"----------------------------- Health Factor -----------------------------",!
"RTN","SYNDHP15",19,0)
 N FNBR1 S FNBR1=9000010.23 ;V HEALTH FACTORS
"RTN","SYNDHP15",20,0)
 N S S S="_"
"RTN","SYNDHP15",21,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP15",22,0)
 N IENS S IENS=HLFIEN_","
"RTN","SYNDHP15",23,0)
 N HLFARR,HLFERR
"RTN","SYNDHP15",24,0)
 D GETS^DIQ(FNBR1,IENS,"**","EI","HLFARR","HLFERR")
"RTN","SYNDHP15",25,0)
 ;I $G(DEBUG) W ! ZWRITE HLFARR
"RTN","SYNDHP15",26,0)
 ;I $G(DEBUG),$D(HLFERR) W ">>ERROR<<",! ZWRITE HLFERR
"RTN","SYNDHP15",27,0)
 I $D(HLFERR) D  QUIT
"RTN","SYNDHP15",28,0)
 . S HLFACT("HealthFactor","ERROR")=HLFIEN
"RTN","SYNDHP15",29,0)
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.HLFACT,.HLFACTJ)
"RTN","SYNDHP15",30,0)
 N HLFACTOR S HLFACTOR=$NA(HLFACT("HealthFactor"))
"RTN","SYNDHP15",31,0)
 S @HLFACTOR@("hlfIen")=HLFIEN
"RTN","SYNDHP15",32,0)
 S @HLFACTOR@("resourceType")="HealthFactor"
"RTN","SYNDHP15",33,0)
 S @HLFACTOR@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_HLFIEN
"RTN","SYNDHP15",34,0)
 S @HLFACTOR@("visitId")=$G(HLFARR(FNBR1,IENS,.03,"I"))
"RTN","SYNDHP15",35,0)
 S @HLFACTOR@("visit")=$G(HLFARR(FNBR1,IENS,.03,"E"))
"RTN","SYNDHP15",36,0)
 S @HLFACTOR@("visitFM")=$$GET1^DIQ(9000010,@HLFACTOR@("visitId")_",",.01,"I")
"RTN","SYNDHP15",37,0)
 S @HLFACTOR@("visitHL7")=$$FMTHL7^XLFDT(@HLFACTOR@("visitFM"))
"RTN","SYNDHP15",38,0)
 S @HLFACTOR@("visitFHIR")=$$FMTFHIR^SYNDHPUTL(@HLFACTOR@("visitFM"))
"RTN","SYNDHP15",39,0)
 S @HLFACTOR@("hlfNameId")=$G(HLFARR(FNBR1,IENS,.01,"I"))
"RTN","SYNDHP15",40,0)
 S @HLFACTOR@("hlfName")=$G(HLFARR(FNBR1,IENS,.01,"E"))
"RTN","SYNDHP15",41,0)
 QUIT:$G(CP)&($E(@HLFACTOR@("hlfName"),1,4)'="SYN ")
"RTN","SYNDHP15",42,0)
 S @HLFACTOR@("hlfCategory")=$$GET1^DIQ(9999999.64,@HLFACTOR@("hlfNameId")_",",.03,"E")
"RTN","SYNDHP15",43,0)
 S @HLFACTOR@("hlfCategoryId")=$$GET1^DIQ(9999999.64,@HLFACTOR@("hlfNameId")_",",.03,"I")
"RTN","SYNDHP15",44,0)
 S @HLFACTOR@("patientNameId")=$G(HLFARR(FNBR1,IENS,.02,"I"))
"RTN","SYNDHP15",45,0)
 S @HLFACTOR@("patientName")=$G(HLFARR(FNBR1,IENS,.02,"E"))
"RTN","SYNDHP15",46,0)
 S @HLFACTOR@("patientICN")=$$GET1^DIQ(2,@HLFACTOR@("patientNameId")_",",991.1)
"RTN","SYNDHP15",47,0)
 S @HLFACTOR@("levelSeverityCd")=$G(HLFARR(FNBR1,IENS,.04,"I"))
"RTN","SYNDHP15",48,0)
 S @HLFACTOR@("levelSeverity")=$G(HLFARR(FNBR1,IENS,.04,"E"))
"RTN","SYNDHP15",49,0)
 S @HLFACTOR@("magnitude")=$G(HLFARR(FNBR1,IENS,220,"E"))
"RTN","SYNDHP15",50,0)
 S @HLFACTOR@("ucumCode")=$G(HLFARR(FNBR1,IENS,221,"I"))
"RTN","SYNDHP15",51,0)
 S @HLFACTOR@("ucumCode")=$G(HLFARR(FNBR1,IENS,221,"E"))
"RTN","SYNDHP15",52,0)
 S @HLFACTOR@("eventDateTime")=$G(HLFARR(FNBR1,IENS,1201,"E"))
"RTN","SYNDHP15",53,0)
 S @HLFACTOR@("eventDateTimeFM")=$G(HLFARR(FNBR1,IENS,1201,"I"))
"RTN","SYNDHP15",54,0)
 S @HLFACTOR@("eventDateTimeHL7")=$$FMTHL7^XLFDT($G(HLFARR(FNBR1,IENS,1201,"I")))
"RTN","SYNDHP15",55,0)
 S @HLFACTOR@("eventDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(HLFARR(FNBR1,IENS,1201,"I")))
"RTN","SYNDHP15",56,0)
 S @HLFACTOR@("orderingProviderId")=$G(HLFARR(FNBR1,IENS,1202,"I"))
"RTN","SYNDHP15",57,0)
 S @HLFACTOR@("orderingProvider")=$G(HLFARR(FNBR1,IENS,1202,"E"))
"RTN","SYNDHP15",58,0)
 S @HLFACTOR@("encounterProviderId")=$G(HLFARR(FNBR1,IENS,1204,"I"))
"RTN","SYNDHP15",59,0)
 S @HLFACTOR@("encounterProvider")=$G(HLFARR(FNBR1,IENS,1204,"E"))
"RTN","SYNDHP15",60,0)
 S @HLFACTOR@("editedCd")=$G(HLFARR(FNBR1,IENS,80101,"I"))
"RTN","SYNDHP15",61,0)
 S @HLFACTOR@("edited")=$G(HLFARR(FNBR1,IENS,80101,"E"))
"RTN","SYNDHP15",62,0)
 S @HLFACTOR@("auditTrail")=$G(HLFARR(FNBR1,IENS,80102,"E"))
"RTN","SYNDHP15",63,0)
 S @HLFACTOR@("comments")=$G(HLFARR(FNBR1,IENS,81101,"E"))
"RTN","SYNDHP15",64,0)
 S @HLFACTOR@("verifiedCd")=$G(HLFARR(FNBR1,IENS,81201,"I"))
"RTN","SYNDHP15",65,0)
 S @HLFACTOR@("verified")=$G(HLFARR(FNBR1,IENS,81201,"E"))
"RTN","SYNDHP15",66,0)
 S @HLFACTOR@("packageId")=$G(HLFARR(FNBR1,IENS,81202,"I"))
"RTN","SYNDHP15",67,0)
 S @HLFACTOR@("package")=$G(HLFARR(FNBR1,IENS,81202,"E"))
"RTN","SYNDHP15",68,0)
 S @HLFACTOR@("dataSourceId")=$G(HLFARR(FNBR1,IENS,81203,"I"))
"RTN","SYNDHP15",69,0)
 S @HLFACTOR@("dataSource")=$G(HLFARR(FNBR1,IENS,81203,"E"))
"RTN","SYNDHP15",70,0)
 ;
"RTN","SYNDHP15",71,0)
 ;care plan record
"RTN","SYNDHP15",72,0)
 I $E(@HLFACTOR@("hlfName"),1,7)="SYN CP " D
"RTN","SYNDHP15",73,0)
 . S @HLFACTOR@("cpStart")=+($$STRIP^XLFSTR($P(@HLFACTOR@("comments"),":",2)," "))
"RTN","SYNDHP15",74,0)
 . I @HLFACTOR@("cpStart")=0 S @HLFACTOR@("cpStart")=""
"RTN","SYNDHP15",75,0)
 . S @HLFACTOR@("cpStartHL7")=$$FMTHL7^XLFDT(@HLFACTOR@("cpStart"))
"RTN","SYNDHP15",76,0)
 . S @HLFACTOR@("cpStartFHIR")=$$FMTFHIR^SYNDHPUTL(@HLFACTOR@("cpStart"))
"RTN","SYNDHP15",77,0)
 . S @HLFACTOR@("cpEnd")=+($$STRIP^XLFSTR($P(@HLFACTOR@("comments"),":",3)," "))
"RTN","SYNDHP15",78,0)
 . I @HLFACTOR@("cpEnd")=0 S @HLFACTOR@("cpEnd")=""
"RTN","SYNDHP15",79,0)
 . S @HLFACTOR@("cpEndHL7")=$$FMTHL7^XLFDT(@HLFACTOR@("cpEnd"))
"RTN","SYNDHP15",80,0)
 . S @HLFACTOR@("cpEndFHIR")=$$FMTFHIR^SYNDHPUTL(@HLFACTOR@("cpEnd"))
"RTN","SYNDHP15",81,0)
 . S @HLFACTOR@("cpState")=$$STRIP^XLFSTR($P(@HLFACTOR@("comments"),":",4)," ")
"RTN","SYNDHP15",82,0)
 . S @HLFACTOR@("cpIntent")="plan"
"RTN","SYNDHP15",83,0)
 ;
"RTN","SYNDHP15",84,0)
 I $G(CP) D
"RTN","SYNDHP15",85,0)
 . S @HLFACTOR@("cpType")=$$GETTYPE(@HLFACTOR@("hlfName"))
"RTN","SYNDHP15",86,0)
 . S @HLFACTOR@("hlfNameSCT")=$$GETSCT(@HLFACTOR@("hlfName"))
"RTN","SYNDHP15",87,0)
 . S @HLFACTOR@("cpState")=$$STRIP^XLFSTR($P(@HLFACTOR@("comments"),":",4)," ")
"RTN","SYNDHP15",88,0)
 . S @HLFACTOR@("cpResourceType")="CarePlan"
"RTN","SYNDHP15",89,0)
 ;
"RTN","SYNDHP15",90,0)
 I '$G(CP) D
"RTN","SYNDHP15",91,0)
 . ;get snomed
"RTN","SYNDHP15",92,0)
 . N SCT S SCT=""
"RTN","SYNDHP15",93,0)
 . I @HLFACTOR@("hlfNameId")'="" D
"RTN","SYNDHP15",94,0)
 . . S SCT=$$MAP^SYNDHPMP("sct2hf",@HLFACTOR@("hlfNameId"),"I")
"RTN","SYNDHP15",95,0)
 . . S @HLFACTOR@("hlfNameSCT")=$S(+SCT=-1:"",1:$P(SCT,U,2))
"RTN","SYNDHP15",96,0)
 ;
"RTN","SYNDHP15",97,0)
 ;I $G(DEBUG) W ! ZWRITE HLFACT
"RTN","SYNDHP15",98,0)
 ;
"RTN","SYNDHP15",99,0)
 D:$G(RETJSON)="J"!($G(RETJSON)="F") TOJASON^SYNDHPUTL(.HLFACT,.HLFACTJ)
"RTN","SYNDHP15",100,0)
 ;
"RTN","SYNDHP15",101,0)
 QUIT
"RTN","SYNDHP15",102,0)
 ;
"RTN","SYNDHP15",103,0)
GETTYPE(HFNAME) ;
"RTN","SYNDHP15",104,0)
 ;
"RTN","SYNDHP15",105,0)
 QUIT $S($E(HFNAME,1,7)="SYN CP ":"careplan",$E(HFNAME,1,8)="SYN ADDR":"addresses",$E(HFNAME,1,8)="SYN ACT ":"activity",$E(HFNAME,1,9)="SYN GOAL ":"goal",1:"")
"RTN","SYNDHP15",106,0)
 ;
"RTN","SYNDHP15",107,0)
GETSCT(HFNAME) ;
"RTN","SYNDHP15",108,0)
 ;
"RTN","SYNDHP15",109,0)
 QUIT $P($P(HFNAME,"SCT:",2),")",1)
"RTN","SYNDHP15",110,0)
 ;
"RTN","SYNDHP15",111,0)
 ;-------------------------------------------------------------
"RTN","SYNDHP15",112,0)
 ;
"RTN","SYNDHP15",113,0)
GET1NCP(NCP,NCPIEN,RETJSON,NCPJ) ;get one nursing care plan
"RTN","SYNDHP15",114,0)
 ;inputs: HLFIEN - Health Factor IEN
"RTN","SYNDHP15",115,0)
 ;        RETJSON - J = Return JSON
"RTN","SYNDHP15",116,0)
 ;output: NCP  - array of nursing care plan, by reference
"RTN","SYNDHP15",117,0)
 ;        NCPJ - JSON structure of nursing care plan data, by reference
"RTN","SYNDHP15",118,0)
 ;
"RTN","SYNDHP15",119,0)
 I $G(DEBUG) W !,"----------------------------- Nursing Care Plan -----------------------------",!
"RTN","SYNDHP15",120,0)
 N FNBR1 S FNBR1=216.8 ;NURS CARE PLAN
"RTN","SYNDHP15",121,0)
 N FNBR2 S FNBR2=216.81 ;NURS CARE PLAN:NURSING PROBLEM LIST
"RTN","SYNDHP15",122,0)
 N FNBR3 S FNBR3=216.82 ;NURS CARE PLAN:EVALUATION DATE
"RTN","SYNDHP15",123,0)
 N FNBR4 S FNBR4=216.83 ;NURS CARE PLAN:TARGET DATE
"RTN","SYNDHP15",124,0)
 N FNBR5 S FNBR5=216.84 ;NURS CARE PLAN:ORDER INFO
"RTN","SYNDHP15",125,0)
 N S S S="_"
"RTN","SYNDHP15",126,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP15",127,0)
 N IENS S IENS=NCPIEN_","
"RTN","SYNDHP15",128,0)
 N NCPARR,NCPERR
"RTN","SYNDHP15",129,0)
 D GETS^DIQ(FNBR1,IENS,"**","EI","NCPARR","NCPERR")
"RTN","SYNDHP15",130,0)
 ;I $G(DEBUG) W ! ZWRITE NCPARR
"RTN","SYNDHP15",131,0)
 ;I $G(DEBUG),$D(NCPERR) W ">>ERROR<<",! ZWRITE NCPERR
"RTN","SYNDHP15",132,0)
 I $D(NCPERR) D  QUIT
"RTN","SYNDHP15",133,0)
 . S NCP("NurseCarePlan","ERROR")=NCPIEN
"RTN","SYNDHP15",134,0)
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.NCP,.NCPJ)
"RTN","SYNDHP15",135,0)
 N CAREPLAN S CAREPLAN=$NA(NCP("NurseCarePlan"))
"RTN","SYNDHP15",136,0)
 S @CAREPLAN@("ncpIen")=NCPIEN
"RTN","SYNDHP15",137,0)
 S @CAREPLAN@("resourceType")="NurseCarePlan"
"RTN","SYNDHP15",138,0)
 S @CAREPLAN@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_NCPIEN
"RTN","SYNDHP15",139,0)
 S @CAREPLAN@("textFileEntryId")=$G(NCPARR(FNBR1,IENS,.01,"I"))
"RTN","SYNDHP15",140,0)
 S @CAREPLAN@("textFileEntry")=$G(NCPARR(FNBR1,IENS,.01,"E"))
"RTN","SYNDHP15",141,0)
 ;
"RTN","SYNDHP15",142,0)
 N PROB S PROB=""
"RTN","SYNDHP15",143,0)
 F  S PROB=$O(NCPARR(FNBR2,PROB)) QUIT:PROB=""  D
"RTN","SYNDHP15",144,0)
 . N FIEN S FIEN=+PROB
"RTN","SYNDHP15",145,0)
 . N PROBLIST S PROBLIST=$NA(NCP("NurseCarePlan","problemLists","problemList",FIEN))
"RTN","SYNDHP15",146,0)
 . S @PROBLIST@("problemId")=$G(NCPARR(FNBR2,PROB,.01,"I"))
"RTN","SYNDHP15",147,0)
 . S @PROBLIST@("problem")=$G(NCPARR(FNBR2,PROB,.01,"E"))
"RTN","SYNDHP15",148,0)
 . S @PROBLIST@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_NCPIEN_S_FNBR2_S_FIEN
"RTN","SYNDHP15",149,0)
 ;
"RTN","SYNDHP15",150,0)
 N EVAL S EVAL=""
"RTN","SYNDHP15",151,0)
 F  S EVAL=$O(NCPARR(FNBR3,EVAL)) QUIT:EVAL=""  D
"RTN","SYNDHP15",152,0)
 . N FIEN S FIEN=+EVAL
"RTN","SYNDHP15",153,0)
 . N EVALDATE S EVALDATE=$NA(NCP("NurseCarePlan","evaluationDates","evaluationDate",FIEN))
"RTN","SYNDHP15",154,0)
 . S @EVALDATE@("dateTimeEntered")=$G(NCPARR(FNBR3,EVAL,.01,"E"))
"RTN","SYNDHP15",155,0)
 . S @EVALDATE@("dateTimeEnteredFM")=$G(NCPARR(FNBR3,EVAL,.01,"I"))
"RTN","SYNDHP15",156,0)
 . S @EVALDATE@("dateTimeEnteredHL7")=$$FMTHL7^XLFDT($G(NCPARR(FNBR3,EVAL,.01,"I")))
"RTN","SYNDHP15",157,0)
 . S @EVALDATE@("dateTimeEnteredFHIR")=$$FMTFHIR^SYNDHPUTL($G(NCPARR(FNBR3,EVAL,.01,"I")))
"RTN","SYNDHP15",158,0)
 . S @EVALDATE@("problemId")=$G(NCPARR(FNBR3,EVAL,.02,"I"))
"RTN","SYNDHP15",159,0)
 . S @EVALDATE@("problem")=$G(NCPARR(FNBR3,EVAL,.02,"E"))
"RTN","SYNDHP15",160,0)
 . S @EVALDATE@("userWhoEvaluatedId")=$G(NCPARR(FNBR3,EVAL,1,"I"))
"RTN","SYNDHP15",161,0)
 . S @EVALDATE@("userWhoEvaluated")=$G(NCPARR(FNBR3,EVAL,1,"E"))
"RTN","SYNDHP15",162,0)
 . S @EVALDATE@("problemStatusCd")=$G(NCPARR(FNBR3,EVAL,2,"I"))
"RTN","SYNDHP15",163,0)
 . S @EVALDATE@("problemStatus")=$G(NCPARR(FNBR3,EVAL,2,"E"))
"RTN","SYNDHP15",164,0)
 . S @EVALDATE@("evaluationDate")=$G(NCPARR(FNBR3,EVAL,3,"E"))
"RTN","SYNDHP15",165,0)
 . S @EVALDATE@("evaluationDateFM")=$G(NCPARR(FNBR3,EVAL,3,"I"))
"RTN","SYNDHP15",166,0)
 . S @EVALDATE@("evaluationDateHL7")=$$FMTHL7^XLFDT($G(NCPARR(FNBR3,EVAL,3,"I")))
"RTN","SYNDHP15",167,0)
 . S @EVALDATE@("evaluationDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(NCPARR(FNBR3,EVAL,3,"I")))
"RTN","SYNDHP15",168,0)
 . S @EVALDATE@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_NCPIEN_S_FNBR3_S_FIEN
"RTN","SYNDHP15",169,0)
 ;
"RTN","SYNDHP15",170,0)
 N TARG S TARG=""
"RTN","SYNDHP15",171,0)
 F  S TARG=$O(NCPARR(FNBR4,TARG)) QUIT:TARG=""  D
"RTN","SYNDHP15",172,0)
 . N FIEN S FIEN=+TARG
"RTN","SYNDHP15",173,0)
 . N TARGDATE S TARGDATE=$NA(NCP("NurseCarePlan","targetDates","targetDate",FIEN))
"RTN","SYNDHP15",174,0)
 . S @TARGDATE@("dateTimeEntered")=$G(NCPARR(FNBR4,TARG,.01,"E"))
"RTN","SYNDHP15",175,0)
 . S @TARGDATE@("dateTimeEnteredFM")=$G(NCPARR(FNBR4,TARG,.01,"I"))
"RTN","SYNDHP15",176,0)
 . S @TARGDATE@("dateTimeEnteredHL7")=$$FMTHL7^XLFDT($G(NCPARR(FNBR4,TARG,.01,"I")))
"RTN","SYNDHP15",177,0)
 . S @TARGDATE@("dateTimeEnteredFHIR")=$$FMTFHIR^SYNDHPUTL($G(NCPARR(FNBR4,TARG,.01,"I")))
"RTN","SYNDHP15",178,0)
 . S @TARGDATE@("goalExpectedOutcomeId")=$G(NCPARR(FNBR4,TARG,.03,"I"))
"RTN","SYNDHP15",179,0)
 . S @TARGDATE@("goalExpectedOutcome")=$G(NCPARR(FNBR4,TARG,.03,"E"))
"RTN","SYNDHP15",180,0)
 . S @TARGDATE@("userWhoEnteredId")=$G(NCPARR(FNBR4,TARG,1,"I"))
"RTN","SYNDHP15",181,0)
 . S @TARGDATE@("userWhoEntered")=$G(NCPARR(FNBR4,TARG,1,"E"))
"RTN","SYNDHP15",182,0)
 . S @TARGDATE@("goalMetDcdCd")=$G(NCPARR(FNBR4,TARG,2,"I"))
"RTN","SYNDHP15",183,0)
 . S @TARGDATE@("goalMetDcd")=$G(NCPARR(FNBR4,TARG,2,"E"))
"RTN","SYNDHP15",184,0)
 . S @TARGDATE@("targetDate")=$G(NCPARR(FNBR4,TARG,3,"E"))
"RTN","SYNDHP15",185,0)
 . S @TARGDATE@("targetDateFM")=$G(NCPARR(FNBR4,TARG,3,"I"))
"RTN","SYNDHP15",186,0)
 . S @TARGDATE@("targetDateHL7")=$$FMTHL7^XLFDT($G(NCPARR(FNBR4,TARG,3,"I")))
"RTN","SYNDHP15",187,0)
 . S @TARGDATE@("targetDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(NCPARR(FNBR4,TARG,3,"I")))
"RTN","SYNDHP15",188,0)
 . S @TARGDATE@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_NCPIEN_S_FNBR4_S_FIEN
"RTN","SYNDHP15",189,0)
 ;
"RTN","SYNDHP15",190,0)
 N ORD S ORD=""
"RTN","SYNDHP15",191,0)
 F  S ORD=$O(NCPARR(FNBR5,ORD)) QUIT:ORD=""  D
"RTN","SYNDHP15",192,0)
 . N FIEN S FIEN=+ORD
"RTN","SYNDHP15",193,0)
 . N ORDINFO S ORDINFO=$NA(NCP("NurseCarePlan","ordersInfo","orderInfo",FIEN))
"RTN","SYNDHP15",194,0)
 . S @ORDINFO@("statusCd")=$G(NCPARR(FNBR5,ORD,1,"I"))
"RTN","SYNDHP15",195,0)
 . S @ORDINFO@("status")=$G(NCPARR(FNBR5,ORD,1,"E"))
"RTN","SYNDHP15",196,0)
 . S @ORDINFO@("userModifyingId")=$G(NCPARR(FNBR5,ORD,2,"I"))
"RTN","SYNDHP15",197,0)
 . S @ORDINFO@("userModifying")=$G(NCPARR(FNBR5,ORD,2,"E"))
"RTN","SYNDHP15",198,0)
 . S @ORDINFO@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_NCPIEN_S_FNBR5_S_FIEN
"RTN","SYNDHP15",199,0)
 ;
"RTN","SYNDHP15",200,0)
 ;I $G(DEBUG) W ! ZWRITE NCP
"RTN","SYNDHP15",201,0)
 ;
"RTN","SYNDHP15",202,0)
 D:$G(RETJSON)="J"!($G(RETJSON)="F") TOJASON^SYNDHPUTL(.NCP,.NCPJ)
"RTN","SYNDHP15",203,0)
 ;
"RTN","SYNDHP15",204,0)
 QUIT
"RTN","SYNDHP15",205,0)
 ;
"RTN","SYNDHP15",206,0)
 ;-------------------------------------------------------------
"RTN","SYNDHP15",207,0)
 ;
"RTN","SYNDHP15",208,0)
GET1GMR(GMRTEXT,GMRIEN,RETJSON,GMRTEXTJ) ;get one GMR Text record
"RTN","SYNDHP15",209,0)
 ;inputs: GMRIEN - GMR Text IEN
"RTN","SYNDHP15",210,0)
 ;        RETJSON - J = Return JSON
"RTN","SYNDHP15",211,0)
 ;output: GMRTEXT  - array of GMR Text data, by reference
"RTN","SYNDHP15",212,0)
 ;        GMRTEXTJ - JSON structure of GMR Text data, by reference
"RTN","SYNDHP15",213,0)
 ;
"RTN","SYNDHP15",214,0)
 I $G(DEBUG) W !,"----------------------------- GMR Text -----------------------------",!
"RTN","SYNDHP15",215,0)
 N FNBR1 S FNBR1=124.3 ;GMR TEXT
"RTN","SYNDHP15",216,0)
 N FNBR2 S FNBR2=124.31 ;GMR TEXT:SELECTION
"RTN","SYNDHP15",217,0)
 N FNBR3 S FNBR3=124.313 ;GMR TEXT:SELECTION:AUDIT TRAIL
"RTN","SYNDHP15",218,0)
 N S S S="_"
"RTN","SYNDHP15",219,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP15",220,0)
 N IENS S IENS=GMRIEN_","
"RTN","SYNDHP15",221,0)
 N GMRARR,GMRERR
"RTN","SYNDHP15",222,0)
 D GETS^DIQ(FNBR1,IENS,"**","EI","GMRARR","GMRERR")
"RTN","SYNDHP15",223,0)
 ;I $G(DEBUG) W ! ZWRITE GMRARR
"RTN","SYNDHP15",224,0)
 ;I $G(DEBUG),$D(GMRERR) W ">>ERROR<<",! ZWRITE GMRERR
"RTN","SYNDHP15",225,0)
 I $D(GMRERR) D  QUIT
"RTN","SYNDHP15",226,0)
 . S GMRTEXT("GMRtext","ERROR")=GMRIEN
"RTN","SYNDHP15",227,0)
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.GMRTEXT,.GMRTEXTJ)
"RTN","SYNDHP15",228,0)
 N GMRTXT S GMRTXT=$NA(GMRTEXT("GMRtext"))
"RTN","SYNDHP15",229,0)
 S @GMRTXT@("GMRIen")=GMRIEN
"RTN","SYNDHP15",230,0)
 S @GMRTXT@("resourceType")="GMRtext"
"RTN","SYNDHP15",231,0)
 S @GMRTXT@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_GMRIEN
"RTN","SYNDHP15",232,0)
 S @GMRTXT@("textBlockId")=$G(GMRARR(FNBR1,IENS,.01,"I"))
"RTN","SYNDHP15",233,0)
 S @GMRTXT@("textBlock")=$G(GMRARR(FNBR1,IENS,.01,"E"))
"RTN","SYNDHP15",234,0)
 S @GMRTXT@("patientId")=$G(GMRARR(FNBR1,IENS,.02,"I"))
"RTN","SYNDHP15",235,0)
 S @GMRTXT@("patient")=$G(GMRARR(FNBR1,IENS,.02,"E"))
"RTN","SYNDHP15",236,0)
 S @GMRTXT@("patientICN")=$$GET1^DIQ(2,@GMRTXT@("patientId")_",",991.1)
"RTN","SYNDHP15",237,0)
 S @GMRTXT@("dateCreated")=$G(GMRARR(FNBR1,IENS,.03,"E"))
"RTN","SYNDHP15",238,0)
 S @GMRTXT@("dateCreatedFM")=$G(GMRARR(FNBR1,IENS,.03,"I"))
"RTN","SYNDHP15",239,0)
 S @GMRTXT@("dateCreatedHL7")=$$FMTHL7^XLFDT($G(GMRARR(FNBR1,IENS,.03,"I")))
"RTN","SYNDHP15",240,0)
 S @GMRTXT@("dateCreatedFHIR")=$$FMTFHIR^SYNDHPUTL($G(GMRARR(FNBR1,IENS,.03,"I")))
"RTN","SYNDHP15",241,0)
 S @GMRTXT@("authorId")=$G(GMRARR(FNBR1,IENS,3,"I"))
"RTN","SYNDHP15",242,0)
 S @GMRTXT@("author")=$G(GMRARR(FNBR1,IENS,3,"E"))
"RTN","SYNDHP15",243,0)
 S @GMRTXT@("enteredInErrorCd")=$G(GMRARR(FNBR1,IENS,5,"I"))
"RTN","SYNDHP15",244,0)
 S @GMRTXT@("enteredInError")=$G(GMRARR(FNBR1,IENS,5,"E"))
"RTN","SYNDHP15",245,0)
 S @GMRTXT@("dateEnteredInError")=$G(GMRARR(FNBR1,IENS,5.1,"E"))
"RTN","SYNDHP15",246,0)
 S @GMRTXT@("dateEnteredInErrorFM")=$G(GMRARR(FNBR1,IENS,5.1,"I"))
"RTN","SYNDHP15",247,0)
 S @GMRTXT@("dateEnteredInErrorHL7")=$$FMTHL7^XLFDT($G(GMRARR(FNBR1,IENS,5.1,"I")))
"RTN","SYNDHP15",248,0)
 S @GMRTXT@("dateEnteredInErrorFHIR")=$$FMTFHIR^SYNDHPUTL($G(GMRARR(FNBR1,IENS,5.1,"I")))
"RTN","SYNDHP15",249,0)
 S @GMRTXT@("userEnteringInErrorId")=$G(GMRARR(FNBR1,IENS,5.2,"I"))
"RTN","SYNDHP15",250,0)
 S @GMRTXT@("userEnteringInError")=$G(GMRARR(FNBR1,IENS,5.2,"E"))
"RTN","SYNDHP15",251,0)
 S @GMRTXT@("dateLastUpdated")=$G(GMRARR(FNBR1,IENS,6,"E"))
"RTN","SYNDHP15",252,0)
 S @GMRTXT@("dateLastUpdatedFM")=$G(GMRARR(FNBR1,IENS,6,"I"))
"RTN","SYNDHP15",253,0)
 S @GMRTXT@("dateLastUpdatedHL7")=$$FMTHL7^XLFDT($G(GMRARR(FNBR1,IENS,6,"I")))
"RTN","SYNDHP15",254,0)
 S @GMRTXT@("dateLastUpdatedFHIR")=$$FMTFHIR^SYNDHPUTL($G(GMRARR(FNBR1,IENS,6,"I")))
"RTN","SYNDHP15",255,0)
 ;
"RTN","SYNDHP15",256,0)
 N SEL S SEL=""
"RTN","SYNDHP15",257,0)
 F  S SEL=$O(GMRARR(FNBR2,SEL)) QUIT:SEL=""  D
"RTN","SYNDHP15",258,0)
 . N FIEN S FIEN=+SEL
"RTN","SYNDHP15",259,0)
 . N SELECTION S SELECTION=$NA(GMRTEXT("GMRtext","selections","selection",FIEN))
"RTN","SYNDHP15",260,0)
 . S @SELECTION@("selectionId")=$G(GMRARR(FNBR2,SEL,.01,"I"))
"RTN","SYNDHP15",261,0)
 . S @SELECTION@("selection")=$G(GMRARR(FNBR2,SEL,.01,"E"))
"RTN","SYNDHP15",262,0)
 . S @SELECTION@("appendedInternalText")=$G(GMRARR(FNBR2,SEL,1,"E"))
"RTN","SYNDHP15",263,0)
 . S @SELECTION@("additionalText")=$G(GMRARR(FNBR2,SEL,2,"E"))
"RTN","SYNDHP15",264,0)
 . S @SELECTION@("added")=$G(GMRARR(FNBR2,SEL,4,"E"))
"RTN","SYNDHP15",265,0)
 . S @SELECTION@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_GMRIEN_S_FNBR2_S_FIEN
"RTN","SYNDHP15",266,0)
 . N AUDIT S AUDIT=""
"RTN","SYNDHP15",267,0)
 . F  S AUDIT=$O(GMRARR(FNBR3,AUDIT)) QUIT:AUDIT=""  D
"RTN","SYNDHP15",268,0)
 . . N AIEN S AIEN=+AUDIT
"RTN","SYNDHP15",269,0)
 . . N AUDIT S AUDIT=$NA(GMRTEXT("GMRtext","selections","selection",FIEN,"auditTrails","auditTrail",AIEN))
"RTN","SYNDHP15",270,0)
 . . S @AUDIT@("auditTrailDateTime")=$G(GMRARR(FNBR3,AUDIT,.01,"E"))
"RTN","SYNDHP15",271,0)
 . . S @AUDIT@("auditTrailDateTimeFM")=$G(GMRARR(FNBR3,AUDIT,.01,"I"))
"RTN","SYNDHP15",272,0)
 . . S @AUDIT@("auditTrailDateTimeHL7")=$$FMTHL7^XLFDT($G(GMRARR(FNBR3,AUDIT,.01,"I")))
"RTN","SYNDHP15",273,0)
 . . S @AUDIT@("auditTrailDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(GMRARR(FNBR3,AUDIT,.01,"I")))
"RTN","SYNDHP15",274,0)
 . . S @AUDIT@("modification")=$G(GMRARR(FNBR3,AUDIT,1,"E"))
"RTN","SYNDHP15",275,0)
 . . S @AUDIT@("userWhoModifiedId")=$G(GMRARR(FNBR3,AUDIT,2,"I"))
"RTN","SYNDHP15",276,0)
 . . S @AUDIT@("userWhoModified")=$G(GMRARR(FNBR3,AUDIT,2,"E"))
"RTN","SYNDHP15",277,0)
 . . S @AUDIT@("appendedInternalText")=$G(GMRARR(FNBR3,AUDIT,3,"E"))
"RTN","SYNDHP15",278,0)
 . . S @AUDIT@("additionalText")=$G(GMRARR(FNBR3,AUDIT,4,"E"))
"RTN","SYNDHP15",279,0)
 . . S @AUDIT@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_GMRIEN_S_FNBR2_S_FIEN_S_FNBR3_S_AIEN
"RTN","SYNDHP15",280,0)
 ;
"RTN","SYNDHP15",281,0)
 ;I $G(DEBUG) W ! ZWRITE GMRTEXT
"RTN","SYNDHP15",282,0)
 ;
"RTN","SYNDHP15",283,0)
 D:$G(RETJSON)="J"!($G(RETJSON)="F") TOJASON^SYNDHPUTL(.GMRTEXT,.GMRTEXTJ)
"RTN","SYNDHP15",284,0)
 ;
"RTN","SYNDHP15",285,0)
 QUIT
"RTN","SYNDHP15",286,0)
 ;
"RTN","SYNDHP16")
0^91^B128773413
"RTN","SYNDHP16",1,0)
SYNDHP16 ; HC/art - HealthConcourse - get Allergy, Vitals, data ;03/01/2019
"RTN","SYNDHP16",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP16",3,0)
 ;;
"RTN","SYNDHP16",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP16",5,0)
 ;
"RTN","SYNDHP16",6,0)
 QUIT
"RTN","SYNDHP16",7,0)
 ;
"RTN","SYNDHP16",8,0)
 ;-------------------------------------------------------------
"RTN","SYNDHP16",9,0)
 ;
"RTN","SYNDHP16",10,0)
GET1ALLERGY(ALLERGY,ALLERGYIEN,RETJSON,ALLERGYJ) ;get one Allergy record
"RTN","SYNDHP16",11,0)
 ;inputs: ALLERGYIEN - Allergy IEN
"RTN","SYNDHP16",12,0)
 ;        RETJSON - J = Return JSON
"RTN","SYNDHP16",13,0)
 ;output: ALLERGY  - array of Allergy data, by reference
"RTN","SYNDHP16",14,0)
 ;        ALLERGYJ - JSON structure of Allergy data, by reference
"RTN","SYNDHP16",15,0)
 ;
"RTN","SYNDHP16",16,0)
 I $G(DEBUG) W !,"--------------------------- Allergy -----------------------------",!
"RTN","SYNDHP16",17,0)
 N S S S="_"
"RTN","SYNDHP16",18,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP16",19,0)
 N FNBR1 S FNBR1=120.8 ;PATIENT ALLERGIES
"RTN","SYNDHP16",20,0)
 N FNBR2 S FNBR2=120.81 ;REACTIONS
"RTN","SYNDHP16",21,0)
 N FNBR3 S FNBR3=120.813 ;CHART MARKED
"RTN","SYNDHP16",22,0)
 N FNBR4 S FNBR4=120.814 ;ID BAND MARKED
"RTN","SYNDHP16",23,0)
 N FNBR5 S FNBR5=120.826 ;COMMENTS
"RTN","SYNDHP16",24,0)
 N IENS1 S IENS1=ALLERGYIEN_","
"RTN","SYNDHP16",25,0)
 ;
"RTN","SYNDHP16",26,0)
 N ALLERGYARR,ALLERGYERR,ALLERGYN
"RTN","SYNDHP16",27,0)
 D GETS^DIQ(FNBR1,IENS1,"**","EI","ALLERGYARR","ALLERGYERR")
"RTN","SYNDHP16",28,0)
 ;I $G(DEBUG) W ! ZWRITE ALLERGYARR
"RTN","SYNDHP16",29,0)
 ;I $G(DEBUG),$D(ALLERGYERR) W ">>ERROR<<",! ZWRITE ALLERGYERR
"RTN","SYNDHP16",30,0)
 I $D(ALLERGYERR) D  QUIT
"RTN","SYNDHP16",31,0)
 . S ALLERGY("Allergy","ERROR")=ALLERGYIEN
"RTN","SYNDHP16",32,0)
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.ALLERGY,.ALLERGYJ)
"RTN","SYNDHP16",33,0)
 S ALLERGYN=$NA(ALLERGY("Allergy"))
"RTN","SYNDHP16",34,0)
 S @ALLERGYN@("allergyIen")=ALLERGYIEN
"RTN","SYNDHP16",35,0)
 S @ALLERGYN@("resourceType")="AllergyIntolerance"
"RTN","SYNDHP16",36,0)
 S @ALLERGYN@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_ALLERGYIEN
"RTN","SYNDHP16",37,0)
 S @ALLERGYN@("patient")=$G(ALLERGYARR(FNBR1,IENS1,.01,"E"))
"RTN","SYNDHP16",38,0)
 S @ALLERGYN@("patientId")=$G(ALLERGYARR(FNBR1,IENS1,.01,"I"))
"RTN","SYNDHP16",39,0)
 S @ALLERGYN@("patientICN")=$$GET1^DIQ(2,@ALLERGYN@("patientId")_",",991.1)
"RTN","SYNDHP16",40,0)
 S @ALLERGYN@("reactant")=$G(ALLERGYARR(FNBR1,IENS1,.02,"E"))
"RTN","SYNDHP16",41,0)
 S @ALLERGYN@("reactantSCT")=$$MAPR^SYNDHPMP(@ALLERGYN@("reactant"),"T","A")
"RTN","SYNDHP16",42,0)
 S @ALLERGYN@("gmrAllergy")=$G(ALLERGYARR(FNBR1,IENS1,1,"E"))
"RTN","SYNDHP16",43,0)
 S @ALLERGYN@("gmrAllergyId")=$G(ALLERGYARR(FNBR1,IENS1,1,"I"))
"RTN","SYNDHP16",44,0)
 S @ALLERGYN@("allergyType")=$G(ALLERGYARR(FNBR1,IENS1,3.1,"E"))
"RTN","SYNDHP16",45,0)
 S @ALLERGYN@("allergyTypeFHIR")=$$CNVTTYPE(@ALLERGYN@("allergyType"))
"RTN","SYNDHP16",46,0)
 S @ALLERGYN@("originationDateTime")=$G(ALLERGYARR(FNBR1,IENS1,4,"E"))
"RTN","SYNDHP16",47,0)
 S @ALLERGYN@("originationDateTimeFM")=$G(ALLERGYARR(FNBR1,IENS1,4,"I"))
"RTN","SYNDHP16",48,0)
 S @ALLERGYN@("originationDateTimeHL7")=$$FMTHL7^XLFDT($G(ALLERGYARR(FNBR1,IENS1,4,"I")))
"RTN","SYNDHP16",49,0)
 S @ALLERGYN@("originationDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(ALLERGYARR(FNBR1,IENS1,4,"I")))
"RTN","SYNDHP16",50,0)
 S @ALLERGYN@("originator")=$G(ALLERGYARR(FNBR1,IENS1,5,"E"))
"RTN","SYNDHP16",51,0)
 S @ALLERGYN@("originatorId")=$G(ALLERGYARR(FNBR1,IENS1,5,"I"))
"RTN","SYNDHP16",52,0)
 S @ALLERGYN@("observedHistorical")=$G(ALLERGYARR(FNBR1,IENS1,6,"E"))
"RTN","SYNDHP16",53,0)
 S @ALLERGYN@("observedHistoricalCd")=$G(ALLERGYARR(FNBR1,IENS1,6,"I"))
"RTN","SYNDHP16",54,0)
 S @ALLERGYN@("reportable")=$G(ALLERGYARR(FNBR1,IENS1,7,"E"))
"RTN","SYNDHP16",55,0)
 S @ALLERGYN@("reportableCd")=$G(ALLERGYARR(FNBR1,IENS1,7,"I"))
"RTN","SYNDHP16",56,0)
 S @ALLERGYN@("originatorSignOff")=$G(ALLERGYARR(FNBR1,IENS1,15,"E"))
"RTN","SYNDHP16",57,0)
 S @ALLERGYN@("originatorSignOffCd")=$G(ALLERGYARR(FNBR1,IENS1,15,"I"))
"RTN","SYNDHP16",58,0)
 S @ALLERGYN@("mechanism")=$G(ALLERGYARR(FNBR1,IENS1,17,"E"))
"RTN","SYNDHP16",59,0)
 S @ALLERGYN@("mechanismCd")=$G(ALLERGYARR(FNBR1,IENS1,17,"I"))
"RTN","SYNDHP16",60,0)
 S @ALLERGYN@("verified")=$G(ALLERGYARR(FNBR1,IENS1,19,"E"))
"RTN","SYNDHP16",61,0)
 S @ALLERGYN@("verifiedCd")=$G(ALLERGYARR(FNBR1,IENS1,19,"I"))
"RTN","SYNDHP16",62,0)
 S @ALLERGYN@("verificationDateTime")=$G(ALLERGYARR(FNBR1,IENS1,20,"E"))
"RTN","SYNDHP16",63,0)
 S @ALLERGYN@("verificationDateTimeFM")=$G(ALLERGYARR(FNBR1,IENS1,20,"I"))
"RTN","SYNDHP16",64,0)
 S @ALLERGYN@("verificationDateTimeHL7")=$$FMTHL7^XLFDT($G(ALLERGYARR(FNBR1,IENS1,20,"I")))
"RTN","SYNDHP16",65,0)
 S @ALLERGYN@("verificationDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(ALLERGYARR(FNBR1,IENS1,20,"I")))
"RTN","SYNDHP16",66,0)
 S @ALLERGYN@("verifier")=$G(ALLERGYARR(FNBR1,IENS1,21,"E"))
"RTN","SYNDHP16",67,0)
 S @ALLERGYN@("verifierId")=$G(ALLERGYARR(FNBR1,IENS1,21,"I"))
"RTN","SYNDHP16",68,0)
 S @ALLERGYN@("enteredInError")=$G(ALLERGYARR(FNBR1,IENS1,22,"E"))
"RTN","SYNDHP16",69,0)
 S @ALLERGYN@("enteredInErrorCd")=$G(ALLERGYARR(FNBR1,IENS1,22,"I"))
"RTN","SYNDHP16",70,0)
 S @ALLERGYN@("dateTimeEnteredInError")=$G(ALLERGYARR(FNBR1,IENS1,23,"E"))
"RTN","SYNDHP16",71,0)
 S @ALLERGYN@("dateTimeEnteredInErrorFM")=$G(ALLERGYARR(FNBR1,IENS1,23,"I"))
"RTN","SYNDHP16",72,0)
 S @ALLERGYN@("dateTimeEnteredInErrorHL7")=$$FMTHL7^XLFDT($G(ALLERGYARR(FNBR1,IENS1,23,"I")))
"RTN","SYNDHP16",73,0)
 S @ALLERGYN@("dateTimeEnteredInErrorFHIR")=$$FMTFHIR^SYNDHPUTL($G(ALLERGYARR(FNBR1,IENS1,23,"I")))
"RTN","SYNDHP16",74,0)
 S @ALLERGYN@("userEnteringInError")=$G(ALLERGYARR(FNBR1,IENS1,24,"E"))
"RTN","SYNDHP16",75,0)
 S @ALLERGYN@("userEnteringInErrorId")=$G(ALLERGYARR(FNBR1,IENS1,24,"I"))
"RTN","SYNDHP16",76,0)
 N REACTION
"RTN","SYNDHP16",77,0)
 N IENS2 S IENS2=""
"RTN","SYNDHP16",78,0)
 F  S IENS2=$O(ALLERGYARR(FNBR2,IENS2)) QUIT:IENS2=""  D
"RTN","SYNDHP16",79,0)
 . S REACTION=$NA(ALLERGY("Allergy","reactionss","reactions",+IENS2))
"RTN","SYNDHP16",80,0)
 . S @REACTION@("reaction")=$G(ALLERGYARR(FNBR2,IENS2,.01,"E"))
"RTN","SYNDHP16",81,0)
 . S @REACTION@("reactionId")=$G(ALLERGYARR(FNBR2,IENS2,.01,"I"))
"RTN","SYNDHP16",82,0)
 . S @REACTION@("reactionSCT")=$$MAPR^SYNDHPMP($G(ALLERGYARR(FNBR2,IENS2,.01,"E")),"T","R")
"RTN","SYNDHP16",83,0)
 . S @REACTION@("otherReaction")=$G(ALLERGYARR(FNBR2,IENS2,1,"E"))
"RTN","SYNDHP16",84,0)
 . S @REACTION@("enteredBy")=$G(ALLERGYARR(FNBR2,IENS2,2,"E"))
"RTN","SYNDHP16",85,0)
 . S @REACTION@("enteredById")=$G(ALLERGYARR(FNBR2,IENS2,2,"I"))
"RTN","SYNDHP16",86,0)
 . S @REACTION@("dateEntered")=$G(ALLERGYARR(FNBR2,IENS2,3,"E"))
"RTN","SYNDHP16",87,0)
 . S @REACTION@("dateEnteredFM")=$G(ALLERGYARR(FNBR2,IENS2,3,"I"))
"RTN","SYNDHP16",88,0)
 . S @REACTION@("dateEnteredHL7")=$$FMTHL7^XLFDT($G(ALLERGYARR(FNBR2,IENS2,3,"I")))
"RTN","SYNDHP16",89,0)
 . S @REACTION@("dateEnteredFHIR")=$$FMTFHIR^SYNDHPUTL($G(ALLERGYARR(FNBR2,IENS2,3,"I")))
"RTN","SYNDHP16",90,0)
 . S @REACTION@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_ALLERGYIEN_S_FNBR2_S_+IENS2
"RTN","SYNDHP16",91,0)
 N CHART
"RTN","SYNDHP16",92,0)
 N IENS3 S IENS3=""
"RTN","SYNDHP16",93,0)
 F  S IENS3=$O(ALLERGYARR(FNBR3,IENS3)) QUIT:IENS3=""  D
"RTN","SYNDHP16",94,0)
 . S CHART=$NA(ALLERGY("Allergy","chartMarkeds","chartMarked",+IENS3))
"RTN","SYNDHP16",95,0)
 . S @CHART@("dateTime")=$G(ALLERGYARR(FNBR3,IENS3,.01,"E"))
"RTN","SYNDHP16",96,0)
 . S @CHART@("dateTimeFM")=$G(ALLERGYARR(FNBR3,IENS3,.01,"I"))
"RTN","SYNDHP16",97,0)
 . S @CHART@("dateTimeHL7")=$$FMTHL7^XLFDT($G(ALLERGYARR(FNBR3,IENS3,.01,"I")))
"RTN","SYNDHP16",98,0)
 . S @CHART@("dateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(ALLERGYARR(FNBR3,IENS3,.01,"I")))
"RTN","SYNDHP16",99,0)
 . S @CHART@("userEntering")=$G(ALLERGYARR(FNBR3,IENS3,1,"E"))
"RTN","SYNDHP16",100,0)
 . S @CHART@("userEnteringId")=$G(ALLERGYARR(FNBR3,IENS3,1,"I"))
"RTN","SYNDHP16",101,0)
 . S @CHART@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_ALLERGYIEN_S_FNBR3_S_+IENS3
"RTN","SYNDHP16",102,0)
 N IDBAND
"RTN","SYNDHP16",103,0)
 N IENS4 S IENS4=""
"RTN","SYNDHP16",104,0)
 F  S IENS4=$O(ALLERGYARR(FNBR4,IENS4)) QUIT:IENS4=""  D
"RTN","SYNDHP16",105,0)
 . S IDBAND=$NA(ALLERGY("Allergy","idBandMarkeds","idBandMarked",+IENS4))
"RTN","SYNDHP16",106,0)
 . S @IDBAND@("dateTime")=$G(ALLERGYARR(FNBR4,IENS4,.01,"E"))
"RTN","SYNDHP16",107,0)
 . S @IDBAND@("dateTimeFM")=$G(ALLERGYARR(FNBR4,IENS4,.01,"I"))
"RTN","SYNDHP16",108,0)
 . S @IDBAND@("dateTimeHL7")=$$FMTHL7^XLFDT($G(ALLERGYARR(FNBR4,IENS4,.01,"I")))
"RTN","SYNDHP16",109,0)
 . S @IDBAND@("dateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(ALLERGYARR(FNBR4,IENS4,.01,"I")))
"RTN","SYNDHP16",110,0)
 . S @IDBAND@("userEntering")=$G(ALLERGYARR(FNBR4,IENS4,1,"E"))
"RTN","SYNDHP16",111,0)
 . S @IDBAND@("userEnteringId")=$G(ALLERGYARR(FNBR4,IENS4,1,"I"))
"RTN","SYNDHP16",112,0)
 . S @IDBAND@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_ALLERGYIEN_S_FNBR4_S_+IENS4
"RTN","SYNDHP16",113,0)
 N COMMENTS
"RTN","SYNDHP16",114,0)
 N IENS5 S IENS5=""
"RTN","SYNDHP16",115,0)
 F  S IENS5=$O(ALLERGYARR(FNBR5,IENS5)) QUIT:IENS5=""  D
"RTN","SYNDHP16",116,0)
 . S COMMENTS=$NA(ALLERGY("Allergy","commentss","comments",+IENS5))
"RTN","SYNDHP16",117,0)
 . S @COMMENTS@("dateTimeCommentEntered")=$G(ALLERGYARR(FNBR5,IENS5,.01,"E"))
"RTN","SYNDHP16",118,0)
 . S @COMMENTS@("dateTimeCommentEnteredFM")=$G(ALLERGYARR(FNBR5,IENS5,.01,"I"))
"RTN","SYNDHP16",119,0)
 . S @COMMENTS@("dateTimeCommentEnteredHL7")=$$FMTHL7^XLFDT($G(ALLERGYARR(FNBR5,IENS5,.01,"I")))
"RTN","SYNDHP16",120,0)
 . S @COMMENTS@("dateTimeCommentEnteredFHIR")=$$FMTFHIR^SYNDHPUTL($G(ALLERGYARR(FNBR5,IENS5,.01,"I")))
"RTN","SYNDHP16",121,0)
 . S @COMMENTS@("userEntering")=$G(ALLERGYARR(FNBR5,IENS5,1,"E"))
"RTN","SYNDHP16",122,0)
 . S @COMMENTS@("userEnteringId")=$G(ALLERGYARR(FNBR5,IENS5,1,"I"))
"RTN","SYNDHP16",123,0)
 . S @COMMENTS@("commentType")=$G(ALLERGYARR(FNBR5,IENS5,1.5,"E"))
"RTN","SYNDHP16",124,0)
 . S @COMMENTS@("commentTypeCd")=$G(ALLERGYARR(FNBR5,IENS5,1.5,"I"))
"RTN","SYNDHP16",125,0)
 . S @COMMENTS@("comments")=$G(ALLERGYARR(FNBR5,IENS5,2,"E"))
"RTN","SYNDHP16",126,0)
 . S @COMMENTS@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_ALLERGYIEN_S_FNBR5_S_+IENS5
"RTN","SYNDHP16",127,0)
 ;
"RTN","SYNDHP16",128,0)
 ;I $G(DEBUG) W ! ZWRITE ALLERGY W !
"RTN","SYNDHP16",129,0)
 ;
"RTN","SYNDHP16",130,0)
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.ALLERGY,.ALLERGYJ)
"RTN","SYNDHP16",131,0)
 ;
"RTN","SYNDHP16",132,0)
 QUIT
"RTN","SYNDHP16",133,0)
 ;
"RTN","SYNDHP16",134,0)
CNVTTYPE(TYPE) ;convert allery type to fhir values
"RTN","SYNDHP16",135,0)
 ;input: TYPE - VistA allergy type
"RTN","SYNDHP16",136,0)
 ;returns: FHIR allery type
"RTN","SYNDHP16",137,0)
 ;
"RTN","SYNDHP16",138,0)
 N IDX,TYPES,ALLTYPES
"RTN","SYNDHP16",139,0)
 F IDX=1:1 S TYPES=$P($T(TYPES+IDX),";;",2) QUIT:TYPES="zzzzz"  D
"RTN","SYNDHP16",140,0)
 . S ALLTYPES($P(TYPES,U,1))=$P(TYPES,U,2)
"RTN","SYNDHP16",141,0)
 ;
"RTN","SYNDHP16",142,0)
 I $G(TYPE)="" QUIT ""
"RTN","SYNDHP16",143,0)
 I $D(ALLTYPES(TYPE)) QUIT ALLTYPES(TYPE)
"RTN","SYNDHP16",144,0)
 QUIT ""
"RTN","SYNDHP16",145,0)
 ;
"RTN","SYNDHP16",146,0)
TYPES ;
"RTN","SYNDHP16",147,0)
  ;;FOOD^food
"RTN","SYNDHP16",148,0)
  ;;DRUG^medication
"RTN","SYNDHP16",149,0)
  ;;OTHER^environment
"RTN","SYNDHP16",150,0)
  ;;FOOD, DRUG^food:medication
"RTN","SYNDHP16",151,0)
  ;;DRUG, FOOD^medication:food
"RTN","SYNDHP16",152,0)
  ;;FOOD, OTHER^food:environment
"RTN","SYNDHP16",153,0)
  ;;DRUG, OTHER^medication:environment
"RTN","SYNDHP16",154,0)
  ;;FOOD, DRUG, OTHER^food:medication:environment
"RTN","SYNDHP16",155,0)
  ;;DRUG, FOOD, OTHER^medication:food:environment
"RTN","SYNDHP16",156,0)
  ;;F^food
"RTN","SYNDHP16",157,0)
  ;;D^medication
"RTN","SYNDHP16",158,0)
  ;;O^environment
"RTN","SYNDHP16",159,0)
  ;;FD^food:medication
"RTN","SYNDHP16",160,0)
  ;;DF^medication:food
"RTN","SYNDHP16",161,0)
  ;;FO^food:environment
"RTN","SYNDHP16",162,0)
  ;;DO^medication:environment
"RTN","SYNDHP16",163,0)
  ;;FDO^food:medication:environment
"RTN","SYNDHP16",164,0)
  ;;DFO^medication:food:environment
"RTN","SYNDHP16",165,0)
  ;;zzzzz
"RTN","SYNDHP16",166,0)
 ;
"RTN","SYNDHP16",167,0)
GET1VITALS(VITALS,VITALSIEN,RETJSON,VITALSJ) ;get one Vitals record
"RTN","SYNDHP16",168,0)
 ;inputs: VITALSIEN - Vitals IEN
"RTN","SYNDHP16",169,0)
 ;        RETJSON - J = Return JSON
"RTN","SYNDHP16",170,0)
 ;output: VITALS  - array of Vitals data, by reference
"RTN","SYNDHP16",171,0)
 ;        VITALSJ - JSON structure of Vitals data, by reference
"RTN","SYNDHP16",172,0)
 ;
"RTN","SYNDHP16",173,0)
 I $G(DEBUG) W !,"--------------------------- Vitals -----------------------------",!
"RTN","SYNDHP16",174,0)
 N S S S="_"
"RTN","SYNDHP16",175,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP16",176,0)
 N FNBR1 S FNBR1=120.5 ;GMRV VITAL MEASUREMENT
"RTN","SYNDHP16",177,0)
 N FNBR2 S FNBR2=120.506 ;REASON ENTERED IN ERROR
"RTN","SYNDHP16",178,0)
 N FNBR3 S FNBR3=120.505 ;QUALIFIER
"RTN","SYNDHP16",179,0)
 N IENS1 S IENS1=VITALSIEN_","
"RTN","SYNDHP16",180,0)
 ;
"RTN","SYNDHP16",181,0)
 N VITALSARR,VITALSERR
"RTN","SYNDHP16",182,0)
 D GETS^DIQ(FNBR1,IENS1,"**","EI","VITALSARR","VITALSERR")
"RTN","SYNDHP16",183,0)
 ;I $G(DEBUG) W ! ZWRITE VITALSARR
"RTN","SYNDHP16",184,0)
 ;I $G(DEBUG),$D(VITALSERR) W ">>ERROR<<" ZWRITE VITALSERR
"RTN","SYNDHP16",185,0)
 I $D(VITALSERR) D  QUIT
"RTN","SYNDHP16",186,0)
 . S VITALS("Vitals","ERROR")=VITALSIEN
"RTN","SYNDHP16",187,0)
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.VITALS,.VITALSJ)
"RTN","SYNDHP16",188,0)
 S VITALS("Vitals","vitalsIen")=VITALSIEN
"RTN","SYNDHP16",189,0)
 S VITALS("Vitals","resourceType")="Observation"
"RTN","SYNDHP16",190,0)
 S VITALS("Vitals","resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_VITALSIEN
"RTN","SYNDHP16",191,0)
 S VITALS("Vitals","dateTimeVitalsTaken")=$G(VITALSARR(FNBR1,IENS1,.01,"E"))
"RTN","SYNDHP16",192,0)
 S VITALS("Vitals","dateTimeVitalsTakenFM")=$G(VITALSARR(FNBR1,IENS1,.01,"I"))
"RTN","SYNDHP16",193,0)
 S VITALS("Vitals","dateTimeVitalsTakenHL7")=$$FMTHL7^XLFDT($G(VITALSARR(FNBR1,IENS1,.01,"I")))
"RTN","SYNDHP16",194,0)
 S VITALS("Vitals","dateTimeVitalsTakenFHIR")=$$FMTFHIR^SYNDHPUTL($G(VITALSARR(FNBR1,IENS1,.01,"I")))
"RTN","SYNDHP16",195,0)
 S VITALS("Vitals","patient")=$G(VITALSARR(FNBR1,IENS1,.02,"E"))
"RTN","SYNDHP16",196,0)
 S VITALS("Vitals","patientId")=$G(VITALSARR(FNBR1,IENS1,.02,"I"))
"RTN","SYNDHP16",197,0)
 S VITALS("Vitals","patientICN")=$$GET1^DIQ(2,VITALS("Vitals","patientId")_",",991.1)
"RTN","SYNDHP16",198,0)
 S VITALS("Vitals","vitalType")=$G(VITALSARR(FNBR1,IENS1,.03,"E"))
"RTN","SYNDHP16",199,0)
 S VITALS("Vitals","vitalTypeSc")=$$SENTENCE^XLFSTR(VITALS("Vitals","vitalType"))
"RTN","SYNDHP16",200,0)
 S VITALS("Vitals","vitalTypeId")=$G(VITALSARR(FNBR1,IENS1,.03,"I"))
"RTN","SYNDHP16",201,0)
 S VITALS("Vitals","dateTimeVitalsEntered")=$G(VITALSARR(FNBR1,IENS1,.04,"E"))
"RTN","SYNDHP16",202,0)
 S VITALS("Vitals","dateTimeVitalsEnteredFM")=$G(VITALSARR(FNBR1,IENS1,.04,"I"))
"RTN","SYNDHP16",203,0)
 S VITALS("Vitals","dateTimeVitalsEnteredHL7")=$$FMTHL7^XLFDT($G(VITALSARR(FNBR1,IENS1,.04,"I")))
"RTN","SYNDHP16",204,0)
 S VITALS("Vitals","dateTimeVitalsEnteredFHIR")=$$FMTFHIR^SYNDHPUTL($G(VITALSARR(FNBR1,IENS1,.04,"I")))
"RTN","SYNDHP16",205,0)
 S VITALS("Vitals","hospitalLocation")=$G(VITALSARR(FNBR1,IENS1,.05,"E"))
"RTN","SYNDHP16",206,0)
 S VITALS("Vitals","hospitalLocationId")=$G(VITALSARR(FNBR1,IENS1,.05,"I"))
"RTN","SYNDHP16",207,0)
 S VITALS("Vitals","enteredBy")=$G(VITALSARR(FNBR1,IENS1,.06,"E"))
"RTN","SYNDHP16",208,0)
 S VITALS("Vitals","enteredById")=$G(VITALSARR(FNBR1,IENS1,.06,"I"))
"RTN","SYNDHP16",209,0)
 S VITALS("Vitals","rate")=$G(VITALSARR(FNBR1,IENS1,1.2,"E"))
"RTN","SYNDHP16",210,0)
 S VITALS("Vitals","supplementalO2")=$G(VITALSARR(FNBR1,IENS1,1.4,"E"))
"RTN","SYNDHP16",211,0)
 S VITALS("Vitals","enteredInError")=$G(VITALSARR(FNBR1,IENS1,2,"E"))
"RTN","SYNDHP16",212,0)
 S VITALS("Vitals","enteredInErrorCd")=$G(VITALSARR(FNBR1,IENS1,2,"I"))
"RTN","SYNDHP16",213,0)
 S VITALS("Vitals","errorEnteredBy")=$G(VITALSARR(FNBR1,IENS1,3,"E"))
"RTN","SYNDHP16",214,0)
 S VITALS("Vitals","errorEnteredById")=$G(VITALSARR(FNBR1,IENS1,3,"I"))
"RTN","SYNDHP16",215,0)
 N REASERR
"RTN","SYNDHP16",216,0)
 N IENS2 S IENS2=""
"RTN","SYNDHP16",217,0)
 F  S IENS2=$O(VITALSARR(FNBR2,IENS2)) QUIT:IENS2=""  D
"RTN","SYNDHP16",218,0)
 . S REASERR=$NA(VITALS("Vitals","reasonEnteredInErrors","reasonEnteredInError",+IENS2))
"RTN","SYNDHP16",219,0)
 . S @REASERR@("reasonEnteredInError")=$G(VITALSARR(FNBR2,IENS2,.01,"E"))
"RTN","SYNDHP16",220,0)
 . S @REASERR@("reasonEnteredInErrorCd")=$G(VITALSARR(FNBR2,IENS2,.01,"I"))
"RTN","SYNDHP16",221,0)
 . S @REASERR@("dateReasonEnteredInError")=$G(VITALSARR(FNBR2,IENS2,.02,"E"))
"RTN","SYNDHP16",222,0)
 . S @REASERR@("dateReasonEnteredInErrorFM")=$G(VITALSARR(FNBR2,IENS2,.02,"I"))
"RTN","SYNDHP16",223,0)
 . S @REASERR@("dateReasonEnteredInErrorHL7")=$$FMTHL7^XLFDT($G(VITALSARR(FNBR2,IENS2,.02,"I")))
"RTN","SYNDHP16",224,0)
 . S @REASERR@("dateReasonEnteredInErrorFHIR")=$$FMTFHIR^SYNDHPUTL($G(VITALSARR(FNBR2,IENS2,.02,"I")))
"RTN","SYNDHP16",225,0)
 . S @REASERR@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_VITALSIEN_S_FNBR2_S_+IENS2
"RTN","SYNDHP16",226,0)
 N QUALIFY
"RTN","SYNDHP16",227,0)
 N IENS3 S IENS3=""
"RTN","SYNDHP16",228,0)
 F  S IENS3=$O(VITALSARR(FNBR3,IENS3)) QUIT:IENS3=""  D
"RTN","SYNDHP16",229,0)
 . S QUALIFY=$NA(VITALS("Vitals","qualifiers","qualifier",+IENS3))
"RTN","SYNDHP16",230,0)
 . S @QUALIFY@("qualifier")=$G(VITALSARR(FNBR3,IENS3,.01,"E"))
"RTN","SYNDHP16",231,0)
 . S @QUALIFY@("qualifierId")=$G(VITALSARR(FNBR3,IENS3,.01,"I"))
"RTN","SYNDHP16",232,0)
 . S @QUALIFY@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_VITALSIEN_S_FNBR3_S_+IENS3
"RTN","SYNDHP16",233,0)
 ;
"RTN","SYNDHP16",234,0)
 ;get snomed
"RTN","SYNDHP16",235,0)
 N SCT S SCT=""
"RTN","SYNDHP16",236,0)
 S SCT=$$MAP^SYNDHPMP("sct2vit",VITALS("Vitals","vitalTypeId"),"I")
"RTN","SYNDHP16",237,0)
 S VITALS("Vitals","vitalTypeSCT")=$S(+SCT=-1:"",1:$P(SCT,U,2))
"RTN","SYNDHP16",238,0)
 ;
"RTN","SYNDHP16",239,0)
 ;I $G(DEBUG) W ! ZWRITE VITALS
"RTN","SYNDHP16",240,0)
 ;
"RTN","SYNDHP16",241,0)
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.VITALS,.VITALSJ)
"RTN","SYNDHP16",242,0)
 ;
"RTN","SYNDHP16",243,0)
 QUIT
"RTN","SYNDHP16",244,0)
 ;
"RTN","SYNDHP17")
0^92^B47657021
"RTN","SYNDHP17",1,0)
SYNDHP17 ; HC/art - HealthConcourse - get MH Diagnosis, Flags data ;05/08/2019
"RTN","SYNDHP17",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP17",3,0)
 ;;
"RTN","SYNDHP17",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP17",5,0)
 ;
"RTN","SYNDHP17",6,0)
 QUIT
"RTN","SYNDHP17",7,0)
 ;
"RTN","SYNDHP17",8,0)
 ;-------------------------------------------------------------
"RTN","SYNDHP17",9,0)
 ;
"RTN","SYNDHP17",10,0)
GET1MHDX(MHDX,MHDXIEN,RETJSON,MHDXJ) ;get one Mental Health Diagnosis record
"RTN","SYNDHP17",11,0)
 ;inputs: MHDXIEN - Mental Health Diagnosis IEN
"RTN","SYNDHP17",12,0)
 ;        RETJSON - J = Return JSON
"RTN","SYNDHP17",13,0)
 ;output: MHDX  - array of Mental Health Diagnosis data, by reference
"RTN","SYNDHP17",14,0)
 ;        MHDXJ - JSON structure of Mental Health Diagnosis data, by reference
"RTN","SYNDHP17",15,0)
 ;
"RTN","SYNDHP17",16,0)
 I $G(DEBUG) W !,"--------------------------- Mental Health Diagnosis ----------------------------",!
"RTN","SYNDHP17",17,0)
 N S S S="_"
"RTN","SYNDHP17",18,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP17",19,0)
 N FNBR1 S FNBR1=627.8 ;DIAGNOSTIC RESULTS - MENTAL HEALTH
"RTN","SYNDHP17",20,0)
 N FNBR2 S FNBR2=627.82 ;MODIFIERS
"RTN","SYNDHP17",21,0)
 N FNBR3 S FNBR3=627.81 ;COMMENT
"RTN","SYNDHP17",22,0)
 N IENS1 S IENS1=MHDXIEN_","
"RTN","SYNDHP17",23,0)
 ;
"RTN","SYNDHP17",24,0)
 N MHDXARR,MHDXERR
"RTN","SYNDHP17",25,0)
 D GETS^DIQ(FNBR1,IENS1,"**","EI","MHDXARR","MHDXERR")
"RTN","SYNDHP17",26,0)
 I $G(DEBUG) W ! ZWRITE MHDXARR
"RTN","SYNDHP17",27,0)
 I $G(DEBUG),$D(MHDXERR) W !,">>ERROR<<" W ! ZWRITE MHDXERR
"RTN","SYNDHP17",28,0)
 I $D(MHDXERR) D  QUIT
"RTN","SYNDHP17",29,0)
 . S MHDX("Mhdiag","ERROR")=MHDXIEN
"RTN","SYNDHP17",30,0)
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.MHDX,.MHDXJ)
"RTN","SYNDHP17",31,0)
 S MHDX("Mhdiag","mhdiagIen")=MHDXIEN
"RTN","SYNDHP17",32,0)
 S MHDX("Mhdiag","resourceType")="Observation"
"RTN","SYNDHP17",33,0)
 S MHDX("Mhdiag","resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_MHDXIEN
"RTN","SYNDHP17",34,0)
 S MHDX("Mhdiag","fileEntryDate")=$G(MHDXARR(FNBR1,IENS1,.01,"E"))
"RTN","SYNDHP17",35,0)
 S MHDX("Mhdiag","fileEntryDateFM")=$G(MHDXARR(FNBR1,IENS1,.01,"I"))
"RTN","SYNDHP17",36,0)
 S MHDX("Mhdiag","fileEntryDateHL7")=$$FMTHL7^XLFDT($G(MHDXARR(FNBR1,IENS1,.01,"I")))
"RTN","SYNDHP17",37,0)
 S MHDX("Mhdiag","fileEntryDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(MHDXARR(FNBR1,IENS1,.01,"I")))
"RTN","SYNDHP17",38,0)
 S MHDX("Mhdiag","patientName")=$G(MHDXARR(FNBR1,IENS1,.02,"E"))
"RTN","SYNDHP17",39,0)
 S MHDX("Mhdiag","patientNameId")=$G(MHDXARR(FNBR1,IENS1,.02,"I"))
"RTN","SYNDHP17",40,0)
 S MHDX("Mhdiag","dateTimeOfDiagnosis")=$G(MHDXARR(FNBR1,IENS1,.03,"E"))
"RTN","SYNDHP17",41,0)
 S MHDX("Mhdiag","dateTimeOfDiagnosisFM")=$G(MHDXARR(FNBR1,IENS1,.03,"I"))
"RTN","SYNDHP17",42,0)
 S MHDX("Mhdiag","dateTimeOfDiagnosisHL7")=$$FMTHL7^XLFDT($G(MHDXARR(FNBR1,IENS1,.03,"I")))
"RTN","SYNDHP17",43,0)
 S MHDX("Mhdiag","dateTimeOfDiagnosisFHIR")=$$FMTFHIR^SYNDHPUTL($G(MHDXARR(FNBR1,IENS1,.03,"I")))
"RTN","SYNDHP17",44,0)
 S MHDX("Mhdiag","diagnosisBy")=$G(MHDXARR(FNBR1,IENS1,.04,"E"))
"RTN","SYNDHP17",45,0)
 S MHDX("Mhdiag","diagnosisById")=$G(MHDXARR(FNBR1,IENS1,.04,"I"))
"RTN","SYNDHP17",46,0)
 S MHDX("Mhdiag","transcriber")=$G(MHDXARR(FNBR1,IENS1,.05,"E"))
"RTN","SYNDHP17",47,0)
 S MHDX("Mhdiag","transcriberId")=$G(MHDXARR(FNBR1,IENS1,.05,"I"))
"RTN","SYNDHP17",48,0)
 S MHDX("Mhdiag","diagnosis")=$G(MHDXARR(FNBR1,IENS1,1,"E"))
"RTN","SYNDHP17",49,0)
 S MHDX("Mhdiag","diagnosisId")=$G(MHDXARR(FNBR1,IENS1,1,"I"))
"RTN","SYNDHP17",50,0)
 S MHDX("Mhdiag","statusVPRINRu")=$G(MHDXARR(FNBR1,IENS1,5,"E"))
"RTN","SYNDHP17",51,0)
 S MHDX("Mhdiag","statusVPRINRuCd")=$G(MHDXARR(FNBR1,IENS1,5,"I"))
"RTN","SYNDHP17",52,0)
 S MHDX("Mhdiag","condition")=$G(MHDXARR(FNBR1,IENS1,7,"E"))
"RTN","SYNDHP17",53,0)
 S MHDX("Mhdiag","conditionCd")=$G(MHDXARR(FNBR1,IENS1,7,"I"))
"RTN","SYNDHP17",54,0)
 S MHDX("Mhdiag","inactivatedDate")=$G(MHDXARR(FNBR1,IENS1,8,"E"))
"RTN","SYNDHP17",55,0)
 S MHDX("Mhdiag","inactivatedDateFM")=$G(MHDXARR(FNBR1,IENS1,8,"I"))
"RTN","SYNDHP17",56,0)
 S MHDX("Mhdiag","inactivatedDateHL7")=$$FMTHL7^XLFDT($G(MHDXARR(FNBR1,IENS1,8,"I")))
"RTN","SYNDHP17",57,0)
 S MHDX("Mhdiag","inactivatedDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(MHDXARR(FNBR1,IENS1,8,"I")))
"RTN","SYNDHP17",58,0)
 S MHDX("Mhdiag","statusChanged")=$G(MHDXARR(FNBR1,IENS1,9,"E"))
"RTN","SYNDHP17",59,0)
 S MHDX("Mhdiag","statusChangedCd")=$G(MHDXARR(FNBR1,IENS1,9,"I"))
"RTN","SYNDHP17",60,0)
 S MHDX("Mhdiag","dxls")=$G(MHDXARR(FNBR1,IENS1,10,"E"))
"RTN","SYNDHP17",61,0)
 S MHDX("Mhdiag","dxlsCd")=$G(MHDXARR(FNBR1,IENS1,10,"I"))
"RTN","SYNDHP17",62,0)
 S MHDX("Mhdiag","psychosocialStressor")=$G(MHDXARR(FNBR1,IENS1,60,"E"))
"RTN","SYNDHP17",63,0)
 S MHDX("Mhdiag","severityCode")=$G(MHDXARR(FNBR1,IENS1,61,"E"))
"RTN","SYNDHP17",64,0)
 S MHDX("Mhdiag","severityCodeCd")=$G(MHDXARR(FNBR1,IENS1,61,"I"))
"RTN","SYNDHP17",65,0)
 S MHDX("Mhdiag","axis5")=$G(MHDXARR(FNBR1,IENS1,65,"E"))
"RTN","SYNDHP17",66,0)
 S MHDX("Mhdiag","patientType")=$G(MHDXARR(FNBR1,IENS1,66,"E"))
"RTN","SYNDHP17",67,0)
 S MHDX("Mhdiag","patientTypeCd")=$G(MHDXARR(FNBR1,IENS1,66,"I"))
"RTN","SYNDHP17",68,0)
 N IENS2 S IENS2=""
"RTN","SYNDHP17",69,0)
 F  S IENS2=$O(MHDXARR(FNBR2,IENS2)) QUIT:IENS2=""  D
"RTN","SYNDHP17",70,0)
 . N MOD S MOD=$NA(MHDX("Mhdiag","modifierss","modifiers",+IENS2))
"RTN","SYNDHP17",71,0)
 . S @MOD@("modifier")=$G(MHDXARR(FNBR2,IENS2,.01,"E"))
"RTN","SYNDHP17",72,0)
 . S @MOD@("modifierId")=$G(MHDXARR(FNBR2,IENS2,.01,"I"))
"RTN","SYNDHP17",73,0)
 . S @MOD@("numberOfAnswer")=$G(MHDXARR(FNBR2,IENS2,1,"E"))
"RTN","SYNDHP17",74,0)
 . S @MOD@("standsFor")=$G(MHDXARR(FNBR2,IENS2,2,"E"))
"RTN","SYNDHP17",75,0)
 . S @MOD@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_MHDXIEN_S_FNBR2_S_+IENS2
"RTN","SYNDHP17",76,0)
 N IENS3 S IENS3=""
"RTN","SYNDHP17",77,0)
 F  S IENS3=$O(MHDXARR(FNBR3,IENS3)) QUIT:IENS3=""  D
"RTN","SYNDHP17",78,0)
 . N COMMENT S COMMENT=$NA(MHDX("Mhdiag","comments","comment",+IENS3))
"RTN","SYNDHP17",79,0)
 . S @COMMENT@("comment")=$G(MHDXARR(FNBR3,IENS3,.01,"E"))
"RTN","SYNDHP17",80,0)
 . S @COMMENT@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_MHDXIEN_S_FNBR3_S_+IENS3
"RTN","SYNDHP17",81,0)
 ;
"RTN","SYNDHP17",82,0)
 ;get SCT code
"RTN","SYNDHP17",83,0)
 S MHDX("Mhdiag","diagnosisSCT")=""
"RTN","SYNDHP17",84,0)
 I MHDX("Mhdiag","diagnosis")'="" D
"RTN","SYNDHP17",85,0)
 . N DATE S DATE=$S(MHDX("Mhdiag","dateTimeOfDiagnosisFM")'="":MHDX("Mhdiag","dateTimeOfDiagnosisFM"),1:MHDX("Mhdiag","fileEntryDateFM"))
"RTN","SYNDHP17",86,0)
 . N MAPPING S MAPPING=$S(DATE>3150930:"sct2icd",1:"sct2icdnine")
"RTN","SYNDHP17",87,0)
 . N SNOMED S SNOMED=$$MAP^SYNDHPMP(MAPPING,MHDX("Mhdiag","diagnosis"),"I")
"RTN","SYNDHP17",88,0)
 . S MHDX("Mhdiag","diagnosisSCT")=$S(+SNOMED=-1:"",1:$P(SNOMED,U,2))
"RTN","SYNDHP17",89,0)
 ;
"RTN","SYNDHP17",90,0)
 ;I $G(DEBUG) W ! ZWRITE DXMH
"RTN","SYNDHP17",91,0)
 ;
"RTN","SYNDHP17",92,0)
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.MHDX,.MHDXJ)
"RTN","SYNDHP17",93,0)
 ;
"RTN","SYNDHP17",94,0)
 QUIT
"RTN","SYNDHP17",95,0)
 ;
"RTN","SYNDHP17",96,0)
GET1FLAG(FLAG,FLAGIEN,RETJSON,FLAGJ) ;get one Flag record
"RTN","SYNDHP17",97,0)
 ;inputs: FLAGIEN - Flag IEN
"RTN","SYNDHP17",98,0)
 ;        RETJSON - J = Return JSON
"RTN","SYNDHP17",99,0)
 ;output: FLAG  - array of Flag data, by reference
"RTN","SYNDHP17",100,0)
 ;        FLAGJ - JSON structure of Flag data, by reference
"RTN","SYNDHP17",101,0)
 ;
"RTN","SYNDHP17",102,0)
 I $G(DEBUG) W !,"--------------------------- Flag -----------------------------",!
"RTN","SYNDHP17",103,0)
 N S S S="_"
"RTN","SYNDHP17",104,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP17",105,0)
 N FNBR1 S FNBR1=26.13 ;PRF ASSIGNMENT
"RTN","SYNDHP17",106,0)
 N FNBR2 S FNBR2=26.132 ;ASSIGNMENT NARRATIVE
"RTN","SYNDHP17",107,0)
 N IENS1 S IENS1=FLAGIEN_","
"RTN","SYNDHP17",108,0)
 ;
"RTN","SYNDHP17",109,0)
 N FLAGARR,FLAGERR
"RTN","SYNDHP17",110,0)
 D GETS^DIQ(FNBR1,IENS1,"**","EI","FLAGARR","FLAGERR")
"RTN","SYNDHP17",111,0)
 ;I $G(DEBUG) W ! ZWRITE FLAGARR
"RTN","SYNDHP17",112,0)
 ;I $G(DEBUG),$D(FLAGERR) W ">>ERROR<<" ZWRITE FLAGERR
"RTN","SYNDHP17",113,0)
 I $D(FLAGERR) D  QUIT
"RTN","SYNDHP17",114,0)
 . S FLAG("Flag","ERROR")=FLAGIEN
"RTN","SYNDHP17",115,0)
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.FLAG,.FLAGJ)
"RTN","SYNDHP17",116,0)
 S FLAG("Flag","flagIen")=FLAGIEN
"RTN","SYNDHP17",117,0)
 S FLAG("Flag","resourceType")="Observation"
"RTN","SYNDHP17",118,0)
 S FLAG("Flag","resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_FLAGIEN
"RTN","SYNDHP17",119,0)
 S FLAG("Flag","number")=$G(FLAGARR(FNBR1,IENS1,.001,"E"))
"RTN","SYNDHP17",120,0)
 S FLAG("Flag","patientName")=$G(FLAGARR(FNBR1,IENS1,.01,"E"))
"RTN","SYNDHP17",121,0)
 S FLAG("Flag","patientNameId")=$G(FLAGARR(FNBR1,IENS1,.01,"I"))
"RTN","SYNDHP17",122,0)
 S FLAG("Flag","patientICN")=$$GET1^DIQ(2,FLAG("Flag","patientNameId")_",",991.1)
"RTN","SYNDHP17",123,0)
 S FLAG("Flag","flagName")=$G(FLAGARR(FNBR1,IENS1,.02,"E"))
"RTN","SYNDHP17",124,0)
 S FLAG("Flag","flagNameId")=$G(FLAGARR(FNBR1,IENS1,.02,"I"))
"RTN","SYNDHP17",125,0)
 S FLAG("Flag","status")=$G(FLAGARR(FNBR1,IENS1,.03,"E"))
"RTN","SYNDHP17",126,0)
 S FLAG("Flag","statusCd")=$G(FLAGARR(FNBR1,IENS1,.03,"I"))
"RTN","SYNDHP17",127,0)
 S FLAG("Flag","ownerSite")=$G(FLAGARR(FNBR1,IENS1,.04,"E"))
"RTN","SYNDHP17",128,0)
 S FLAG("Flag","ownerSiteId")=$G(FLAGARR(FNBR1,IENS1,.04,"I"))
"RTN","SYNDHP17",129,0)
 S FLAG("Flag","originatingSite")=$G(FLAGARR(FNBR1,IENS1,.05,"E"))
"RTN","SYNDHP17",130,0)
 S FLAG("Flag","originatingSiteId")=$G(FLAGARR(FNBR1,IENS1,.05,"I"))
"RTN","SYNDHP17",131,0)
 S FLAG("Flag","reviewDate")=$G(FLAGARR(FNBR1,IENS1,.06,"E"))
"RTN","SYNDHP17",132,0)
 S FLAG("Flag","reviewDateFM")=$G(FLAGARR(FNBR1,IENS1,.06,"I"))
"RTN","SYNDHP17",133,0)
 S FLAG("Flag","reviewDateHL7")=$$FMTHL7^XLFDT($G(FLAGARR(FNBR1,IENS1,.06,"I")))
"RTN","SYNDHP17",134,0)
 S FLAG("Flag","reviewDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(FLAGARR(FNBR1,IENS1,.06,"I")))
"RTN","SYNDHP17",135,0)
 S FLAG("Flag","assignmentNarrative")=""
"RTN","SYNDHP17",136,0)
 N x S x=""
"RTN","SYNDHP17",137,0)
 F  S x=$O(FLAGARR(FNBR1,IENS1,1,x)) QUIT:'+x  D
"RTN","SYNDHP17",138,0)
 . S FLAG("Flag","assignmentNarrative")=FLAG("Flag","assignmentNarrative")_$G(FLAGARR(FNBR1,IENS1,1,x))
"RTN","SYNDHP17",139,0)
 ;
"RTN","SYNDHP17",140,0)
 ;get snomed
"RTN","SYNDHP17",141,0)
 N SCT
"RTN","SYNDHP17",142,0)
 S SCT=$$MAP^SYNDHPMP("flag2sct",FLAG("Flag","flagName"),"D")
"RTN","SYNDHP17",143,0)
 S FLAG("Flag","flagSCT")=$S(+SCT=-1:"",1:$P(SCT,U,2))
"RTN","SYNDHP17",144,0)
 ;
"RTN","SYNDHP17",145,0)
 ;I $G(DEBUG) W ! ZWRITE FLAG
"RTN","SYNDHP17",146,0)
 ;
"RTN","SYNDHP17",147,0)
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.FLAG,.FLAGJ)
"RTN","SYNDHP17",148,0)
 ;
"RTN","SYNDHP17",149,0)
 QUIT
"RTN","SYNDHP17",150,0)
 ;
"RTN","SYNDHP18")
0^93^B118565363
"RTN","SYNDHP18",1,0)
SYNDHP18 ; HC/art - HealthConcourse - get care team data ;03/27/2019
"RTN","SYNDHP18",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP18",3,0)
 ;;
"RTN","SYNDHP18",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP18",5,0)
 ;
"RTN","SYNDHP18",6,0)
 ;The authoratative source for VA care team data is PCMM Web. (currently no connection is available.)
"RTN","SYNDHP18",7,0)
 ; PCMM Web updates VistA files on a regular basis.
"RTN","SYNDHP18",8,0)
 ;
"RTN","SYNDHP18",9,0)
 QUIT
"RTN","SYNDHP18",10,0)
 ;
"RTN","SYNDHP18",11,0)
GET1TEAM(TEAM,TEAMIEN,RETJSON,TEAMJ) ;get one care team
"RTN","SYNDHP18",12,0)
 ;inputs: TEAMIEN - team IEN
"RTN","SYNDHP18",13,0)
 ;        RETJSON - J = Return JSON
"RTN","SYNDHP18",14,0)
 ;                  null or any other value = Return array (default)
"RTN","SYNDHP18",15,0)
 ;output: TEAM    - array of team data, by reference
"RTN","SYNDHP18",16,0)
 ;        TEAMJ   - JSON structure of team data, by reference
"RTN","SYNDHP18",17,0)
 ;
"RTN","SYNDHP18",18,0)
 N FNBR1 S FNBR1=404.51 ;TEAM
"RTN","SYNDHP18",19,0)
 N FNBR2 S FNBR2=404.58 ;TEAM HISTORY
"RTN","SYNDHP18",20,0)
 N S S S="_"
"RTN","SYNDHP18",21,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP18",22,0)
 N IENS S IENS=TEAMIEN_","
"RTN","SYNDHP18",23,0)
 N TMARR,TMERR
"RTN","SYNDHP18",24,0)
 D GETS^DIQ(FNBR1,IENS,"**","EI","TMARR","TMERR")
"RTN","SYNDHP18",25,0)
 ;I $G(DEBUG) W ! ZWRITE TMARR
"RTN","SYNDHP18",26,0)
 ;I $G(DEBUG),$D(TMERR) W !,">>ERROR<<" ZWRITE TMERR
"RTN","SYNDHP18",27,0)
 I $D(TMERR) D  QUIT
"RTN","SYNDHP18",28,0)
 . S TEAM("Team","ERROR")=TEAMIEN
"RTN","SYNDHP18",29,0)
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.TEAM,.TEAMJ)
"RTN","SYNDHP18",30,0)
 S TEAM("Team","resourceType")="CareTeam"
"RTN","SYNDHP18",31,0)
 S TEAM("Team","resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_TEAMIEN
"RTN","SYNDHP18",32,0)
 S TEAM("Team","teamName")=$G(TMARR(FNBR1,IENS,.01,"E"))
"RTN","SYNDHP18",33,0)
 S TEAM("Team","fhirTeamType")="longitudinal"
"RTN","SYNDHP18",34,0)
 S TEAM("Team","teamPhone")=$G(TMARR(FNBR1,IENS,.02,"E"))
"RTN","SYNDHP18",35,0)
 S TEAM("Team","teamPurposeId")=$G(TMARR(FNBR1,IENS,.03,"I"))
"RTN","SYNDHP18",36,0)
 S TEAM("Team","teamPurpose")=$G(TMARR(FNBR1,IENS,.03,"E"))
"RTN","SYNDHP18",37,0)
 S TEAM("Team","teamPrinterId")=$G(TMARR(FNBR1,IENS,.04,"I"))
"RTN","SYNDHP18",38,0)
 S TEAM("Team","teamPrinter")=$G(TMARR(FNBR1,IENS,.04,"E"))
"RTN","SYNDHP18",39,0)
 S TEAM("Team","canBePcCd")=$G(TMARR(FNBR1,IENS,.05,"I"))
"RTN","SYNDHP18",40,0)
 S TEAM("Team","canBePC")=$G(TMARR(FNBR1,IENS,.05,"E"))
"RTN","SYNDHP18",41,0)
 S TEAM("Team","serviceDeptId")=$G(TMARR(FNBR1,IENS,.06,"I"))
"RTN","SYNDHP18",42,0)
 S TEAM("Team","serviceDept")=$G(TMARR(FNBR1,IENS,.06,"E"))
"RTN","SYNDHP18",43,0)
 S TEAM("Team","institutionId")=$G(TMARR(FNBR1,IENS,.07,"I"))
"RTN","SYNDHP18",44,0)
 S TEAM("Team","institution")=$G(TMARR(FNBR1,IENS,.07,"E"))
"RTN","SYNDHP18",45,0)
 S TEAM("Team","maxPatients")=$G(TMARR(FNBR1,IENS,.08,"E"))
"RTN","SYNDHP18",46,0)
 S TEAM("Team","max%PCPatients")=$G(TMARR(FNBR1,IENS,.09,"E"))
"RTN","SYNDHP18",47,0)
 S TEAM("Team","closeToFutureAssignId")=$G(TMARR(FNBR1,IENS,.1,"I"))
"RTN","SYNDHP18",48,0)
 S TEAM("Team","closeToFutureAssign")=$G(TMARR(FNBR1,IENS,.1,"E"))
"RTN","SYNDHP18",49,0)
 S TEAM("Team","autoAssignId")=$G(TMARR(FNBR1,IENS,.11,"I"))
"RTN","SYNDHP18",50,0)
 S TEAM("Team","autoAssign")=$G(TMARR(FNBR1,IENS,.11,"E"))
"RTN","SYNDHP18",51,0)
 S TEAM("Team","autoDischargeId")=$G(TMARR(FNBR1,IENS,.12,"I"))
"RTN","SYNDHP18",52,0)
 S TEAM("Team","autoDischarge")=$G(TMARR(FNBR1,IENS,.12,"E"))
"RTN","SYNDHP18",53,0)
 S TEAM("Team","restrictConsultsId")=$G(TMARR(FNBR1,IENS,.13,"I"))
"RTN","SYNDHP18",54,0)
 S TEAM("Team","restrictConsults")=$G(TMARR(FNBR1,IENS,.13,"E"))
"RTN","SYNDHP18",55,0)
 S TEAM("Team","description")=$G(TMARR(FNBR1,IENS,50,1))_$G(TMARR(FNBR1,IENS,50,2)) ;<<<
"RTN","SYNDHP18",56,0)
 S TEAM("Team","current#PatientsC")=$G(TMARR(FNBR1,IENS,201,"E"))
"RTN","SYNDHP18",57,0)
 S TEAM("Team","currentStatusC")=$G(TMARR(FNBR1,IENS,202,"E"))
"RTN","SYNDHP18",58,0)
 S TEAM("Team","currentEffectiveDateC")=$G(TMARR(FNBR1,IENS,203,"E"))
"RTN","SYNDHP18",59,0)
 S TEAM("Team","currentEffectiveDateCFM")=$$DATECNVT^SYNDHPUTL($G(TMARR(FNBR1,IENS,203,"E")))
"RTN","SYNDHP18",60,0)
 S TEAM("Team","currentEffectiveDateCHL7")=$$FMTHL7^XLFDT($$DATECNVT^SYNDHPUTL($G(TMARR(FNBR1,IENS,203,"E"))))
"RTN","SYNDHP18",61,0)
 S TEAM("Team","currentEffectiveDateCFHIR")=$$FMTFHIR^SYNDHPUTL($$DATECNVT^SYNDHPUTL($G(TMARR(FNBR1,IENS,203,"E"))))
"RTN","SYNDHP18",62,0)
 S TEAM("Team","currentActivationDateC")=$G(TMARR(FNBR1,IENS,204,"E"))
"RTN","SYNDHP18",63,0)
 S TEAM("Team","currentActivationDateCFM")=$$DATECNVT^SYNDHPUTL($G(TMARR(FNBR1,IENS,204,"E")))
"RTN","SYNDHP18",64,0)
 S TEAM("Team","currentActivationDateCHL7")=$$FMTHL7^XLFDT($$DATECNVT^SYNDHPUTL($G(TMARR(FNBR1,IENS,204,"E"))))
"RTN","SYNDHP18",65,0)
 S TEAM("Team","currentActivationDateCFHIR")=$$FMTFHIR^SYNDHPUTL($$DATECNVT^SYNDHPUTL($G(TMARR(FNBR1,IENS,204,"E"))))
"RTN","SYNDHP18",66,0)
 S TEAM("Team","currentInactivationDateC")=$G(TMARR(FNBR1,IENS,205,"E"))
"RTN","SYNDHP18",67,0)
 S TEAM("Team","currentInactivationDateCFM")=$$DATECNVT^SYNDHPUTL($G(TMARR(FNBR1,IENS,205,"E")))
"RTN","SYNDHP18",68,0)
 S TEAM("Team","currentInactivationDateCHL7")=$$FMTHL7^XLFDT($$DATECNVT^SYNDHPUTL($G(TMARR(FNBR1,IENS,205,"E"))))
"RTN","SYNDHP18",69,0)
 S TEAM("Team","currentInactivationDateCFHIR")=$$FMTFHIR^SYNDHPUTL($$DATECNVT^SYNDHPUTL($G(TMARR(FNBR1,IENS,205,"E"))))
"RTN","SYNDHP18",70,0)
 ;
"RTN","SYNDHP18",71,0)
 N STATIEN S STATIEN=0
"RTN","SYNDHP18",72,0)
 F  S STATIEN=$O(^SCTM(FNBR2,"B",TEAMIEN,STATIEN)) QUIT:+STATIEN=0  D
"RTN","SYNDHP18",73,0)
 . N IENS2 S IENS2=STATIEN_","
"RTN","SYNDHP18",74,0)
 . N STATARR,STATERR
"RTN","SYNDHP18",75,0)
 . D GETS^DIQ(FNBR2,IENS2,"**","EI","STATARR","STATERR")
"RTN","SYNDHP18",76,0)
 . ;I $G(DEBUG) W ! ZWRITE STATARR
"RTN","SYNDHP18",77,0)
 . ;I $G(DEBUG),$D(STATERR) W !,">>ERROR<<" ZWRITE STATERR
"RTN","SYNDHP18",78,0)
 . I $D(STATERR) D  QUIT
"RTN","SYNDHP18",79,0)
 . . S TEAM("Team","teamStatus","status",STATIEN,"ERROR")=STATIEN
"RTN","SYNDHP18",80,0)
 . . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.TEAM,.TEAMJ)
"RTN","SYNDHP18",81,0)
 . N TEAMSTAT S TEAMSTAT=$NA(TEAM("Team","teamStatus","status",STATIEN))
"RTN","SYNDHP18",82,0)
 . S @TEAMSTAT@("statusCd")=$G(STATARR(FNBR2,IENS2,.03,"I"))
"RTN","SYNDHP18",83,0)
 . S @TEAMSTAT@("status")=$G(STATARR(FNBR2,IENS2,.03,"E"))
"RTN","SYNDHP18",84,0)
 . S @TEAMSTAT@("effectiveDate")=$G(STATARR(FNBR2,IENS2,.02,"E"))
"RTN","SYNDHP18",85,0)
 . S @TEAMSTAT@("effectiveDateFM")=$G(STATARR(FNBR2,IENS2,.02,"I"))
"RTN","SYNDHP18",86,0)
 . S @TEAMSTAT@("effectiveDateHL7")=$$FMTHL7^XLFDT($G(STATARR(FNBR2,IENS2,.02,"I")))
"RTN","SYNDHP18",87,0)
 . S @TEAMSTAT@("effectiveDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(STATARR(FNBR2,IENS2,.02,"I")))
"RTN","SYNDHP18",88,0)
 . S @TEAMSTAT@("statusReasonId")=$G(STATARR(FNBR2,IENS2,.04,"I"))
"RTN","SYNDHP18",89,0)
 . S @TEAMSTAT@("statusReason")=$G(STATARR(FNBR2,IENS2,.04,"E"))
"RTN","SYNDHP18",90,0)
 . S @TEAMSTAT@("statusRecordId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR2_S_STATIEN
"RTN","SYNDHP18",91,0)
 ;
"RTN","SYNDHP18",92,0)
 N POSITION
"RTN","SYNDHP18",93,0)
 D TEAMPOS(.POSITION,TEAMIEN,0)
"RTN","SYNDHP18",94,0)
 M TEAM("Team","positions")=POSITION
"RTN","SYNDHP18",95,0)
 ;I $G(DEBUG) W ! ZWRITE TEAM
"RTN","SYNDHP18",96,0)
 ;
"RTN","SYNDHP18",97,0)
 I $G(RETJSON)="J" D
"RTN","SYNDHP18",98,0)
 . N TEAMS M TEAMS("Teams",TEAMIEN)=TEAM
"RTN","SYNDHP18",99,0)
 . D TOJASON^SYNDHPUTL(.TEAMS,.TEAMJ)
"RTN","SYNDHP18",100,0)
 . ;I $G(DEBUG) W ! ZWRITE TEAM
"RTN","SYNDHP18",101,0)
 ;
"RTN","SYNDHP18",102,0)
 QUIT
"RTN","SYNDHP18",103,0)
 ;
"RTN","SYNDHP18",104,0)
TEAMPOS(POSITION,TEAMIEN,RETJSON,POSITIONJ) ;get team positions
"RTN","SYNDHP18",105,0)
 ;inputs: TEAMIEN - team IEN
"RTN","SYNDHP18",106,0)
 ;        RETJSON - J = Return JSON
"RTN","SYNDHP18",107,0)
 ;                  null or any other value = Return array (default)
"RTN","SYNDHP18",108,0)
 ;Output: POSITION - an array of position data, by reference
"RTN","SYNDHP18",109,0)
 ;        POSITIONJ - JSON structure, by reference
"RTN","SYNDHP18",110,0)
 ;
"RTN","SYNDHP18",111,0)
 N FNBR1 S FNBR1=404.57 ;TEAM POSITION
"RTN","SYNDHP18",112,0)
 N FNBR2 S FNBR2=404.575 ;TEAM POSITION:ASSOCIATED CLINICS
"RTN","SYNDHP18",113,0)
 N FNBR3 S FNBR3=404.59 ;TEAM POSITION HISTORY
"RTN","SYNDHP18",114,0)
 N S S S="_"
"RTN","SYNDHP18",115,0)
 N ROLENAME
"RTN","SYNDHP18",116,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP18",117,0)
 N POSIEN S POSIEN=0
"RTN","SYNDHP18",118,0)
 F  S POSIEN=$O(^SCTM(FNBR1,"C",TEAMIEN,POSIEN)) QUIT:+POSIEN=0  D
"RTN","SYNDHP18",119,0)
 . N IENS S IENS=POSIEN_","
"RTN","SYNDHP18",120,0)
 . N POSARR,POSERR
"RTN","SYNDHP18",121,0)
 . D GETS^DIQ(FNBR1,IENS,"**","EI","POSARR","POSERR")
"RTN","SYNDHP18",122,0)
 . ;I $G(DEBUG) W ! ZWRITE POSARR
"RTN","SYNDHP18",123,0)
 . ;I $G(DEBUG),$D(POSERR) W !,">>ERROR<<" ZWRITE POSERR
"RTN","SYNDHP18",124,0)
 . I $D(POSERR) D  QUIT
"RTN","SYNDHP18",125,0)
 . . S POSITION("position",POSIEN,"ERROR")=POSIEN
"RTN","SYNDHP18",126,0)
 . . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.POSITION,.POSITIONJ)
"RTN","SYNDHP18",127,0)
 . N TEAMPOS S TEAMPOS=$NA(POSITION("position",POSIEN))
"RTN","SYNDHP18",128,0)
 . S @TEAMPOS@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_POSIEN
"RTN","SYNDHP18",129,0)
 . S @TEAMPOS@("positionIen")=POSIEN
"RTN","SYNDHP18",130,0)
 . S @TEAMPOS@("positionName")=$G(POSARR(FNBR1,IENS,.01,"E"))
"RTN","SYNDHP18",131,0)
 . S @TEAMPOS@("teamId")=$G(POSARR(FNBR1,IENS,.02,"I"))
"RTN","SYNDHP18",132,0)
 . S @TEAMPOS@("team")=$G(POSARR(FNBR1,IENS,.02,"E"))
"RTN","SYNDHP18",133,0)
 . S @TEAMPOS@("standRoleNameId")=$G(POSARR(FNBR1,IENS,.03,"I"))
"RTN","SYNDHP18",134,0)
 . S @TEAMPOS@("standRoleName")=$G(POSARR(FNBR1,IENS,.03,"E"))
"RTN","SYNDHP18",135,0)
 . S ROLENAME=$G(POSARR(FNBR1,IENS,.03,"E")) ;used below for SCT lookup
"RTN","SYNDHP18",136,0)
 . S @TEAMPOS@("possPrimPractId")=$G(POSARR(FNBR1,IENS,.04,"I"))
"RTN","SYNDHP18",137,0)
 . S @TEAMPOS@("possPrimPract")=$G(POSARR(FNBR1,IENS,.04,"E"))
"RTN","SYNDHP18",138,0)
 . S @TEAMPOS@("max#patients")=$G(POSARR(FNBR1,IENS,.08,"E"))
"RTN","SYNDHP18",139,0)
 . ;S @TEAMPOS@("NAassocClinic")=$G(POSARR(FNBR1,IENS,.09,"E")) ;field is no longer used
"RTN","SYNDHP18",140,0)
 . S @TEAMPOS@("beeperNbr")=$G(POSARR(FNBR1,IENS,.11,"E"))
"RTN","SYNDHP18",141,0)
 . S @TEAMPOS@("canBePreceptor")=$G(POSARR(FNBR1,IENS,.12,"E"))
"RTN","SYNDHP18",142,0)
 . S @TEAMPOS@("userClass")=$G(POSARR(FNBR1,IENS,.13,"E"))
"RTN","SYNDHP18",143,0)
 . S @TEAMPOS@("description")=$G(POSARR(FNBR1,IENS,1,1))_$G(POSARR(FNBR1,IENS,1,2)) ;<<<
"RTN","SYNDHP18",144,0)
 . S @TEAMPOS@("deathMsg")=$G(POSARR(FNBR1,IENS,2.01,"E"))
"RTN","SYNDHP18",145,0)
 . S @TEAMPOS@("inpatientMsg")=$G(POSARR(FNBR1,IENS,2.02,"E"))
"RTN","SYNDHP18",146,0)
 . S @TEAMPOS@("teamMsg")=$G(POSARR(FNBR1,IENS,2.03,"E"))
"RTN","SYNDHP18",147,0)
 . S @TEAMPOS@("consultMsg")=$G(POSARR(FNBR1,IENS,2.04,"E"))
"RTN","SYNDHP18",148,0)
 . S @TEAMPOS@("precepDeathMsg")=$G(POSARR(FNBR1,IENS,2.05,"E"))
"RTN","SYNDHP18",149,0)
 . S @TEAMPOS@("precepInpatientMsg")=$G(POSARR(FNBR1,IENS,2.06,"E"))
"RTN","SYNDHP18",150,0)
 . S @TEAMPOS@("precepTeamMsg")=$G(POSARR(FNBR1,IENS,2.07,"E"))
"RTN","SYNDHP18",151,0)
 . S @TEAMPOS@("precepConsultMsg")=$G(POSARR(FNBR1,IENS,2.08,"E"))
"RTN","SYNDHP18",152,0)
 . S @TEAMPOS@("autoInactMsg")=$G(POSARR(FNBR1,IENS,2.09,"E"))
"RTN","SYNDHP18",153,0)
 . S @TEAMPOS@("precepInactMsg")=$G(POSARR(FNBR1,IENS,2.1,"E"))
"RTN","SYNDHP18",154,0)
 . N IENS2 S IENS2=""
"RTN","SYNDHP18",155,0)
 . F  S IENS2=$O(POSARR(FNBR2,IENS2)) QUIT:IENS2=""  D
"RTN","SYNDHP18",156,0)
 . . N TEAMCLIN S TEAMCLIN=$NA(POSITION("position",POSIEN,"associatedClinics","clinic",+IENS2))
"RTN","SYNDHP18",157,0)
 . . S @TEAMCLIN@("assocClincId")=$G(POSARR(FNBR2,IENS2,.01,"I"))
"RTN","SYNDHP18",158,0)
 . . S @TEAMCLIN@("assocClinc")=$G(POSARR(FNBR2,IENS2,.01,"E"))
"RTN","SYNDHP18",159,0)
 . . S @TEAMCLIN@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_POSIEN_S_FNBR2_S_+IENS2
"RTN","SYNDHP18",160,0)
 . S @TEAMPOS@("curr#PCpatsC")=$G(POSARR(FNBR1,IENS,200,"E"))
"RTN","SYNDHP18",161,0)
 . S @TEAMPOS@("curr#PatientsC")=$G(POSARR(FNBR1,IENS,201,"E"))
"RTN","SYNDHP18",162,0)
 . S @TEAMPOS@("future#PCpatsC")=$G(POSARR(FNBR1,IENS,202,"E"))
"RTN","SYNDHP18",163,0)
 . S @TEAMPOS@("future#PatientsC")=$G(POSARR(FNBR1,IENS,203,"E"))
"RTN","SYNDHP18",164,0)
 . S @TEAMPOS@("currStatusC")=$G(POSARR(FNBR1,IENS,300,"E"))
"RTN","SYNDHP18",165,0)
 . S @TEAMPOS@("currEffectDateC")=$G(POSARR(FNBR1,IENS,301,"E"))
"RTN","SYNDHP18",166,0)
 . S @TEAMPOS@("currEffectDateCFM")=$$DATECNVT^SYNDHPUTL($G(POSARR(FNBR1,IENS,301,"E")))
"RTN","SYNDHP18",167,0)
 . S @TEAMPOS@("currEffectDateCHL7")=$$FMTHL7^XLFDT($$DATECNVT^SYNDHPUTL($G(POSARR(FNBR1,IENS,301,"E"))))
"RTN","SYNDHP18",168,0)
 . S @TEAMPOS@("currEffectDateCFHIR")=$$FMTFHIR^SYNDHPUTL($$DATECNVT^SYNDHPUTL($G(POSARR(FNBR1,IENS,301,"E"))))
"RTN","SYNDHP18",169,0)
 . S @TEAMPOS@("currActDateC")=$G(POSARR(FNBR1,IENS,302,"E"))
"RTN","SYNDHP18",170,0)
 . S @TEAMPOS@("currActDateCFM")=$$DATECNVT^SYNDHPUTL($G(POSARR(FNBR1,IENS,302,"E")))
"RTN","SYNDHP18",171,0)
 . S @TEAMPOS@("currActDateCHL7")=$$FMTHL7^XLFDT($$DATECNVT^SYNDHPUTL($G(POSARR(FNBR1,IENS,302,"E"))))
"RTN","SYNDHP18",172,0)
 . S @TEAMPOS@("currActDateCFHIR")=$$FMTFHIR^SYNDHPUTL($$DATECNVT^SYNDHPUTL($G(POSARR(FNBR1,IENS,302,"E"))))
"RTN","SYNDHP18",173,0)
 . S @TEAMPOS@("currInactDateC")=$G(POSARR(FNBR1,IENS,303,"E"))
"RTN","SYNDHP18",174,0)
 . S @TEAMPOS@("currInactDateCFM")=$$DATECNVT^SYNDHPUTL($G(POSARR(FNBR1,IENS,303,"E")))
"RTN","SYNDHP18",175,0)
 . S @TEAMPOS@("currInactDateCHL7")=$$FMTHL7^XLFDT($$DATECNVT^SYNDHPUTL($G(POSARR(FNBR1,IENS,303,"E"))))
"RTN","SYNDHP18",176,0)
 . S @TEAMPOS@("currInactDateFHIR")=$$FMTFHIR^SYNDHPUTL($$DATECNVT^SYNDHPUTL($G(POSARR(FNBR1,IENS,303,"E"))))
"RTN","SYNDHP18",177,0)
 . S @TEAMPOS@("currPractitionerC")=$G(POSARR(FNBR1,IENS,304,"E"))
"RTN","SYNDHP18",178,0)
 . S @TEAMPOS@("currPrecptorPosC")=$G(POSARR(FNBR1,IENS,305,"E"))
"RTN","SYNDHP18",179,0)
 . S @TEAMPOS@("currPreceptorC")=$G(POSARR(FNBR1,IENS,306,"E"))
"RTN","SYNDHP18",180,0)
 . S @TEAMPOS@("activePreceptsC")=$G(POSARR(FNBR1,IENS,307,"E"))
"RTN","SYNDHP18",181,0)
 . S @TEAMPOS@("allowPreceptedChngC")=$G(POSARR(FNBR1,IENS,400,"E"))
"RTN","SYNDHP18",182,0)
 . S @TEAMPOS@("allowPreceptorChngC")=$G(POSARR(FNBR1,IENS,401,"E"))
"RTN","SYNDHP18",183,0)
 . S @TEAMPOS@("inconsistentReasonC")=$G(POSARR(FNBR1,IENS,402,"E"))
"RTN","SYNDHP18",184,0)
 . ;team position history
"RTN","SYNDHP18",185,0)
 . N STATIEN S STATIEN=0
"RTN","SYNDHP18",186,0)
 . F  S STATIEN=$O(^SCTM(FNBR3,"B",POSIEN,STATIEN)) QUIT:+STATIEN=0  D
"RTN","SYNDHP18",187,0)
 . . N IENS3 S IENS3=STATIEN_","
"RTN","SYNDHP18",188,0)
 . . N STATARR,STATERR
"RTN","SYNDHP18",189,0)
 . . D GETS^DIQ(FNBR3,IENS3,"**","EI","STATARR","STATERR")
"RTN","SYNDHP18",190,0)
 . . ;I $G(DEBUG) W ! ZWRITE STATARR
"RTN","SYNDHP18",191,0)
 . . ;I $G(DEBUG),$D(STATERR) W !,">>ERROR<<" ZWRITE STATERR
"RTN","SYNDHP18",192,0)
 . . I $D(STATERR) S POSITION("position",POSIEN,"positionStatus","status",STATIEN,"ERROR")=STATIEN QUIT
"RTN","SYNDHP18",193,0)
 . . N POSSTAT S POSSTAT=$NA(POSITION("position",POSIEN,"positionStatus","status",STATIEN))
"RTN","SYNDHP18",194,0)
 . . S @POSSTAT@("statusCd")=$G(STATARR(FNBR3,IENS3,.03,"I"))
"RTN","SYNDHP18",195,0)
 . . S @POSSTAT@("status")=$G(STATARR(FNBR3,IENS3,.03,"E"))
"RTN","SYNDHP18",196,0)
 . . S @POSSTAT@("effectiveDate")=$G(STATARR(FNBR3,IENS3,.02,"E"))
"RTN","SYNDHP18",197,0)
 . . S @POSSTAT@("effectiveDateFM")=$G(STATARR(FNBR3,IENS3,.02,"I"))
"RTN","SYNDHP18",198,0)
 . . S @POSSTAT@("effectiveDateHL7")=$$FMTHL7^XLFDT($G(STATARR(FNBR3,IENS3,.02,"I")))
"RTN","SYNDHP18",199,0)
 . . S @POSSTAT@("effectiveDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(STATARR(FNBR3,IENS3,.02,"I")))
"RTN","SYNDHP18",200,0)
 . . S @POSSTAT@("statusReasonId")=$G(STATARR(FNBR3,IENS3,.04,"I"))
"RTN","SYNDHP18",201,0)
 . . S @POSSTAT@("statusReason")=$G(STATARR(FNBR3,IENS3,.04,"E"))
"RTN","SYNDHP18",202,0)
 . . S @POSSTAT@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR3_S_STATIEN
"RTN","SYNDHP18",203,0)
 . ;
"RTN","SYNDHP18",204,0)
 . N SCT S SCT=$$MAP^SYNDHPMP("ctpos2sct",ROLENAME,"D")
"RTN","SYNDHP18",205,0)
 . S POSITION("position",POSIEN,"standRoleSct")=$S(+SCT=-1:"",1:$P(SCT,U,2))
"RTN","SYNDHP18",206,0)
 . ;
"RTN","SYNDHP18",207,0)
 . ;position assignment history
"RTN","SYNDHP18",208,0)
 . N ASGNHIST,ASGNHISTJ
"RTN","SYNDHP18",209,0)
 . D ASGNHIST^SYNDHP19(.ASGNHIST,TEAMIEN,0)
"RTN","SYNDHP18",210,0)
 . M POSITION("position",POSIEN,"positionAssignmentHistory")=ASGNHIST
"RTN","SYNDHP18",211,0)
 . ;
"RTN","SYNDHP18",212,0)
 . ;preceptor assignment history
"RTN","SYNDHP18",213,0)
 . N PRECHIST,PRECHISTJ
"RTN","SYNDHP18",214,0)
 . D PRECHIST^SYNDHP19(.PRECHIST,POSIEN,0)
"RTN","SYNDHP18",215,0)
 . M POSITION("position",POSIEN,"preceptorAssignmentHistory")=PRECHIST
"RTN","SYNDHP18",216,0)
 . ;
"RTN","SYNDHP18",217,0)
 . ;I $G(DEBUG) W ! ZWRITE POSITION
"RTN","SYNDHP18",218,0)
 ;
"RTN","SYNDHP18",219,0)
 I $G(RETJSON)="J" D
"RTN","SYNDHP18",220,0)
 . N POSITIONS M POSITIONS("TeamPositions")=POSITION
"RTN","SYNDHP18",221,0)
 . D TOJASON^SYNDHPUTL(.POSITIONS,.POSITIONJ)
"RTN","SYNDHP18",222,0)
 . ;I $G(DEBUG) W ! ZWRITE POSITIONSJ
"RTN","SYNDHP18",223,0)
 ;
"RTN","SYNDHP18",224,0)
 QUIT
"RTN","SYNDHP18",225,0)
 ;
"RTN","SYNDHP19")
0^94^B43797002
"RTN","SYNDHP19",1,0)
SYNDHP19 ; HC/art - HealthConcourse - get care team data ;03/27/2019
"RTN","SYNDHP19",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP19",3,0)
 ;;
"RTN","SYNDHP19",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP19",5,0)
 ;
"RTN","SYNDHP19",6,0)
 ;The authoratative source for care team data is PCMM Web. (currently no connection is available.)
"RTN","SYNDHP19",7,0)
 ; PCMM Web updates VistA files on a regular basis.
"RTN","SYNDHP19",8,0)
 ;
"RTN","SYNDHP19",9,0)
 QUIT
"RTN","SYNDHP19",10,0)
 ;
"RTN","SYNDHP19",11,0)
ASGNHIST(ASGNHIST,POSIEN,RETJSON,ASGNHISTJ) ;get team position assignment history
"RTN","SYNDHP19",12,0)
 ;inputs: POSIEN - team position IEN
"RTN","SYNDHP19",13,0)
 ;        RETJSON - J = Return JSON
"RTN","SYNDHP19",14,0)
 ;                  null or any other value = Return array (default)
"RTN","SYNDHP19",15,0)
 ;Output: ASGNHIST - an array of position assignment history data, by reference
"RTN","SYNDHP19",16,0)
 ;        ASGNHISTJ - JSON structure, by reference
"RTN","SYNDHP19",17,0)
 ;
"RTN","SYNDHP19",18,0)
 N FNBR1 S FNBR1=404.52 ;POSITION ASSIGNMENT HISTORY
"RTN","SYNDHP19",19,0)
 N FNBR2 S FNBR2=404.521 ;POSITION ASSIGNMENT HISTORY:FTEE HISTORY
"RTN","SYNDHP19",20,0)
 N S S S="_"
"RTN","SYNDHP19",21,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP19",22,0)
 N HISTIEN S HISTIEN=0
"RTN","SYNDHP19",23,0)
 F  S HISTIEN=$O(^SCTM(FNBR1,"B",POSIEN,HISTIEN)) QUIT:+HISTIEN=0  D
"RTN","SYNDHP19",24,0)
 . N IENS S IENS=HISTIEN_","
"RTN","SYNDHP19",25,0)
 . N HISTARR,HISTERR
"RTN","SYNDHP19",26,0)
 . D GETS^DIQ(FNBR1,IENS,"**","EI","HISTARR","HISTERR")
"RTN","SYNDHP19",27,0)
 . ;I $G(DEBUG) W ! ZWRITE HISTARR
"RTN","SYNDHP19",28,0)
 . ;I $G(DEBUG),$D(HISTERR) W !,">>ERROR<<" ZWRITE HISTERR
"RTN","SYNDHP19",29,0)
 . I $D(HISTERR) D  QUIT
"RTN","SYNDHP19",30,0)
 . . S ASGNHIST("posAssignHist",HISTIEN,"ERROR")=HISTIEN
"RTN","SYNDHP19",31,0)
 . . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.ASGNHIST,.ASGNHISTJ)
"RTN","SYNDHP19",32,0)
 . N AHIST S AHIST=$NA(ASGNHIST("posAssignHist",HISTIEN))
"RTN","SYNDHP19",33,0)
 . S @AHIST@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_HISTIEN
"RTN","SYNDHP19",34,0)
 . S @AHIST@("assignHistIen")=HISTIEN
"RTN","SYNDHP19",35,0)
 . S @AHIST@("teamPositionId")=$G(HISTARR(FNBR1,IENS,.01,"I"))
"RTN","SYNDHP19",36,0)
 . S @AHIST@("teamPositionName")=$G(HISTARR(FNBR1,IENS,.01,"E"))
"RTN","SYNDHP19",37,0)
 . S @AHIST@("effectiveDate")=$G(HISTARR(FNBR1,IENS,.02,"E"))
"RTN","SYNDHP19",38,0)
 . S @AHIST@("effectiveDateFM")=$G(HISTARR(FNBR1,IENS,.02,"I"))
"RTN","SYNDHP19",39,0)
 . S @AHIST@("effectiveDateHL7")=$$FMTHL7^XLFDT($G(HISTARR(FNBR1,IENS,.02,"I")))
"RTN","SYNDHP19",40,0)
 . S @AHIST@("effectiveDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(HISTARR(FNBR1,IENS,.02,"I")))
"RTN","SYNDHP19",41,0)
 . S @AHIST@("practitionerId")=$G(HISTARR(FNBR1,IENS,.03,"I"))
"RTN","SYNDHP19",42,0)
 . S @AHIST@("practitioner")=$G(HISTARR(FNBR1,IENS,.03,"E"))
"RTN","SYNDHP19",43,0)
 . S @AHIST@("statusCd")=$G(HISTARR(FNBR1,IENS,.04,"I"))
"RTN","SYNDHP19",44,0)
 . S @AHIST@("status")=$G(HISTARR(FNBR1,IENS,.04,"E"))
"RTN","SYNDHP19",45,0)
 . S @AHIST@("statusReasonId")=$G(HISTARR(FNBR1,IENS,.05,"I"))
"RTN","SYNDHP19",46,0)
 . S @AHIST@("statusReason")=$G(HISTARR(FNBR1,IENS,.05,"E"))
"RTN","SYNDHP19",47,0)
 . S @AHIST@("userEnteringId")=$G(HISTARR(FNBR1,IENS,.07,"I"))
"RTN","SYNDHP19",48,0)
 . S @AHIST@("userEntering")=$G(HISTARR(FNBR1,IENS,.07,"E"))
"RTN","SYNDHP19",49,0)
 . S @AHIST@("dateTimeEntered")=$G(HISTARR(FNBR1,IENS,.08,"E"))
"RTN","SYNDHP19",50,0)
 . S @AHIST@("dateTimeEnteredFM")=$G(HISTARR(FNBR1,IENS,.08,"I"))
"RTN","SYNDHP19",51,0)
 . S @AHIST@("dateTimeEnteredHL7")=$$FMTHL7^XLFDT($G(HISTARR(FNBR1,IENS,.08,"I")))
"RTN","SYNDHP19",52,0)
 . S @AHIST@("dateTimeEnteredFHIR")=$$FMTFHIR^SYNDHPUTL($G(HISTARR(FNBR1,IENS,.08,"I")))
"RTN","SYNDHP19",53,0)
 . S @AHIST@("fteeEquivalent")=$G(HISTARR(FNBR1,IENS,.09,"E"))
"RTN","SYNDHP19",54,0)
 . S @AHIST@("dateFlagedInactivation")=$G(HISTARR(FNBR1,IENS,.091,"E"))
"RTN","SYNDHP19",55,0)
 . S @AHIST@("dateFlagedInactivationFM")=$G(HISTARR(FNBR1,IENS,.091,"I"))
"RTN","SYNDHP19",56,0)
 . S @AHIST@("dateFlagedInactivationHL7")=$$FMTHL7^XLFDT($G(HISTARR(FNBR1,IENS,.091,"I")))
"RTN","SYNDHP19",57,0)
 . S @AHIST@("dateFlagedInactivationFHIR")=$$FMTFHIR^SYNDHPUTL($G(HISTARR(FNBR1,IENS,.091,"I")))
"RTN","SYNDHP19",58,0)
 . S @AHIST@("availablePositionsC")=$G(HISTARR(FNBR1,IENS,.096,"E"))
"RTN","SYNDHP19",59,0)
 . S @AHIST@("max#PatientsC")=$G(HISTARR(FNBR1,IENS,.097,"E"))
"RTN","SYNDHP19",60,0)
 . S @AHIST@("currActivePatientsC")=$G(HISTARR(FNBR1,IENS,.098,"E"))
"RTN","SYNDHP19",61,0)
 . S @AHIST@("adjustedPanelSizeC")=$G(HISTARR(FNBR1,IENS,.099,"E"))
"RTN","SYNDHP19",62,0)
 . S @AHIST@("inactivatedAutomaticlyCd")=$G(HISTARR(FNBR1,IENS,.011,"I"))
"RTN","SYNDHP19",63,0)
 . S @AHIST@("inactivatedAutomaticly")=$G(HISTARR(FNBR1,IENS,.011,"E"))
"RTN","SYNDHP19",64,0)
 . S @AHIST@("teamletPositionCd")=$G(HISTARR(FNBR1,IENS,.012,"I"))
"RTN","SYNDHP19",65,0)
 . S @AHIST@("teamletPosition")=$G(HISTARR(FNBR1,IENS,.012,"E"))
"RTN","SYNDHP19",66,0)
 . N FTEE S FTEE=""
"RTN","SYNDHP19",67,0)
 . F  S FTEE=$O(HISTARR(FNBR2,FTEE)) QUIT:FTEE=""  D
"RTN","SYNDHP19",68,0)
 . . N FIEN S FIEN=+FTEE
"RTN","SYNDHP19",69,0)
 . . N FTEEHIST S FTEEHIST=$NA(ASGNHIST("posAssignHist",HISTIEN,"fteeHistory","fteeHist",FIEN))
"RTN","SYNDHP19",70,0)
 . . S @FTEEHIST@("fteeHistoryDate")=$G(HISTARR(FNBR2,FTEE,.01,"E"))
"RTN","SYNDHP19",71,0)
 . . S @FTEEHIST@("fteeHistoryDateFM")=$G(HISTARR(FNBR2,FTEE,.01,"I"))
"RTN","SYNDHP19",72,0)
 . . S @FTEEHIST@("fteeHistoryDateHL7")=$$FMTHL7^XLFDT($G(HISTARR(FNBR2,FTEE,.01,"I")))
"RTN","SYNDHP19",73,0)
 . . S @FTEEHIST@("fteeHistoryDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(HISTARR(FNBR2,FTEE,.01,"I")))
"RTN","SYNDHP19",74,0)
 . . S @FTEEHIST@("value")=$G(HISTARR(FNBR2,FTEE,.02,"I"))
"RTN","SYNDHP19",75,0)
 . . S @FTEEHIST@("userId")=$G(HISTARR(FNBR2,FTEE,.03,"I"))
"RTN","SYNDHP19",76,0)
 . . S @FTEEHIST@("user")=$G(HISTARR(FNBR2,FTEE,.03,"E"))
"RTN","SYNDHP19",77,0)
 . . S @FTEEHIST@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_HISTIEN_S_FNBR2_S_FTEE
"RTN","SYNDHP19",78,0)
 ;
"RTN","SYNDHP19",79,0)
 ;I $G(DEBUG) W ! ZWRITE ASGNHIST
"RTN","SYNDHP19",80,0)
 ;
"RTN","SYNDHP19",81,0)
 I $G(RETJSON)="J" D
"RTN","SYNDHP19",82,0)
 . N ASGNHISTS M ASGNHISTS("TeamPositionAssignmentHistory")=ASGNHIST
"RTN","SYNDHP19",83,0)
 . D TOJASON^SYNDHPUTL(.ASGNHISTS,.ASGNHISTJ)
"RTN","SYNDHP19",84,0)
 . ;I $G(DEBUG) W ! ZWRITE ASGNHISTSJ
"RTN","SYNDHP19",85,0)
 ;
"RTN","SYNDHP19",86,0)
 QUIT
"RTN","SYNDHP19",87,0)
 ;
"RTN","SYNDHP19",88,0)
PRECHIST(PRECHIST,POSIEN,RETJSON,PRECHISTJ) ;get preceptor assignment history
"RTN","SYNDHP19",89,0)
 ;inputs: POSIEN - team position IEN
"RTN","SYNDHP19",90,0)
 ;        RETJSON - J = Return JSON
"RTN","SYNDHP19",91,0)
 ;                  null or any other value = Return array (default)
"RTN","SYNDHP19",92,0)
 ;Output: PRECHIST - an array of preceptor history data, by reference
"RTN","SYNDHP19",93,0)
 ;        PRECHISTJ - JSON structure, by reference
"RTN","SYNDHP19",94,0)
 ;
"RTN","SYNDHP19",95,0)
 ;   >>>>>>>>>>>>>>>>>>>>>> UNTESTED, NO DATA IN OUR VISTA <<<<<<<<<<<<<<<<<<<<<<<<<<<<
"RTN","SYNDHP19",96,0)
 ;
"RTN","SYNDHP19",97,0)
 N FNBR1 S FNBR1=404.53 ;PRECEPTOR ASSIGNMENT HISTORY
"RTN","SYNDHP19",98,0)
 N S S S="_"
"RTN","SYNDHP19",99,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP19",100,0)
 N PRECIEN S PRECIEN=0
"RTN","SYNDHP19",101,0)
 F  S PRECIEN=$O(^SCTM(FNBR1,"B",POSIEN,PRECIEN)) QUIT:+PRECIEN=0  D
"RTN","SYNDHP19",102,0)
 . N IENS S IENS=PRECIEN_","
"RTN","SYNDHP19",103,0)
 . N HISTARR,HISTERR
"RTN","SYNDHP19",104,0)
 . D GETS^DIQ(FNBR1,IENS,"**","EI","HISTARR","HISTERR")
"RTN","SYNDHP19",105,0)
 . ;I $G(DEBUG) W ! ZWRITE HISTARR
"RTN","SYNDHP19",106,0)
 . ;I $G(DEBUG),$D(HISTERR) W !,">>ERROR<<" ZWRITE HISTERR
"RTN","SYNDHP19",107,0)
 . I $D(HISTERR) D  QUIT
"RTN","SYNDHP19",108,0)
 . . S PRECHIST("preceptorAssignHist",PRECIEN,"ERROR")=PRECIEN
"RTN","SYNDHP19",109,0)
 . . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.PRECHIST,.PRECHISTJ)
"RTN","SYNDHP19",110,0)
 . N PHIST S PHIST=$NA(PRECHIST("preceptorAssignHist",PRECIEN))
"RTN","SYNDHP19",111,0)
 . S @PHIST@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_PRECIEN
"RTN","SYNDHP19",112,0)
 . S @PHIST@("preceptorHistoryIen")=PRECIEN
"RTN","SYNDHP19",113,0)
 . S @PHIST@("teamPositionId")=$G(HISTARR(FNBR1,IENS,.01,"I"))
"RTN","SYNDHP19",114,0)
 . S @PHIST@("teamPositionName")=$G(HISTARR(FNBR1,IENS,.01,"E"))
"RTN","SYNDHP19",115,0)
 . S @PHIST@("effectiveDate")=$G(HISTARR(FNBR1,IENS,.02,"E"))
"RTN","SYNDHP19",116,0)
 . S @PHIST@("effectiveDateFM")=$G(HISTARR(FNBR1,IENS,.02,"I"))
"RTN","SYNDHP19",117,0)
 . S @PHIST@("effectiveDateHL7")=$$FMTHL7^XLFDT($G(HISTARR(FNBR1,IENS,.02,"I")))
"RTN","SYNDHP19",118,0)
 . S @PHIST@("effectiveDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(HISTARR(FNBR1,IENS,.02,"I")))
"RTN","SYNDHP19",119,0)
 . S @PHIST@("statusCd")=$G(HISTARR(FNBR1,IENS,.04,"I"))
"RTN","SYNDHP19",120,0)
 . S @PHIST@("statusReason")=$G(HISTARR(FNBR1,IENS,.05,"E"))
"RTN","SYNDHP19",121,0)
 . S @PHIST@("PreceptorTeamPositionId")=$G(HISTARR(FNBR1,IENS,.06,"I"))
"RTN","SYNDHP19",122,0)
 . S @PHIST@("PreceptorTeamPosition")=$G(HISTARR(FNBR1,IENS,.06,"E"))
"RTN","SYNDHP19",123,0)
 . S @PHIST@("userEnteringId")=$G(HISTARR(FNBR1,IENS,.07,"I"))
"RTN","SYNDHP19",124,0)
 . S @PHIST@("userEntering")=$G(HISTARR(FNBR1,IENS,.07,"E"))
"RTN","SYNDHP19",125,0)
 . S @PHIST@("dateTimeEntered")=$G(HISTARR(FNBR1,IENS,.08,"E"))
"RTN","SYNDHP19",126,0)
 . S @PHIST@("dateTimeEnteredFM")=$G(HISTARR(FNBR1,IENS,.08,"I"))
"RTN","SYNDHP19",127,0)
 . S @PHIST@("dateTimeEnteredHL7")=$$FMTHL7^XLFDT($G(HISTARR(FNBR1,IENS,.08,"I")))
"RTN","SYNDHP19",128,0)
 . S @PHIST@("dateTimeEnteredFHIR")=$$FMTFHIR^SYNDHPUTL($G(HISTARR(FNBR1,IENS,.08,"I")))
"RTN","SYNDHP19",129,0)
 . S @PHIST@("preceptorNameC")=$G(HISTARR(FNBR1,IENS,200,"E"))
"RTN","SYNDHP19",130,0)
 ;
"RTN","SYNDHP19",131,0)
 ;I $G(DEBUG) W ! ZWRITE PRECHIST
"RTN","SYNDHP19",132,0)
 ;
"RTN","SYNDHP19",133,0)
 I $G(RETJSON)="J" D
"RTN","SYNDHP19",134,0)
 . N PRECHISTS M PRECHISTS("TeamPreceptorHistory")=PRECHIST
"RTN","SYNDHP19",135,0)
 . D TOJASON^SYNDHPUTL(.PRECHISTS,.PRECHISTJ)
"RTN","SYNDHP19",136,0)
 . ;I $G(DEBUG) W ! ZWRITE PRECHISTSJ
"RTN","SYNDHP19",137,0)
 ;
"RTN","SYNDHP19",138,0)
 QUIT
"RTN","SYNDHP19",139,0)
 ;
"RTN","SYNDHP20")
0^95^B137306202
"RTN","SYNDHP20",1,0)
SYNDHP20 ; HC/art - HealthConcourse - get patient demographic data ;03/01/2019
"RTN","SYNDHP20",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP20",3,0)
 ;;
"RTN","SYNDHP20",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP20",5,0)
 ;
"RTN","SYNDHP20",6,0)
 QUIT
"RTN","SYNDHP20",7,0)
 ;
"RTN","SYNDHP20",8,0)
 ;-------------------------------------------------------------
"RTN","SYNDHP20",9,0)
 ;
"RTN","SYNDHP20",10,0)
GETPATIENT(PATIENT,PATIENTIEN,RETJSON,PATIENTJ) ;get one Patient record
"RTN","SYNDHP20",11,0)
 ; This API does not include all data in the Patient file. Only select patient demographic data are included.
"RTN","SYNDHP20",12,0)
 ;inputs: PATIENTIEN - Patient IEN
"RTN","SYNDHP20",13,0)
 ;        RETJSON - J = Return JSON
"RTN","SYNDHP20",14,0)
 ;output: PATIENT  - array of Patient Demographic data, by reference
"RTN","SYNDHP20",15,0)
 ;        PATIENTJ - JSON structure of Patient Demographic data, by reference
"RTN","SYNDHP20",16,0)
 ;
"RTN","SYNDHP20",17,0)
 I $G(DEBUG) W !,"--------------------------- Patient Demographic -----------------------------",!
"RTN","SYNDHP20",18,0)
 N S S S="_"
"RTN","SYNDHP20",19,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP20",20,0)
 N FNBR1 S FNBR1=2 ;PATIENT
"RTN","SYNDHP20",21,0)
 N FNBR2 S FNBR2=2.141 ;CONFIDENTIAL ADDRESS CATEGORY
"RTN","SYNDHP20",22,0)
 N FNBR3 S FNBR3=2.01 ;ALIAS
"RTN","SYNDHP20",23,0)
 N FNBR4 S FNBR4=2.02 ;RACE INFORMATION
"RTN","SYNDHP20",24,0)
 N FNBR5 S FNBR5=2.06 ;ETHNICITY INFORMATION
"RTN","SYNDHP20",25,0)
 N IENS1 S IENS1=PATIENTIEN_","
"RTN","SYNDHP20",26,0)
 ;
"RTN","SYNDHP20",27,0)
 N PATIENTARR,PATIENTERR
"RTN","SYNDHP20",28,0)
 D GETS^DIQ(FNBR1,IENS1,"**","EI","PATIENTARR","PATIENTERR")
"RTN","SYNDHP20",29,0)
 ;I $G(DEBUG) W ! ZWRITE PATIENTARR
"RTN","SYNDHP20",30,0)
 ;I $G(DEBUG),$D(PATIENTERR) W !,">>ERROR<<" ZWRITE PATIENTERR
"RTN","SYNDHP20",31,0)
 I $D(PATIENTERR) D  QUIT
"RTN","SYNDHP20",32,0)
 . S PATIENT("Patient","ERROR")=PATIENTIEN
"RTN","SYNDHP20",33,0)
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.PATIENT,.PATIENTJ)
"RTN","SYNDHP20",34,0)
 S PATIENT("Patient","patientIen")=PATIENTIEN
"RTN","SYNDHP20",35,0)
 S PATIENT("Patient","resourceType")="Patient"
"RTN","SYNDHP20",36,0)
 S PATIENT("Patient","resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_PATIENTIEN
"RTN","SYNDHP20",37,0)
 S PATIENT("Patient","name")=$G(PATIENTARR(FNBR1,IENS1,.01,"E"))
"RTN","SYNDHP20",38,0)
 S PATIENT("Patient","sex")=$G(PATIENTARR(FNBR1,IENS1,.02,"E"))
"RTN","SYNDHP20",39,0)
 S PATIENT("Patient","sexCd")=$G(PATIENTARR(FNBR1,IENS1,.02,"I"))
"RTN","SYNDHP20",40,0)
 S PATIENT("Patient","selfIdentifiedGender")=$G(PATIENTARR(FNBR1,IENS1,.024,"E"))
"RTN","SYNDHP20",41,0)
 S PATIENT("Patient","selfIdentifiedGenderCd")=$G(PATIENTARR(FNBR1,IENS1,.024,"I"))
"RTN","SYNDHP20",42,0)
 S PATIENT("Patient","dateOfBirth")=$G(PATIENTARR(FNBR1,IENS1,.03,"E"))
"RTN","SYNDHP20",43,0)
 S PATIENT("Patient","dateOfBirthFM")=$G(PATIENTARR(FNBR1,IENS1,.03,"I"))
"RTN","SYNDHP20",44,0)
 S PATIENT("Patient","dateOfBirthHL7")=$$FMTHL7^XLFDT($G(PATIENTARR(FNBR1,IENS1,.03,"I")))
"RTN","SYNDHP20",45,0)
 S PATIENT("Patient","dateOfBirthFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATIENTARR(FNBR1,IENS1,.03,"I")))
"RTN","SYNDHP20",46,0)
 S PATIENT("Patient","age")=$G(PATIENTARR(FNBR1,IENS1,.033,"E"))
"RTN","SYNDHP20",47,0)
 S PATIENT("Patient","maritalStatus")=$G(PATIENTARR(FNBR1,IENS1,.05,"E"))
"RTN","SYNDHP20",48,0)
 S PATIENT("Patient","maritalStatusId")=$G(PATIENTARR(FNBR1,IENS1,.05,"I"))
"RTN","SYNDHP20",49,0)
 S PATIENT("Patient","race")=$G(PATIENTARR(FNBR1,IENS1,.06,"E"))
"RTN","SYNDHP20",50,0)
 S PATIENT("Patient","raceId")=$G(PATIENTARR(FNBR1,IENS1,.06,"I"))
"RTN","SYNDHP20",51,0)
 S PATIENT("Patient","occupation")=$G(PATIENTARR(FNBR1,IENS1,.07,"E"))
"RTN","SYNDHP20",52,0)
 S PATIENT("Patient","religiousPreference")=$G(PATIENTARR(FNBR1,IENS1,.08,"E"))
"RTN","SYNDHP20",53,0)
 S PATIENT("Patient","socialSecurityNumber")=$G(PATIENTARR(FNBR1,IENS1,.09,"E"))
"RTN","SYNDHP20",54,0)
 S PATIENT("Patient","terminalDigitOfSsn")=$G(PATIENTARR(FNBR1,IENS1,.0901,"E"))
"RTN","SYNDHP20",55,0)
 S PATIENT("Patient","initlast4")=$G(PATIENTARR(FNBR1,IENS1,.0905,"E"))
"RTN","SYNDHP20",56,0)
 S PATIENT("Patient","remarks")=$G(PATIENTARR(FNBR1,IENS1,.091,"E"))
"RTN","SYNDHP20",57,0)
 S PATIENT("Patient","placeOfBirthCity")=$G(PATIENTARR(FNBR1,IENS1,.092,"E"))
"RTN","SYNDHP20",58,0)
 S PATIENT("Patient","placeOfBirthState")=$G(PATIENTARR(FNBR1,IENS1,.093,"E"))
"RTN","SYNDHP20",59,0)
 S PATIENT("Patient","placeOfBirthStateId")=$G(PATIENTARR(FNBR1,IENS1,.093,"I"))
"RTN","SYNDHP20",60,0)
 S PATIENT("Patient","streetAddressLine1")=$G(PATIENTARR(FNBR1,IENS1,.111,"E"))
"RTN","SYNDHP20",61,0)
 S PATIENT("Patient","streetAddressLine2")=$G(PATIENTARR(FNBR1,IENS1,.112,"E"))
"RTN","SYNDHP20",62,0)
 S PATIENT("Patient","streetAddressLine3")=$G(PATIENTARR(FNBR1,IENS1,.113,"E"))
"RTN","SYNDHP20",63,0)
 S PATIENT("Patient","city")=$G(PATIENTARR(FNBR1,IENS1,.114,"E"))
"RTN","SYNDHP20",64,0)
 S PATIENT("Patient","state")=$G(PATIENTARR(FNBR1,IENS1,.115,"E"))
"RTN","SYNDHP20",65,0)
 S PATIENT("Patient","stateId")=$G(PATIENTARR(FNBR1,IENS1,.115,"I"))
"RTN","SYNDHP20",66,0)
 S PATIENT("Patient","zipCode")=$G(PATIENTARR(FNBR1,IENS1,.116,"E"))
"RTN","SYNDHP20",67,0)
 S PATIENT("Patient","zip4")=$G(PATIENTARR(FNBR1,IENS1,.1112,"E"))
"RTN","SYNDHP20",68,0)
 S PATIENT("Patient","county")=$G(PATIENTARR(FNBR1,IENS1,.117,"E"))
"RTN","SYNDHP20",69,0)
 S PATIENT("Patient","province")=$G(PATIENTARR(FNBR1,IENS1,.1171,"E"))
"RTN","SYNDHP20",70,0)
 S PATIENT("Patient","postalCode")=$G(PATIENTARR(FNBR1,IENS1,.1172,"E"))
"RTN","SYNDHP20",71,0)
 S PATIENT("Patient","country")=$G(PATIENTARR(FNBR1,IENS1,.1173,"E"))
"RTN","SYNDHP20",72,0)
 S PATIENT("Patient","countryId")=$G(PATIENTARR(FNBR1,IENS1,.1173,"I"))
"RTN","SYNDHP20",73,0)
 S PATIENT("Patient","phoneNumberResidence")=$G(PATIENTARR(FNBR1,IENS1,.131,"E"))
"RTN","SYNDHP20",74,0)
 S PATIENT("Patient","phoneNumberWork")=$G(PATIENTARR(FNBR1,IENS1,.132,"E"))
"RTN","SYNDHP20",75,0)
 S PATIENT("Patient","emailAddress")=$G(PATIENTARR(FNBR1,IENS1,.133,"E"))
"RTN","SYNDHP20",76,0)
 S PATIENT("Patient","phoneNumberCellular")=$G(PATIENTARR(FNBR1,IENS1,.134,"E"))
"RTN","SYNDHP20",77,0)
 S PATIENT("Patient","pagerNumber")=$G(PATIENTARR(FNBR1,IENS1,.135,"E"))
"RTN","SYNDHP20",78,0)
 S PATIENT("Patient","tempAddressActive")=$G(PATIENTARR(FNBR1,IENS1,.12105,"E"))
"RTN","SYNDHP20",79,0)
 S PATIENT("Patient","tempAddressActiveCd")=$G(PATIENTARR(FNBR1,IENS1,.12105,"I"))
"RTN","SYNDHP20",80,0)
 S PATIENT("Patient","tempStreetLine1")=$G(PATIENTARR(FNBR1,IENS1,.1211,"E"))
"RTN","SYNDHP20",81,0)
 S PATIENT("Patient","tempStreetLine2")=$G(PATIENTARR(FNBR1,IENS1,.1212,"E"))
"RTN","SYNDHP20",82,0)
 S PATIENT("Patient","tempStreetLine3")=$G(PATIENTARR(FNBR1,IENS1,.1213,"E"))
"RTN","SYNDHP20",83,0)
 S PATIENT("Patient","tempCity")=$G(PATIENTARR(FNBR1,IENS1,.1214,"E"))
"RTN","SYNDHP20",84,0)
 S PATIENT("Patient","tempState")=$G(PATIENTARR(FNBR1,IENS1,.1215,"E"))
"RTN","SYNDHP20",85,0)
 S PATIENT("Patient","tempStateId")=$G(PATIENTARR(FNBR1,IENS1,.1215,"I"))
"RTN","SYNDHP20",86,0)
 S PATIENT("Patient","tempZipCode")=$G(PATIENTARR(FNBR1,IENS1,.1216,"E"))
"RTN","SYNDHP20",87,0)
 S PATIENT("Patient","tempZip4")=$G(PATIENTARR(FNBR1,IENS1,.12112,"E"))
"RTN","SYNDHP20",88,0)
 S PATIENT("Patient","tempAddressCounty")=$G(PATIENTARR(FNBR1,IENS1,.12111,"E"))
"RTN","SYNDHP20",89,0)
 S PATIENT("Patient","tempAddressProvince")=$G(PATIENTARR(FNBR1,IENS1,.1221,"E"))
"RTN","SYNDHP20",90,0)
 S PATIENT("Patient","tempAddressPostalCode")=$G(PATIENTARR(FNBR1,IENS1,.1222,"E"))
"RTN","SYNDHP20",91,0)
 S PATIENT("Patient","tempAddressCountry")=$G(PATIENTARR(FNBR1,IENS1,.1223,"E"))
"RTN","SYNDHP20",92,0)
 S PATIENT("Patient","tempAddressCountryId")=$G(PATIENTARR(FNBR1,IENS1,.1223,"I"))
"RTN","SYNDHP20",93,0)
 S PATIENT("Patient","tempPhoneNumber")=$G(PATIENTARR(FNBR1,IENS1,.1219,"E"))
"RTN","SYNDHP20",94,0)
 S PATIENT("Patient","tempAddressStartDate")=$G(PATIENTARR(FNBR1,IENS1,.1217,"E"))
"RTN","SYNDHP20",95,0)
 S PATIENT("Patient","tempAddressStartDateFM")=$G(PATIENTARR(FNBR1,IENS1,.1217,"I"))
"RTN","SYNDHP20",96,0)
 S PATIENT("Patient","tempAddressStartDateHL7")=$$FMTHL7^XLFDT($G(PATIENTARR(FNBR1,IENS1,.1217,"I")))
"RTN","SYNDHP20",97,0)
 S PATIENT("Patient","tempAddressStartDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATIENTARR(FNBR1,IENS1,.1217,"I")))
"RTN","SYNDHP20",98,0)
 S PATIENT("Patient","tempAddressEndDate")=$G(PATIENTARR(FNBR1,IENS1,.1218,"E"))
"RTN","SYNDHP20",99,0)
 S PATIENT("Patient","tempAddressEndDateFM")=$G(PATIENTARR(FNBR1,IENS1,.1218,"I"))
"RTN","SYNDHP20",100,0)
 S PATIENT("Patient","tempAddressEndDateHL7")=$$FMTHL7^XLFDT($G(PATIENTARR(FNBR1,IENS1,.1218,"I")))
"RTN","SYNDHP20",101,0)
 S PATIENT("Patient","tempAddressEndDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATIENTARR(FNBR1,IENS1,.1218,"I")))
"RTN","SYNDHP20",102,0)
 S PATIENT("Patient","emergencyResponseIndicator")=$G(PATIENTARR(FNBR1,IENS1,.181,"E"))
"RTN","SYNDHP20",103,0)
 S PATIENT("Patient","emergencyResponseIndicatorCd")=$G(PATIENTARR(FNBR1,IENS1,.181,"I"))
"RTN","SYNDHP20",104,0)
 S PATIENT("Patient","kNameOfPrimaryNok")=$G(PATIENTARR(FNBR1,IENS1,.211,"E"))
"RTN","SYNDHP20",105,0)
 S PATIENT("Patient","kRelationshipToPatient")=$G(PATIENTARR(FNBR1,IENS1,.212,"E"))
"RTN","SYNDHP20",106,0)
 S PATIENT("Patient","kAddressSameAsPatientS")=$G(PATIENTARR(FNBR1,IENS1,.2125,"E"))
"RTN","SYNDHP20",107,0)
 S PATIENT("Patient","kAddressSameAsPatientSCd")=$G(PATIENTARR(FNBR1,IENS1,.2125,"I"))
"RTN","SYNDHP20",108,0)
 S PATIENT("Patient","kStreetAddressLine1")=$G(PATIENTARR(FNBR1,IENS1,.213,"E"))
"RTN","SYNDHP20",109,0)
 S PATIENT("Patient","kStreetAddressLine2")=$G(PATIENTARR(FNBR1,IENS1,.214,"E"))
"RTN","SYNDHP20",110,0)
 S PATIENT("Patient","kStreetAddressLine3")=$G(PATIENTARR(FNBR1,IENS1,.215,"E"))
"RTN","SYNDHP20",111,0)
 S PATIENT("Patient","kCity")=$G(PATIENTARR(FNBR1,IENS1,.216,"E"))
"RTN","SYNDHP20",112,0)
 S PATIENT("Patient","kState")=$G(PATIENTARR(FNBR1,IENS1,.217,"E"))
"RTN","SYNDHP20",113,0)
 S PATIENT("Patient","kStateId")=$G(PATIENTARR(FNBR1,IENS1,.217,"I"))
"RTN","SYNDHP20",114,0)
 S PATIENT("Patient","kZipCode")=$G(PATIENTARR(FNBR1,IENS1,.218,"E"))
"RTN","SYNDHP20",115,0)
 S PATIENT("Patient","kZip4")=$G(PATIENTARR(FNBR1,IENS1,.2207,"E"))
"RTN","SYNDHP20",116,0)
 S PATIENT("Patient","kPhoneNumber")=$G(PATIENTARR(FNBR1,IENS1,.219,"E"))
"RTN","SYNDHP20",117,0)
 S PATIENT("Patient","kWorkPhoneNumber")=$G(PATIENTARR(FNBR1,IENS1,.21011,"E"))
"RTN","SYNDHP20",118,0)
 S PATIENT("Patient","fatherSName")=$G(PATIENTARR(FNBR1,IENS1,.2401,"E"))
"RTN","SYNDHP20",119,0)
 S PATIENT("Patient","motherSName")=$G(PATIENTARR(FNBR1,IENS1,.2402,"E"))
"RTN","SYNDHP20",120,0)
 S PATIENT("Patient","motherSMaidenName")=$G(PATIENTARR(FNBR1,IENS1,.2403,"E"))
"RTN","SYNDHP20",121,0)
 S PATIENT("Patient","employerName")=$G(PATIENTARR(FNBR1,IENS1,.3111,"E"))
"RTN","SYNDHP20",122,0)
 S PATIENT("Patient","employmentStatus")=$G(PATIENTARR(FNBR1,IENS1,.31115,"E"))
"RTN","SYNDHP20",123,0)
 S PATIENT("Patient","employmentStatusCd")=$G(PATIENTARR(FNBR1,IENS1,.31115,"I"))
"RTN","SYNDHP20",124,0)
 S PATIENT("Patient","governmentAgency")=$G(PATIENTARR(FNBR1,IENS1,.3112,"E"))
"RTN","SYNDHP20",125,0)
 S PATIENT("Patient","governmentAgencyCd")=$G(PATIENTARR(FNBR1,IENS1,.3112,"I"))
"RTN","SYNDHP20",126,0)
 S PATIENT("Patient","employerStreetLine1")=$G(PATIENTARR(FNBR1,IENS1,.3113,"E"))
"RTN","SYNDHP20",127,0)
 S PATIENT("Patient","employerStreetLine2")=$G(PATIENTARR(FNBR1,IENS1,.3114,"E"))
"RTN","SYNDHP20",128,0)
 S PATIENT("Patient","employerStreetLine3")=$G(PATIENTARR(FNBR1,IENS1,.3115,"E"))
"RTN","SYNDHP20",129,0)
 S PATIENT("Patient","employerCity")=$G(PATIENTARR(FNBR1,IENS1,.3116,"E"))
"RTN","SYNDHP20",130,0)
 S PATIENT("Patient","employerState")=$G(PATIENTARR(FNBR1,IENS1,.3117,"E"))
"RTN","SYNDHP20",131,0)
 S PATIENT("Patient","employerStateId")=$G(PATIENTARR(FNBR1,IENS1,.3117,"I"))
"RTN","SYNDHP20",132,0)
 S PATIENT("Patient","employerZipCode")=$G(PATIENTARR(FNBR1,IENS1,.3118,"E"))
"RTN","SYNDHP20",133,0)
 S PATIENT("Patient","employerZip4")=$G(PATIENTARR(FNBR1,IENS1,.2205,"E"))
"RTN","SYNDHP20",134,0)
 S PATIENT("Patient","employerPhoneNumber")=$G(PATIENTARR(FNBR1,IENS1,.3119,"E"))
"RTN","SYNDHP20",135,0)
 S PATIENT("Patient","emrContactSameAsNok")=$G(PATIENTARR(FNBR1,IENS1,.3305,"E"))
"RTN","SYNDHP20",136,0)
 S PATIENT("Patient","emrContactSameAsNokCd")=$G(PATIENTARR(FNBR1,IENS1,.3305,"I"))
"RTN","SYNDHP20",137,0)
 S PATIENT("Patient","emrName")=$G(PATIENTARR(FNBR1,IENS1,.331,"E"))
"RTN","SYNDHP20",138,0)
 S PATIENT("Patient","emrRelationshipToPatient")=$G(PATIENTARR(FNBR1,IENS1,.332,"E"))
"RTN","SYNDHP20",139,0)
 S PATIENT("Patient","emrStreetAddressLine1")=$G(PATIENTARR(FNBR1,IENS1,.333,"E"))
"RTN","SYNDHP20",140,0)
 S PATIENT("Patient","emrStreetAddressLine2")=$G(PATIENTARR(FNBR1,IENS1,.334,"E"))
"RTN","SYNDHP20",141,0)
 S PATIENT("Patient","emrStreetAddressLine3")=$G(PATIENTARR(FNBR1,IENS1,.335,"E"))
"RTN","SYNDHP20",142,0)
 S PATIENT("Patient","emrCity")=$G(PATIENTARR(FNBR1,IENS1,.336,"E"))
"RTN","SYNDHP20",143,0)
 S PATIENT("Patient","emrState")=$G(PATIENTARR(FNBR1,IENS1,.337,"E"))
"RTN","SYNDHP20",144,0)
 S PATIENT("Patient","emrStateId")=$G(PATIENTARR(FNBR1,IENS1,.337,"I"))
"RTN","SYNDHP20",145,0)
 S PATIENT("Patient","emrZipCode")=$G(PATIENTARR(FNBR1,IENS1,.338,"E"))
"RTN","SYNDHP20",146,0)
 S PATIENT("Patient","emrZip4")=$G(PATIENTARR(FNBR1,IENS1,.2201,"E"))
"RTN","SYNDHP20",147,0)
 S PATIENT("Patient","emrPhoneNumber")=$G(PATIENTARR(FNBR1,IENS1,.339,"E"))
"RTN","SYNDHP20",148,0)
 S PATIENT("Patient","emrWorkPhoneNumber")=$G(PATIENTARR(FNBR1,IENS1,.33011,"E"))
"RTN","SYNDHP20",149,0)
 S PATIENT("Patient","dateOfDeath")=$G(PATIENTARR(FNBR1,IENS1,.351,"E"))
"RTN","SYNDHP20",150,0)
 S PATIENT("Patient","dateOfDeathFM")=$G(PATIENTARR(FNBR1,IENS1,.351,"I"))
"RTN","SYNDHP20",151,0)
 S PATIENT("Patient","dateOfDeathHL7")=$$FMTHL7^XLFDT($G(PATIENTARR(FNBR1,IENS1,.351,"I")))
"RTN","SYNDHP20",152,0)
 S PATIENT("Patient","dateOfDeathFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATIENTARR(FNBR1,IENS1,.351,"I")))
"RTN","SYNDHP20",153,0)
 S PATIENT("Patient","deathEnteredBy")=$G(PATIENTARR(FNBR1,IENS1,.352,"E"))
"RTN","SYNDHP20",154,0)
 S PATIENT("Patient","deathEnteredById")=$G(PATIENTARR(FNBR1,IENS1,.352,"I"))
"RTN","SYNDHP20",155,0)
 S PATIENT("Patient","testPatientIndicator")=$G(PATIENTARR(FNBR1,IENS1,.6,"E"))
"RTN","SYNDHP20",156,0)
 S PATIENT("Patient","testPatientIndicatorCd")=$G(PATIENTARR(FNBR1,IENS1,.6,"I"))
"RTN","SYNDHP20",157,0)
 S PATIENT("Patient","preferredFacility")=$G(PATIENTARR(FNBR1,IENS1,27.02,"E"))
"RTN","SYNDHP20",158,0)
 S PATIENT("Patient","preferredFacilityId")=$G(PATIENTARR(FNBR1,IENS1,27.02,"I"))
"RTN","SYNDHP20",159,0)
 S PATIENT("Patient","integrationControlNumber")=$G(PATIENTARR(FNBR1,IENS1,991.01,"E"))
"RTN","SYNDHP20",160,0)
 S PATIENT("Patient","icnChecksum")=$G(PATIENTARR(FNBR1,IENS1,991.02,"E"))
"RTN","SYNDHP20",161,0)
 S PATIENT("Patient","fullICN")=$G(PATIENTARR(FNBR1,IENS1,991.1,"E"))
"RTN","SYNDHP20",162,0)
 S PATIENT("Patient","multipleBirthIndicator")=$G(PATIENTARR(FNBR1,IENS1,994,"E"))
"RTN","SYNDHP20",163,0)
 S PATIENT("Patient","multipleBirthIndicatorCd")=$G(PATIENTARR(FNBR1,IENS1,994,"I"))
"RTN","SYNDHP20",164,0)
 S PATIENT("Patient","veteranYN")=$G(PATIENTARR(FNBR1,IENS1,1901,"E"))
"RTN","SYNDHP20",165,0)
 S PATIENT("Patient","veteranYNCd")=$G(PATIENTARR(FNBR1,IENS1,1901,"I"))
"RTN","SYNDHP20",166,0)
 N IENS2 S IENS2=""
"RTN","SYNDHP20",167,0)
 F  S IENS2=$O(PATIENTARR(FNBR2,IENS2)) QUIT:IENS2=""  D
"RTN","SYNDHP20",168,0)
 . N CONFADRS S CONFADRS=$NA(PATIENT("Patient","confidentialAddressCategorys","confidentialAddressCategory",+IENS2))
"RTN","SYNDHP20",169,0)
 . S @CONFADRS@("confidentialAddressCategory")=$G(PATIENTARR(FNBR2,IENS2,.01,"E"))
"RTN","SYNDHP20",170,0)
 . S @CONFADRS@("confidentialAddressCategoryCd")=$G(PATIENTARR(FNBR2,IENS2,.01,"I"))
"RTN","SYNDHP20",171,0)
 . S @CONFADRS@("confidentialCategoryActive")=$G(PATIENTARR(FNBR2,IENS2,1,"E"))
"RTN","SYNDHP20",172,0)
 . S @CONFADRS@("confidentialCategoryActiveCd")=$G(PATIENTARR(FNBR2,IENS2,1,"I"))
"RTN","SYNDHP20",173,0)
 . S @CONFADRS@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_PATIENTIEN_S_FNBR2_S_+IENS2
"RTN","SYNDHP20",174,0)
 N IENS3 S IENS3=""
"RTN","SYNDHP20",175,0)
 F  S IENS3=$O(PATIENTARR(FNBR3,IENS3)) QUIT:IENS3=""  D
"RTN","SYNDHP20",176,0)
 . N ALIAS S ALIAS=$NA(PATIENT("Patient","aliass","alias",+IENS3))
"RTN","SYNDHP20",177,0)
 . S @ALIAS@("alias")=$G(PATIENTARR(FNBR3,IENS3,.01,"E"))
"RTN","SYNDHP20",178,0)
 . S @ALIAS@("aliasSsn")=$G(PATIENTARR(FNBR3,IENS3,1,"E"))
"RTN","SYNDHP20",179,0)
 . S @ALIAS@("aliasComponents")=$G(PATIENTARR(FNBR3,IENS3,100.03,"E"))
"RTN","SYNDHP20",180,0)
 . S @ALIAS@("aliasComponentsId")=$G(PATIENTARR(FNBR3,IENS3,100.03,"I"))
"RTN","SYNDHP20",181,0)
 . S @ALIAS@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_PATIENTIEN_S_FNBR3_S_+IENS3
"RTN","SYNDHP20",182,0)
 N IENS4 S IENS4=""
"RTN","SYNDHP20",183,0)
 F  S IENS4=$O(PATIENTARR(FNBR4,IENS4)) QUIT:IENS4=""  D
"RTN","SYNDHP20",184,0)
 . N RACE S RACE=$NA(PATIENT("Patient","raceInformations","raceInformation",+IENS4))
"RTN","SYNDHP20",185,0)
 . S @RACE@("raceInformation")=$G(PATIENTARR(FNBR4,IENS4,.01,"E"))
"RTN","SYNDHP20",186,0)
 . S @RACE@("raceInformationId")=$G(PATIENTARR(FNBR4,IENS4,.01,"I"))
"RTN","SYNDHP20",187,0)
 . S @RACE@("methodOfCollection")=$G(PATIENTARR(FNBR4,IENS4,.02,"E"))
"RTN","SYNDHP20",188,0)
 . S @RACE@("methodOfCollectionId")=$G(PATIENTARR(FNBR4,IENS4,.02,"I"))
"RTN","SYNDHP20",189,0)
 . S @RACE@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_PATIENTIEN_S_FNBR4_S_+IENS4
"RTN","SYNDHP20",190,0)
 N IENS5 S IENS5=""
"RTN","SYNDHP20",191,0)
 F  S IENS5=$O(PATIENTARR(FNBR5,IENS5)) QUIT:IENS5=""  D
"RTN","SYNDHP20",192,0)
 . N ETHNIC S ETHNIC=$NA(PATIENT("Patient","ethnicityInformations","ethnicityInformation",+IENS5))
"RTN","SYNDHP20",193,0)
 . S @ETHNIC@("ethnicityInformation")=$G(PATIENTARR(FNBR5,IENS5,.01,"E"))
"RTN","SYNDHP20",194,0)
 . S @ETHNIC@("ethnicityInformationId")=$G(PATIENTARR(FNBR5,IENS5,.01,"I"))
"RTN","SYNDHP20",195,0)
 . S @ETHNIC@("methodOfCollection")=$G(PATIENTARR(FNBR5,IENS5,.02,"E"))
"RTN","SYNDHP20",196,0)
 . S @ETHNIC@("methodOfCollectionId")=$G(PATIENTARR(FNBR5,IENS5,.02,"I"))
"RTN","SYNDHP20",197,0)
 . S @ETHNIC@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_PATIENTIEN_S_FNBR5_S_+IENS5
"RTN","SYNDHP20",198,0)
 ;
"RTN","SYNDHP20",199,0)
 ;I $G(DEBUG) W ! ZWRITE PATIENT
"RTN","SYNDHP20",200,0)
 ;
"RTN","SYNDHP20",201,0)
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.PATIENT,.PATIENTJ)
"RTN","SYNDHP20",202,0)
 ;
"RTN","SYNDHP20",203,0)
 QUIT
"RTN","SYNDHP20",204,0)
 ;
"RTN","SYNDHP21")
0^105^B55720482
"RTN","SYNDHP21",1,0)
SYNDHP21 ; HC/art - HealthConcourse - get patient lab data ;03/28/2019
"RTN","SYNDHP21",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP21",3,0)
 ;;
"RTN","SYNDHP21",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP21",5,0)
 ;
"RTN","SYNDHP21",6,0)
 QUIT
"RTN","SYNDHP21",7,0)
 ;
"RTN","SYNDHP21",8,0)
 ;-------------------------------------------------------------
"RTN","SYNDHP21",9,0)
 ;
"RTN","SYNDHP21",10,0)
GETLABS(LABS,LABREF,RETJSON,LABSJ) ;get Patient Labs records
"RTN","SYNDHP21",11,0)
 ;inputs: LABREF - Labs IEN (patient LRDFN)
"RTN","SYNDHP21",12,0)
 ;        RETJSON - J = Return JSON
"RTN","SYNDHP21",13,0)
 ;output: LABS  - array of Labs data, by reference
"RTN","SYNDHP21",14,0)
 ;        LABSJ - JSON structure of Labs data, by reference
"RTN","SYNDHP21",15,0)
 ;
"RTN","SYNDHP21",16,0)
 I $G(DEBUG) W !,"--------------------------- Labs -----------------------------",!
"RTN","SYNDHP21",17,0)
 N S S S="_"
"RTN","SYNDHP21",18,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP21",19,0)
 N FNBR1 S FNBR1=63 ;LAB DATA
"RTN","SYNDHP21",20,0)
 N FNBR2 S FNBR2=63.04 ;CHEM, HEM, TOX, RIA, SER, etc.
"RTN","SYNDHP21",21,0)
 N FNBR3 S FNBR3=63.07 ;ORDERED TEST
"RTN","SYNDHP21",22,0)
 N IENS1 S IENS1=LABREF_","
"RTN","SYNDHP21",23,0)
 ;
"RTN","SYNDHP21",24,0)
 N LABSARR,LABSERR,INVDT,RESULT,LOINC
"RTN","SYNDHP21",25,0)
 D GETS^DIQ(FNBR1,IENS1,"**","EI","LABSARR","LABSERR")
"RTN","SYNDHP21",26,0)
 ;I $G(DEBUG) W ! ZWRITE LABSARR
"RTN","SYNDHP21",27,0)
 ;I $G(DEBUG),$D(LABSERR) W !,">>ERROR<<" ZWRITE LABSERR
"RTN","SYNDHP21",28,0)
 I $D(LABSERR) D  QUIT
"RTN","SYNDHP21",29,0)
 . S LABS("Lab","ERROR")=LABREF
"RTN","SYNDHP21",30,0)
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.LABS,.LABSJ)
"RTN","SYNDHP21",31,0)
 S LABS("Lab","labsIen")=LABREF
"RTN","SYNDHP21",32,0)
 S LABS("Lab","resourceType")="Laboratory"
"RTN","SYNDHP21",33,0)
 S LABS("Lab","resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_LABREF
"RTN","SYNDHP21",34,0)
 S LABS("Lab","lrDfn")=$G(LABSARR(FNBR1,IENS1,.01,"E"))
"RTN","SYNDHP21",35,0)
 S LABS("Lab","patientName")=$G(LABSARR(FNBR1,IENS1,.03,"E"))
"RTN","SYNDHP21",36,0)
 S LABS("Lab","patientNameId")=$G(LABSARR(FNBR1,IENS1,.03,"I"))
"RTN","SYNDHP21",37,0)
 S LABS("Lab","patientIcn")=$$ICN^SYNDHPUTL(LABS("Lab","patientNameId"))
"RTN","SYNDHP21",38,0)
 S LABS("Lab","doNotTransfuse")=$G(LABSARR(FNBR1,IENS1,.04,"E"))
"RTN","SYNDHP21",39,0)
 S LABS("Lab","doNotTransfuseCd")=$G(LABSARR(FNBR1,IENS1,.04,"I"))
"RTN","SYNDHP21",40,0)
 S LABS("Lab","aboGroup")=$G(LABSARR(FNBR1,IENS1,.05,"E"))
"RTN","SYNDHP21",41,0)
 S LABS("Lab","aboGroupCd")=$G(LABSARR(FNBR1,IENS1,.05,"I"))
"RTN","SYNDHP21",42,0)
 S LABS("Lab","rhType")=$G(LABSARR(FNBR1,IENS1,.06,"E"))
"RTN","SYNDHP21",43,0)
 S LABS("Lab","rhTypeCd")=$G(LABSARR(FNBR1,IENS1,.06,"I"))
"RTN","SYNDHP21",44,0)
 S LABS("Lab","hospitalId")=$G(LABSARR(FNBR1,IENS1,.09,"E"))
"RTN","SYNDHP21",45,0)
 N IENS2 S IENS2=""
"RTN","SYNDHP21",46,0)
 F  S IENS2=$O(LABSARR(FNBR2,IENS2)) QUIT:IENS2=""  D
"RTN","SYNDHP21",47,0)
 . N CHEMLABS S CHEMLABS=$NA(LABS("Lab","chemHemToxRiaSerEtcs","chemHemToxRiaSerEtc",+IENS2))
"RTN","SYNDHP21",48,0)
 . S @CHEMLABS@("dateTimeSpecimenTaken")=$G(LABSARR(FNBR2,IENS2,.01,"E"))
"RTN","SYNDHP21",49,0)
 . S @CHEMLABS@("dateTimeSpecimenTakenFM")=$G(LABSARR(FNBR2,IENS2,.01,"I"))
"RTN","SYNDHP21",50,0)
 . S @CHEMLABS@("dateTimeSpecimenTakenHL7")=$$FMTHL7^XLFDT($G(LABSARR(FNBR2,IENS2,.01,"I")))
"RTN","SYNDHP21",51,0)
 . S @CHEMLABS@("dateTimeSpecimenTakenFHIR")=$$FMTFHIR^SYNDHPUTL($G(LABSARR(FNBR2,IENS2,.01,"I")))
"RTN","SYNDHP21",52,0)
 . S @CHEMLABS@("dateTimeObtainedInexact")=$G(LABSARR(FNBR2,IENS2,.02,"E"))
"RTN","SYNDHP21",53,0)
 . S @CHEMLABS@("dateTimeObtainedInexactCd")=$G(LABSARR(FNBR2,IENS2,.02,"I"))
"RTN","SYNDHP21",54,0)
 . S @CHEMLABS@("dateReportCompleted")=$G(LABSARR(FNBR2,IENS2,.03,"E"))
"RTN","SYNDHP21",55,0)
 . S @CHEMLABS@("dateReportCompletedFM")=$G(LABSARR(FNBR2,IENS2,.03,"I"))
"RTN","SYNDHP21",56,0)
 . S @CHEMLABS@("dateReportCompletedHL7")=$$FMTHL7^XLFDT($G(LABSARR(FNBR2,IENS2,.03,"I")))
"RTN","SYNDHP21",57,0)
 . S @CHEMLABS@("dateReportCompletedFHIR")=$$FMTFHIR^SYNDHPUTL($G(LABSARR(FNBR2,IENS2,.03,"I")))
"RTN","SYNDHP21",58,0)
 . S @CHEMLABS@("verifyPerson")=$G(LABSARR(FNBR2,IENS2,.04,"E"))
"RTN","SYNDHP21",59,0)
 . S @CHEMLABS@("verifyPersonId")=$G(LABSARR(FNBR2,IENS2,.04,"I"))
"RTN","SYNDHP21",60,0)
 . S @CHEMLABS@("specimenType")=$G(LABSARR(FNBR2,IENS2,.05,"E"))
"RTN","SYNDHP21",61,0)
 . S @CHEMLABS@("specimenTypeId")=$G(LABSARR(FNBR2,IENS2,.05,"I"))
"RTN","SYNDHP21",62,0)
 . S @CHEMLABS@("accession")=$G(LABSARR(FNBR2,IENS2,.06,"E"))
"RTN","SYNDHP21",63,0)
 . S @CHEMLABS@("volume")=$G(LABSARR(FNBR2,IENS2,.07,"E"))
"RTN","SYNDHP21",64,0)
 . S @CHEMLABS@("methodOrSite")=$G(LABSARR(FNBR2,IENS2,.08,"E"))
"RTN","SYNDHP21",65,0)
 . S @CHEMLABS@("sumReportNum")=$G(LABSARR(FNBR2,IENS2,.09,"E"))
"RTN","SYNDHP21",66,0)
 . S @CHEMLABS@("requestingPerson")=$G(LABSARR(FNBR2,IENS2,.1,"E"))
"RTN","SYNDHP21",67,0)
 . S @CHEMLABS@("requestingPersonId")=$G(LABSARR(FNBR2,IENS2,.1,"I"))
"RTN","SYNDHP21",68,0)
 . S @CHEMLABS@("requestingLocation")=$G(LABSARR(FNBR2,IENS2,.11,"E"))
"RTN","SYNDHP21",69,0)
 . S @CHEMLABS@("requestingLocDiv")=$G(LABSARR(FNBR2,IENS2,.111,"E"))
"RTN","SYNDHP21",70,0)
 . S @CHEMLABS@("requestingLocDivId")=$G(LABSARR(FNBR2,IENS2,.111,"I"))
"RTN","SYNDHP21",71,0)
 . S @CHEMLABS@("accessioningInstitution")=$G(LABSARR(FNBR2,IENS2,.112,"E"))
"RTN","SYNDHP21",72,0)
 . S @CHEMLABS@("accessioningInstitutionId")=$G(LABSARR(FNBR2,IENS2,.112,"I"))
"RTN","SYNDHP21",73,0)
 . S @CHEMLABS@("uid")=$G(LABSARR(FNBR2,IENS2,.31,"E"))
"RTN","SYNDHP21",74,0)
 . S @CHEMLABS@("orderingSite")=$G(LABSARR(FNBR2,IENS2,.32,"E"))
"RTN","SYNDHP21",75,0)
 . S @CHEMLABS@("orderingSiteId")=$G(LABSARR(FNBR2,IENS2,.32,"I"))
"RTN","SYNDHP21",76,0)
 . S @CHEMLABS@("collectingSite")=$G(LABSARR(FNBR2,IENS2,.33,"E"))
"RTN","SYNDHP21",77,0)
 . S @CHEMLABS@("collectingSiteId")=$G(LABSARR(FNBR2,IENS2,.33,"I"))
"RTN","SYNDHP21",78,0)
 . S @CHEMLABS@("hostUid")=$G(LABSARR(FNBR2,IENS2,.34,"E"))
"RTN","SYNDHP21",79,0)
 . S @CHEMLABS@("orderingSiteUid")=$G(LABSARR(FNBR2,IENS2,.342,"E"))
"RTN","SYNDHP21",80,0)
 . S @CHEMLABS@("releasingSite")=$G(LABSARR(FNBR2,IENS2,.345,"E"))
"RTN","SYNDHP21",81,0)
 . S @CHEMLABS@("releasingSiteId")=$G(LABSARR(FNBR2,IENS2,.345,"I"))
"RTN","SYNDHP21",82,0)
 . S @CHEMLABS@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_LABREF_S_FNBR2_S_+IENS2
"RTN","SYNDHP21",83,0)
 . ;"secret" data in the results field
"RTN","SYNDHP21",84,0)
 . S INVDT=9999999-@CHEMLABS@("dateTimeSpecimenTakenFM")
"RTN","SYNDHP21",85,0)
 . N RESULT
"RTN","SYNDHP21",86,0)
 . D GETRESLT(LABREF,INVDT,.RESULT)
"RTN","SYNDHP21",87,0)
 . S @CHEMLABS@("labTestId")=$G(RESULT("labTestId"))
"RTN","SYNDHP21",88,0)
 . S @CHEMLABS@("labTestName")=$G(RESULT("labTestName"))
"RTN","SYNDHP21",89,0)
 . S @CHEMLABS@("result")=$G(RESULT("result"))
"RTN","SYNDHP21",90,0)
 . S @CHEMLABS@("flag")=$G(RESULT("flag"))
"RTN","SYNDHP21",91,0)
 . S @CHEMLABS@("referenceHigh")=$G(RESULT("referenceHigh"))
"RTN","SYNDHP21",92,0)
 . S @CHEMLABS@("referenceLow")=$G(RESULT("referenceLow"))
"RTN","SYNDHP21",93,0)
 . S @CHEMLABS@("criticalHigh")=$G(RESULT("criticalHigh"))
"RTN","SYNDHP21",94,0)
 . S @CHEMLABS@("criticalLow")=$G(RESULT("criticalLow"))
"RTN","SYNDHP21",95,0)
 . S @CHEMLABS@("units")=$G(RESULT("units"))
"RTN","SYNDHP21",96,0)
 . S @CHEMLABS@("typographyId")=$G(RESULT("typographyId"))
"RTN","SYNDHP21",97,0)
 . S @CHEMLABS@("typography")=$G(RESULT("typography"))
"RTN","SYNDHP21",98,0)
 . S @CHEMLABS@("workloadCd")=$G(RESULT("workloadCd"))
"RTN","SYNDHP21",99,0)
 . S @CHEMLABS@("workloadProcedure")=$G(RESULT("workloadProcedure"))
"RTN","SYNDHP21",100,0)
 . ;get loinc
"RTN","SYNDHP21",101,0)
 . S LOINC=$$GETLOINC(@CHEMLABS@("labTestId"),@CHEMLABS@("labTestName"),@CHEMLABS@("typographyId"))
"RTN","SYNDHP21",102,0)
 . S @CHEMLABS@("loincCode")=$P(LOINC,U,1)
"RTN","SYNDHP21",103,0)
 . S @CHEMLABS@("loincName")=$P(LOINC,U,2)
"RTN","SYNDHP21",104,0)
 ;
"RTN","SYNDHP21",105,0)
 ;I $G(DEBUG) W ! ZWRITE LABS
"RTN","SYNDHP21",106,0)
 ;
"RTN","SYNDHP21",107,0)
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.LABS,.LABSJ)
"RTN","SYNDHP21",108,0)
 ;
"RTN","SYNDHP21",109,0)
 QUIT
"RTN","SYNDHP21",110,0)
 ;
"RTN","SYNDHP21",111,0)
GETRESLT(lrDfn,invDate,ret) ;get chem lab test result
"RTN","SYNDHP21",112,0)
 quit:('$get(lrDfn))!('$get(invDate))
"RTN","SYNDHP21",113,0)
 ;
"RTN","SYNDHP21",114,0)
 new node
"RTN","SYNDHP21",115,0)
 new fieldnbr set fieldnbr=$order(^LR(lrDfn,"CH",invDate,1))
"RTN","SYNDHP21",116,0)
 if fieldnbr'="",$data(^LR(lrDfn,"CH",invDate,fieldnbr)) do
"RTN","SYNDHP21",117,0)
 . set ret("resultFor")=$piece($get(^DD(63.04,fieldnbr,0)),U,1)
"RTN","SYNDHP21",118,0)
 . set node=^LR(lrDfn,"CH",invDate,fieldnbr)
"RTN","SYNDHP21",119,0)
 . set ret("result")=$piece(node,U,1)
"RTN","SYNDHP21",120,0)
 . set ret("flag")=$piece(node,U,2)
"RTN","SYNDHP21",121,0)
 . set ret("workloadCd")=$piece($piece(node,U,3),"!",1)
"RTN","SYNDHP21",122,0)
 . if ret("workloadCd")'="" set ret("workloadProcedure")=$$GET1^DIQ(64,$order(^LAM("C",ret("workloadCd")_" ",""))_",",.01)
"RTN","SYNDHP21",123,0)
 . set ret("labTestId")=$piece($piece(node,U,3),"!",7)
"RTN","SYNDHP21",124,0)
 . set ret("labTestName")=$$GET1^DIQ(60,ret("labTestId")_",",.01)
"RTN","SYNDHP21",125,0)
 . set ret("verifyById")=$piece(node,U,4)
"RTN","SYNDHP21",126,0)
 . set ret("verifyBy")=$$GET1^DIQ(200,ret("verifyById")_",",.01)
"RTN","SYNDHP21",127,0)
 . set ret("typographyId")=$piece($piece(node,U,5),"!",1)
"RTN","SYNDHP21",128,0)
 . set ret("typography")=$$GET1^DIQ(61,ret("typographyId")_",",.01)
"RTN","SYNDHP21",129,0)
 . set ret("referenceLow")=$piece($piece(node,U,5),"!",2)
"RTN","SYNDHP21",130,0)
 . set ret("referenceHigh")=$piece($piece(node,U,5),"!",3)
"RTN","SYNDHP21",131,0)
 . set ret("criticalLow")=$piece($piece(node,U,5),"!",4)
"RTN","SYNDHP21",132,0)
 . set ret("criticalHigh")=$piece($piece(node,U,5),"!",5)
"RTN","SYNDHP21",133,0)
 . set ret("units")=$piece($piece(node,U,5),"!",7)
"RTN","SYNDHP21",134,0)
 . set ret("institutionId")=$piece(node,U,9)
"RTN","SYNDHP21",135,0)
 . set ret("institution")=$$GET1^DIQ(4,ret("institutionId")_",",.01)
"RTN","SYNDHP21",136,0)
 ;2)="110^^84330.0000!!!!!!175^1^72!60!110!50!300!!mg/dL!!!^^^^500"
"RTN","SYNDHP21",137,0)
 quit
"RTN","SYNDHP21",138,0)
 ;
"RTN","SYNDHP21",139,0)
GETLOINC(TESTIEN,TESTNAME,TYPE) ; get loinc code for test
"RTN","SYNDHP21",140,0)
 ;returns - loinc code ^ loinc code name (or test name)
"RTN","SYNDHP21",141,0)
 ;
"RTN","SYNDHP21",142,0)
 N IENS S IENS=TYPE_","_TESTIEN_","
"RTN","SYNDHP21",143,0)
 N LOINCCD S LOINCCD=$$GET1^DIQ(60.01,IENS,95.3) ;loinc code from laboratory test:site/specimen (60:100)
"RTN","SYNDHP21",144,0)
 N LOINCNM S LOINCNM=$$GET1^DIQ(95.3,+LOINCCD_",",80) ;loinc fully specified name
"RTN","SYNDHP21",145,0)
 ;if not found in Vista, then use SYNGRAPH below
"RTN","SYNDHP21",146,0)
 I LOINCCD="" D
"RTN","SYNDHP21",147,0)
 . S LOINCCD=$$graphmap^SYNGRAPH("loinc-lab-map",TESTNAME,"LOINC")
"RTN","SYNDHP21",148,0)
 . I +LOINCCD=-1 D
"RTN","SYNDHP21",149,0)
 . . S LOINCCD=""
"RTN","SYNDHP21",150,0)
 . . S LOINCNM=TESTNAME
"RTN","SYNDHP21",151,0)
 . E  D
"RTN","SYNDHP21",152,0)
 . . S LOINCNM=$$GET1^DIQ(95.3,+LOINCCD_",",80) ;loinc fully specified name
"RTN","SYNDHP21",153,0)
 ;
"RTN","SYNDHP21",154,0)
 QUIT LOINCCD_U_LOINCNM
"RTN","SYNDHP21",155,0)
 ;
"RTN","SYNDHP22")
0^109^B41410082
"RTN","SYNDHP22",1,0)
SYNDHP22 ; HC/art - HealthConcourse - get hospital location data ;03/26/2019
"RTN","SYNDHP22",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP22",3,0)
 ;;
"RTN","SYNDHP22",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP22",5,0)
 ;
"RTN","SYNDHP22",6,0)
 QUIT
"RTN","SYNDHP22",7,0)
 ;
"RTN","SYNDHP22",8,0)
 ;-------------------------------------------------------------
"RTN","SYNDHP22",9,0)
 ;
"RTN","SYNDHP22",10,0)
GETHLOC(HOSPLOC,HLOCIEN,RETJSON,HOSPLOCJ) ;get one Hospital Location record
"RTN","SYNDHP22",11,0)
 ; This API does not return all Hospital Location fields. In general, fields related to appointments are omitted
"RTN","SYNDHP22",12,0)
 ;inputs: HLOCIEN - Hospital Location IEN
"RTN","SYNDHP22",13,0)
 ;        RETJSON - J = Return JSON
"RTN","SYNDHP22",14,0)
 ;output: HOSPLOC  - array of Hospital Location data, by reference
"RTN","SYNDHP22",15,0)
 ;        HOSPLOCJ - JSON structure of Hospital Location data, by reference
"RTN","SYNDHP22",16,0)
 ;
"RTN","SYNDHP22",17,0)
 I $G(DEBUG) W !,"--------------------------- Hospital Location -----------------------------",!
"RTN","SYNDHP22",18,0)
 N S S S="_"
"RTN","SYNDHP22",19,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP22",20,0)
 N FNBR1 S FNBR1=44 ;HOSPITAL LOCATION
"RTN","SYNDHP22",21,0)
 N FNBR2 S FNBR2=44.01 ;SYNONYM
"RTN","SYNDHP22",22,0)
 N FNBR3 S FNBR3=44.101 ;ASSOCIATED LOCATION TYPES
"RTN","SYNDHP22",23,0)
 N FNBR4 S FNBR4=44.1 ;PROVIDER
"RTN","SYNDHP22",24,0)
 N IENS1 S IENS1=HLOCIEN_","
"RTN","SYNDHP22",25,0)
 N FIELDS S FIELDS=".01:4;7:10;13*;14:16;23;42;99;99.1;101*;1916;1920.9;2502;2503:2506;2600*"
"RTN","SYNDHP22",26,0)
 ;
"RTN","SYNDHP22",27,0)
 N HOSPLOCARR,HOSPLOCERR
"RTN","SYNDHP22",28,0)
 D GETS^DIQ(FNBR1,IENS1,FIELDS,"EI","HOSPLOCARR","HOSPLOCERR")
"RTN","SYNDHP22",29,0)
 ;I $G(DEBUG) W ! ZWRITE HOSPLOCARR
"RTN","SYNDHP22",30,0)
 ;I $G(DEBUG),$D(HOSPLOCERR) W !,">>ERROR<<" ZWRITE HOSPLOCERR
"RTN","SYNDHP22",31,0)
 I $D(HOSPLOCERR) D  QUIT
"RTN","SYNDHP22",32,0)
 . S HOSPLOC("Hosploc","ERROR")=HLOCIEN
"RTN","SYNDHP22",33,0)
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.HOSPLOC,.HOSPLOCJ)
"RTN","SYNDHP22",34,0)
 N HLOC S HLOC=$NA(HOSPLOC("Hosploc"))
"RTN","SYNDHP22",35,0)
 S @HLOC@("hosplocIen")=HLOCIEN
"RTN","SYNDHP22",36,0)
 S @HLOC@("resourceType")="Organization"
"RTN","SYNDHP22",37,0)
 S @HLOC@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_HLOCIEN
"RTN","SYNDHP22",38,0)
 S @HLOC@("name")=$G(HOSPLOCARR(FNBR1,IENS1,.01,"E"))
"RTN","SYNDHP22",39,0)
 S @HLOC@("abbreviation")=$G(HOSPLOCARR(FNBR1,IENS1,1,"E"))
"RTN","SYNDHP22",40,0)
 S @HLOC@("type")=$G(HOSPLOCARR(FNBR1,IENS1,2,"E"))
"RTN","SYNDHP22",41,0)
 S @HLOC@("typeCd")=$G(HOSPLOCARR(FNBR1,IENS1,2,"I"))
"RTN","SYNDHP22",42,0)
 S @HLOC@("typeExtension")=$G(HOSPLOCARR(FNBR1,IENS1,2.1,"E"))
"RTN","SYNDHP22",43,0)
 S @HLOC@("typeExtensionId")=$G(HOSPLOCARR(FNBR1,IENS1,2.1,"I"))
"RTN","SYNDHP22",44,0)
 S @HLOC@("institution")=$G(HOSPLOCARR(FNBR1,IENS1,3,"E"))
"RTN","SYNDHP22",45,0)
 S @HLOC@("institutionId")=$G(HOSPLOCARR(FNBR1,IENS1,3,"I"))
"RTN","SYNDHP22",46,0)
 S @HLOC@("division")=$G(HOSPLOCARR(FNBR1,IENS1,3.5,"E"))
"RTN","SYNDHP22",47,0)
 S @HLOC@("divisionId")=$G(HOSPLOCARR(FNBR1,IENS1,3.5,"I"))
"RTN","SYNDHP22",48,0)
 S @HLOC@("module")=$G(HOSPLOCARR(FNBR1,IENS1,4,"E"))
"RTN","SYNDHP22",49,0)
 S @HLOC@("moduleId")=$G(HOSPLOCARR(FNBR1,IENS1,4,"I"))
"RTN","SYNDHP22",50,0)
 S @HLOC@("visitLocation")=$G(HOSPLOCARR(FNBR1,IENS1,7,"E"))
"RTN","SYNDHP22",51,0)
 S @HLOC@("stopCodeNumber")=$G(HOSPLOCARR(FNBR1,IENS1,8,"E"))
"RTN","SYNDHP22",52,0)
 S @HLOC@("stopCodeNumberId")=$G(HOSPLOCARR(FNBR1,IENS1,8,"I"))
"RTN","SYNDHP22",53,0)
 S @HLOC@("prvYearStopCode")=$G(HOSPLOCARR(FNBR1,IENS1,8.1,"E"))
"RTN","SYNDHP22",54,0)
 S @HLOC@("prvYearStopCodeId")=$G(HOSPLOCARR(FNBR1,IENS1,8.1,"I"))
"RTN","SYNDHP22",55,0)
 S @HLOC@("service")=$G(HOSPLOCARR(FNBR1,IENS1,9,"E"))
"RTN","SYNDHP22",56,0)
 S @HLOC@("serviceCd")=$G(HOSPLOCARR(FNBR1,IENS1,9,"I"))
"RTN","SYNDHP22",57,0)
 S @HLOC@("treatingSpecialty")=$G(HOSPLOCARR(FNBR1,IENS1,9.5,"E"))
"RTN","SYNDHP22",58,0)
 S @HLOC@("treatingSpecialtyId")=$G(HOSPLOCARR(FNBR1,IENS1,9.5,"I"))
"RTN","SYNDHP22",59,0)
 S @HLOC@("physicalLocation")=$G(HOSPLOCARR(FNBR1,IENS1,10,"E"))
"RTN","SYNDHP22",60,0)
 S @HLOC@("specialAmisStop")=$G(HOSPLOCARR(FNBR1,IENS1,14,"E"))
"RTN","SYNDHP22",61,0)
 S @HLOC@("specialAmisStopCd")=$G(HOSPLOCARR(FNBR1,IENS1,14,"I"))
"RTN","SYNDHP22",62,0)
 S @HLOC@("categoryOfVisit")=$G(HOSPLOCARR(FNBR1,IENS1,15,"E"))
"RTN","SYNDHP22",63,0)
 S @HLOC@("defaultProvider")=$G(HOSPLOCARR(FNBR1,IENS1,16,"E"))
"RTN","SYNDHP22",64,0)
 S @HLOC@("defaultProviderId")=$G(HOSPLOCARR(FNBR1,IENS1,16,"I"))
"RTN","SYNDHP22",65,0)
 S @HLOC@("agency")=$G(HOSPLOCARR(FNBR1,IENS1,23,"E"))
"RTN","SYNDHP22",66,0)
 S @HLOC@("agencyId")=$G(HOSPLOCARR(FNBR1,IENS1,23,"I"))
"RTN","SYNDHP22",67,0)
 S @HLOC@("wardLocationFilePointer")=$G(HOSPLOCARR(FNBR1,IENS1,42,"E"))
"RTN","SYNDHP22",68,0)
 S @HLOC@("wardLocationFilePointerId")=$G(HOSPLOCARR(FNBR1,IENS1,42,"I"))
"RTN","SYNDHP22",69,0)
 S @HLOC@("telephone")=$G(HOSPLOCARR(FNBR1,IENS1,99,"E"))
"RTN","SYNDHP22",70,0)
 S @HLOC@("telephoneExtension")=$G(HOSPLOCARR(FNBR1,IENS1,99.1,"E"))
"RTN","SYNDHP22",71,0)
 S @HLOC@("principalClinic")=$G(HOSPLOCARR(FNBR1,IENS1,1916,"E"))
"RTN","SYNDHP22",72,0)
 S @HLOC@("principalClinicId")=$G(HOSPLOCARR(FNBR1,IENS1,1916,"I"))
"RTN","SYNDHP22",73,0)
 S @HLOC@("availabilityFlag")=$G(HOSPLOCARR(FNBR1,IENS1,1920.9,"E"))
"RTN","SYNDHP22",74,0)
 S @HLOC@("availabilityFlagFM")=$G(HOSPLOCARR(FNBR1,IENS1,1920.9,"I"))
"RTN","SYNDHP22",75,0)
 S @HLOC@("availabilityFlagHL7")=$$FMTHL7^XLFDT($G(HOSPLOCARR(FNBR1,IENS1,1920.9,"I")))
"RTN","SYNDHP22",76,0)
 S @HLOC@("availabilityFlagFHIR")=$$FMTFHIR^SYNDHPUTL($G(HOSPLOCARR(FNBR1,IENS1,1920.9,"I")))
"RTN","SYNDHP22",77,0)
 S @HLOC@("nonCountClinicYOrN")=$G(HOSPLOCARR(FNBR1,IENS1,2502,"E"))
"RTN","SYNDHP22",78,0)
 S @HLOC@("nonCountClinicYOrNCd")=$G(HOSPLOCARR(FNBR1,IENS1,2502,"I"))
"RTN","SYNDHP22",79,0)
 S @HLOC@("creditStopCode")=$G(HOSPLOCARR(FNBR1,IENS1,2503,"E"))
"RTN","SYNDHP22",80,0)
 S @HLOC@("creditStopCodeId")=$G(HOSPLOCARR(FNBR1,IENS1,2503,"I"))
"RTN","SYNDHP22",81,0)
 S @HLOC@("prvYearCreditStopCode")=$G(HOSPLOCARR(FNBR1,IENS1,2503.1,"E"))
"RTN","SYNDHP22",82,0)
 S @HLOC@("prvYearCreditStopCodeId")=$G(HOSPLOCARR(FNBR1,IENS1,2503.1,"I"))
"RTN","SYNDHP22",83,0)
 S @HLOC@("clinicMeetsAtThisFacility")=$G(HOSPLOCARR(FNBR1,IENS1,2504,"E"))
"RTN","SYNDHP22",84,0)
 S @HLOC@("clinicMeetsAtThisFacilityCd")=$G(HOSPLOCARR(FNBR1,IENS1,2504,"I"))
"RTN","SYNDHP22",85,0)
 S @HLOC@("inactivateDate")=$G(HOSPLOCARR(FNBR1,IENS1,2505,"E"))
"RTN","SYNDHP22",86,0)
 S @HLOC@("inactivateDateFM")=$G(HOSPLOCARR(FNBR1,IENS1,2505,"I"))
"RTN","SYNDHP22",87,0)
 S @HLOC@("inactivateDateHL7")=$$FMTHL7^XLFDT($G(HOSPLOCARR(FNBR1,IENS1,2505,"I")))
"RTN","SYNDHP22",88,0)
 S @HLOC@("inactivateDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(HOSPLOCARR(FNBR1,IENS1,2505,"I")))
"RTN","SYNDHP22",89,0)
 S @HLOC@("reactivateDate")=$G(HOSPLOCARR(FNBR1,IENS1,2506,"E"))
"RTN","SYNDHP22",90,0)
 S @HLOC@("reactivateDateFM")=$G(HOSPLOCARR(FNBR1,IENS1,2506,"I"))
"RTN","SYNDHP22",91,0)
 S @HLOC@("reactivateDateHL7")=$$FMTHL7^XLFDT($G(HOSPLOCARR(FNBR1,IENS1,2506,"I")))
"RTN","SYNDHP22",92,0)
 S @HLOC@("reactivateDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(HOSPLOCARR(FNBR1,IENS1,2506,"I")))
"RTN","SYNDHP22",93,0)
 N IENS2 S IENS2=""
"RTN","SYNDHP22",94,0)
 F  S IENS2=$O(HOSPLOCARR(FNBR2,IENS2)) QUIT:IENS2=""  D
"RTN","SYNDHP22",95,0)
 . N SYNONYM S SYNONYM=$NA(HOSPLOC("Hosploc","synonyms","synonym",+IENS2))
"RTN","SYNDHP22",96,0)
 . S @SYNONYM@("synonym")=$G(HOSPLOCARR(FNBR2,IENS2,.01,"E"))
"RTN","SYNDHP22",97,0)
 . S @SYNONYM@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_HLOCIEN_S_FNBR2_S_+IENS2
"RTN","SYNDHP22",98,0)
 N IENS3 S IENS3=""
"RTN","SYNDHP22",99,0)
 F  S IENS3=$O(HOSPLOCARR(FNBR3,IENS3)) QUIT:IENS3=""  D
"RTN","SYNDHP22",100,0)
 . N ASSLOCTP S ASSLOCTP=$NA(HOSPLOC("Hosploc","associatedLocationTypess","associatedLocationTypes",+IENS3))
"RTN","SYNDHP22",101,0)
 . S @ASSLOCTP@("associatedLocationTypes")=$G(HOSPLOCARR(FNBR3,IENS3,.01,"E"))
"RTN","SYNDHP22",102,0)
 . S @ASSLOCTP@("associatedLocationTypesId")=$G(HOSPLOCARR(FNBR3,IENS3,.01,"I"))
"RTN","SYNDHP22",103,0)
 . S @ASSLOCTP@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_HLOCIEN_S_FNBR3_S_+IENS3
"RTN","SYNDHP22",104,0)
 N IENS4 S IENS4=""
"RTN","SYNDHP22",105,0)
 F  S IENS4=$O(HOSPLOCARR(FNBR4,IENS4)) QUIT:IENS4=""  D
"RTN","SYNDHP22",106,0)
 . N PROVIDER S PROVIDER=$NA(HOSPLOC("Hosploc","providers","provider",+IENS4))
"RTN","SYNDHP22",107,0)
 . S @PROVIDER@("provider")=$G(HOSPLOCARR(FNBR4,IENS4,.01,"E"))
"RTN","SYNDHP22",108,0)
 . S @PROVIDER@("providerId")=$G(HOSPLOCARR(FNBR4,IENS4,.01,"I"))
"RTN","SYNDHP22",109,0)
 . S @PROVIDER@("defaultProvider")=$G(HOSPLOCARR(FNBR4,IENS4,.02,"E"))
"RTN","SYNDHP22",110,0)
 . S @PROVIDER@("defaultProviderCd")=$G(HOSPLOCARR(FNBR4,IENS4,.02,"I"))
"RTN","SYNDHP22",111,0)
 . S @PROVIDER@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_HLOCIEN_S_FNBR4_S_+IENS4
"RTN","SYNDHP22",112,0)
 ;
"RTN","SYNDHP22",113,0)
 ;I $G(DEBUG) W ! ZWRITE HOSPLOC
"RTN","SYNDHP22",114,0)
 ;
"RTN","SYNDHP22",115,0)
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.HOSPLOC,.HOSPLOCJ)
"RTN","SYNDHP22",116,0)
 ;
"RTN","SYNDHP22",117,0)
 QUIT
"RTN","SYNDHP22",118,0)
 ;
"RTN","SYNDHP23")
0^110^B15447210
"RTN","SYNDHP23",1,0)
SYNDHP23 ; HC/art - HealthConcourse - get visit provider data ;03/26/2019
"RTN","SYNDHP23",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP23",3,0)
 ;;
"RTN","SYNDHP23",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP23",5,0)
 ;
"RTN","SYNDHP23",6,0)
 QUIT
"RTN","SYNDHP23",7,0)
 ;
"RTN","SYNDHP23",8,0)
 ;-------------------------------------------------------------
"RTN","SYNDHP23",9,0)
 ;
"RTN","SYNDHP23",10,0)
GET1VPROV(VPROV,VPROVIEN,RETJSON,VPROVJ) ;get one V Provider record
"RTN","SYNDHP23",11,0)
 ;inputs: VPROVIEN - V Provider IEN
"RTN","SYNDHP23",12,0)
 ;        RETJSON - J = Return JSON
"RTN","SYNDHP23",13,0)
 ;output: VPROV  - array of V Provider data, by reference
"RTN","SYNDHP23",14,0)
 ;        VPROVJ - JSON structure of V Provider data, by reference
"RTN","SYNDHP23",15,0)
 ;
"RTN","SYNDHP23",16,0)
 I $G(DEBUG) W !,"--------------------------- V Provider -----------------------------",!
"RTN","SYNDHP23",17,0)
 N S S S="_"
"RTN","SYNDHP23",18,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP23",19,0)
 N FNBR1 S FNBR1=9000010.06 ;V PROVIDER
"RTN","SYNDHP23",20,0)
 N IENS1 S IENS1=VPROVIEN_","
"RTN","SYNDHP23",21,0)
 ;
"RTN","SYNDHP23",22,0)
 N VPROVARR,VPROVERR
"RTN","SYNDHP23",23,0)
 D GETS^DIQ(FNBR1,IENS1,"**","EI","VPROVARR","VPROVERR")
"RTN","SYNDHP23",24,0)
 ;I $G(DEBUG) W ! ZWRITE VPROVARR
"RTN","SYNDHP23",25,0)
 ;I $G(DEBUG),$D(VPROVERR) W ">>ERROR<<",! ZWRITE VPROVERR
"RTN","SYNDHP23",26,0)
 I $D(VPROVERR) D  QUIT
"RTN","SYNDHP23",27,0)
 . S VPROV("Vprov","ERROR")=VPROVIEN
"RTN","SYNDHP23",28,0)
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.VPROV,.VPROVJ)
"RTN","SYNDHP23",29,0)
 S VPROV("Vprov","vprovIen")=VPROVIEN
"RTN","SYNDHP23",30,0)
 S VPROV("Vprov","resourceType")="Encounter"
"RTN","SYNDHP23",31,0)
 S VPROV("Vprov","resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_VPROVIEN
"RTN","SYNDHP23",32,0)
 S VPROV("Vprov","provider")=$G(VPROVARR(FNBR1,IENS1,.01,"E"))
"RTN","SYNDHP23",33,0)
 S VPROV("Vprov","providerId")=$G(VPROVARR(FNBR1,IENS1,.01,"I"))
"RTN","SYNDHP23",34,0)
 S VPROV("Vprov","patientName")=$G(VPROVARR(FNBR1,IENS1,.02,"E"))
"RTN","SYNDHP23",35,0)
 S VPROV("Vprov","patientNameId")=$G(VPROVARR(FNBR1,IENS1,.02,"I"))
"RTN","SYNDHP23",36,0)
 S VPROV("Vprov","patientICN")=$$GET1^DIQ(2,VPROV("Vprov","patientNameId")_",",991.1)
"RTN","SYNDHP23",37,0)
 S VPROV("Vprov","visit")=$G(VPROVARR(FNBR1,IENS1,.03,"E"))
"RTN","SYNDHP23",38,0)
 S VPROV("Vprov","visitId")=$G(VPROVARR(FNBR1,IENS1,.03,"I"))
"RTN","SYNDHP23",39,0)
 S VPROV("Vprov","visitFM")=$$GET1^DIQ(9000010,VPROV("Vprov","visitId")_",",.01,"I")
"RTN","SYNDHP23",40,0)
 S VPROV("Vprov","visitHL7")=$$FMTHL7^XLFDT(VPROV("Vprov","visitFM"))
"RTN","SYNDHP23",41,0)
 S VPROV("Vprov","visitFHIR")=$$FMTFHIR^SYNDHPUTL(VPROV("Vprov","visitFM"))
"RTN","SYNDHP23",42,0)
 S VPROV("Vprov","primarySecondary")=$G(VPROVARR(FNBR1,IENS1,.04,"E"))
"RTN","SYNDHP23",43,0)
 S VPROV("Vprov","primarySecondaryCd")=$G(VPROVARR(FNBR1,IENS1,.04,"I"))
"RTN","SYNDHP23",44,0)
 S VPROV("Vprov","primarySecondarySc")=$$SENTENCE^XLFSTR(VPROV("Vprov","primarySecondary"))
"RTN","SYNDHP23",45,0)
 S VPROV("Vprov","operatingAttending")=$G(VPROVARR(FNBR1,IENS1,.05,"E"))
"RTN","SYNDHP23",46,0)
 S VPROV("Vprov","operatingAttendingCd")=$G(VPROVARR(FNBR1,IENS1,.05,"I"))
"RTN","SYNDHP23",47,0)
 S VPROV("Vprov","personClass")=$G(VPROVARR(FNBR1,IENS1,.06,"E"))
"RTN","SYNDHP23",48,0)
 S VPROV("Vprov","personClassId")=$G(VPROVARR(FNBR1,IENS1,.06,"I"))
"RTN","SYNDHP23",49,0)
 S VPROV("Vprov","eventDateAndTime")=$G(VPROVARR(FNBR1,IENS1,1201,"E"))
"RTN","SYNDHP23",50,0)
 S VPROV("Vprov","eventDateAndTimeFM")=$G(VPROVARR(FNBR1,IENS1,1201,"I"))
"RTN","SYNDHP23",51,0)
 S VPROV("Vprov","eventDateAndTimeHL7")=$$FMTHL7^XLFDT($G(VPROVARR(FNBR1,IENS1,1201,"I")))
"RTN","SYNDHP23",52,0)
 S VPROV("Vprov","eventDateAndTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(VPROVARR(FNBR1,IENS1,1201,"I")))
"RTN","SYNDHP23",53,0)
 S VPROV("Vprov","editedFlag")=$G(VPROVARR(FNBR1,IENS1,80101,"E"))
"RTN","SYNDHP23",54,0)
 S VPROV("Vprov","editedFlagCd")=$G(VPROVARR(FNBR1,IENS1,80101,"I"))
"RTN","SYNDHP23",55,0)
 S VPROV("Vprov","auditTrail")=$G(VPROVARR(FNBR1,IENS1,80102,"E"))
"RTN","SYNDHP23",56,0)
 S VPROV("Vprov","comments")=$G(VPROVARR(FNBR1,IENS1,81101,"E"))
"RTN","SYNDHP23",57,0)
 S VPROV("Vprov","verified")=$G(VPROVARR(FNBR1,IENS1,81201,"E"))
"RTN","SYNDHP23",58,0)
 S VPROV("Vprov","verifiedCd")=$G(VPROVARR(FNBR1,IENS1,81201,"I"))
"RTN","SYNDHP23",59,0)
 S VPROV("Vprov","package")=$G(VPROVARR(FNBR1,IENS1,81202,"E"))
"RTN","SYNDHP23",60,0)
 S VPROV("Vprov","packageId")=$G(VPROVARR(FNBR1,IENS1,81202,"I"))
"RTN","SYNDHP23",61,0)
 S VPROV("Vprov","dataSource")=$G(VPROVARR(FNBR1,IENS1,81203,"E"))
"RTN","SYNDHP23",62,0)
 S VPROV("Vprov","dataSourceId")=$G(VPROVARR(FNBR1,IENS1,81203,"I"))
"RTN","SYNDHP23",63,0)
 ;
"RTN","SYNDHP23",64,0)
 ;I $G(DEBUG) W ! ZWRITE VPROV
"RTN","SYNDHP23",65,0)
 ;
"RTN","SYNDHP23",66,0)
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.VPROV,.VPROVJ)
"RTN","SYNDHP23",67,0)
 ;
"RTN","SYNDHP23",68,0)
 QUIT
"RTN","SYNDHP23",69,0)
 ;
"RTN","SYNDHP24")
0^115^B129210012
"RTN","SYNDHP24",1,0)
SYNDHP24 ; HC/art - HealthConcourse - get TIU note data ;04/25/2019
"RTN","SYNDHP24",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP24",3,0)
 ;;
"RTN","SYNDHP24",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP24",5,0)
 ;
"RTN","SYNDHP24",6,0)
 QUIT
"RTN","SYNDHP24",7,0)
 ;
"RTN","SYNDHP24",8,0)
 ;-------------------------------------------------------------
"RTN","SYNDHP24",9,0)
 ;
"RTN","SYNDHP24",10,0)
GET1TIU(TIU,TIUIEN,RETJSON,TIUJ) ;get one TIU record
"RTN","SYNDHP24",11,0)
 ;inputs: TIUIEN - TIU IEN
"RTN","SYNDHP24",12,0)
 ;        RETJSON - J = Return JSON
"RTN","SYNDHP24",13,0)
 ;output: TIU  - array of TIU data, by reference
"RTN","SYNDHP24",14,0)
 ;        TIUJ - JSON structure of TIU data, by reference
"RTN","SYNDHP24",15,0)
 ;
"RTN","SYNDHP24",16,0)
 I $G(DEBUG) W !,"--------------------------- TIU -----------------------------",!
"RTN","SYNDHP24",17,0)
 N S S S="_"
"RTN","SYNDHP24",18,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP24",19,0)
 N FNBR1 S FNBR1=8925 ;TIU DOCUMENT
"RTN","SYNDHP24",20,0)
 N FNBR2 S FNBR2=8925.02 ;REPORT TEXT
"RTN","SYNDHP24",21,0)
 N IENS1 S IENS1=TIUIEN_","
"RTN","SYNDHP24",22,0)
 ;
"RTN","SYNDHP24",23,0)
 N TIUARR,TIUERR
"RTN","SYNDHP24",24,0)
 D GETS^DIQ(FNBR1,IENS1,"**","EI","TIUARR","TIUERR")
"RTN","SYNDHP24",25,0)
 ;I $G(DEBUG) W ! ZWRITE TIUARR
"RTN","SYNDHP24",26,0)
 ;I $G(DEBUG),$D(TIUERR) W !,">>ERROR<<" W ! ZWRITE TIUERR
"RTN","SYNDHP24",27,0)
 I $D(TIUERR) D  QUIT
"RTN","SYNDHP24",28,0)
 . S TIU("Tiu","ERROR")=TIUIEN
"RTN","SYNDHP24",29,0)
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.TIU,.TIUJ)
"RTN","SYNDHP24",30,0)
 S TIU("Tiu","tiuIen")=TIUIEN
"RTN","SYNDHP24",31,0)
 S TIU("Tiu","resourceType")="TiuNote"
"RTN","SYNDHP24",32,0)
 S TIU("Tiu","resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_TIUIEN
"RTN","SYNDHP24",33,0)
 S TIU("Tiu","documentType")=$G(TIUARR(FNBR1,IENS1,.01,"E"))
"RTN","SYNDHP24",34,0)
 S TIU("Tiu","documentTypeId")=$G(TIUARR(FNBR1,IENS1,.01,"I"))
"RTN","SYNDHP24",35,0)
 S TIU("Tiu","patient")=$G(TIUARR(FNBR1,IENS1,.02,"E"))
"RTN","SYNDHP24",36,0)
 S TIU("Tiu","patientId")=$G(TIUARR(FNBR1,IENS1,.02,"I"))
"RTN","SYNDHP24",37,0)
 S TIU("Tiu","visit")=$G(TIUARR(FNBR1,IENS1,.03,"E"))
"RTN","SYNDHP24",38,0)
 S TIU("Tiu","visitId")=$G(TIUARR(FNBR1,IENS1,.03,"I"))
"RTN","SYNDHP24",39,0)
 S TIU("Tiu","visitFM")=$$GET1^DIQ(9000010,TIU("Tiu","visitId")_",",.01,"I")
"RTN","SYNDHP24",40,0)
 S TIU("Tiu","visitHL7")=$$FMTHL7^XLFDT(TIU("Tiu","visitFM"))
"RTN","SYNDHP24",41,0)
 S TIU("Tiu","visitFHIR")=$$FMTFHIR^SYNDHPUTL(TIU("Tiu","visitFM"))
"RTN","SYNDHP24",42,0)
 S TIU("Tiu","parentDocumentType")=$G(TIUARR(FNBR1,IENS1,.04,"E"))
"RTN","SYNDHP24",43,0)
 S TIU("Tiu","parentDocumentTypeId")=$G(TIUARR(FNBR1,IENS1,.04,"I"))
"RTN","SYNDHP24",44,0)
 S TIU("Tiu","status")=$G(TIUARR(FNBR1,IENS1,.05,"E"))
"RTN","SYNDHP24",45,0)
 S TIU("Tiu","statusId")=$G(TIUARR(FNBR1,IENS1,.05,"I"))
"RTN","SYNDHP24",46,0)
 S TIU("Tiu","parent")=$G(TIUARR(FNBR1,IENS1,.06,"E"))
"RTN","SYNDHP24",47,0)
 S TIU("Tiu","parentId")=$G(TIUARR(FNBR1,IENS1,.06,"I"))
"RTN","SYNDHP24",48,0)
 S TIU("Tiu","episodeBeginDateTime")=$G(TIUARR(FNBR1,IENS1,.07,"E"))
"RTN","SYNDHP24",49,0)
 S TIU("Tiu","episodeBeginDateTimeFM")=$G(TIUARR(FNBR1,IENS1,.07,"I"))
"RTN","SYNDHP24",50,0)
 S TIU("Tiu","episodeBeginDateTimeHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,.07,"I")))
"RTN","SYNDHP24",51,0)
 S TIU("Tiu","episodeBeginDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,.07,"I")))
"RTN","SYNDHP24",52,0)
 S TIU("Tiu","episodeEndDateTime")=$G(TIUARR(FNBR1,IENS1,.08,"E"))
"RTN","SYNDHP24",53,0)
 S TIU("Tiu","episodeEndDateTimeFM")=$G(TIUARR(FNBR1,IENS1,.08,"I"))
"RTN","SYNDHP24",54,0)
 S TIU("Tiu","episodeEndDateTimeHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,.08,"I")))
"RTN","SYNDHP24",55,0)
 S TIU("Tiu","episodeEndDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,.08,"I")))
"RTN","SYNDHP24",56,0)
 S TIU("Tiu","urgency")=$G(TIUARR(FNBR1,IENS1,.09,"E"))
"RTN","SYNDHP24",57,0)
 S TIU("Tiu","urgencyCd")=$G(TIUARR(FNBR1,IENS1,.09,"I"))
"RTN","SYNDHP24",58,0)
 S TIU("Tiu","lineCount")=$G(TIUARR(FNBR1,IENS1,.1,"E"))
"RTN","SYNDHP24",59,0)
 S TIU("Tiu","creditStopCodeOnCompletion")=$G(TIUARR(FNBR1,IENS1,.11,"E"))
"RTN","SYNDHP24",60,0)
 S TIU("Tiu","creditStopCodeOnCompletionCd")=$G(TIUARR(FNBR1,IENS1,.11,"I"))
"RTN","SYNDHP24",61,0)
 S TIU("Tiu","markDischDtForCorrection")=$G(TIUARR(FNBR1,IENS1,.12,"E"))
"RTN","SYNDHP24",62,0)
 S TIU("Tiu","markDischDtForCorrectionCd")=$G(TIUARR(FNBR1,IENS1,.12,"I"))
"RTN","SYNDHP24",63,0)
 S TIU("Tiu","visitType")=$G(TIUARR(FNBR1,IENS1,.13,"E"))
"RTN","SYNDHP24",64,0)
 S TIU("Tiu","reportText")=""
"RTN","SYNDHP24",65,0)
 N Z S Z=""
"RTN","SYNDHP24",66,0)
 F  S Z=$O(TIUARR(FNBR1,IENS1,2,Z)) QUIT:'+Z  D
"RTN","SYNDHP24",67,0)
 . S TIU("Tiu","reportText")=TIU("Tiu","reportText")_$G(TIUARR(FNBR1,IENS1,2,Z))
"RTN","SYNDHP24",68,0)
 S TIU("Tiu","entryDateTime")=$G(TIUARR(FNBR1,IENS1,1201,"E"))
"RTN","SYNDHP24",69,0)
 S TIU("Tiu","entryDateTimeFM")=$G(TIUARR(FNBR1,IENS1,1201,"I"))
"RTN","SYNDHP24",70,0)
 S TIU("Tiu","entryDateTimeHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,1201,"I")))
"RTN","SYNDHP24",71,0)
 S TIU("Tiu","entryDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,1201,"I")))
"RTN","SYNDHP24",72,0)
 S TIU("Tiu","authorDictator")=$G(TIUARR(FNBR1,IENS1,1202,"E"))
"RTN","SYNDHP24",73,0)
 S TIU("Tiu","authorDictatorId")=$G(TIUARR(FNBR1,IENS1,1202,"I"))
"RTN","SYNDHP24",74,0)
 S TIU("Tiu","clinic")=$G(TIUARR(FNBR1,IENS1,1203,"E"))
"RTN","SYNDHP24",75,0)
 S TIU("Tiu","clinicId")=$G(TIUARR(FNBR1,IENS1,1203,"I"))
"RTN","SYNDHP24",76,0)
 S TIU("Tiu","expectedSigner")=$G(TIUARR(FNBR1,IENS1,1204,"E"))
"RTN","SYNDHP24",77,0)
 S TIU("Tiu","expectedSignerId")=$G(TIUARR(FNBR1,IENS1,1204,"I"))
"RTN","SYNDHP24",78,0)
 S TIU("Tiu","hospitalLocation")=$G(TIUARR(FNBR1,IENS1,1205,"E"))
"RTN","SYNDHP24",79,0)
 S TIU("Tiu","hospitalLocationId")=$G(TIUARR(FNBR1,IENS1,1205,"I"))
"RTN","SYNDHP24",80,0)
 S TIU("Tiu","serviceCreditStop")=$G(TIUARR(FNBR1,IENS1,1206,"E"))
"RTN","SYNDHP24",81,0)
 S TIU("Tiu","serviceCreditStopId")=$G(TIUARR(FNBR1,IENS1,1206,"I"))
"RTN","SYNDHP24",82,0)
 S TIU("Tiu","secondaryVisit")=$G(TIUARR(FNBR1,IENS1,1207,"E"))
"RTN","SYNDHP24",83,0)
 S TIU("Tiu","secondaryVisitId")=$G(TIUARR(FNBR1,IENS1,1207,"I"))
"RTN","SYNDHP24",84,0)
 S TIU("Tiu","expectedCosigner")=$G(TIUARR(FNBR1,IENS1,1208,"E"))
"RTN","SYNDHP24",85,0)
 S TIU("Tiu","expectedCosignerId")=$G(TIUARR(FNBR1,IENS1,1208,"I"))
"RTN","SYNDHP24",86,0)
 S TIU("Tiu","attendingPhysician")=$G(TIUARR(FNBR1,IENS1,1209,"E"))
"RTN","SYNDHP24",87,0)
 S TIU("Tiu","attendingPhysicianId")=$G(TIUARR(FNBR1,IENS1,1209,"I"))
"RTN","SYNDHP24",88,0)
 S TIU("Tiu","orderNumber")=$G(TIUARR(FNBR1,IENS1,1210,"E"))
"RTN","SYNDHP24",89,0)
 S TIU("Tiu","orderNumberId")=$G(TIUARR(FNBR1,IENS1,1210,"I"))
"RTN","SYNDHP24",90,0)
 S TIU("Tiu","visitLocation")=$G(TIUARR(FNBR1,IENS1,1211,"E"))
"RTN","SYNDHP24",91,0)
 S TIU("Tiu","visitLocationId")=$G(TIUARR(FNBR1,IENS1,1211,"I"))
"RTN","SYNDHP24",92,0)
 S TIU("Tiu","division")=$G(TIUARR(FNBR1,IENS1,1212,"E"))
"RTN","SYNDHP24",93,0)
 S TIU("Tiu","divisionId")=$G(TIUARR(FNBR1,IENS1,1212,"I"))
"RTN","SYNDHP24",94,0)
 S TIU("Tiu","referenceDate")=$G(TIUARR(FNBR1,IENS1,1301,"E"))
"RTN","SYNDHP24",95,0)
 S TIU("Tiu","referenceDateFM")=$G(TIUARR(FNBR1,IENS1,1301,"I"))
"RTN","SYNDHP24",96,0)
 S TIU("Tiu","referenceDateHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,1301,"I")))
"RTN","SYNDHP24",97,0)
 S TIU("Tiu","referenceDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,1301,"I")))
"RTN","SYNDHP24",98,0)
 S TIU("Tiu","enteredBy")=$G(TIUARR(FNBR1,IENS1,1302,"E"))
"RTN","SYNDHP24",99,0)
 S TIU("Tiu","enteredById")=$G(TIUARR(FNBR1,IENS1,1302,"I"))
"RTN","SYNDHP24",100,0)
 S TIU("Tiu","captureMethod")=$G(TIUARR(FNBR1,IENS1,1303,"E"))
"RTN","SYNDHP24",101,0)
 S TIU("Tiu","captureMethodCd")=$G(TIUARR(FNBR1,IENS1,1303,"I"))
"RTN","SYNDHP24",102,0)
 S TIU("Tiu","releaseDateTime")=$G(TIUARR(FNBR1,IENS1,1304,"E"))
"RTN","SYNDHP24",103,0)
 S TIU("Tiu","releaseDateTimeFM")=$G(TIUARR(FNBR1,IENS1,1304,"I"))
"RTN","SYNDHP24",104,0)
 S TIU("Tiu","releaseDateTimeHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,1304,"I")))
"RTN","SYNDHP24",105,0)
 S TIU("Tiu","releaseDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,1304,"I")))
"RTN","SYNDHP24",106,0)
 S TIU("Tiu","verificationDateTime")=$G(TIUARR(FNBR1,IENS1,1305,"E"))
"RTN","SYNDHP24",107,0)
 S TIU("Tiu","verificationDateTimeFM")=$G(TIUARR(FNBR1,IENS1,1305,"I"))
"RTN","SYNDHP24",108,0)
 S TIU("Tiu","verificationDateTimeHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,1305,"I")))
"RTN","SYNDHP24",109,0)
 S TIU("Tiu","verificationDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,1305,"I")))
"RTN","SYNDHP24",110,0)
 S TIU("Tiu","verifiedBy")=$G(TIUARR(FNBR1,IENS1,1306,"E"))
"RTN","SYNDHP24",111,0)
 S TIU("Tiu","verifiedById")=$G(TIUARR(FNBR1,IENS1,1306,"I"))
"RTN","SYNDHP24",112,0)
 S TIU("Tiu","dictationDate")=$G(TIUARR(FNBR1,IENS1,1307,"E"))
"RTN","SYNDHP24",113,0)
 S TIU("Tiu","dictationDateFM")=$G(TIUARR(FNBR1,IENS1,1307,"I"))
"RTN","SYNDHP24",114,0)
 S TIU("Tiu","dictationDateHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,1307,"I")))
"RTN","SYNDHP24",115,0)
 S TIU("Tiu","dictationDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,1307,"I")))
"RTN","SYNDHP24",116,0)
 S TIU("Tiu","suspenseDateTime")=$G(TIUARR(FNBR1,IENS1,1308,"E"))
"RTN","SYNDHP24",117,0)
 S TIU("Tiu","suspenseDateTimeFM")=$G(TIUARR(FNBR1,IENS1,1308,"I"))
"RTN","SYNDHP24",118,0)
 S TIU("Tiu","suspenseDateTimeHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,1308,"I")))
"RTN","SYNDHP24",119,0)
 S TIU("Tiu","suspenseDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,1308,"I")))
"RTN","SYNDHP24",120,0)
 S TIU("Tiu","patientMovementRecord")=$G(TIUARR(FNBR1,IENS1,1401,"E"))
"RTN","SYNDHP24",121,0)
 S TIU("Tiu","patientMovementRecordId")=$G(TIUARR(FNBR1,IENS1,1401,"I"))
"RTN","SYNDHP24",122,0)
 S TIU("Tiu","treatingSpecialty")=$G(TIUARR(FNBR1,IENS1,1402,"E"))
"RTN","SYNDHP24",123,0)
 S TIU("Tiu","treatingSpecialtyId")=$G(TIUARR(FNBR1,IENS1,1402,"I"))
"RTN","SYNDHP24",124,0)
 S TIU("Tiu","irtRecord")=$G(TIUARR(FNBR1,IENS1,1403,"E"))
"RTN","SYNDHP24",125,0)
 S TIU("Tiu","irtRecordId")=$G(TIUARR(FNBR1,IENS1,1403,"I"))
"RTN","SYNDHP24",126,0)
 S TIU("Tiu","service")=$G(TIUARR(FNBR1,IENS1,1404,"E"))
"RTN","SYNDHP24",127,0)
 S TIU("Tiu","serviceId")=$G(TIUARR(FNBR1,IENS1,1404,"I"))
"RTN","SYNDHP24",128,0)
 S TIU("Tiu","requestingPackageReference")=$G(TIUARR(FNBR1,IENS1,1405,"E"))
"RTN","SYNDHP24",129,0)
 S TIU("Tiu","requestingPackageReferenceId")=$G(TIUARR(FNBR1,IENS1,1405,"I"))
"RTN","SYNDHP24",130,0)
 S TIU("Tiu","retractedOriginal")=$G(TIUARR(FNBR1,IENS1,1406,"E"))
"RTN","SYNDHP24",131,0)
 S TIU("Tiu","retractedOriginalId")=$G(TIUARR(FNBR1,IENS1,1406,"I"))
"RTN","SYNDHP24",132,0)
 S TIU("Tiu","prfFlagAction")=$G(TIUARR(FNBR1,IENS1,1407,"E"))
"RTN","SYNDHP24",133,0)
 S TIU("Tiu","signatureDateTime")=$G(TIUARR(FNBR1,IENS1,1501,"E"))
"RTN","SYNDHP24",134,0)
 S TIU("Tiu","signatureDateTimeFM")=$G(TIUARR(FNBR1,IENS1,1501,"I"))
"RTN","SYNDHP24",135,0)
 S TIU("Tiu","signatureDateTimeHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,1501,"I")))
"RTN","SYNDHP24",136,0)
 S TIU("Tiu","signatureDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,1501,"I")))
"RTN","SYNDHP24",137,0)
 S TIU("Tiu","signedBy")=$G(TIUARR(FNBR1,IENS1,1502,"E"))
"RTN","SYNDHP24",138,0)
 S TIU("Tiu","signedById")=$G(TIUARR(FNBR1,IENS1,1502,"I"))
"RTN","SYNDHP24",139,0)
 S TIU("Tiu","signatureBlockName")=$G(TIUARR(FNBR1,IENS1,1503,"E"))
"RTN","SYNDHP24",140,0)
 S TIU("Tiu","signatureBlockTitle")=$G(TIUARR(FNBR1,IENS1,1504,"E"))
"RTN","SYNDHP24",141,0)
 S TIU("Tiu","signatureMode")=$G(TIUARR(FNBR1,IENS1,1505,"E"))
"RTN","SYNDHP24",142,0)
 S TIU("Tiu","signatureModeCd")=$G(TIUARR(FNBR1,IENS1,1505,"I"))
"RTN","SYNDHP24",143,0)
 S TIU("Tiu","cosignatureNeeded")=$G(TIUARR(FNBR1,IENS1,1506,"E"))
"RTN","SYNDHP24",144,0)
 S TIU("Tiu","cosignatureNeededCd")=$G(TIUARR(FNBR1,IENS1,1506,"I"))
"RTN","SYNDHP24",145,0)
 S TIU("Tiu","cosignatureDateTime")=$G(TIUARR(FNBR1,IENS1,1507,"E"))
"RTN","SYNDHP24",146,0)
 S TIU("Tiu","cosignatureDateTimeFM")=$G(TIUARR(FNBR1,IENS1,1507,"I"))
"RTN","SYNDHP24",147,0)
 S TIU("Tiu","cosignatureDateTimeHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,1507,"I")))
"RTN","SYNDHP24",148,0)
 S TIU("Tiu","cosignatureDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,1507,"I")))
"RTN","SYNDHP24",149,0)
 S TIU("Tiu","cosignedBy")=$G(TIUARR(FNBR1,IENS1,1508,"E"))
"RTN","SYNDHP24",150,0)
 S TIU("Tiu","cosignedById")=$G(TIUARR(FNBR1,IENS1,1508,"I"))
"RTN","SYNDHP24",151,0)
 S TIU("Tiu","cosignatureBlockName")=$G(TIUARR(FNBR1,IENS1,1509,"E"))
"RTN","SYNDHP24",152,0)
 S TIU("Tiu","cosignatureBlockTitle")=$G(TIUARR(FNBR1,IENS1,1510,"E"))
"RTN","SYNDHP24",153,0)
 S TIU("Tiu","cosignatureMode")=$G(TIUARR(FNBR1,IENS1,1511,"E"))
"RTN","SYNDHP24",154,0)
 S TIU("Tiu","cosignatureModeCd")=$G(TIUARR(FNBR1,IENS1,1511,"I"))
"RTN","SYNDHP24",155,0)
 S TIU("Tiu","markedSignedOnChartBy")=$G(TIUARR(FNBR1,IENS1,1512,"E"))
"RTN","SYNDHP24",156,0)
 S TIU("Tiu","markedSignedOnChartById")=$G(TIUARR(FNBR1,IENS1,1512,"I"))
"RTN","SYNDHP24",157,0)
 S TIU("Tiu","markedCosignedOnChartBy")=$G(TIUARR(FNBR1,IENS1,1513,"E"))
"RTN","SYNDHP24",158,0)
 S TIU("Tiu","markedCosignedOnChartById")=$G(TIUARR(FNBR1,IENS1,1513,"I"))
"RTN","SYNDHP24",159,0)
 S TIU("Tiu","amendmentDateTime")=$G(TIUARR(FNBR1,IENS1,1601,"E"))
"RTN","SYNDHP24",160,0)
 S TIU("Tiu","amendmentDateTimeFM")=$G(TIUARR(FNBR1,IENS1,1601,"I"))
"RTN","SYNDHP24",161,0)
 S TIU("Tiu","amendmentDateTimeHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,1601,"I")))
"RTN","SYNDHP24",162,0)
 S TIU("Tiu","amendmentDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,1601,"I")))
"RTN","SYNDHP24",163,0)
 S TIU("Tiu","amendedBy")=$G(TIUARR(FNBR1,IENS1,1602,"E"))
"RTN","SYNDHP24",164,0)
 S TIU("Tiu","amendedById")=$G(TIUARR(FNBR1,IENS1,1602,"I"))
"RTN","SYNDHP24",165,0)
 S TIU("Tiu","amendmentSigned")=$G(TIUARR(FNBR1,IENS1,1603,"E"))
"RTN","SYNDHP24",166,0)
 S TIU("Tiu","amendmentSignedFM")=$G(TIUARR(FNBR1,IENS1,1603,"I"))
"RTN","SYNDHP24",167,0)
 S TIU("Tiu","amendmentSignedHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,1603,"I")))
"RTN","SYNDHP24",168,0)
 S TIU("Tiu","amendmentSignedFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,1603,"I")))
"RTN","SYNDHP24",169,0)
 S TIU("Tiu","amendmentSignBlockName")=$G(TIUARR(FNBR1,IENS1,1604,"E"))
"RTN","SYNDHP24",170,0)
 S TIU("Tiu","amendmentSignBlockTitle")=$G(TIUARR(FNBR1,IENS1,1605,"E"))
"RTN","SYNDHP24",171,0)
 S TIU("Tiu","administrativeClosureDate")=$G(TIUARR(FNBR1,IENS1,1606,"E"))
"RTN","SYNDHP24",172,0)
 S TIU("Tiu","administrativeClosureDateFM")=$G(TIUARR(FNBR1,IENS1,1606,"I"))
"RTN","SYNDHP24",173,0)
 S TIU("Tiu","administrativeClosureDateHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,1606,"I")))
"RTN","SYNDHP24",174,0)
 S TIU("Tiu","administrativeClosureDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,1606,"I")))
"RTN","SYNDHP24",175,0)
 S TIU("Tiu","adminClosureSigBlockName")=$G(TIUARR(FNBR1,IENS1,1607,"E"))
"RTN","SYNDHP24",176,0)
 S TIU("Tiu","adminClosureSigBlockTitle")=$G(TIUARR(FNBR1,IENS1,1608,"E"))
"RTN","SYNDHP24",177,0)
 S TIU("Tiu","archivePurgeDateTime")=$G(TIUARR(FNBR1,IENS1,1609,"E"))
"RTN","SYNDHP24",178,0)
 S TIU("Tiu","archivePurgeDateTimeFM")=$G(TIUARR(FNBR1,IENS1,1609,"I"))
"RTN","SYNDHP24",179,0)
 S TIU("Tiu","archivePurgeDateTimeHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,1609,"I")))
"RTN","SYNDHP24",180,0)
 S TIU("Tiu","archivePurgeDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,1609,"I")))
"RTN","SYNDHP24",181,0)
 S TIU("Tiu","deletedBy")=$G(TIUARR(FNBR1,IENS1,1610,"E"))
"RTN","SYNDHP24",182,0)
 S TIU("Tiu","deletedById")=$G(TIUARR(FNBR1,IENS1,1610,"I"))
"RTN","SYNDHP24",183,0)
 S TIU("Tiu","deletionDate")=$G(TIUARR(FNBR1,IENS1,1611,"E"))
"RTN","SYNDHP24",184,0)
 S TIU("Tiu","deletionDateFM")=$G(TIUARR(FNBR1,IENS1,1611,"I"))
"RTN","SYNDHP24",185,0)
 S TIU("Tiu","deletionDateHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,1611,"I")))
"RTN","SYNDHP24",186,0)
 S TIU("Tiu","deletionDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,1611,"I")))
"RTN","SYNDHP24",187,0)
 S TIU("Tiu","reasonForDeletion")=$G(TIUARR(FNBR1,IENS1,1612,"E"))
"RTN","SYNDHP24",188,0)
 S TIU("Tiu","reasonForDeletionCd")=$G(TIUARR(FNBR1,IENS1,1612,"I"))
"RTN","SYNDHP24",189,0)
 S TIU("Tiu","administrativeClosureMode")=$G(TIUARR(FNBR1,IENS1,1613,"E"))
"RTN","SYNDHP24",190,0)
 S TIU("Tiu","administrativeClosureModeCd")=$G(TIUARR(FNBR1,IENS1,1613,"I"))
"RTN","SYNDHP24",191,0)
 S TIU("Tiu","subjectOptionalDescription")=$G(TIUARR(FNBR1,IENS1,1701,"E"))
"RTN","SYNDHP24",192,0)
 S TIU("Tiu","vbcLineCount")=$G(TIUARR(FNBR1,IENS1,1801,"E"))
"RTN","SYNDHP24",193,0)
 S TIU("Tiu","idParent")=$G(TIUARR(FNBR1,IENS1,2101,"E"))
"RTN","SYNDHP24",194,0)
 S TIU("Tiu","idParentId")=$G(TIUARR(FNBR1,IENS1,2101,"I"))
"RTN","SYNDHP24",195,0)
 S TIU("Tiu","visitId")=$G(TIUARR(FNBR1,IENS1,15001,"E"))
"RTN","SYNDHP24",196,0)
 S TIU("Tiu","procedureSummaryCode")=$G(TIUARR(FNBR1,IENS1,70201,"E"))
"RTN","SYNDHP24",197,0)
 S TIU("Tiu","procedureSummaryCodeCd")=$G(TIUARR(FNBR1,IENS1,70201,"I"))
"RTN","SYNDHP24",198,0)
 S TIU("Tiu","dateTimePerformed")=$G(TIUARR(FNBR1,IENS1,70202,"E"))
"RTN","SYNDHP24",199,0)
 S TIU("Tiu","dateTimePerformedFM")=$G(TIUARR(FNBR1,IENS1,70202,"I"))
"RTN","SYNDHP24",200,0)
 S TIU("Tiu","dateTimePerformedHL7")=$$FMTHL7^XLFDT($G(TIUARR(FNBR1,IENS1,70202,"I")))
"RTN","SYNDHP24",201,0)
 S TIU("Tiu","dateTimePerformedFHIR")=$$FMTFHIR^SYNDHPUTL($G(TIUARR(FNBR1,IENS1,70202,"I")))
"RTN","SYNDHP24",202,0)
 S TIU("Tiu","vhaEnterpriseStandardTitle")=$G(TIUARR(FNBR1,IENS1,89261,"E"))
"RTN","SYNDHP24",203,0)
 ;
"RTN","SYNDHP24",204,0)
 ;
"RTN","SYNDHP24",205,0)
 ;I $G(DEBUG) W ! ZWRITE TIU
"RTN","SYNDHP24",206,0)
 ;
"RTN","SYNDHP24",207,0)
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.TIU,.TIUJ)
"RTN","SYNDHP24",208,0)
 ;
"RTN","SYNDHP24",209,0)
 QUIT
"RTN","SYNDHP24",210,0)
 ;
"RTN","SYNDHP25")
0^116^B68600664
"RTN","SYNDHP25",1,0)
SYNDHP25 ; HC/art - HealthConcourse - get patient appointment data ;05/08/2019
"RTN","SYNDHP25",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP25",3,0)
 ;;
"RTN","SYNDHP25",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP25",5,0)
 ;
"RTN","SYNDHP25",6,0)
 QUIT
"RTN","SYNDHP25",7,0)
 ;
"RTN","SYNDHP25",8,0)
 ;-------------------------------------------------------------
"RTN","SYNDHP25",9,0)
 ;
"RTN","SYNDHP25",10,0)
GETPATAPPT(PATAPPT,PATIEN,RETJSON,PATAPPTJ) ;get patient appointment records
"RTN","SYNDHP25",11,0)
 ;inputs: PATIEN - Patient IEN
"RTN","SYNDHP25",12,0)
 ;        RETJSON - J = Return JSON
"RTN","SYNDHP25",13,0)
 ;output: PATAPPT  - array of patient appointment data, by reference
"RTN","SYNDHP25",14,0)
 ;        PATAPPTJ - JSON structure of patient appointment data, by reference
"RTN","SYNDHP25",15,0)
 ;
"RTN","SYNDHP25",16,0)
 I $G(DEBUG) W !,"--------------------------- patient appointments -----------------------------",!
"RTN","SYNDHP25",17,0)
 N S S S="_"
"RTN","SYNDHP25",18,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP25",19,0)
 N FNBR1 S FNBR1=2 ;PATIENT
"RTN","SYNDHP25",20,0)
 N FNBR2 S FNBR2=2.98 ;APPOINTMENT
"RTN","SYNDHP25",21,0)
 N IENS1 S IENS1=PATIEN_","
"RTN","SYNDHP25",22,0)
 N FIELDS S FIELDS=".01:.03;.09;991.1;1900*"
"RTN","SYNDHP25",23,0)
 ;
"RTN","SYNDHP25",24,0)
 N PATAPPTARR,PATAPPTERR
"RTN","SYNDHP25",25,0)
 D GETS^DIQ(FNBR1,IENS1,FIELDS,"EI","PATAPPTARR","PATAPPTERR")
"RTN","SYNDHP25",26,0)
 I $G(DEBUG) W ! ZWRITE PATAPPTARR
"RTN","SYNDHP25",27,0)
 I $G(DEBUG),$D(PATAPPTERR) W !,">>ERROR<<" W ! ZWRITE PATAPPTERR
"RTN","SYNDHP25",28,0)
 I $D(PATAPPTERR) D  QUIT
"RTN","SYNDHP25",29,0)
 . S PATAPPT("Patappt","ERROR")=PATIEN
"RTN","SYNDHP25",30,0)
 . D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.PATAPPT,.PATAPPTJ)
"RTN","SYNDHP25",31,0)
 S PATAPPT("Patappt","patIen")=PATIEN
"RTN","SYNDHP25",32,0)
 S PATAPPT("Patappt","resourceType")="Appointment"
"RTN","SYNDHP25",33,0)
 S PATAPPT("Patappt","resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_PATIEN
"RTN","SYNDHP25",34,0)
 S PATAPPT("Patappt","name")=$G(PATAPPTARR(FNBR1,IENS1,.01,"E"))
"RTN","SYNDHP25",35,0)
 S PATAPPT("Patappt","sex")=$G(PATAPPTARR(FNBR1,IENS1,.02,"E"))
"RTN","SYNDHP25",36,0)
 S PATAPPT("Patappt","sexCd")=$G(PATAPPTARR(FNBR1,IENS1,.02,"I"))
"RTN","SYNDHP25",37,0)
 S PATAPPT("Patappt","genderFHIR")=$S(PATAPPT("Patappt","sexCd")="M":"male",PATAPPT("Patappt","sexCd")="F":"female",1:"unknown")
"RTN","SYNDHP25",38,0)
 S PATAPPT("Patappt","selfIdentifiedGender")=$G(PATAPPTARR(FNBR1,IENS1,.024,"E"))
"RTN","SYNDHP25",39,0)
 S PATAPPT("Patappt","selfIdentifiedGenderCd")=$G(PATAPPTARR(FNBR1,IENS1,.024,"I"))
"RTN","SYNDHP25",40,0)
 S PATAPPT("Patappt","dateOfBirth")=$G(PATAPPTARR(FNBR1,IENS1,.03,"E"))
"RTN","SYNDHP25",41,0)
 S PATAPPT("Patappt","dateOfBirthFM")=$G(PATAPPTARR(FNBR1,IENS1,.03,"I"))
"RTN","SYNDHP25",42,0)
 S PATAPPT("Patappt","dateOfBirthHL7")=$$FMTHL7^XLFDT($G(PATAPPTARR(FNBR1,IENS1,.03,"I")))
"RTN","SYNDHP25",43,0)
 S PATAPPT("Patappt","dateOfBirthFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATAPPTARR(FNBR1,IENS1,.03,"I")))
"RTN","SYNDHP25",44,0)
 S PATAPPT("Patappt","socialSecurityNumber")=$G(PATAPPTARR(FNBR1,IENS1,.09,"E"))
"RTN","SYNDHP25",45,0)
 S PATAPPT("Patappt","fullIcn")=$G(PATAPPTARR(FNBR1,IENS1,991.1,"E"))
"RTN","SYNDHP25",46,0)
 N IENS2 S IENS2=""
"RTN","SYNDHP25",47,0)
 F  S IENS2=$O(PATAPPTARR(FNBR2,IENS2)) QUIT:IENS2=""  D
"RTN","SYNDHP25",48,0)
 . N APPOINT S APPOINT=$NA(PATAPPT("Patappt","appointments","appointment",+IENS2))
"RTN","SYNDHP25",49,0)
 . S @APPOINT@("appointmentDateTime")=$G(PATAPPTARR(FNBR2,IENS2,.001,"E"))
"RTN","SYNDHP25",50,0)
 . S @APPOINT@("appointmentDateTimeFM")=$G(PATAPPTARR(FNBR2,IENS2,.001,"I"))
"RTN","SYNDHP25",51,0)
 . S @APPOINT@("appointmentDateTimeHL7")=$$FMTHL7^XLFDT($G(PATAPPTARR(FNBR2,IENS2,.001,"I")))
"RTN","SYNDHP25",52,0)
 . S @APPOINT@("appointmentDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATAPPTARR(FNBR2,IENS2,.001,"I")))
"RTN","SYNDHP25",53,0)
 . S @APPOINT@("clinic")=$G(PATAPPTARR(FNBR2,IENS2,.01,"E"))
"RTN","SYNDHP25",54,0)
 . S @APPOINT@("clinicId")=$G(PATAPPTARR(FNBR2,IENS2,.01,"I"))
"RTN","SYNDHP25",55,0)
 . S @APPOINT@("telephoneOfClinic")=$G(PATAPPTARR(FNBR2,IENS2,.02,"E"))
"RTN","SYNDHP25",56,0)
 . S @APPOINT@("status")=$G(PATAPPTARR(FNBR2,IENS2,3,"E"))
"RTN","SYNDHP25",57,0)
 . S @APPOINT@("statusCd")=$G(PATAPPTARR(FNBR2,IENS2,3,"I"))
"RTN","SYNDHP25",58,0)
 . N STATUS S STATUS=$G(PATAPPTARR(FNBR2,IENS2,3,"I"))
"RTN","SYNDHP25",59,0)
 . S @APPOINT@("statusFHIR")=$S(STATUS="":"booked",STATUS["C":"cancelled",STATUS="I":"booked",STATUS="N":"noshow",STATUS="NA":"noshow",STATUS="NT":"booked",1:"entered-in-error")
"RTN","SYNDHP25",60,0)
 . S @APPOINT@("realAppointment")=$G(PATAPPTARR(FNBR2,IENS2,4,"E"))
"RTN","SYNDHP25",61,0)
 . S @APPOINT@("labDateTime")=$G(PATAPPTARR(FNBR2,IENS2,5,"E"))
"RTN","SYNDHP25",62,0)
 . S @APPOINT@("labDateTimeFM")=$G(PATAPPTARR(FNBR2,IENS2,5,"I"))
"RTN","SYNDHP25",63,0)
 . S @APPOINT@("labDateTimeHL7")=$$FMTHL7^XLFDT($G(PATAPPTARR(FNBR2,IENS2,5,"I")))
"RTN","SYNDHP25",64,0)
 . S @APPOINT@("labDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATAPPTARR(FNBR2,IENS2,5,"I")))
"RTN","SYNDHP25",65,0)
 . S @APPOINT@("xRayDateTime")=$G(PATAPPTARR(FNBR2,IENS2,6,"E"))
"RTN","SYNDHP25",66,0)
 . S @APPOINT@("xRayDateTimeFM")=$G(PATAPPTARR(FNBR2,IENS2,6,"I"))
"RTN","SYNDHP25",67,0)
 . S @APPOINT@("xRayDateTimeHL7")=$$FMTHL7^XLFDT($G(PATAPPTARR(FNBR2,IENS2,6,"I")))
"RTN","SYNDHP25",68,0)
 . S @APPOINT@("xRayDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATAPPTARR(FNBR2,IENS2,6,"I")))
"RTN","SYNDHP25",69,0)
 . S @APPOINT@("ekgDateTime")=$G(PATAPPTARR(FNBR2,IENS2,7,"E"))
"RTN","SYNDHP25",70,0)
 . S @APPOINT@("ekgDateTimeFM")=$G(PATAPPTARR(FNBR2,IENS2,7,"I"))
"RTN","SYNDHP25",71,0)
 . S @APPOINT@("ekgDateTimeHL7")=$$FMTHL7^XLFDT($G(PATAPPTARR(FNBR2,IENS2,7,"I")))
"RTN","SYNDHP25",72,0)
 . S @APPOINT@("ekgDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATAPPTARR(FNBR2,IENS2,7,"I")))
"RTN","SYNDHP25",73,0)
 . S @APPOINT@("routingSlipPrinted")=$G(PATAPPTARR(FNBR2,IENS2,8,"E"))
"RTN","SYNDHP25",74,0)
 . S @APPOINT@("routingSlipPrintedCd")=$G(PATAPPTARR(FNBR2,IENS2,8,"I"))
"RTN","SYNDHP25",75,0)
 . S @APPOINT@("routingSlipPrintDate")=$G(PATAPPTARR(FNBR2,IENS2,8.5,"E"))
"RTN","SYNDHP25",76,0)
 . S @APPOINT@("routingSlipPrintDateFM")=$G(PATAPPTARR(FNBR2,IENS2,8.5,"I"))
"RTN","SYNDHP25",77,0)
 . S @APPOINT@("routingSlipPrintDateHL7")=$$FMTHL7^XLFDT($G(PATAPPTARR(FNBR2,IENS2,8.5,"I")))
"RTN","SYNDHP25",78,0)
 . S @APPOINT@("routingSlipPrintDateFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATAPPTARR(FNBR2,IENS2,8.5,"I")))
"RTN","SYNDHP25",79,0)
 . S @APPOINT@("purposeOfVisit")=$G(PATAPPTARR(FNBR2,IENS2,9,"E"))
"RTN","SYNDHP25",80,0)
 . S @APPOINT@("purposeOfVisitCd")=$G(PATAPPTARR(FNBR2,IENS2,9,"I"))
"RTN","SYNDHP25",81,0)
 . N POV S POV=$G(PATAPPTARR(FNBR2,IENS2,9,"I"))
"RTN","SYNDHP25",82,0)
 . S @APPOINT@("appointmentTypeFHIR")=$S(POV="4":"WALKIN",1:"ROUTINE")
"RTN","SYNDHP25",83,0)
 . S @APPOINT@("appointmentType")=$G(PATAPPTARR(FNBR2,IENS2,9.5,"E"))
"RTN","SYNDHP25",84,0)
 . S @APPOINT@("appointmentTypeId")=$G(PATAPPTARR(FNBR2,IENS2,9.5,"I"))
"RTN","SYNDHP25",85,0)
 . S @APPOINT@("specialSurveyDisposition")=$G(PATAPPTARR(FNBR2,IENS2,10,"E"))
"RTN","SYNDHP25",86,0)
 . S @APPOINT@("numberOfCollateralSeen")=$G(PATAPPTARR(FNBR2,IENS2,11,"E"))
"RTN","SYNDHP25",87,0)
 . S @APPOINT@("autoRebookedApptDateTime")=$G(PATAPPTARR(FNBR2,IENS2,12,"E"))
"RTN","SYNDHP25",88,0)
 . S @APPOINT@("autoRebookedApptDateTimeFM")=$G(PATAPPTARR(FNBR2,IENS2,12,"I"))
"RTN","SYNDHP25",89,0)
 . S @APPOINT@("autoRebookedApptDateTimeHL7")=$$FMTHL7^XLFDT($G(PATAPPTARR(FNBR2,IENS2,12,"I")))
"RTN","SYNDHP25",90,0)
 . S @APPOINT@("autoRebookedApptDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATAPPTARR(FNBR2,IENS2,12,"I")))
"RTN","SYNDHP25",91,0)
 . S @APPOINT@("collateralVisit")=$G(PATAPPTARR(FNBR2,IENS2,13,"E"))
"RTN","SYNDHP25",92,0)
 . S @APPOINT@("collateralVisitCd")=$G(PATAPPTARR(FNBR2,IENS2,13,"I"))
"RTN","SYNDHP25",93,0)
 . S @APPOINT@("noShowCancelledBy")=$G(PATAPPTARR(FNBR2,IENS2,14,"E"))
"RTN","SYNDHP25",94,0)
 . S @APPOINT@("noShowCancelledById")=$G(PATAPPTARR(FNBR2,IENS2,14,"I"))
"RTN","SYNDHP25",95,0)
 . S @APPOINT@("noShowCancelDateTime")=$G(PATAPPTARR(FNBR2,IENS2,15,"E"))
"RTN","SYNDHP25",96,0)
 . S @APPOINT@("noShowCancelDateTimeFM")=$G(PATAPPTARR(FNBR2,IENS2,15,"I"))
"RTN","SYNDHP25",97,0)
 . S @APPOINT@("noShowCancelDateTimeHL7")=$$FMTHL7^XLFDT($G(PATAPPTARR(FNBR2,IENS2,15,"I")))
"RTN","SYNDHP25",98,0)
 . S @APPOINT@("noShowCancelDateTimeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATAPPTARR(FNBR2,IENS2,15,"I")))
"RTN","SYNDHP25",99,0)
 . S @APPOINT@("cancellationReason")=$G(PATAPPTARR(FNBR2,IENS2,16,"E"))
"RTN","SYNDHP25",100,0)
 . S @APPOINT@("cancellationReasonId")=$G(PATAPPTARR(FNBR2,IENS2,16,"I"))
"RTN","SYNDHP25",101,0)
 . S @APPOINT@("cancellationRemarks")=$G(PATAPPTARR(FNBR2,IENS2,17,"E"))
"RTN","SYNDHP25",102,0)
 . S @APPOINT@("apptCancelled")=$G(PATAPPTARR(FNBR2,IENS2,18,"E"))
"RTN","SYNDHP25",103,0)
 . S @APPOINT@("apptCancelledId")=$G(PATAPPTARR(FNBR2,IENS2,18,"I"))
"RTN","SYNDHP25",104,0)
 . S @APPOINT@("dataEntryClerk")=$G(PATAPPTARR(FNBR2,IENS2,19,"E"))
"RTN","SYNDHP25",105,0)
 . S @APPOINT@("dataEntryClerkId")=$G(PATAPPTARR(FNBR2,IENS2,19,"I"))
"RTN","SYNDHP25",106,0)
 . S @APPOINT@("dateApptMade")=$G(PATAPPTARR(FNBR2,IENS2,20,"E"))
"RTN","SYNDHP25",107,0)
 . S @APPOINT@("dateApptMadeFM")=$G(PATAPPTARR(FNBR2,IENS2,20,"I"))
"RTN","SYNDHP25",108,0)
 . S @APPOINT@("dateApptMadeHL7")=$$FMTHL7^XLFDT($G(PATAPPTARR(FNBR2,IENS2,20,"I")))
"RTN","SYNDHP25",109,0)
 . S @APPOINT@("dateApptMadeFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATAPPTARR(FNBR2,IENS2,20,"I")))
"RTN","SYNDHP25",110,0)
 . S @APPOINT@("outpatientEncounter")=$G(PATAPPTARR(FNBR2,IENS2,21,"E"))
"RTN","SYNDHP25",111,0)
 . S @APPOINT@("outpatientEncounterId")=$G(PATAPPTARR(FNBR2,IENS2,21,"I"))
"RTN","SYNDHP25",112,0)
 . S @APPOINT@("encounterFormsPrinted")=$G(PATAPPTARR(FNBR2,IENS2,22,"E"))
"RTN","SYNDHP25",113,0)
 . S @APPOINT@("encounterFormsPrintedCd")=$G(PATAPPTARR(FNBR2,IENS2,22,"I"))
"RTN","SYNDHP25",114,0)
 . S @APPOINT@("encounterFormsAsAddOns")=$G(PATAPPTARR(FNBR2,IENS2,23,"E"))
"RTN","SYNDHP25",115,0)
 . S @APPOINT@("encounterFormsAsAddOnsCd")=$G(PATAPPTARR(FNBR2,IENS2,23,"I"))
"RTN","SYNDHP25",116,0)
 . S @APPOINT@("encounterConversionStatus")=$G(PATAPPTARR(FNBR2,IENS2,23.1,"E"))
"RTN","SYNDHP25",117,0)
 . S @APPOINT@("encounterConversionStatusCd")=$G(PATAPPTARR(FNBR2,IENS2,23.1,"I"))
"RTN","SYNDHP25",118,0)
 . S @APPOINT@("appointmentTypeSubCategory")=$G(PATAPPTARR(FNBR2,IENS2,24,"E"))
"RTN","SYNDHP25",119,0)
 . S @APPOINT@("appointmentTypeSubCategoryId")=$G(PATAPPTARR(FNBR2,IENS2,24,"I"))
"RTN","SYNDHP25",120,0)
 . S @APPOINT@("schedulingRequestType")=$G(PATAPPTARR(FNBR2,IENS2,25,"E"))
"RTN","SYNDHP25",121,0)
 . S @APPOINT@("schedulingRequestTypeCd")=$G(PATAPPTARR(FNBR2,IENS2,25,"I"))
"RTN","SYNDHP25",122,0)
 . S @APPOINT@("nextAvaApptIndicator")=$G(PATAPPTARR(FNBR2,IENS2,26,"E"))
"RTN","SYNDHP25",123,0)
 . S @APPOINT@("nextAvaApptIndicatorCd")=$G(PATAPPTARR(FNBR2,IENS2,26,"I"))
"RTN","SYNDHP25",124,0)
 . S @APPOINT@("desiredDateOfAppointment")=$G(PATAPPTARR(FNBR2,IENS2,27,"E"))
"RTN","SYNDHP25",125,0)
 . S @APPOINT@("desiredDateOfAppointmentFM")=$G(PATAPPTARR(FNBR2,IENS2,27,"I"))
"RTN","SYNDHP25",126,0)
 . S @APPOINT@("desiredDateOfAppointmentHL7")=$$FMTHL7^XLFDT($G(PATAPPTARR(FNBR2,IENS2,27,"I")))
"RTN","SYNDHP25",127,0)
 . S @APPOINT@("desiredDateOfAppointmentFHIR")=$$FMTFHIR^SYNDHPUTL($G(PATAPPTARR(FNBR2,IENS2,27,"I")))
"RTN","SYNDHP25",128,0)
 . S @APPOINT@("followUpVisit")=$G(PATAPPTARR(FNBR2,IENS2,28,"E"))
"RTN","SYNDHP25",129,0)
 . S @APPOINT@("followUpVisitCd")=$G(PATAPPTARR(FNBR2,IENS2,28,"I"))
"RTN","SYNDHP25",130,0)
 . S @APPOINT@("currentStatus")=$G(PATAPPTARR(FNBR2,IENS2,100,"E"))
"RTN","SYNDHP25",131,0)
 . S @APPOINT@("resourceId")=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_PATIEN_S_FNBR2_S_+IENS2
"RTN","SYNDHP25",132,0)
 ;
"RTN","SYNDHP25",133,0)
 ;I $G(DEBUG) W ! ZWRITE PATAPPT
"RTN","SYNDHP25",134,0)
 ;
"RTN","SYNDHP25",135,0)
 D:$G(RETJSON)="J" TOJASON^SYNDHPUTL(.PATAPPT,.PATAPPTJ)
"RTN","SYNDHP25",136,0)
 ;
"RTN","SYNDHP25",137,0)
 QUIT
"RTN","SYNDHP25",138,0)
 ;
"RTN","SYNDHP40")
0^106^B22154311
"RTN","SYNDHP40",1,0)
SYNDHP40 ; HC/fjf/art - HealthConcourse - retrieve patient encounters ;05/04/2019
"RTN","SYNDHP40",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP40",3,0)
 ;;
"RTN","SYNDHP40",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP40",5,0)
 ;
"RTN","SYNDHP40",6,0)
 QUIT
"RTN","SYNDHP40",7,0)
 ;
"RTN","SYNDHP40",8,0)
 ; ---------------- Get patient encounters ----------------------------
"RTN","SYNDHP40",9,0)
 ;
"RTN","SYNDHP40",10,0)
PATENCI(RETSTA,DHPICN,FRDAT,TODAT) ; Patient primary encounters for ICN
"RTN","SYNDHP40",11,0)
 ;
"RTN","SYNDHP40",12,0)
 ; Return primary encounters/visits for a given patient ICN
"RTN","SYNDHP40",13,0)
 ;
"RTN","SYNDHP40",14,0)
 ; Input:
"RTN","SYNDHP40",15,0)
 ;   ICN     - unique patient identifier across all VistA systems
"RTN","SYNDHP40",16,0)
 ;   FRDAT   - from date (inclusive), optional, compared to .01 VISIT/ADMIT DATE&TIME
"RTN","SYNDHP40",17,0)
 ;   TODAT   - to date (inclusive), optional, compared to .01 VISIT/ADMIT DATE&TIME
"RTN","SYNDHP40",18,0)
 ; Output:
"RTN","SYNDHP40",19,0)
 ;   RETSTA  - a delimited string that lists the following information
"RTN","SYNDHP40",20,0)
 ;      PatientICN ^ RESOURSE ID ^ TYPE ^ ENCOUNTER DATE ^ REASON ^ ICD DIAGNOSIS CODE ; ICD DIAGNOSIS NAME 
"RTN","SYNDHP40",21,0)
 ;      ^ SERVICE CATEGORY ^ SOURCE ^  
"RTN","SYNDHP40",22,0)
 ;      ^ LOCATION OF ENCOUNTER , LOCATION ADDRESS SEPARATED BY SEMICOLONS ^ HOSPITAL LOCATION
"RTN","SYNDHP40",23,0)
 ;      ^ PROVIDER(S) SEPARATED BY SEMICOLONS
"RTN","SYNDHP40",24,0)
 ;
"RTN","SYNDHP40",25,0)
 ;   Identifier will be "V_"_SITE ID_"_"_FILE #_"_"_FILE IEN   i.e. V_500_9000010_930
"RTN","SYNDHP40",26,0)
 ;
"RTN","SYNDHP40",27,0)
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
"RTN","SYNDHP40",28,0)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
"RTN","SYNDHP40",29,0)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
"RTN","SYNDHP40",30,0)
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
"RTN","SYNDHP40",31,0)
 ;
"RTN","SYNDHP40",32,0)
 ; validate ICN
"RTN","SYNDHP40",33,0)
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
"RTN","SYNDHP40",34,0)
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" Q
"RTN","SYNDHP40",35,0)
 ;
"RTN","SYNDHP40",36,0)
 N C,ACU,P,S,IDENT,ENCDT,ENCDTI,TYPE,SERV,SOURCE,LOC,HLOC,LOCI,LOCD,LOCA,SITE,CONIEN
"RTN","SYNDHP40",37,0)
 N DIAGC,DIAGN,ENFLG,DATEN,DISD,PROV,REASON,PROV,PROV1,PATIEN,RETDESC,PERIOD,PERIODFM
"RTN","SYNDHP40",38,0)
 N DIEN
"RTN","SYNDHP40",39,0)
 S C=",",P="|",S=";"
"RTN","SYNDHP40",40,0)
 S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP40",41,0)
 ;
"RTN","SYNDHP40",42,0)
 ; get patient IEN from ICN
"RTN","SYNDHP40",43,0)
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP40",44,0)
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
"RTN","SYNDHP40",45,0)
 S RETDESC=""
"RTN","SYNDHP40",46,0)
 ;
"RTN","SYNDHP40",47,0)
 S DIEN=""
"RTN","SYNDHP40",48,0)
 F  S DIEN=$O(^AUPNVSIT("C",PATIEN,DIEN)) QUIT:DIEN=""  D
"RTN","SYNDHP40",49,0)
 . N VISITX,VISITE
"RTN","SYNDHP40",50,0)
 . D GETS^DIQ(9000010,DIEN_",",".01;.05;.06;.07;.22;15002;15003;81203","EIN","VISITX","VISITE")
"RTN","SYNDHP40",51,0)
 . QUIT:$D(VISITE)
"RTN","SYNDHP40",52,0)
 . I $G(VISITX(9000010,DIEN_",",15003,"I"))'="P" QUIT
"RTN","SYNDHP40",53,0)
 . N IDENT,PERIOD,ENCDTI,TYPE,SERV,SOURCE,LOC,HLOC,LOCI,LOCD,LOCA,CONIEN,DIAGC,DIAGN
"RTN","SYNDHP40",54,0)
 . N PDO,ENFLG,DATEN,DISD,PROV,REASON,DIAGC,PROV1,PROV
"RTN","SYNDHP40",55,0)
 . S IDENT=$$RESID^SYNDHP69("V",SITE)_"_9000010_"_DIEN
"RTN","SYNDHP40",56,0)
 . S PERIODFM=$G(VISITX(9000010,DIEN_",",.01,"I"))   ; encounter date/time
"RTN","SYNDHP40",57,0)
 . QUIT:((PERIODFM\1)<FRDAT)!((PERIODFM\1)>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP40",58,0)
 . S PERIOD=$$FMTHL7^XLFDT($G(VISITX(9000010,DIEN_",",.01,"I")))   ; date/time, HL7 format
"RTN","SYNDHP40",59,0)
 . S ENCDTI=$P($G(VISITX(9000010,DIEN_",",.01,"I")),".",1)
"RTN","SYNDHP40",60,0)
 . S ENFLG=0,CONIEN=""
"RTN","SYNDHP40",61,0)
 . F  S CONIEN=$O(^AUPNPROB("AC",PATIEN,CONIEN)) QUIT:CONIEN=""  D  QUIT:ENFLG=1  ;get first diagnosis for patient
"RTN","SYNDHP40",62,0)
 .. S DATEN=$$GET1^DIQ(9000011,CONIEN_",",.08,"I") QUIT:DATEN'=$P($G(ENCDTI),".",1)  ;date/time must equal date entered
"RTN","SYNDHP40",63,0)
 .. S REASON=$$GET1^DIQ(9000011,CONIEN_",",1.01)   ; reason
"RTN","SYNDHP40",64,0)
 .. S DIAGC=$$GET1^DIQ(9000011,CONIEN_",",.01,"I") ; condition
"RTN","SYNDHP40",65,0)
 .. S DIAGN=$G(^ICD9(DIAGC,68,1,1))           ; diagnosis
"RTN","SYNDHP40",66,0)
 .. S ENFLG=1    ;set flag to know we have data and can move on
"RTN","SYNDHP40",67,0)
 . S:$D(VISITX(9000010,DIEN_",",15002,"E")) TYPE=$G(VISITX(9000010,DIEN_",",15002,"E"))    ; encounter type
"RTN","SYNDHP40",68,0)
 . S:$D(VISITX(9000010,DIEN_",",15003,"E")) DISD=$G(VISITX(9000010,DIEN_",",15003,"E"))    ; discharge disposition
"RTN","SYNDHP40",69,0)
 . S:$D(VISITX(9000010,DIEN_",",.06,"E")) LOC=$G(VISITX(9000010,DIEN_",",.06,"E")),LOCI=$G(VISITX(9000010,DIEN_",",.06,"I")) ; location
"RTN","SYNDHP40",70,0)
 . I $G(LOCI)'="" D
"RTN","SYNDHP40",71,0)
 .. S LOCD=$G(^DIC(4,LOCI,1))
"RTN","SYNDHP40",72,0)
 .. S LOCA=$P(LOCD,U,1)_S_$P(LOCD,U,2)_S_$P(LOCD,U,3)_S_$P(LOCD,U,4) ; location address
"RTN","SYNDHP40",73,0)
 . S:$D(VISITX(9000010,DIEN_",",.07,"E")) SERV=$G(VISITX(9000010,DIEN_",",.07,"E"))        ; service category
"RTN","SYNDHP40",74,0)
 . S:$D(VISITX(9000010,DIEN_",",.22,"E")) HLOC=$G(VISITX(9000010,DIEN_",",.22,"E"))        ; hospital location
"RTN","SYNDHP40",75,0)
 . S:$D(VISITX(9000010,DIEN_",",81203,"E")) SOURCE=$G(VISITX(9000010,DIEN_",",81203,"E"))  ; Source
"RTN","SYNDHP40",76,0)
 . S PDO=0,(PROV1,PROV)=""
"RTN","SYNDHP40",77,0)
 . F  S PDO=$O(^AUPNVPRV("AD",DIEN,PDO)) Q:PDO=""  D
"RTN","SYNDHP40",78,0)
 .. S PROV1=$P(^AUPNVPRV(PDO,0),U,1)
"RTN","SYNDHP40",79,0)
 .. S PROV=PROV_$$GET1^DIQ(200,PROV1_",",.01)_S
"RTN","SYNDHP40",80,0)
 . S RETDESC=RETDESC_$G(IDENT)_U_$G(TYPE)_U_$G(PERIOD)_U_$G(REASON)_U_$G(DIAGC)_S_$G(DIAGN)_U_$G(SERV)_U_$G(SOURCE)_U_$G(LOC)_C_$G(LOCA)_U_$G(HLOC)_U_PROV_P
"RTN","SYNDHP40",81,0)
 S RETSTA=DHPICN_U_RETDESC
"RTN","SYNDHP40",82,0)
 ;
"RTN","SYNDHP40",83,0)
 QUIT
"RTN","SYNDHP40",84,0)
 ;
"RTN","SYNDHP40",85,0)
 ; ----------- Unit Test -----------
"RTN","SYNDHP40",86,0)
T1 ;
"RTN","SYNDHP40",87,0)
 N ICN S ICN="2676604935V204585"
"RTN","SYNDHP40",88,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP40",89,0)
 N TODAT S TODAT=""
"RTN","SYNDHP40",90,0)
 N RETSTA
"RTN","SYNDHP40",91,0)
 D PATENCI(.RETSTA,ICN,FRDAT,TODAT)
"RTN","SYNDHP40",92,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP40",93,0)
 QUIT
"RTN","SYNDHP40",94,0)
 ;
"RTN","SYNDHP41")
0^107^B11397025
"RTN","SYNDHP41",1,0)
SYNDHP41 ; HC/rdb/art - HealthConcourse - retrieve patient appointments ;05/04/2019
"RTN","SYNDHP41",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP41",3,0)
 ;;
"RTN","SYNDHP41",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP41",5,0)
 ;
"RTN","SYNDHP41",6,0)
 QUIT
"RTN","SYNDHP41",7,0)
 ;
"RTN","SYNDHP41",8,0)
 ; ---------------- Get patient appointment information ------------------------------
"RTN","SYNDHP41",9,0)
 ;
"RTN","SYNDHP41",10,0)
PATAPTI(RETSTA,DHPICN,FRDAT,TODAT) ; Patient appointments for ICN
"RTN","SYNDHP41",11,0)
 ;
"RTN","SYNDHP41",12,0)
 ; Return patient appointments for a given patient ICN
"RTN","SYNDHP41",13,0)
 ; Returns a patient's appointments from PATIENT:APPOINTMENT (2:1900)
"RTN","SYNDHP41",14,0)
 ;
"RTN","SYNDHP41",15,0)
 ; Input:
"RTN","SYNDHP41",16,0)
 ;   ICN     - unique patient identifier across all VistA systems
"RTN","SYNDHP41",17,0)
 ;   FRDAT   - from date (inclusive), optional, compared to appointment date/time
"RTN","SYNDHP41",18,0)
 ;   TODAT   - to date (inclusive), optional, compared to appointment date/time
"RTN","SYNDHP41",19,0)
 ; Output:
"RTN","SYNDHP41",20,0)
 ;   RETSTA  - a delimited string that lists patient appointment information
"RTN","SYNDHP41",21,0)
 ;          ICN ^ Patient IEN _ Appt Date (HL7) | Clinic | Appt Status | purpose of visit | Appt Type | Resource ID ^...
"RTN","SYNDHP41",22,0)
 ;
"RTN","SYNDHP41",23,0)
 ; bypass for CQM
"RTN","SYNDHP41",24,0)
 ; 
"RTN","SYNDHP41",25,0)
 ; ***********
"RTN","SYNDHP41",26,0)
 ; *********** Important Note for open source community
"RTN","SYNDHP41",27,0)
 ; ***********
"RTN","SYNDHP41",28,0)
 ; *********** Perspecta - who developed this source code and have released it to the open source
"RTN","SYNDHP41",29,0)
 ; *********** need the following six lines to remain intact
"RTN","SYNDHP41",30,0)
 ; 
"RTN","SYNDHP41",31,0)
 ;I DHPICN="1686299845V246594" D  Q
"RTN","SYNDHP41",32,0)
 ;.S RETSTA="1686299845V246594^101916_201704281200-0500|GENERAL MEDICINE||UNSCHED. VISIT|REGULAR"
"RTN","SYNDHP41",33,0)
 ;
"RTN","SYNDHP41",34,0)
 ; *********** the above lines will be redacted by Perspecta at some suitable juncture to 
"RTN","SYNDHP41",35,0)
 ; *********** be determined by Perspecta
"RTN","SYNDHP41",36,0)
 ; ***********
"RTN","SYNDHP41",37,0)
 ; *********** End of Important Note for open source community
"RTN","SYNDHP41",38,0)
 ;
"RTN","SYNDHP41",39,0)
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
"RTN","SYNDHP41",40,0)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
"RTN","SYNDHP41",41,0)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
"RTN","SYNDHP41",42,0)
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
"RTN","SYNDHP41",43,0)
 ;
"RTN","SYNDHP41",44,0)
 ; validate ICN
"RTN","SYNDHP41",45,0)
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
"RTN","SYNDHP41",46,0)
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" Q
"RTN","SYNDHP41",47,0)
 ; 
"RTN","SYNDHP41",48,0)
 ; get patient IEN from ICN
"RTN","SYNDHP41",49,0)
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP41",50,0)
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
"RTN","SYNDHP41",51,0)
 ;
"RTN","SYNDHP41",52,0)
 S RETSTA=$$APPTS(PATIEN,DHPICN,FRDAT,TODAT)
"RTN","SYNDHP41",53,0)
 Q
"RTN","SYNDHP41",54,0)
 ;
"RTN","SYNDHP41",55,0)
APPTS(PATIEN,DHPICN,FRDAT,TODAT) ; get appointments for a patient
"RTN","SYNDHP41",56,0)
 ;
"RTN","SYNDHP41",57,0)
 N HLFCTS,FNUM,SITE,APPTDTTM,PTAPTID,CLNAM,APDTDISP,APPTSTAT,APPTPURP,APPTTYPE,ZARR
"RTN","SYNDHP41",58,0)
 N C,P,S
"RTN","SYNDHP41",59,0)
 S C=",",P="|",S="_"
"RTN","SYNDHP41",60,0)
 S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP41",61,0)
 S FNUM=2.98      ;  patient appointment sub-file
"RTN","SYNDHP41",62,0)
 ; scan PATIENT "S" index for Appointments
"RTN","SYNDHP41",63,0)
 S APPTDTTM=0
"RTN","SYNDHP41",64,0)
 F  S APPTDTTM=$O(^DPT(PATIEN,"S",APPTDTTM)) Q:APPTDTTM=""  D
"RTN","SYNDHP41",65,0)
 .QUIT:((APPTDTTM\1)<FRDAT)!((APPTDTTM\1)>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP41",66,0)
 .S PTAPTID=$$RESID^SYNDHP69("V",SITE)_S_2_S_PATIEN_S_FNUM_S_APPTDTTM
"RTN","SYNDHP41",67,0)
 .S CLNAM=$$GET1^DIQ(FNUM,APPTDTTM_","_PATIEN,.01) ;clinic
"RTN","SYNDHP41",68,0)
 .S APDTDISP=$$FMTHL7^XLFDT(APPTDTTM) ;appt. date/time
"RTN","SYNDHP41",69,0)
 .S APPTSTAT=$$GET1^DIQ(FNUM,APPTDTTM_","_PATIEN,3) ;status
"RTN","SYNDHP41",70,0)
 .S APPTPURP=$$GET1^DIQ(FNUM,APPTDTTM_","_PATIEN,9) ;purpose of visit
"RTN","SYNDHP41",71,0)
 .S APPTTYPE=$$GET1^DIQ(FNUM,APPTDTTM_","_PATIEN,9.5) ;appt. type
"RTN","SYNDHP41",72,0)
 .S ZARR(DHPICN,APPTDTTM)=PATIEN_S_APDTDISP_P_CLNAM_P_APPTSTAT_P_APPTPURP_P_APPTTYPE_P_PTAPTID
"RTN","SYNDHP41",73,0)
 ; serialize data
"RTN","SYNDHP41",74,0)
 S APPTDTTM=""
"RTN","SYNDHP41",75,0)
 N APPTREC
"RTN","SYNDHP41",76,0)
 S HLFCTS=DHPICN
"RTN","SYNDHP41",77,0)
 F  S APPTDTTM=$O(ZARR(DHPICN,APPTDTTM)) Q:APPTDTTM=""  D
"RTN","SYNDHP41",78,0)
 .S APPTREC=ZARR(DHPICN,APPTDTTM)
"RTN","SYNDHP41",79,0)
 .S HLFCTS=HLFCTS_U_APPTREC
"RTN","SYNDHP41",80,0)
 Q HLFCTS
"RTN","SYNDHP41",81,0)
 ;
"RTN","SYNDHP41",82,0)
 ; ----------- Unit Test -----------
"RTN","SYNDHP41",83,0)
T1 ;
"RTN","SYNDHP41",84,0)
 N ICN S ICN="1198013374V588739"
"RTN","SYNDHP41",85,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP41",86,0)
 N TODAT S TODAT=""
"RTN","SYNDHP41",87,0)
 N RETSTA
"RTN","SYNDHP41",88,0)
 D PATAPTI(.RETSTA,ICN,FRDAT,TODAT)
"RTN","SYNDHP41",89,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP41",90,0)
 QUIT
"RTN","SYNDHP41",91,0)
 ;
"RTN","SYNDHP43")
0^1^B11341406
"RTN","SYNDHP43",1,0)
SYNDHP43 ; HC/fjf/art - HealthConcourse - validate a patient's traits ;05/04/2019
"RTN","SYNDHP43",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP43",3,0)
 ;;
"RTN","SYNDHP43",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP43",5,0)
 ;
"RTN","SYNDHP43",6,0)
 QUIT
"RTN","SYNDHP43",7,0)
 ;
"RTN","SYNDHP43",8,0)
PATVAL(RETSTA,NAME,SSN,DOB,GENDER,MMDNM) ; validate patient for DHP
"RTN","SYNDHP43",9,0)
 ; 
"RTN","SYNDHP43",10,0)
 ; this API validates a patient
"RTN","SYNDHP43",11,0)
 ; all the input criteria must be satisfied for the patient to be identified as a valid patient
"RTN","SYNDHP43",12,0)
 ;
"RTN","SYNDHP43",13,0)
 ; Input:
"RTN","SYNDHP43",14,0)
 ; NAME is the patient Name                   - REQUIRED 
"RTN","SYNDHP43",15,0)
 ; SSN is the patient Social Security Number  - REQUIRED
"RTN","SYNDHP43",16,0)
 ; DOB is the patient Date of Birth           - REQUIRED
"RTN","SYNDHP43",17,0)
 ; GENDER is the patient gender               - REQUIRED
"RTN","SYNDHP43",18,0)
 ; MMDNM is the patient Mother's Maiden Name  - optional
"RTN","SYNDHP43",19,0)
 ;
"RTN","SYNDHP43",20,0)
 ; Output:
"RTN","SYNDHP43",21,0)
 ; RETSTA is the name of the return array
"RTN","SYNDHP43",22,0)
 ;   RETSTA(0)=STATUS^REASON^ICN
"RTN","SYNDHP43",23,0)
 ;             STATUS = 1 - valid match found
"RTN","SYNDHP43",24,0)
 ;             STATUS = 0 - no match found
"RTN","SYNDHP43",25,0)
 ;
"RTN","SYNDHP43",26,0)
 N SSNA,RZN,N,TX,IEN
"RTN","SYNDHP43",27,0)
 I $G(NAME)="" S RETSTA="-1^Patient Name not specified" Q
"RTN","SYNDHP43",28,0)
 I $G(SSN)="" S RETSTA="-1^Patient SSN not specified" Q
"RTN","SYNDHP43",29,0)
 I $G(DOB)="" S RETSTA="-1^Patient DOB not specified" Q
"RTN","SYNDHP43",30,0)
 I $G(GENDER)="" S RETSTA="-1^Patient Gender not specified" Q
"RTN","SYNDHP43",31,0)
 ;I $G(MMDNM)="" S RETSTA="-1^Mother's Maiden Name not specified" Q
"RTN","SYNDHP43",32,0)
 S MMDNM=$G(MMDNM)
"RTN","SYNDHP43",33,0)
 ;
"RTN","SYNDHP43",34,0)
 ; do some validation for above traits and determine if patient is valid
"RTN","SYNDHP43",35,0)
 ; 
"RTN","SYNDHP43",36,0)
 ; check to see if SSN is recognised by VistA system
"RTN","SYNDHP43",37,0)
 I '+$$SSNCHK(SSN) S RETSTA="-1^Patient SSN not recognised" Q
"RTN","SYNDHP43",38,0)
 ;
"RTN","SYNDHP43",39,0)
 ; otherwise we have at least one patient for the SSN
"RTN","SYNDHP43",40,0)
 ; check each patient for a match
"RTN","SYNDHP43",41,0)
 S N=""
"RTN","SYNDHP43",42,0)
 S RETSTA="0^Invalid patient"
"RTN","SYNDHP43",43,0)
 F  S N=$O(SSNA(N)) Q:N=""  D
"RTN","SYNDHP43",44,0)
 .S TX=SSNA(N)
"RTN","SYNDHP43",45,0)
 .S IEN=$P(TX,"^",2)
"RTN","SYNDHP43",46,0)
 .I $$NAMCHK(IEN),$$DOBCHK(IEN),$$GENCHK(IEN),$$MDNCHK(IEN) S RETSTA="1^Valid patient^"_$$ICN(IEN)
"RTN","SYNDHP43",47,0)
 I +RETSTA Q
"RTN","SYNDHP43",48,0)
 I $D(RZN) S RETSTA="-1^Invalid "_RZN Q
"RTN","SYNDHP43",49,0)
 Q
"RTN","SYNDHP43",50,0)
 ;
"RTN","SYNDHP43",51,0)
SSNCHK(SSN) ; SSN check
"RTN","SYNDHP43",52,0)
 ; find all patients that match SSN
"RTN","SYNDHP43",53,0)
 K SSNA
"RTN","SYNDHP43",54,0)
 N IEN S IEN=""
"RTN","SYNDHP43",55,0)
 F  S IEN=$O(^DPT("SSN",SSN,IEN)) Q:IEN=""  D
"RTN","SYNDHP43",56,0)
 .S SSNA(IEN)=SSN_U_IEN
"RTN","SYNDHP43",57,0)
 I '$D(SSNA) Q 0
"RTN","SYNDHP43",58,0)
 Q 1
"RTN","SYNDHP43",59,0)
 ;
"RTN","SYNDHP43",60,0)
NAMCHK(IEN) ; name check
"RTN","SYNDHP43",61,0)
 I $P(NAME," ")'=$P($$GET1^DIQ(2,IEN_",",.01,"I")," ") S RZN="patient name" Q 0
"RTN","SYNDHP43",62,0)
 Q 1
"RTN","SYNDHP43",63,0)
 ;
"RTN","SYNDHP43",64,0)
DOBCHK(IEN) ; DOB check
"RTN","SYNDHP43",65,0)
 I $$HL7TFM^XLFDT(DOB)'=$$GET1^DIQ(2,IEN_",",.03,"I") S RZN="DOB" Q 0
"RTN","SYNDHP43",66,0)
 Q 1
"RTN","SYNDHP43",67,0)
 ;
"RTN","SYNDHP43",68,0)
GENCHK(IEN) ; gender check
"RTN","SYNDHP43",69,0)
 I GENDER'=$$GET1^DIQ(2,IEN_",",.02,"I") S RZN="gender" Q 0
"RTN","SYNDHP43",70,0)
 Q 1
"RTN","SYNDHP43",71,0)
 ;
"RTN","SYNDHP43",72,0)
MDNCHK(IEN) ; mother's maiden name check
"RTN","SYNDHP43",73,0)
 Q:MMDNM="" 1
"RTN","SYNDHP43",74,0)
 I MMDNM'=$P($$GET1^DIQ(2,IEN_",",.2403),",") S RZN="mother maiden name" Q 0
"RTN","SYNDHP43",75,0)
 Q 1
"RTN","SYNDHP43",76,0)
 ;
"RTN","SYNDHP43",77,0)
ICN(IEN) ; obtain ICN
"RTN","SYNDHP43",78,0)
 N ICN
"RTN","SYNDHP43",79,0)
 S ICN=$$GET1^DIQ(2,IEN_",",991.1)
"RTN","SYNDHP43",80,0)
 I ICN="" D
"RTN","SYNDHP43",81,0)
 . S ICN=$$GET1^DIQ(2,IEN_",",991.01)_"V"_$$GET1^DIQ(2,IEN_",",991.02)
"RTN","SYNDHP43",82,0)
 Q ICN
"RTN","SYNDHP43",83,0)
 ;
"RTN","SYNDHP43",84,0)
TESTP ;
"RTN","SYNDHP43",85,0)
 D PATVAL(.RETSTA,"ZERO,PATIENT",666000000,19350505,"M","SCHMIDT")
"RTN","SYNDHP43",86,0)
 Q
"RTN","SYNDHP43",87,0)
 ;
"RTN","SYNDHP43",88,0)
TESTF1 ; SSN fail
"RTN","SYNDHP43",89,0)
 D PATVAL(.RETSTA,"ZERO,PATIENT",566000000,19350505,"M","SCHMIDT")
"RTN","SYNDHP43",90,0)
 Q
"RTN","SYNDHP43",91,0)
 ;
"RTN","SYNDHP43",92,0)
TESTF2 ; name fail
"RTN","SYNDHP43",93,0)
 D PATVAL(.RETSTA,"FRAUNOFER,PATIENT",666000000,19350505,"M","SCHMIDT")
"RTN","SYNDHP43",94,0)
 Q
"RTN","SYNDHP43",95,0)
 ;
"RTN","SYNDHP43",96,0)
TESTF3 ; DOB fail
"RTN","SYNDHP43",97,0)
 D PATVAL(.RETSTA,"ZERO,PATIENT",666000000,19270928,"M","SCHMIDT")
"RTN","SYNDHP43",98,0)
 Q
"RTN","SYNDHP43",99,0)
 ;
"RTN","SYNDHP43",100,0)
TESTF4 ; gender fail
"RTN","SYNDHP43",101,0)
 D PATVAL(.RETSTA,"ZERO,PATIENT",666000000,19350505,"F","SCHMIDT")
"RTN","SYNDHP43",102,0)
 Q
"RTN","SYNDHP43",103,0)
 ;
"RTN","SYNDHP43",104,0)
TESTF5 ; mother's maiden name fail
"RTN","SYNDHP43",105,0)
 D PATVAL(.RETSTA,"ZERO,PATIENT",666000000,19350505,"M","SCHROEDINGER")
"RTN","SYNDHP43",106,0)
 Q
"RTN","SYNDHP43",107,0)
 ;
"RTN","SYNDHP43",108,0)
T3 ;
"RTN","SYNDHP43",109,0)
 S NAME="COPD,PATIENT MALE"
"RTN","SYNDHP43",110,0)
 S SSN=666111957
"RTN","SYNDHP43",111,0)
 S DOB=19800530
"RTN","SYNDHP43",112,0)
 S GENDER="M"
"RTN","SYNDHP43",113,0)
 N RETSTA
"RTN","SYNDHP43",114,0)
 D PATVAL(.RETSTA,NAME,SSN,DOB,GENDER) 
"RTN","SYNDHP43",115,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP43",116,0)
 QUIT
"RTN","SYNDHP43",117,0)
 ;
"RTN","SYNDHP47")
0^2^B42834722
"RTN","SYNDHP47",1,0)
SYNDHP47 ; HC/fjf/art - HealthConcourse - retrieve patient demographics ;05/07/2019
"RTN","SYNDHP47",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP47",3,0)
 ;;
"RTN","SYNDHP47",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP47",5,0)
 ;
"RTN","SYNDHP47",6,0)
 QUIT
"RTN","SYNDHP47",7,0)
 ;
"RTN","SYNDHP47",8,0)
 ; ----------------  Get Patient Demographics  ----------------------  
"RTN","SYNDHP47",9,0)
 ;
"RTN","SYNDHP47",10,0)
PATDEM(RETSTA,NAME,SSN,DOB,GENDER,RETJSON) ; get demographics for a patient by traits
"RTN","SYNDHP47",11,0)
 S RETSTA="-1^This service has been retired"
"RTN","SYNDHP47",12,0)
 QUIT
"RTN","SYNDHP47",13,0)
 ; Return patient demographics for name, SSN, DOB, and gender
"RTN","SYNDHP47",14,0)
 ;
"RTN","SYNDHP47",15,0)
 ; Input:
"RTN","SYNDHP47",16,0)
 ;   NAME    - patient name
"RTN","SYNDHP47",17,0)
 ;   SSN     - social security number
"RTN","SYNDHP47",18,0)
 ;   DOB     - date of birth
"RTN","SYNDHP47",19,0)
 ;   GENDER  - gender
"RTN","SYNDHP47",20,0)
 ;   RETJSON - J = Return JSON
"RTN","SYNDHP47",21,0)
 ;             F = Return FHIR
"RTN","SYNDHP47",22,0)
 ;             0 or null = Return patient demographics string (default)
"RTN","SYNDHP47",23,0)
 ; Output:
"RTN","SYNDHP47",24,0)
 ;   RETSTA  - a delimited string that has the following
"RTN","SYNDHP47",25,0)
 ;             ICN^Name^Phone Number^Gender^Date of Birth^Address1,Address2,Address3,^City^State^ZIP^resID
"RTN","SYNDHP47",26,0)
 ;          or patient demographics in JSON format
"RTN","SYNDHP47",27,0)
 ;
"RTN","SYNDHP47",28,0)
 ; validate patient
"RTN","SYNDHP47",29,0)
 N ICNST
"RTN","SYNDHP47",30,0)
 D PATVAL^SYNDHP43(.ICNST,NAME,SSN,DOB,GENDER)
"RTN","SYNDHP47",31,0)
 I +ICNST'=1 S RETSTA=ICNST QUIT
"RTN","SYNDHP47",32,0)
 S DHPICN=$P(ICNST,U,3)
"RTN","SYNDHP47",33,0)
 ; get patient IEN from ICN
"RTN","SYNDHP47",34,0)
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP47",35,0)
 ;
"RTN","SYNDHP47",36,0)
 ; get patient demographics
"RTN","SYNDHP47",37,0)
 N PATARRAY
"RTN","SYNDHP47",38,0)
 S RETSTA=$$GETPATS(.PATARRAY,PATIEN)
"RTN","SYNDHP47",39,0)
 ;
"RTN","SYNDHP47",40,0)
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
"RTN","SYNDHP47",41,0)
 ;
"RTN","SYNDHP47",42,0)
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
"RTN","SYNDHP47",43,0)
 . S RETSTA=""
"RTN","SYNDHP47",44,0)
 . D TOJASON^SYNDHPUTL(.PATARRAY,.RETSTA)
"RTN","SYNDHP47",45,0)
 ;
"RTN","SYNDHP47",46,0)
 QUIT
"RTN","SYNDHP47",47,0)
 ;
"RTN","SYNDHP47",48,0)
 ; ----------------  Get Patient Demographics  ----------------------  
"RTN","SYNDHP47",49,0)
 ;
"RTN","SYNDHP47",50,0)
PATDEMI(RETSTA,DHPICN,RETJSON) ; get demographics for patient by ICN
"RTN","SYNDHP47",51,0)
 ; 
"RTN","SYNDHP47",52,0)
 ; Return patient demographics for given patient ICN
"RTN","SYNDHP47",53,0)
 ; 
"RTN","SYNDHP47",54,0)
 ; Input:
"RTN","SYNDHP47",55,0)
 ;   ICN     - unique patient identifier across all VistA systems
"RTN","SYNDHP47",56,0)
 ;   RETJSON - J = Return JSON
"RTN","SYNDHP47",57,0)
 ;             F = Return FHIR
"RTN","SYNDHP47",58,0)
 ;             0 or null = Return patient demographics string (default)
"RTN","SYNDHP47",59,0)
 ; Output:
"RTN","SYNDHP47",60,0)
 ;   RETSTA  - a delimited string that has the following
"RTN","SYNDHP47",61,0)
 ;             ICN^Name^Phone Number^Gender^Date of Birth^Address1,Address2,Address3,^City^State^ZIP^resID
"RTN","SYNDHP47",62,0)
 ;          or patient demographics in JSON format
"RTN","SYNDHP47",63,0)
 ;
"RTN","SYNDHP47",64,0)
 ; validate ICN
"RTN","SYNDHP47",65,0)
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
"RTN","SYNDHP47",66,0)
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" QUIT
"RTN","SYNDHP47",67,0)
 ; get patient IEN from ICN
"RTN","SYNDHP47",68,0)
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP47",69,0)
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
"RTN","SYNDHP47",70,0)
 ;
"RTN","SYNDHP47",71,0)
 ; get patient demographics
"RTN","SYNDHP47",72,0)
 N PATARRAY
"RTN","SYNDHP47",73,0)
 S RETSTA=$$GETPATS(.PATARRAY,PATIEN)
"RTN","SYNDHP47",74,0)
 ;
"RTN","SYNDHP47",75,0)
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
"RTN","SYNDHP47",76,0)
 ;
"RTN","SYNDHP47",77,0)
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
"RTN","SYNDHP47",78,0)
 . S RETSTA=""
"RTN","SYNDHP47",79,0)
 . D TOJASON^SYNDHPUTL(.PATARRAY,.RETSTA)
"RTN","SYNDHP47",80,0)
 ;
"RTN","SYNDHP47",81,0)
 QUIT
"RTN","SYNDHP47",82,0)
 ; 
"RTN","SYNDHP47",83,0)
GETPATS(PATARRAY,PATIEN) ; get demographics for patient
"RTN","SYNDHP47",84,0)
 ; 
"RTN","SYNDHP47",85,0)
 N C,S,RESID,NAME,PHONE,SEX,DOB,ADRS1,ADRS2,ADRS3,CITY,STATE,ZIP,ICN
"RTN","SYNDHP47",86,0)
 S C=","
"RTN","SYNDHP47",87,0)
 S S="_"
"RTN","SYNDHP47",88,0)
 ;
"RTN","SYNDHP47",89,0)
 N PATIENT
"RTN","SYNDHP47",90,0)
 D GETPATIENT^SYNDHP20(.PATIENT,PATIEN,0,"")
"RTN","SYNDHP47",91,0)
 I $D(PATIENT("Patient","ERROR")) QUIT "-1^error reading patient file"
"RTN","SYNDHP47",92,0)
 S RESID=PATIENT("Patient","resourceId")
"RTN","SYNDHP47",93,0)
 S NAME=PATIENT("Patient","name")
"RTN","SYNDHP47",94,0)
 S PHONE=PATIENT("Patient","phoneNumberResidence")
"RTN","SYNDHP47",95,0)
 S SEX=PATIENT("Patient","sex")
"RTN","SYNDHP47",96,0)
 S DOB=PATIENT("Patient","dateOfBirthHL7")
"RTN","SYNDHP47",97,0)
 S ADRS1=PATIENT("Patient","streetAddressLine1")
"RTN","SYNDHP47",98,0)
 S ADRS2=PATIENT("Patient","streetAddressLine2")
"RTN","SYNDHP47",99,0)
 S ADRS3=PATIENT("Patient","streetAddressLine3")
"RTN","SYNDHP47",100,0)
 S CITY=PATIENT("Patient","city")
"RTN","SYNDHP47",101,0)
 S STATE=PATIENT("Patient","state")
"RTN","SYNDHP47",102,0)
 S ZIP=PATIENT("Patient","zipCode")
"RTN","SYNDHP47",103,0)
 S ICN=PATIENT("Patient","fullICN")
"RTN","SYNDHP47",104,0)
 S PATSTR=ICN_U_NAME_U_PHONE_U_SEX_U_DOB_U_ADRS1_C_ADRS2_C_ADRS3_C_U_CITY_U_STATE_U_ZIP_U_RESID
"RTN","SYNDHP47",105,0)
 M PATARRAY("Patients",PATIEN)=PATIENT
"RTN","SYNDHP47",106,0)
 ;
"RTN","SYNDHP47",107,0)
 QUIT PATSTR
"RTN","SYNDHP47",108,0)
 ; 
"RTN","SYNDHP47",109,0)
PATDEMAL(RETSTA,DHPICN,RETJSON) ; get demographics for all patients
"RTN","SYNDHP47",110,0)
 ; 
"RTN","SYNDHP47",111,0)
 ; Return patient demographics for all patients
"RTN","SYNDHP47",112,0)
 ; 
"RTN","SYNDHP47",113,0)
 ; Input:
"RTN","SYNDHP47",114,0)
 ;   DHPICN - "ALL"
"RTN","SYNDHP47",115,0)
 ;   RETJSON - J = Return JSON (JSON is not currently supported for this call)
"RTN","SYNDHP47",116,0)
 ;             F = Return FHIR
"RTN","SYNDHP47",117,0)
 ;             0 or null = Return patient demographics string (default)
"RTN","SYNDHP47",118,0)
 ; Output:
"RTN","SYNDHP47",119,0)
 ;   RETSTA  - a delimited string that has the following data elements for each patient
"RTN","SYNDHP47",120,0)
 ;             ICN^Name^Phone Number^Gender^Date of Birth^Address1,Address2,Address3,^City^State^ZIP^resID|...
"RTN","SYNDHP47",121,0)
 ;             data for each patient is separated by "|"
"RTN","SYNDHP47",122,0)
 ;          or patient demographics in JSON format
"RTN","SYNDHP47",123,0)
 ;
"RTN","SYNDHP47",124,0)
 I $G(DHPICN)'="ALL" S RETSTA="-1^please specify ICN=ALL" QUIT
"RTN","SYNDHP47",125,0)
 I ($G(RETJSON)="J"!($G(RETJSON)="F")) S RETSTA="-1^JSON for all patients is currently not supported" QUIT
"RTN","SYNDHP47",126,0)
 ;
"RTN","SYNDHP47",127,0)
 N C,S,CT
"RTN","SYNDHP47",128,0)
 S C=","
"RTN","SYNDHP47",129,0)
 S S="_"
"RTN","SYNDHP47",130,0)
 S CT=0
"RTN","SYNDHP47",131,0)
 K ^TMP("DHPPATALL",$J)
"RTN","SYNDHP47",132,0)
 S ^TMP("DHPPATALL",$J)=""
"RTN","SYNDHP47",133,0)
 K ^SYNDHPTMP("DHPCOUNT")
"RTN","SYNDHP47",134,0)
 ;
"RTN","SYNDHP47",135,0)
 N PATARRAY,PATSTR
"RTN","SYNDHP47",136,0)
 N PATIEN S PATIEN=0
"RTN","SYNDHP47",137,0)
 F  S PATIEN=$O(^DPT(PATIEN)) Q:+PATIEN=0  D
"RTN","SYNDHP47",138,0)
 .S PATSTR=$$GETPATS(.PATARRAY,PATIEN)
"RTN","SYNDHP47",139,0)
 .S ^TMP("DHPPATALL",$J)=^TMP("DHPPATALL",$J)_PATSTR_"|"
"RTN","SYNDHP47",140,0)
 .S CT=CT+1
"RTN","SYNDHP47",141,0)
 .S ^SYNDHPTMP("DHPCOUNT",$J,CT)=PATSTR
"RTN","SYNDHP47",142,0)
 S RETSTA=^TMP("DHPPATALL",$J)
"RTN","SYNDHP47",143,0)
 ;
"RTN","SYNDHP47",144,0)
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
"RTN","SYNDHP47",145,0)
 ;
"RTN","SYNDHP47",146,0)
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
"RTN","SYNDHP47",147,0)
 . S RETSTA=""
"RTN","SYNDHP47",148,0)
 . D TOJASON^SYNDHPUTL(.PATARRAY,.RETSTA)
"RTN","SYNDHP47",149,0)
 ;
"RTN","SYNDHP47",150,0)
 Q
"RTN","SYNDHP47",151,0)
 ;
"RTN","SYNDHP47",152,0)
PATDEMRNG(RETSTA,DHPPATS,RETJSON) ; get demographics for range of patients
"RTN","SYNDHP47",153,0)
 ; 
"RTN","SYNDHP47",154,0)
 ; Return patient demographics for a range of patients
"RTN","SYNDHP47",155,0)
 ; 
"RTN","SYNDHP47",156,0)
 ; Input:
"RTN","SYNDHP47",157,0)
 ;   DHPPATS - mmmmRnnnn where nnnn and mmmm are patient DFNs, mmmm<nnnn (limited 1000 patients for JSON)
"RTN","SYNDHP47",158,0)
 ;   RETJSON - J = Return JSON
"RTN","SYNDHP47",159,0)
 ;             F = Return FHIR
"RTN","SYNDHP47",160,0)
 ;             0 or null = Return patient demographics string (default)
"RTN","SYNDHP47",161,0)
 ; Output:
"RTN","SYNDHP47",162,0)
 ;   RETSTA  - a delimited string that has the following
"RTN","SYNDHP47",163,0)
 ;             ICN^Name^Phone Number^Gender^Date of Birth^Address1,Address2,Address3,^City^State^ZIP^resID|...
"RTN","SYNDHP47",164,0)
 ;          or patient demographics in JSON format
"RTN","SYNDHP47",165,0)
 ;
"RTN","SYNDHP47",166,0)
 ;
"RTN","SYNDHP47",167,0)
 N C,M,S,SOR,EOR,N,NOPATS,FPATIEN,PTNTS,DHPICN,PATSTR,I,RESID
"RTN","SYNDHP47",168,0)
 S C=",",M="R"
"RTN","SYNDHP47",169,0)
 S S="_"
"RTN","SYNDHP47",170,0)
 N SITE S SITE=$P($$SITE^VASITE,U,3)
"RTN","SYNDHP47",171,0)
 ;
"RTN","SYNDHP47",172,0)
 S CT=0
"RTN","SYNDHP47",173,0)
 K ^TMP("DHPPATRNG",$J) S ^TMP("DHPPATRNG",$J)=""
"RTN","SYNDHP47",174,0)
 K ^SYNDHPTMP("DHPCOUNT")
"RTN","SYNDHP47",175,0)
 N PATARRAY
"RTN","SYNDHP47",176,0)
 ;
"RTN","SYNDHP47",177,0)
 I DHPPATS'?1.N1"R"1.N S RETSTA="-1^Invalid range format" QUIT
"RTN","SYNDHP47",178,0)
 S SOR=$P(DHPPATS,M),EOR=$P(DHPPATS,M,2)
"RTN","SYNDHP47",179,0)
 I EOR<SOR S RETSTA="-1^End before beginning" QUIT
"RTN","SYNDHP47",180,0)
 S NOPATS=EOR-SOR+1
"RTN","SYNDHP47",181,0)
 I ($G(RETJSON)="J"!($G(RETJSON)="F")),NOPATS>1000 S RETSTA="-1^please limit JSON request to 1000 patients" QUIT
"RTN","SYNDHP47",182,0)
 ; find first patient IEN
"RTN","SYNDHP47",183,0)
 S PATIEN=SOR-1
"RTN","SYNDHP47",184,0)
 F  S PATIEN=$O(^DPT(PATIEN)) QUIT:(PATIEN>EOR)!(+PATIEN=0)  D
"RTN","SYNDHP47",185,0)
 .;W !,PATIEN
"RTN","SYNDHP47",186,0)
 .;Q
"RTN","SYNDHP47",187,0)
 .S PATSTR=$$GETPATS(.PATARRAY,PATIEN)
"RTN","SYNDHP47",188,0)
 .S ^TMP("DHPPATRNG",$J)=^TMP("DHPPATRNG",$J)_PATSTR_"|"
"RTN","SYNDHP47",189,0)
 .S CT=CT+1
"RTN","SYNDHP47",190,0)
 .S ^SYNDHPTMP("DHPCOUNT",$J,CT)=PATSTR
"RTN","SYNDHP47",191,0)
 S RETSTA=^TMP("DHPPATRNG",$J)
"RTN","SYNDHP47",192,0)
 ;
"RTN","SYNDHP47",193,0)
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
"RTN","SYNDHP47",194,0)
 ;
"RTN","SYNDHP47",195,0)
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
"RTN","SYNDHP47",196,0)
 . S RETSTA=""
"RTN","SYNDHP47",197,0)
 . D TOJASON^SYNDHPUTL(.PATARRAY,.RETSTA)
"RTN","SYNDHP47",198,0)
 ;
"RTN","SYNDHP47",199,0)
 Q
"RTN","SYNDHP47",200,0)
 ;
"RTN","SYNDHP47",201,0)
 ; ----------- Unit Test -----------
"RTN","SYNDHP47",202,0)
T1 ;
"RTN","SYNDHP47",203,0)
 N ICN S ICN="1034989029V875306"
"RTN","SYNDHP47",204,0)
 N JSON S JSON=""
"RTN","SYNDHP47",205,0)
 N RETSTA
"RTN","SYNDHP47",206,0)
 D PATDEMI(.RETSTA,ICN,JSON)
"RTN","SYNDHP47",207,0)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
"RTN","SYNDHP47",208,0)
 QUIT
"RTN","SYNDHP47",209,0)
 ;
"RTN","SYNDHP47",210,0)
T2 ;
"RTN","SYNDHP47",211,0)
 N ICN S ICN="1034989029V875306"
"RTN","SYNDHP47",212,0)
 N JSON S JSON="J"
"RTN","SYNDHP47",213,0)
 N RETSTA
"RTN","SYNDHP47",214,0)
 D PATDEMI(.RETSTA,ICN,JSON)
"RTN","SYNDHP47",215,0)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
"RTN","SYNDHP47",216,0)
 QUIT
"RTN","SYNDHP47",217,0)
 ;
"RTN","SYNDHP47",218,0)
T3 ;
"RTN","SYNDHP47",219,0)
 N RANGE S RANGE="10R15"
"RTN","SYNDHP47",220,0)
 N JSON S JSON=""
"RTN","SYNDHP47",221,0)
 N RETSTA
"RTN","SYNDHP47",222,0)
 D PATDEMRNG(.RETSTA,RANGE,JSON)
"RTN","SYNDHP47",223,0)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
"RTN","SYNDHP47",224,0)
 QUIT
"RTN","SYNDHP47",225,0)
 ;
"RTN","SYNDHP47",226,0)
T4 ;
"RTN","SYNDHP47",227,0)
 N RANGE S RANGE="10R15"
"RTN","SYNDHP47",228,0)
 N JSON S JSON="J"
"RTN","SYNDHP47",229,0)
 N RETSTA
"RTN","SYNDHP47",230,0)
 D PATDEMRNG(.RETSTA,RANGE,JSON)
"RTN","SYNDHP47",231,0)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
"RTN","SYNDHP47",232,0)
 QUIT
"RTN","SYNDHP47",233,0)
 ;
"RTN","SYNDHP47",234,0)
T5 ;
"RTN","SYNDHP47",235,0)
 N ICN S ICN="ALL"
"RTN","SYNDHP47",236,0)
 N JSON S JSON=""
"RTN","SYNDHP47",237,0)
 N RETSTA
"RTN","SYNDHP47",238,0)
 D PATDEMAL(.RETSTA,ICN,JSON)
"RTN","SYNDHP47",239,0)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
"RTN","SYNDHP47",240,0)
 QUIT
"RTN","SYNDHP47",241,0)
 ;
"RTN","SYNDHP47",242,0)
TESTS ;
"RTN","SYNDHP47",243,0)
DEMTEST0 ; pass
"RTN","SYNDHP47",244,0)
 D PATDEM(.RETSTA,"HYPERTENSION,PATIENT FEMALE",666111938,19280913,"F")
"RTN","SYNDHP47",245,0)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
"RTN","SYNDHP47",246,0)
 Q
"RTN","SYNDHP48")
0^3^B113334144
"RTN","SYNDHP48",1,0)
SYNDHP48 ; HC/PWC/art - HealthConcourse - retrieve patient medication data ;05/07/2019
"RTN","SYNDHP48",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP48",3,0)
 ;;
"RTN","SYNDHP48",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP48",5,0)
 ;
"RTN","SYNDHP48",6,0)
 Q
"RTN","SYNDHP48",7,0)
 ;
"RTN","SYNDHP48",8,0)
 ; ---------------- Get patient medication statement ----------------------------
"RTN","SYNDHP48",9,0)
PATMEDS(RETSTA,DHPICN,FRDAT,TODAT) ; Patient medication statement for ICN
"RTN","SYNDHP48",10,0)
 ;
"RTN","SYNDHP48",11,0)
 ; Return patient medication statement for a given patient ICN
"RTN","SYNDHP48",12,0)
 ;
"RTN","SYNDHP48",13,0)
 ; Input:
"RTN","SYNDHP48",14,0)
 ;   ICN     - unique patient identifier across all VistA systems
"RTN","SYNDHP48",15,0)
 ;   FRDAT   - from date (inclusive), optional
"RTN","SYNDHP48",16,0)
 ;   TODAT   - to date (inclusive), optional
"RTN","SYNDHP48",17,0)
 ; Output:
"RTN","SYNDHP48",18,0)
 ;   RETSTA  - a delimited string that lists the following information
"RTN","SYNDHP48",19,0)
 ;      PatientICN ^ RESOURSE ID ^ STATUS ^ MEDICATION ^ DATE ASSERTED ^ CONDITION
"RTN","SYNDHP48",20,0)
 ;      ^ DOSAGE , SITE ; ROUTE ; DOSE ^ QUANTITY ^ DAYS ^ RXN |
"RTN","SYNDHP48",21,0)
 ;
"RTN","SYNDHP48",22,0)
 ;   Identifier will be "V"_SITE ID_"_"_FILEMAN #_"_"_FILE IEN   i.e. V_500_55_930
"RTN","SYNDHP48",23,0)
 ;
"RTN","SYNDHP48",24,0)
 ; validate ICN
"RTN","SYNDHP48",25,0)
STM ;
"RTN","SYNDHP48",26,0)
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
"RTN","SYNDHP48",27,0)
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" Q
"RTN","SYNDHP48",28,0)
 ;
"RTN","SYNDHP48",29,0)
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
"RTN","SYNDHP48",30,0)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
"RTN","SYNDHP48",31,0)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
"RTN","SYNDHP48",32,0)
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
"RTN","SYNDHP48",33,0)
 ;
"RTN","SYNDHP48",34,0)
 N C,ACU,P,S,UL,D1,IDENT,ORDDAT,ORDNUM,ROUTE,STATUS,DOSORD,STDT,STDTFM,DRUG,SITE,SITEA
"RTN","SYNDHP48",35,0)
 N RETDESC,QTY,DAYS,RXN,IENS,IDATE,IDATEFM,RX,PATIEN,DRUGI
"RTN","SYNDHP48",36,0)
 S C=",",P="|",S=";",UL="_"
"RTN","SYNDHP48",37,0)
 ; get patient IEN from ICN
"RTN","SYNDHP48",38,0)
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP48",39,0)
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
"RTN","SYNDHP48",40,0)
 ;
"RTN","SYNDHP48",41,0)
 S RETDESC=""
"RTN","SYNDHP48",42,0)
 S SITE=$P($$SITE^VASITE,U,3)
"RTN","SYNDHP48",43,0)
 S RETSTA=""
"RTN","SYNDHP48",44,0)
 ; loop through the PHARMACY PATIENT file #55 (^PS(55)) for patient (this will contain both IP and OP orders)
"RTN","SYNDHP48",45,0)
 ;
"RTN","SYNDHP48",46,0)
 ; this is start of Inpatient Orders
"RTN","SYNDHP48",47,0)
 S D1=0
"RTN","SYNDHP48",48,0)
 F  S D1=$O(^PS(55,PATIEN,5,D1)) Q:D1'?1N.N  D
"RTN","SYNDHP48",49,0)
 .S IENS=D1_C_PATIEN_C
"RTN","SYNDHP48",50,0)
 .S (ORDDAT,ORDNUM,ROUTE,STATUS,DOSORD,STDT,STDTFM,DRUG,SITEA,QTY,DAYS,RXN)=""
"RTN","SYNDHP48",51,0)
 .N MEDX,MEDERR
"RTN","SYNDHP48",52,0)
 .D GETS^DIQ(55.06,IENS,".01;3;10;28","IEN","MEDX","MEDERR")
"RTN","SYNDHP48",53,0)
 .QUIT:$D(MEDERR)
"RTN","SYNDHP48",54,0)
 .S ORDNUM=$G(MEDX(55.06,IENS,.01,"E"))   ; order number
"RTN","SYNDHP48",55,0)
 .; route is most likely not stored in vista as SCT code, but should check this
"RTN","SYNDHP48",56,0)
 .S ROUTE=$G(MEDX(55.06,IENS,3,"E"))      ; route
"RTN","SYNDHP48",57,0)
 .S STATUS=$G(MEDX(55.06,IENS,28,"E"))    ; status
"RTN","SYNDHP48",58,0)
 .S DOSORD=$P($G(^PS(55,PATIEN,5,D1,.2)),U,2)          ; dosage ordered
"RTN","SYNDHP48",59,0)
 .S STDTFM=$G(MEDX(55.06,IENS,10,"I"))      ; start date
"RTN","SYNDHP48",60,0)
 .QUIT:((STDTFM\1)<FRDAT)!((STDTFM\1)>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP48",61,0)
 .S STDT=$$FMTHL7^XLFDT($G(MEDX(55.06,IENS,10,"I")))      ; start date
"RTN","SYNDHP48",62,0)
 .S DRUG=$$GET1^DIQ(55.07,1_C_IENS,.01,"E")  ; medication
"RTN","SYNDHP48",63,0)
 .S DRUGI=$$GET1^DIQ(55.07,1_C_IENS,.01,"I")
"RTN","SYNDHP48",64,0)
 .S RXN=$$GETRXN(DRUGI)
"RTN","SYNDHP48",65,0)
 .I RXN?1.N S RXN="RXN"_RXN
"RTN","SYNDHP48",66,0)
 .S IDENT=$$RESID^SYNDHP69("V",SITE)_UL_55_UL_PATIEN_UL_55.06_UL_D1
"RTN","SYNDHP48",67,0)
 .S RETDESC=RETDESC_$G(IDENT)_U_$G(STATUS)_U_$G(DRUG)_U_$G(STDT)_U_"REASON"_U_$G(SITEA)_S_$G(ROUTE)_S_$G(DOSORD)_U_$G(QTY)_U_$G(DAYS)_U_$G(RXN)_P
"RTN","SYNDHP48",68,0)
 ;
"RTN","SYNDHP48",69,0)
 ; start here for outpatient orders
"RTN","SYNDHP48",70,0)
 S D1=0
"RTN","SYNDHP48",71,0)
 F  S D1=$O(^PS(55,PATIEN,"P",D1)) Q:D1'?1N.N  D
"RTN","SYNDHP48",72,0)
 . S RX=$G(^PS(55,PATIEN,"P",D1,0))
"RTN","SYNDHP48",73,0)
 . S (IDENT,IDATE,DRUG,QTY,DAYS,STATUS,ROUTE,RXN)=""
"RTN","SYNDHP48",74,0)
 . N MEDX,MEDERR
"RTN","SYNDHP48",75,0)
 . D GETS^DIQ(52,RX_",",".01;1;2;6;7;8;100","IEN","MEDX","MEDERR")
"RTN","SYNDHP48",76,0)
 . QUIT:$D(MEDERR)
"RTN","SYNDHP48",77,0)
 . S IDENT=$$RESID^SYNDHP69("V",SITE)_UL_52_UL_RX
"RTN","SYNDHP48",78,0)
 . S IDATEFM=$G(MEDX(52,RX_",",1,"I"))     ;issue date
"RTN","SYNDHP48",79,0)
 . QUIT:((IDATEFM\1)<FRDAT)!((IDATEFM\1)>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP48",80,0)
 . S IDATE=$$FMTHL7^XLFDT($G(MEDX(52,RX_",",1,"I")))     ;issue date HL7
"RTN","SYNDHP48",81,0)
 . S DRUG=$G(MEDX(52,RX_",",6,"E"))      ;medication
"RTN","SYNDHP48",82,0)
 . S DRUGI=$G(MEDX(52,RX_",",6,"I"))
"RTN","SYNDHP48",83,0)
 . S RXN=$$GETRXN(DRUGI)
"RTN","SYNDHP48",84,0)
 . I RXN?1.N S RXN="RXN"_RXN
"RTN","SYNDHP48",85,0)
 . S QTY=$G(MEDX(52,RX_",",7,"E"))       ;quantity
"RTN","SYNDHP48",86,0)
 . S DAYS=$G(MEDX(52,RX_",",8,"E"))      ;days supply
"RTN","SYNDHP48",87,0)
 . S STATUS=$G(MEDX(52,RX_",",100,"E"))  ;status
"RTN","SYNDHP48",88,0)
 . S ROUTE=$$GET1^DIQ(52.0113,"1,"_RX_",",6,"EN")  ;route
"RTN","SYNDHP48",89,0)
 . S RETDESC=RETDESC_$G(IDENT)_U_$G(STATUS)_U_$G(DRUG)_U_$G(IDATE)_U_"REASON"_U_$G(SITEA)_S_$G(ROUTE)_S_$G(DOSORD)_U_$G(QTY)_U_$G(DAYS)_U_$G(RXN)_P
"RTN","SYNDHP48",90,0)
 S RETSTA=DHPICN_U_RETDESC
"RTN","SYNDHP48",91,0)
 Q
"RTN","SYNDHP48",92,0)
 ;
"RTN","SYNDHP48",93,0)
GETRXN(X,IO) ; get RxNorm code for drug
"RTN","SYNDHP48",94,0)
 ;
"RTN","SYNDHP48",95,0)
 N NAME,F50P6IEN,VUID,NDFRT,RXNORM
"RTN","SYNDHP48",96,0)
 S NAME=$$GET1^DIQ(50,X_",",20,"E")
"RTN","SYNDHP48",97,0)
 I $G(DEBUG) W !,"name: ",NAME
"RTN","SYNDHP48",98,0)
 I NAME'="" D
"RTN","SYNDHP48",99,0)
 .S F50P6IEN=$O(^PSNDF(50.6,"B",NAME,""))
"RTN","SYNDHP48",100,0)
 .I $G(DEBUG) W !,"ien: ",F50P6IEN
"RTN","SYNDHP48",101,0)
 .S VUID=$$GET1^DIQ(50.6,F50P6IEN_",",99.99)
"RTN","SYNDHP48",102,0)
 .I $G(DEBUG) W !,"vuid: ",VUID
"RTN","SYNDHP48",103,0)
 .S NDFRT=$$graphmap^SYNGRAPH("ndfrt-map",VUID,"NDFRT")
"RTN","SYNDHP48",104,0)
 .I $G(DEBUG) W !,"ndfrt: ",NDFRT
"RTN","SYNDHP48",105,0)
 .N SCT S SCT=$$MAP^SYNDHPMP("rxn2ndf",NDFRT,"I")
"RTN","SYNDHP48",106,0)
 .I $G(DEBUG) W !,"sct: ",SCT
"RTN","SYNDHP48",107,0)
 .S RXNORM=$S(+SCT=-1:$P(SCT,U,2),1:$P(SCT,U,2))
"RTN","SYNDHP48",108,0)
 .I $G(DEBUG) W !,"rxnorm: ",RXNORM
"RTN","SYNDHP48",109,0)
 I NAME="" S RXNORM="^missing VistA data"
"RTN","SYNDHP48",110,0)
 I $G(DEBUG) W !,"rxnorm: ",RXNORM,!
"RTN","SYNDHP48",111,0)
 Q RXNORM
"RTN","SYNDHP48",112,0)
 ;I NAME="" S NAME=$$GET1^DIQ(50,X_",",26,"E")
"RTN","SYNDHP48",113,0)
 ;
"RTN","SYNDHP48",114,0)
 ; ---------------- Get patient medication administration ----------------------------
"RTN","SYNDHP48",115,0)
PATMEDA(RETSTA,DHPICN,FRDAT,TODAT) ; Patient medication administration for ICN
"RTN","SYNDHP48",116,0)
 ;
"RTN","SYNDHP48",117,0)
 ; Return patient medication administration for a given patient ICN
"RTN","SYNDHP48",118,0)
 ;
"RTN","SYNDHP48",119,0)
 ; Input:
"RTN","SYNDHP48",120,0)
 ;   ICN     - unique patient identifier across all VistA systems
"RTN","SYNDHP48",121,0)
 ;   FRDAT   - from date (inclusive), optional
"RTN","SYNDHP48",122,0)
 ;   TODAT   - to date (inclusive), optional
"RTN","SYNDHP48",123,0)
 ; Output:
"RTN","SYNDHP48",124,0)
 ;   RETSTA  - a delimited string that lists the following information
"RTN","SYNDHP48",125,0)
 ;      PatientICN ^ RESOURSE ID ^ STATUS ^ MEDICATION ^ DATE ASSERTED ^ CONDITION
"RTN","SYNDHP48",126,0)
 ;      ^ DOSAGE , SITE ; ROUTE ; DOSE ^ QUANTITY ^ DAYS ^ RXN |
"RTN","SYNDHP48",127,0)
 ;
"RTN","SYNDHP48",128,0)
 ;   Identifier will be "V"_SITE ID_"_"_FILEMAN #_"_"_FILE IEN   i.e. V_500_55_930
"RTN","SYNDHP48",129,0)
 ;
"RTN","SYNDHP48",130,0)
 ; validate ICN
"RTN","SYNDHP48",131,0)
STA ;
"RTN","SYNDHP48",132,0)
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
"RTN","SYNDHP48",133,0)
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" Q
"RTN","SYNDHP48",134,0)
 ;
"RTN","SYNDHP48",135,0)
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
"RTN","SYNDHP48",136,0)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
"RTN","SYNDHP48",137,0)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
"RTN","SYNDHP48",138,0)
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
"RTN","SYNDHP48",139,0)
 ;
"RTN","SYNDHP48",140,0)
 N C,ACU,P,S,UL,D1,IDENT,ORDDAT,ORDNUM,ROUTE,STATUS,DOSORD,STDT,STDTFM,DRUG,SITE ;,IENS
"RTN","SYNDHP48",141,0)
 N RETDESC,SITEA,QTY,DAYS,RXN,IDATE,IDATEFM,PATIEN,DRUGI,RX
"RTN","SYNDHP48",142,0)
 S C=",",P="|",S=";",UL="_"
"RTN","SYNDHP48",143,0)
 ; get patient IEN from ICN
"RTN","SYNDHP48",144,0)
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP48",145,0)
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
"RTN","SYNDHP48",146,0)
 ;
"RTN","SYNDHP48",147,0)
 S RETDESC=""
"RTN","SYNDHP48",148,0)
 S SITE=$P($$SITE^VASITE,U,3)
"RTN","SYNDHP48",149,0)
 S RETSTA=""
"RTN","SYNDHP48",150,0)
 ; loop through the PHARMACY PATIENT file #55 (^PS(55)) for patient (this will contain both IP and OP orders)
"RTN","SYNDHP48",151,0)
 ;
"RTN","SYNDHP48",152,0)
 ; this is start of Inpatient Orders
"RTN","SYNDHP48",153,0)
 S D1=0
"RTN","SYNDHP48",154,0)
 F  S D1=$O(^PS(55,PATIEN,5,D1)) Q:D1'?1N.N  D
"RTN","SYNDHP48",155,0)
 .S IENS=D1_C_PATIEN_C
"RTN","SYNDHP48",156,0)
 .S (ORDDAT,ORDNUM,ROUTE,STATUS,DOSORD,STDT,STDTFM,DRUG,SITEA,QTY,DAYS,RXN)=""
"RTN","SYNDHP48",157,0)
 .N MEDX,MEDERR
"RTN","SYNDHP48",158,0)
 .D GETS^DIQ(55.06,IENS,".01;3;10;28","IEN","MEDX","MEDERR")
"RTN","SYNDHP48",159,0)
 .QUIT:$D(MEDERR)
"RTN","SYNDHP48",160,0)
 .S ORDNUM=$G(MEDX(55.06,IENS,.01,"E"))   ; order number
"RTN","SYNDHP48",161,0)
 .; route is most likely not stored in vista as SCT code, but should check this
"RTN","SYNDHP48",162,0)
 .S ROUTE=$G(MEDX(55.06,IENS,3,"E"))      ; route
"RTN","SYNDHP48",163,0)
 .S STATUS=$G(MEDX(55.06,IENS,28,"E"))    ; status
"RTN","SYNDHP48",164,0)
 .S DOSORD=$P($G(^PS(55,PATIEN,5,D1,.2)),U,2)          ; dosage ordered
"RTN","SYNDHP48",165,0)
 .S STDTFM=$G(MEDX(55.06,IENS,10,"I"))      ; start date
"RTN","SYNDHP48",166,0)
 .QUIT:((STDTFM\1)<FRDAT)!((STDTFM\1)>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP48",167,0)
 .S STDT=$$FMTHL7^XLFDT($G(MEDX(55.06,IENS,10,"I")))      ; start date
"RTN","SYNDHP48",168,0)
 .S DRUG=$$GET1^DIQ(55.07,1_C_IENS,.01,"E")  ; medication
"RTN","SYNDHP48",169,0)
 .S DRUGI=$$GET1^DIQ(55.07,1_C_IENS,.01,"I")
"RTN","SYNDHP48",170,0)
 .S RXN=$$GETRXN(DRUGI)
"RTN","SYNDHP48",171,0)
 .I RXN?1.N S RXN="RXN"_RXN
"RTN","SYNDHP48",172,0)
 .S IDENT=$$RESID^SYNDHP69("V",SITE)_UL_55_UL_PATIEN_UL_55.06_UL_D1
"RTN","SYNDHP48",173,0)
 .S RETDESC=RETDESC_$G(IDENT)_U_$G(STATUS)_U_$G(DRUG)_U_$G(STDT)_U_"REASON"_U_$G(SITEA)_S_$G(ROUTE)_S_$G(DOSORD)_U_$G(QTY)_U_$G(DAYS)_U_$G(RXN)_P
"RTN","SYNDHP48",174,0)
 ;
"RTN","SYNDHP48",175,0)
 ; start here for outpatient orders
"RTN","SYNDHP48",176,0)
 S D1=0
"RTN","SYNDHP48",177,0)
 F  S D1=$O(^PS(55,PATIEN,"P",D1)) Q:D1'?1N.N  D
"RTN","SYNDHP48",178,0)
 . S RX=$G(^PS(55,PATIEN,"P",D1,0))
"RTN","SYNDHP48",179,0)
 . S (IDENT,IDATE,DRUG,QTY,DAYS,STATUS,ROUTE)=""
"RTN","SYNDHP48",180,0)
 . N MEDX,MEDERR
"RTN","SYNDHP48",181,0)
 . D GETS^DIQ(52,RX_",",".01;1;2;6;7;8;100","IEN","MEDX","MEDERR")
"RTN","SYNDHP48",182,0)
 . QUIT:$D(MEDERR)
"RTN","SYNDHP48",183,0)
 . S IDENT=$$RESID^SYNDHP69("V",SITE)_UL_52_UL_RX
"RTN","SYNDHP48",184,0)
 . S IDATEFM=$G(MEDX(52,RX_",",1,"I"))     ;issue date
"RTN","SYNDHP48",185,0)
 . QUIT:((IDATEFM\1)<FRDAT)!((IDATEFM\1)>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP48",186,0)
 . S IDATE=$$FMTHL7^XLFDT($G(MEDX(52,RX_",",1,"I")))     ;issue date
"RTN","SYNDHP48",187,0)
 . S DRUG=$G(MEDX(52,RX_",",6,"E"))      ;medication
"RTN","SYNDHP48",188,0)
 . S DRUGI=$G(MEDX(52,RX_",",6,"I"))
"RTN","SYNDHP48",189,0)
 . S RXN=$$GETRXN(DRUGI)
"RTN","SYNDHP48",190,0)
 . I RXN?1.N S RXN="RXN"_RXN
"RTN","SYNDHP48",191,0)
 . S QTY=$G(MEDX(52,RX_",",7,"E"))       ;quantity
"RTN","SYNDHP48",192,0)
 . S DAYS=$G(MEDX(52,RX_",",8,"E"))      ;days supply
"RTN","SYNDHP48",193,0)
 . S STATUS=$G(MEDX(52,RX_",",100,"E"))  ;status
"RTN","SYNDHP48",194,0)
 . S ROUTE=$$GET1^DIQ(52.0113,"1,"_RX_",",6,"EN")  ;route
"RTN","SYNDHP48",195,0)
 . S RETDESC=RETDESC_$G(IDENT)_U_$G(STATUS)_U_$G(DRUG)_U_$G(IDATE)_U_"REASON"_U_$G(SITEA)_S_$G(ROUTE)_S_$G(DOSORD)_U_$G(QTY)_U_$G(DAYS)_U_$G(RXN)_P
"RTN","SYNDHP48",196,0)
 S RETSTA=DHPICN_U_RETDESC
"RTN","SYNDHP48",197,0)
 Q
"RTN","SYNDHP48",198,0)
 ;
"RTN","SYNDHP48",199,0)
 ; ---------------- Get patient medication dispense ----------------------------
"RTN","SYNDHP48",200,0)
 ;
"RTN","SYNDHP48",201,0)
PATMEDD(RETSTA,DHPICN,FRDAT,TODAT) ; Patient medication dispense for ICN
"RTN","SYNDHP48",202,0)
 ;
"RTN","SYNDHP48",203,0)
 ; Return patient medication dispense for a given patient ICN
"RTN","SYNDHP48",204,0)
 ;
"RTN","SYNDHP48",205,0)
 ; Input:
"RTN","SYNDHP48",206,0)
 ;   ICN     - unique patient identifier across all VistA systems
"RTN","SYNDHP48",207,0)
 ;   FRDAT   - from date (inclusive), optional
"RTN","SYNDHP48",208,0)
 ;   TODAT   - to date (inclusive), optional
"RTN","SYNDHP48",209,0)
 ; Output:
"RTN","SYNDHP48",210,0)
 ;   RETSTA  - a delimited string that lists the following information
"RTN","SYNDHP48",211,0)
 ;      PatientICN ^ RESOURSE ID ^ STATUS ^ MEDICATION ^ DATE ASSERTED ^ CONDITION
"RTN","SYNDHP48",212,0)
 ;      ^ DOSAGE , SITE ; ROUTE ; DOSE ^ QUANTITY ^ DAYS ^ RXN |
"RTN","SYNDHP48",213,0)
 ;
"RTN","SYNDHP48",214,0)
 ;   Identifier will be "V"_SITE ID_"_"_FILEMAN #_"_"_FILE IEN   i.e. V_500_55_930
"RTN","SYNDHP48",215,0)
 ;
"RTN","SYNDHP48",216,0)
 ; validate ICN
"RTN","SYNDHP48",217,0)
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
"RTN","SYNDHP48",218,0)
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" Q
"RTN","SYNDHP48",219,0)
 ;
"RTN","SYNDHP48",220,0)
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
"RTN","SYNDHP48",221,0)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
"RTN","SYNDHP48",222,0)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
"RTN","SYNDHP48",223,0)
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
"RTN","SYNDHP48",224,0)
 ;
"RTN","SYNDHP48",225,0)
 N C,ACU,P,S,UL,D1,IDENT,ORDDAT,ORDNUM,ROUTE,STATUS,DOSORD,STDT,STDTFM,DRUG,SITEA
"RTN","SYNDHP48",226,0)
 N RETDESC,SITE,QTY,DAYS,RXN,PATIEN,RX
"RTN","SYNDHP48",227,0)
 S C=",",P="|",S=";",UL="_"
"RTN","SYNDHP48",228,0)
 ; get patient IEN from ICN
"RTN","SYNDHP48",229,0)
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP48",230,0)
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
"RTN","SYNDHP48",231,0)
 ;
"RTN","SYNDHP48",232,0)
 S RETDESC=""
"RTN","SYNDHP48",233,0)
 S SITE=$P($$SITE^VASITE,U,3)
"RTN","SYNDHP48",234,0)
 S RETSTA=""
"RTN","SYNDHP48",235,0)
 ; loop through the PHARMACY PATIENT file #55 (^PS(55)) for patient (this will contain both IP and OP orders).
"RTN","SYNDHP48",236,0)
 ; OP orders will need to get additional information from the PRESCRIPTION file #52 (^PSRX)
"RTN","SYNDHP48",237,0)
 S D1=0
"RTN","SYNDHP48",238,0)
 F  S D1=$O(^PS(55,PATIEN,5,D1)) Q:D1'?1N.N  D
"RTN","SYNDHP48",239,0)
 .S IENS=D1_C_PATIEN_C
"RTN","SYNDHP48",240,0)
 .S (ORDDAT,ORDNUM,ROUTE,STATUS,DOSORD,STDT,STDTFM,DRUG,SITEA,QTY,DAYS,RXN)=""
"RTN","SYNDHP48",241,0)
 .N MEDX,MEDERR
"RTN","SYNDHP48",242,0)
 .D GETS^DIQ(55.06,IENS,".01;3;10;28","IEN","MEDX","MEDERR")
"RTN","SYNDHP48",243,0)
 .QUIT:$D(MEDERR)
"RTN","SYNDHP48",244,0)
 .S ORDNUM=$G(MEDX(55.06,IENS,.01,"E"))   ; order number
"RTN","SYNDHP48",245,0)
 .; route is most likely not stored in vista as SCT code, but should check this
"RTN","SYNDHP48",246,0)
 .S ROUTE=$G(MEDX(55.06,IENS,3,"E"))      ; route
"RTN","SYNDHP48",247,0)
 .S STATUS=$G(MEDX(55.06,IENS,28,"E"))    ; status
"RTN","SYNDHP48",248,0)
 .S DOSORD=$P($G(^PS(55,PATIEN,5,D1,.2)),U,2)          ; dosage ordered
"RTN","SYNDHP48",249,0)
 .S STDTFM=$G(MEDX(55.06,IENS,10,"I"))      ; start date
"RTN","SYNDHP48",250,0)
 .QUIT:((STDTFM\1)<FRDAT)!((STDTFM\1)>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP48",251,0)
 .S STDT=$$FMTHL7^XLFDT($G(MEDX(55.06,IENS,10,"I")))      ; start date
"RTN","SYNDHP48",252,0)
 .S DRUG=$$GET1^DIQ(55.07,1_C_IENS,.01,"E")  ; medication
"RTN","SYNDHP48",253,0)
 .S DRUGI=$$GET1^DIQ(55.07,1_C_IENS,.01,"I")
"RTN","SYNDHP48",254,0)
 .S RXN=$$GETRXN(DRUGI)
"RTN","SYNDHP48",255,0)
 .I RXN?1.N S RXN="RXN"_RXN
"RTN","SYNDHP48",256,0)
 .S IDENT=$$RESID^SYNDHP69("V",SITE)_UL_55_UL_PATIEN_UL_55.06_UL_D1
"RTN","SYNDHP48",257,0)
 .S RETDESC=RETDESC_$G(IDENT)_U_$G(STATUS)_U_$G(DRUG)_U_$G(STDT)_U_"REASON"_U_$G(SITEA)_S_$G(ROUTE)_S_$G(DOSORD)_U_$G(QTY)_U_$G(DAYS)_U_$G(RXN)_P
"RTN","SYNDHP48",258,0)
 ;
"RTN","SYNDHP48",259,0)
 S RETSTA=DHPICN_U_RETDESC
"RTN","SYNDHP48",260,0)
 Q
"RTN","SYNDHP48",261,0)
 ;
"RTN","SYNDHP48",262,0)
TESTS ;
"RTN","SYNDHP48",263,0)
 Q
"RTN","SYNDHP48",264,0)
 ;
"RTN","SYNDHP48",265,0)
T1 ;
"RTN","SYNDHP48",266,0)
 N ICN S ICN=""
"RTN","SYNDHP48",267,0)
 F  S ICN=$O(^DPT("AFICN",ICN)) Q:ICN=""  D
"RTN","SYNDHP48",268,0)
 .W !!!,ICN,!!!
"RTN","SYNDHP48",269,0)
 .D PATMEDS(.RETSTA,ICN)
"RTN","SYNDHP48",270,0)
 .W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP48",271,0)
 .W !!!
"RTN","SYNDHP48",272,0)
 Q
"RTN","SYNDHP48",273,0)
 ;
"RTN","SYNDHP48",274,0)
T2 ;
"RTN","SYNDHP48",275,0)
 N ICN S ICN=""
"RTN","SYNDHP48",276,0)
 F  S ICN=$O(^DPT("AFICN",ICN)) Q:ICN=""  D
"RTN","SYNDHP48",277,0)
 .W !,ICN,!
"RTN","SYNDHP48",278,0)
 .D PATMEDD(.RETSTA,ICN)
"RTN","SYNDHP48",279,0)
 .W $$ZW^SYNDHPUTL("RETSTA"),!!
"RTN","SYNDHP48",280,0)
 Q
"RTN","SYNDHP48",281,0)
 ;
"RTN","SYNDHP48",282,0)
T3 ;
"RTN","SYNDHP48",283,0)
 N ICN,XPIEN
"RTN","SYNDHP48",284,0)
 S ICN=""
"RTN","SYNDHP48",285,0)
 F  S ICN=$O(^DPT("AFICN",ICN)) Q:ICN=""  D
"RTN","SYNDHP48",286,0)
 .S XPIEN=$O(^DPT("AFICN",ICN,""))
"RTN","SYNDHP48",287,0)
 .W !,ICN,!,XPIEN,!,^DPT(XPIEN,0),!
"RTN","SYNDHP48",288,0)
 .D PATMEDD(.RETSTA,ICN)
"RTN","SYNDHP48",289,0)
 .W $$ZW^SYNDHPUTL("RETSTA"),!!
"RTN","SYNDHP48",290,0)
 Q
"RTN","SYNDHP48",291,0)
 ;
"RTN","SYNDHP48",292,0)
T4 ;
"RTN","SYNDHP48",293,0)
 N ICN S ICN="10111V183702"
"RTN","SYNDHP48",294,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP48",295,0)
 N TODAT S TODAT=""
"RTN","SYNDHP48",296,0)
 N RETSTA
"RTN","SYNDHP48",297,0)
 D PATMEDA(.RETSTA,ICN,FRDAT,TODAT)
"RTN","SYNDHP48",298,0)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
"RTN","SYNDHP48",299,0)
 QUIT
"RTN","SYNDHP48",300,0)
 ;
"RTN","SYNDHP48",301,0)
T5 ;
"RTN","SYNDHP48",302,0)
 N ICN S ICN="10111V183702"
"RTN","SYNDHP48",303,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP48",304,0)
 N TODAT S TODAT=""
"RTN","SYNDHP48",305,0)
 N RETSTA
"RTN","SYNDHP48",306,0)
 D PATMEDD(.RETSTA,ICN,FRDAT,TODAT)
"RTN","SYNDHP48",307,0)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
"RTN","SYNDHP48",308,0)
 QUIT
"RTN","SYNDHP48",309,0)
 ;
"RTN","SYNDHP48",310,0)
T6 ;
"RTN","SYNDHP48",311,0)
 N ICN S ICN="10111V183702"
"RTN","SYNDHP48",312,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP48",313,0)
 N TODAT S TODAT=""
"RTN","SYNDHP48",314,0)
 N RETSTA
"RTN","SYNDHP48",315,0)
 D PATMEDS(.RETSTA,ICN,FRDAT,TODAT)
"RTN","SYNDHP48",316,0)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
"RTN","SYNDHP48",317,0)
 QUIT
"RTN","SYNDHP48",318,0)
 ;
"RTN","SYNDHP48",319,0)
 ;Statement
"RTN","SYNDHP48",320,0)
 ;IP S RETDESC=RETDESC_$G(IDENT)_U_$G(STATUS)_U_$G(DRUG)_U_$G(STDT)_U_"REASON"_U_$G(SITEA)_S_$G(ROUTE)_S_$G(DOSORD)_U_QTY_U_DAYS_U_RXN_P
"RTN","SYNDHP48",321,0)
 ;OP S RETDESC=RETDESC_$G(IDENT)_U_$G(STATUS)_U_$G(DRUG)_U_$G(IDATE)_U_"REASON"_U_$G(SITEA)_S_$G(ROUTE)_S_$G(DOSORD)_U_QTY_U_DAYS_U_RXN_P
"RTN","SYNDHP48",322,0)
 ;Administer
"RTN","SYNDHP48",323,0)
 ;IP S RETDESC=RETDESC_$G(IDENT)_U_$G(STATUS)_U_$G(DRUG)_U_$G(STDT)_U_"REASON"_U_$G(SITEA)_S_$G(ROUTE)_S_$G(DOSORD)_U_QTY_U_DAYS_U_RXN_P
"RTN","SYNDHP48",324,0)
 ;OP S RETDESC=RETDESC_$G(IDENT)_U_$G(STATUS)_U_$G(DRUG)_U_$G(IDATE)_U_"REASON"_U_$G(SITEA)_S_$G(ROUTE)_S_$G(DOSORD)_U_QTY_U_DAYS_U_RXN_P
"RTN","SYNDHP48",325,0)
 ;Dispense
"RTN","SYNDHP48",326,0)
 ;IP S RETDESC=RETDESC_$G(IDENT)_U_$G(STATUS)_U_$G(DRUG)_U_$G(STDT)_U_"REASON"_U_$G(SITEA)_S_$G(ROUTE)_S_$G(DOSORD)_U_QTY_U_DAYS_U_$G(RXN)_P
"RTN","SYNDHP53")
0^4^B22563892
"RTN","SYNDHP53",1,0)
SYNDHP53 ; HC/fjf/art - HealthConcourse - get patient labs ;05/04/2019
"RTN","SYNDHP53",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP53",3,0)
 ;;
"RTN","SYNDHP53",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP53",5,0)
 ;
"RTN","SYNDHP53",6,0)
 QUIT
"RTN","SYNDHP53",7,0)
 ;
"RTN","SYNDHP53",8,0)
 ;
"RTN","SYNDHP53",9,0)
 ; ---------------- Get patient labs ----------------------
"RTN","SYNDHP53",10,0)
 ;
"RTN","SYNDHP53",11,0)
PATLAB(RETSTA,NAME,SSN,DOB,GENDER,FRDAT,TODAT) ; get labs for a patient by traits
"RTN","SYNDHP53",12,0)
 S RETSTA="-1^This service has been retired"
"RTN","SYNDHP53",13,0)
 QUIT
"RTN","SYNDHP53",14,0)
 ; Return patient labs for name, SSN, DOB, and gender
"RTN","SYNDHP53",15,0)
 ;
"RTN","SYNDHP53",16,0)
 ; Input:
"RTN","SYNDHP53",17,0)
 ;   NAME    - patient name
"RTN","SYNDHP53",18,0)
 ;   SSN     - social security number
"RTN","SYNDHP53",19,0)
 ;   DOB     - date of birth
"RTN","SYNDHP53",20,0)
 ;   GENDER  - gender
"RTN","SYNDHP53",21,0)
 ;   FRDAT   - from date (inclusive), optional, compared to 63.04:.01 DATE/TIME SPECIMEN TAKEN
"RTN","SYNDHP53",22,0)
 ;   TODAT   - to date (inclusive), optional, compared to 63.04:.01 DATE/TIME SPECIMEN TAKEN
"RTN","SYNDHP53",23,0)
 ; Output:
"RTN","SYNDHP53",24,0)
 ;   RETSTA  - a delimited string that lists LOINC codes for the patient labs
"RTN","SYNDHP53",25,0)
 ;           - ICN^LOINC code1|LOINC description|result|date|identifier
"RTN","SYNDHP53",26,0)
 ;
"RTN","SYNDHP53",27,0)
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
"RTN","SYNDHP53",28,0)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
"RTN","SYNDHP53",29,0)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
"RTN","SYNDHP53",30,0)
 ;
"RTN","SYNDHP53",31,0)
 N P,ICNST,PATIEN
"RTN","SYNDHP53",32,0)
 ;
"RTN","SYNDHP53",33,0)
 S P="|"
"RTN","SYNDHP53",34,0)
 D PATVAL^SYNDHP43(.ICNST,NAME,SSN,DOB,GENDER)
"RTN","SYNDHP53",35,0)
 I +ICNST'=1 S RETSTA=ICNST QUIT
"RTN","SYNDHP53",36,0)
 ; if we are here we are dealing with a valid patient
"RTN","SYNDHP53",37,0)
 S DHPICN=$P(ICNST,U,3)
"RTN","SYNDHP53",38,0)
 ; get patient IEN from ICN
"RTN","SYNDHP53",39,0)
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP53",40,0)
 I PATIEN="" S RETSTA="-1^Patient ICN not found" QUIT
"RTN","SYNDHP53",41,0)
 D LABS(.RETSTA,PATIEN,FRDAT,TODAT,DHPICN)
"RTN","SYNDHP53",42,0)
 ;
"RTN","SYNDHP53",43,0)
 QUIT
"RTN","SYNDHP53",44,0)
 ;
"RTN","SYNDHP53",45,0)
PATLABI(RETSTA,DHPICN,FRDAT,TODAT,RETJSON) ; Patient labs for ICN
"RTN","SYNDHP53",46,0)
 ;
"RTN","SYNDHP53",47,0)
 ; Return patient labs for a given patient ICN
"RTN","SYNDHP53",48,0)
 ;
"RTN","SYNDHP53",49,0)
 ; Input:
"RTN","SYNDHP53",50,0)
 ;   DHPICN  - unique patient identifier across all VistA systems
"RTN","SYNDHP53",51,0)
 ;   FRDAT   - from date (inclusive), optional, compared to 63.04:.01 DATE/TIME SPECIMEN TAKEN
"RTN","SYNDHP53",52,0)
 ;   TODAT   - to date (inclusive), optional, compared to 63.04:.01 DATE/TIME SPECIMEN TAKEN
"RTN","SYNDHP53",53,0)
 ;   RETJSON - J = Return JSON
"RTN","SYNDHP53",54,0)
 ;             F = Return FHIR
"RTN","SYNDHP53",55,0)
 ;             0 or null = Return lab string (default)
"RTN","SYNDHP53",56,0)
 ; Output:
"RTN","SYNDHP53",57,0)
 ;   RETSTA  - a delimited string that lists LOINC codes for the patient labs
"RTN","SYNDHP53",58,0)
 ;           - ICN^LOINC code1|LOINC description|result|date|resource ID^...
"RTN","SYNDHP53",59,0)
 ;          or patient chem labs in JSON format
"RTN","SYNDHP53",60,0)
 ;
"RTN","SYNDHP53",61,0)
 ; validate ICN
"RTN","SYNDHP53",62,0)
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
"RTN","SYNDHP53",63,0)
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" QUIT
"RTN","SYNDHP53",64,0)
 ;
"RTN","SYNDHP53",65,0)
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
"RTN","SYNDHP53",66,0)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
"RTN","SYNDHP53",67,0)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
"RTN","SYNDHP53",68,0)
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
"RTN","SYNDHP53",69,0)
 ;
"RTN","SYNDHP53",70,0)
 ; get patient IEN from ICN
"RTN","SYNDHP53",71,0)
 N LABARRAY
"RTN","SYNDHP53",72,0)
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP53",73,0)
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
"RTN","SYNDHP53",74,0)
 ;
"RTN","SYNDHP53",75,0)
 D LABS(.RETSTA,PATIEN,FRDAT,TODAT,DHPICN,.LABARRAY)
"RTN","SYNDHP53",76,0)
 ;
"RTN","SYNDHP53",77,0)
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
"RTN","SYNDHP53",78,0)
 ;
"RTN","SYNDHP53",79,0)
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
"RTN","SYNDHP53",80,0)
 . S RETSTA=""
"RTN","SYNDHP53",81,0)
 . D TOJASON^SYNDHPUTL(.LABARRAY,.RETSTA)
"RTN","SYNDHP53",82,0)
 ;
"RTN","SYNDHP53",83,0)
 QUIT
"RTN","SYNDHP53",84,0)
 ;
"RTN","SYNDHP53",85,0)
LABS(LLIST,PATIEN,FRDAT,TODAT,DHPICN,LABARRAY) ; return chem labs for patient
"RTN","SYNDHP53",86,0)
 ;
"RTN","SYNDHP53",87,0)
 N LABREF S LABREF=$$GET1^DIQ(2,PATIEN_",",63) ;laboratory reference in Patient file
"RTN","SYNDHP53",88,0)
 I LABREF="" S LLIST=DHPICN QUIT
"RTN","SYNDHP53",89,0)
 ;
"RTN","SYNDHP53",90,0)
 N P S P="|"
"RTN","SYNDHP53",91,0)
 N RETSEQ S RETSEQ=0
"RTN","SYNDHP53",92,0)
 N LABS,TESTDT,TESTDTHL,LOINCCD,LOINCNM,RESULT,LABID,TESTIEN,TESTNAME,ARRAY
"RTN","SYNDHP53",93,0)
 D GETLABS^SYNDHP21(.LABS,LABREF,0)
"RTN","SYNDHP53",94,0)
 I $D(LABS("Lab","ERROR")) M LABARRAY("Labs",PATIEN)=LABS QUIT
"RTN","SYNDHP53",95,0)
 N SEQ S SEQ=""
"RTN","SYNDHP53",96,0)
 F  S SEQ=$O(LABS("Lab","chemHemToxRiaSerEtcs","chemHemToxRiaSerEtc",SEQ)) QUIT:SEQ=""  D
"RTN","SYNDHP53",97,0)
 . N TEST S TEST=$NA(LABS("Lab","chemHemToxRiaSerEtcs","chemHemToxRiaSerEtc",SEQ))
"RTN","SYNDHP53",98,0)
 . S TESTDT=@TEST@("dateTimeSpecimenTakenFM")
"RTN","SYNDHP53",99,0)
 . QUIT:((TESTDT\1)<FRDAT)!((TESTDT\1)>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP53",100,0)
 . S TESTDTHL=@TEST@("dateTimeSpecimenTakenHL7")
"RTN","SYNDHP53",101,0)
 . S LOINCCD=@TEST@("loincCode")
"RTN","SYNDHP53",102,0)
 . S LOINCNM=@TEST@("loincName")
"RTN","SYNDHP53",103,0)
 . S RESULT=@TEST@("result")
"RTN","SYNDHP53",104,0)
 . S TESTIEN=@TEST@("labTestId")
"RTN","SYNDHP53",105,0)
 . S TESTNAME=@TEST@("labTestName")
"RTN","SYNDHP53",106,0)
 . S LABID=@TEST@("resourceId")
"RTN","SYNDHP53",107,0)
 . I $G(DEBUG) D
"RTN","SYNDHP53",108,0)
 . . ;W "  Workload Code: ",WKLDCODE,?30,WKLDNAME,!
"RTN","SYNDHP53",109,0)
 . . W "  Test Name:     ",TESTIEN,?30,TESTNAME,!
"RTN","SYNDHP53",110,0)
 . . W "  LOINC Code: ",LOINCCD,!
"RTN","SYNDHP53",111,0)
 . . W "  LOINC Name: ",LOINCNM,!
"RTN","SYNDHP53",112,0)
 . . W "  Result:     ",RESULT,!
"RTN","SYNDHP53",113,0)
 . S RETSEQ=RETSEQ+1
"RTN","SYNDHP53",114,0)
 . S ARRAY(RETSEQ)=LOINCCD_P_LOINCNM_P_RESULT_P_TESTDTHL_P_LABID
"RTN","SYNDHP53",115,0)
 . M LABARRAY("Labs",PATIEN)=LABS ;
"RTN","SYNDHP53",116,0)
 ;
"RTN","SYNDHP53",117,0)
 ;I $G(DEBUG) W ! ZWRITE ARRAY W !
"RTN","SYNDHP53",118,0)
 ;serialize data
"RTN","SYNDHP53",119,0)
 S LLIST=DHPICN
"RTN","SYNDHP53",120,0)
 S RETSEQ=""
"RTN","SYNDHP53",121,0)
 F  S RETSEQ=$O(ARRAY(RETSEQ)) QUIT:RETSEQ=""  D
"RTN","SYNDHP53",122,0)
 . S LLIST=LLIST_U_ARRAY(RETSEQ)
"RTN","SYNDHP53",123,0)
 ;
"RTN","SYNDHP53",124,0)
 QUIT
"RTN","SYNDHP53",125,0)
 ;
"RTN","SYNDHP53",126,0)
 ; --------------------------------------------------------------------
"RTN","SYNDHP53",127,0)
 ;
"RTN","SYNDHP53",128,0)
 ; ----------- Unit Test -----------
"RTN","SYNDHP53",129,0)
T1 ;
"RTN","SYNDHP53",130,0)
 N ICN S ICN="1034989029V875306"
"RTN","SYNDHP53",131,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP53",132,0)
 N TODAT S TODAT=""
"RTN","SYNDHP53",133,0)
 N JSON S JSON=""
"RTN","SYNDHP53",134,0)
 N RETSTA
"RTN","SYNDHP53",135,0)
 D PATLABI(.RETSTA,ICN,FRDAT,TODAT,JSON)
"RTN","SYNDHP53",136,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP53",137,0)
 QUIT
"RTN","SYNDHP53",138,0)
 ;
"RTN","SYNDHP53",139,0)
T2 ;
"RTN","SYNDHP53",140,0)
 N ICN S ICN="1034989029V875306"
"RTN","SYNDHP53",141,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP53",142,0)
 N TODAT S TODAT=""
"RTN","SYNDHP53",143,0)
 N JSON S JSON="J"
"RTN","SYNDHP53",144,0)
 N RETSTA
"RTN","SYNDHP53",145,0)
 D PATLABI(.RETSTA,ICN,FRDAT,TODAT,JSON)
"RTN","SYNDHP53",146,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP53",147,0)
 QUIT
"RTN","SYNDHP53",148,0)
 ;
"RTN","SYNDHP54")
0^5^B25313993
"RTN","SYNDHP54",1,0)
SYNDHP54 ; HC/rbd/art - HealthConcourse - retrieve patient provider data ;04/12/2019
"RTN","SYNDHP54",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP54",3,0)
 ;;
"RTN","SYNDHP54",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP54",5,0)
 ;
"RTN","SYNDHP54",6,0)
 QUIT
"RTN","SYNDHP54",7,0)
 ;
"RTN","SYNDHP54",8,0)
 ; ---------------- Get patient providers for encounters ------------------------------
"RTN","SYNDHP54",9,0)
 ;
"RTN","SYNDHP54",10,0)
PATPRVI(RETSTA,DHPICN,FRDAT,TODAT,RETJSON) ; Patient encounter providers for ICN
"RTN","SYNDHP54",11,0)
 ;
"RTN","SYNDHP54",12,0)
 ; Return patient enc providers for a given patient ICN
"RTN","SYNDHP54",13,0)
 ;
"RTN","SYNDHP54",14,0)
 ; Input:
"RTN","SYNDHP54",15,0)
 ;   ICN     - unique patient identifier across all VistA systems
"RTN","SYNDHP54",16,0)
 ;   FRDAT   - from date (inclusive), optional, compares to Visit Date/Time
"RTN","SYNDHP54",17,0)
 ;   TODAT   - to date (inclusive), optional, compares to Visit Date/Time
"RTN","SYNDHP54",18,0)
 ;   RETJSON - J = Return JSON
"RTN","SYNDHP54",19,0)
 ;             F = Return FHIR
"RTN","SYNDHP54",20,0)
 ;             0 or null = Return patient providers string (default)
"RTN","SYNDHP54",21,0)
 ; Output:
"RTN","SYNDHP54",22,0)
 ;   RETSTA  - a delimited string that lists patient providers for encounters
"RTN","SYNDHP54",23,0)
 ;             ICN^visit date|visit ien|provider name|role|prim/sec|address1|address2|city|state|zip|off. phone|specialization|resourceId^...
"RTN","SYNDHP54",24,0)
 ;          or patient enc providers in JSON format
"RTN","SYNDHP54",25,0)
 ;
"RTN","SYNDHP54",26,0)
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
"RTN","SYNDHP54",27,0)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
"RTN","SYNDHP54",28,0)
 I $G(DEBUG) W !,"DHPICN: ",DHPICN,"   FRDAT: ",FRDAT,"   TODAT: ",TODAT,"   RETJSON: ",RETJSON,!
"RTN","SYNDHP54",29,0)
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
"RTN","SYNDHP54",30,0)
 ;
"RTN","SYNDHP54",31,0)
 ; validate ICN
"RTN","SYNDHP54",32,0)
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
"RTN","SYNDHP54",33,0)
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" Q
"RTN","SYNDHP54",34,0)
 ; 
"RTN","SYNDHP54",35,0)
 ; get patient IEN from ICN
"RTN","SYNDHP54",36,0)
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP54",37,0)
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
"RTN","SYNDHP54",38,0)
 ;
"RTN","SYNDHP54",39,0)
 ; get encounter providers
"RTN","SYNDHP54",40,0)
 N ENCPROV
"RTN","SYNDHP54",41,0)
 S RETSTA=$$PRVS(.ENCPROV,PATIEN,DHPICN,FRDAT,TODAT)
"RTN","SYNDHP54",42,0)
 ;
"RTN","SYNDHP54",43,0)
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
"RTN","SYNDHP54",44,0)
 ;
"RTN","SYNDHP54",45,0)
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
"RTN","SYNDHP54",46,0)
 . S RETSTA=""
"RTN","SYNDHP54",47,0)
 . D TOJASON^SYNDHPUTL(.ENCPROV,.RETSTA)
"RTN","SYNDHP54",48,0)
 ;
"RTN","SYNDHP54",49,0)
 Q
"RTN","SYNDHP54",50,0)
 ;
"RTN","SYNDHP54",51,0)
PRVS(ENCPROV,PATIEN,DHPICN,FRDAT,TODAT) ; get providers for encounters for a patient
"RTN","SYNDHP54",52,0)
 ;
"RTN","SYNDHP54",53,0)
 N ENCPROVS,ZARR
"RTN","SYNDHP54",54,0)
 N PRCITY,PRID,PRNAM,PROFFPH,PRPRMSEC,PRREC,PRROLE,PRSTAD1,PRSTAD2,PRSTATE,PRVID,PRVSTDT,PRVVIEN,PRZIP
"RTN","SYNDHP54",55,0)
 N USRCLIEN,USRSPEC,VSTDT
"RTN","SYNDHP54",56,0)
 N P S P="|"
"RTN","SYNDHP54",57,0)
 ; scan visit providers "C" index for IEN
"RTN","SYNDHP54",58,0)
 N PRIEN S PRIEN=""
"RTN","SYNDHP54",59,0)
 F  S PRIEN=$O(^AUPNVPRV("C",PATIEN,PRIEN)) QUIT:PRIEN=""  D
"RTN","SYNDHP54",60,0)
 . N VPROV
"RTN","SYNDHP54",61,0)
 . D GET1VPROV^SYNDHP23(.VPROV,PRIEN,0)
"RTN","SYNDHP54",62,0)
 . I $D(VPROV("Vprov","ERROR")) M ENCPROV("EncProv",PRIEN)=VPROV QUIT
"RTN","SYNDHP54",63,0)
 . ;I $G(DEBUG) W ! ZWRITE VPROV
"RTN","SYNDHP54",64,0)
 . S VSTDT=VPROV("Vprov","visitFM")
"RTN","SYNDHP54",65,0)
 . QUIT:((VSTDT\1)<FRDAT)!((VSTDT\1)>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP54",66,0)
 . S PRID=VPROV("Vprov","resourceId")
"RTN","SYNDHP54",67,0)
 . S PRNAM=VPROV("Vprov","provider")
"RTN","SYNDHP54",68,0)
 . S PRVVIEN=VPROV("Vprov","visitId")
"RTN","SYNDHP54",69,0)
 . S PRVSTDT=VPROV("Vprov","visitHL7")
"RTN","SYNDHP54",70,0)
 . S PRVID=VPROV("Vprov","providerId")
"RTN","SYNDHP54",71,0)
 . S PRPRMSEC=VPROV("Vprov","primarySecondary")
"RTN","SYNDHP54",72,0)
 . N PROVARR,PROVERR
"RTN","SYNDHP54",73,0)
 . N IENS S IENS=PRVID_","
"RTN","SYNDHP54",74,0)
 . D GETS^DIQ(200,IENS,"8;.111;.112;.114;.115;.116;.132;41.99","EI","PROVARR","PROVERR")
"RTN","SYNDHP54",75,0)
 . ;I $G(DEBUG),$D(PROVERR) W !,">>ERROR<<" ZWRITE PROVERR
"RTN","SYNDHP54",76,0)
 . QUIT:$D(PROVERR)
"RTN","SYNDHP54",77,0)
 . S PRROLE=PROVARR(200,IENS,8,"E")
"RTN","SYNDHP54",78,0)
 . S VPROV("Vprov","provRole")=PRROLE
"RTN","SYNDHP54",79,0)
 . S PRSTAD1=PROVARR(200,IENS,.111,"E")
"RTN","SYNDHP54",80,0)
 . S VPROV("Vprov","provAddress1")=PRSTAD1
"RTN","SYNDHP54",81,0)
 . S PRSTAD2=PROVARR(200,IENS,.112,"E")
"RTN","SYNDHP54",82,0)
 . S VPROV("Vprov","provAddress2")=PRSTAD2
"RTN","SYNDHP54",83,0)
 . S PRCITY=PROVARR(200,IENS,.114,"E")
"RTN","SYNDHP54",84,0)
 . S VPROV("Vprov","provCity")=PRCITY
"RTN","SYNDHP54",85,0)
 . S PRSTATE=PROVARR(200,IENS,.115,"E")
"RTN","SYNDHP54",86,0)
 . S VPROV("Vprov","provState")=PRSTATE
"RTN","SYNDHP54",87,0)
 . S PRZIP=PROVARR(200,IENS,.116,"E")
"RTN","SYNDHP54",88,0)
 . S VPROV("Vprov","provZip")=PRZIP
"RTN","SYNDHP54",89,0)
 . S PROFFPH=PROVARR(200,IENS,.132,"E")
"RTN","SYNDHP54",90,0)
 . S VPROV("Vprov","provOffPhone")=PROFFPH
"RTN","SYNDHP54",91,0)
 . S VPROV("Vprov","provNpi")=PROVARR(200,IENS,41.99,"E")
"RTN","SYNDHP54",92,0)
 . S USRCLIEN=VPROV("Vprov","personClassId")
"RTN","SYNDHP54",93,0)
 . S USRSPEC=$$GET1^DIQ(8932.1,USRCLIEN_",",2)
"RTN","SYNDHP54",94,0)
 . S VPROV("Vprov","personClassSpecialty")=USRSPEC
"RTN","SYNDHP54",95,0)
 . I $G(DEBUG) W !,PRNAM_U_PRVSTDT_U_PRROLE_U_PRPRMSEC
"RTN","SYNDHP54",96,0)
 . S ZARR(DHPICN,PRVSTDT,PRVVIEN)=PRNAM_P_PRROLE_P_PRPRMSEC_P_PRSTAD1_P_PRSTAD2_P_PRCITY_P_PRSTATE_P_PRZIP_P_PROFFPH_P_USRSPEC_P_PRID
"RTN","SYNDHP54",97,0)
 . M ENCPROV("EncProv",PRIEN)=VPROV ;
"RTN","SYNDHP54",98,0)
 ;
"RTN","SYNDHP54",99,0)
 ; serialize data
"RTN","SYNDHP54",100,0)
 S (PRVSTDT,PRVVIEN)="",ENCPROVS=DHPICN
"RTN","SYNDHP54",101,0)
 F  S PRVSTDT=$O(ZARR(DHPICN,PRVSTDT)) QUIT:PRVSTDT=""  D
"RTN","SYNDHP54",102,0)
 .F  S PRVVIEN=$O(ZARR(DHPICN,PRVSTDT,PRVVIEN)) Q:PRVVIEN=""  D
"RTN","SYNDHP54",103,0)
 ..S PRREC=ZARR(DHPICN,PRVSTDT,PRVVIEN)
"RTN","SYNDHP54",104,0)
 ..S ENCPROVS=ENCPROVS_U_PRVSTDT_P_PRVVIEN_P_PRREC
"RTN","SYNDHP54",105,0)
 ..; visit date|visit ien|provider name|role|prim/sec|address1|address2|city|state|zip|off. phone|specialization|resourceId
"RTN","SYNDHP54",106,0)
 ;
"RTN","SYNDHP54",107,0)
 QUIT ENCPROVS
"RTN","SYNDHP54",108,0)
 ;
"RTN","SYNDHP54",109,0)
 ; ----------- Unit Test -----------
"RTN","SYNDHP54",110,0)
T1 ;
"RTN","SYNDHP54",111,0)
 N ICN S ICN="1095759922V858498"
"RTN","SYNDHP54",112,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP54",113,0)
 N TODAT S TODAT=""
"RTN","SYNDHP54",114,0)
 N JSON S JSON=""
"RTN","SYNDHP54",115,0)
 N RETSTA
"RTN","SYNDHP54",116,0)
 D PATPRVI(.RETSTA,ICN,FRDAT,TODAT,JSON)
"RTN","SYNDHP54",117,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP54",118,0)
 QUIT
"RTN","SYNDHP54",119,0)
 ;
"RTN","SYNDHP54",120,0)
T2 ;
"RTN","SYNDHP54",121,0)
 N ICN S ICN="1095759922V858498"
"RTN","SYNDHP54",122,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP54",123,0)
 N TODAT S TODAT=""
"RTN","SYNDHP54",124,0)
 N JSON S JSON="J"
"RTN","SYNDHP54",125,0)
 N RETSTA
"RTN","SYNDHP54",126,0)
 D PATPRVI(.RETSTA,ICN,FRDAT,TODAT,JSON)
"RTN","SYNDHP54",127,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP54",128,0)
 QUIT
"RTN","SYNDHP54",129,0)
 ;
"RTN","SYNDHP55")
0^6^B170944201
"RTN","SYNDHP55",1,0)
SYNDHP55 ; HC/art - HealthConcourse - retrieve patient procedures ;04/15/2019
"RTN","SYNDHP55",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP55",3,0)
 ;;
"RTN","SYNDHP55",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP55",5,0)
 ;
"RTN","SYNDHP55",6,0)
 ;Surgical Procedures
"RTN","SYNDHP55",7,0)
 ;Visit Procedures
"RTN","SYNDHP55",8,0)
 ;Radiology Procedures
"RTN","SYNDHP55",9,0)
 ;Radiology Reports
"RTN","SYNDHP55",10,0)
 ;
"RTN","SYNDHP55",11,0)
 QUIT
"RTN","SYNDHP55",12,0)
 ;
"RTN","SYNDHP55",13,0)
 ;Surgical Procedures
"RTN","SYNDHP55",14,0)
SRPRCS(PTIEN,FRDAT,TODAT) ; get surgical procedures for a patient
"RTN","SYNDHP55",15,0)
 ; build the array of SNOMED CT codes that correspond to procedures
"RTN","SYNDHP55",16,0)
 ;
"RTN","SYNDHP55",17,0)
 N PROCS,FNUM,FNBR2,PIEN,PIENS,PRCPTCD,PRCPTIEN,PID,SCT,SCTPT,SEQ,DATE,MAPPING
"RTN","SYNDHP55",18,0)
 N VISITID,VISITDT,VISITHL,SURG,PROV,PDATE,PDATEHL,PRDATE,PRDATEHL,SERPROCS,CLINIC,DIVISION
"RTN","SYNDHP55",19,0)
 N ORDER,ORDERIEN,PRINPROC,SCHDPROC
"RTN","SYNDHP55",20,0)
 ;
"RTN","SYNDHP55",21,0)
 N P S P="|"
"RTN","SYNDHP55",22,0)
 N S S S="_"
"RTN","SYNDHP55",23,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP55",24,0)
 S FNUM=130 ;surgery
"RTN","SYNDHP55",25,0)
 S FNBR2=9000010 ;visit
"RTN","SYNDHP55",26,0)
 N FLIST S FLIST=".015;.021;.09;.14;26;27;50;68;100;120;123"
"RTN","SYNDHP55",27,0)
 S SEQ=0
"RTN","SYNDHP55",28,0)
 ;
"RTN","SYNDHP55",29,0)
 I $G(DEBUG) W !,"Surgical Procedures",!
"RTN","SYNDHP55",30,0)
 ; scan surgery "B" index for IEN
"RTN","SYNDHP55",31,0)
 S PIEN=""
"RTN","SYNDHP55",32,0)
 F  S PIEN=$O(^SRF("B",PTIEN,PIEN)) QUIT:PIEN=""  D
"RTN","SYNDHP55",33,0)
 . N SURGARR,SURGERR
"RTN","SYNDHP55",34,0)
 . S PIENS=PIEN_","
"RTN","SYNDHP55",35,0)
 . D GETS^DIQ(FNUM,PIENS,FLIST,"EI","SURGARR","SURGERR")  ;specific fields
"RTN","SYNDHP55",36,0)
 . ;I $G(DEBUG),$D(SURGERR) W !,">>ERROR<<",! ZWRITE SURGERR
"RTN","SYNDHP55",37,0)
 . QUIT:$D(SURGERR)
"RTN","SYNDHP55",38,0)
 . S PID=$$RESID^SYNDHP69("V",SITE)_S_FNUM_S_PIEN
"RTN","SYNDHP55",39,0)
 . S PDATE=SURGARR(FNUM,PIENS,.09,"I") ;date of operation
"RTN","SYNDHP55",40,0)
 . QUIT:((PDATE\1)<FRDAT)!((PDATE\1)>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP55",41,0)
 . S PDATEHL=$$FMTHL7^XLFDT(PDATE) ;date of operation, hl7 format
"RTN","SYNDHP55",42,0)
 . S CLINIC=SURGARR(FNUM,PIENS,.021,"E") ;associated clinic
"RTN","SYNDHP55",43,0)
 . S DIVISION=SURGARR(FNUM,PIENS,50,"E") ;division
"RTN","SYNDHP55",44,0)
 . S SURG=SURGARR(FNUM,PIENS,.14,"E") ;primary surgeon
"RTN","SYNDHP55",45,0)
 . S PRDATE=SURGARR(FNUM,PIENS,120,"I") ;date of procedure
"RTN","SYNDHP55",46,0)
 . S PRDATEHL=$$FMTHL7^XLFDT(PRDATE) ;date of operation, hl7 format
"RTN","SYNDHP55",47,0)
 . S PROV=SURGARR(FNUM,PIENS,123,"E") ;provider
"RTN","SYNDHP55",48,0)
 . S VISITID=SURGARR(FNUM,PIENS,.015,"I") ;visit, pointer to Visit file
"RTN","SYNDHP55",49,0)
 . S VISITDT=""
"RTN","SYNDHP55",50,0)
 . S:VISITID'="" VISITDT=$$GET1^DIQ(FNBR2,VISITID_",",.01,"I") ;visit/admit date&time
"RTN","SYNDHP55",51,0)
 . S VISITHL=$$FMTHL7^XLFDT(VISITDT) ;hl7 format visit/admit date&time
"RTN","SYNDHP55",52,0)
 . S ORDERIEN=SURGARR(FNUM,PIENS,100,"I") ;order number ien
"RTN","SYNDHP55",53,0)
 . S ORDER=SURGARR(FNUM,PIENS,100,"E") ;order number
"RTN","SYNDHP55",54,0)
 . S PRCPTIEN=SURGARR(FNUM,PIENS,27,"I") ;planned prin procedure code ien
"RTN","SYNDHP55",55,0)
 . S PRCPTCD=SURGARR(FNUM,PIENS,27,"E") ;planned prin procedure code
"RTN","SYNDHP55",56,0)
 . S PRINPROC=SURGARR(FNUM,PIENS,26,"E") ;principal procedure
"RTN","SYNDHP55",57,0)
 . S SCHDPROC=SURGARR(FNUM,PIENS,68,"E") ;scheduled procedure
"RTN","SYNDHP55",58,0)
 . ;LOOKUP SNOMED(sct) - cpt, os5
"RTN","SYNDHP55",59,0)
 . S SCT=""
"RTN","SYNDHP55",60,0)
 . S SCTPT=$S(PRINPROC'="":PRINPROC,1:"")
"RTN","SYNDHP55",61,0)
 . ;map cpt to snomed (currently uses very small map)
"RTN","SYNDHP55",62,0)
 . I PRCPTCD'="" D
"RTN","SYNDHP55",63,0)
 . . S SCT=$$MAP^SYNDHPMP("sct2cpt",PRCPTCD,"I")
"RTN","SYNDHP55",64,0)
 . . S SCT=$S(+SCT=-1:"",1:$P(SCT,U,2))
"RTN","SYNDHP55",65,0)
 . ;if no cpt hit, map os5 to snomed
"RTN","SYNDHP55",66,0)
 . I SCT="",PRCPTCD'="" D
"RTN","SYNDHP55",67,0)
 . . S SCT=$$MAP^SYNDHPMP("sct2os5",PRCPTCD,"I")
"RTN","SYNDHP55",68,0)
 . . S SCT=$S(+SCT=-1:"",1:$P(SCT,U,2))
"RTN","SYNDHP55",69,0)
 . I $G(DEBUG) D
"RTN","SYNDHP55",70,0)
 . . W !,"Record IEN: ",PIEN,!
"RTN","SYNDHP55",71,0)
 . . W "Planned Principal Procedure (CPT): ",PRCPTIEN,"     ",PRCPTCD,!
"RTN","SYNDHP55",72,0)
 . . W "Principal Procedure: ",?22,PRINPROC,!
"RTN","SYNDHP55",73,0)
 . . W "Scheduled Procedure: ",?22,SCHDPROC,!
"RTN","SYNDHP55",74,0)
 . . W "SCT: ",?22,SCT,!
"RTN","SYNDHP55",75,0)
 . . W "SCT Description: ",?22,SCTPT,!
"RTN","SYNDHP55",76,0)
 . . W "Date of Operation: ",?22,PDATE,"     ",PDATEHL,!
"RTN","SYNDHP55",77,0)
 . . W "Date of Procedure: ",?22,PRDATE,"     ",PRDATEHL,!
"RTN","SYNDHP55",78,0)
 . . W "Primary Surgeon: ",?22,SURG,!
"RTN","SYNDHP55",79,0)
 . . W "Provider: ",?22,PROV,!
"RTN","SYNDHP55",80,0)
 . . W "Clinic: ",?22,CLINIC,!
"RTN","SYNDHP55",81,0)
 . . W "Division: ",?22,DIVISION,!
"RTN","SYNDHP55",82,0)
 . . W "Order: ",?22,ORDERIEN,"     ",ORDER,!
"RTN","SYNDHP55",83,0)
 . . W "Visit IEN: ",?22,VISITID,!
"RTN","SYNDHP55",84,0)
 . . W "Visit Date: ",?22,VISITDT,"     ",VISITHL,!
"RTN","SYNDHP55",85,0)
 . . W "PID: ",?22,PID,!
"RTN","SYNDHP55",86,0)
 . S DATE=$S(PDATE'="":PDATEHL,PRDATE'="":PRDATEHL,VISITDT'="":VISITHL,1:"")
"RTN","SYNDHP55",87,0)
 . ;SCT code1|descrption|CPT code|date|identifier
"RTN","SYNDHP55",88,0)
 . S SEQ=SEQ+1
"RTN","SYNDHP55",89,0)
 . S PROCS(SEQ)=U_SCT_P_SCTPT_P_PRCPTCD_P_PDATEHL_P_PID
"RTN","SYNDHP55",90,0)
 ;
"RTN","SYNDHP55",91,0)
 ;I $G(DEBUG) W ! ZWRITE PROCS
"RTN","SYNDHP55",92,0)
 ;
"RTN","SYNDHP55",93,0)
 ;serialize data
"RTN","SYNDHP55",94,0)
 S SERPROCS=""
"RTN","SYNDHP55",95,0)
 S SEQ=""
"RTN","SYNDHP55",96,0)
 F  S SEQ=$O(PROCS(SEQ)) QUIT:SEQ=""  D
"RTN","SYNDHP55",97,0)
 . S SERPROCS=SERPROCS_PROCS(SEQ)
"RTN","SYNDHP55",98,0)
 ;
"RTN","SYNDHP55",99,0)
 ;I $G(DEBUG) W ! ZWRITE SERPROCS
"RTN","SYNDHP55",100,0)
 ;
"RTN","SYNDHP55",101,0)
 QUIT SERPROCS
"RTN","SYNDHP55",102,0)
 ;
"RTN","SYNDHP55",103,0)
 ;Visit Procedures
"RTN","SYNDHP55",104,0)
VSTPRCS(PATIEN,FRDAT,TODAT) ;
"RTN","SYNDHP55",105,0)
 ;
"RTN","SYNDHP55",106,0)
 N PROCS,FNBR1,FNBR2,PIEN,VISITID,VISITDT,PRPROC
"RTN","SYNDHP55",107,0)
 N VISITHL,CPT,CPTNAME,PID,SEQ,SERPROCS,MAPPING,SCT
"RTN","SYNDHP55",108,0)
 ;
"RTN","SYNDHP55",109,0)
 S PROCS=""
"RTN","SYNDHP55",110,0)
 N P S P="|"
"RTN","SYNDHP55",111,0)
 S SEQ=0
"RTN","SYNDHP55",112,0)
 S FNBR1=9000010.18 ;v cpt
"RTN","SYNDHP55",113,0)
 S FNBR2=9000010 ;visit
"RTN","SYNDHP55",114,0)
 I $G(DEBUG) W !,"Visit Procedures",!
"RTN","SYNDHP55",115,0)
 ;
"RTN","SYNDHP55",116,0)
 S PIEN=""
"RTN","SYNDHP55",117,0)
 F  S PIEN=$O(^AUPNVCPT("C",PATIEN,PIEN)) QUIT:PIEN=""  D
"RTN","SYNDHP55",118,0)
 . N VCPT
"RTN","SYNDHP55",119,0)
 . D GET1VCPT^SYNDHP14(.VCPT,PIEN,0)
"RTN","SYNDHP55",120,0)
 . QUIT:$D(VCPT("Vcpt","ERROR"))
"RTN","SYNDHP55",121,0)
 . ;I $G(DEBUG) ZWRITE VCPT
"RTN","SYNDHP55",122,0)
 . S VISITDT=VCPT("Vcpt","visitFM") ;visit/admit date&time
"RTN","SYNDHP55",123,0)
 . QUIT:((VISITDT\1)<FRDAT)!((VISITDT\1)>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP55",124,0)
 . S VISITHL=VCPT("Vcpt","visitHL7") ;hl7 format visit/admit date&time
"RTN","SYNDHP55",125,0)
 . S PID=VCPT("Vcpt","resourceId")
"RTN","SYNDHP55",126,0)
 . S CPT=VCPT("Vcpt","cpt") ;cpt code
"RTN","SYNDHP55",127,0)
 . S CPTNAME=VCPT("Vcpt","cptName") ;cpt name
"RTN","SYNDHP55",128,0)
 . S VISITDT=VCPT("Vcpt","visitFM") ;visit/admit date&time
"RTN","SYNDHP55",129,0)
 . QUIT:(VISITDT<FRDAT)!(VISITDT>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP55",130,0)
 . S VISITHL=VCPT("Vcpt","visitHL7") ;hl7 format visit/admit date&time
"RTN","SYNDHP55",131,0)
 . ;LOOKUP SNOMED(sct) - cpt, os5
"RTN","SYNDHP55",132,0)
 . S SCT=""
"RTN","SYNDHP55",133,0)
 . ;map cpt to snomed (currently uses very small map)
"RTN","SYNDHP55",134,0)
 . I CPT'="" D
"RTN","SYNDHP55",135,0)
 . . S SCT=$$MAP^SYNDHPMP("sct2cpt",CPT,"I")
"RTN","SYNDHP55",136,0)
 . . S SCT=$S(+SCT=-1:"",1:$P(SCT,U,2))
"RTN","SYNDHP55",137,0)
 . ;if no cpt hit, map os5 to snomed
"RTN","SYNDHP55",138,0)
 . I SCT="",CPT'="" D
"RTN","SYNDHP55",139,0)
 . . S SCT=$$MAP^SYNDHPMP("sct2os5",CPT,"I")
"RTN","SYNDHP55",140,0)
 . . S SCT=$S(+SCT=-1:"",1:$P(SCT,U,2))
"RTN","SYNDHP55",141,0)
 . S SEQ=SEQ+1
"RTN","SYNDHP55",142,0)
 . ;SCT code1|descrption|CPT code|date|identifier
"RTN","SYNDHP55",143,0)
 . S PROCS(SEQ)=U_SCT_P_CPTNAME_P_CPT_P_VISITHL_P_PID
"RTN","SYNDHP55",144,0)
 ;
"RTN","SYNDHP55",145,0)
 ;I $G(DEBUG) W ! ZWRITE PROCS
"RTN","SYNDHP55",146,0)
 ;
"RTN","SYNDHP55",147,0)
 ;serialize data
"RTN","SYNDHP55",148,0)
 S SERPROCS=""
"RTN","SYNDHP55",149,0)
 S SEQ=""
"RTN","SYNDHP55",150,0)
 F  S SEQ=$O(PROCS(SEQ)) QUIT:SEQ=""  D
"RTN","SYNDHP55",151,0)
 . S SERPROCS=SERPROCS_PROCS(SEQ)
"RTN","SYNDHP55",152,0)
 ;
"RTN","SYNDHP55",153,0)
 ;I $G(DEBUG) W ! ZWRITE SERPROCS
"RTN","SYNDHP55",154,0)
 ;
"RTN","SYNDHP55",155,0)
 QUIT SERPROCS
"RTN","SYNDHP55",156,0)
 ;
"RTN","SYNDHP55",157,0)
 ;Radiology Procedures
"RTN","SYNDHP55",158,0)
RADPRCS(PATIEN,FRDAT,TODAT) ;
"RTN","SYNDHP55",159,0)
 ;
"RTN","SYNDHP55",160,0)
 N P S P="|"
"RTN","SYNDHP55",161,0)
 N SEQ S SEQ=0
"RTN","SYNDHP55",162,0)
 I $G(DEBUG) W !,"Radiology Procedures",!
"RTN","SYNDHP55",163,0)
 N RADEX
"RTN","SYNDHP55",164,0)
 D RADEXAM(.RADEX,PATIEN,0,FRDAT,TODAT)
"RTN","SYNDHP55",165,0)
 ;             1      2        3       4            5            6         7        8     9     10     11         12      13        14        15       16
"RTN","SYNDHP55",166,0)
 ; RADEX(SEQ)=PID_U_PatDfn_U_CatEx_U_ExamDate_U_ExamDateHl7_U_CASENBR_U_PROCIEN_U_PROC_U_CPT_U_SCT_U_PDIAGCD_U_REQPHYS_U_PIRES_U_PISTAFF_U_VISITDT_U_VISITHL
"RTN","SYNDHP55",167,0)
 ;
"RTN","SYNDHP55",168,0)
 N SCT,PROC,PROCS,CPT,EXDATE,EXDATEHL,PID
"RTN","SYNDHP55",169,0)
 N IDX S IDX=""
"RTN","SYNDHP55",170,0)
 F  S IDX=$O(RADEX(IDX)) QUIT:IDX=""  D
"RTN","SYNDHP55",171,0)
 . S EXDATE=$P(RADEX(IDX),U,4)
"RTN","SYNDHP55",172,0)
 . QUIT:((EXDATE\1)<FRDAT)!((EXDATE\1)>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP55",173,0)
 . S SCT=$P(RADEX(IDX),U,10)
"RTN","SYNDHP55",174,0)
 . S PROC=$P(RADEX(IDX),U,8)
"RTN","SYNDHP55",175,0)
 . S CPT=$P(RADEX(IDX),U,9)
"RTN","SYNDHP55",176,0)
 . S EXDATEHL=$P(RADEX(IDX),U,5)
"RTN","SYNDHP55",177,0)
 . S PID=$P(RADEX(IDX),U,1)
"RTN","SYNDHP55",178,0)
 . ;SCT code|descrption|CPT code|date|identifier
"RTN","SYNDHP55",179,0)
 . S SEQ=SEQ+1
"RTN","SYNDHP55",180,0)
 . S PROCS(SEQ)=U_SCT_P_PROC_P_CPT_P_EXDATEHL_P_PID
"RTN","SYNDHP55",181,0)
 ;
"RTN","SYNDHP55",182,0)
 ;I $G(DEBUG) W ! ZWRITE PROCS
"RTN","SYNDHP55",183,0)
 ;
"RTN","SYNDHP55",184,0)
 ;serialize data
"RTN","SYNDHP55",185,0)
 N SERPROCS S SERPROCS=""
"RTN","SYNDHP55",186,0)
 N SEQ S SEQ=""
"RTN","SYNDHP55",187,0)
 F  S SEQ=$O(PROCS(SEQ)) QUIT:SEQ=""  D
"RTN","SYNDHP55",188,0)
 . S SERPROCS=SERPROCS_PROCS(SEQ)
"RTN","SYNDHP55",189,0)
 ;
"RTN","SYNDHP55",190,0)
 ;I $G(DEBUG) W ! ZWRITE SERPROCS
"RTN","SYNDHP55",191,0)
 ;
"RTN","SYNDHP55",192,0)
 QUIT SERPROCS
"RTN","SYNDHP55",193,0)
 ;
"RTN","SYNDHP55",194,0)
 ;
"RTN","SYNDHP55",195,0)
 ;Radiology Procedures
"RTN","SYNDHP55",196,0)
RADEXAM(RADEX,PATIEN,RPT,FRDAT,TODAT) ;Radiology procedures, diagnosis, report for a patient
"RTN","SYNDHP55",197,0)
 ;Inputs: PATIEN - patient IEN
"RTN","SYNDHP55",198,0)
 ;        RPT - return report, 0=no, 1=yes
"RTN","SYNDHP55",199,0)
 ;Output: RADEX - array of radiology exams, by reference
"RTN","SYNDHP55",200,0)
 ;          PID^PatDfn^Category^ExamDate^ExamDateHl7^CASENBR^PROCIEN^PROC^CPT^SCT^PDIAGCD^REQPHYS^
"RTN","SYNDHP55",201,0)
 ;            PIRES^PISTAFF^VISITDT^VISITHL^EnteringUser
"RTN","SYNDHP55",202,0)
 ;
"RTN","SYNDHP55",203,0)
 S RADEX=""
"RTN","SYNDHP55",204,0)
 N S S S="_"
"RTN","SYNDHP55",205,0)
 N SEQ S SEQ=0
"RTN","SYNDHP55",206,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP55",207,0)
 N FNBR1 S FNBR1=70 ;RAD/NUC MED PATIENT FILE, this file DINUMed
"RTN","SYNDHP55",208,0)
 N FNBR2 S FNBR2=70.02 ;RAD/NUC MED PATIENT FILE:REGISTERED EXAMS
"RTN","SYNDHP55",209,0)
 N FNBR3 S FNBR3=70.03 ;RAD/NUC MED PATIENT FILE:REGISTERED EXAMS:EXAMINATIONS
"RTN","SYNDHP55",210,0)
 N FNBR4 S FNBR4=9000010 ;visit
"RTN","SYNDHP55",211,0)
 ;
"RTN","SYNDHP55",212,0)
 ;get patient record
"RTN","SYNDHP55",213,0)
 N IENS S IENS=PATIEN_","
"RTN","SYNDHP55",214,0)
 N RADRPT,PATARR,PATERR
"RTN","SYNDHP55",215,0)
 D GETS^DIQ(FNBR1,IENS,".01;.04;.06","EI","PATARR","PATERR")  ;specific fields
"RTN","SYNDHP55",216,0)
 ;I $G(DEBUG),$D(PATERR) W !,"FNBR1:",FNBR1,!,"IENS:",IENS,!,">>ERROR<<",! ZWRITE PATERR
"RTN","SYNDHP55",217,0)
 QUIT:$D(PATERR)
"RTN","SYNDHP55",218,0)
 N PatDfn S PatDfn=$G(PATARR(FNBR1,IENS,.01,"I")) ;patient dfn
"RTN","SYNDHP55",219,0)
 N CategoryCd S CategoryCd=$G(PATARR(FNBR1,IENS,.04,"I")) ;category code
"RTN","SYNDHP55",220,0)
 N Category S Category=$G(PATARR(FNBR1,IENS,.04,"E")) ;category
"RTN","SYNDHP55",221,0)
 N EnteringUserId S EnteringUserId=$G(PATARR(FNBR1,IENS,.06,"I")) ;user who entered patient
"RTN","SYNDHP55",222,0)
 N EnteringUser S EnteringUser=$G(PATARR(FNBR1,IENS,.06,"E")) ;user who entered patient
"RTN","SYNDHP55",223,0)
 ;get registered exams
"RTN","SYNDHP55",224,0)
 N REXIEN S REXIEN=0
"RTN","SYNDHP55",225,0)
 F  S REXIEN=$O(^RADPT(PATIEN,"DT",REXIEN)) QUIT:'+REXIEN  D
"RTN","SYNDHP55",226,0)
 . N IENS1 S IENS1=REXIEN_","_IENS
"RTN","SYNDHP55",227,0)
 . N REXARR,REXERR
"RTN","SYNDHP55",228,0)
 . D GETS^DIQ(FNBR2,IENS1,".01;2;3;4;5","EI","REXARR","REXERR")  ;specific fields
"RTN","SYNDHP55",229,0)
 . ;I $G(DEBUG),$D(REXERR) W !,">>ERROR<<",! ZWRITE REXERR
"RTN","SYNDHP55",230,0)
 . QUIT:$D(REXERR)
"RTN","SYNDHP55",231,0)
 . N ExamDate S ExamDate=$G(REXARR(FNBR2,IENS1,.01,"I")) ;exam date
"RTN","SYNDHP55",232,0)
 . QUIT:((ExamDate\1)<FRDAT)!((ExamDate\1)>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP55",233,0)
 . N ExamDateHl7 S ExamDateHl7=$$FMTHL7^XLFDT(ExamDate) ;hl7 format exam date
"RTN","SYNDHP55",234,0)
 . ;get examinations
"RTN","SYNDHP55",235,0)
 . N EXIEN S EXIEN=0
"RTN","SYNDHP55",236,0)
 . F  S EXIEN=$O(^RADPT(PATIEN,"DT",REXIEN,"P",EXIEN)) QUIT:'+EXIEN  D
"RTN","SYNDHP55",237,0)
 . . N CASENBR,PROCIEN,PROC,CPT,PIRES,PDIAGCD,REQPHYS,PISTAFF,RPTTEXT,VISITID,VISITDT,VISITHL,SCT,PID
"RTN","SYNDHP55",238,0)
 . . N IENS2 S IENS2=EXIEN_","_IENS1
"RTN","SYNDHP55",239,0)
 . . N EXARR,EXERR
"RTN","SYNDHP55",240,0)
 . . D GETS^DIQ(FNBR3,IENS2,".01;2;12;13;14;15;17;27","EI","EXARR","EXERR")  ;specific fields
"RTN","SYNDHP55",241,0)
 . . ;I $G(DEBUG),$D(EXERR) W !,">>ERROR<<",! ZWRITE EXERR
"RTN","SYNDHP55",242,0)
 . . QUIT:$D(EXERR)
"RTN","SYNDHP55",243,0)
 . . S CASENBR=$G(EXARR(FNBR3,IENS2,.01,"I")) ;case number
"RTN","SYNDHP55",244,0)
 . . S PROCIEN=$G(EXARR(FNBR3,IENS2,2,"I")) ;procedure ien
"RTN","SYNDHP55",245,0)
 . . S PROC=$G(EXARR(FNBR3,IENS2,2,"E")) ;procedure name
"RTN","SYNDHP55",246,0)
 . . S CPT=""
"RTN","SYNDHP55",247,0)
 . . S:PROCIEN'="" CPT=$$GET1^DIQ(71,PROCIEN_",",9) ;cpt code
"RTN","SYNDHP55",248,0)
 . . S PIRES=$G(EXARR(FNBR3,IENS2,12,"E")) ;primary interpreting resident
"RTN","SYNDHP55",249,0)
 . . S PDIAGCD=$G(EXARR(FNBR3,IENS2,13,"E")) ;primary diagnostic code
"RTN","SYNDHP55",250,0)
 . . S REQPHYS=$G(EXARR(FNBR3,IENS2,14,"E")) ;requesting physician
"RTN","SYNDHP55",251,0)
 . . S PISTAFF=$G(EXARR(FNBR3,IENS2,15,"E")) ;primary interpreting staff
"RTN","SYNDHP55",252,0)
 . . S RPTTEXT=$G(EXARR(FNBR3,IENS2,17,"I")) ;report text (pointer to file 74)
"RTN","SYNDHP55",253,0)
 . . S VISITID=$G(EXARR(FNBR3,IENS2,27)) ;visit id
"RTN","SYNDHP55",254,0)
 . . S VISITDT=""
"RTN","SYNDHP55",255,0)
 . . S:VISITID'="" VISITDT=$$GET1^DIQ(FNBR4,VISITID_",",.01,"I") ;visit/admit date&time
"RTN","SYNDHP55",256,0)
 . . S VISITHL=$$FMTHL7^XLFDT(VISITDT) ;hl7 format visit/admit date&time
"RTN","SYNDHP55",257,0)
 . . S PID=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_PATIEN_S_FNBR2_S_REXIEN_S_FNBR3_S_EXIEN
"RTN","SYNDHP55",258,0)
 . . ;LOOKUP SNOMED(sct) - cpt, os5
"RTN","SYNDHP55",259,0)
 . . S SCT=""
"RTN","SYNDHP55",260,0)
 . . ;map cpt to snomed (currently uses very small map)
"RTN","SYNDHP55",261,0)
 . . I CPT'="" D
"RTN","SYNDHP55",262,0)
 . . . S SCT=$$MAP^SYNDHPMP("sct2cpt",CPT,"I")
"RTN","SYNDHP55",263,0)
 . . . S SCT=$S(+SCT=-1:"",1:$P(SCT,U,2))
"RTN","SYNDHP55",264,0)
 . . ;if no cpt hit, map os5 to snomed
"RTN","SYNDHP55",265,0)
 . . I SCT="",CPT'="" D
"RTN","SYNDHP55",266,0)
 . . . S SCT=$$MAP^SYNDHPMP("sct2os5",CPT,"I")
"RTN","SYNDHP55",267,0)
 . . . S SCT=$S(+SCT=-1:"",1:$P(SCT,U,2))
"RTN","SYNDHP55",268,0)
 . . ;
"RTN","SYNDHP55",269,0)
 . . I $G(DEBUG) D
"RTN","SYNDHP55",270,0)
 . . . W !,"Patient: ",?32,PatDfn,!
"RTN","SYNDHP55",271,0)
 . . . W "Category: ",?32,CategoryCd,"     ",Category,!
"RTN","SYNDHP55",272,0)
 . . . W "Exam Date: ",?32,ExamDate,"     ",ExamDateHl7,!
"RTN","SYNDHP55",273,0)
 . . . W "Case Number: ",?32,CASENBR,!
"RTN","SYNDHP55",274,0)
 . . . W "Procedure: ",?32,PROCIEN,"     ",PROC,!
"RTN","SYNDHP55",275,0)
 . . . W "CPT: ",?32,CPT,!
"RTN","SYNDHP55",276,0)
 . . . W "SCT: ",?32,SCT,!
"RTN","SYNDHP55",277,0)
 . . . W "Requesting physician: ",?32,REQPHYS,!
"RTN","SYNDHP55",278,0)
 . . . W "Primary diagnostic code: ",?32,PDIAGCD,!
"RTN","SYNDHP55",279,0)
 . . . W "Primary interpreting resident: ",?32,PIRES,!
"RTN","SYNDHP55",280,0)
 . . . W "Primary interpreting staff: ",?32,PISTAFF,!
"RTN","SYNDHP55",281,0)
 . . . W "Pointer to report text:",?32,RPTTEXT,!
"RTN","SYNDHP55",282,0)
 . . . W "Visit Date: ",?32,VISITDT,"     ",VISITHL,!
"RTN","SYNDHP55",283,0)
 . . . W "PID: ",?32,PID,!
"RTN","SYNDHP55",284,0)
 . . ;PID^PatDfn^Category^ExamDate^ExamDateHl7^CASENBR^PROCIEN^PROC^CPT^SCT^PDIAGCD^REQPHYS^PIRES^PISTAFF^VISITDT^VISITHL^EnteringUser
"RTN","SYNDHP55",285,0)
 . . S SEQ=SEQ+1
"RTN","SYNDHP55",286,0)
 . . S RADEX(SEQ)=PID_U_PatDfn_U_Category_U_ExamDate_U_ExamDateHl7_U_CASENBR_U_PROCIEN_U_PROC_U_CPT_U_SCT_U_PDIAGCD_U_REQPHYS_U_PIRES_U_PISTAFF_U_VISITDT_U_VISITHL_U_EnteringUser
"RTN","SYNDHP55",287,0)
 . . ;
"RTN","SYNDHP55",288,0)
 . . I $G(RPT),RPTTEXT'="" D
"RTN","SYNDHP55",289,0)
 . . . D GETRPT(.RADRPT,RPTTEXT,SITE,SEQ,FRDAT,TODAT)
"RTN","SYNDHP55",290,0)
 . . . M RADEX(SEQ)=RADRPT(SEQ)
"RTN","SYNDHP55",291,0)
 ;
"RTN","SYNDHP55",292,0)
 ;I $G(DEBUG) W ! ZWRITE RADEX
"RTN","SYNDHP55",293,0)
 ;
"RTN","SYNDHP55",294,0)
 QUIT
"RTN","SYNDHP55",295,0)
 ;
"RTN","SYNDHP55",296,0)
GETRPT(RADRPT,RPTTEXT,SITE,SEQ,FRDAT,TODAT) ; get radiology diagnostic report
"RTN","SYNDHP55",297,0)
 ; Inputs: RPTTEXT - radiology diagnostic report IEN from file #70
"RTN","SYNDHP55",298,0)
 ;         SITE - station number
"RTN","SYNDHP55",299,0)
 ;         SEQ - record sequence
"RTN","SYNDHP55",300,0)
 ; Output: RADRPT array
"RTN","SYNDHP55",301,0)
 ;         RADRPT(1) - PID^dayCase^dateTime^dateTimeHL7^status id^status^verifying physician id^verifying physician name
"RTN","SYNDHP55",302,0)
 ;         RADRPT("REPORT")=report
"RTN","SYNDHP55",303,0)
 ;         RADRPT("IMPRESSION")=impression
"RTN","SYNDHP55",304,0)
 ;
"RTN","SYNDHP55",305,0)
 N FNUM S FNUM=74
"RTN","SYNDHP55",306,0)
 I $G(DEBUG) W "<Radiology Report>"
"RTN","SYNDHP55",307,0)
 N DAYCASE,PRSTA,PRSTATUS,PPROV,PPROVNM,PDATE,PDATEHL
"RTN","SYNDHP55",308,0)
 N PID S PID=$$RESID^SYNDHP69("V",SITE)_"_"_FNUM_"_"_RPTTEXT
"RTN","SYNDHP55",309,0)
 N PIENS S PIENS=RPTTEXT_","
"RTN","SYNDHP55",310,0)
 N EXARR,EXERR
"RTN","SYNDHP55",311,0)
 D GETS^DIQ(FNUM,PIENS,".01;3;5;9;113","EI","EXARR","EXERR")  ;specific fields
"RTN","SYNDHP55",312,0)
 ;I $G(DEBUG),$D(EXERR) W !,">>ERROR<<",! ZWRITE EXERR
"RTN","SYNDHP55",313,0)
 QUIT:$D(EXERR)
"RTN","SYNDHP55",314,0)
 S PDATE=$G(EXARR(FNUM,PIENS,3,"I")) ;exam date/time
"RTN","SYNDHP55",315,0)
 QUIT:((PDATE\1)<FRDAT)!((PDATE\1)>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP55",316,0)
 S PDATEHL=$$FMTHL7^XLFDT(PDATE) ;exam date/time HL7
"RTN","SYNDHP55",317,0)
 S DAYCASE=$G(EXARR(FNUM,PIENS,.01,"I")) ;day case#
"RTN","SYNDHP55",318,0)
 S PRSTA=$G(EXARR(FNUM,PIENS,5,"I")) ;report status
"RTN","SYNDHP55",319,0)
 S PRSTATUS=$G(EXARR(FNUM,PIENS,5,"E")) ;report status
"RTN","SYNDHP55",320,0)
 ;S PRSTA=$S(PRSTA="V":"final",PRSTA="D":"partial",1:"unknown") ; there are other possible values
"RTN","SYNDHP55",321,0)
 S PPROV=$G(EXARR(FNUM,PIENS,9,"I")) ;verifying physician ien
"RTN","SYNDHP55",322,0)
 S PPROVNM=$G(EXARR(FNUM,PIENS,9,"E")) ;verifying physician name
"RTN","SYNDHP55",323,0)
 ;
"RTN","SYNDHP55",324,0)
 N REPORT,IMPRESS,RPTTEXT,IMPTEXT,RPTLINE,IMPLINE
"RTN","SYNDHP55",325,0)
 S RPTTEXT=""
"RTN","SYNDHP55",326,0)
 S IMPTEXT=""
"RTN","SYNDHP55",327,0)
 D GETS^DIQ(FNUM,PIENS,200,,"REPORT","EXERR")
"RTN","SYNDHP55",328,0)
 ;I $G(DEBUG),$D(EXERR) W !,">>ERROR<<",! ZWRITE EXERR
"RTN","SYNDHP55",329,0)
 QUIT:$D(EXERR)
"RTN","SYNDHP55",330,0)
 N N S N=0
"RTN","SYNDHP55",331,0)
 F  S N=$O(REPORT(FNUM,PIENS,200,N)) Q:N=""  D
"RTN","SYNDHP55",332,0)
 . S RPTLINE=REPORT(FNUM,PIENS,200,N)
"RTN","SYNDHP55",333,0)
 . S RPTTEXT=RPTTEXT_RPTLINE
"RTN","SYNDHP55",334,0)
 N EXERR
"RTN","SYNDHP55",335,0)
 D GETS^DIQ(FNUM,PIENS,300,,"IMPRESS","EXERR")
"RTN","SYNDHP55",336,0)
 ;I $G(DEBUG),$D(EXERR) W !,">>ERROR<<",! ZWRITE EXERR
"RTN","SYNDHP55",337,0)
 QUIT:$D(EXERR)
"RTN","SYNDHP55",338,0)
 N N S N=0
"RTN","SYNDHP55",339,0)
 F  S N=$O(IMPRESS(FNUM,PIENS,300,N)) Q:N=""  D
"RTN","SYNDHP55",340,0)
 . S IMPLINE=IMPRESS(FNUM,PIENS,300,N)
"RTN","SYNDHP55",341,0)
 . S IMPTEXT=IMPTEXT_IMPLINE
"RTN","SYNDHP55",342,0)
 ;
"RTN","SYNDHP55",343,0)
 I $G(DEBUG) D
"RTN","SYNDHP55",344,0)
 . W !,"Exam Date/Time:",?25,PDATE,"     ",PDATEHL,!
"RTN","SYNDHP55",345,0)
 . W "Day-Case#:",?25,DAYCASE,!
"RTN","SYNDHP55",346,0)
 . W "Report Status:",?25,PRSTA,"     ",PRSTATUS,!
"RTN","SYNDHP55",347,0)
 . W "Verifying Physician:",?25,PPROV,"     ",PPROVNM,!
"RTN","SYNDHP55",348,0)
 . W "Report:",?25,RPTTEXT,!
"RTN","SYNDHP55",349,0)
 . W "Impression:",?25,IMPTEXT,!
"RTN","SYNDHP55",350,0)
 S RADRPT(SEQ,1)=PID_U_DAYCASE_U_PDATE_U_PDATEHL_U_PRSTA_U_PRSTATUS_U_PPROV_U_PPROVNM
"RTN","SYNDHP55",351,0)
 S RADRPT(SEQ,"REPORT")=RPTTEXT
"RTN","SYNDHP55",352,0)
 S RADRPT(SEQ,"IMPRESSION")=IMPTEXT
"RTN","SYNDHP55",353,0)
 ;
"RTN","SYNDHP55",354,0)
 QUIT
"RTN","SYNDHP55",355,0)
 ;
"RTN","SYNDHP56")
0^49^B92343991
"RTN","SYNDHP56",1,0)
SYNDHP56 ; HC/ART - HealthConcourse - retrieve patient mental health observations ;05/04/2019
"RTN","SYNDHP56",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP56",3,0)
 ;;
"RTN","SYNDHP56",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP56",5,0)
 ;
"RTN","SYNDHP56",6,0)
 QUIT
"RTN","SYNDHP56",7,0)
 ;
"RTN","SYNDHP56",8,0)
 ; ---------------- Get patient Observations ----------------------
"RTN","SYNDHP56",9,0)
 ;  MH Administrations
"RTN","SYNDHP56",10,0)
 ;  GAF
"RTN","SYNDHP56",11,0)
 ;
"RTN","SYNDHP56",12,0)
PATOBS(RETSTA,NAME,SSN,DOB,GENDER,FRDAT,TODAT) ; get Observations for a patient by traits
"RTN","SYNDHP56",13,0)
 S RETSTA="-1^This service has been retired"
"RTN","SYNDHP56",14,0)
 QUIT
"RTN","SYNDHP56",15,0)
 ; Return patient Observations for name, SSN, DOB, and gender
"RTN","SYNDHP56",16,0)
 ;
"RTN","SYNDHP56",17,0)
 ; Input:
"RTN","SYNDHP56",18,0)
 ;   NAME    - patient name
"RTN","SYNDHP56",19,0)
 ;   SSN     - social security number
"RTN","SYNDHP56",20,0)
 ;   DOB     - date of birth
"RTN","SYNDHP56",21,0)
 ;   GENDER  - gender
"RTN","SYNDHP56",22,0)
 ;   FRDAT   - from date (inclusive), optional, compared to date given (MH) date/time of diagnosis (GAF)
"RTN","SYNDHP56",23,0)
 ;   TODAT   - to date (inclusive), optional, compared to date given (MH) date/time of diagnosis (GAF)
"RTN","SYNDHP56",24,0)
 ; Output:
"RTN","SYNDHP56",25,0)
 ;   RETSTA  - a delimited string that lists LOINC and SNOMED CT codes for the patient Observations
"RTN","SYNDHP56",26,0)
 ;           - ICN^SCT code|descrption|LOINC code|description|instrument name|date given|clinic name|ordered by|scale:score|identifier
"RTN","SYNDHP56",27,0)
 ;
"RTN","SYNDHP56",28,0)
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
"RTN","SYNDHP56",29,0)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
"RTN","SYNDHP56",30,0)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
"RTN","SYNDHP56",31,0)
 ;
"RTN","SYNDHP56",32,0)
 N C,P,S,ZARR,ICNST,DHPICN,PATIEN
"RTN","SYNDHP56",33,0)
 ;
"RTN","SYNDHP56",34,0)
 S C=",",P="|",S="_"
"RTN","SYNDHP56",35,0)
 D PATVAL^SYNDHP43(.ICNST,NAME,SSN,DOB,GENDER)
"RTN","SYNDHP56",36,0)
 I +ICNST'=1 S RETSTA=ICNST QUIT
"RTN","SYNDHP56",37,0)
 ; if we are here we are dealing with a valid patient
"RTN","SYNDHP56",38,0)
 S DHPICN=$P(ICNST,U,3)
"RTN","SYNDHP56",39,0)
 ; get patient IEN from ICN
"RTN","SYNDHP56",40,0)
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP56",41,0)
 ;
"RTN","SYNDHP56",42,0)
 S RETSTA=DHPICN
"RTN","SYNDHP56",43,0)
 D GET(.RETSTA,PATIEN,FRDAT,TODAT)
"RTN","SYNDHP56",44,0)
 ;
"RTN","SYNDHP56",45,0)
 QUIT
"RTN","SYNDHP56",46,0)
 ;
"RTN","SYNDHP56",47,0)
PATOBSI(RETSTA,DHPICN,FRDAT,TODAT) ; Patient Observations for ICN
"RTN","SYNDHP56",48,0)
 ;
"RTN","SYNDHP56",49,0)
 ; Return patient Observations for a given patient ICN
"RTN","SYNDHP56",50,0)
 ;
"RTN","SYNDHP56",51,0)
 ; Input:
"RTN","SYNDHP56",52,0)
 ;   ICN     - unique patient identifier across all VistA systems
"RTN","SYNDHP56",53,0)
 ;   FRDAT   - from date (inclusive), optional, compared to date given (MH) date/time of diagnosis (GAF)
"RTN","SYNDHP56",54,0)
 ;   TODAT   - to date (inclusive), optional, compared to date given (MH) date/time of diagnosis (GAF)
"RTN","SYNDHP56",55,0)
 ; Output:
"RTN","SYNDHP56",56,0)
 ;   RETSTA  - a delimited string that lists LOINC and SNOMED CT codes for the patient Observations
"RTN","SYNDHP56",57,0)
 ;           - ICN^LOINC code|description|SCT code|description|Instrument Name|date given|clinic name|ordered by|scale:score|resource ID^...
"RTN","SYNDHP56",58,0)
 ;
"RTN","SYNDHP56",59,0)
 ; validate ICN
"RTN","SYNDHP56",60,0)
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
"RTN","SYNDHP56",61,0)
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" Q
"RTN","SYNDHP56",62,0)
 ; 
"RTN","SYNDHP56",63,0)
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
"RTN","SYNDHP56",64,0)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
"RTN","SYNDHP56",65,0)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
"RTN","SYNDHP56",66,0)
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
"RTN","SYNDHP56",67,0)
 ;
"RTN","SYNDHP56",68,0)
 N C,P,S,ZARR,PATIEN
"RTN","SYNDHP56",69,0)
 S C=",",P="|",S="_"
"RTN","SYNDHP56",70,0)
 ; get patient IEN from ICN
"RTN","SYNDHP56",71,0)
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP56",72,0)
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
"RTN","SYNDHP56",73,0)
 ;
"RTN","SYNDHP56",74,0)
 S RETSTA=DHPICN
"RTN","SYNDHP56",75,0)
 D GET(.RETSTA,PATIEN,FRDAT,TODAT)
"RTN","SYNDHP56",76,0)
 ;
"RTN","SYNDHP56",77,0)
 QUIT
"RTN","SYNDHP56",78,0)
 ;
"RTN","SYNDHP56",79,0)
GET(RETSTA,PATIEN,FRDAT,TODAT) ;
"RTN","SYNDHP56",80,0)
 ;
"RTN","SYNDHP56",81,0)
 ;Mental Health Observations (Assessments/Administrations)
"RTN","SYNDHP56",82,0)
 S RETSTA=RETSTA_$$MHOBS(PATIEN,FRDAT,TODAT)
"RTN","SYNDHP56",83,0)
 ;
"RTN","SYNDHP56",84,0)
 ;GAF (Global Assessment of Functioning)
"RTN","SYNDHP56",85,0)
 S RETSTA=RETSTA_$$GAFOBS(PATIEN,FRDAT,TODAT)
"RTN","SYNDHP56",86,0)
 ;
"RTN","SYNDHP56",87,0)
 QUIT
"RTN","SYNDHP56",88,0)
 ;
"RTN","SYNDHP56",89,0)
 ;
"RTN","SYNDHP56",90,0)
MHOBS(PATIEN,FRDAT,TODAT) ;Mental Health Observations
"RTN","SYNDHP56",91,0)
 ;patient's MH administration results - observation
"RTN","SYNDHP56",92,0)
 ;
"RTN","SYNDHP56",93,0)
 N PROCS,SERPROCS,SEQ,FNBR1,FNBR2
"RTN","SYNDHP56",94,0)
 N ADMINIEN,ADMINNBR,INSTID,INSTNAME,GIVDATE,GIVDATEHL,PROVO,PROVA,LOCID,LOCATION,SCALE,SCORE,PROVNAMO,PROVNAMA
"RTN","SYNDHP56",95,0)
 N SNOMED,SDESC,LOINC,LDESC,MH2LOINC,LOINC2MH,MH2SNOMED,SCT
"RTN","SYNDHP56",96,0)
 N RESIEN,RIENS
"RTN","SYNDHP56",97,0)
 N YS,YSRET,YSSEQ
"RTN","SYNDHP56",98,0)
 ;
"RTN","SYNDHP56",99,0)
 N USER S USER=$$DUZ^SYNDHP69
"RTN","SYNDHP56",100,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP56",101,0)
 S PROCS=""
"RTN","SYNDHP56",102,0)
 S FNBR1=601.84 ;administrations
"RTN","SYNDHP56",103,0)
 S FNBR2=601.92 ;administration results
"RTN","SYNDHP56",104,0)
 ;D LOADREF(.MH2LOINC,.LOINC2MH,.MH2SNOMED)  ;load temporary code arrays
"RTN","SYNDHP56",105,0)
 S SEQ=0
"RTN","SYNDHP56",106,0)
 ;
"RTN","SYNDHP56",107,0)
 S YS("DFN")=PATIEN
"RTN","SYNDHP56",108,0)
 S YS("COMPLETE")="Y"
"RTN","SYNDHP56",109,0)
 D ADMINS^YTQAPI5(.YSRET,.YS)  ;call MH API
"RTN","SYNDHP56",110,0)
 I $G(DEBUG) D
"RTN","SYNDHP56",111,0)
 . W !,"Mental Health",!!
"RTN","SYNDHP56",112,0)
 . ;W ";                 1        2          3         4          5       6       7      8         9       10         11            12        13           14           15",!
"RTN","SYNDHP56",113,0)
 . ;W ";MH API output:Adm. ID^Inst. Name^Date Given^Date Saved^Orderer^Admin.By^Signed^# Answers^R_Privl^Is Legacy^INSTRUMENT id^Test IENS^copyright^location iens^DAY RESTART",!
"RTN","SYNDHP56",114,0)
 . ;ZWRITE YSRET
"RTN","SYNDHP56",115,0)
 . W "Adm. ID^Inst. Name^Date Given^Date Saved^Orderer^Admin.By^Signed^# Answers^R_Privl^Is Legacy^INSTRUMENT id^Test IENS^copyright^location iens^DAY RESTART",!
"RTN","SYNDHP56",116,0)
 QUIT:YSRET(1)["[ERROR]" SERPROCS
"RTN","SYNDHP56",117,0)
 S YSSEQ=2
"RTN","SYNDHP56",118,0)
 F  S YSSEQ=$O(YSRET(YSSEQ)) Q:YSSEQ=""  D
"RTN","SYNDHP56",119,0)
 . S ADMINNBR=$P(YSRET(YSSEQ),U,1) ;administration number
"RTN","SYNDHP56",120,0)
 . QUIT:ADMINNBR=""
"RTN","SYNDHP56",121,0)
 . S INSTNAME=$P(YSRET(YSSEQ),U,2) ;instrument name
"RTN","SYNDHP56",122,0)
 . S INSTID=$O(^YTT(601.71,"B",INSTNAME,"")) ;instrument id
"RTN","SYNDHP56",123,0)
 . S GIVDATE=$P(YSRET(YSSEQ),U,3) ;date given
"RTN","SYNDHP56",124,0)
 . QUIT:((GIVDATE\1)<FRDAT)!((GIVDATE\1)>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP56",125,0)
 . S GIVDATEHL=$$FMTHL7^XLFDT(GIVDATE) ;hl7 format date given
"RTN","SYNDHP56",126,0)
 . S PROVO=$P(YSRET(YSSEQ),U,5) ;ordered by
"RTN","SYNDHP56",127,0)
 . S:+PROVO PROVNAMO=$$GET1^DIQ(200,PROVO_",",.01) ;ordered by
"RTN","SYNDHP56",128,0)
 . S PROVA=$P(YSRET(YSSEQ),U,6) ;administered by
"RTN","SYNDHP56",129,0)
 . S:+PROVA PROVNAMA=$$GET1^DIQ(200,PROVA_",",.01) ;administered by
"RTN","SYNDHP56",130,0)
 . S LOCID=$P(YSRET(YSSEQ),U,14) ;location ien
"RTN","SYNDHP56",131,0)
 . S LOCATION=$$GET1^DIQ(44,LOCID_",",.01) ;location
"RTN","SYNDHP56",132,0)
 . ;get administration results
"RTN","SYNDHP56",133,0)
 . S RESULT=""
"RTN","SYNDHP56",134,0)
 . S RESIEN=""
"RTN","SYNDHP56",135,0)
 . F  S RESIEN=$O(^YTT(601.92,"AC",ADMINNBR,RESIEN)) Q:RESIEN=""  D
"RTN","SYNDHP56",136,0)
 . . S RIENS=RESIEN_","
"RTN","SYNDHP56",137,0)
 . . S SCALE=$$GET1^DIQ(FNBR2,RIENS,2) ;scale
"RTN","SYNDHP56",138,0)
 . . S SCORE=$$GET1^DIQ(FNBR2,RIENS,3) ;raw score
"RTN","SYNDHP56",139,0)
 . . S RESULT=SCALE_":"_SCORE
"RTN","SYNDHP56",140,0)
 . . S PID=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_ADMINNBR_S_FNBR2_S_RESIEN
"RTN","SYNDHP56",141,0)
 . . ;
"RTN","SYNDHP56",142,0)
 . . ;Look-up LOINC CODE & SNOMED CT code
"RTN","SYNDHP56",143,0)
 . . S LDESC=INSTNAME_" Result"
"RTN","SYNDHP56",144,0)
 . . S SDESC=INSTNAME_" Result"
"RTN","SYNDHP56",145,0)
 . . S LOINC=""
"RTN","SYNDHP56",146,0)
 . . I INSTID'="" D
"RTN","SYNDHP56",147,0)
 . . . S LOINC=$$MAP^SYNDHPMP("mh2loinc",INSTID,"D")
"RTN","SYNDHP56",148,0)
 . . . S LOINC=$S(+LOINC=-1:"",1:$P(LOINC,U,2))
"RTN","SYNDHP56",149,0)
 . . I LOINC="",INSTNAME'="" D
"RTN","SYNDHP56",150,0)
 . . . S LOINC=$$MAP^SYNDHPMP("mh2loinc",INSTNAME,"D")
"RTN","SYNDHP56",151,0)
 . . . S LOINC=$S(+LOINC=-1:"",1:$P(LOINC,U,2))
"RTN","SYNDHP56",152,0)
 . . S SCT=""
"RTN","SYNDHP56",153,0)
 . . I INSTID'="" D
"RTN","SYNDHP56",154,0)
 . . . S SCT=$$MAP^SYNDHPMP("mh2sct",INSTID,"D")
"RTN","SYNDHP56",155,0)
 . . . S SCT=$S(+SCT=-1:"",1:$P(SCT,U,2))
"RTN","SYNDHP56",156,0)
 . . I SCT="",INSTNAME'="" D
"RTN","SYNDHP56",157,0)
 . . . S SCT=$$MAP^SYNDHPMP("mh2sct",INSTNAME,"D")
"RTN","SYNDHP56",158,0)
 . . . S SCT=$S(+SCT=-1:"",1:$P(SCT,U,2))
"RTN","SYNDHP56",159,0)
 . . ;
"RTN","SYNDHP56",160,0)
 . . I $G(DEBUG) D
"RTN","SYNDHP56",161,0)
 . . . W !,"Admin Number:    ",ADMINNBR,!
"RTN","SYNDHP56",162,0)
 . . . W "Instrument:      ",INSTID,"     ",INSTNAME,!
"RTN","SYNDHP56",163,0)
 . . . W "Date Given:      ",GIVDATE,"     ",GIVDATEHL,!
"RTN","SYNDHP56",164,0)
 . . . W "Ordered by:      ",PROVO,"     ",PROVNAMO,!
"RTN","SYNDHP56",165,0)
 . . . W "Administered by: ",PROVA,"     ",PROVNAMA,!
"RTN","SYNDHP56",166,0)
 . . . W "Location:        ",LOCID,"     ",LOCATION,!
"RTN","SYNDHP56",167,0)
 . . . W "Results:     ",RESULT,!
"RTN","SYNDHP56",168,0)
 . . . W "LOINC Code:  ",LOINC,!
"RTN","SYNDHP56",169,0)
 . . . W "SNOMED Code: ",SCT,!
"RTN","SYNDHP56",170,0)
 . . . W "Description: ",SDESC,!
"RTN","SYNDHP56",171,0)
 . . ;
"RTN","SYNDHP56",172,0)
 . . ;record is created for each result for an instrument administration
"RTN","SYNDHP56",173,0)
 . . ;LOINC code|description|SCT code|descrption|Instrument Name|date given|clinic name|ordered by|scale:score|resource id
"RTN","SYNDHP56",174,0)
 . . S SEQ=SEQ+1
"RTN","SYNDHP56",175,0)
 . . S PROCS(SEQ)=U_LOINC_P_LDESC_P_SCT_P_SDESC_P_INSTNAME_P_GIVDATEHL_P_LOCATION_P_PROVNAMO_P_RESULT_P_PID
"RTN","SYNDHP56",176,0)
 ;
"RTN","SYNDHP56",177,0)
 ;I $G(DEBUG) W ! ZWRITE PROCS
"RTN","SYNDHP56",178,0)
 ;serialize data
"RTN","SYNDHP56",179,0)
 S SERPROCS=""
"RTN","SYNDHP56",180,0)
 S SEQ=""
"RTN","SYNDHP56",181,0)
 F  S SEQ=$O(PROCS(SEQ)) QUIT:SEQ=""  D
"RTN","SYNDHP56",182,0)
 . S SERPROCS=SERPROCS_PROCS(SEQ)
"RTN","SYNDHP56",183,0)
 ;
"RTN","SYNDHP56",184,0)
 ;I $G(DEBUG) W ! ZWRITE SERPROCS
"RTN","SYNDHP56",185,0)
 ;
"RTN","SYNDHP56",186,0)
 QUIT SERPROCS
"RTN","SYNDHP56",187,0)
 ;
"RTN","SYNDHP56",188,0)
GAFOBS(PATIEN,FRDAT,TODAT) ;get GAF score
"RTN","SYNDHP56",189,0)
 ;
"RTN","SYNDHP56",190,0)
 N PROCS,SERPROCS,SEQ,FNBR1,MHIEN,IENS
"RTN","SYNDHP56",191,0)
 N FILEDTFM,FILEDT,FILEDTHL,GAFDTFM,GAFDT,GAFDTHL,GAFBYID,GAFBY,TRANSCID,TRANSCR,GAF,RESULT,PID
"RTN","SYNDHP56",192,0)
 N SNOMED,SDESC,LOINC,LDESC,DESC,PATTYPE
"RTN","SYNDHP56",193,0)
 ;
"RTN","SYNDHP56",194,0)
 N USER S USER=$$DUZ^SYNDHP69
"RTN","SYNDHP56",195,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP56",196,0)
 S (SNOMED,LOINC)=""
"RTN","SYNDHP56",197,0)
 S (SDESC,LDESC)="GAF"
"RTN","SYNDHP56",198,0)
 S DESC="Global Assessment of Functioning"
"RTN","SYNDHP56",199,0)
 ;
"RTN","SYNDHP56",200,0)
 I $G(DEBUG) W !,"GAF - Global Assessment of Functioning",!!
"RTN","SYNDHP56",201,0)
 S PROCS=""
"RTN","SYNDHP56",202,0)
 S FNBR1=627.8 ;Diagnostic Results-Mental Health
"RTN","SYNDHP56",203,0)
 S SEQ=0
"RTN","SYNDHP56",204,0)
 ;
"RTN","SYNDHP56",205,0)
 S MHIEN=""
"RTN","SYNDHP56",206,0)
 F  S MHIEN=$O(^YSD(627.8,"C",PATIEN,MHIEN)) QUIT:MHIEN=""  D
"RTN","SYNDHP56",207,0)
 . S IENS=MHIEN_","
"RTN","SYNDHP56",208,0)
 . S GAF=$$GET1^DIQ(FNBR1,IENS,65) ;axis 5 (GAF)
"RTN","SYNDHP56",209,0)
 . QUIT:GAF=""
"RTN","SYNDHP56",210,0)
 . S FILEDTFM=$$GET1^DIQ(FNBR1,IENS,.01,"I") ;file entry date fm format
"RTN","SYNDHP56",211,0)
 . S FILEDT=$$GET1^DIQ(FNBR1,IENS,.01) ;file entry date
"RTN","SYNDHP56",212,0)
 . S FILEDTHL=$$FMTHL7^XLFDT(FILEDTFM) ;hl7 format file entry date
"RTN","SYNDHP56",213,0)
 . S GAFDT=$$GET1^DIQ(FNBR1,IENS,.03) ;date/time of diagnosis
"RTN","SYNDHP56",214,0)
 . S GAFDTFM=$$GET1^DIQ(FNBR1,IENS,.03,"I") ;date/time of diagnosis fm format
"RTN","SYNDHP56",215,0)
 . QUIT:((GAFDTFM\1)<FRDAT)!((GAFDTFM\1)>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP56",216,0)
 . S GAFDTHL=$$FMTHL7^XLFDT(GAFDTFM) ;hl7 format date/time of diagnosis
"RTN","SYNDHP56",217,0)
 . S GAFBYID=$$GET1^DIQ(FNBR1,IENS,.04,"I") ;diagnosed by ien
"RTN","SYNDHP56",218,0)
 . S GAFBY=$$GET1^DIQ(FNBR1,IENS,.04) ;diagnosed by
"RTN","SYNDHP56",219,0)
 . S TRANSCID=$$GET1^DIQ(FNBR1,IENS,.05,"I") ;transcriber ien
"RTN","SYNDHP56",220,0)
 . S TRANSCR=$$GET1^DIQ(FNBR1,IENS,.05) ;transcriber
"RTN","SYNDHP56",221,0)
 . S RESULT="GAF Scale:"_GAF
"RTN","SYNDHP56",222,0)
 . S PATTYPE=$$GET1^DIQ(FNBR1,IENS,66,"I") ;patient type
"RTN","SYNDHP56",223,0)
 . S PID=$$RESID^SYNDHP69("V",SITE)_S_FNBR1_S_MHIEN
"RTN","SYNDHP56",224,0)
 . I $G(DEBUG) D
"RTN","SYNDHP56",225,0)
 . . W "File Date Time: ",FILEDTFM,"     ",FILEDT,"     ",FILEDTHL,!
"RTN","SYNDHP56",226,0)
 . . W "GAF Date Time:  ",GAFDTFM,"     ",GAFDT,"     ",GAFDTHL,!
"RTN","SYNDHP56",227,0)
 . . W "Diagnosis by:   ",GAFBYID,"     ",GAFBY,!
"RTN","SYNDHP56",228,0)
 . . W "Transcriber:    ",TRANSCID,"     ",TRANSCR,!
"RTN","SYNDHP56",229,0)
 . . W "Patient Type:   ",PATTYPE,!
"RTN","SYNDHP56",230,0)
 . . W "Result:         ",RESULT,!
"RTN","SYNDHP56",231,0)
 . . W "LOINC Code:  ",LOINC,!
"RTN","SYNDHP56",232,0)
 . . W "SNOMED Code: ",SNOMED,!
"RTN","SYNDHP56",233,0)
 . . W "Description: ",SDESC,!
"RTN","SYNDHP56",234,0)
 . ;LOINC code|description|SCT code|descrption|Instrument Name|date given|clinic name|ordered by|scale:score|identifier
"RTN","SYNDHP56",235,0)
 . S SEQ=SEQ+1
"RTN","SYNDHP56",236,0)
 . S PROCS(SEQ)=U_LOINC_P_LDESC_P_SNOMED_P_SDESC_P_DESC_P_GAFDTHL_P_""_P_GAFBY_P_RESULT_P_PID
"RTN","SYNDHP56",237,0)
 ;
"RTN","SYNDHP56",238,0)
 ;I $G(DEBUG) W ! ZWRITE PROCS
"RTN","SYNDHP56",239,0)
 ;
"RTN","SYNDHP56",240,0)
 ;serialize data
"RTN","SYNDHP56",241,0)
 S SERPROCS=""
"RTN","SYNDHP56",242,0)
 S SEQ=""
"RTN","SYNDHP56",243,0)
 F  S SEQ=$O(PROCS(SEQ)) QUIT:SEQ=""  D
"RTN","SYNDHP56",244,0)
 . S SERPROCS=SERPROCS_PROCS(SEQ)
"RTN","SYNDHP56",245,0)
 ;
"RTN","SYNDHP56",246,0)
 ;I $G(DEBUG) W ! ZWRITE SERPROCS
"RTN","SYNDHP56",247,0)
 ;
"RTN","SYNDHP56",248,0)
 QUIT SERPROCS
"RTN","SYNDHP56",249,0)
 ;
"RTN","SYNDHP56",250,0)
 ; ----------- Unit Test -----------
"RTN","SYNDHP56",251,0)
T1 ;
"RTN","SYNDHP56",252,0)
 N ICN S ICN="5000000352V586511"
"RTN","SYNDHP56",253,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP56",254,0)
 N TODAT S TODAT=""
"RTN","SYNDHP56",255,0)
 N RETSTA
"RTN","SYNDHP56",256,0)
 D PATOBSI(.RETSTA,ICN,FRDAT,TODAT)
"RTN","SYNDHP56",257,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP56",258,0)
 QUIT
"RTN","SYNDHP56",259,0)
 ;
"RTN","SYNDHP57")
0^7^B81356532
"RTN","SYNDHP57",1,0)
SYNDHP57 ; HC/fjf/art - HealthConcourse - get patient allergies ;05/07/2019
"RTN","SYNDHP57",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP57",3,0)
 ;;
"RTN","SYNDHP57",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP57",5,0)
 ;
"RTN","SYNDHP57",6,0)
 QUIT
"RTN","SYNDHP57",7,0)
 ;
"RTN","SYNDHP57",8,0)
 ; ---------------- Get patient allergies ------------------------------
"RTN","SYNDHP57",9,0)
 ;
"RTN","SYNDHP57",10,0)
PATALLI(RETSTA,DHPICN,FRDAT,TODAT,RETJSON) ; Patient allergies for ICN
"RTN","SYNDHP57",11,0)
 ;
"RTN","SYNDHP57",12,0)
 ; Return patient allergies for a given patient ICN
"RTN","SYNDHP57",13,0)
 ;
"RTN","SYNDHP57",14,0)
 ; Input:
"RTN","SYNDHP57",15,0)
 ;   DHPICN  - unique patient identifier across all VistA systems
"RTN","SYNDHP57",16,0)
 ;   FRDAT   - from date (inclusive), optional, compared to origination date/time
"RTN","SYNDHP57",17,0)
 ;   TODAT   - to date (inclusive), optional, compared to origination date/time
"RTN","SYNDHP57",18,0)
 ;   RETJSON - J = Return JSON
"RTN","SYNDHP57",19,0)
 ;             F = Return FHIR
"RTN","SYNDHP57",20,0)
 ;             0 or null = Return allergies string (default)
"RTN","SYNDHP57",21,0)
 ; Output:
"RTN","SYNDHP57",22,0)
 ;   RETSTA  - a delimited string that lists SNOMED CDT codes for the patient allergies
"RTN","SYNDHP57",23,0)
 ;           - ICN^allergen|SCT:code|origination dt/tm|type|verified flag|resource id~reaction:sct code:severity^...
"RTN","SYNDHP57",24,0)
 ;             or if no reaction: ICN^allergen|SCT:code|origination dt/tm|type|verified flag|resource id^...
"RTN","SYNDHP57",25,0)
 ;          or patient allergies in JSON format
"RTN","SYNDHP57",26,0)
 ;
"RTN","SYNDHP57",27,0)
 ; validate ICN
"RTN","SYNDHP57",28,0)
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
"RTN","SYNDHP57",29,0)
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" QUIT
"RTN","SYNDHP57",30,0)
 ;
"RTN","SYNDHP57",31,0)
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
"RTN","SYNDHP57",32,0)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
"RTN","SYNDHP57",33,0)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
"RTN","SYNDHP57",34,0)
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
"RTN","SYNDHP57",35,0)
 ;
"RTN","SYNDHP57",36,0)
 ; get patient IEN from ICN
"RTN","SYNDHP57",37,0)
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP57",38,0)
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
"RTN","SYNDHP57",39,0)
 ;
"RTN","SYNDHP57",40,0)
 N ALLARRAY
"RTN","SYNDHP57",41,0)
 S RETSTA=$$ALLERGIES(.ALLARRAY,PATIEN,DHPICN,FRDAT,TODAT)
"RTN","SYNDHP57",42,0)
 ;
"RTN","SYNDHP57",43,0)
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
"RTN","SYNDHP57",44,0)
 ;
"RTN","SYNDHP57",45,0)
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
"RTN","SYNDHP57",46,0)
 . S RETSTA=""
"RTN","SYNDHP57",47,0)
 . D TOJASON^SYNDHPUTL(.ALLARRAY,.RETSTA)
"RTN","SYNDHP57",48,0)
 ;
"RTN","SYNDHP57",49,0)
 QUIT
"RTN","SYNDHP57",50,0)
 ;
"RTN","SYNDHP57",51,0)
ALLERGIES(ALLARRAY,PATIEN,DHPICN,FRDAT,TODAT) ; get allergies for a patient
"RTN","SYNDHP57",52,0)
 ;
"RTN","SYNDHP57",53,0)
 N ZARR
"RTN","SYNDHP57",54,0)
 N V S V="_"
"RTN","SYNDHP57",55,0)
 N P S P="|"
"RTN","SYNDHP57",56,0)
 N S S S=";"
"RTN","SYNDHP57",57,0)
 N USER S USER=$$DUZ^SYNDHP69
"RTN","SYNDHP57",58,0)
 N SITE S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP57",59,0)
 I $G(DEBUG) W !,"Allergies",!
"RTN","SYNDHP57",60,0)
 ;
"RTN","SYNDHP57",61,0)
 N x,AID,ADATEFM,ADATE,REACTANT,ALGE,ALLERGENI,ATYPE,ATYPET,AVERT,AEIER
"RTN","SYNDHP57",62,0)
 N RE85IEN,REACTION,ENTBY,ENTDATE,RSEV,IENS,ALLERGIES,FT,TX,O,CS
"RTN","SYNDHP57",63,0)
 N ALLRET S ALLRET=DHPICN
"RTN","SYNDHP57",64,0)
 N FNUM S FNUM=120.8 ;patient allergies
"RTN","SYNDHP57",65,0)
 ; scan Patient Allergies B index
"RTN","SYNDHP57",66,0)
 N ALLIEN S ALLIEN=""
"RTN","SYNDHP57",67,0)
 F x=1:1 S ALLIEN=$O(^GMR(FNUM,"B",PATIEN,ALLIEN)) QUIT:ALLIEN=""  D
"RTN","SYNDHP57",68,0)
 . N ALLERGY
"RTN","SYNDHP57",69,0)
 . D GET1ALLERGY^SYNDHP16(.ALLERGY,ALLIEN,0)
"RTN","SYNDHP57",70,0)
 . I $D(ALLERGY("Allergy","ERROR")) M ALLARRAY("Allergies",ALLIEN)=ALLERGY QUIT
"RTN","SYNDHP57",71,0)
 . S AID=ALLERGY("Allergy","resourceId")
"RTN","SYNDHP57",72,0)
 . S ADATEFM=ALLERGY("Allergy","originationDateTimeFM")
"RTN","SYNDHP57",73,0)
 . QUIT:((ADATEFM\1)<FRDAT)!((ADATEFM\1)>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP57",74,0)
 . S ADATE=ALLERGY("Allergy","originationDateTimeHL7")
"RTN","SYNDHP57",75,0)
 . S REACTANT=ALLERGY("Allergy","reactant")
"RTN","SYNDHP57",76,0)
 . S FT=" ( FREE TEXT )"
"RTN","SYNDHP57",77,0)
 . I REACTANT[FT S REACTANT=$P(REACTANT,FT)
"RTN","SYNDHP57",78,0)
 . S ALGE=REACTANT
"RTN","SYNDHP57",79,0)
 . S ALLERGENI=ALLERGY("Allergy","gmrAllergyId")
"RTN","SYNDHP57",80,0)
 . I $P(ALLERGENI,S,2)["PS" S REACTANT=$P($$GVREF(ALLERGENI),U,2)
"RTN","SYNDHP57",81,0)
 . S ATYPE=ALLERGY("Allergy","allergyType")
"RTN","SYNDHP57",82,0)
 . S ATYPET=ALLERGY("Allergy","allergyTypeFHIR")
"RTN","SYNDHP57",83,0)
 . S AVERT=ALLERGY("Allergy","verified")
"RTN","SYNDHP57",84,0)
 . S AEIER=ALLERGY("Allergy","enteredInError")
"RTN","SYNDHP57",85,0)
 . S AVERT=$S(AVERT="YES":"confirmed",AEIER="YES":"entered-in-error",1:"unconfirmed")
"RTN","SYNDHP57",86,0)
 . ;get severity from file 120.85
"RTN","SYNDHP57",87,0)
 . S RE85IEN=$O(^GMR(120.85,"C",ALLIEN,""))
"RTN","SYNDHP57",88,0)
 . S RSEV=$$GET1^DIQ(120.85,RE85IEN_",",14.5)
"RTN","SYNDHP57",89,0)
 . S ALLERGY("Allergy","severity")=RSEV
"RTN","SYNDHP57",90,0)
 . S ALLERGY("Allergy","severityCd")=$$GET1^DIQ(120.85,RE85IEN_",",14.5,"I")
"RTN","SYNDHP57",91,0)
 . S ALLERGIES(x)=AID_U_ADATEFM_U_ADATE_U_REACTANT_U_ALLERGENI_U_ATYPE_U_ATYPET_U_AVERT_U_AEIER_U_RSEV
"RTN","SYNDHP57",92,0)
 . ;get reactions
"RTN","SYNDHP57",93,0)
 . N y
"RTN","SYNDHP57",94,0)
 . S IENS=""
"RTN","SYNDHP57",95,0)
 . F y=1:1 S IENS=$O(ALLERGY("Allergy","reactionss","reactions",IENS)) QUIT:IENS=""  D
"RTN","SYNDHP57",96,0)
 . . S REACTION=ALLERGY("Allergy","reactionss","reactions",IENS,"reaction")
"RTN","SYNDHP57",97,0)
 . . S ENTBY=ALLERGY("Allergy","reactionss","reactions",IENS,"enteredBy")
"RTN","SYNDHP57",98,0)
 . . S ENTDATE=ALLERGY("Allergy","reactionss","reactions",IENS,"dateEnteredHL7")
"RTN","SYNDHP57",99,0)
 . . S ALLERGIES(x,y)=AID_U_REACTION_U_ENTBY_U_ENTDATE_U_RSEV_U_ATYPET
"RTN","SYNDHP57",100,0)
 . M ALLARRAY("Allergies",ALLIEN)=ALLERGY ;
"RTN","SYNDHP57",101,0)
 . ;
"RTN","SYNDHP57",102,0)
 . I $G(DEBUG) D 
"RTN","SYNDHP57",103,0)
 . . W "ADATE:",ADATE,!
"RTN","SYNDHP57",104,0)
 . . W "REACTANT:",REACTANT,!
"RTN","SYNDHP57",105,0)
 . . W "ALGE:",ALGE,!
"RTN","SYNDHP57",106,0)
 . . W "ALLERGENI:",ALLERGENI,!
"RTN","SYNDHP57",107,0)
 . . W "ATYPE:",ATYPE,!
"RTN","SYNDHP57",108,0)
 . . W "ATYPET:",ATYPET,!
"RTN","SYNDHP57",109,0)
 . . W "AVERT:",AVERT,!
"RTN","SYNDHP57",110,0)
 . . W "AEIER:",AEIER,!
"RTN","SYNDHP57",111,0)
 . . W "RE85IEN:",RE85IEN,!
"RTN","SYNDHP57",112,0)
 . . W "RSEV:",RSEV,!
"RTN","SYNDHP57",113,0)
 ;
"RTN","SYNDHP57",114,0)
 ;I $G(DEBUG) W ! ZWRITE ALLERGIES W !
"RTN","SYNDHP57",115,0)
 ;
"RTN","SYNDHP57",116,0)
 ; serialize data
"RTN","SYNDHP57",117,0)
 N N,SCT,AIEN,ALGN,ALGE,ADATE,ATYPET,AVERT,RSEV,AID,ATYNODE,ATYPTX,ATYPET,GMRID
"RTN","SYNDHP57",118,0)
 S (SCT,AIEN)=""
"RTN","SYNDHP57",119,0)
 S ALGN=""
"RTN","SYNDHP57",120,0)
 F  S ALGN=$O(ALLERGIES(ALGN)) QUIT:ALGN=""  D
"RTN","SYNDHP57",121,0)
 . S ALGE=$P(ALLERGIES(ALGN),U,4)
"RTN","SYNDHP57",122,0)
 . S ADATE=$P(ALLERGIES(ALGN),U,3)
"RTN","SYNDHP57",123,0)
 . S GMRID=$P(ALLERGIES(ALGN),U,5)
"RTN","SYNDHP57",124,0)
 . S ATYPET=$P(ALLERGIES(ALGN),U,7)
"RTN","SYNDHP57",125,0)
 . S AVERT=$P(ALLERGIES(ALGN),U,8)
"RTN","SYNDHP57",126,0)
 . S RSEV=$P(ALLERGIES(ALGN),U,10)
"RTN","SYNDHP57",127,0)
 . S AID=$P(ALLERGIES(ALGN),U,1)
"RTN","SYNDHP57",128,0)
 . S ATYNODE=$O(ALLERGIES(ALGN,""))
"RTN","SYNDHP57",129,0)
 . S (ATYPTX,ATYPET)=""
"RTN","SYNDHP57",130,0)
 . I ATYNODE'="" D
"RTN","SYNDHP57",131,0)
 . . S ATYPTX=$G(ALLERGIES(ALGN,ATYNODE))
"RTN","SYNDHP57",132,0)
 . . S ATYPET=$P($G(ATYPTX),U,6)
"RTN","SYNDHP57",133,0)
 . N VMAP
"RTN","SYNDHP57",134,0)
 . I $P(GMRID,S,2)["PS" D
"RTN","SYNDHP57",135,0)
 . . S VUID=+$$GVREF(GMRID)
"RTN","SYNDHP57",136,0)
 . . S VMAP=$$MVUID(VUID,"VMAP")
"RTN","SYNDHP57",137,0)
 . I $P(GMRID,S,2)'["PS" D
"RTN","SYNDHP57",138,0)
 . . S CODE=$$MAPR^SYNDHPMP(ALGE,"T","A")
"RTN","SYNDHP57",139,0)
 . . S VMAP("SCT",CODE)=""
"RTN","SYNDHP57",140,0)
 . S (CS,N,O)=""
"RTN","SYNDHP57",141,0)
 . F  S N=$O(VMAP(N)) Q:N=""  F  S O=$O(VMAP(N,O)) Q:O=""  S CS=CS_N_":"_O_"~"
"RTN","SYNDHP57",142,0)
 . S CS=$RE($E($RE(CS),2,$L(CS)))
"RTN","SYNDHP57",143,0)
 . S ALLRET=ALLRET_U_ALGE_P_CS_P_ADATE_P_ATYPET_P_AVERT_P_AID
"RTN","SYNDHP57",144,0)
 . S N=""
"RTN","SYNDHP57",145,0)
 . F  S N=$O(ALLERGIES(ALGN,N)) Q:N=""  D
"RTN","SYNDHP57",146,0)
 . . S TX=ALLERGIES(ALGN,N)
"RTN","SYNDHP57",147,0)
 . . S REACTION=$P(TX,U,2)
"RTN","SYNDHP57",148,0)
 . . S ALLRET=ALLRET_"~"_REACTION_":"_$$MAPR^SYNDHPMP(REACTION,"T","R")_":"_$$LOW^XLFSTR(RSEV)
"RTN","SYNDHP57",149,0)
 . ;
"RTN","SYNDHP57",150,0)
 . I $G(DEBUG) D
"RTN","SYNDHP57",151,0)
 . . W "ALGE:",ALGE,!
"RTN","SYNDHP57",152,0)
 . . W "ADATE:",ADATE,!
"RTN","SYNDHP57",153,0)
 . . W "ATYPET:",ATYPET,!
"RTN","SYNDHP57",154,0)
 . . W "AVERT:",AVERT,!
"RTN","SYNDHP57",155,0)
 . . W "RSEV:",RSEV,!
"RTN","SYNDHP57",156,0)
 . . W "AID:",AID,!
"RTN","SYNDHP57",157,0)
 . . W "ATYNODE:",ATYNODE,!
"RTN","SYNDHP57",158,0)
 . . W "ATYPTX:",ATYPTX,!
"RTN","SYNDHP57",159,0)
 . . W "CS:",CS,!!
"RTN","SYNDHP57",160,0)
 ;
"RTN","SYNDHP57",161,0)
 QUIT ALLRET
"RTN","SYNDHP57",162,0)
 ;
"RTN","SYNDHP57",163,0)
 ;  -------------- Utility functions
"RTN","SYNDHP57",164,0)
 ;
"RTN","SYNDHP57",165,0)
VXMAPR(SURFORM,SFTYPE,MAOR) ; map reactions (SNOMED CT) - - redundant code - remove when sure
"RTN","SYNDHP57",166,0)
 ; map an allergic reaction surface form to an SCT code
"RTN","SYNDHP57",167,0)
 ; Input:
"RTN","SYNDHP57",168,0)
 ;   SURFORM - surface form
"RTN","SYNDHP57",169,0)
 ;   TYPE    - type of surface form
"RTN","SYNDHP57",170,0)
 ;             I - IEN
"RTN","SYNDHP57",171,0)
 ;             T - term
"RTN","SYNDHP57",172,0)
 ;   MAOR    - allergen or reaction
"RTN","SYNDHP57",173,0)
 ;             A - Allergen
"RTN","SYNDHP57",174,0)
 ;             R - Reaction
"RTN","SYNDHP57",175,0)
 ;
"RTN","SYNDHP57",176,0)
 I SFTYPE'="I",SFTYPE'="T" Q "-1^Type unrecognised - should be I or T"
"RTN","SYNDHP57",177,0)
 I MAOR'="A",MAOR'="R" Q "-1^Allergy/Reaction indicator unrecognised - should be A or R"
"RTN","SYNDHP57",178,0)
 N RSUB,INDX
"RTN","SYNDHP57",179,0)
 S RSUB=$S(MAOR="A":"ALLERGENS",1:"REACTIONS")
"RTN","SYNDHP57",180,0)
 S INDX=$S(SFTYPE="I":"ICT",1:"TCI")
"RTN","SYNDHP57",181,0)
 I '$D(^SYN("2002.010",RSUB,INDX,SURFORM)) Q ""  ; <<<<<< this global is missing
"RTN","SYNDHP57",182,0)
 QUIT $O(^SYN("2002.010",RSUB,INDX,SURFORM,""))
"RTN","SYNDHP57",183,0)
 ;
"RTN","SYNDHP57",184,0)
GVREF(ALLERGEN) ; map allergens (SNOMED CT, NDFRT, RxNorm, VANDF, etc)
"RTN","SYNDHP57",185,0)
 ; GMRD - SNOMED CT
"RTN","SYNDHP57",186,0)
 N S S S=";"
"RTN","SYNDHP57",187,0)
 ;I $P(ALLERGEN,S,2)["GMRD" D MAPGMRD QUIT MAPS
"RTN","SYNDHP57",188,0)
 I $P(ALLERGEN,S,2)["PSDRUG" QUIT $$VDRUG()
"RTN","SYNDHP57",189,0)
 I $P(ALLERGEN,S,2)["PSNDF" QUIT $$VPSNDF()
"RTN","SYNDHP57",190,0)
 I $P(ALLERGEN,S,2)["PS(50.416" QUIT $$VP50416()
"RTN","SYNDHP57",191,0)
 I $P(ALLERGEN,S,2)["PS(50.605" QUIT $$VP50605()
"RTN","SYNDHP57",192,0)
 QUIT
"RTN","SYNDHP57",193,0)
 ;
"RTN","SYNDHP57",194,0)
VDRUG() ;
"RTN","SYNDHP57",195,0)
 N PSDIEN,GENNAM,FPFOS,VUID,VMAP
"RTN","SYNDHP57",196,0)
 ;W !,N,"  -  ",INT,"  -  ",EXT
"RTN","SYNDHP57",197,0)
 S PSDIEN=+$P(ALLERGEN,";")
"RTN","SYNDHP57",198,0)
 ;W !,$$GET1^DIQ(50,PSDIEN_",",64,"E")
"RTN","SYNDHP57",199,0)
 S GENNAM=$$GET1^DIQ(50,PSDIEN_",",64,"E")
"RTN","SYNDHP57",200,0)
 ;W !,$O(^PS(50.416,"B",GENNAM,""))
"RTN","SYNDHP57",201,0)
 I '$D(^PS(50.416,"B",GENNAM)) QUIT "not found"
"RTN","SYNDHP57",202,0)
 S FPFOS=$O(^PS(50.416,"B",GENNAM,""))
"RTN","SYNDHP57",203,0)
 S VUID=$$GET1^DIQ(50.416,FPFOS_",","VUID")
"RTN","SYNDHP57",204,0)
 S VMAP=$$MVUID(VUID,"VMAP")
"RTN","SYNDHP57",205,0)
 QUIT VUID_U_GENNAM
"RTN","SYNDHP57",206,0)
 ;
"RTN","SYNDHP57",207,0)
 ;
"RTN","SYNDHP57",208,0)
VPSNDF() ;
"RTN","SYNDHP57",209,0)
 N PSDIEN,GENNAM,VUID
"RTN","SYNDHP57",210,0)
 S PSDIEN=+$P(ALLERGEN,";")
"RTN","SYNDHP57",211,0)
 S GENNAM=$$GET1^DIQ(50.6,PSDIEN_",",.01,"E")
"RTN","SYNDHP57",212,0)
 S VUID=$$GET1^DIQ(50.6,PSDIEN_",","VUID")
"RTN","SYNDHP57",213,0)
 QUIT VUID_U_GENNAM
"RTN","SYNDHP57",214,0)
 ;
"RTN","SYNDHP57",215,0)
VP50416() ;
"RTN","SYNDHP57",216,0)
 N PSDIEN,GENNAM,VUID
"RTN","SYNDHP57",217,0)
 S PSDIEN=+$P(ALLERGEN,";")
"RTN","SYNDHP57",218,0)
 S GENNAM=$$GET1^DIQ(50.416,PSDIEN_",",.01,"E")
"RTN","SYNDHP57",219,0)
 S VUID=$$GET1^DIQ(50.416,PSDIEN_",","VUID")
"RTN","SYNDHP57",220,0)
 QUIT VUID_U_GENNAM
"RTN","SYNDHP57",221,0)
 ;
"RTN","SYNDHP57",222,0)
VP50605() ;
"RTN","SYNDHP57",223,0)
 N PSDIEN,GENNAM,VUID
"RTN","SYNDHP57",224,0)
 S PSDIEN=+$P(ALLERGEN,";")
"RTN","SYNDHP57",225,0)
 S GENNAM=$$GET1^DIQ(50.605,PSDIEN_",",1,"E")
"RTN","SYNDHP57",226,0)
 S VUID=$$GET1^DIQ(50.605,PSDIEN_",","VUID")
"RTN","SYNDHP57",227,0)
 QUIT VUID_U_GENNAM
"RTN","SYNDHP57",228,0)
 ;
"RTN","SYNDHP57",229,0)
LYNX ;
"RTN","SYNDHP57",230,0)
 N EXT,INT
"RTN","SYNDHP57",231,0)
 N N S N=0
"RTN","SYNDHP57",232,0)
 N F S F=120.8
"RTN","SYNDHP57",233,0)
 F  S N=$O(^GMR(F,N)) Q:+N=0  D
"RTN","SYNDHP57",234,0)
 .S INT=$$GET1^DIQ(F,N_",",1,"I")
"RTN","SYNDHP57",235,0)
 .S EXT=$$GET1^DIQ(F,N_",",1,"E")
"RTN","SYNDHP57",236,0)
 .I $P(INT,";",2)["GMRD" Q
"RTN","SYNDHP57",237,0)
 .;I $P(INT,";",2)["PSDRUG" D LPSDRUG Q
"RTN","SYNDHP57",238,0)
 .I $P(INT,";",2)["PSNDF" D LPSNDF Q
"RTN","SYNDHP57",239,0)
 .W !,N,"  -  ",INT,"  -  ",EXT
"RTN","SYNDHP57",240,0)
 Q
"RTN","SYNDHP57",241,0)
 ;
"RTN","SYNDHP57",242,0)
LPSNDF ;
"RTN","SYNDHP57",243,0)
 Q
"RTN","SYNDHP57",244,0)
 W !,N,"  -  ",INT,"  -  ",EXT
"RTN","SYNDHP57",245,0)
 N PSDIEN,VUID
"RTN","SYNDHP57",246,0)
 S PSDIEN=+$P(INT,";")
"RTN","SYNDHP57",247,0)
 S VUID=$$GET1^DIQ(50.6,PSDIEN_",","VUID")
"RTN","SYNDHP57",248,0)
 W !,VUID
"RTN","SYNDHP57",249,0)
 Q
"RTN","SYNDHP57",250,0)
 ;
"RTN","SYNDHP57",251,0)
MVUID(VUID,MAP) ;  ******   needs work  ******
"RTN","SYNDHP57",252,0)
 ; map VUID to RXNORM sources ; Should be RxNorm
"RTN","SYNDHP57",253,0)
 N VMAP,RXCUI,SRC,CODE
"RTN","SYNDHP57",254,0)
 S VMAP("VANDF",VUID)=""
"RTN","SYNDHP57",255,0)
 S RXCUI=""
"RTN","SYNDHP57",256,0)
 F  S RXCUI=$O(^SYN("2002.020","IXVANDF",VUID,RXCUI)) Q:RXCUI=""  D
"RTN","SYNDHP57",257,0)
 .F SRC="RXNORM","NDFRT" D
"RTN","SYNDHP57",258,0)
 ..S CODE=""
"RTN","SYNDHP57",259,0)
 ..F  S CODE=$O(^SYN("2002.020",RXCUI,SRC,CODE)) Q:CODE=""  D
"RTN","SYNDHP57",260,0)
 ...S VMAP(SRC,CODE)=""
"RTN","SYNDHP57",261,0)
 M @MAP=VMAP
"RTN","SYNDHP57",262,0)
 Q MAP
"RTN","SYNDHP57",263,0)
 ;
"RTN","SYNDHP57",264,0)
KILL ;
"RTN","SYNDHP57",265,0)
 ;K AEIER,AID,ALLERGENI,CS,CODE,V,VMAP,SRC,RXCUI,ATYPET,GENNAM,REACT,REACTS,VUID
"RTN","SYNDHP57",266,0)
 ;K ALLERGY,AVERT,ATYPE,S,ALGN,PSDRUG
"RTN","SYNDHP57",267,0)
 Q
"RTN","SYNDHP57",268,0)
 ;
"RTN","SYNDHP57",269,0)
 ; ----------- Unit Test -----------
"RTN","SYNDHP57",270,0)
T1 ;
"RTN","SYNDHP57",271,0)
 N ICN S ICN="10111V183702"
"RTN","SYNDHP57",272,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP57",273,0)
 N TODAT S TODAT=""
"RTN","SYNDHP57",274,0)
 N JSON S JSON=""
"RTN","SYNDHP57",275,0)
 N RETSTA
"RTN","SYNDHP57",276,0)
 D PATALLI(.RETSTA,ICN,FRDAT,TODAT,JSON)
"RTN","SYNDHP57",277,0)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
"RTN","SYNDHP57",278,0)
 QUIT
"RTN","SYNDHP57",279,0)
 ;
"RTN","SYNDHP57",280,0)
T2 ;
"RTN","SYNDHP57",281,0)
 N ICN S ICN="10111V183702"
"RTN","SYNDHP57",282,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP57",283,0)
 N TODAT S TODAT=""
"RTN","SYNDHP57",284,0)
 N JSON S JSON="J"
"RTN","SYNDHP57",285,0)
 N RETSTA
"RTN","SYNDHP57",286,0)
 D PATALLI(.RETSTA,ICN,FRDAT,TODAT,JSON)
"RTN","SYNDHP57",287,0)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
"RTN","SYNDHP57",288,0)
 QUIT
"RTN","SYNDHP57",289,0)
 ;
"RTN","SYNDHP57",290,0)
TESTS ;
"RTN","SYNDHP57",291,0)
ALLTEST0 ; pass
"RTN","SYNDHP57",292,0)
 D PATALLI(.RETSTA,"10111V183702")
"RTN","SYNDHP57",293,0)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
"RTN","SYNDHP57",294,0)
 Q
"RTN","SYNDHP57",295,0)
PROTEST ; in keeping with the spirit of the times
"RTN","SYNDHP57",296,0)
 n icn,pien
"RTN","SYNDHP57",297,0)
 s icn=""
"RTN","SYNDHP57",298,0)
 f  s icn=$o(^DPT("AFICN",icn)) q:icn=""  d
"RTN","SYNDHP57",299,0)
 .s pien=""
"RTN","SYNDHP57",300,0)
 .f  s pien=$o(^DPT("AFICN",icn,pien)) q:pien=""  d
"RTN","SYNDHP57",301,0)
 ..q:'$d(^GMR(120.8,"B",pien))
"RTN","SYNDHP57",302,0)
 ..k output
"RTN","SYNDHP57",303,0)
 ..k (icn,pien)
"RTN","SYNDHP57",304,0)
 ..d PATALLI(.output,icn)
"RTN","SYNDHP57",305,0)
 ..;i output["RXNORM" q
"RTN","SYNDHP57",306,0)
 ..;i output["NDFRT" q
"RTN","SYNDHP57",307,0)
 ..;i output'["VANDF" q
"RTN","SYNDHP57",308,0)
 ..W !!!!!!!! W $$ZW^SYNDHPUTL("output")
"RTN","SYNDHP57",309,0)
 q
"RTN","SYNDHP58")
0^67^B22472959
"RTN","SYNDHP58",1,0)
SYNDHP58 ; HC/art - HealthConcourse - get care team data ;05/04/2019
"RTN","SYNDHP58",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP58",3,0)
 ;;
"RTN","SYNDHP58",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP58",5,0)
 ;
"RTN","SYNDHP58",6,0)
 ;The authoratative source for VHA care team data is PCMM Web. (currently no connection is available.)
"RTN","SYNDHP58",7,0)
 ; PCMM Web updates VistA files on a regular basis.
"RTN","SYNDHP58",8,0)
 ;
"RTN","SYNDHP58",9,0)
 QUIT
"RTN","SYNDHP58",10,0)
 ;
"RTN","SYNDHP58",11,0)
GETTEAMS(RETSTA,FRDAT,TODAT,RETJSON) ;get all care teams
"RTN","SYNDHP58",12,0)
 ;input: FRDAT   - from date (inclusive), optional, compared to Current Activation Date
"RTN","SYNDHP58",13,0)
 ;       TODAT   - to date (inclusive), optional, compared to Current Activation Date
"RTN","SYNDHP58",14,0)
 ;       RETJSON - J = Return JSON
"RTN","SYNDHP58",15,0)
 ;                 F = Return FHIR
"RTN","SYNDHP58",16,0)
 ;                 0 or null = Return TEAMS string (default)
"RTN","SYNDHP58",17,0)
 ;returns: RETSTA - delimited string or JSON or FHIR string
"RTN","SYNDHP58",18,0)
 ;                  field delimiter |
"RTN","SYNDHP58",19,0)
 ;                  team delimiter ^
"RTN","SYNDHP58",20,0)
 ;                  resourceId | teamName | teamPurpose | institution | serviceDept | currentStatus | fhirTeamType | currentActivationDate | currentInactivationDate | current#Patients | resourceType ^ ...
"RTN","SYNDHP58",21,0)
 ;                or care team data in JSON format
"RTN","SYNDHP58",22,0)
 ;
"RTN","SYNDHP58",23,0)
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
"RTN","SYNDHP58",24,0)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
"RTN","SYNDHP58",25,0)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
"RTN","SYNDHP58",26,0)
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
"RTN","SYNDHP58",27,0)
 ;
"RTN","SYNDHP58",28,0)
 S RETSTA=""
"RTN","SYNDHP58",29,0)
 N P S P="|"
"RTN","SYNDHP58",30,0)
 N TEAMS
"RTN","SYNDHP58",31,0)
 N TEAMIEN S TEAMIEN=0
"RTN","SYNDHP58",32,0)
 F  S TEAMIEN=$O(^SCTM(404.51,TEAMIEN)) QUIT:+TEAMIEN=0  D
"RTN","SYNDHP58",33,0)
 . I $G(DEBUG) W !,"-------------------------------------------------------------",!
"RTN","SYNDHP58",34,0)
 . N TEAM,TEAMJ
"RTN","SYNDHP58",35,0)
 . D GET1TEAM^SYNDHP18(.TEAM,TEAMIEN,0)
"RTN","SYNDHP58",36,0)
 . I $D(TEAM("Team","ERROR")) M TEAMS("Teams",TEAMIEN)=TEAM QUIT
"RTN","SYNDHP58",37,0)
 . QUIT:((TEAM("Team","currentActivationDateCFM")\1)<FRDAT)!((TEAM("Team","currentActivationDateCFM")\1)>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP58",38,0)
 . M TEAMS("Teams",TEAMIEN)=TEAM
"RTN","SYNDHP58",39,0)
 . I $G(RETJSON)'="J",$G(RETJSON)'="F" D
"RTN","SYNDHP58",40,0)
 . . S RETSTA=RETSTA_TEAM("Team","resourceId")_P_TEAM("Team","teamName")_P_TEAM("Team","teamPurpose")_P_TEAM("Team","institution")_P_TEAM("Team","serviceDept")_P
"RTN","SYNDHP58",41,0)
 . . S RETSTA=RETSTA_TEAM("Team","currentStatusC")_P_"longitudinal"_P_TEAM("Team","currentActivationDateCHL7")_P_TEAM("Team","currentInactivationDateCHL7")_P
"RTN","SYNDHP58",42,0)
 . . S RETSTA=RETSTA_TEAM("Team","current#PatientsC")_P_TEAM("Team","resourceType")_U
"RTN","SYNDHP58",43,0)
 . . ;I $G(DEBUG) W ! ZWRITE TEAM
"RTN","SYNDHP58",44,0)
 ;
"RTN","SYNDHP58",45,0)
 ;I $G(DEBUG) W ! ZWRITE TEAMS
"RTN","SYNDHP58",46,0)
 ;
"RTN","SYNDHP58",47,0)
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
"RTN","SYNDHP58",48,0)
 ;
"RTN","SYNDHP58",49,0)
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
"RTN","SYNDHP58",50,0)
 . S RETSTA=""
"RTN","SYNDHP58",51,0)
 . D TOJASON^SYNDHPUTL(.TEAMS,.RETSTA)
"RTN","SYNDHP58",52,0)
 ;
"RTN","SYNDHP58",53,0)
 ;I $G(DEBUG) W ! ZWRITE RETSTA
"RTN","SYNDHP58",54,0)
 ;
"RTN","SYNDHP58",55,0)
 QUIT
"RTN","SYNDHP58",56,0)
 ;
"RTN","SYNDHP58",57,0)
GETTEAM(RETSTA,TEAMID,RETJSON) ;get one care team
"RTN","SYNDHP58",58,0)
 ;input: TEAMID - Team Name or IEN
"RTN","SYNDHP58",59,0)
 ;       RETJSON - J = Return JSON
"RTN","SYNDHP58",60,0)
 ;                 F = Return FHIR
"RTN","SYNDHP58",61,0)
 ;                 0 or null = Return TEAMS string (default)
"RTN","SYNDHP58",62,0)
 ;returns: RETSTA - delimited string or JSON or FHIR string
"RTN","SYNDHP58",63,0)
 ;                  resourceId | teamName | teamPurpose | institution | serviceDept | currentStatus | fhirTeamType | currentActivationDate | currentInactivationDate | current#Patients | resourceType
"RTN","SYNDHP58",64,0)
 ;                or care team data in JSON format
"RTN","SYNDHP58",65,0)
 ;         -1^What team?
"RTN","SYNDHP58",66,0)
 ;         -1^Team not found
"RTN","SYNDHP58",67,0)
 ;
"RTN","SYNDHP58",68,0)
 I $G(TEAMID)="" S RETSTA="-1^What team?" QUIT
"RTN","SYNDHP58",69,0)
 N TEAMIEN,ERR
"RTN","SYNDHP58",70,0)
 S TEAMIEN=$$FIND1^DIC(404.51,"","B",TEAMID,"","","ERR")
"RTN","SYNDHP58",71,0)
 ;I $G(DEBUG),$D(ERR) W ! ZWRITE ERR
"RTN","SYNDHP58",72,0)
 I TEAMIEN=0,+TEAMID,'$D(^SCTM(404.51,+TEAMID)) S RETSTA="-1^Team not found" QUIT
"RTN","SYNDHP58",73,0)
 I $D(^SCTM(404.51,+TEAMID,0)) S TEAMIEN=TEAMID
"RTN","SYNDHP58",74,0)
 I TEAMIEN=0 S RETSTA="-1^Team not found" QUIT
"RTN","SYNDHP58",75,0)
 ;
"RTN","SYNDHP58",76,0)
 I $G(DEBUG) W !,"---------------------------- care team ---------------------------------",!
"RTN","SYNDHP58",77,0)
 N P S P="|"
"RTN","SYNDHP58",78,0)
 S RETSTA=""
"RTN","SYNDHP58",79,0)
 N TEAM,TEAMJ,TEAMS
"RTN","SYNDHP58",80,0)
 DO
"RTN","SYNDHP58",81,0)
 . D GET1TEAM^SYNDHP18(.TEAM,TEAMIEN,0)
"RTN","SYNDHP58",82,0)
 . M TEAMS("Teams",TEAMIEN)=TEAM
"RTN","SYNDHP58",83,0)
 . QUIT:$D(TEAM("Team","ERROR"))
"RTN","SYNDHP58",84,0)
 . I $G(RETJSON)'="J",$G(RETJSON)'="F" D
"RTN","SYNDHP58",85,0)
 . . S RETSTA=RETSTA_TEAM("Team","resourceId")_P_TEAM("Team","teamName")_P_TEAM("Team","teamPurpose")_P_TEAM("Team","institution")_P_TEAM("Team","serviceDept")_P
"RTN","SYNDHP58",86,0)
 . . S RETSTA=RETSTA_TEAM("Team","currentStatusC")_P_"longitudinal"_P_TEAM("Team","currentActivationDateCHL7")_P_TEAM("Team","currentInactivationDateCHL7")_P
"RTN","SYNDHP58",87,0)
 . . S RETSTA=RETSTA_TEAM("Team","current#PatientsC")_P_TEAM("Team","resourceType")
"RTN","SYNDHP58",88,0)
 ;I $G(DEBUG) W ! ZWRITE TEAM
"RTN","SYNDHP58",89,0)
 ;I $G(DEBUG) W ! ZWRITE TEAMS W !
"RTN","SYNDHP58",90,0)
 ;
"RTN","SYNDHP58",91,0)
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
"RTN","SYNDHP58",92,0)
 ;
"RTN","SYNDHP58",93,0)
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
"RTN","SYNDHP58",94,0)
 . S RETSTA=""
"RTN","SYNDHP58",95,0)
 . D TOJASON^SYNDHPUTL(.TEAMS,.RETSTA)
"RTN","SYNDHP58",96,0)
 ;
"RTN","SYNDHP58",97,0)
 ;I $G(DEBUG) W ! ZWRITE RETSTA W !
"RTN","SYNDHP58",98,0)
 ;
"RTN","SYNDHP58",99,0)
 QUIT
"RTN","SYNDHP58",100,0)
 ;
"RTN","SYNDHP58",101,0)
 ; ----------- Unit Test -----------
"RTN","SYNDHP58",102,0)
T1 ;
"RTN","SYNDHP58",103,0)
 N TEAMID S TEAMID="BLUE"
"RTN","SYNDHP58",104,0)
 N JSON S JSON=""
"RTN","SYNDHP58",105,0)
 N RETSTA
"RTN","SYNDHP58",106,0)
 D GETTEAM(.RETSTA,TEAMID,JSON)
"RTN","SYNDHP58",107,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP58",108,0)
 QUIT
"RTN","SYNDHP58",109,0)
 ;
"RTN","SYNDHP58",110,0)
T2 ;
"RTN","SYNDHP58",111,0)
 N TEAMID S TEAMID=5
"RTN","SYNDHP58",112,0)
 N JSON S JSON="J"
"RTN","SYNDHP58",113,0)
 N RETSTA
"RTN","SYNDHP58",114,0)
 D GETTEAM(.RETSTA,TEAMID,JSON)
"RTN","SYNDHP58",115,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP58",116,0)
 QUIT
"RTN","SYNDHP58",117,0)
 ;
"RTN","SYNDHP58",118,0)
T3 ;
"RTN","SYNDHP58",119,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP58",120,0)
 N TODAT S TODAT=""
"RTN","SYNDHP58",121,0)
 N JSON S JSON=""
"RTN","SYNDHP58",122,0)
 N RETSTA
"RTN","SYNDHP58",123,0)
 D GETTEAMS(.RETSTA,FRDAT,TODAT,JSON)
"RTN","SYNDHP58",124,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP58",125,0)
 QUIT
"RTN","SYNDHP58",126,0)
 ;
"RTN","SYNDHP58",127,0)
T4 ;
"RTN","SYNDHP58",128,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP58",129,0)
 N TODAT S TODAT=""
"RTN","SYNDHP58",130,0)
 N JSON S JSON="J"
"RTN","SYNDHP58",131,0)
 N RETSTA
"RTN","SYNDHP58",132,0)
 D GETTEAMS(.RETSTA,FRDAT,TODAT,JSON)
"RTN","SYNDHP58",133,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP58",134,0)
 QUIT
"RTN","SYNDHP58",135,0)
 ;
"RTN","SYNDHP59")
0^68^B60059790
"RTN","SYNDHP59",1,0)
SYNDHP59 ; HC/art - HealthConcourse - get care plan data for a patient ;05/07/2019
"RTN","SYNDHP59",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP59",3,0)
 ;;
"RTN","SYNDHP59",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP59",5,0)
 ;
"RTN","SYNDHP59",6,0)
 QUIT
"RTN","SYNDHP59",7,0)
 ; -------------------- Patient Care Plans --------------------
"RTN","SYNDHP59",8,0)
 ;
"RTN","SYNDHP59",9,0)
PATCPALL(RETSTA,NAME,SSN,DOB,GENDER,FRDAT,TODAT,RETJSON) ; get Care Plans for a patient by traits
"RTN","SYNDHP59",10,0)
 S RETSTA="-1^This service has been retired"
"RTN","SYNDHP59",11,0)
 QUIT
"RTN","SYNDHP59",12,0)
 ; Return patient Care Plans for name, SSN, DOB, and gender
"RTN","SYNDHP59",13,0)
 ; This API will only return data for Synthea care plan patients
"RTN","SYNDHP59",14,0)
 ;
"RTN","SYNDHP59",15,0)
 ; Input:
"RTN","SYNDHP59",16,0)
 ;   NAME    - patient name
"RTN","SYNDHP59",17,0)
 ;   SSN     - social security number
"RTN","SYNDHP59",18,0)
 ;   DOB     - date of birth
"RTN","SYNDHP59",19,0)
 ;   GENDER  - gender
"RTN","SYNDHP59",20,0)
 ;   FRDATE  - from date (inclusive), optional, compared to Visit Date/Time
"RTN","SYNDHP59",21,0)
 ;   TODATE  - to date (inclusive), optional, compared to Visit Date/Time
"RTN","SYNDHP59",22,0)
 ;   RETJSON - J = Return JSON
"RTN","SYNDHP59",23,0)
 ;             F = Return FHIR
"RTN","SYNDHP59",24,0)
 ;             0 = Return Care Plan string (default)
"RTN","SYNDHP59",25,0)
 ; Output:
"RTN","SYNDHP59",26,0)
 ;   RETSTA  - a delimited string ...
"RTN","SYNDHP59",27,0)
 ;           - ICN^resourceId|HF SCT|HF Name|levelSeverity|encounterProvider|eventDateTime|visitDateTime|comments^...
"RTN","SYNDHP59",28,0)
 ;
"RTN","SYNDHP59",29,0)
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
"RTN","SYNDHP59",30,0)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
"RTN","SYNDHP59",31,0)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
"RTN","SYNDHP59",32,0)
 ;
"RTN","SYNDHP59",33,0)
 N ICNST,DHPICN,PATIEN
"RTN","SYNDHP59",34,0)
 ;
"RTN","SYNDHP59",35,0)
 D PATVAL^SYNDHP43(.ICNST,NAME,SSN,DOB,GENDER)
"RTN","SYNDHP59",36,0)
 I +ICNST'=1 S RETSTA=ICNST QUIT
"RTN","SYNDHP59",37,0)
 S DHPICN=$P(ICNST,U,3)
"RTN","SYNDHP59",38,0)
 ;
"RTN","SYNDHP59",39,0)
 ; get patient IEN from ICN
"RTN","SYNDHP59",40,0)
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP59",41,0)
 ;
"RTN","SYNDHP59",42,0)
 S RETSTA=DHPICN
"RTN","SYNDHP59",43,0)
 ;
"RTN","SYNDHP59",44,0)
 D GETALL(.RETSTA,PATIEN,FRDAT,TODAT)
"RTN","SYNDHP59",45,0)
 ;
"RTN","SYNDHP59",46,0)
 QUIT
"RTN","SYNDHP59",47,0)
 ;
"RTN","SYNDHP59",48,0)
 ; -------------------- Patient Care Plans --------------------
"RTN","SYNDHP59",49,0)
 ;
"RTN","SYNDHP59",50,0)
PATCPALLI(RETSTA,DHPICN,FRDAT,TODAT,RETJSON) ; Get Patient Care Plans for ICN
"RTN","SYNDHP59",51,0)
 ;
"RTN","SYNDHP59",52,0)
 ; Return patient Care Plans for a given patient ICN
"RTN","SYNDHP59",53,0)
 ; This API will only return care plan(s) for ingested Synthea patients
"RTN","SYNDHP59",54,0)
 ;
"RTN","SYNDHP59",55,0)
 ; Input:
"RTN","SYNDHP59",56,0)
 ;   DHPICN  - patient ICN (unique patient identifier across all VistA systems)
"RTN","SYNDHP59",57,0)
 ;   FRDAT   - from date (inclusive), optional, compared to Visit Date/Time
"RTN","SYNDHP59",58,0)
 ;   TODAT   - to date (inclusive), optional, compared to Visit Date/Time
"RTN","SYNDHP59",59,0)
 ;   RETJSON - J = Return JSON
"RTN","SYNDHP59",60,0)
 ;             F = Return FHIR
"RTN","SYNDHP59",61,0)
 ;             0 = Return Care Plan string (default)
"RTN","SYNDHP59",62,0)
 ; Output:
"RTN","SYNDHP59",63,0)
 ;   RETSTA  - a delimited string ...
"RTN","SYNDHP59",64,0)
 ;           - ICN^resourceId|HF SCT|HF Name|levelSeverity|encounterProvider|eventDateTime|visitDateTime|comments^...
"RTN","SYNDHP59",65,0)
 ;         or care plan data in JSON format
"RTN","SYNDHP59",66,0)
 ;
"RTN","SYNDHP59",67,0)
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
"RTN","SYNDHP59",68,0)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
"RTN","SYNDHP59",69,0)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
"RTN","SYNDHP59",70,0)
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
"RTN","SYNDHP59",71,0)
 ;
"RTN","SYNDHP59",72,0)
 ; validate ICN
"RTN","SYNDHP59",73,0)
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
"RTN","SYNDHP59",74,0)
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" QUIT
"RTN","SYNDHP59",75,0)
 ; 
"RTN","SYNDHP59",76,0)
 ; get patient IEN from ICN
"RTN","SYNDHP59",77,0)
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP59",78,0)
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
"RTN","SYNDHP59",79,0)
 ;
"RTN","SYNDHP59",80,0)
 S RETSTA=DHPICN
"RTN","SYNDHP59",81,0)
 ;
"RTN","SYNDHP59",82,0)
 D GETALL(.RETSTA,PATIEN,FRDAT,TODAT)
"RTN","SYNDHP59",83,0)
 ;
"RTN","SYNDHP59",84,0)
 QUIT
"RTN","SYNDHP59",85,0)
 ;
"RTN","SYNDHP59",86,0)
GETALL(RETSTA,PATIEN,FRDAT,TODAT) ;get all care plans for a patient
"RTN","SYNDHP59",87,0)
 ;
"RTN","SYNDHP59",88,0)
 N P S P="|"
"RTN","SYNDHP59",89,0)
 ;
"RTN","SYNDHP59",90,0)
 N visitId,HLFACTS
"RTN","SYNDHP59",91,0)
 N HFIEN S HFIEN=""
"RTN","SYNDHP59",92,0)
 F  S HFIEN=$O(^AUPNVHF("C",PATIEN,HFIEN)) QUIT:HFIEN=""  D
"RTN","SYNDHP59",93,0)
 . N HLFACT
"RTN","SYNDHP59",94,0)
 . D GET1HLF^SYNDHP15(.HLFACT,HFIEN,1,0)
"RTN","SYNDHP59",95,0)
 . I $D(HLFACT("HealthFactor","ERROR")) M HLFACTS("CarePlan",HFIEN)=HLFACT QUIT
"RTN","SYNDHP59",96,0)
 . ;I $D(HLFACT("HealthFactor","ERROR")) M HLFACTS("CarePlan",visitId,"Visit",HFIEN)=HLFACT QUIT
"RTN","SYNDHP59",97,0)
 . QUIT:$E(HLFACT("HealthFactor","hlfName"),1,4)'="SYN "
"RTN","SYNDHP59",98,0)
 . I $G(DEBUG) W HLFACT("HealthFactor","visitFM"),!
"RTN","SYNDHP59",99,0)
 . QUIT:((HLFACT("HealthFactor","visitFM")\1)<FRDAT)!((HLFACT("HealthFactor","visitFM")\1)>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP59",100,0)
 . S visitId=HLFACT("HealthFactor","visitId")
"RTN","SYNDHP59",101,0)
 . M HLFACTS("CarePlan",visitId,"Visit",HFIEN)=HLFACT
"RTN","SYNDHP59",102,0)
 . I $G(RETJSON)'="J",$G(RETJSON)'="F" D
"RTN","SYNDHP59",103,0)
 . . S RETSTA=RETSTA_U_HLFACT("HealthFactor","resourceId")_P_HLFACT("HealthFactor","hlfNameSCT")_P_HLFACT("HealthFactor","hlfName")_P
"RTN","SYNDHP59",104,0)
 . . S RETSTA=RETSTA_HLFACT("HealthFactor","levelSeverity")_P_HLFACT("HealthFactor","encounterProvider")_P_HLFACT("HealthFactor","eventDateTimeHL7")_P
"RTN","SYNDHP59",105,0)
 . . S RETSTA=RETSTA_HLFACT("HealthFactor","visitHL7")_P_HLFACT("HealthFactor","comments")
"RTN","SYNDHP59",106,0)
 ;
"RTN","SYNDHP59",107,0)
 ;I $G(DEBUG) W ! ZWRITE HLFACTS
"RTN","SYNDHP59",108,0)
 ;
"RTN","SYNDHP59",109,0)
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
"RTN","SYNDHP59",110,0)
 ;
"RTN","SYNDHP59",111,0)
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
"RTN","SYNDHP59",112,0)
 . S RETSTA=""
"RTN","SYNDHP59",113,0)
 . D TOJASON^SYNDHPUTL(.HLFACTS,.RETSTA)
"RTN","SYNDHP59",114,0)
 ;
"RTN","SYNDHP59",115,0)
 ;I $G(DEBUG) W ! ZWRITE RETSTA
"RTN","SYNDHP59",116,0)
 ;
"RTN","SYNDHP59",117,0)
 QUIT
"RTN","SYNDHP59",118,0)
 ;
"RTN","SYNDHP59",119,0)
PATCP(RETSTA,NAME,SSN,DOB,GENDER,VRESID,RETJSON) ; get Care Plan for a patient by traits and Visit ID
"RTN","SYNDHP59",120,0)
 S RETSTA="-1^This service has been retired"
"RTN","SYNDHP59",121,0)
 QUIT
"RTN","SYNDHP59",122,0)
 ; Return patient Care Plans for name, SSN, DOB, and gender and Visit ID
"RTN","SYNDHP59",123,0)
 ; This API will only return data for Synthea care plan patients
"RTN","SYNDHP59",124,0)
 ;
"RTN","SYNDHP59",125,0)
 ; Input:
"RTN","SYNDHP59",126,0)
 ;   NAME    - patient name
"RTN","SYNDHP59",127,0)
 ;   SSN     - social security number
"RTN","SYNDHP59",128,0)
 ;   DOB     - date of birth
"RTN","SYNDHP59",129,0)
 ;   GENDER  - gender
"RTN","SYNDHP59",130,0)
 ;   VRESID  - Visit resource ID
"RTN","SYNDHP59",131,0)
 ;   RETJSON - J = Return JSON
"RTN","SYNDHP59",132,0)
 ;             0 = Return Care Plan string (default)
"RTN","SYNDHP59",133,0)
 ; Output:
"RTN","SYNDHP59",134,0)
 ;   RETSTA  - a delimited string ...
"RTN","SYNDHP59",135,0)
 ;           - ICN^resourceId|HF SCT|HF Name|levelSeverity|encounterProvider|eventDateTime|visitDateTime|comments^...
"RTN","SYNDHP59",136,0)
 ;         or care plan data in JSON format
"RTN","SYNDHP59",137,0)
 ;
"RTN","SYNDHP59",138,0)
 I $G(VRESID)="" S RETSTA="-1^No visit identifier" QUIT
"RTN","SYNDHP59",139,0)
 ;
"RTN","SYNDHP59",140,0)
 N ICNST
"RTN","SYNDHP59",141,0)
 D PATVAL^SYNDHP43(.ICNST,NAME,SSN,DOB,GENDER)
"RTN","SYNDHP59",142,0)
 I +ICNST'=1 S RETSTA=ICNST QUIT
"RTN","SYNDHP59",143,0)
 N DHPICN S DHPICN=$P(ICNST,U,3)
"RTN","SYNDHP59",144,0)
 ;
"RTN","SYNDHP59",145,0)
 ; get patient IEN from ICN
"RTN","SYNDHP59",146,0)
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP59",147,0)
 ;
"RTN","SYNDHP59",148,0)
 S RETSTA=DHPICN
"RTN","SYNDHP59",149,0)
 ;
"RTN","SYNDHP59",150,0)
 D GETONE(.RETSTA,PATIEN,VRESID)
"RTN","SYNDHP59",151,0)
 ;
"RTN","SYNDHP59",152,0)
 QUIT
"RTN","SYNDHP59",153,0)
 ;
"RTN","SYNDHP59",154,0)
PATCPI(RETSTA,DHPICN,VRESID,RETJSON) ; Patient Care Plan(s) for ICN and Visit ID
"RTN","SYNDHP59",155,0)
 ;
"RTN","SYNDHP59",156,0)
 ; Return patient Care Plan for a given patient ICN and Visit ID
"RTN","SYNDHP59",157,0)
 ; This API will only return data for Synthea care plan patients
"RTN","SYNDHP59",158,0)
 ;
"RTN","SYNDHP59",159,0)
 ; Input:
"RTN","SYNDHP59",160,0)
 ;   DHPICN  - patient ICN (unique patient identifier across all VistA systems)
"RTN","SYNDHP59",161,0)
 ;   VRESID  - Visit resource ID, "_" piece 4 is the visit ien 
"RTN","SYNDHP59",162,0)
 ;   RETJSON - J = Return JSON
"RTN","SYNDHP59",163,0)
 ;             F = Return FHIR
"RTN","SYNDHP59",164,0)
 ;             0 = Return Care Plan string (default)
"RTN","SYNDHP59",165,0)
 ; Output:
"RTN","SYNDHP59",166,0)
 ;   RETSTA  - a delimited string ...
"RTN","SYNDHP59",167,0)
 ;           - ICN^resourceId|HF SCT|HF Name|levelSeverity|encounterProvider|eventDateTime|visitDateTime|comments^...
"RTN","SYNDHP59",168,0)
 ;         or care plan data in JSON format
"RTN","SYNDHP59",169,0)
 ;
"RTN","SYNDHP59",170,0)
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
"RTN","SYNDHP59",171,0)
 I $G(VRESID)="" S RETSTA="-1^What visit?" QUIT
"RTN","SYNDHP59",172,0)
 ;
"RTN","SYNDHP59",173,0)
 ; validate ICN
"RTN","SYNDHP59",174,0)
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" Q
"RTN","SYNDHP59",175,0)
 ; 
"RTN","SYNDHP59",176,0)
 ; get patient IEN from ICN
"RTN","SYNDHP59",177,0)
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP59",178,0)
 ;
"RTN","SYNDHP59",179,0)
 S RETSTA=DHPICN
"RTN","SYNDHP59",180,0)
 ;
"RTN","SYNDHP59",181,0)
 D GETONE(.RETSTA,PATIEN,VRESID)
"RTN","SYNDHP59",182,0)
 ;
"RTN","SYNDHP59",183,0)
 QUIT
"RTN","SYNDHP59",184,0)
 ;
"RTN","SYNDHP59",185,0)
GETONE(RETSTA,PATIEN,VRESID) ;get care plan(s) for a visit
"RTN","SYNDHP59",186,0)
 ;
"RTN","SYNDHP59",187,0)
 N P S P="|"
"RTN","SYNDHP59",188,0)
 N S S S="_"
"RTN","SYNDHP59",189,0)
 ;
"RTN","SYNDHP59",190,0)
 N HLFACTS
"RTN","SYNDHP59",191,0)
 N VISIT S VISIT=$P(VRESID,S,4)
"RTN","SYNDHP59",192,0)
 N HFIEN S HFIEN=""
"RTN","SYNDHP59",193,0)
 F  S HFIEN=$O(^AUPNVHF("C",PATIEN,HFIEN)) QUIT:HFIEN=""  D
"RTN","SYNDHP59",194,0)
 . N HLFACT
"RTN","SYNDHP59",195,0)
 . D GET1HLF^SYNDHP15(.HLFACT,HFIEN,1,0)
"RTN","SYNDHP59",196,0)
 . I $D(HLFACT("HealthFactor","ERROR")) M HLFACTS("CarePlan",HFIEN)=HLFACT QUIT
"RTN","SYNDHP59",197,0)
 . ;I $D(HLFACT("HealthFactor","ERROR")) M HLFACTS("CarePlan",visitId,"Visit",HFIEN)=HLFACT QUIT
"RTN","SYNDHP59",198,0)
 . QUIT:$E(HLFACT("HealthFactor","hlfName"),1,4)'="SYN "  ;skip if not synthea ingested
"RTN","SYNDHP59",199,0)
 . QUIT:VISIT'=HLFACT("HealthFactor","visitId")  ;skip if not for requested visit
"RTN","SYNDHP59",200,0)
 . S visitId=HLFACT("HealthFactor","visitId")
"RTN","SYNDHP59",201,0)
 . M HLFACTS("CarePlan",visitId,"Visit",HFIEN)=HLFACT
"RTN","SYNDHP59",202,0)
 . I $G(RETJSON)'="J",$G(RETJSON)'="F" D
"RTN","SYNDHP59",203,0)
 . . S RETSTA=RETSTA_U_HLFACT("HealthFactor","resourceId")_P_HLFACT("HealthFactor","hlfNameSCT")_P_HLFACT("HealthFactor","hlfName")_P
"RTN","SYNDHP59",204,0)
 . . S RETSTA=RETSTA_HLFACT("HealthFactor","levelSeverity")_P_HLFACT("HealthFactor","encounterProvider")_P_HLFACT("HealthFactor","eventDateTimeHL7")_P
"RTN","SYNDHP59",205,0)
 . . S RETSTA=RETSTA_HLFACT("HealthFactor","visitHL7")_P_HLFACT("HealthFactor","comments")
"RTN","SYNDHP59",206,0)
 ;
"RTN","SYNDHP59",207,0)
 ;I $G(DEBUG) W ! ZWRITE HLFACTS
"RTN","SYNDHP59",208,0)
 ;
"RTN","SYNDHP59",209,0)
 ;I $G(RETJSON)="F" D xxx  ;create array for FHIR
"RTN","SYNDHP59",210,0)
 ;
"RTN","SYNDHP59",211,0)
 I $G(RETJSON)="J"!($G(RETJSON)="F") D
"RTN","SYNDHP59",212,0)
 . S RETSTA=""
"RTN","SYNDHP59",213,0)
 . D TOJASON^SYNDHPUTL(.HLFACTS,.RETSTA)
"RTN","SYNDHP59",214,0)
 ;
"RTN","SYNDHP59",215,0)
 ;I $G(DEBUG) W ! ZWRITE RETSTA
"RTN","SYNDHP59",216,0)
 ;
"RTN","SYNDHP59",217,0)
 QUIT
"RTN","SYNDHP59",218,0)
 ;
"RTN","SYNDHP59",219,0)
 ; ----------- Unit Test -----------
"RTN","SYNDHP59",220,0)
T1 ;
"RTN","SYNDHP59",221,0)
 N ICN S ICN="2434609669V691690"
"RTN","SYNDHP59",222,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP59",223,0)
 N TODAT S TODAT=""
"RTN","SYNDHP59",224,0)
 N JSON S JSON=""
"RTN","SYNDHP59",225,0)
 N RETSTA
"RTN","SYNDHP59",226,0)
 D PATCPALLI(.RETSTA,ICN,FRDAT,TODAT,JSON)
"RTN","SYNDHP59",227,0)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
"RTN","SYNDHP59",228,0)
 QUIT
"RTN","SYNDHP59",229,0)
 ;
"RTN","SYNDHP59",230,0)
T2 ;
"RTN","SYNDHP59",231,0)
 N ICN S ICN="2434609669V691690"
"RTN","SYNDHP59",232,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP59",233,0)
 N TODAT S TODAT=""
"RTN","SYNDHP59",234,0)
 N JSON S JSON="J"
"RTN","SYNDHP59",235,0)
 N RETSTA
"RTN","SYNDHP59",236,0)
 D PATCPALLI(.RETSTA,ICN,FRDAT,TODAT,JSON)
"RTN","SYNDHP59",237,0)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
"RTN","SYNDHP59",238,0)
 QUIT
"RTN","SYNDHP59",239,0)
 ;
"RTN","SYNDHP59",240,0)
T3 ;
"RTN","SYNDHP59",241,0)
 N ICN S ICN="2434609669V691690"
"RTN","SYNDHP59",242,0)
 N VRESID S VRESID="V_500_1000010_34494"
"RTN","SYNDHP59",243,0)
 N JSON S JSON=""
"RTN","SYNDHP59",244,0)
 N RETSTA
"RTN","SYNDHP59",245,0)
 D PATCPI(.RETSTA,ICN,VRESID,JSON)
"RTN","SYNDHP59",246,0)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
"RTN","SYNDHP59",247,0)
 QUIT
"RTN","SYNDHP59",248,0)
 ;
"RTN","SYNDHP59",249,0)
T4 ;
"RTN","SYNDHP59",250,0)
 N ICN S ICN="2434609669V691690"
"RTN","SYNDHP59",251,0)
 N VRESID S VRESID="V_500_1000010_34494"
"RTN","SYNDHP59",252,0)
 N JSON S JSON="J"
"RTN","SYNDHP59",253,0)
 N RETSTA
"RTN","SYNDHP59",254,0)
 D PATCPI(.RETSTA,ICN,VRESID,JSON)
"RTN","SYNDHP59",255,0)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
"RTN","SYNDHP59",256,0)
 QUIT
"RTN","SYNDHP59",257,0)
 ;
"RTN","SYNDHP61")
0^8^B175435602
"RTN","SYNDHP61",1,0)
SYNDHP61 ;DHP/FJF/ART - HealthConcourse - Write To VistA ;12/07/2018
"RTN","SYNDHP61",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNDHP61",3,0)
 ;;
"RTN","SYNDHP61",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP61",5,0)
 ;
"RTN","SYNDHP61",6,0)
 QUIT
"RTN","SYNDHP61",7,0)
 ;
"RTN","SYNDHP61",8,0)
 ; vitals update
"RTN","SYNDHP61",9,0)
VITUPD(RETSTA,DHPPAT,DHPSCT,DHPOBS,DHPUNT,DHPDTM,DHPROV,DHPLOC) ; vitals update
"RTN","SYNDHP61",10,0)
 ;
"RTN","SYNDHP61",11,0)
 ; Input:
"RTN","SYNDHP61",12,0)
 ;  DHPPAT  - patient ICN           (mandatory)
"RTN","SYNDHP61",13,0)
 ;  DHPSCT  - SNOMED CT code        (mandatory)
"RTN","SYNDHP61",14,0)
 ;  DHPOBS  - Observation Value     (mandatory)
"RTN","SYNDHP61",15,0)
 ;  DHPUNT  - Observation units     (mandatory)
"RTN","SYNDHP61",16,0)
 ;  DHPDTM  - Observation Date/Time (mandatory) HL7 format
"RTN","SYNDHP61",17,0)
 ;  DHPROV  - provider              (mandatory) NPI#
"RTN","SYNDHP61",18,0)
 ;  DHPLOC  - location              (mandatory) name
"RTN","SYNDHP61",19,0)
 ; Output:   
"RTN","SYNDHP61",20,0)
 ;  1 - success
"RTN","SYNDHP61",21,0)
 ; -1 - failure
"RTN","SYNDHP61",22,0)
 ;
"RTN","SYNDHP61",23,0)
 I '$D(^DPT("AFICN",DHPPAT)) S RETSTA="-1^Patient not recognised" Q
"RTN","SYNDHP61",24,0)
 ; set up array of allowed SCT codes
"RTN","SYNDHP61",25,0)
 ;
"RTN","SYNDHP61",26,0)
 D VITSCT
"RTN","SYNDHP61",27,0)
 ;
"RTN","SYNDHP61",28,0)
 I '$D(SCTA(DHPSCT)) S RETSTA="-1^SNOMED CT code not recognised as vitals" Q
"RTN","SYNDHP61",29,0)
 ; build FDA and update vitals file (FN)
"RTN","SYNDHP61",30,0)
 D VITFDA
"RTN","SYNDHP61",31,0)
 D UPDATE^DIE(,"FDA",,"ZZERR")
"RTN","SYNDHP61",32,0)
 S RETSTA=$S($D(ZZERR):-1,1:1)
"RTN","SYNDHP61",33,0)
 Q
"RTN","SYNDHP61",34,0)
 ;
"RTN","SYNDHP61",35,0)
VITSCT ; set up recognised SCT codes for VITALS
"RTN","SYNDHP61",36,0)
 ; map incoming SNOMED CT code to VistA Vital Type (file FN1)
"RTN","SYNDHP61",37,0)
 S SCTA(27113001)="9^Body weight"
"RTN","SYNDHP61",38,0)
 S SCTA(50373000)="8^Body height"
"RTN","SYNDHP61",39,0)
 S SCTA(75367002)="1^Blood pressure"
"RTN","SYNDHP61",40,0)
 S SCTA(78564009)="5^Pulse rate"
"RTN","SYNDHP61",41,0)
 S SCTA(386725007)="2^Body Temperature"
"RTN","SYNDHP61",42,0)
 S SCTA(86290005)="3^Respiration"
"RTN","SYNDHP61",43,0)
 S SCTA(48094003)="10^Abdominal girth measurement"
"RTN","SYNDHP61",44,0)
 S SCTA(21727005)="11^Audiometry"
"RTN","SYNDHP61",45,0)
 S SCTA(252465000)="21^Pulse oximetry"
"RTN","SYNDHP61",46,0)
 S SCTA(22253000)="22^Pain"
"RTN","SYNDHP61",47,0)
 ; map incoming SNOMED CT code to VistA Vital Type (file FN1)
"RTN","SYNDHP61",48,0)
 S SCTX(9)="27113001^Body weight"
"RTN","SYNDHP61",49,0)
 S SCTX(8)="50373000^Body height"
"RTN","SYNDHP61",50,0)
 S SCTX(1)="75367002^Blood pressure"
"RTN","SYNDHP61",51,0)
 S SCTX(5)="78564009^Pulse rate"
"RTN","SYNDHP61",52,0)
 S SCTX(2)="386725007^Body Temperature"
"RTN","SYNDHP61",53,0)
 S SCTX(3)="86290005^Respiration"
"RTN","SYNDHP61",54,0)
 S SCTX(10)="48094003^Abdominal girth measurement"
"RTN","SYNDHP61",55,0)
 S SCTX(11)="21727005^Audiometry"
"RTN","SYNDHP61",56,0)
 S SCTX(21)="252465000^Pulse oximetry"
"RTN","SYNDHP61",57,0)
 S SCTX(22)="22253000^Pain"
"RTN","SYNDHP61",58,0)
 Q
"RTN","SYNDHP61",59,0)
 ;
"RTN","SYNDHP61",60,0)
VITFDA ; build FDA array for Vitals
"RTN","SYNDHP61",61,0)
 K FDA,ZZERR,ORIEN
"RTN","SYNDHP61",62,0)
 N PATIEN,PRVIEN,LOCIEN
"RTN","SYNDHP61",63,0)
 S FN=120.5
"RTN","SYNDHP61",64,0)
 ;S DHPLOC=$G(DHPLOC,10000000286)
"RTN","SYNDHP61",65,0)
 ;S DHPROV=$G(DHPROV,101)
"RTN","SYNDHP61",66,0)
 S DHPOBS=$$SI2IMP(DHPSCT,DHPOBS)
"RTN","SYNDHP61",67,0)
 S ORIEN(1)=$$NEXTIEN()
"RTN","SYNDHP61",68,0)
 S PATIEN=$O(^DPT("AFICN",DHPPAT,""))
"RTN","SYNDHP61",69,0)
 S PRVIEN=0
"RTN","SYNDHP61",70,0)
 I $G(DHPROV)'="" S PRVIEN=$O(^VA(200,"ANPI",DHPROV,""))
"RTN","SYNDHP61",71,0)
 I 'PRVIEN S PRVIEN=$O(^XUSEC("PROVIDER",0))
"RTN","SYNDHP61",72,0)
 I 'PRVIEN S $EC=",U-SET-UP-A-BLOODY-PROVIDER,"
"RTN","SYNDHP61",73,0)
 S LOCIEN=$O(^SC("B",DHPLOC,""))
"RTN","SYNDHP61",74,0)
 ;
"RTN","SYNDHP61",75,0)
 S FDA(FN,"+1,",.01)=$$HL7TFM^XLFDT(DHPDTM) ;date/time vitals taken
"RTN","SYNDHP61",76,0)
 S FDA(FN,"+1,",.02)=PATIEN ;patient
"RTN","SYNDHP61",77,0)
 S FDA(FN,"+1,",.03)=+SCTA(DHPSCT) ;vital type
"RTN","SYNDHP61",78,0)
 S FDA(FN,"+1,",.04)=$$HL7TFM^XLFDT(DHPDTM) ;date/time vitals entered
"RTN","SYNDHP61",79,0)
 S FDA(FN,"+1,",.05)=DHPLOC ;hospital location
"RTN","SYNDHP61",80,0)
 S FDA(FN,"+1,",.06)=PRVIEN ;entered by
"RTN","SYNDHP61",81,0)
 S FDA(FN,"+1,",1.2)=DHPOBS ;rate
"RTN","SYNDHP61",82,0)
 Q
"RTN","SYNDHP61",83,0)
 ;
"RTN","SYNDHP61",84,0)
NEXTIEN() ; 
"RTN","SYNDHP61",85,0)
 ; Get new code IEN
"RTN","SYNDHP61",86,0)
 Q $O(^GMR(FN,9E29),-1)+1
"RTN","SYNDHP61",87,0)
 ;
"RTN","SYNDHP61",88,0)
SI2IMP(SCT,OBS) ; convert metric units to imperial
"RTN","SYNDHP61",89,0)
 ;
"RTN","SYNDHP61",90,0)
 N UNITS
"RTN","SYNDHP61",91,0)
 S UNITS=$$UP^XLFSTR(DHPUNT)
"RTN","SYNDHP61",92,0)
 I SCT=27113001,UNITS="KG" Q $J(OBS*2.20462,0,1)  ; weight kg to lbs
"RTN","SYNDHP61",93,0)
 I SCT=50373000,UNITS="CM" Q $J(OBS*0.393701,0,0) ; height cm to inches
"RTN","SYNDHP61",94,0)
 I SCT=386725007,UNITS="CEL" Q $J(OBS/5*9+32,0,1) ; celsius to fahrenheit
"RTN","SYNDHP61",95,0)
 Q OBS
"RTN","SYNDHP61",96,0)
 ;
"RTN","SYNDHP61",97,0)
 ;
"RTN","SYNDHP61",98,0)
 ; -------- problem/condition update
"RTN","SYNDHP61",99,0)
 ;
"RTN","SYNDHP61",100,0)
PROBUPD(RETSTA,DHPPAT,DHPSCT,DHPSDES,DHPROV,DHPDTM,DHPRID) ; problems update
"RTN","SYNDHP61",101,0)
 ;
"RTN","SYNDHP61",102,0)
 ; Alternate entry for creating problem/condition if snomed code does not map to icd code, so can't use DATA2PCE
"RTN","SYNDHP61",103,0)
 ;
"RTN","SYNDHP61",104,0)
 ; Input:
"RTN","SYNDHP61",105,0)
 ;  DHPPAT -   patient ICN                (mandatory)
"RTN","SYNDHP61",106,0)
 ;  DHPSCT -   SNOMED CT code             (mandatory)
"RTN","SYNDHP61",107,0)
 ;  DHPSDES -  SNOMED CT designation code (optional)      >>>not used in code below, code (DHPSCDES) is looked up in Lexicon <<<
"RTN","SYNDHP61",108,0)
 ;  DHPROV -   Provider     (NPI)              (optional)
"RTN","SYNDHP61",109,0)
 ;  DHPDTM -   Observation Date/Time  (HL7)    (mandatory)
"RTN","SYNDHP61",110,0)
 ;  DHPRID -   DHP unique resource ID     (optional)
"RTN","SYNDHP61",111,0)
 ;               agency_facility          
"RTN","SYNDHP61",112,0)
 ;
"RTN","SYNDHP61",113,0)
 ; Output:   
"RTN","SYNDHP61",114,0)
 ;  1 - success
"RTN","SYNDHP61",115,0)
 ; -1 - failure
"RTN","SYNDHP61",116,0)
 ;
"RTN","SYNDHP61",117,0)
 I '$D(^DPT("AFICN",DHPPAT)) S RETSTA="-1^Patient not recognised" Q
"RTN","SYNDHP61",118,0)
 ;
"RTN","SYNDHP61",119,0)
 ;I '$D(SCTA(DHPSCT)) S RETSTA="-1^SNOMED CT code not recognised as vitals" Q
"RTN","SYNDHP61",120,0)
 ; build FDA and update vitals file (FN)
"RTN","SYNDHP61",121,0)
 K LEX
"RTN","SYNDHP61",122,0)
 S LEX=$$CODE^LEXTRAN(DHPSCT,"SCT")
"RTN","SYNDHP61",123,0)
 I +LEX=-2 S RETSTA=LEX Q
"RTN","SYNDHP61",124,0)
 D PROBFDA
"RTN","SYNDHP61",125,0)
 D UPDATE^DIE(,"FDA",,"ZZERR")
"RTN","SYNDHP61",126,0)
 ;W ! ZW ZZERR
"RTN","SYNDHP61",127,0)
 S RETSTA=$S($D(ZZERR):-1,1:1)
"RTN","SYNDHP61",128,0)
 Q
"RTN","SYNDHP61",129,0)
 ;
"RTN","SYNDHP61",130,0)
 ;
"RTN","SYNDHP61",131,0)
PROBFDA ; build FDA array for Problems
"RTN","SYNDHP61",132,0)
 ;
"RTN","SYNDHP61",133,0)
 K FDA,ZZERR,ORIEN
"RTN","SYNDHP61",134,0)
 S P="|"
"RTN","SYNDHP61",135,0)
 S FN=9000011
"RTN","SYNDHP61",136,0)
 ;S DHPOBS=$$UNCNVT(DHPSCT,DHPOBS)
"RTN","SYNDHP61",137,0)
 S ORIEN(1)=$$NEXTIEN()
"RTN","SYNDHP61",138,0)
 S PATIEN=$O(^DPT("AFICN",DHPPAT,""))
"RTN","SYNDHP61",139,0)
 S MAPVUID=5217693 ; VUID for SNOMED CT to ICD-10-CM mapping 
"RTN","SYNDHP61",140,0)
 K LEX
"RTN","SYNDHP61",141,0)
 S DHPICD=$$GETASSN^LEXTRAN1(DHPSCT,MAPVUID)
"RTN","SYNDHP61",142,0)
 S DHPICD=$O(LEX(1,""))
"RTN","SYNDHP61",143,0)
 I DHPICD="" S DHPICD="R69."
"RTN","SYNDHP61",144,0)
 S DHPICD=+$$ICDDX^ICDEX(DHPICD,30)
"RTN","SYNDHP61",145,0)
 S FDA(FN,"+1,",.01)=DHPICD ;diagnosis
"RTN","SYNDHP61",146,0)
 S FDA(FN,"+1,",.02)=PATIEN ;patient name
"RTN","SYNDHP61",147,0)
 S FDA(FN,"+1,",.03)=$$NOW^XLFDT() ;date last modified
"RTN","SYNDHP61",148,0)
 S FDA(FN,"+1,",.04)="P" ; or "F" personal history/family history
"RTN","SYNDHP61",149,0)
 ;
"RTN","SYNDHP61",150,0)
 S DHPLOC=+DHPRID
"RTN","SYNDHP61",151,0)
 S FDA(FN,"+1,",.06)=DHPLOC ; location
"RTN","SYNDHP61",152,0)
 S FDA(FN,"+1,",1.07)=$$HL7TFM^XLFDT(DHPDTM) ;date resolved <<<<<<<<<<<<< not if still active
"RTN","SYNDHP61",153,0)
 S FDA(FN,"+1,",.08)=$$NOW^XLFDT() ;date entered
"RTN","SYNDHP61",154,0)
 S FDA(FN,"+1,",.13)=$$HL7TFM^XLFDT(DHPDTM) ;date of onset
"RTN","SYNDHP61",155,0)
 S STATII=P_"A"_P_"I"_P
"RTN","SYNDHP61",156,0)
 S FDA(FN,"+1,",.12)=$S(STATII[(P_$G(DHPSTA)_P):DHPSTA,1:"A") ;status
"RTN","SYNDHP61",157,0)
 S FDA(FN,"+1,",80001)=DHPSCT ; snomed ct concept code
"RTN","SYNDHP61",158,0)
 ;
"RTN","SYNDHP61",159,0)
 N LEX
"RTN","SYNDHP61",160,0)
 S LEX=$$CODE^LEXTRAN(DHPSCT,"SCT",,,,1,1)
"RTN","SYNDHP61",161,0)
 S DHPSCDES=$P($G(LEX("P")),U,3)
"RTN","SYNDHP61",162,0)
 S LEXIEN=$P(LEX("P"),U,2)
"RTN","SYNDHP61",163,0)
 S EXPRSN=$P(LEX("P"),U)
"RTN","SYNDHP61",164,0)
 S PROVNAR=$$PROVNARTL(EXPRSN)
"RTN","SYNDHP61",165,0)
 S FDA(FN,"+1,",.05)=PROVNAR ;provider narrative
"RTN","SYNDHP61",166,0)
 S FDA(FN,"+1,",1.01)=LEXIEN ;problem
"RTN","SYNDHP61",167,0)
 S FDA(FN,"+1,",80002)=DHPSCDES ;snomed ct designation code
"RTN","SYNDHP61",168,0)
 S FDA(FN,"+1,",80201)=$$HL7TFM^XLFDT(DHPDTM) ;date of interest
"RTN","SYNDHP61",169,0)
 S FDA(FN,"+1,",80202)="10D" ;coding system
"RTN","SYNDHP61",170,0)
 S NUM=$O(^AUPNPROB("AA",PATIEN,DHPLOC,""),-1) ;get last NMBR used
"RTN","SYNDHP61",171,0)
 S NUM=+$RE(+$RE(NUM))
"RTN","SYNDHP61",172,0)
 S NUM=NUM+1
"RTN","SYNDHP61",173,0)
 S FDA(FN,"+1,",.07)=NUM ;nmbr
"RTN","SYNDHP61",174,0)
 S PRVIEN="" I DHPROV'="" S PRVIEN=$O(^VA(200,"ANPI",DHPROV,""))
"RTN","SYNDHP61",175,0)
 S FDA(FN,"+1,",1.03)=PRVIEN ;entered by
"RTN","SYNDHP61",176,0)
 S FDA(FN,"+1,",1.04)=PRVIEN ;recording provider
"RTN","SYNDHP61",177,0)
 S FDA(FN,"+1,",1.05)=PRVIEN ;responsible provider
"RTN","SYNDHP61",178,0)
 ;W ! ZW FDA
"RTN","SYNDHP61",179,0)
 Q
"RTN","SYNDHP61",180,0)
PROVNARTL(EXPRSN) ; deal with provider narrative
"RTN","SYNDHP61",181,0)
 ;
"RTN","SYNDHP61",182,0)
 N PROVNAR
"RTN","SYNDHP61",183,0)
 I '$D(^AUTNPOV("B",EXPRSN)) D PROVNADD(EXPRSN)
"RTN","SYNDHP61",184,0)
 S PROVNAR=$O(^AUTNPOV("B",EXPRSN,""))
"RTN","SYNDHP61",185,0)
 Q PROVNAR
"RTN","SYNDHP61",186,0)
 ;
"RTN","SYNDHP61",187,0)
PROVNADD(EXPRSN) ;
"RTN","SYNDHP61",188,0)
 N PNIEN
"RTN","SYNDHP61",189,0)
 S PNIEN=$O(^AUTNPOV(99999999999),-1)+1
"RTN","SYNDHP61",190,0)
 S ^AUTNPOV(PNIEN,0)=EXPRSN
"RTN","SYNDHP61",191,0)
 S ^AUTNPOV("B",EXPRSN,PNIEN)=""
"RTN","SYNDHP61",192,0)
 Q
"RTN","SYNDHP61",193,0)
 ;
"RTN","SYNDHP61",194,0)
 ; -------- Immunization update
"RTN","SYNDHP61",195,0)
 ;
"RTN","SYNDHP61",196,0)
IMMUNUPD(RETSTA,DHPPAT,VISIT,IMMUNIZ,ANATLOC,ADMINRT,DOSE,EVENTDT,IMMPROV) ;Immunization update
"RTN","SYNDHP61",197,0)
 ;
"RTN","SYNDHP61",198,0)
 ; Input:
"RTN","SYNDHP61",199,0)
 ;  DHPPAT  - patient ICN  (mandatory)
"RTN","SYNDHP61",200,0)
 ;  VISIT   - visit ien    (mandatory)
"RTN","SYNDHP61",201,0)
 ;  IMMUNIZ - cvx code     (mandatory)
"RTN","SYNDHP61",202,0)
 ;  ANATLOC - anatomical location
"RTN","SYNDHP61",203,0)
 ;  ADMINRT - route of administration
"RTN","SYNDHP61",204,0)
 ;  DOSE    - dose
"RTN","SYNDHP61",205,0)
 ;  EVENTDT - event date/time (HL7 format)
"RTN","SYNDHP61",206,0)
 ;  IMMPROV - immunization provider (NPI)
"RTN","SYNDHP61",207,0)
 ;
"RTN","SYNDHP61",208,0)
 ; Output:   RETSTA
"RTN","SYNDHP61",209,0)
 ;  1 - success
"RTN","SYNDHP61",210,0)
 ; -1 - failure -1^message
"RTN","SYNDHP61",211,0)
 ;
"RTN","SYNDHP61",212,0)
 N IMMIEN
"RTN","SYNDHP61",213,0)
 ;
"RTN","SYNDHP61",214,0)
 I '$D(^DPT("AFICN",DHPPAT)) S RETSTA="-1^Patient not recognised" QUIT
"RTN","SYNDHP61",215,0)
 ;
"RTN","SYNDHP61",216,0)
 I $G(IMMUNIZ)="" S RETSTA="-1^Immunization (CVX code) is required" QUIT
"RTN","SYNDHP61",217,0)
 S IMMIEN=$O(^AUTTIMM("C",IMMUNIZ,""))
"RTN","SYNDHP61",218,0)
 I IMMIEN="" S RETSTA="-1^Immunization (CVX code) not found" QUIT
"RTN","SYNDHP61",219,0)
 I +$$GET1^DIQ(9999999.14,IMMIEN_",",.07,"I") S RETSTA="-1^Immunization is inactive" QUIT
"RTN","SYNDHP61",220,0)
 ;
"RTN","SYNDHP61",221,0)
 I $G(VISIT)="" S RETSTA="-1^Visit IEN is required" QUIT
"RTN","SYNDHP61",222,0)
 I '$D(^AUPNVSIT(VISIT)) S RETSTA="-1^Visit not found" QUIT
"RTN","SYNDHP61",223,0)
 ;
"RTN","SYNDHP61",224,0)
 N PACKAGE,SOURCE,USER,ERRDISP,ZZERR,PPEDIT,ZZERDESC,ACCOUNT
"RTN","SYNDHP61",225,0)
 N IMMDATA,IMMPRVIEN,PPEDIT
"RTN","SYNDHP61",226,0)
 ;
"RTN","SYNDHP61",227,0)
 S RETSTA=1
"RTN","SYNDHP61",228,0)
 D SETUP
"RTN","SYNDHP61",229,0)
 QUIT:RETSTA=-1
"RTN","SYNDHP61",230,0)
 ;
"RTN","SYNDHP61",231,0)
 S RETSTA=$$DATA2PCE^PXAI("IMMDATA",PACKAGE,SOURCE,.VISIT,USER,$G(ERRDISP),.ZZERR,$G(PPEDIT),.ZZERDESC,.ACCOUNT)
"RTN","SYNDHP61",232,0)
 ;I $D(ZZERR) ZW ZZERR
"RTN","SYNDHP61",233,0)
 I $D(ZZERDESC) M RETSTA("ZZERDESC")=ZZERDESC
"RTN","SYNDHP61",234,0)
 I $D(ZZERR) M RETSTA("ZZERR")=ZZERR
"RTN","SYNDHP61",235,0)
 M RESTSTA("IMMDATA")=IMMDATA
"RTN","SYNDHP61",236,0)
 QUIT
"RTN","SYNDHP61",237,0)
 ;
"RTN","SYNDHP61",238,0)
 ; $$DATA2PCE Output:   
"RTN","SYNDHP61",239,0)
 ;+   1  if no errors and processed completely
"RTN","SYNDHP61",240,0)
 ;+  -1  if errors occurred but processed completely as possible
"RTN","SYNDHP61",241,0)
 ;+  -2  if could not get a visit
"RTN","SYNDHP61",242,0)
 ;+  -3  if called incorrectly
"RTN","SYNDHP61",243,0)
 ;
"RTN","SYNDHP61",244,0)
SETUP ; set data for $$DATA2PCE call
"RTN","SYNDHP61",245,0)
 ;
"RTN","SYNDHP61",246,0)
 S PACKAGE=507 ;PCE PATIENT CARE ENCOUNTER
"RTN","SYNDHP61",247,0)
 S SOURCE="DHP DATA INGEST"
"RTN","SYNDHP61",248,0)
 S USER=$$DUZ^SYNDHP69
"RTN","SYNDHP61",249,0)
 N EVDATFM
"RTN","SYNDHP61",250,0)
 S EVDATFM=$$HL7TFM^XLFDT(EVENTDT)
"RTN","SYNDHP61",251,0)
 S ERRDISP=1 ;for testing only, set to null otherwise  <<<<<<<<<<<<<<<<<<<<<<<
"RTN","SYNDHP61",252,0)
 S PPEDIT=""
"RTN","SYNDHP61",253,0)
 S ACCOUNT=""
"RTN","SYNDHP61",254,0)
 ;
"RTN","SYNDHP61",255,0)
 S IMMDATA("IMMUNIZATION",1,"IMMUN")=IMMIEN
"RTN","SYNDHP61",256,0)
 ;don't send null data values to create records
"RTN","SYNDHP61",257,0)
 ; There are extra data elements here for possible future use
"RTN","SYNDHP61",258,0)
 I $G(IMMPROV)'="" D
"RTN","SYNDHP61",259,0)
 . S IMMPRVIEN=$O(^VA(200,"ANPI",IMMPROV,""))
"RTN","SYNDHP61",260,0)
 . QUIT:IMMPRVIEN=""
"RTN","SYNDHP61",261,0)
 . S IMMDATA("IMMUNIZATION",1,"ENC PROVIDER")=IMMPRVIEN
"RTN","SYNDHP61",262,0)
 S:$G(EVENTDT)'="" IMMDATA("IMMUNIZATION",1,"EVENT D/T")=EVDATFM
"RTN","SYNDHP61",263,0)
 S:$G(SERIES)'="" IMMDATA("IMMUNIZATION",1,"SERIES")=SERIES
"RTN","SYNDHP61",264,0)
 S:$G(REACTION)'="" IMMDATA("IMMUNIZATION",1,"REACTION")=REACTION
"RTN","SYNDHP61",265,0)
 S:$G(CONTRA)'="" IMMDATA("IMMUNIZATION",1,"CONTRAINDICATED")=CONTRA
"RTN","SYNDHP61",266,0)
 S:$G(DXCODE)'="" IMMDATA("IMMUNIZATION",1,"DIAGNOSIS")=DXCODE
"RTN","SYNDHP61",267,0)
 S:$G(COMMENT)'="" IMMDATA("IMMUNIZATION",1,"COMMENT")=COMMENT
"RTN","SYNDHP61",268,0)
 S:$G(LOTNUM)'="" IMMDATA("IMMUNIZATION",1,"LOT NUM")=LOTNUM
"RTN","SYNDHP61",269,0)
 S:$G(INFOSRC)'="" IMMDATA("IMMUNIZATION",1,"INFO SOURCE")=INFOSRC
"RTN","SYNDHP61",270,0)
 S:$G(ADMINRT)'="" IMMDATA("IMMUNIZATION",1,"ADMIN ROUTE")=ADMINRT
"RTN","SYNDHP61",271,0)
 S:$G(ANATLOC)'="" IMMDATA("IMMUNIZATION",1,"ANATOMIC LOC")=ANATLOC
"RTN","SYNDHP61",272,0)
 S:$G(DOSE)'="" IMMDATA("IMMUNIZATION",1,"DOSE")=DOSE
"RTN","SYNDHP61",273,0)
 S:$G(DOSEUNIT)'="" IMMDATA("IMMUNIZATION",1,"DOSE UNITS")=DOSEUNIT
"RTN","SYNDHP61",274,0)
 N SERCAT
"RTN","SYNDHP61",275,0)
 S SERCAT=$S(EVDATFM\1<$$DT^XLFDT:"E",1:"A")
"RTN","SYNDHP61",276,0)
 S IMMDATA("IMMUNIZATION",1,"SERVICE CATEGORY")=SERCAT ; A for current E for historical
"RTN","SYNDHP61",277,0)
 QUIT
"RTN","SYNDHP61",278,0)
 ;
"RTN","SYNDHP61",279,0)
 ; -------- Encounter update
"RTN","SYNDHP61",280,0)
 ;
"RTN","SYNDHP61",281,0)
ENCTUPD(RETSTA,DHPPAT,STARTDT,ENDDT,ENCPROV,CLINIC,SCTDX,SCTCPT) ;Encounter update
"RTN","SYNDHP61",282,0)
 ;return visit id/ien
"RTN","SYNDHP61",283,0)
 ;
"RTN","SYNDHP61",284,0)
 S U="^"
"RTN","SYNDHP61",285,0)
 I '$D(^DPT("AFICN",DHPPAT)) S RETSTA="-1^Patient not recognised" QUIT
"RTN","SYNDHP61",286,0)
 ;
"RTN","SYNDHP61",287,0)
 I $G(ENCPROV)'="" D
"RTN","SYNDHP61",288,0)
 .S ENCPRVIEN=$O(^VA(200,"ANPI",ENCPROV,""))
"RTN","SYNDHP61",289,0)
 .I 'ENCPRVIEN S ENCPRVIEN=$O(^XUSEC("PROVIDER",0))
"RTN","SYNDHP61",290,0)
 .I 'ENCPRVIEN S $EC=",U-SET-UP-A-BLOODY-PROVIDER,"
"RTN","SYNDHP61",291,0)
 S PATIEN=$O(^DPT("AFICN",DHPPAT,""),-1)
"RTN","SYNDHP61",292,0)
 S SOURCE="DHP DATA INGEST"
"RTN","SYNDHP61",293,0)
 S PACKAGE=$$FIND1^DIC(9.4,,"","PCE")
"RTN","SYNDHP61",294,0)
 S LOCATION=$O(^SC("B",CLINIC,""))
"RTN","SYNDHP61",295,0)
 S USER=$$DUZ^SYNDHP69
"RTN","SYNDHP61",296,0)
 ;
"RTN","SYNDHP61",297,0)
 ;chop off seconds
"RTN","SYNDHP61",298,0)
 N APPTDATE
"RTN","SYNDHP61",299,0)
 S APPTDATE=$$HL7TFM^XLFDT(STARTDT)
"RTN","SYNDHP61",300,0)
 S APPTTM=$E($P(APPTDATE,".",2),1,4)
"RTN","SYNDHP61",301,0)
 S $P(APPTDATE,".",2)=APPTTM
"RTN","SYNDHP61",302,0)
 ;
"RTN","SYNDHP61",303,0)
 ; map SNOMED CT code in SCTDX to ICD-10
"RTN","SYNDHP61",304,0)
 S MAPVUID=5217693 ; VUID for SNOMED CT to ICD-10-CM mapping 
"RTN","SYNDHP61",305,0)
 ;K LEX
"RTN","SYNDHP61",306,0)
 ;S DHPICD=$$GETASSN^LEXTRAN1(SCTDX,MAPVUID)
"RTN","SYNDHP61",307,0)
 ;S DHPICD=$O(LEX(1,""))
"RTN","SYNDHP61",308,0)
 ;I DHPICD="" S DHPICD="R69."
"RTN","SYNDHP61",309,0)
 ;S DHPICD=+$$ICDDX^ICDEX(DHPICD,30)
"RTN","SYNDHP61",310,0)
 I $G(SCTDX)'="" D  ;
"RTN","SYNDHP61",311,0)
 .S MAPPING=$S(APPTDATE>3150930:"sct2icd",1:"sct2icdnine") ; APPTDATE IS IN FM FORMAT
"RTN","SYNDHP61",312,0)
 .S DHPICD=$$MAP^SYNDHPMP(MAPPING,SCTDX)
"RTN","SYNDHP61",313,0)
 .I +DHPICD=-1 S RETSTA="-1^SNOMED CT CODE "_SCTDX_" not mapped" Q
"RTN","SYNDHP61",314,0)
 .;S DHPICD=+$$ICDDX^ICDEX($P(DHPICD,U,2),30)
"RTN","SYNDHP61",315,0)
 .I +DHPICD'=-1 S DHPICD=+$$ICDDX^ICDEX($P(DHPICD,U,2),30)
"RTN","SYNDHP61",316,0)
 ;
"RTN","SYNDHP61",317,0)
 ; map SNOMED CT code in SCTCPT to CPT
"RTN","SYNDHP61",318,0)
 ;S DHPCPT=$S($$MAP^SYNQLDM(SCTCPT)'="":$$MAP^SYNQLDM(SCTCPT),1:92002)
"RTN","SYNDHP61",319,0)
 S DHPCPT=$$MAP^SYNQLDM(SCTCPT)
"RTN","SYNDHP61",320,0)
 I DHPCPT'="" D
"RTN","SYNDHP61",321,0)
 .I '$D(^ICPT("B",DHPCPT)) S DHPCPT=""
"RTN","SYNDHP61",322,0)
 I DHPCPT="" D
"RTN","SYNDHP61",323,0)
 .S DHPCPT=$$MAP^SYNDHPMP("sct2os5",SCTCPT)
"RTN","SYNDHP61",324,0)
 .I +DHPCPT=-1 S DHPCPT="" Q
"RTN","SYNDHP61",325,0)
 .S DHPCPT=$P(DHPCPT,U,2)
"RTN","SYNDHP61",326,0)
 ;
"RTN","SYNDHP61",327,0)
 I DHPCPT="" S RETSTA="-1^SNOMED CT CODE "_SCTCPT_" not mapped" Q
"RTN","SYNDHP61",328,0)
 ; create root array
"RTN","SYNDHP61",329,0)
 K ENCDATA
"RTN","SYNDHP61",330,0)
 S ENCDATA("ENCOUNTER",1,"PATIENT")=PATIEN
"RTN","SYNDHP61",331,0)
 S ENCDATA("ENCOUNTER",1,"ENCOUNTER TYPE")="P"
"RTN","SYNDHP61",332,0)
 S ENCDATA("ENCOUNTER",1,"ENC D/T")=APPTDATE
"RTN","SYNDHP61",333,0)
 S ENCDATA("ENCOUNTER",1,"HOS LOC")=LOCATION
"RTN","SYNDHP61",334,0)
 N SERCAT
"RTN","SYNDHP61",335,0)
 S SERCAT=$S(APPTDATE\1<$$DT^XLFDT:"E",1:"A")
"RTN","SYNDHP61",336,0)
 S SERCAT="A"
"RTN","SYNDHP61",337,0)
 S ENCDATA("ENCOUNTER",1,"SERVICE CATEGORY")=SERCAT ; A for current E for historical
"RTN","SYNDHP61",338,0)
 S ENCDATA("PROVIDER",1,"NAME")=ENCPRVIEN
"RTN","SYNDHP61",339,0)
 S ENCDATA("PROVIDER",1,"PRIMARY")=1
"RTN","SYNDHP61",340,0)
 ; gpl 100%
"RTN","SYNDHP61",341,0)
 I +$G(DHPICD)=-1 D  ; no mapping was found
"RTN","SYNDHP61",342,0)
 . I $G(SCTDX)="" Q  ; no code passed in
"RTN","SYNDHP61",343,0)
 . S ENCDATA("STD CODES",1,"CODE")=SCTDX
"RTN","SYNDHP61",344,0)
 . S ENCDATA("STD CODES",1,"CODING SYSTEM")="SCT"
"RTN","SYNDHP61",345,0)
 . S ENCDATA("STD CODES",1,"EVENT D/T")=APPTDATE
"RTN","SYNDHP61",346,0)
 . S ENCDATA("STD CODES",1,"COMMENT")="Purpose of Visit - POV."
"RTN","SYNDHP61",347,0)
 . S ENCDATA("STD CODES",1,"ENC PROVIDER")=ENCPRVIEN
"RTN","SYNDHP61",348,0)
 . ; health factor for CPRS display (v 30,31)
"RTN","SYNDHP61",349,0)
 . N HFIEN
"RTN","SYNDHP61",350,0)
 . S HFIEN=$O(^AUTTHF("B","SYN SNOMED PURPOSE OF VISIT",""))
"RTN","SYNDHP61",351,0)
 . I HFIEN'="" D  ; Health factor exists
"RTN","SYNDHP61",352,0)
 . . S ENCDATA("HEALTH FACTOR",1,"HEALTH FACTOR")=HFIEN
"RTN","SYNDHP61",353,0)
 . . S ENCDATA("HEALTH FACTOR",1,"EVENT D/T")=APPTDATE
"RTN","SYNDHP61",354,0)
 . . S ENCDATA("HEALTH FACTOR",1,"COMMENT")=SCTDX
"RTN","SYNDHP61",355,0)
 E  D  ; mapping was found
"RTN","SYNDHP61",356,0)
 . I $G(SCTDX)'="" S ENCDATA("DX/PL",1,"DIAGNOSIS")=DHPICD
"RTN","SYNDHP61",357,0)
 . I $G(SCTDX)'="" S ENCDATA("DX/PL",1,"ENC PROVIDER")=ENCPRVIEN
"RTN","SYNDHP61",358,0)
 . I $G(SCTDX)'="" S ENCDATA("DX/PL",1,"PRIMARY")=1
"RTN","SYNDHP61",359,0)
 S ENCDATA("PROCEDURE",1,"PROCEDURE")=DHPCPT
"RTN","SYNDHP61",360,0)
 S ENCDATA("PROCEDURE",1,"QTY")=1
"RTN","SYNDHP61",361,0)
 I $G(SCTDX)'="" I +DHPICD'=-1 S ENCDATA("PROCEDURE",1,"DIAGNOSIS")=DHPICD
"RTN","SYNDHP61",362,0)
 ;
"RTN","SYNDHP61",363,0)
 K ZZERR,ZZERDESC,VISIT
"RTN","SYNDHP61",364,0)
 S RETSTA=$$DATA2PCE^PXAI("ENCDATA",PACKAGE,SOURCE,.VISIT,USER,$G(ERRDISP),.ZZERR,$G(PPEDIT),.ZZERDESC,.ACCOUNT)
"RTN","SYNDHP61",365,0)
 S RETSTA=RETSTA_"^"_$G(VISIT)
"RTN","SYNDHP61",366,0)
 I $D(ZZERDESC) M RETSTA("ZZERDESC")=ZZERDESC
"RTN","SYNDHP61",367,0)
 I $D(ZZERR) M RETSTA("ZZERR")=ZZERR
"RTN","SYNDHP61",368,0)
 M RETSTA("ENCDATA")=ENCDATA
"RTN","SYNDHP61",369,0)
 ;
"RTN","SYNDHP61",370,0)
 ;change APPTDATE back to HL7 format for these next calls
"RTN","SYNDHP61",371,0)
 S APPTDATE=$$FMTHL7^XLFDT(APPTDATE)
"RTN","SYNDHP61",372,0)
 ;create appointment
"RTN","SYNDHP61",373,0)
 N DHPLEN
"RTN","SYNDHP61",374,0)
 S DHPLEN=""
"RTN","SYNDHP61",375,0)
 D APPTADD^SYNDHP62(.RETSTA,DHPPAT,CLINIC,APPTDATE,DHPLEN)
"RTN","SYNDHP61",376,0)
 QUIT:$G(RETSTA("APPT"))'=1
"RTN","SYNDHP61",377,0)
 ;
"RTN","SYNDHP61",378,0)
 ;check-in appointment
"RTN","SYNDHP61",379,0)
 N DHPCIDT
"RTN","SYNDHP61",380,0)
 S DHPCIDT=""
"RTN","SYNDHP61",381,0)
 D APPTCKIN^SYNDHP62(.RETSTA,DHPPAT,CLINIC,APPTDATE,DHPCIDT)
"RTN","SYNDHP61",382,0)
 QUIT:$G(RETSTA("CKIN"))'=1
"RTN","SYNDHP61",383,0)
 ;
"RTN","SYNDHP61",384,0)
 ;check-out appointment
"RTN","SYNDHP61",385,0)
 N DHPCODT
"RTN","SYNDHP61",386,0)
 S DHPCODT=""
"RTN","SYNDHP61",387,0)
 D APTCKOUT^SYNDHP62(.RETSTA,DHPPAT,CLINIC,APPTDATE,DHPCODT)
"RTN","SYNDHP61",388,0)
 ;
"RTN","SYNDHP61",389,0)
 QUIT
"RTN","SYNDHP61",390,0)
 ;
"RTN","SYNDHP61",391,0)
 ; -------------------------------------------------------------------------
"RTN","SYNDHP61",392,0)
 ;;
"RTN","SYNDHP61",393,0)
TEST ;
"RTN","SYNDHP61",394,0)
T1 D PROBUPD(.ZXC,"5482156687V807096",267036007,158482014,9990006675,20180118,"5OO_EXT")
"RTN","SYNDHP61",395,0)
 Q
"RTN","SYNDHP61",396,0)
T2 D ENCTUPD(.ZXC,"5482156687V807096",20161227154556,20161227161234,"9990000348","GENERAL MEDICINE",73211009,10492003)
"RTN","SYNDHP61",397,0)
 Q
"RTN","SYNDHP61",398,0)
T3 S IDT=20170115154546
"RTN","SYNDHP61",399,0)
 F SDT=IDT:1E8:(IDT+9E8) S EDT=SDT+2E8 D
"RTN","SYNDHP61",400,0)
 .;K VISIT
"RTN","SYNDHP61",401,0)
 .K ZXC
"RTN","SYNDHP61",402,0)
 .D ENCTUPD(.ZXC,"9004935583V839304",SDT,EDT,"9990000348","GENERAL MEDICINE",73211009,10492003)
"RTN","SYNDHP61",403,0)
 .W !!,"___________________________________________________",!!
"RTN","SYNDHP61",404,0)
 .ZWRITE ZXC
"RTN","SYNDHP61",405,0)
 .W !!
"RTN","SYNDHP61",406,0)
 .ZWRITE ENCDATA
"RTN","SYNDHP61",407,0)
 .W !!,"___________________________________________________",!!
"RTN","SYNDHP61",408,0)
 .ZWRITE ZZERDESC
"RTN","SYNDHP61",409,0)
 .W !!,"___________________________________________________",!!
"RTN","SYNDHP61",410,0)
 .ZWRITE ZZERR
"RTN","SYNDHP61",411,0)
 Q
"RTN","SYNDHP62")
0^9^B308344743
"RTN","SYNDHP62",1,0)
SYNDHP62 ;DHP/ART - HealthConcourse - Write Problems, Appointments To VistA ;05/29/2018
"RTN","SYNDHP62",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNDHP62",3,0)
 ;;
"RTN","SYNDHP62",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP62",5,0)
 ;
"RTN","SYNDHP62",6,0)
 QUIT
"RTN","SYNDHP62",7,0)
 ;
"RTN","SYNDHP62",8,0)
 ; -------- Problem/Condition update
"RTN","SYNDHP62",9,0)
 ;
"RTN","SYNDHP62",10,0)
PRBUPDT(RETSTA,DHPPAT,DHPVST,DHPROV,DHPONS,DHPABT,DHPCLNST,DHPSCT) ;Problem/Condition update
"RTN","SYNDHP62",11,0)
 ;
"RTN","SYNDHP62",12,0)
 ; Input:
"RTN","SYNDHP62",13,0)
 ;   DHPPAT   - Patient ICN
"RTN","SYNDHP62",14,0)
 ;   DHPVST   - Visit ID
"RTN","SYNDHP62",15,0)
 ;   DHPROV   - Provider ID (NPI)
"RTN","SYNDHP62",16,0)
 ;   DHPONS   - Onset Date (HL7 format)
"RTN","SYNDHP62",17,0)
 ;   DHPABT   - Abatement Date (HL7 format)
"RTN","SYNDHP62",18,0)
 ;   DHPCLNST - Clinical Status ?   (A or I)
"RTN","SYNDHP62",19,0)
 ;   DHPSCT   - SNOMED CT code
"RTN","SYNDHP62",20,0)
 ;
"RTN","SYNDHP62",21,0)
 ; Output:   RETSTA
"RTN","SYNDHP62",22,0)
 ;  1 - success
"RTN","SYNDHP62",23,0)
 ; -1 - failure -1^message
"RTN","SYNDHP62",24,0)
 ;
"RTN","SYNDHP62",25,0)
 I '$D(^DPT("AFICN",DHPPAT)) S RETSTA="-1^Patient not recognised" Q
"RTN","SYNDHP62",26,0)
 ;
"RTN","SYNDHP62",27,0)
 I $G(DHPSCT)="" S RETSTA="-1^SNOMED CT code is required" Q
"RTN","SYNDHP62",28,0)
 I $G(DHPVST)="" S RETSTA="-1^Visit IEN is required" Q
"RTN","SYNDHP62",29,0)
 I $G(DHPONS)="" S RETSTA="-1^onset date is required" Q
"RTN","SYNDHP62",30,0)
 I '$D(^AUPNVSIT(DHPVST)) S RETSTA="-1^Visit not found" Q
"RTN","SYNDHP62",31,0)
 ;
"RTN","SYNDHP62",32,0)
 N PACKAGE,SOURCE,USER,ERRDISP,ZZERR,PPEDIT,ZZERDESC,ACCOUNT
"RTN","SYNDHP62",33,0)
 N PROBDATA,PRBPRIEN,STATII,MAPVUID,P,DHPICD,DHPCS,MAPPING
"RTN","SYNDHP62",34,0)
 ;
"RTN","SYNDHP62",35,0)
 S PACKAGE=$$FIND1^DIC(9.4,,"","PCE")
"RTN","SYNDHP62",36,0)
 S SOURCE="DHP DATA INGEST"
"RTN","SYNDHP62",37,0)
 S USER=$$DUZ^SYNDHP69
"RTN","SYNDHP62",38,0)
 S ERRDISP=""
"RTN","SYNDHP62",39,0)
 I $G(DEBUG)=1 S ERRDISP=1
"RTN","SYNDHP62",40,0)
 S PPEDIT=""
"RTN","SYNDHP62",41,0)
 S ACCOUNT=""
"RTN","SYNDHP62",42,0)
 S P="|"
"RTN","SYNDHP62",43,0)
 ;
"RTN","SYNDHP62",44,0)
 S RETSTA=1
"RTN","SYNDHP62",45,0)
 ;
"RTN","SYNDHP62",46,0)
 S PROBDATA("DX/PL",1,"PL ADD")=1
"RTN","SYNDHP62",47,0)
 S DHPONS=$P($$HL7TFM^XLFDT(DHPONS),".",1)
"RTN","SYNDHP62",48,0)
 ;20130526110511-0400 
"RTN","SYNDHP62",49,0)
 ;date portion only, active problems can not have a date resolved
"RTN","SYNDHP62",50,0)
 S PROBDATA("DX/PL",1,"PL ONSET DATE")=DHPONS
"RTN","SYNDHP62",51,0)
 S:$G(DHPABT)'="" PROBDATA("DX/PL",1,"PL RESOLVED DATE")=$P($$HL7TFM^XLFDT(DHPABT),".",1)
"RTN","SYNDHP62",52,0)
 ;
"RTN","SYNDHP62",53,0)
 ;S MAPVUID=5217693 ; VUID for SNOMED CT to ICD-10-CM mapping 
"RTN","SYNDHP62",54,0)
 ;K LEX
"RTN","SYNDHP62",55,0)
 ;S DHPICD=$$GETASSN^LEXTRAN1(DHPSCT,MAPVUID)
"RTN","SYNDHP62",56,0)
 ;S DHPICD=$O(LEX(1,""))
"RTN","SYNDHP62",57,0)
 ;I DHPICD="" S DHPICD="R69."
"RTN","SYNDHP62",58,0)
 ;S DHPICD=+$$ICDDX^ICDEX(DHPICD,30) ;30=ICD-10
"RTN","SYNDHP62",59,0)
 ;S PROBDATA("DX/PL",1,"DIAGNOSIS")=DHPICD
"RTN","SYNDHP62",60,0)
 ;S PROBDATA("DX/PL",1,"DIAGNOSIS")=DHPSCT
"RTN","SYNDHP62",61,0)
 ;
"RTN","SYNDHP62",62,0)
 ; next line determines whether to use ICD10 or ICD9 map
"RTN","SYNDHP62",63,0)
 S MAPPING=$S(DHPONS>3150930:"sct2icd",1:"sct2icdnine")
"RTN","SYNDHP62",64,0)
 ;
"RTN","SYNDHP62",65,0)
 ;W !!,">>>> DHPONS ",DHPONS
"RTN","SYNDHP62",66,0)
 ;W !,">>>> MAPPING ",MAPPING,!!
"RTN","SYNDHP62",67,0)
 ;
"RTN","SYNDHP62",68,0)
 ;
"RTN","SYNDHP62",69,0)
 S DHPICD=$$MAP^SYNDHPMP(MAPPING,DHPSCT)
"RTN","SYNDHP62",70,0)
 I +DHPICD=-1 S RETSTA="-1^SNOMED CT CODE "_DHPSCT_" not mapped" Q
"RTN","SYNDHP62",71,0)
 S DHPCS=$S(DHPONS>3150930:30,1:1)
"RTN","SYNDHP62",72,0)
 S DHPICD=$P(DHPICD,U,2) ; DHPICD now contains ICD code from mapping return
"RTN","SYNDHP62",73,0)
 N ICDTX
"RTN","SYNDHP62",74,0)
 S ICDTX=$$ICDDX^ICDEX(DHPICD,DHPCS)
"RTN","SYNDHP62",75,0)
 ;
"RTN","SYNDHP62",76,0)
 S DHPICD=+ICDTX ; DHPICD now contains ICD code IEN
"RTN","SYNDHP62",77,0)
 I +DHPICD=-1 S RETSTA="-1^ICD Code "_DHPICD_" not on file" Q
"RTN","SYNDHP62",78,0)
 S DHPDXNR=$P(ICDTX,U,4)
"RTN","SYNDHP62",79,0)
 S PROBDATA("DX/PL",1,"DIAGNOSIS")=DHPICD
"RTN","SYNDHP62",80,0)
 S PROBDATA("DX/PL",1,"NARRATIVE")=DHPDXNR
"RTN","SYNDHP62",81,0)
 N SERCAT
"RTN","SYNDHP62",82,0)
 S SERCAT="A" ; $S(DHPONS\1<$$DT^XLFDT:"E",1:"A")
"RTN","SYNDHP62",83,0)
 S PROBDATA("DX/PL",1,"SERVICE CATEGORY")=SERCAT ; A for current E for historical
"RTN","SYNDHP62",84,0)
 S DHPDXF=$$PRMDX(DHPVST,DHPICD)
"RTN","SYNDHP62",85,0)
 I DHPDXF=-1 S RETSTA="-1^Problem with DX code "_DHPICD_" already exists for visit "_DHPVST Q
"RTN","SYNDHP62",86,0)
 S PROBDATA("DX/PL",1,"PRIMARY")=DHPDXF
"RTN","SYNDHP62",87,0)
 ;
"RTN","SYNDHP62",88,0)
 I $G(DHPROV)'="" D
"RTN","SYNDHP62",89,0)
 . S PRBPRIEN=$O(^VA(200,"ANPI",DHPROV,""))
"RTN","SYNDHP62",90,0)
 . QUIT:PRBPRIEN=""
"RTN","SYNDHP62",91,0)
 . S PROBDATA("DX/PL",1,"ENC PROVIDER")=PRBPRIEN
"RTN","SYNDHP62",92,0)
 ;
"RTN","SYNDHP62",93,0)
 S STATII=P_"A"_P_"I"_P
"RTN","SYNDHP62",94,0)
 S:$G(DHPCLNST)'="" PROBDATA("DX/PL",1,"PL ACTIVE")=$S(STATII[(P_$G(DHPCLNST)_P):DHPCLNST,1:"A")
"RTN","SYNDHP62",95,0)
 ;
"RTN","SYNDHP62",96,0)
 S RETSTA=$$DATA2PCE^PXAI("PROBDATA",PACKAGE,SOURCE,.DHPVST,USER,$G(ERRDISP),.ZZERR,$G(PPEDIT),.ZZERDESC,.ACCOUNT)
"RTN","SYNDHP62",97,0)
 ;I $D(ZZERR) ZWRITE ZZERR
"RTN","SYNDHP62",98,0)
 S RETSTA=RETSTA_"^"_$G(DHPVST)
"RTN","SYNDHP62",99,0)
 I $D(ZZERDESC) M RETSTA("ZZERDESC")=ZZERDESC
"RTN","SYNDHP62",100,0)
 I $D(ZZERR) M RETSTA("ZZERR")=ZZERR
"RTN","SYNDHP62",101,0)
 M RETSTA("PROBDATA")=PROBDATA
"RTN","SYNDHP62",102,0)
 ;
"RTN","SYNDHP62",103,0)
 ; $$DATA2PCE Output:   
"RTN","SYNDHP62",104,0)
 ;+   1  if no errors and processed completely
"RTN","SYNDHP62",105,0)
 ;+  -1  if errors occurred but processed completely as possible
"RTN","SYNDHP62",106,0)
 ;+  -2  if could not get a visit
"RTN","SYNDHP62",107,0)
 ;+  -3  if called incorrectly
"RTN","SYNDHP62",108,0)
 QUIT
"RTN","SYNDHP62",109,0)
 ;
"RTN","SYNDHP62",110,0)
PRMDX(X,D) ; Check if primary diagnosis
"RTN","SYNDHP62",111,0)
 ; Input:
"RTN","SYNDHP62",112,0)
 ;   X - visit IEN
"RTN","SYNDHP62",113,0)
 ;   D - DX code IEN
"RTN","SYNDHP62",114,0)
 ; Output
"RTN","SYNDHP62",115,0)
 ;   1 if code D can be filed as primary DX
"RTN","SYNDHP62",116,0)
 ;   0 if code D can be filed as secondary DX
"RTN","SYNDHP62",117,0)
 ;  -1 if there is already a problem with DX code D files for the visit
"RTN","SYNDHP62",118,0)
 ;
"RTN","SYNDHP62",119,0)
 N IND,PRMDX,DIAG
"RTN","SYNDHP62",120,0)
 S IND=0
"RTN","SYNDHP62",121,0)
 F  S IND=$O(^AUPNVPOV("AD",X,IND)) Q:IND=""  D
"RTN","SYNDHP62",122,0)
 .I $P(^AUPNVPOV(IND,0),U,12)="P" D
"RTN","SYNDHP62",123,0)
 ..S DIAG=$P(^AUPNVPOV(IND,0),U,1)
"RTN","SYNDHP62",124,0)
 ..S PRMDX(DIAG)=""
"RTN","SYNDHP62",125,0)
 I '$D(PRMDX) Q 1  ; D is the primary DX
"RTN","SYNDHP62",126,0)
 I '$D(PRMDX(D)) Q 0  ; D is a secondary DX
"RTN","SYNDHP62",127,0)
 Q -1  ; problem with DX D already exists for visit
"RTN","SYNDHP62",128,0)
 ;
"RTN","SYNDHP62",129,0)
 ; -------- Appointment create
"RTN","SYNDHP62",130,0)
 ;
"RTN","SYNDHP62",131,0)
APPTADD(RETSTA,DHPPAT,DHPCLIN,DHPAPTDT,DHPLEN) ;Create appointment
"RTN","SYNDHP62",132,0)
 ;
"RTN","SYNDHP62",133,0)
 ;     - past appointments are created as Walk-in, NSC, Regular appointments
"RTN","SYNDHP62",134,0)
 ;     - future appointments are created as NSC, Regular appointments
"RTN","SYNDHP62",135,0)
 ;
"RTN","SYNDHP62",136,0)
 ; Input:
"RTN","SYNDHP62",137,0)
 ;   DHPPAT   - Patient ICN (required)
"RTN","SYNDHP62",138,0)
 ;   DHPCLIN  - Clinic Name (required)
"RTN","SYNDHP62",139,0)
 ;   DHPAPTDT - Appointment Date & Time (required) all dates received in HL7 format
"RTN","SYNDHP62",140,0)
 ;   DHPLEN   - Appointment length as minutes (optional, defaults to 15 mins.)
"RTN","SYNDHP62",141,0)
 ;
"RTN","SYNDHP62",142,0)
 ; Output:   RETSTA("APPT")
"RTN","SYNDHP62",143,0)
 ;  1 - success
"RTN","SYNDHP62",144,0)
 ; -1 - failure -1^message
"RTN","SYNDHP62",145,0)
 ;
"RTN","SYNDHP62",146,0)
 N PATDFN,APPTDT,APPTLEN,CHKINDT,CHKOUTDT,COFLG,CLINIEN,INACTDT,REACTDT
"RTN","SYNDHP62",147,0)
 N Y,EXDATE,BADDATE,RESULT,MSG
"RTN","SYNDHP62",148,0)
 ;
"RTN","SYNDHP62",149,0)
 I $G(DHPPAT)="" S RETSTA("APPT")="-1^Missing patient identifier (#2)." QUIT
"RTN","SYNDHP62",150,0)
 I $G(DHPCLIN)="" S RETSTA("APPT")="-1^Missing appt. location (#44)." QUIT
"RTN","SYNDHP62",151,0)
 I $G(DHPAPTDT)="" S RETSTA("APPT")="-1^Missing date/time for appt." QUIT
"RTN","SYNDHP62",152,0)
 ;
"RTN","SYNDHP62",153,0)
 I '$D(^DPT("AFICN",DHPPAT)) S RETSTA("APPT")="-1^Patient not recognised" QUIT
"RTN","SYNDHP62",154,0)
 S PATDFN=$O(^DPT("AFICN",DHPPAT,""))
"RTN","SYNDHP62",155,0)
 ;
"RTN","SYNDHP62",156,0)
 ; -- Check appointment date/time --
"RTN","SYNDHP62",157,0)
 S APPTDT=$$HL7TFM^XLFDT(DHPAPTDT)
"RTN","SYNDHP62",158,0)
 I $P(APPTDT,".",2)="" S RETSTA("APPT")="-1^Missing time for appt." QUIT
"RTN","SYNDHP62",159,0)
 ;convert to external and check date/time against Fileman date/time field
"RTN","SYNDHP62",160,0)
 S Y=APPTDT
"RTN","SYNDHP62",161,0)
 D DD^%DT
"RTN","SYNDHP62",162,0)
 S EXDATE=Y ;Convert to external
"RTN","SYNDHP62",163,0)
 D CHK^DIE(2.98,.001,"",EXDATE,.RESULT,.MSG)
"RTN","SYNDHP62",164,0)
 I RESULT="^" S RETSTA("APPT")="-1^Invalid appt date/time." QUIT
"RTN","SYNDHP62",165,0)
 ;
"RTN","SYNDHP62",166,0)
 S USER=$$DUZ^SYNDHP69
"RTN","SYNDHP62",167,0)
 ;
"RTN","SYNDHP62",168,0)
 S:$G(DHPLEN)="" APPTLEN=15 ;default appointment length
"RTN","SYNDHP62",169,0)
 ;
"RTN","SYNDHP62",170,0)
 ; -- Check Clinic --
"RTN","SYNDHP62",171,0)
 S CLINIEN=$O(^SC("B",DHPCLIN,""))
"RTN","SYNDHP62",172,0)
 I CLINIEN="" S RETSTA("APPT")="-1^Invalid clinic name (#44)." QUIT
"RTN","SYNDHP62",173,0)
 S INACTDT=$$GET1^DIQ(44,CLINIEN_",",2505,"I") ;inactivate date
"RTN","SYNDHP62",174,0)
 S REACTDT=$$GET1^DIQ(44,CLINIEN_",",2506,"I") ;reactivate date
"RTN","SYNDHP62",175,0)
 I INACTDT'="",REACTDT="",INACTDT<APPTDT S RETSTA("APPT")="-1^Clinic inactive on appt. date (#44)." QUIT
"RTN","SYNDHP62",176,0)
 I REACTDT'="",REACTDT>INACTDT,REACTDT>APPTDT S RETSTA("APPT")="-1^Clinic inactive on appt. date (#44)." QUIT
"RTN","SYNDHP62",177,0)
 I REACTDT'="",REACTDT<INACTDT,INACTDT<APPTDT S RETSTA("APPT")="-1^Clinic inactive on appt. date (#44)." QUIT
"RTN","SYNDHP62",178,0)
 ;
"RTN","SYNDHP62",179,0)
 ; -- Check for Clinic stop code --
"RTN","SYNDHP62",180,0)
 I $$GET1^DIQ(44,CLINIEN_",",8)="" D  QUIT
"RTN","SYNDHP62",181,0)
 . S RETSTA("APPT")="-1^Clinic missing STOP CODE NUMBER (#44,8)."
"RTN","SYNDHP62",182,0)
 ;
"RTN","SYNDHP62",183,0)
 I $G(DEBUG)=1 D
"RTN","SYNDHP62",184,0)
 . W "Create Appointment  APPTADD^SYNDHP62",!
"RTN","SYNDHP62",185,0)
 . W "ICN: ",DHPPAT,"   DFN: ",PATDFN,!
"RTN","SYNDHP62",186,0)
 . W "CLINIC: ",DHPCLIN,"   IEN: ",CLINIEN,!
"RTN","SYNDHP62",187,0)
 . W "APPT D/T: ",DHPAPTDT,"   ",APPTDT,!
"RTN","SYNDHP62",188,0)
 ;
"RTN","SYNDHP62",189,0)
 I $D(^DPT(PATDFN,"S",APPTDT,0)),$P($G(^DPT(PATDFN,"S",APPTDT,0)),U,2)'="C" D  QUIT
"RTN","SYNDHP62",190,0)
 . S RETSTA("APPT")="-1^Duplicate Appointment"
"RTN","SYNDHP62",191,0)
 ;
"RTN","SYNDHP62",192,0)
 ; -- create patient appointment --
"RTN","SYNDHP62",193,0)
 N FDA,ERRMSG,IENS,IENROOT
"RTN","SYNDHP62",194,0)
 S IENS="+1,"_PATDFN_","
"RTN","SYNDHP62",195,0)
 S FDA(2.98,IENS,.001)=APPTDT ;appointment date/time
"RTN","SYNDHP62",196,0)
 S FDA(2.98,IENS,.01)=CLINIEN ;clinic
"RTN","SYNDHP62",197,0)
 S FDA(2.98,IENS,3)="" ;status
"RTN","SYNDHP62",198,0)
 S FDA(2.98,IENS,9.5)=9 ;appointment type (9=regular)
"RTN","SYNDHP62",199,0)
 S FDA(2.98,IENS,19)=DUZ ;data entry clerk
"RTN","SYNDHP62",200,0)
 S FDA(2.98,IENS,20)=DT ;date appointment made
"RTN","SYNDHP62",201,0)
 S FDA(2.98,IENS,21)="" ;pointer to Encounter record (409.68)
"RTN","SYNDHP62",202,0)
 I APPTDT<$$NOW^XLFDT() D
"RTN","SYNDHP62",203,0)
 . S FDA(2.98,IENS,9)=4 ;purpose of visit (4=unscheduled visit)
"RTN","SYNDHP62",204,0)
 . S FDA(2.98,IENS,25)="W" ;sched request type (W=walk-in)
"RTN","SYNDHP62",205,0)
 . S FDA(2.98,IENS,26)=0 ;next available appt indicator
"RTN","SYNDHP62",206,0)
 E  D
"RTN","SYNDHP62",207,0)
 . S FDA(2.98,IENS,9)=3 ;purpose of visit (3=scheduled visit)
"RTN","SYNDHP62",208,0)
 . S FDA(2.98,IENS,25)="N" ;sched request type (N=next available)
"RTN","SYNDHP62",209,0)
 . S FDA(2.98,IENS,26)=1 ;next available appt indicator
"RTN","SYNDHP62",210,0)
 . S FDA(2.98,IENS,27)=$P(APPTDT,".",1) ;desired date of appointment
"RTN","SYNDHP62",211,0)
 . S FDA(2.98,IENS,28)=0 ;follow-up visit (0=no)
"RTN","SYNDHP62",212,0)
 D UPDATE^DIE("","FDA","IENROOT","ERRMSG")
"RTN","SYNDHP62",213,0)
 I $D(ERRMSG) D  QUIT
"RTN","SYNDHP62",214,0)
 . S RETSTA("APPT")="-1^Problem saving patient appointment info (#2.98) - "_$G(ERRMSG("DIERR",1,"TEXT",1))
"RTN","SYNDHP62",215,0)
 ;
"RTN","SYNDHP62",216,0)
 ; -- create clinic appointment --
"RTN","SYNDHP62",217,0)
 N FDA,IENS,ERRMSG,ERROR
"RTN","SYNDHP62",218,0)
 S IENS="+2,"_CLINIEN_","
"RTN","SYNDHP62",219,0)
 S IENS(2)=+APPTDT
"RTN","SYNDHP62",220,0)
 S ERROR=0
"RTN","SYNDHP62",221,0)
 I '$D(^SC(CLINIEN,"S",APPTDT,0)) D
"RTN","SYNDHP62",222,0)
 . S FDA(44.001,IENS,.01)=+APPTDT ;appointment date/time
"RTN","SYNDHP62",223,0)
 . D UPDATE^DIE("","FDA","IENS","ERRMSG")
"RTN","SYNDHP62",224,0)
 . I $D(ERRMSG) D  QUIT
"RTN","SYNDHP62",225,0)
 . . S RETSTA("APPT")="-1^Problem saving clinic appointment date (#44.001) - "_$G(ERRMSG("DIERR",1,"TEXT",1))
"RTN","SYNDHP62",226,0)
 . . S ERROR=1
"RTN","SYNDHP62",227,0)
 ;ZWRITE IENS
"RTN","SYNDHP62",228,0)
 QUIT:ERROR
"RTN","SYNDHP62",229,0)
 S APPTDT=$G(IENS(2))
"RTN","SYNDHP62",230,0)
 N FDA,IENS,ERRMSG
"RTN","SYNDHP62",231,0)
 S IENS="?+1,"_+APPTDT_","_CLINIEN_","
"RTN","SYNDHP62",232,0)
 S FDA(44.003,IENS,.01)=PATDFN ;patient dfn
"RTN","SYNDHP62",233,0)
 S FDA(44.003,IENS,1)=APPTLEN ;appointment length
"RTN","SYNDHP62",234,0)
 S FDA(44.003,IENS,7)=DUZ ;data entry clerk
"RTN","SYNDHP62",235,0)
 S FDA(44.003,IENS,8)=$P($$NOW^XLFDT,".",1) ;date appointment made
"RTN","SYNDHP62",236,0)
 D UPDATE^DIE("","FDA","IENS","ERRMSG")
"RTN","SYNDHP62",237,0)
 ;ZWRITE IENS
"RTN","SYNDHP62",238,0)
 I $D(ERRMSG) D  QUIT
"RTN","SYNDHP62",239,0)
 . S RETSTA("APPT")="-1^Problem saving clinic appointment (#44.003) - "_$G(ERRMSG("DIERR",1,"TEXT",1))
"RTN","SYNDHP62",240,0)
 ;
"RTN","SYNDHP62",241,0)
 S RETSTA("APPT")=1
"RTN","SYNDHP62",242,0)
 ;
"RTN","SYNDHP62",243,0)
 QUIT
"RTN","SYNDHP62",244,0)
 ;
"RTN","SYNDHP62",245,0)
 ; -------- Appointment check-in
"RTN","SYNDHP62",246,0)
 ;
"RTN","SYNDHP62",247,0)
APPTCKIN(RETSTA,DHPPAT,DHPCLIN,DHPAPTDT,DHPCIDT) ;Check-in appointment
"RTN","SYNDHP62",248,0)
 ;
"RTN","SYNDHP62",249,0)
 ; Input:
"RTN","SYNDHP62",250,0)
 ;   DHPPAT   - Patient ICN (required)
"RTN","SYNDHP62",251,0)
 ;   DHPCLIN  - Clinic Name (required)
"RTN","SYNDHP62",252,0)
 ;   DHPAPTDT - Appointment Date & Time (required) all dates received in HL7 format
"RTN","SYNDHP62",253,0)
 ;   DHPCIDT  - Check-in Date & Time (optional, will default to appointment date/time)
"RTN","SYNDHP62",254,0)
 ;
"RTN","SYNDHP62",255,0)
 ; Output:   RETSTA("CKIN")
"RTN","SYNDHP62",256,0)
 ;  1 - success
"RTN","SYNDHP62",257,0)
 ; -1 - failure -1^message
"RTN","SYNDHP62",258,0)
 ;
"RTN","SYNDHP62",259,0)
 N Y,PATDFN,APPTDT,CHKINDT,CLINIEN,EXDATE,BADDATE,RESULT,MSG,HIT,CLAPTIEN,ELIGCODE
"RTN","SYNDHP62",260,0)
 ;
"RTN","SYNDHP62",261,0)
 I $G(DHPPAT)="" S RETSTA("CKIN")="-1^Missing patient identifier (#2)." QUIT
"RTN","SYNDHP62",262,0)
 I $G(DHPCLIN)="" S RETSTA("CKIN")="-1^Missing appt. location (#44)." QUIT
"RTN","SYNDHP62",263,0)
 I $G(DHPAPTDT)="" S RETSTA("CKIN")="-1^Missing date/time for appt." QUIT
"RTN","SYNDHP62",264,0)
 ;
"RTN","SYNDHP62",265,0)
 I '$D(^DPT("AFICN",DHPPAT)) S RETSTA("CKIN")="-1^Patient not recognised" QUIT
"RTN","SYNDHP62",266,0)
 S PATDFN=$O(^DPT("AFICN",DHPPAT,""))
"RTN","SYNDHP62",267,0)
 ;
"RTN","SYNDHP62",268,0)
 ; -- Check Clinic --
"RTN","SYNDHP62",269,0)
 S CLINIEN=$O(^SC("B",DHPCLIN,""))
"RTN","SYNDHP62",270,0)
 I CLINIEN="" S RETSTA("CKIN")="-1^Invalid clinic name (#44)." QUIT
"RTN","SYNDHP62",271,0)
 ;
"RTN","SYNDHP62",272,0)
 ; -- Check appointment date/time --
"RTN","SYNDHP62",273,0)
 S APPTDT=$$HL7TFM^XLFDT(DHPAPTDT)
"RTN","SYNDHP62",274,0)
 I $P(APPTDT,".",2)="" S RETSTA("CKIN")="-1^Missing time for appt." QUIT
"RTN","SYNDHP62",275,0)
 ;convert to external and check date/time against Fileman date/time field
"RTN","SYNDHP62",276,0)
 S Y=APPTDT
"RTN","SYNDHP62",277,0)
 D DD^%DT
"RTN","SYNDHP62",278,0)
 S EXDATE=Y ;Convert to external
"RTN","SYNDHP62",279,0)
 D CHK^DIE(2.98,.001,"",EXDATE,.RESULT,.MSG)
"RTN","SYNDHP62",280,0)
 I RESULT="^" S RETSTA("CKIN")="-1^Invalid appt date/time." QUIT
"RTN","SYNDHP62",281,0)
 ;
"RTN","SYNDHP62",282,0)
 ; -- Check check-in date/time --
"RTN","SYNDHP62",283,0)
 N RESULT,MSG
"RTN","SYNDHP62",284,0)
 S BADDATE=0
"RTN","SYNDHP62",285,0)
 I $G(DHPCIDT)="" D
"RTN","SYNDHP62",286,0)
 . S CHKINDT=APPTDT
"RTN","SYNDHP62",287,0)
 E  D
"RTN","SYNDHP62",288,0)
 . S CHKINDT=$$HL7TFM^XLFDT(DHPCIDT)
"RTN","SYNDHP62",289,0)
 . I $P(CHKINDT,".",2)="" S RETSTA("CKIN")="-1^Missing time for check-in.",BADDATE=1 QUIT
"RTN","SYNDHP62",290,0)
 . ;convert to external and check date/time against Fileman date/time field
"RTN","SYNDHP62",291,0)
 . S Y=CHKINDT
"RTN","SYNDHP62",292,0)
 . D DD^%DT
"RTN","SYNDHP62",293,0)
 . S EXDATE=Y
"RTN","SYNDHP62",294,0)
 . D CHK^DIE(2.98,.001,"",EXDATE,.RESULT,.MSG)
"RTN","SYNDHP62",295,0)
 . I RESULT="^" S RETSTA("CKIN")="-1^Invalid check-in date/time.",BADDATE=1 QUIT
"RTN","SYNDHP62",296,0)
 QUIT:BADDATE
"RTN","SYNDHP62",297,0)
 ;
"RTN","SYNDHP62",298,0)
 ;check that there are both patient and clinic appointment records
"RTN","SYNDHP62",299,0)
 I '$D(^DPT(PATDFN,"S",APPTDT,0)) D  QUIT
"RTN","SYNDHP62",300,0)
 . S RETSTA("CKIN")="-1^Patient Appointment record was not found"
"RTN","SYNDHP62",301,0)
 ;
"RTN","SYNDHP62",302,0)
 S HIT=0
"RTN","SYNDHP62",303,0)
 S CLAPTIEN=0
"RTN","SYNDHP62",304,0)
 F  S CLAPTIEN=$O(^SC(CLINIEN,"S",APPTDT,1,CLAPTIEN)) QUIT:CLAPTIEN=""  D  QUIT:HIT
"RTN","SYNDHP62",305,0)
 . S:$P(^SC(CLINIEN,"S",APPTDT,1,CLAPTIEN,0),U,1)=PATDFN HIT=1
"RTN","SYNDHP62",306,0)
 I 'HIT D  QUIT
"RTN","SYNDHP62",307,0)
 . S RETSTA("CKIN")="-1^Clinic Appointment record was not found"
"RTN","SYNDHP62",308,0)
 ;
"RTN","SYNDHP62",309,0)
 I $G(DEBUG)=1 D
"RTN","SYNDHP62",310,0)
 . W "Appointment Check-in  APPTCKIN^SYNDHP62",!
"RTN","SYNDHP62",311,0)
 . W "ICN:             ",DHPPAT,"   DFN: ",PATDFN,!
"RTN","SYNDHP62",312,0)
 . W "CLINIC:          ",DHPCLIN,"   IEN: ",CLINIEN,!
"RTN","SYNDHP62",313,0)
 . W "CLINIC,APPT,IEN: ",CLAPTIEN,!
"RTN","SYNDHP62",314,0)
 . W "APPT D/T:        ",DHPAPTDT,"   ",APPTDT,!
"RTN","SYNDHP62",315,0)
 . W "CHK-IN D/T:      ",DHPCIDT,"   ",CHKINDT,!
"RTN","SYNDHP62",316,0)
 ;
"RTN","SYNDHP62",317,0)
 ; -- appointment check-in updates --
"RTN","SYNDHP62",318,0)
 ;
"RTN","SYNDHP62",319,0)
 ; clinic appointment record
"RTN","SYNDHP62",320,0)
 ;  30 - eligibility of visit 0;10
"RTN","SYNDHP62",321,0)
 ;      10 = NSC
"RTN","SYNDHP62",322,0)
 ;      11 = NSC, VA PENSION
"RTN","SYNDHP62",323,0)
 ;      15 = SC LESS THAN 50%
"RTN","SYNDHP62",324,0)
 ;      16 = SERVICE CONNECTED 50% to 100%
"RTN","SYNDHP62",325,0)
 ;  309 - checked-in (date) C;1
"RTN","SYNDHP62",326,0)
 ;  302 - check in user C;2 P200
"RTN","SYNDHP62",327,0)
 ;  305 - check in entered (date) C;5
"RTN","SYNDHP62",328,0)
 ;
"RTN","SYNDHP62",329,0)
 S ELIGCODE=$$GET1^DIQ(2,DHPPAT_",",.361,"I")
"RTN","SYNDHP62",330,0)
 S:ELIGCODE="" ELIGCODE=10
"RTN","SYNDHP62",331,0)
 N IENS,FDA,ERRMSG
"RTN","SYNDHP62",332,0)
 S IENS=CLAPTIEN_","_APPTDT_","_CLINIEN_","
"RTN","SYNDHP62",333,0)
 S FDA(44.003,IENS,30)=ELIGCODE ;eligibility of visit
"RTN","SYNDHP62",334,0)
 S FDA(44.003,IENS,309)=CHKINDT ;checked-in (date)
"RTN","SYNDHP62",335,0)
 S FDA(44.003,IENS,302)=DUZ ;check in user
"RTN","SYNDHP62",336,0)
 S FDA(44.003,IENS,305)=CHKINDT ;check in entered (date)
"RTN","SYNDHP62",337,0)
 D FILE^DIE("K","FDA","ERRMSG")
"RTN","SYNDHP62",338,0)
 I $D(ERRMSG) D  QUIT
"RTN","SYNDHP62",339,0)
 . S RETSTA("CKIN")="-1^Problem updating clinic appointment check-in info (#44.003) - "_$G(ERRMSG("DIERR",1,"TEXT",1))
"RTN","SYNDHP62",340,0)
 ;
"RTN","SYNDHP62",341,0)
 S RETSTA("CKIN")=1
"RTN","SYNDHP62",342,0)
 ;
"RTN","SYNDHP62",343,0)
 QUIT
"RTN","SYNDHP62",344,0)
 ;
"RTN","SYNDHP62",345,0)
 ; -------- Appointment check-out
"RTN","SYNDHP62",346,0)
 ;
"RTN","SYNDHP62",347,0)
APTCKOUT(RETSTA,DHPPAT,DHPCLIN,DHPAPTDT,DHPCODT) ;Check-out appointment
"RTN","SYNDHP62",348,0)
 ;>>>>>> This API currently will ONLY work for synthetic data ingest <<<<<<<
"RTN","SYNDHP62",349,0)
 ;>>>>>>  where Outpatient Encounters and Visits are created first   <<<<<<<
"RTN","SYNDHP62",350,0)
 ; Input:
"RTN","SYNDHP62",351,0)
 ;   DHPPAT   - Patient ICN (required)
"RTN","SYNDHP62",352,0)
 ;   DHPCLIN  - Clinic Name (required)
"RTN","SYNDHP62",353,0)
 ;   DHPAPTDT - Appointment Date & Time (required) all dates received in HL7 format
"RTN","SYNDHP62",354,0)
 ;   DHPCODT  - Check-out Date & Time (optional, will default to check-in date/time + 30 minutes)
"RTN","SYNDHP62",355,0)
 ;
"RTN","SYNDHP62",356,0)
 ; Output:   RETSTA("CKOUT")
"RTN","SYNDHP62",357,0)
 ;  1 - success
"RTN","SYNDHP62",358,0)
 ; -1 - failure -1^message
"RTN","SYNDHP62",359,0)
 ;
"RTN","SYNDHP62",360,0)
 N Y,PATDFN,APPTDT,CHKINDT,CHKOUTDT,CLINIEN,EXDATE,BADDATE,RESULT,MSG,HIT,CLAPTIEN,IENS
"RTN","SYNDHP62",361,0)
 ;
"RTN","SYNDHP62",362,0)
 I $G(DHPPAT)="" S RETSTA("CKOUT")="-1^Missing patient identifier (#2)." QUIT
"RTN","SYNDHP62",363,0)
 I $G(DHPCLIN)="" S RETSTA("CKOUT")="-1^Missing appt. location (#44)." QUIT
"RTN","SYNDHP62",364,0)
 I $G(DHPAPTDT)="" S RETSTA("CKOUT")="-1^Missing date/time for appt." QUIT
"RTN","SYNDHP62",365,0)
 ;
"RTN","SYNDHP62",366,0)
 I '$D(^DPT("AFICN",DHPPAT)) S RETSTA("CKOUT")="-1^Patient not recognised" QUIT
"RTN","SYNDHP62",367,0)
 S PATDFN=$O(^DPT("AFICN",DHPPAT,""))
"RTN","SYNDHP62",368,0)
 ;
"RTN","SYNDHP62",369,0)
 ; -- Check Clinic --
"RTN","SYNDHP62",370,0)
 S CLINIEN=$O(^SC("B",DHPCLIN,""))
"RTN","SYNDHP62",371,0)
 I CLINIEN="" S RETSTA("CKOUT")="-1^Invalid clinic name (#44)." QUIT
"RTN","SYNDHP62",372,0)
 ;
"RTN","SYNDHP62",373,0)
 ; -- Check appointment date/time --
"RTN","SYNDHP62",374,0)
 S APPTDT=$$HL7TFM^XLFDT(DHPAPTDT)
"RTN","SYNDHP62",375,0)
 I $P(APPTDT,".",2)="" S RETSTA("CKOUT")="-1^Missing time for appt." QUIT
"RTN","SYNDHP62",376,0)
 ;convert to external and check date/time against Fileman date/time field
"RTN","SYNDHP62",377,0)
 S Y=APPTDT
"RTN","SYNDHP62",378,0)
 D DD^%DT
"RTN","SYNDHP62",379,0)
 S EXDATE=Y ;Convert to external
"RTN","SYNDHP62",380,0)
 D CHK^DIE(2.98,.001,"",EXDATE,.RESULT,.MSG)
"RTN","SYNDHP62",381,0)
 I RESULT="^" S RETSTA("CKOUT")="-1^Invalid appt date/time." QUIT
"RTN","SYNDHP62",382,0)
 ;
"RTN","SYNDHP62",383,0)
 ;check that there are both patient and clinic appointment records
"RTN","SYNDHP62",384,0)
 I '$D(^DPT(PATDFN,"S",APPTDT,0)) D  QUIT
"RTN","SYNDHP62",385,0)
 . S RETSTA("CKOUT")="-1^Patient Appointment record was not found"
"RTN","SYNDHP62",386,0)
 ;
"RTN","SYNDHP62",387,0)
 S HIT=0
"RTN","SYNDHP62",388,0)
 S CLAPTIEN=0
"RTN","SYNDHP62",389,0)
 F  S CLAPTIEN=$O(^SC(CLINIEN,"S",APPTDT,1,CLAPTIEN)) QUIT:CLAPTIEN=""  D  QUIT:HIT
"RTN","SYNDHP62",390,0)
 . S:$P(^SC(CLINIEN,"S",APPTDT,1,CLAPTIEN,0),U,1)=PATDFN HIT=1
"RTN","SYNDHP62",391,0)
 I 'HIT D  QUIT
"RTN","SYNDHP62",392,0)
 . S RETSTA("CKOUT")="-1^Clinic Appointment record was not found"
"RTN","SYNDHP62",393,0)
 ;
"RTN","SYNDHP62",394,0)
 ; -- Get check-in date/time --
"RTN","SYNDHP62",395,0)
 S IENS=CLAPTIEN_","_APPTDT_","_CLINIEN_","
"RTN","SYNDHP62",396,0)
 S CHKINDT=$$GET1^DIQ(44.003,IENS,309,"I")
"RTN","SYNDHP62",397,0)
 I CHKINDT="" D  QUIT
"RTN","SYNDHP62",398,0)
 . S RETSTA("CKOUT")="-1^Appointment has not been checked-in"
"RTN","SYNDHP62",399,0)
 ;
"RTN","SYNDHP62",400,0)
 ; -- Check check-out date/time --
"RTN","SYNDHP62",401,0)
 N RESULT,MSG
"RTN","SYNDHP62",402,0)
 S BADDATE=0
"RTN","SYNDHP62",403,0)
 I $G(DHPCODT)="" D
"RTN","SYNDHP62",404,0)
 . S CHKOUTDT=$$FMADD^XLFDT(CHKINDT,0,0,30)
"RTN","SYNDHP62",405,0)
 E  D
"RTN","SYNDHP62",406,0)
 . S CHKOUTDT=$$HL7TFM^XLFDT(DHPCODT)
"RTN","SYNDHP62",407,0)
 . I $P(CHKOUTDT,".",2)="" S RETSTA("CKOUT")="-1^Missing time for check-out.",BADDATE=1 QUIT
"RTN","SYNDHP62",408,0)
 . ;convert to external and check date/time against Fileman date/time field
"RTN","SYNDHP62",409,0)
 . S Y=CHKOUTDT
"RTN","SYNDHP62",410,0)
 . D DD^%DT
"RTN","SYNDHP62",411,0)
 . S EXDATE=Y
"RTN","SYNDHP62",412,0)
 . D CHK^DIE(2.98,.001,"",EXDATE,.RESULT,.MSG)
"RTN","SYNDHP62",413,0)
 . I RESULT="^" S RETSTA("CKOUT")="-1^Invalid check-out date/time.",BADDATE=1 QUIT
"RTN","SYNDHP62",414,0)
 QUIT:BADDATE
"RTN","SYNDHP62",415,0)
 I CHKOUTDT'>CHKINDT S RETSTA("CKOUT")="-1^Check-out date/time must greater than check-in date." QUIT
"RTN","SYNDHP62",416,0)
 ;
"RTN","SYNDHP62",417,0)
 ;check requirements for completing check-out of appointment
"RTN","SYNDHP62",418,0)
 N COERRMSG,IDX
"RTN","SYNDHP62",419,0)
 S COERRMSG=1
"RTN","SYNDHP62",420,0)
 D CHECKCO(.COERRMSG,PATDFN,APPTDT)
"RTN","SYNDHP62",421,0)
 I COERRMSG=-1 D  QUIT
"RTN","SYNDHP62",422,0)
 . S RETSTA("CKOUT")=-1
"RTN","SYNDHP62",423,0)
 . S IDX=""
"RTN","SYNDHP62",424,0)
 . F  S IDX=$O(COERRMSG(IDX)) QUIT:IDX=""  D
"RTN","SYNDHP62",425,0)
 . . S RETSTA("CKOUT")=RETSTA("CKOUT")_"^"_COERRMSG(IDX)
"RTN","SYNDHP62",426,0)
 ;
"RTN","SYNDHP62",427,0)
 I $G(DEBUG)=1 D
"RTN","SYNDHP62",428,0)
 . W "Appointment Check-in  APTCKOUT^SYNDHP62",!
"RTN","SYNDHP62",429,0)
 . W "ICN:             ",DHPPAT,"   DFN: ",PATDFN,!
"RTN","SYNDHP62",430,0)
 . W "CLINIC:          ",DHPCLIN,"   IEN: ",CLINIEN,!
"RTN","SYNDHP62",431,0)
 . W "CLINIC,APPT,IEN: ",CLAPTIEN,!
"RTN","SYNDHP62",432,0)
 . W "APPT D/T:        ",DHPAPTDT,"   ",APPTDT,!
"RTN","SYNDHP62",433,0)
 . W "CHK-IN D/T:      ",CHKINDT,!
"RTN","SYNDHP62",434,0)
 . W "CHK-OUT D/T:     ",DHPCODT,"   ",CHKOUTDT,!
"RTN","SYNDHP62",435,0)
 ;
"RTN","SYNDHP62",436,0)
 ; -- appointment check-out updates --
"RTN","SYNDHP62",437,0)
 ;
"RTN","SYNDHP62",438,0)
 ; patient appointment record
"RTN","SYNDHP62",439,0)
 ;  update appt record with outpatient encounter ien
"RTN","SYNDHP62",440,0)
 ;    21 - outpatient encounter 0;20 P409.68
"RTN","SYNDHP62",441,0)
 ;
"RTN","SYNDHP62",442,0)
 ;get the outpatient encounter IEN for the appt. encounter record, not the stop code record
"RTN","SYNDHP62",443,0)
 N SCEIEN
"RTN","SYNDHP62",444,0)
 S SCEIEN=$O(^SCE("ADFN",PATDFN,APPTDT,""))
"RTN","SYNDHP62",445,0)
 I SCEIEN="" D  QUIT
"RTN","SYNDHP62",446,0)
 . S RETSTA("CKOUT")="-1^Could not find the outpatient encounter record."
"RTN","SYNDHP62",447,0)
 ;
"RTN","SYNDHP62",448,0)
 ; patient appointment record
"RTN","SYNDHP62",449,0)
 ;  update appt record with outpatient encounter ien
"RTN","SYNDHP62",450,0)
 ;    21 - outpatient encounter 0;20 P409.68
"RTN","SYNDHP62",451,0)
 ;
"RTN","SYNDHP62",452,0)
 N IENS,FDA,ERRMSG
"RTN","SYNDHP62",453,0)
 S IENS=APPTDT_","_PATDFN_","
"RTN","SYNDHP62",454,0)
 S FDA(2.98,IENS,21)=SCEIEN ;outpatient encounter
"RTN","SYNDHP62",455,0)
 D FILE^DIE("K","FDA","ERRMSG")
"RTN","SYNDHP62",456,0)
 I $D(ERRMSG) D  QUIT
"RTN","SYNDHP62",457,0)
 . S RETSTA("CKOUT")="-1^Problem updating patient appointment Outpat Enc pointer (#2.98) - "_$G(ERRMSG("DIERR",1,"TEXT",1))
"RTN","SYNDHP62",458,0)
 ;
"RTN","SYNDHP62",459,0)
 ; clinic appointment record
"RTN","SYNDHP62",460,0)
 ;  303 - checked out (date) C;3
"RTN","SYNDHP62",461,0)
 ;  304 - check out user C;4 P200
"RTN","SYNDHP62",462,0)
 ;  306 - check out entered (date) C;6
"RTN","SYNDHP62",463,0)
 ;
"RTN","SYNDHP62",464,0)
 N IENS,FDA,ERRMSG
"RTN","SYNDHP62",465,0)
 S IENS=CLAPTIEN_","_APPTDT_","_CLINIEN_","
"RTN","SYNDHP62",466,0)
 S FDA(44.003,IENS,303)=CHKOUTDT ;checked out (date)
"RTN","SYNDHP62",467,0)
 S FDA(44.003,IENS,304)=DUZ ;check out user
"RTN","SYNDHP62",468,0)
 S FDA(44.003,IENS,306)=CHKOUTDT ;check out entered (date)
"RTN","SYNDHP62",469,0)
 D FILE^DIE("K","FDA","ERRMSG")
"RTN","SYNDHP62",470,0)
 I $D(ERRMSG) D  QUIT
"RTN","SYNDHP62",471,0)
 . S RETSTA("CKOUT")="-1^Problem updating clinic appointment check-out info (#44.003) - "_$G(ERRMSG("DIERR",1,"TEXT",1))
"RTN","SYNDHP62",472,0)
 ;
"RTN","SYNDHP62",473,0)
 ; outpatient encounter records
"RTN","SYNDHP62",474,0)
 ;
"RTN","SYNDHP62",475,0)
 N IENS,FDA,ERRMSG
"RTN","SYNDHP62",476,0)
 S IENS=SCEIEN_","
"RTN","SYNDHP62",477,0)
 S FDA(409.68,IENS,.07)=CHKOUTDT ;check out process completion
"RTN","SYNDHP62",478,0)
 S FDA(409.68,IENS,.1)=11 ;appointment type
"RTN","SYNDHP62",479,0)
 S FDA(409.68,IENS,.12)=2 ;status
"RTN","SYNDHP62",480,0)
 D FILE^DIE("K","FDA","ERRMSG")
"RTN","SYNDHP62",481,0)
 I $D(ERRMSG) D  QUIT
"RTN","SYNDHP62",482,0)
 . S RETSTA("CKOUT")="-1^Problem updating outpatient encounter (#409.68) - "_$G(ERRMSG("DIERR",1,"TEXT",1))
"RTN","SYNDHP62",483,0)
 ;
"RTN","SYNDHP62",484,0)
 N IENS,FDA,ERRMSG
"RTN","SYNDHP62",485,0)
 S IENS=$O(^SCE("APAR",SCEIEN,""))_","
"RTN","SYNDHP62",486,0)
 S FDA(409.68,IENS,.1)=11 ;appointment type
"RTN","SYNDHP62",487,0)
 D FILE^DIE("K","FDA","ERRMSG")
"RTN","SYNDHP62",488,0)
 I $D(ERRMSG) D  QUIT
"RTN","SYNDHP62",489,0)
 . S RETSTA("CKOUT")="-1^Problem updating outpatient encounter (#409.68) - "_$G(ERRMSG("DIERR",1,"TEXT",1))
"RTN","SYNDHP62",490,0)
 ;
"RTN","SYNDHP62",491,0)
 ; visit records - no update required
"RTN","SYNDHP62",492,0)
 ;
"RTN","SYNDHP62",493,0)
 S RETSTA("CKOUT")=1
"RTN","SYNDHP62",494,0)
 ;
"RTN","SYNDHP62",495,0)
 QUIT
"RTN","SYNDHP62",496,0)
 ;
"RTN","SYNDHP62",497,0)
CHECKCO(COERRMSG,PATDFN,APPTDT) ;
"RTN","SYNDHP62",498,0)
 ;
"RTN","SYNDHP62",499,0)
 N ECNT,SCEIENP,SCEIENS,INVDATE,VIENP,VIENS,VPROV,VPOV,VCPT
"RTN","SYNDHP62",500,0)
 S ECNT=0
"RTN","SYNDHP62",501,0)
 ;
"RTN","SYNDHP62",502,0)
 S SCEIENP=$O(^SCE("ADFN",PATDFN,APPTDT,""))
"RTN","SYNDHP62",503,0)
 I SCEIENP="" D
"RTN","SYNDHP62",504,0)
 . S ECNT=ECNT+1
"RTN","SYNDHP62",505,0)
 . S COERRMSG=-1
"RTN","SYNDHP62",506,0)
 . S COERRMSG(ECNT)="No Outpatient Encounter record"
"RTN","SYNDHP62",507,0)
 ;
"RTN","SYNDHP62",508,0)
 I SCEIENP'="" D
"RTN","SYNDHP62",509,0)
 . S SCEIENS=$O(^SCE("APAR",SCEIENP,""))
"RTN","SYNDHP62",510,0)
 . I SCEIENS="" D
"RTN","SYNDHP62",511,0)
 . . S ECNT=ECNT+1
"RTN","SYNDHP62",512,0)
 . . S COERRMSG=-1
"RTN","SYNDHP62",513,0)
 . . S COERRMSG(ECNT)="No Outpatient Encounter stop code record"
"RTN","SYNDHP62",514,0)
 ;
"RTN","SYNDHP62",515,0)
 S INVDATE=9999999-$P(+APPTDT,".",1)_$S($P(+APPTDT,".",2)'="":"."_$P(+APPTDT,".",2),1:"")
"RTN","SYNDHP62",516,0)
 S VIENP=$O(^AUPNVSIT("AA",PATDFN,INVDATE,""))
"RTN","SYNDHP62",517,0)
 I VIENP="" D
"RTN","SYNDHP62",518,0)
 . S ECNT=ECNT+1
"RTN","SYNDHP62",519,0)
 . S COERRMSG=-1
"RTN","SYNDHP62",520,0)
 . S COERRMSG(ECNT)="No Visit record"
"RTN","SYNDHP62",521,0)
 ;
"RTN","SYNDHP62",522,0)
 I VIENP'="" D
"RTN","SYNDHP62",523,0)
 . S VIENS=$O(^AUPNVSIT("AD",VIENP,""))
"RTN","SYNDHP62",524,0)
 . I VIENS="" D
"RTN","SYNDHP62",525,0)
 . . S ECNT=ECNT+1
"RTN","SYNDHP62",526,0)
 . . S COERRMSG=-1
"RTN","SYNDHP62",527,0)
 . . S COERRMSG(ECNT)="No Visit stop code record"
"RTN","SYNDHP62",528,0)
 . ;
"RTN","SYNDHP62",529,0)
 . S VPROV=$O(^AUPNVPRV("AD",VIENP,""))
"RTN","SYNDHP62",530,0)
 . I VPROV="" D
"RTN","SYNDHP62",531,0)
 . . S ECNT=ECNT+1
"RTN","SYNDHP62",532,0)
 . . S COERRMSG=-1
"RTN","SYNDHP62",533,0)
 . . S COERRMSG(ECNT)="No V Provider record for Visit"
"RTN","SYNDHP62",534,0)
 . ;
"RTN","SYNDHP62",535,0)
 . S VPOV=$O(^AUPNVPOV("AD",VIENP,""))
"RTN","SYNDHP62",536,0)
 . I VPOV="" D
"RTN","SYNDHP62",537,0)
 . . S ECNT=ECNT+1
"RTN","SYNDHP62",538,0)
 . . S COERRMSG=-1
"RTN","SYNDHP62",539,0)
 . . S COERRMSG(ECNT)="No V POV record for Visit"
"RTN","SYNDHP62",540,0)
 . ;
"RTN","SYNDHP62",541,0)
 . S VCPT=$O(^AUPNVCPT("AD",VIENP,""))
"RTN","SYNDHP62",542,0)
 . I VCPT="" D
"RTN","SYNDHP62",543,0)
 . . S ECNT=ECNT+1
"RTN","SYNDHP62",544,0)
 . . S COERRMSG=-1
"RTN","SYNDHP62",545,0)
 . . S COERRMSG(ECNT)="No V CPT record for Visit"
"RTN","SYNDHP62",546,0)
 . ;
"RTN","SYNDHP62",547,0)
 QUIT
"RTN","SYNDHP62",548,0)
 ;
"RTN","SYNDHP62",549,0)
TEST ;
"RTN","SYNDHP62",550,0)
T1 S ERRDISP=1
"RTN","SYNDHP62",551,0)
 D PRBUPDT(.ZXC,"5482156687V807096",2,9990006675,,"A","5OO_EXT",267036007)
"RTN","SYNDHP62",552,0)
 Q
"RTN","SYNDHP62",553,0)
 ;"PAT":"5482156687V807096","VST":"17004","ROV":"9990006675","ONS":"20130117","ABT":"20131021","CLNST":"I","SCT":"267036007"
"RTN","SYNDHP62",554,0)
T2 S ERRDISP=1
"RTN","SYNDHP62",555,0)
 D PRBUPDT(.ZXC,"11004V412157",17003,9990006675,20160117,20161021,"I",1657008)
"RTN","SYNDHP62",556,0)
 Q
"RTN","SYNDHP62",557,0)
T3 ;
"RTN","SYNDHP62",558,0)
 S ERRDISP=1
"RTN","SYNDHP62",559,0)
 D PRBUPDT(.ZXC,"11004V412157",,9990006675,20160117,20161021,"I",1657008)
"RTN","SYNDHP62",560,0)
 Q
"RTN","SYNDHP62",561,0)
T4 ; ICD9 code that was valid at 20130117
"RTN","SYNDHP62",562,0)
 S ERRDISP=1
"RTN","SYNDHP62",563,0)
 D PRBUPDT(.ZXC,"11004V412157",17003,9990006675,20130117,20161021,"I",2251002)
"RTN","SYNDHP63")
0^10^B12371395
"RTN","SYNDHP63",1,0)
SYNDHP63 ; HC/art - HealthConcourse - Write Lab Tests to VistA ;05/29/2018
"RTN","SYNDHP63",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNDHP63",3,0)
 ;;
"RTN","SYNDHP63",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP63",5,0)
 ;
"RTN","SYNDHP63",6,0)
 QUIT
"RTN","SYNDHP63",7,0)
 ;
"RTN","SYNDHP63",8,0)
 ; -------- Create lab test for a patient
"RTN","SYNDHP63",9,0)
 ;
"RTN","SYNDHP63",10,0)
LABADD(RETSTA,DHPPAT,DHPLOC,DHPTEST,DHPRSLT,DHPRSDT,DHPLOINC) ;Create lab test
"RTN","SYNDHP63",11,0)
 ; This is a wrapper to setup a call to the ISI Lab Import processing
"RTN","SYNDHP63",12,0)
 ;
"RTN","SYNDHP63",13,0)
 ; Input:
"RTN","SYNDHP63",14,0)
 ;   DHPPAT  - Patient ICN (required)
"RTN","SYNDHP63",15,0)
 ;   DHPLOC  - Location Name (required)
"RTN","SYNDHP63",16,0)
 ;   DHPTEST - Test name (required if no valid LOINC code passed)
"RTN","SYNDHP63",17,0)
 ;   DHPRSLT - Test result value (required)
"RTN","SYNDHP63",18,0)
 ;   DHPRSDT - Test result date (required, HL7 format)
"RTN","SYNDHP63",19,0)
 ;   DHPLOINC - LOINC code
"RTN","SYNDHP63",20,0)
 ;
"RTN","SYNDHP63",21,0)
 ; Output:   RETSTA
"RTN","SYNDHP63",22,0)
 ;  1 - success
"RTN","SYNDHP63",23,0)
 ; -1 - failure -1^message
"RTN","SYNDHP63",24,0)
 ;
"RTN","SYNDHP63",25,0)
 N PATDFN,PATSSN,LABARRAY,RC,DHPRC,LOINCIEN,TESTIEN,LABTEST,SAVEIO
"RTN","SYNDHP63",26,0)
 ;send input values back to caller
"RTN","SYNDHP63",27,0)
 S RETSTA("LABINPUT","DHPPAT")=DHPPAT
"RTN","SYNDHP63",28,0)
 S RETSTA("LABINPUT","DHPLOC")=DHPLOC
"RTN","SYNDHP63",29,0)
 S RETSTA("LABINPUT","DHPTEST")=DHPTEST
"RTN","SYNDHP63",30,0)
 S RETSTA("LABINPUT","DHPRSLT")=DHPRSLT
"RTN","SYNDHP63",31,0)
 S RETSTA("LABINPUT","DHPRSDT")=DHPRSDT
"RTN","SYNDHP63",32,0)
 S RETSTA("LABINPUT","DHPLOINC")=DHPLOINC
"RTN","SYNDHP63",33,0)
 ;
"RTN","SYNDHP63",34,0)
 I $G(DHPPAT)="" S RETSTA="-1^Missing patient identifier." QUIT
"RTN","SYNDHP63",35,0)
 I $G(DHPLOC)="" S RETSTA="-1^Missing location." QUIT
"RTN","SYNDHP63",36,0)
 I $G(DHPLOINC)="",$G(DHPTEST)="" S RETSTA="-1^Missing lab test name." QUIT
"RTN","SYNDHP63",37,0)
 I $G(DHPRSLT)="" S RETSTA="-1^Missing lab test result value." QUIT
"RTN","SYNDHP63",38,0)
 I $G(DHPRSDT)="" S RETSTA="-1^Missing lab test result date/time." QUIT
"RTN","SYNDHP63",39,0)
 ;
"RTN","SYNDHP63",40,0)
 I '$D(^DPT("AFICN",DHPPAT)) S RETSTA="-1^Patient not recognised." QUIT
"RTN","SYNDHP63",41,0)
 S PATDFN=$O(^DPT("AFICN",DHPPAT,""))
"RTN","SYNDHP63",42,0)
 S PATSSN=$$GET1^DIQ(2,PATDFN_",",.09,"I") ;patient SSN
"RTN","SYNDHP63",43,0)
 I PATSSN="" S RETSTA="-1^Patient does not have an SSN." QUIT
"RTN","SYNDHP63",44,0)
 ;
"RTN","SYNDHP63",45,0)
 ; -- Check lab test date/time --
"RTN","SYNDHP63",46,0)
 S LABDTTM=$$HL7TFM^XLFDT(DHPRSDT)
"RTN","SYNDHP63",47,0)
 I $P(LABDTTM,".",2)="" S RETSTA="-1^Missing time for result date/time." QUIT
"RTN","SYNDHP63",48,0)
 ;chop off seconds
"RTN","SYNDHP63",49,0)
 S LABTM=$E($P(LABDTTM,".",2),1,4)
"RTN","SYNDHP63",50,0)
 S $P(LABDTTM,".",2)=LABTM
"RTN","SYNDHP63",51,0)
 S LABDTTM=$$HL7TFM^XLFDT($$FMTHL7^XLFDT(LABDTTM)) ;drop any trailing 0's in time
"RTN","SYNDHP63",52,0)
 ;
"RTN","SYNDHP63",53,0)
 ;Get lab test name for LOINC code
"RTN","SYNDHP63",54,0)
 I $G(DHPLOINC)'="" D
"RTN","SYNDHP63",55,0)
 . S LOINCIEN=$O(^LAB(95.3,"B",$P(DHPLOINC,"-",1),""))
"RTN","SYNDHP63",56,0)
 . QUIT:LOINCIEN=""
"RTN","SYNDHP63",57,0)
 . S TESTIEN=$O(^LAB(60,"AF",LOINCIEN,""))
"RTN","SYNDHP63",58,0)
 . QUIT:TESTIEN=""
"RTN","SYNDHP63",59,0)
 . S LABTEST=$$GET1^DIQ(60,TESTIEN_",",.01)
"RTN","SYNDHP63",60,0)
 I $G(LABTEST)="" S LABTEST=$$UP^XLFSTR(DHPTEST)
"RTN","SYNDHP63",61,0)
 I $G(LABTEST)="" S RETSTA="-1^Cannot determine lab test name." QUIT
"RTN","SYNDHP63",62,0)
 ;
"RTN","SYNDHP63",63,0)
 S LABARRAY("PAT_SSN")=PATSSN
"RTN","SYNDHP63",64,0)
 S LABARRAY("LAB_TEST")=LABTEST
"RTN","SYNDHP63",65,0)
 S LABARRAY("RESULT_DT")=LABDTTM
"RTN","SYNDHP63",66,0)
 S LABARRAY("RESULT_VAL")=DHPRSLT
"RTN","SYNDHP63",67,0)
 S LABARRAY("LOCATION")=DHPLOC
"RTN","SYNDHP63",68,0)
 S LABARRAY("LOINC")=DHPLOINC
"RTN","SYNDHP63",69,0)
 M RETSTA("LABDATA")=LABARRAY
"RTN","SYNDHP63",70,0)
 ;
"RTN","SYNDHP63",71,0)
 I $G(DEBUG)=1 D
"RTN","SYNDHP63",72,0)
 . W "ICN:      ",DHPPAT,!
"RTN","SYNDHP63",73,0)
 . W "SSN:      ",LABARRAY("PAT_SSN"),!
"RTN","SYNDHP63",74,0)
 . W "LOCATION: ",LABARRAY("LOCATION"),!
"RTN","SYNDHP63",75,0)
 . W "LOINC:    ",DHPLOINC,!
"RTN","SYNDHP63",76,0)
 . W "TEST:     ",LABARRAY("LAB_TEST"),!
"RTN","SYNDHP63",77,0)
 . W "RESULT:   ",LABARRAY("RESULT_VAL"),!
"RTN","SYNDHP63",78,0)
 . W "DATE:     ",LABARRAY("RESULT_DT"),!
"RTN","SYNDHP63",79,0)
 ;
"RTN","SYNDHP63",80,0)
 ;call ISI Labs Ingest
"RTN","SYNDHP63",81,0)
 S DUZ=$$DUZ^SYNDHP69
"RTN","SYNDHP63",82,0)
 ;
"RTN","SYNDHP63",83,0)
 S DHPRC=$$LAB^ISIIMP12(.RC,.LABARRAY)
"RTN","SYNDHP63",84,0)
 I +DHPRC=-1 S RETSTA=DHPRC QUIT
"RTN","SYNDHP63",85,0)
 ;
"RTN","SYNDHP63",86,0)
 S RETSTA=1
"RTN","SYNDHP63",87,0)
 ;
"RTN","SYNDHP63",88,0)
 QUIT
"RTN","SYNDHP63",89,0)
 ;
"RTN","SYNDHP63",90,0)
 ;
"RTN","SYNDHP63",91,0)
T1 ; test one
"RTN","SYNDHP63",92,0)
 ;
"RTN","SYNDHP63",93,0)
 M PARMS=^%wd(17.040801,1,1267,"load","labs",13,"parms")
"RTN","SYNDHP63",94,0)
 S N=""
"RTN","SYNDHP63",95,0)
 F  S N=$O(PARMS(N)) Q:N=""  S @N=PARMS(N)
"RTN","SYNDHP63",96,0)
 D LABADD(.ZXC,DHPPAT,DHPLOC,DHPLAB,DHPOBS,DHPDTM,DHPLOINC)
"RTN","SYNDHP63",97,0)
 Q
"RTN","SYNDHP64")
0^11^B1748603
"RTN","SYNDHP64",1,0)
SYNDHP64 ;DHP/AFHIL -fjf/art - HealthConcourse - Write Health Factors to VistA ; 31st July 2018
"RTN","SYNDHP64",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNDHP64",3,0)
 ;;
"RTN","SYNDHP64",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP64",5,0)
 ;
"RTN","SYNDHP64",6,0)
 QUIT
"RTN","SYNDHP64",7,0)
 ;
"RTN","SYNDHP64",8,0)
 ; -------- Create health factor for a patient
"RTN","SYNDHP64",9,0)
 ;
"RTN","SYNDHP64",10,0)
HLFADD(RETSTA,DHPPAT,DHPLOC,DHPHLF,DHPCAT,DHPCODE,DHPCOD,DHPSYS,DHPDAT,DHPPRV,DHPVST,DHPCOM,DHPUCUM,DHPMAG) ;
"RTN","SYNDHP64",11,0)
 ; Create health factor
"RTN","SYNDHP64",12,0)
 ; 
"RTN","SYNDHP64",13,0)
 ;
"RTN","SYNDHP64",14,0)
 ; Input:
"RTN","SYNDHP64",15,0)
 ;   DHPPAT  - Patient ICN (required)
"RTN","SYNDHP64",16,0)
 ;   DHPLOC  - Location Name (required)
"RTN","SYNDHP64",17,0)
 ;   DHPHLF  - Health Factor Name (include SNOMED CT or LOINC code)
"RTN","SYNDHP64",18,0)
 ;   DHPCAT  - Health Factor Category
"RTN","SYNDHP64",19,0)
 ;   DHPCOD  - Code
"RTN","SYNDHP64",20,0)
 ;   DHPSYS  - Coding system (SNOMED CT or LOINC)
"RTN","SYNDHP64",21,0)
 ;   DHPDAT  - Date
"RTN","SYNDHP64",22,0)
 ;   DHPPRV  - Provider
"RTN","SYNDHP64",23,0)
 ;   DHPVST  - Visit number
"RTN","SYNDHP64",24,0)
 ;   DHPCOM  - Comment
"RTN","SYNDHP64",25,0)
 ;   DHPUCUM - UCUM code
"RTN","SYNDHP64",26,0)
 ;   DHPMAG  - Magnitude
"RTN","SYNDHP64",27,0)
 ;
"RTN","SYNDHP64",28,0)
 ; Output:   RETSTA
"RTN","SYNDHP64",29,0)
 ;  1 - success
"RTN","SYNDHP64",30,0)
 ; -1 - failure -1^message
"RTN","SYNDHP64",31,0)
 ;
"RTN","SYNDHP64",32,0)
 I '$D(^DPT("AFICN",DHPPAT)) S RETSTA="-1^Patient not recognised" Q
"RTN","SYNDHP64",33,0)
 ;
"RTN","SYNDHP64",34,0)
 I $G(DHPSCT)="" S RETSTA="-1^SNOMED CT code is required" Q
"RTN","SYNDHP64",35,0)
 I $G(DHPVST)="" S RETSTA="-1^Visit IEN is required" Q
"RTN","SYNDHP64",36,0)
 ;
"RTN","SYNDHP64",37,0)
 ;
"RTN","SYNDHP64",38,0)
 ;S HDATA("LEVEL/SEVERITY")
"RTN","SYNDHP64",39,0)
 ; HDATA("EVENT D/T"))
"RTN","SYNDHP64",40,0)
 ; HDATA("ORD PROVIDER"))
"RTN","SYNDHP64",41,0)
 ; HDATA("ENC PROVIDER"))
"RTN","SYNDHP64",42,0)
 ;
"RTN","SYNDHP64",43,0)
 ;Magnitude and UCUM code
"RTN","SYNDHP64",44,0)
 ; HDATA("MAGNITUDE"))
"RTN","SYNDHP64",45,0)
 ; HDATA("COMMENT"))
"RTN","SYNDHP64",46,0)
 ;
"RTN","SYNDHP65")
0^51^B5073143
"RTN","SYNDHP65",1,0)
SYNDHP65 ;DHP/AFHIL -fjf - HealthConcourse - Write Procedures to VistA ; 12th Sept 2018
"RTN","SYNDHP65",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNDHP65",3,0)
 ;;
"RTN","SYNDHP65",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP65",5,0)
 ;
"RTN","SYNDHP65",6,0)
PRCADD(RETSTA,DHPPAT,DHPVST,DHPCNT,DHPSCT,DHPDTM) ;Ingest Procedures
"RTN","SYNDHP65",7,0)
 ;
"RTN","SYNDHP65",8,0)
 ; Ingest Procedures into VistA
"RTN","SYNDHP65",9,0)
 ;
"RTN","SYNDHP65",10,0)
 ; Input:
"RTN","SYNDHP65",11,0)
 ;   DHPPAT   - patient ICN              (mandatory)
"RTN","SYNDHP65",12,0)
 ;   DHPVST   - Visit Identifier         (mandatory)
"RTN","SYNDHP65",13,0)
 ;   DHPCNT   - No of times performed    (mandatory)
"RTN","SYNDHP65",14,0)
 ;   DHPSCT   - SCT Procedure code       (mandatory)   
"RTN","SYNDHP65",15,0)
 ;   DHPDTM   - Procedure Date/Time      (mandatory) HL7 format
"RTN","SYNDHP65",16,0)
 ; Output:   
"RTN","SYNDHP65",17,0)
 ;   1 - success
"RTN","SYNDHP65",18,0)
 ;  -1 - failure
"RTN","SYNDHP65",19,0)
 ;
"RTN","SYNDHP65",20,0)
 I '$D(^DPT("AFICN",DHPPAT)) S RETSTA="-1^Patient not recognised" Q
"RTN","SYNDHP65",21,0)
 ;
"RTN","SYNDHP65",22,0)
 I $G(DHPSCT)="" S RETSTA="-1^SNOMED CT code is required" Q
"RTN","SYNDHP65",23,0)
 I $G(DHPVST)="" S RETSTA="-1^Visit IEN is required" Q
"RTN","SYNDHP65",24,0)
 I '$D(^AUPNVSIT(DHPVST)) S RETSTA="-1^Visit not found" Q
"RTN","SYNDHP65",25,0)
 ;
"RTN","SYNDHP65",26,0)
 D INIT
"RTN","SYNDHP65",27,0)
 ;
"RTN","SYNDHP65",28,0)
 ; use SNOMED CT to OS5 mapping
"RTN","SYNDHP65",29,0)
 S MAPPING="sct2os5"
"RTN","SYNDHP65",30,0)
 ;
"RTN","SYNDHP65",31,0)
 S DHPOS5=$$MAP^SYNDHPMP(MAPPING,DHPSCT)
"RTN","SYNDHP65",32,0)
 I +DHPOS5'=1 S RETSTA="-1^Code "_DHPSCT_" not mapped" Q
"RTN","SYNDHP65",33,0)
 S DHPOS5=$P(DHPOS5,U,2)
"RTN","SYNDHP65",34,0)
 ;
"RTN","SYNDHP65",35,0)
 S PROCDATA("PROCEDURE",1,"PROCEDURE")=DHPOS5
"RTN","SYNDHP65",36,0)
 S PROCDATA("PROCEDURE",1,"QTY")=DHPCNT
"RTN","SYNDHP65",37,0)
 ;
"RTN","SYNDHP65",38,0)
 S DATFM=$$HL7TFM^XLFDT(DHPDTM)
"RTN","SYNDHP65",39,0)
 S PROCDATA("PROCEDURE",1,"EVENT D/T")=DATFM
"RTN","SYNDHP65",40,0)
 ;
"RTN","SYNDHP65",41,0)
 ;
"RTN","SYNDHP65",42,0)
 S RETSTA=1
"RTN","SYNDHP65",43,0)
 S RETSTA=$$DATA2PCE^PXAI("PROCDATA",PACKAGE,SOURCE,.DHPVST,USER,$G(ERRDISP),.ZZERR,$G(PPEDIT),.ZZERDESC,.ACCOUNT)
"RTN","SYNDHP65",44,0)
 ;I $D(ZZERR) ZWRITE ZZERR
"RTN","SYNDHP65",45,0)
 ;
"RTN","SYNDHP65",46,0)
 Q
"RTN","SYNDHP65",47,0)
 ;
"RTN","SYNDHP65",48,0)
INIT ; Initiate variables
"RTN","SYNDHP65",49,0)
 ;
"RTN","SYNDHP65",50,0)
 S PACKAGE=$$FIND1^DIC(9.4,,"","PCE")
"RTN","SYNDHP65",51,0)
 S SOURCE="DHP DATA INGEST"
"RTN","SYNDHP65",52,0)
 S USER=$$DUZ^SYNDHP69
"RTN","SYNDHP65",53,0)
 S ERRDISP=""
"RTN","SYNDHP65",54,0)
 I $G(DEBUG)=1 S ERRDISP=1
"RTN","SYNDHP65",55,0)
 S PPEDIT=""
"RTN","SYNDHP65",56,0)
 S ACCOUNT=""
"RTN","SYNDHP65",57,0)
 S P="|"
"RTN","SYNDHP65",58,0)
 ;
"RTN","SYNDHP65",59,0)
 S ERRDISP=1 ;for testing only, set to null otherwise  <<<<<<<<<<<<<<<<<<<<<<<
"RTN","SYNDHP65",60,0)
 S PPEDIT=""
"RTN","SYNDHP65",61,0)
 S ACCOUNT=""
"RTN","SYNDHP65",62,0)
 ;
"RTN","SYNDHP65",63,0)
 Q
"RTN","SYNDHP65",64,0)
 ;
"RTN","SYNDHP65",65,0)
T1 ;
"RTN","SYNDHP65",66,0)
 D PRCADD(.ZXC,"5000000352V586511",20559,1,56876005,20151002)
"RTN","SYNDHP65",67,0)
 Q
"RTN","SYNDHP67")
0^12^B17235437
"RTN","SYNDHP67",1,0)
SYNDHP67 ; AFHIL/fjf/art - HealthConcourse - retrieve patient TIU notes ;05/07/2019
"RTN","SYNDHP67",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP67",3,0)
 ;;
"RTN","SYNDHP67",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP67",5,0)
 ;
"RTN","SYNDHP67",6,0)
PATTIUI(RETSTA,DHPICN,FRDAT,TODAT) ; Patient TIU Notes for ICN
"RTN","SYNDHP67",7,0)
 ;
"RTN","SYNDHP67",8,0)
 ; Return patient Text Integration Utility Notes for a given patient ICN
"RTN","SYNDHP67",9,0)
 ;
"RTN","SYNDHP67",10,0)
 ; Input:
"RTN","SYNDHP67",11,0)
 ;   ICN     - unique patient identifier across all VistA systems
"RTN","SYNDHP67",12,0)
 ;   FRDAT   - from date (inclusive), optional, compared to 1201 ENTRY DATE/TIME
"RTN","SYNDHP67",13,0)
 ;   TODAT   - to date (inclusive), optional, compared to 1201 ENTRY DATE/TIME
"RTN","SYNDHP67",14,0)
 ; Output:
"RTN","SYNDHP67",15,0)
 ;   RETSTA  - a delimited string that lists the following information
"RTN","SYNDHP67",16,0)
 ;      PatientICN~ResourceID|DateTime|NoteStatus|NoteConfidentiality
"RTN","SYNDHP67",17,0)
 ;        |NoteAuthor|NoteLine(1)^NoteLine(2)^NoteLine(3)...
"RTN","SYNDHP67",18,0)
 ;        ^NoteLine(n)^|LOINC Code_LOINC Name~...
"RTN","SYNDHP67",19,0)
 ;
"RTN","SYNDHP67",20,0)
 ;  Identifier will be "V"_SITE ID_FILE #_FILE IEN   i.e. V_500_8925_930
"RTN","SYNDHP67",21,0)
 ;
"RTN","SYNDHP67",22,0)
 S FRDAT=$S($G(FRDAT):$$HL7TFM^XLFDT(FRDAT),1:1000101)
"RTN","SYNDHP67",23,0)
 S TODAT=$S($G(TODAT):$$HL7TFM^XLFDT(TODAT),1:9991231)
"RTN","SYNDHP67",24,0)
 I $G(DEBUG) W !,"FRDAT: ",FRDAT,"   TODAT: ",TODAT,!
"RTN","SYNDHP67",25,0)
 I FRDAT>TODAT S RETSTA="-1^From date is greater than to date" QUIT
"RTN","SYNDHP67",26,0)
 ;
"RTN","SYNDHP67",27,0)
 ; validate ICN
"RTN","SYNDHP67",28,0)
 I $G(DHPICN)="" S RETSTA="-1^What patient?" QUIT
"RTN","SYNDHP67",29,0)
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTA="-1^Patient identifier not recognised" Q
"RTN","SYNDHP67",30,0)
 ;
"RTN","SYNDHP67",31,0)
 N P,S,T,SITE,USER,PATIEN,NTS,NT,NTX,NTIEN,VID,NTSTA,NTDTMFM,NTDTM,NTAUTH,NCONF,NTLS,NTL
"RTN","SYNDHP67",32,0)
 S P="|",S="_",T="~"
"RTN","SYNDHP67",33,0)
 S U=$G(U,"^")
"RTN","SYNDHP67",34,0)
 I '$D(DT) S DT=$$DT^XLFDT
"RTN","SYNDHP67",35,0)
 S DUZ=$G(DUZ,1)
"RTN","SYNDHP67",36,0)
 S USER=$G(DUZ,1),DUZ("AG")="V"
"RTN","SYNDHP67",37,0)
 S SITE=$P($$SITE^VASITE,"^",3)
"RTN","SYNDHP67",38,0)
 ;
"RTN","SYNDHP67",39,0)
 ; get list of notes for patient
"RTN","SYNDHP67",40,0)
 S RETSTA=DHPICN
"RTN","SYNDHP67",41,0)
 S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP67",42,0)
 I PATIEN="" S RETSTA="-1^Internal data structure error" QUIT
"RTN","SYNDHP67",43,0)
 ;
"RTN","SYNDHP67",44,0)
 N ZXC
"RTN","SYNDHP67",45,0)
 D NOTES^TIUSRVLO(.ZXC,PATIEN,,,USER)
"RTN","SYNDHP67",46,0)
 ; now scan list for individual notes
"RTN","SYNDHP67",47,0)
 S NTS=$NA(@ZXC)
"RTN","SYNDHP67",48,0)
 S NT=0
"RTN","SYNDHP67",49,0)
 ; set generic LOINC code required by Azure implementation of FHIR
"RTN","SYNDHP67",50,0)
 N NTLOINC S NTLOINC="11506-3_Provider-unspecified Progress note"
"RTN","SYNDHP67",51,0)
 F  S NT=$O(@NTS@(NT)) Q:NT=""  D
"RTN","SYNDHP67",52,0)
 .I $E(RETSTA,$L(RETSTA))=U S RETSTA=$E(RETSTA,1,$L(RETSTA)-1)
"RTN","SYNDHP67",53,0)
 .S NTX=@NTS@(NT)
"RTN","SYNDHP67",54,0)
 .S NTIEN=$P(NTX,U)
"RTN","SYNDHP67",55,0)
 .S NTDTMFM=$$GET1^DIQ(8925,NTIEN_",",1201,"I")
"RTN","SYNDHP67",56,0)
 .QUIT:((NTDTMFM\1)<FRDAT)!((NTDTMFM\1)>TODAT)  ;quit if outside of requested date range
"RTN","SYNDHP67",57,0)
 .S RETSTA=RETSTA_T
"RTN","SYNDHP67",58,0)
 .S VID=$$RESID^SYNDHP69("V",SITE)_S_8925_S_NTIEN
"RTN","SYNDHP67",59,0)
 .S NTSTA=$P(NTX,U,7)
"RTN","SYNDHP67",60,0)
 .S NTSTA=$$NOTSTAT(NTSTA)
"RTN","SYNDHP67",61,0)
 .S NTDTM=$$FMTHL7^XLFDT(NTDTMFM)
"RTN","SYNDHP67",62,0)
 .S NTAUTH=$$GET1^DIQ(8925,NTIEN_",",1202,"I")
"RTN","SYNDHP67",63,0)
 .S NTAUTH=$$GET1^DIQ(200,NTAUTH_",",41.99)
"RTN","SYNDHP67",64,0)
 .; note confidentiality
"RTN","SYNDHP67",65,0)
 .S NCONF="N"
"RTN","SYNDHP67",66,0)
 .;W !,NT,"  -  ",NTSTA,!
"RTN","SYNDHP67",67,0)
 .S RETSTA=RETSTA_VID_P_NTDTM_P_NTSTA_P_NCONF_P_NTAUTH_P ;_NTLOINC_P
"RTN","SYNDHP67",68,0)
 .; now get note text
"RTN","SYNDHP67",69,0)
 .N ZXCV,NTLTX
"RTN","SYNDHP67",70,0)
 .D TGET^TIUSRVR1(.ZXCV,NTIEN)
"RTN","SYNDHP67",71,0)
 .;ZW @ZXCV
"RTN","SYNDHP67",72,0)
 .S NTLS=$NA(@ZXCV)
"RTN","SYNDHP67",73,0)
 .S NTL=0
"RTN","SYNDHP67",74,0)
 .F  S NTL=$O(@NTLS@(NTL)) Q:NTL=""  D
"RTN","SYNDHP67",75,0)
 ..S NTLTX=@NTLS@(NTL)
"RTN","SYNDHP67",76,0)
 ..S RETSTA=RETSTA_NTLTX_U
"RTN","SYNDHP67",77,0)
 .S RETSTA=RETSTA_P_NTLOINC_P
"RTN","SYNDHP67",78,0)
 Q
"RTN","SYNDHP67",79,0)
 ;
"RTN","SYNDHP67",80,0)
NOTSTAT(X) ; Note status mapping
"RTN","SYNDHP67",81,0)
 ; the VistA status must map to one of the following FHIR statii
"RTN","SYNDHP67",82,0)
 ;   preliminary | final | amended | entered-in-error
"RTN","SYNDHP67",83,0)
 ;
"RTN","SYNDHP67",84,0)
 ; X is External Status value (8925, .05) converted to lower case
"RTN","SYNDHP67",85,0)
 ;
"RTN","SYNDHP67",86,0)
 ;  statii from TIU(8925.6
"RTN","SYNDHP67",87,0)
 ;    1)="UNDICTATED^preliminary"
"RTN","SYNDHP67",88,0)
 ;    2)="UNTRANSCRIBED^preliminary"
"RTN","SYNDHP67",89,0)
 ;    3)="UNRELEASED^preliminary"
"RTN","SYNDHP67",90,0)
 ;    4)="UNVERIFIED^preliminary"
"RTN","SYNDHP67",91,0)
 ;    5)="UNSIGNED^preliminary"
"RTN","SYNDHP67",92,0)
 ;    6)="UNCOSIGNED^preliminary"
"RTN","SYNDHP67",93,0)
 ;    7)="COMPLETED^final"
"RTN","SYNDHP67",94,0)
 ;    8)="AMENDED^amended"
"RTN","SYNDHP67",95,0)
 ;    9)="PURGED^entered-in-error"
"RTN","SYNDHP67",96,0)
 ;    10)="TEST^entered-in-error"
"RTN","SYNDHP67",97,0)
 ;    11)="ACTIVE^preliminary"
"RTN","SYNDHP67",98,0)
 ;    13)="INACTIVE^preliminary"
"RTN","SYNDHP67",99,0)
 ;    14)="DELETED^enered-in-error"
"RTN","SYNDHP67",100,0)
 ;    15)="RETRACTED^entered-in-error"
"RTN","SYNDHP67",101,0)
 ;
"RTN","SYNDHP67",102,0)
 ;
"RTN","SYNDHP67",103,0)
 ; converted to values returned by TIU RPC
"RTN","SYNDHP67",104,0)
 ;
"RTN","SYNDHP67",105,0)
 N XNS
"RTN","SYNDHP67",106,0)
 S XNS("active")="preliminary"
"RTN","SYNDHP67",107,0)
 S XNS("amended")="amended"
"RTN","SYNDHP67",108,0)
 S XNS("completed")="final"
"RTN","SYNDHP67",109,0)
 S XNS("deleted")="enered-in-error"
"RTN","SYNDHP67",110,0)
 S XNS("inactive")="preliminary"
"RTN","SYNDHP67",111,0)
 S XNS("purged")="entered-in-error"
"RTN","SYNDHP67",112,0)
 S XNS("retracted")="entered-in-error"
"RTN","SYNDHP67",113,0)
 S XNS("test")="entered-in-error"
"RTN","SYNDHP67",114,0)
 S XNS("uncosigned")="preliminary"
"RTN","SYNDHP67",115,0)
 S XNS("undictated")="preliminary"
"RTN","SYNDHP67",116,0)
 S XNS("unreleased")="preliminary"
"RTN","SYNDHP67",117,0)
 S XNS("unsigned")="preliminary"
"RTN","SYNDHP67",118,0)
 S XNS("untranscribed")="preliminary"
"RTN","SYNDHP67",119,0)
 S XNS("unverified")="preliminary"
"RTN","SYNDHP67",120,0)
 ; 
"RTN","SYNDHP67",121,0)
 Q:$D(XNS(X)) $P(XNS(X),U)
"RTN","SYNDHP67",122,0)
 Q "error - composition status not recognised"
"RTN","SYNDHP67",123,0)
 ;
"RTN","SYNDHP67",124,0)
 ; ----------- Unit Test -----------
"RTN","SYNDHP67",125,0)
T1 ;
"RTN","SYNDHP67",126,0)
 N ZXC
"RTN","SYNDHP67",127,0)
 D PATTIUI(.ZXC,"5000000001V324625")
"RTN","SYNDHP67",128,0)
 Q
"RTN","SYNDHP67",129,0)
T2 ;
"RTN","SYNDHP67",130,0)
 N ZXS
"RTN","SYNDHP67",131,0)
 D PATTIUI(.ZXS,"11004V412157")
"RTN","SYNDHP67",132,0)
 Q
"RTN","SYNDHP67",133,0)
 ;
"RTN","SYNDHP67",134,0)
T3 ;
"RTN","SYNDHP67",135,0)
 N ICN S ICN="9009373208V847154"
"RTN","SYNDHP67",136,0)
 N FRDAT S FRDAT=""
"RTN","SYNDHP67",137,0)
 N TODAT S TODAT=""
"RTN","SYNDHP67",138,0)
 N RETSTA
"RTN","SYNDHP67",139,0)
 D PATTIUI(.RETSTA,ICN,FRDAT,TODAT)
"RTN","SYNDHP67",140,0)
 W $$ZW^SYNDHPUTL("RETSTA")
"RTN","SYNDHP67",141,0)
 QUIT
"RTN","SYNDHP67",142,0)
 ;
"RTN","SYNDHP69")
0^13^B4950282
"RTN","SYNDHP69",1,0)
SYNDHP69 ;AFHIL-DHP/fjf - HealthConcourse - Common Utility Functions
"RTN","SYNDHP69",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNDHP69",3,0)
 ;;
"RTN","SYNDHP69",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP69",5,0)
 Q
"RTN","SYNDHP69",6,0)
 ;
"RTN","SYNDHP69",7,0)
DUZ() ; issues/set DUZ
"RTN","SYNDHP69",8,0)
 I '$D(DT) S DT=$$DT^XLFDT
"RTN","SYNDHP69",9,0)
 N VASITE S VASITE=$$SITE^VASITE
"RTN","SYNDHP69",10,0)
 N SITE S SITE=$P(VASITE,"^",3)
"RTN","SYNDHP69",11,0)
 S DUZ=$S(+$G(DUZ)=0:1,1:DUZ)
"RTN","SYNDHP69",12,0)
 S DUZ("AG")="V",DUZ(2)=+SITE ;'temporary' fix for lab accession
"RTN","SYNDHP69",13,0)
 Q DUZ
"RTN","SYNDHP69",14,0)
 ;
"RTN","SYNDHP69",15,0)
 ;
"RTN","SYNDHP69",16,0)
RESID(ENT,SITE) ; resource ID
"RTN","SYNDHP69",17,0)
 ; some rudimenatary validatation inputs
"RTN","SYNDHP69",18,0)
 ;
"RTN","SYNDHP69",19,0)
 N S
"RTN","SYNDHP69",20,0)
 S S="_"
"RTN","SYNDHP69",21,0)
 Q ENT_S_SITE_$$FACID
"RTN","SYNDHP69",22,0)
 ;
"RTN","SYNDHP69",23,0)
 ;
"RTN","SYNDHP69",24,0)
FACID() ; Get facility parameter to append to site
"RTN","SYNDHP69",25,0)
 ;
"RTN","SYNDHP69",26,0)
 N XPARSYS
"RTN","SYNDHP69",27,0)
 Q $$GET^XPAR("SYS","SYNDHPFAC",1)
"RTN","SYNDHP69",28,0)
 ;
"RTN","SYNDHP69",29,0)
 ;
"RTN","SYNDHP69",30,0)
GETFACID(RETSTA,X) ; Get facility parameter
"RTN","SYNDHP69",31,0)
 ;
"RTN","SYNDHP69",32,0)
 S RETSTA=$$FACID
"RTN","SYNDHP69",33,0)
 Q
"RTN","SYNDHP69",34,0)
 ;
"RTN","SYNDHP69",35,0)
FACPAR(RETSTA,DHPFAC) ; Setup/delete faciltity identification parameter
"RTN","SYNDHP69",36,0)
 ;
"RTN","SYNDHP69",37,0)
 ; Input:
"RTN","SYNDHP69",38,0)
 ;   DHPFAC - facility identifier
"RTN","SYNDHP69",39,0)
 ;     ER     - Emergency Room
"RTN","SYNDHP69",40,0)
 ;     HOSP   - Hospital
"RTN","SYNDHP69",41,0)
 ;     SCLIN  - Specialist Clinic
"RTN","SYNDHP69",42,0)
 ;     HS     - HealthShare
"RTN","SYNDHP69",43,0)
 ;     @      - delete
"RTN","SYNDHP69",44,0)
 ;   
"RTN","SYNDHP69",45,0)
 S RETSTA=0
"RTN","SYNDHP69",46,0)
 I "^ER^SCLIN^HOSP^HS^@"'[DHPFAC S RETSTA=0_"^error" Q
"RTN","SYNDHP69",47,0)
 I $$CKPRDF=0 S RETSTA=0_"^parameter definition error" Q
"RTN","SYNDHP69",48,0)
 ;
"RTN","SYNDHP69",49,0)
 ; add the parameter if it doesn't exist, or delete for FAC="@"
"RTN","SYNDHP69",50,0)
 K ZZERR
"RTN","SYNDHP69",51,0)
 D EN^XPAR("SYS","SYNDHPFAC",,DHPFAC,.ZZERR)
"RTN","SYNDHP69",52,0)
 S RETSTA='ZZERR
"RTN","SYNDHP69",53,0)
 Q
"RTN","SYNDHP69",54,0)
 ;
"RTN","SYNDHP69",55,0)
CKPRDF() ; Check that parameter definition exists for SYNDHPFAC
"RTN","SYNDHP69",56,0)
 ;       and it it doesn't exist, create it
"RTN","SYNDHP69",57,0)
 N FN,FDA,ZZERR
"RTN","SYNDHP69",58,0)
 S FN=8989.51
"RTN","SYNDHP69",59,0)
 I +$$FIND1^DIC(FN,,"MX","SYNDHPFAC")'=0 Q 1
"RTN","SYNDHP69",60,0)
 S FDA(FN,"+1,",.01)="SYNDHPFAC"
"RTN","SYNDHP69",61,0)
 S FDA(FN,"+1,",.02)="SYNDHP Facility Parameter"
"RTN","SYNDHP69",62,0)
 S FDA(FN,"+1,",1.1)="F"
"RTN","SYNDHP69",63,0)
 K ZZERR
"RTN","SYNDHP69",64,0)
 D UPDATE^DIE(,"FDA",,"ZZERR")
"RTN","SYNDHP69",65,0)
 Q '$D(ZZERR)
"RTN","SYNDHP69",66,0)
 ;
"RTN","SYNDHP69",67,0)
 ;
"RTN","SYNDHP69",68,0)
LOGRST(RETSTA) ; expunge ^VPRHTTP("log")
"RTN","SYNDHP69",69,0)
 ;
"RTN","SYNDHP69",70,0)
 N QT
"RTN","SYNDHP69",71,0)
 S QT=""""
"RTN","SYNDHP69",72,0)
 K ^VPRHTTP("log")
"RTN","SYNDHP69",73,0)
 S RETSTA="Mission accomplished - ^VPRHTTP("_QT_"log"_QT_")"_" annihilated"
"RTN","SYNDHP69",74,0)
 Q
"RTN","SYNDHP69",75,0)
 ;
"RTN","SYNDHP69",76,0)
 ;
"RTN","SYNDHP69",77,0)
TEST D EN^%ut($T(+0),1) QUIT
"RTN","SYNDHP69",78,0)
T1 ; @TEST HASHINFO^ORDEA previously crashed due to bad DUZ(2)
"RTN","SYNDHP69",79,0)
 S DUZ=$$DUZ()
"RTN","SYNDHP69",80,0)
 N ORY
"RTN","SYNDHP69",81,0)
 D HASHINFO^ORDEA(.ORY,1,$$PROV^SYNINIT)
"RTN","SYNDHP69",82,0)
 D SUCCEED^%ut
"RTN","SYNDHP69",83,0)
 QUIT
"RTN","SYNDHP69",84,0)
 ;
"RTN","SYNDHP73")
0^14^B176773227
"RTN","SYNDHP73",1,0)
SYNDHP73 ;AFHIL DHP/fjf/art - HealthConcourse - DHP REST handlers ;03/27/2019
"RTN","SYNDHP73",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP73",3,0)
 ;;
"RTN","SYNDHP73",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP73",5,0)
 ;  -------------------------------
"RTN","SYNDHP73",6,0)
 ;  Patient validate bridge routine
"RTN","SYNDHP73",7,0)
 ;  -------------------------------
"RTN","SYNDHP73",8,0)
 ;
"RTN","SYNDHP73",9,0)
PATVAL ; Verify patient on basis of name, SSN, DoB, Gender and Mother's Maiden name 
"RTN","SYNDHP73",10,0)
 ;parse out RPC call parameters from REST request
"RTN","SYNDHP73",11,0)
 ;  
"RTN","SYNDHP73",12,0)
 ;   DHPPATVAL
"RTN","SYNDHP73",13,0)
 ;
"RTN","SYNDHP73",14,0)
 ;S $ZT="^ZTER"
"RTN","SYNDHP73",15,0)
 D PARSEVAL
"RTN","SYNDHP73",16,0)
 ;
"RTN","SYNDHP73",17,0)
 D PATVAL^SYNDHP43(.RETSTA,DHPNAME,DHPSSN,DHPDOB,DHPGENDER,DHPMMDNM)
"RTN","SYNDHP73",18,0)
 ; RETSTA is string returned by 
"RTN","SYNDHP73",19,0)
 ;S RETSTA="NOTHING SUCCEEDS LIKE A BUDGIE"
"RTN","SYNDHP73",20,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",21,0)
 ;
"RTN","SYNDHP73",22,0)
 Q
"RTN","SYNDHP73",23,0)
 ;
"RTN","SYNDHP73",24,0)
PARSEVAL ; 
"RTN","SYNDHP73",25,0)
 ;
"RTN","SYNDHP73",26,0)
 F I="SSN","DOB","GENDER","MMDNM" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",27,0)
 S DHPNAME=$$GETPARAM^RGNETWWW("NAME",1,1)
"RTN","SYNDHP73",28,0)
 S DHPNAME=DHPNAME_","_$$GETPARAM^RGNETWWW("NAME",1,2)_" "
"RTN","SYNDHP73",29,0)
 Q
"RTN","SYNDHP73",30,0)
 ;
"RTN","SYNDHP73",31,0)
 ;  ---------------------------------------------
"RTN","SYNDHP73",32,0)
 ;  Patient demographics by traits bridge routine
"RTN","SYNDHP73",33,0)
 ;  ---------------------------------------------
"RTN","SYNDHP73",34,0)
 ;
"RTN","SYNDHP73",35,0)
PATDEM ; get patient demographics for one patient
"RTN","SYNDHP73",36,0)
 ;
"RTN","SYNDHP73",37,0)
 ;   DHPPATDEM
"RTN","SYNDHP73",38,0)
 ;
"RTN","SYNDHP73",39,0)
 D PARSEDEM
"RTN","SYNDHP73",40,0)
 D PATDEM^SYNDHP47(.RETSTA,DHPNAME,DHPSSN,DHPDOB,DHPGENDER,DHPJSON)
"RTN","SYNDHP73",41,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",42,0)
 Q
"RTN","SYNDHP73",43,0)
 ;
"RTN","SYNDHP73",44,0)
PARSEDEM ;
"RTN","SYNDHP73",45,0)
 ;
"RTN","SYNDHP73",46,0)
 F I="SSN","DOB","GENDER","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",47,0)
 S DHPNAME=$$GETPARAM^RGNETWWW("NAME",1,1)
"RTN","SYNDHP73",48,0)
 S DHPNAME=DHPNAME_","_$$GETPARAM^RGNETWWW("NAME",1,2)_" "
"RTN","SYNDHP73",49,0)
 Q
"RTN","SYNDHP73",50,0)
 ;
"RTN","SYNDHP73",51,0)
 ;  ------------------------------------------
"RTN","SYNDHP73",52,0)
 ;  Patient demographics by ICN bridge routine
"RTN","SYNDHP73",53,0)
 ;  ------------------------------------------
"RTN","SYNDHP73",54,0)
 ;
"RTN","SYNDHP73",55,0)
PATDEMI ; get patient demographics for one patient
"RTN","SYNDHP73",56,0)
 ;
"RTN","SYNDHP73",57,0)
 ;   DHPPATDEMICN
"RTN","SYNDHP73",58,0)
 ;
"RTN","SYNDHP73",59,0)
 D PARSEICN
"RTN","SYNDHP73",60,0)
 F I="JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",61,0)
 D PATDEMI^SYNDHP47(.RETSTA,DHPICN,DHPJSON)
"RTN","SYNDHP73",62,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",63,0)
 Q
"RTN","SYNDHP73",64,0)
 ;
"RTN","SYNDHP73",65,0)
 ;  ----------------------------------------------------
"RTN","SYNDHP73",66,0)
 ;  All patient demographics by ICN="ALL" bridge routine
"RTN","SYNDHP73",67,0)
 ;  ----------------------------------------------------
"RTN","SYNDHP73",68,0)
 ;
"RTN","SYNDHP73",69,0)
PATDEMAL ; get patient demographics for all patients
"RTN","SYNDHP73",70,0)
 ;
"RTN","SYNDHP73",71,0)
 ;   DHPPATDEMALL
"RTN","SYNDHP73",72,0)
 ;
"RTN","SYNDHP73",73,0)
 D PARSEICN
"RTN","SYNDHP73",74,0)
 F I="JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",75,0)
 D PATDEMAL^SYNDHP47(.RETSTA,DHPICN,DHPJSON)
"RTN","SYNDHP73",76,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",77,0)
 Q
"RTN","SYNDHP73",78,0)
 ;
"RTN","SYNDHP73",79,0)
 ;  ----------------------------------------------------
"RTN","SYNDHP73",80,0)
 ;  All patient ICN's bridge routine
"RTN","SYNDHP73",81,0)
 ;  ----------------------------------------------------
"RTN","SYNDHP73",82,0)
 ;
"RTN","SYNDHP73",83,0)
PATICNS ; get patient ICN for all patients
"RTN","SYNDHP73",84,0)
 ;
"RTN","SYNDHP73",85,0)
 ;   DHPPATICNALL
"RTN","SYNDHP73",86,0)
 ;
"RTN","SYNDHP73",87,0)
 F I="CNT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",88,0)
 D ICNS^SYNDHPIC(.RETSTA,DHPCNT,DHPJSON)
"RTN","SYNDHP73",89,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",90,0)
 Q
"RTN","SYNDHP73",91,0)
 ;  ----------------------------------------------------
"RTN","SYNDHP73",92,0)
 ;  All patient demographics by ICN=range bridge routine
"RTN","SYNDHP73",93,0)
 ;  ----------------------------------------------------
"RTN","SYNDHP73",94,0)
 ;
"RTN","SYNDHP73",95,0)
PATDEMRG ; get patient demographics for a range of patients
"RTN","SYNDHP73",96,0)
 ;
"RTN","SYNDHP73",97,0)
 ;   DHPPATDEMRNG
"RTN","SYNDHP73",98,0)
 ;
"RTN","SYNDHP73",99,0)
 D PARSEICN
"RTN","SYNDHP73",100,0)
 F I="JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",101,0)
 D PATDEMRNG^SYNDHP47(.RETSTA,DHPICN,DHPJSON)
"RTN","SYNDHP73",102,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",103,0)
 Q
"RTN","SYNDHP73",104,0)
 ;
"RTN","SYNDHP73",105,0)
 ;  ----------------------------------------------------
"RTN","SYNDHP73",106,0)
 ;  Patient condition SCT codes by traits bridge routine
"RTN","SYNDHP73",107,0)
 ;  ----------------------------------------------------
"RTN","SYNDHP73",108,0)
 ;
"RTN","SYNDHP73",109,0)
PATCON ; get patient condition SCT codes for one patient by traits
"RTN","SYNDHP73",110,0)
 ;
"RTN","SYNDHP73",111,0)
 ;   DHPPATCON
"RTN","SYNDHP73",112,0)
 ;
"RTN","SYNDHP73",113,0)
 D PARSECON
"RTN","SYNDHP73",114,0)
 D PATCONDS^SYNDHP03(.RETSTA,DHPNAME,DHPSSN,DHPDOB,DHPGENDER)
"RTN","SYNDHP73",115,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",116,0)
 Q
"RTN","SYNDHP73",117,0)
 ;
"RTN","SYNDHP73",118,0)
PARSECON ;
"RTN","SYNDHP73",119,0)
 ; 
"RTN","SYNDHP73",120,0)
 F I="SSN","DOB","GENDER" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",121,0)
 S DHPNAME=$$GETPARAM^RGNETWWW("NAME",1,1)
"RTN","SYNDHP73",122,0)
 S DHPNAME=DHPNAME_","_$$GETPARAM^RGNETWWW("NAME",1,2)_" "
"RTN","SYNDHP73",123,0)
 Q
"RTN","SYNDHP73",124,0)
 ;
"RTN","SYNDHP73",125,0)
 ;  ----------------------------------------
"RTN","SYNDHP73",126,0)
 ;  Patient conditions by ICN bridge routine
"RTN","SYNDHP73",127,0)
 ;  ----------------------------------------
"RTN","SYNDHP73",128,0)
 ;
"RTN","SYNDHP73",129,0)
PATCONI ; get patient conditions for one patient by ICN
"RTN","SYNDHP73",130,0)
 ;
"RTN","SYNDHP73",131,0)
 ;   DHPPATCONICN
"RTN","SYNDHP73",132,0)
 ;
"RTN","SYNDHP73",133,0)
 D PARSEICN
"RTN","SYNDHP73",134,0)
 F I="FRDAT","TODAT" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",135,0)
 D PATCONI^SYNDHP03(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
"RTN","SYNDHP73",136,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",137,0)
 Q
"RTN","SYNDHP73",138,0)
 ;
"RTN","SYNDHP73",139,0)
 ;  --------------------------------------------------------
"RTN","SYNDHP73",140,0)
 ;  Patient encounters for one patient by ICN bridge routine
"RTN","SYNDHP73",141,0)
 ;  --------------------------------------------------------
"RTN","SYNDHP73",142,0)
 ;
"RTN","SYNDHP73",143,0)
PATENCI ; get patient encounters for one patient by ICN
"RTN","SYNDHP73",144,0)
 ;
"RTN","SYNDHP73",145,0)
 ;   DHPPATENCICN
"RTN","SYNDHP73",146,0)
 ;
"RTN","SYNDHP73",147,0)
 D PARSEICN
"RTN","SYNDHP73",148,0)
 F I="FRDAT","TODAT" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",149,0)
 D PATENCI^SYNDHP40(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
"RTN","SYNDHP73",150,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",151,0)
 Q
"RTN","SYNDHP73",152,0)
 ;  
"RTN","SYNDHP73",153,0)
 ;  ---------------------------------------
"RTN","SYNDHP73",154,0)
 ;  Patients for a condition bridge routine
"RTN","SYNDHP73",155,0)
 ;  ---------------------------------------
"RTN","SYNDHP73",156,0)
 ;
"RTN","SYNDHP73",157,0)
PATCONAL ; get patients for a condition
"RTN","SYNDHP73",158,0)
 ;
"RTN","SYNDHP73",159,0)
 ;   DHPPATS4CON
"RTN","SYNDHP73",160,0)
 ;
"RTN","SYNDHP73",161,0)
 D PARSECONAL
"RTN","SYNDHP73",162,0)
 D PATCONAL^SYNDHP03(.RETSTA,DHPSCT)
"RTN","SYNDHP73",163,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",164,0)
 Q
"RTN","SYNDHP73",165,0)
 ;
"RTN","SYNDHP73",166,0)
PARSECONAL ; generalise
"RTN","SYNDHP73",167,0)
 ; 
"RTN","SYNDHP73",168,0)
 F I="SCT" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",169,0)
 Q
"RTN","SYNDHP73",170,0)
 ;
"RTN","SYNDHP73",171,0)
 ;  --------------------------------------------------
"RTN","SYNDHP73",172,0)
 ;  Patient medication statement by ICN bridge routine
"RTN","SYNDHP73",173,0)
 ;  --------------------------------------------------
"RTN","SYNDHP73",174,0)
 ;
"RTN","SYNDHP73",175,0)
PATMEDS ; get patient medication statement for one patient by ICN
"RTN","SYNDHP73",176,0)
 ;
"RTN","SYNDHP73",177,0)
 ;   DHPPATMEDSICN
"RTN","SYNDHP73",178,0)
 ;
"RTN","SYNDHP73",179,0)
 D PARSEICN
"RTN","SYNDHP73",180,0)
 F I="FRDAT","TODAT" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",181,0)
 D PATMEDS^SYNDHP48(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
"RTN","SYNDHP73",182,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",183,0)
 Q
"RTN","SYNDHP73",184,0)
 ;
"RTN","SYNDHP73",185,0)
 ;  -------------------------------------------------------
"RTN","SYNDHP73",186,0)
 ;  Patient medication administration by ICN bridge routine
"RTN","SYNDHP73",187,0)
 ;  -------------------------------------------------------
"RTN","SYNDHP73",188,0)
 ;
"RTN","SYNDHP73",189,0)
PATMEDA ; get patient medication administration for one patient by ICN
"RTN","SYNDHP73",190,0)
 ;
"RTN","SYNDHP73",191,0)
 ;   DHPPATMEDAICN
"RTN","SYNDHP73",192,0)
 ;
"RTN","SYNDHP73",193,0)
 D PARSEICN
"RTN","SYNDHP73",194,0)
 F I="FRDAT","TODAT" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",195,0)
 D PATMEDA^SYNDHP48(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
"RTN","SYNDHP73",196,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",197,0)
 Q
"RTN","SYNDHP73",198,0)
 ;
"RTN","SYNDHP73",199,0)
 ;  -------------------------------------------------
"RTN","SYNDHP73",200,0)
 ;  Patient medication dispense by ICN bridge routine
"RTN","SYNDHP73",201,0)
 ;  -------------------------------------------------
"RTN","SYNDHP73",202,0)
 ;
"RTN","SYNDHP73",203,0)
PATMEDD ; get patient medication dispense for one patient by ICN
"RTN","SYNDHP73",204,0)
 ;
"RTN","SYNDHP73",205,0)
 ;   DHPPATMEDDICN
"RTN","SYNDHP73",206,0)
 ;
"RTN","SYNDHP73",207,0)
 D PARSEICN
"RTN","SYNDHP73",208,0)
 F I="FRDAT","TODAT" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",209,0)
 D PATMEDD^SYNDHP48(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
"RTN","SYNDHP73",210,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",211,0)
 Q
"RTN","SYNDHP73",212,0)
 ;
"RTN","SYNDHP73",213,0)
 ;  ---------------------------------------
"RTN","SYNDHP73",214,0)
 ;  Patient vitals by traits bridge routine
"RTN","SYNDHP73",215,0)
 ;  ---------------------------------------
"RTN","SYNDHP73",216,0)
 ;
"RTN","SYNDHP73",217,0)
PATVIT ; get patient vitals for one patient by traits
"RTN","SYNDHP73",218,0)
 ;
"RTN","SYNDHP73",219,0)
 ;   DHPPATVIT
"RTN","SYNDHP73",220,0)
 ;
"RTN","SYNDHP73",221,0)
 D PARSEVIT
"RTN","SYNDHP73",222,0)
 D PATVIT^SYNDHP01(.RETSTA,DHPNAME,DHPSSN,DHPDOB,DHPGENDER,DHPFRDAT,DHPTODAT,DHPJSON)
"RTN","SYNDHP73",223,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",224,0)
 Q
"RTN","SYNDHP73",225,0)
 ;
"RTN","SYNDHP73",226,0)
 ;
"RTN","SYNDHP73",227,0)
PARSEVIT ;
"RTN","SYNDHP73",228,0)
 ;
"RTN","SYNDHP73",229,0)
 F I="SSN","DOB","GENDER","FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",230,0)
 S DHPNAME=$$GETPARAM^RGNETWWW("NAME",1,1)
"RTN","SYNDHP73",231,0)
 S DHPNAME=DHPNAME_","_$$GETPARAM^RGNETWWW("NAME",1,2)_" "
"RTN","SYNDHP73",232,0)
 Q
"RTN","SYNDHP73",233,0)
 ;
"RTN","SYNDHP73",234,0)
 ;  ------------------------------------
"RTN","SYNDHP73",235,0)
 ;  Patient vitals by ICN bridge routine
"RTN","SYNDHP73",236,0)
 ;  ------------------------------------
"RTN","SYNDHP73",237,0)
 ;
"RTN","SYNDHP73",238,0)
PATVITI ; get patient vitals for one patient by ICN
"RTN","SYNDHP73",239,0)
 ;
"RTN","SYNDHP73",240,0)
 ;   DHPPATVITICN
"RTN","SYNDHP73",241,0)
 ;
"RTN","SYNDHP73",242,0)
 D PARSEICN
"RTN","SYNDHP73",243,0)
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",244,0)
 D PATVITI^SYNDHP01(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
"RTN","SYNDHP73",245,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",246,0)
 Q
"RTN","SYNDHP73",247,0)
 ;
"RTN","SYNDHP73",248,0)
 ;  -----------------------------------------------
"RTN","SYNDHP73",249,0)
 ;  Patient health factors by traits bridge routine
"RTN","SYNDHP73",250,0)
 ;  -----------------------------------------------
"RTN","SYNDHP73",251,0)
 ;
"RTN","SYNDHP73",252,0)
PATHLF ; get patient health factors for one patient
"RTN","SYNDHP73",253,0)
 ;
"RTN","SYNDHP73",254,0)
 ;   DHPPATHLF
"RTN","SYNDHP73",255,0)
 ;
"RTN","SYNDHP73",256,0)
 D PARSETRAITS
"RTN","SYNDHP73",257,0)
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",258,0)
 D PATHLF^SYNDHP09(.RETSTA,DHPNAME,DHPSSN,DHPDOB,DHPGENDER,DHPFRDAT,DHPTODAT,DHPJSON)
"RTN","SYNDHP73",259,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",260,0)
 Q
"RTN","SYNDHP73",261,0)
 ;
"RTN","SYNDHP73",262,0)
 ;  --------------------------------------------
"RTN","SYNDHP73",263,0)
 ;  Patient health factors by ICN bridge routine
"RTN","SYNDHP73",264,0)
 ;  --------------------------------------------
"RTN","SYNDHP73",265,0)
 ;
"RTN","SYNDHP73",266,0)
PATHLFI ; get patient health factors for one patient
"RTN","SYNDHP73",267,0)
 ;
"RTN","SYNDHP73",268,0)
 ;   DHPPATHLFICN
"RTN","SYNDHP73",269,0)
 ;
"RTN","SYNDHP73",270,0)
 D PARSEICN
"RTN","SYNDHP73",271,0)
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",272,0)
 D PATHLFI^SYNDHP09(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
"RTN","SYNDHP73",273,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",274,0)
 Q
"RTN","SYNDHP73",275,0)
 ;
"RTN","SYNDHP73",276,0)
 ;  -------------------------------------------
"RTN","SYNDHP73",277,0)
 ;  Patient procedures by traits bridge routine
"RTN","SYNDHP73",278,0)
 ;  -------------------------------------------
"RTN","SYNDHP73",279,0)
 ;
"RTN","SYNDHP73",280,0)
PATPRC ; get patient procedures for one patient
"RTN","SYNDHP73",281,0)
 ;
"RTN","SYNDHP73",282,0)
 ;   DHPPATPRC
"RTN","SYNDHP73",283,0)
 ;
"RTN","SYNDHP73",284,0)
 D PARSETRAITS
"RTN","SYNDHP73",285,0)
 F I="FRDAT","TODAT" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",286,0)
 D PATPRC^SYNDHP04(.RETSTA,DHPNAME,DHPSSN,DHPDOB,DHPGENDER,DHPFRDAT,DHPTODAT)
"RTN","SYNDHP73",287,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",288,0)
 Q
"RTN","SYNDHP73",289,0)
 ;
"RTN","SYNDHP73",290,0)
 ;  ----------------------------------------
"RTN","SYNDHP73",291,0)
 ;  Patient procedures by ICN bridge routine
"RTN","SYNDHP73",292,0)
 ;  ----------------------------------------
"RTN","SYNDHP73",293,0)
 ;
"RTN","SYNDHP73",294,0)
PATPRCI ; get patient procedures for one patient
"RTN","SYNDHP73",295,0)
 ;
"RTN","SYNDHP73",296,0)
 ;   DHPPATPRCICN
"RTN","SYNDHP73",297,0)
 ;
"RTN","SYNDHP73",298,0)
 D PARSEICN
"RTN","SYNDHP73",299,0)
 F I="FRDAT","TODAT" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",300,0)
 D PATPRCI^SYNDHP04(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
"RTN","SYNDHP73",301,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",302,0)
 Q
"RTN","SYNDHP73",303,0)
 ;
"RTN","SYNDHP73",304,0)
 ;  ---------------------------------------
"RTN","SYNDHP73",305,0)
 ;  Patient allergies by ICN bridge routine
"RTN","SYNDHP73",306,0)
 ;  ---------------------------------------
"RTN","SYNDHP73",307,0)
 ;
"RTN","SYNDHP73",308,0)
PATALLI ; get patient allergies for one patient by ICN
"RTN","SYNDHP73",309,0)
 ;
"RTN","SYNDHP73",310,0)
 ;   DHPPATALLICN
"RTN","SYNDHP73",311,0)
 ;
"RTN","SYNDHP73",312,0)
 D PARSEICN
"RTN","SYNDHP73",313,0)
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",314,0)
 D PATALLI^SYNDHP57(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
"RTN","SYNDHP73",315,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",316,0)
 Q
"RTN","SYNDHP73",317,0)
 ;
"RTN","SYNDHP73",318,0)
 ;  -----------------------------------------------
"RTN","SYNDHP73",319,0)
 ;  Patient diagnostic report by ICN bridge routine
"RTN","SYNDHP73",320,0)
 ;  -----------------------------------------------
"RTN","SYNDHP73",321,0)
 ;
"RTN","SYNDHP73",322,0)
PATDXREP ; get patient diagnostic report for one patient by ICN
"RTN","SYNDHP73",323,0)
 ;
"RTN","SYNDHP73",324,0)
 ;   DHPPATDXRICN
"RTN","SYNDHP73",325,0)
 ;
"RTN","SYNDHP73",326,0)
 D PARSEICN
"RTN","SYNDHP73",327,0)
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",328,0)
 D PATDXRI^SYNDHP05(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
"RTN","SYNDHP73",329,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",330,0)
 Q
"RTN","SYNDHP73",331,0)
 ;
"RTN","SYNDHP73",332,0)
 ;  -------------------------------------
"RTN","SYNDHP73",333,0)
 ;  Patient labs by traits bridge routine
"RTN","SYNDHP73",334,0)
 ;  -------------------------------------
"RTN","SYNDHP73",335,0)
 ;
"RTN","SYNDHP73",336,0)
PATLAB ; get patient labs for one patient
"RTN","SYNDHP73",337,0)
 ;
"RTN","SYNDHP73",338,0)
 ;   DHPPATLAB
"RTN","SYNDHP73",339,0)
 ;
"RTN","SYNDHP73",340,0)
 D PARSETRAITS
"RTN","SYNDHP73",341,0)
 F I="FRDAT","TODAT" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",342,0)
 D PATLAB^SYNDHP53(.RETSTA,DHPNAME,DHPSSN,DHPDOB,DHPGENDER,DHPFRDAT,DHPTODAT)
"RTN","SYNDHP73",343,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",344,0)
 Q
"RTN","SYNDHP73",345,0)
 ;
"RTN","SYNDHP73",346,0)
 ;  ----------------------------------
"RTN","SYNDHP73",347,0)
 ;  Patient labs by ICN bridge routine
"RTN","SYNDHP73",348,0)
 ;  ----------------------------------
"RTN","SYNDHP73",349,0)
 ;
"RTN","SYNDHP73",350,0)
PATLABI ; get patient labs for one patient
"RTN","SYNDHP73",351,0)
 ;
"RTN","SYNDHP73",352,0)
 ;   DHPPATLABICN
"RTN","SYNDHP73",353,0)
 ;
"RTN","SYNDHP73",354,0)
 D PARSEICN
"RTN","SYNDHP73",355,0)
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",356,0)
 D PATLABI^SYNDHP53(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
"RTN","SYNDHP73",357,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",358,0)
 Q
"RTN","SYNDHP73",359,0)
 ;
"RTN","SYNDHP73",360,0)
 ;  -------------------------------------------
"RTN","SYNDHP73",361,0)
 ;  Patient Enc Providers by ICN bridge routine
"RTN","SYNDHP73",362,0)
 ;  -------------------------------------------
"RTN","SYNDHP73",363,0)
 ;
"RTN","SYNDHP73",364,0)
PATPRVI ; get patient encounter providers for one patient
"RTN","SYNDHP73",365,0)
 ;
"RTN","SYNDHP73",366,0)
 ;   DHPPATPRVICN
"RTN","SYNDHP73",367,0)
 ;
"RTN","SYNDHP73",368,0)
 D PARSEICN
"RTN","SYNDHP73",369,0)
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",370,0)
 D PATPRVI^SYNDHP54(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
"RTN","SYNDHP73",371,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",372,0)
 Q
"RTN","SYNDHP73",373,0)
 ;  ------------------------------------------
"RTN","SYNDHP73",374,0)
 ;  Patient Appointments by ICN bridge routine
"RTN","SYNDHP73",375,0)
 ;  ------------------------------------------
"RTN","SYNDHP73",376,0)
 ;
"RTN","SYNDHP73",377,0)
PATAPTI ; get patient appointments for one patient
"RTN","SYNDHP73",378,0)
 ;
"RTN","SYNDHP73",379,0)
 ;   DHPPATAPTICN
"RTN","SYNDHP73",380,0)
 ;
"RTN","SYNDHP73",381,0)
 D PARSEICN
"RTN","SYNDHP73",382,0)
 F I="FRDAT","TODAT" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",383,0)
 D PATAPTI^SYNDHP41(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
"RTN","SYNDHP73",384,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",385,0)
 Q
"RTN","SYNDHP73",386,0)
 ;
"RTN","SYNDHP73",387,0)
 ;  -----------------------------------
"RTN","SYNDHP73",388,0)
 ;  Patient Flags by ICN bridge routine
"RTN","SYNDHP73",389,0)
 ;  -----------------------------------
"RTN","SYNDHP73",390,0)
 ;
"RTN","SYNDHP73",391,0)
PATFLGI ; get patient flags for one patient
"RTN","SYNDHP73",392,0)
 ;
"RTN","SYNDHP73",393,0)
 ;   DHPPATFLGICN
"RTN","SYNDHP73",394,0)
 ;
"RTN","SYNDHP73",395,0)
 D PARSEICN
"RTN","SYNDHP73",396,0)
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",397,0)
 D PATFLGI^SYNDHP08(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
"RTN","SYNDHP73",398,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",399,0)
 Q
"RTN","SYNDHP73",400,0)
 ;
"RTN","SYNDHP73",401,0)
 ;  ---------------------------------------------
"RTN","SYNDHP73",402,0)
 ;  Patient Immunizations by ICN bridge routine
"RTN","SYNDHP73",403,0)
 ;  ---------------------------------------------
"RTN","SYNDHP73",404,0)
 ;
"RTN","SYNDHP73",405,0)
PATIMMI ; get patient immunizations for one patient
"RTN","SYNDHP73",406,0)
 ;
"RTN","SYNDHP73",407,0)
 ;   DHPPATIMMICN
"RTN","SYNDHP73",408,0)
 ;
"RTN","SYNDHP73",409,0)
 D PARSEICN
"RTN","SYNDHP73",410,0)
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",411,0)
 D PATIMMI^SYNDHP02(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
"RTN","SYNDHP73",412,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",413,0)
 Q
"RTN","SYNDHP73",414,0)
 ;
"RTN","SYNDHP73",415,0)
 ;  ---------------------------------------------
"RTN","SYNDHP73",416,0)
 ;  Patient Goals by ICN bridge routine
"RTN","SYNDHP73",417,0)
 ;  ---------------------------------------------
"RTN","SYNDHP73",418,0)
 ;
"RTN","SYNDHP73",419,0)
PATGOLI ; get patient goals for one patient
"RTN","SYNDHP73",420,0)
 ;
"RTN","SYNDHP73",421,0)
 ;   DHPPATGOLICN
"RTN","SYNDHP73",422,0)
 ;
"RTN","SYNDHP73",423,0)
 D PARSEICN
"RTN","SYNDHP73",424,0)
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",425,0)
 D PATGOLI^SYNDHP07(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
"RTN","SYNDHP73",426,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",427,0)
 Q
"RTN","SYNDHP73",428,0)
 ;
"RTN","SYNDHP73",429,0)
 ;
"RTN","SYNDHP73",430,0)
 ;  -----------------------------------------------
"RTN","SYNDHP73",431,0)
 ;  Patient observations by traits bridge routine
"RTN","SYNDHP73",432,0)
 ;  -----------------------------------------------
"RTN","SYNDHP73",433,0)
 ;
"RTN","SYNDHP73",434,0)
PATOBS ; get patient observations for one patient
"RTN","SYNDHP73",435,0)
 ;
"RTN","SYNDHP73",436,0)
 ;   DHPPATOBS
"RTN","SYNDHP73",437,0)
 ;
"RTN","SYNDHP73",438,0)
 D PARSETRAITS
"RTN","SYNDHP73",439,0)
 F I="FRDAT","TODAT" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",440,0)
 D PATOBS^SYNDHP56(.RETSTA,DHPNAME,DHPSSN,DHPDOB,DHPGENDER,DHPFRDAT,DHPTODAT)
"RTN","SYNDHP73",441,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",442,0)
 Q
"RTN","SYNDHP73",443,0)
 ;
"RTN","SYNDHP73",444,0)
 ;  ---------------------------------------------
"RTN","SYNDHP73",445,0)
 ;  Patient observations by ICN bridge routine
"RTN","SYNDHP73",446,0)
 ;  ---------------------------------------------
"RTN","SYNDHP73",447,0)
 ;
"RTN","SYNDHP73",448,0)
PATOBSI ; get patient observations for one patient
"RTN","SYNDHP73",449,0)
 ;
"RTN","SYNDHP73",450,0)
 ;   DHPPATOBSICN
"RTN","SYNDHP73",451,0)
 ;
"RTN","SYNDHP73",452,0)
 D PARSEICN
"RTN","SYNDHP73",453,0)
 F I="FRDAT","TODAT" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",454,0)
 D PATOBSI^SYNDHP56(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
"RTN","SYNDHP73",455,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",456,0)
 Q
"RTN","SYNDHP73",457,0)
 ;
"RTN","SYNDHP73",458,0)
 ;  ---------------------------------------------
"RTN","SYNDHP73",459,0)
 ;  Get one care team bridge routine
"RTN","SYNDHP73",460,0)
 ;  ---------------------------------------------
"RTN","SYNDHP73",461,0)
 ;
"RTN","SYNDHP73",462,0)
CARETEAM ; get one care team
"RTN","SYNDHP73",463,0)
 ;
"RTN","SYNDHP73",464,0)
 ;   DHPCARETEAM
"RTN","SYNDHP73",465,0)
 ;
"RTN","SYNDHP73",466,0)
 F I="TEAM","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",467,0)
 D GETTEAM^SYNDHP58(.RETSTA,DHPTEAM,DHPJSON)
"RTN","SYNDHP73",468,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",469,0)
 Q
"RTN","SYNDHP73",470,0)
 ;
"RTN","SYNDHP73",471,0)
 ;  ---------------------------------------------
"RTN","SYNDHP73",472,0)
 ;  Get all care teams bridge routine
"RTN","SYNDHP73",473,0)
 ;  ---------------------------------------------
"RTN","SYNDHP73",474,0)
 ;
"RTN","SYNDHP73",475,0)
CARETEAMS ; get all care teams
"RTN","SYNDHP73",476,0)
 ;
"RTN","SYNDHP73",477,0)
 ;   DHPCARETEAMS
"RTN","SYNDHP73",478,0)
 ;
"RTN","SYNDHP73",479,0)
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",480,0)
 D GETTEAMS^SYNDHP58(.RETSTA,DHPFRDAT,DHPTODAT,DHPJSON)
"RTN","SYNDHP73",481,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",482,0)
 Q
"RTN","SYNDHP73",483,0)
 ;
"RTN","SYNDHP73",484,0)
 ;  ---------------------------------------------
"RTN","SYNDHP73",485,0)
 ;  get Care Plans for a patient by traits bridge routine
"RTN","SYNDHP73",486,0)
 ;  ---------------------------------------------
"RTN","SYNDHP73",487,0)
 ;
"RTN","SYNDHP73",488,0)
PATCPALL ; get all care plans
"RTN","SYNDHP73",489,0)
 ;
"RTN","SYNDHP73",490,0)
 ;   DHPPATCPALL
"RTN","SYNDHP73",491,0)
 ;
"RTN","SYNDHP73",492,0)
 D PARSETRAITS
"RTN","SYNDHP73",493,0)
 F I="FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",494,0)
 D PATCPALL^SYNDHP59(.RETSTA,DHPNAME,DHPSSN,DHPDOB,DHPGENDER,DHPFRDAT,DHPTODAT,DHPJSON)
"RTN","SYNDHP73",495,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",496,0)
 Q
"RTN","SYNDHP73",497,0)
 ;
"RTN","SYNDHP73",498,0)
 ;  ---------------------------------------------
"RTN","SYNDHP73",499,0)
 ;  get Care Plans for a patient by ICN bridge routine
"RTN","SYNDHP73",500,0)
 ;  ---------------------------------------------
"RTN","SYNDHP73",501,0)
 ;
"RTN","SYNDHP73",502,0)
PATCPALLI ; get all care plans for a patient
"RTN","SYNDHP73",503,0)
 ;
"RTN","SYNDHP73",504,0)
 ;   DHPPATCPALLI
"RTN","SYNDHP73",505,0)
 ;
"RTN","SYNDHP73",506,0)
 F I="ICN","FRDAT","TODAT","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",507,0)
 D PATCPALLI^SYNDHP59(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
"RTN","SYNDHP73",508,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",509,0)
 Q
"RTN","SYNDHP73",510,0)
 ;
"RTN","SYNDHP73",511,0)
 ;  --------------------------------------------------------
"RTN","SYNDHP73",512,0)
 ;  get one Care Plan for a patient by traits bridge routine
"RTN","SYNDHP73",513,0)
 ;  --------------------------------------------------------
"RTN","SYNDHP73",514,0)
 ;
"RTN","SYNDHP73",515,0)
PATCP ; get one care plan for a patient
"RTN","SYNDHP73",516,0)
 ;
"RTN","SYNDHP73",517,0)
 ;   DHPPATCP
"RTN","SYNDHP73",518,0)
 ;
"RTN","SYNDHP73",519,0)
 D PARSETRAITS
"RTN","SYNDHP73",520,0)
 F I="VRESID","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",521,0)
 D PATCP^SYNDHP59(.RETSTA,DHPNAME,DHPSSN,DHPDOB,DHPGENDER,DHPVRESID,DHPJSON)
"RTN","SYNDHP73",522,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",523,0)
 Q
"RTN","SYNDHP73",524,0)
 ;
"RTN","SYNDHP73",525,0)
 ;  --------------------------------------------------------
"RTN","SYNDHP73",526,0)
 ;  get one Care Plan for a patient by ICN bridge routine
"RTN","SYNDHP73",527,0)
 ;  --------------------------------------------------------
"RTN","SYNDHP73",528,0)
 ;
"RTN","SYNDHP73",529,0)
PATCPI ; get one care plan for a patient
"RTN","SYNDHP73",530,0)
 ;
"RTN","SYNDHP73",531,0)
 ;   DHPPATCPI
"RTN","SYNDHP73",532,0)
 ;
"RTN","SYNDHP73",533,0)
 F I="ICN","VRESID","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",534,0)
 D PATCPI^SYNDHP59(.RETSTA,DHPICN,DHPVRESID,DHPJSON)
"RTN","SYNDHP73",535,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",536,0)
 Q
"RTN","SYNDHP73",537,0)
 ;
"RTN","SYNDHP73",538,0)
 ;  ----------------------------------------------
"RTN","SYNDHP73",539,0)
 ;  Institution Information by HLOC bridge routine
"RTN","SYNDHP73",540,0)
 ;  ----------------------------------------------
"RTN","SYNDHP73",541,0)
 ; 
"RTN","SYNDHP73",542,0)
HLOCINST ; get institution information for hospital location name
"RTN","SYNDHP73",543,0)
 ;
"RTN","SYNDHP73",544,0)
 ;    DHPHLOCINSTHLOCNAM
"RTN","SYNDHP73",545,0)
 ;
"RTN","SYNDHP73",546,0)
 D PARSEHLC
"RTN","SYNDHP73",547,0)
 D HOSINSTI^SYNDHP06(.RETSTA,DHPHLOC,DHPJSON)
"RTN","SYNDHP73",548,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",549,0)
 Q
"RTN","SYNDHP73",550,0)
 ;
"RTN","SYNDHP73",551,0)
PARSEHLC ; Hospital Location Name PARSER
"RTN","SYNDHP73",552,0)
 ;
"RTN","SYNDHP73",553,0)
 F I="HLOC","JSON" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",554,0)
 Q
"RTN","SYNDHP73",555,0)
 ;
"RTN","SYNDHP73",556,0)
 ;  ---------------------------------------------
"RTN","SYNDHP73",557,0)
 ;  Text Integration Utility (TIU) bridge routine
"RTN","SYNDHP73",558,0)
 ;  ---------------------------------------------
"RTN","SYNDHP73",559,0)
 ;
"RTN","SYNDHP73",560,0)
PATTIUI ; get patient notes for one patient by ICN
"RTN","SYNDHP73",561,0)
 ;
"RTN","SYNDHP73",562,0)
 ;   DHPPATTIUICN
"RTN","SYNDHP73",563,0)
 ;
"RTN","SYNDHP73",564,0)
 D PARSEICN
"RTN","SYNDHP73",565,0)
 F I="FRDAT","TODAT" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",566,0)
 D PATTIUI^SYNDHP67(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
"RTN","SYNDHP73",567,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",568,0)
 Q
"RTN","SYNDHP73",569,0)
 ;
"RTN","SYNDHP73",570,0)
 ;  --------------------------------------------------
"RTN","SYNDHP73",571,0)
 ;  get record specified by resource ID bridge routine
"RTN","SYNDHP73",572,0)
 ;  --------------------------------------------------
"RTN","SYNDHP73",573,0)
 ;
"RTN","SYNDHP73",574,0)
GETRESID ; get record specified by resource ID
"RTN","SYNDHP73",575,0)
 ;
"RTN","SYNDHP73",576,0)
 ;   DHPGETRESID
"RTN","SYNDHP73",577,0)
 ;
"RTN","SYNDHP73",578,0)
 F I="RESID" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",579,0)
 D GETREC^SYNDHP99(.RETSTA,DHPRESID)
"RTN","SYNDHP73",580,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",581,0)
 Q
"RTN","SYNDHP73",582,0)
 ;
"RTN","SYNDHP73",583,0)
 ;  ---------------------------------------------
"RTN","SYNDHP73",584,0)
 ;  Mappings bridge routine
"RTN","SYNDHP73",585,0)
 ;  ---------------------------------------------
"RTN","SYNDHP73",586,0)
 ;
"RTN","SYNDHP73",587,0)
MAPSVC ; get mapped code for a given source and code
"RTN","SYNDHP73",588,0)
 ;
"RTN","SYNDHP73",589,0)
 ;   DHPMAPSVC
"RTN","SYNDHP73",590,0)
 ;
"RTN","SYNDHP73",591,0)
 D PARSEMAP
"RTN","SYNDHP73",592,0)
 D MAPSVC^SYNDHP83(.RETSTA,DHPMAP,DHPCODE,DHPDIR,DHPIOE)
"RTN","SYNDHP73",593,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",594,0)
 Q
"RTN","SYNDHP73",595,0)
 ;
"RTN","SYNDHP73",596,0)
 ;  ---------------------------------------------
"RTN","SYNDHP73",597,0)
 ;  Facility Suffix Parameter bridge routine
"RTN","SYNDHP73",598,0)
 ;  ---------------------------------------------
"RTN","SYNDHP73",599,0)
 ;
"RTN","SYNDHP73",600,0)
SYSFAC ; get system facility  suffix parameter
"RTN","SYNDHP73",601,0)
 ;
"RTN","SYNDHP73",602,0)
 ;   DHPSYSFACUPD
"RTN","SYNDHP73",603,0)
 ;
"RTN","SYNDHP73",604,0)
 S DHPFAC="DHP"_$$GETPARAM^RGNETWWW(1)
"RTN","SYNDHP73",605,0)
 D GETFACID^SYNDHP69(.RETSTA,DHPFAC)
"RTN","SYNDHP73",606,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",607,0)
 Q 
"RTN","SYNDHP73",608,0)
 ;
"RTN","SYNDHP73",609,0)
LOGRST ; expunge VPRHTTP("log"
"RTN","SYNDHP73",610,0)
 ;
"RTN","SYNDHP73",611,0)
 ;   DHPVPRLOGRST
"RTN","SYNDHP73",612,0)
 ;
"RTN","SYNDHP73",613,0)
 D LOGRST^SYNDHP69(.RETSTA)
"RTN","SYNDHP73",614,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP73",615,0)
 Q 
"RTN","SYNDHP73",616,0)
 ;
"RTN","SYNDHP73",617,0)
 ;  -------------------------------------
"RTN","SYNDHP73",618,0)
 ;
"RTN","SYNDHP73",619,0)
PARSEICN ; ICN PARSER
"RTN","SYNDHP73",620,0)
 ; 
"RTN","SYNDHP73",621,0)
 F I="ICN" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",622,0)
 Q
"RTN","SYNDHP73",623,0)
 ;
"RTN","SYNDHP73",624,0)
PARSETRAITS ; Traits parser
"RTN","SYNDHP73",625,0)
 ;
"RTN","SYNDHP73",626,0)
 F I="SSN","DOB","GENDER" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",627,0)
 S DHPNAME=$$GETPARAM^RGNETWWW("NAME",1,1)
"RTN","SYNDHP73",628,0)
 S DHPNAME=DHPNAME_","_$$GETPARAM^RGNETWWW("NAME",1,2)_" "
"RTN","SYNDHP73",629,0)
 Q
"RTN","SYNDHP73",630,0)
 ;
"RTN","SYNDHP73",631,0)
PARSEMAP ; Map parser
"RTN","SYNDHP73",632,0)
 ;
"RTN","SYNDHP73",633,0)
 F I="MAP","CODE","DIR","IOE" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP73",634,0)
 Q
"RTN","SYNDHP79")
0^15^B29692023
"RTN","SYNDHP79",1,0)
SYNDHP79 ; HC/fjf/art - HealthConcourse - DHP REST handlers ;03/27/2019
"RTN","SYNDHP79",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP79",3,0)
 ;;
"RTN","SYNDHP79",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP79",5,0)
 ; 
"RTN","SYNDHP79",6,0)
 ;  -------------------------------------------
"RTN","SYNDHP79",7,0)
 ;  Save patient vitals to VistA bridge routine
"RTN","SYNDHP79",8,0)
 ;  -------------------------------------------
"RTN","SYNDHP79",9,0)
 ;
"RTN","SYNDHP79",10,0)
PATVITSV ; save patient vitals for one patient to VistA
"RTN","SYNDHP79",11,0)
 ;
"RTN","SYNDHP79",12,0)
 ;   DHPPATVITPST
"RTN","SYNDHP79",13,0)
 ;
"RTN","SYNDHP79",14,0)
 ;CRASH
"RTN","SYNDHP79",15,0)
 D PARSEVITU
"RTN","SYNDHP79",16,0)
 D VITUPD^SYNDHP61(.RETSTA,DHPICN,DHPSCT,DHPOBS,DHPUNT,DHPDTM)
"RTN","SYNDHP79",17,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP79",18,0)
 Q
"RTN","SYNDHP79",19,0)
 ;
"RTN","SYNDHP79",20,0)
 ;
"RTN","SYNDHP79",21,0)
PARSEVITU ;
"RTN","SYNDHP79",22,0)
 ;
"RTN","SYNDHP79",23,0)
 S C=",",L=":"
"RTN","SYNDHP79",24,0)
 S PARAMS=RGNETREQ("BODY",1)
"RTN","SYNDHP79",25,0)
 ;CRASH
"RTN","SYNDHP79",26,0)
 F I=1:1:$L(PARAMS,C) D
"RTN","SYNDHP79",27,0)
 .S PARAMS($P($P(PARAMS,C,I),L))=$P($P(PARAMS,C,I),L,2)
"RTN","SYNDHP79",28,0)
 F I="ICN","SCT","OBS","UNT","DTM" S @("DHP"_I)=PARAMS(I)
"RTN","SYNDHP79",29,0)
 ;S ^ZZFJF(99)=DHPICN_"^"_DHPSCT_"^"_DHPOBS_"^"_DHPUNT_"^"_DHPDTM
"RTN","SYNDHP79",30,0)
 Q
"RTN","SYNDHP79",31,0)
 ;
"RTN","SYNDHP79",32,0)
 ;  ---------------------------------------------
"RTN","SYNDHP79",33,0)
 ;
"RTN","SYNDHP79",34,0)
PATPRBSVX ; - old save patient problems for one patient to VistA
"RTN","SYNDHP79",35,0)
 ; >>>>>> THIS IS OLD CODE <<<<<<<
"RTN","SYNDHP79",36,0)
 ; >>>>>> SEE PATPRBSV BELOW <<<<<<<
"RTN","SYNDHP79",37,0)
 ;
"RTN","SYNDHP79",38,0)
 ;   DHPPATPRBUPD
"RTN","SYNDHP79",39,0)
 ;
"RTN","SYNDHP79",40,0)
 ;CRASH
"RTN","SYNDHP79",41,0)
 D PARSEPUPD
"RTN","SYNDHP79",42,0)
 D PROBUPD^SYNDHP61(.RETSTA,DHPICN,DHPSCT,DHPDES,DHPROV,DHPDTM,DHPRID)
"RTN","SYNDHP79",43,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP79",44,0)
 Q
"RTN","SYNDHP79",45,0)
 ;
"RTN","SYNDHP79",46,0)
 ;
"RTN","SYNDHP79",47,0)
PARSEPUPDX ;
"RTN","SYNDHP79",48,0)
 ;
"RTN","SYNDHP79",49,0)
 S C=",",L=":"
"RTN","SYNDHP79",50,0)
 D SYNDHPLOG($H)
"RTN","SYNDHP79",51,0)
 S PARAMS=RGNETREQ("BODY",1)
"RTN","SYNDHP79",52,0)
 I $L(PARAMS,L)=1 S C="&",L="="
"RTN","SYNDHP79",53,0)
 F I=1:1:$L(PARAMS,C) D
"RTN","SYNDHP79",54,0)
 .S PARAMS($P($P(PARAMS,C,I),L))=$P($P(PARAMS,C,I),L,2)
"RTN","SYNDHP79",55,0)
 F I="ICN","SCT","DES","ROV","DTM","RID" S @("DHP"_I)=PARAMS(I)
"RTN","SYNDHP79",56,0)
 ;S ^ZZFJF(99)=DHPICN_"^"_DHPSCT_"^"_DHPOBS_"^"_DHPUNT_"^"_DHPDTM
"RTN","SYNDHP79",57,0)
 Q
"RTN","SYNDHP79",58,0)
 ;
"RTN","SYNDHP79",59,0)
 ;  ---------------------------------------------
"RTN","SYNDHP79",60,0)
 ;
"RTN","SYNDHP79",61,0)
 ;
"RTN","SYNDHP79",62,0)
PATPRBSV ; save patient problems for one patient to VistA
"RTN","SYNDHP79",63,0)
 ;
"RTN","SYNDHP79",64,0)
 ;   DHPPATPRBUPD
"RTN","SYNDHP79",65,0)
 ;
"RTN","SYNDHP79",66,0)
 ;CRASH
"RTN","SYNDHP79",67,0)
 D PARSEPUPD
"RTN","SYNDHP79",68,0)
 D PRBUPDT^SYNDHP62(.RETSTA,DHPPAT,DHPVST,DHPROV,DHPONS,DHPABT,DHPCLNST,DHPSCT)
"RTN","SYNDHP79",69,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP79",70,0)
 Q
"RTN","SYNDHP79",71,0)
 ;
"RTN","SYNDHP79",72,0)
 ;
"RTN","SYNDHP79",73,0)
PARSEPUPD ;
"RTN","SYNDHP79",74,0)
 ;
"RTN","SYNDHP79",75,0)
 S C=",",L=":"
"RTN","SYNDHP79",76,0)
 D SYNDHPLOG($H)
"RTN","SYNDHP79",77,0)
 S PARAMS=RGNETREQ("BODY",1)
"RTN","SYNDHP79",78,0)
 I $L(PARAMS,L)=1 S C="&",L="="
"RTN","SYNDHP79",79,0)
 F I=1:1:$L(PARAMS,C) D
"RTN","SYNDHP79",80,0)
 .S PARAMS($P($P(PARAMS,C,I),L))=$P($P(PARAMS,C,I),L,2)
"RTN","SYNDHP79",81,0)
 F I="PAT","VST","ROV","ONS","ABT","CLNST","SCT" S @("DHP"_I)=PARAMS(I)
"RTN","SYNDHP79",82,0)
 Q
"RTN","SYNDHP79",83,0)
 ;
"RTN","SYNDHP79",84,0)
 ;
"RTN","SYNDHP79",85,0)
PATDEMSV ; save demographics for one patient
"RTN","SYNDHP79",86,0)
 ;
"RTN","SYNDHP79",87,0)
 ; *** may have been overtaken by events
"RTN","SYNDHP79",88,0)
 ; *** may be removed at some suitable juncture or use ISI?
"RTN","SYNDHP79",89,0)
 ;
"RTN","SYNDHP79",90,0)
 ;   DHPPATDEMUPD
"RTN","SYNDHP79",91,0)
 ;
"RTN","SYNDHP79",92,0)
 ;D PARSEDEM
"RTN","SYNDHP79",93,0)
 ;D DEMUPD^SYNDHP61(.RETSTA,DHPICN,DHPSCT,DHPDES,DHPICD,DHPROV,DHPDTM,DHPRID)
"RTN","SYNDHP79",94,0)
 ;D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP79",95,0)
 Q
"RTN","SYNDHP79",96,0)
PARSEDEM ;
"RTN","SYNDHP79",97,0)
 ;
"RTN","SYNDHP79",98,0)
 S C=",",L=":"
"RTN","SYNDHP79",99,0)
 S PARAMS=RGNETREQ("BODY",1)
"RTN","SYNDHP79",100,0)
 F I=1:1:$L(PARAMS,C) D
"RTN","SYNDHP79",101,0)
 .S PARAMS($P($P(PARAMS,C,I),L))=$P($P(PARAMS,C,I),L,2)
"RTN","SYNDHP79",102,0)
 ;CRASH
"RTN","SYNDHP79",103,0)
 F I="ICN","SCT","DES","ICD","ROV","DTM","RID" S @("DHP"_I)=PARAMS(I)
"RTN","SYNDHP79",104,0)
 ;S ^ZZFJF(99)=DHPICN_"^"_DHPSCT_"^"_DHPOBS_"^"_DHPUNT_"^"_DHPDTM
"RTN","SYNDHP79",105,0)
 Q
"RTN","SYNDHP79",106,0)
 ;
"RTN","SYNDHP79",107,0)
 ;  ---------------------------------------------
"RTN","SYNDHP79",108,0)
 ;
"RTN","SYNDHP79",109,0)
PATIMUSV ; save Immunizations for one patient
"RTN","SYNDHP79",110,0)
 ;
"RTN","SYNDHP79",111,0)
 ;   DHPPATIMMUPD
"RTN","SYNDHP79",112,0)
 ;
"RTN","SYNDHP79",113,0)
 D PARSEIMU
"RTN","SYNDHP79",114,0)
 ; Immunizations update
"RTN","SYNDHP79",115,0)
 D IMMUNUPD^SYNDHP61(.RETSTA,DHPICN,DHPVIS,DHPCVX,DHPLOC,DHPROU,DHPDOS,DHPDTM,DHPPROV)
"RTN","SYNDHP79",116,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP79",117,0)
 Q
"RTN","SYNDHP79",118,0)
PARSEIMU ;
"RTN","SYNDHP79",119,0)
 ;
"RTN","SYNDHP79",120,0)
 N C,I,L,PARAMS
"RTN","SYNDHP79",121,0)
 ;
"RTN","SYNDHP79",122,0)
 S C=",",L=":"
"RTN","SYNDHP79",123,0)
 S PARAMS=RGNETREQ("BODY",1)
"RTN","SYNDHP79",124,0)
 F I=1:1:$L(PARAMS,C) D
"RTN","SYNDHP79",125,0)
 .S PARAMS($P($P(PARAMS,C,I),L))=$P($P(PARAMS,C,I),L,2)
"RTN","SYNDHP79",126,0)
 ;CRASH
"RTN","SYNDHP79",127,0)
 F I="ICN","VIS","CVX","LOC","ROU","DOS","DTM","PROV" S @("DHP"_I)=PARAMS(I)
"RTN","SYNDHP79",128,0)
 ;S ^ZZART(99)=DHPICN_U_DHPVIS_U_DHPCVX_U_DHPLOC_U_DHPROU_U_DHPDOS_U_DHPDTM_U_DHPPROV
"RTN","SYNDHP79",129,0)
 Q
"RTN","SYNDHP79",130,0)
 ;
"RTN","SYNDHP79",131,0)
 ;  ---------------------------------------------
"RTN","SYNDHP79",132,0)
 ;
"RTN","SYNDHP79",133,0)
PATAPTCR ; create Appointment for one patient
"RTN","SYNDHP79",134,0)
 ;
"RTN","SYNDHP79",135,0)
 ;   DHPPATAPTCRE
"RTN","SYNDHP79",136,0)
 ;
"RTN","SYNDHP79",137,0)
 D PARSEAPT
"RTN","SYNDHP79",138,0)
 ; Appointment create
"RTN","SYNDHP79",139,0)
 D APPTADD^SYNDHP62(.RETSTA,DHPPAT,DHPCLIN,DHPAPTDT,DHPLEN)
"RTN","SYNDHP79",140,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP79",141,0)
 Q
"RTN","SYNDHP79",142,0)
PARSEAPT ;
"RTN","SYNDHP79",143,0)
 ;
"RTN","SYNDHP79",144,0)
 N C,I,L,PARAMS
"RTN","SYNDHP79",145,0)
 ;
"RTN","SYNDHP79",146,0)
 S C=",",L=":"
"RTN","SYNDHP79",147,0)
 S PARAMS=RGNETREQ("BODY",1)
"RTN","SYNDHP79",148,0)
 F I=1:1:$L(PARAMS,C) D
"RTN","SYNDHP79",149,0)
 .S PARAMS($P($P(PARAMS,C,I),L))=$P($P(PARAMS,C,I),L,2)
"RTN","SYNDHP79",150,0)
 ;CRASH
"RTN","SYNDHP79",151,0)
 F I="PAT","CLIN","APTDT","LEN" S @("DHP"_I)=PARAMS(I)
"RTN","SYNDHP79",152,0)
 ;S ^ZZART(99)=DHPPAT_U_DHPCLIN_U_DHPAPTDT_U_DHPLEN
"RTN","SYNDHP79",153,0)
 Q
"RTN","SYNDHP79",154,0)
 ;
"RTN","SYNDHP79",155,0)
 ;  ---------------------------------------------
"RTN","SYNDHP79",156,0)
 ;
"RTN","SYNDHP79",157,0)
PATAPTCI ; check-in one Appointment for one patient
"RTN","SYNDHP79",158,0)
 ;
"RTN","SYNDHP79",159,0)
 ;   DHPPATAPTCI
"RTN","SYNDHP79",160,0)
 ;
"RTN","SYNDHP79",161,0)
 D PARSECI
"RTN","SYNDHP79",162,0)
 ; Appointment create
"RTN","SYNDHP79",163,0)
 D APPTCKIN^SYNDHP62(.RETSTA,DHPPAT,DHPCLIN,DHPAPTDT,DHPCIDT)
"RTN","SYNDHP79",164,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP79",165,0)
 Q
"RTN","SYNDHP79",166,0)
PARSECI ;
"RTN","SYNDHP79",167,0)
 ;
"RTN","SYNDHP79",168,0)
 N C,I,L,PARAMS
"RTN","SYNDHP79",169,0)
 ;
"RTN","SYNDHP79",170,0)
 S C=",",L=":"
"RTN","SYNDHP79",171,0)
 S PARAMS=RGNETREQ("BODY",1)
"RTN","SYNDHP79",172,0)
 F I=1:1:$L(PARAMS,C) D
"RTN","SYNDHP79",173,0)
 .S PARAMS($P($P(PARAMS,C,I),L))=$P($P(PARAMS,C,I),L,2)
"RTN","SYNDHP79",174,0)
 ;CRASH
"RTN","SYNDHP79",175,0)
 F I="PAT","CLIN","APTDT","CIDT" S @("DHP"_I)=PARAMS(I)
"RTN","SYNDHP79",176,0)
 ;S ^ZZART(99)=DHPPAT_U_DHPCLIN_U_DHPAPTDT_U_DHPCIDT
"RTN","SYNDHP79",177,0)
 Q
"RTN","SYNDHP79",178,0)
 ;
"RTN","SYNDHP79",179,0)
 ;
"RTN","SYNDHP79",180,0)
 ;  ---------------------------------------------
"RTN","SYNDHP79",181,0)
 ;
"RTN","SYNDHP79",182,0)
PATLABSV ; create one lab result for one patient
"RTN","SYNDHP79",183,0)
 ;
"RTN","SYNDHP79",184,0)
 ;   DHPPATLABUPD
"RTN","SYNDHP79",185,0)
 ;
"RTN","SYNDHP79",186,0)
 D PARSELAB
"RTN","SYNDHP79",187,0)
 ; Lab Result create
"RTN","SYNDHP79",188,0)
 D LABADD^SYNDHP63(.RETSTA,DHPPAT,DHPLOC,DHPTEST,DHPRSLT,DHPRSDT,DHPLOINC)
"RTN","SYNDHP79",189,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP79",190,0)
 Q
"RTN","SYNDHP79",191,0)
PARSELAB ;
"RTN","SYNDHP79",192,0)
 ;
"RTN","SYNDHP79",193,0)
 N C,I,L,PARAMS
"RTN","SYNDHP79",194,0)
 ;
"RTN","SYNDHP79",195,0)
 S C=",",L=":"
"RTN","SYNDHP79",196,0)
 S PARAMS=RGNETREQ("BODY",1)
"RTN","SYNDHP79",197,0)
 F I=1:1:$L(PARAMS,C) D
"RTN","SYNDHP79",198,0)
 .S PARAMS($P($P(PARAMS,C,I),L))=$P($P(PARAMS,C,I),L,2)
"RTN","SYNDHP79",199,0)
 ;CRASH
"RTN","SYNDHP79",200,0)
 F I="PAT","LOC","TEST","RSLT","RSDT","LOINC" S @("DHP"_I)=PARAMS(I)
"RTN","SYNDHP79",201,0)
 ;S ^ZZART(99)=DHPPAT_U_DHPLOC_U_DHPTEST_U_DHPRSLT_U_DHPRSDT_U_DHPLOINC
"RTN","SYNDHP79",202,0)
 Q
"RTN","SYNDHP79",203,0)
 ;
"RTN","SYNDHP79",204,0)
 ;  ---------------------------------------------
"RTN","SYNDHP79",205,0)
 ;
"RTN","SYNDHP79",206,0)
SYSFAC ; create/delete system facility parameter
"RTN","SYNDHP79",207,0)
 ;
"RTN","SYNDHP79",208,0)
 ;   DHPSYSFACUPD
"RTN","SYNDHP79",209,0)
 ;
"RTN","SYNDHP79",210,0)
 F I="FAC" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP79",211,0)
 S ^zzfjf("FAC")=DHPFAC
"RTN","SYNDHP79",212,0)
 D FACPAR^SYNDHP69(.RETSTA,DHPFAC)
"RTN","SYNDHP79",213,0)
 D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP79",214,0)
 Q 
"RTN","SYNDHP79",215,0)
 ;
"RTN","SYNDHP79",216,0)
 ;  ---------------------------------------------
"RTN","SYNDHP79",217,0)
 ;
"RTN","SYNDHP79",218,0)
PARSEICN ; ICN PARSER
"RTN","SYNDHP79",219,0)
 ; 
"RTN","SYNDHP79",220,0)
 ;CRASH
"RTN","SYNDHP79",221,0)
 F I="ICN" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP79",222,0)
 Q
"RTN","SYNDHP79",223,0)
PARSETRAITS ; Traits parser
"RTN","SYNDHP79",224,0)
 ;
"RTN","SYNDHP79",225,0)
 F I="SSN","DOB","GENDER" S @("DHP"_I)=$$GETPARAM^RGNETWWW(I)
"RTN","SYNDHP79",226,0)
 S DHPNAME=$$GETPARAM^RGNETWWW("NAME",1,1)
"RTN","SYNDHP79",227,0)
 S DHPNAME=DHPNAME_","_$$GETPARAM^RGNETWWW("NAME",1,2)_" "
"RTN","SYNDHP79",228,0)
 Q
"RTN","SYNDHP79",229,0)
SYNDHPLOG(TS) ; log arrays
"RTN","SYNDHP79",230,0)
 I $D(RGNETREQ) M ^SYNDHPLOG(TS,"RGNETREQ")=RGNETREQ
"RTN","SYNDHP79",231,0)
 I $D(RGCFG) M ^SYNDHPLOG(TS,"RGCFG")=RGCFG
"RTN","SYNDHP79",232,0)
 q
"RTN","SYNDHP83")
0^16^B347144
"RTN","SYNDHP83",1,0)
SYNDHP83 ; AFHIL/fjf - HealthConcourse - retrieve mapped code ;03/21/2019
"RTN","SYNDHP83",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP83",3,0)
 ;
"RTN","SYNDHP83",4,0)
 ;
"RTN","SYNDHP83",5,0)
 Q
"RTN","SYNDHP83",6,0)
 ;
"RTN","SYNDHP83",7,0)
 ; ----------------  Get Mapped Code  ----------------------  
"RTN","SYNDHP83",8,0)
 ;
"RTN","SYNDHP83",9,0)
MAPSVC(RETSTA,DHPMAP,DHPCODE,DHPDIR,DHPIOE) ; get mapped code
"RTN","SYNDHP83",10,0)
 ;
"RTN","SYNDHP83",11,0)
 ; Return mapped code for given mapping and source code
"RTN","SYNDHP83",12,0)
 ;
"RTN","SYNDHP83",13,0)
 ; Input:
"RTN","SYNDHP83",14,0)
 ;   DHPMAP   - map identifier e.g. sct2icd, or rxn2ndf
"RTN","SYNDHP83",15,0)
 ;   DHPCODE  - source code to be mapped
"RTN","SYNDHP83",16,0)
 ;   DHPDIR  - direction of mapping
"RTN","SYNDHP83",17,0)
 ;             D for direct (default)
"RTN","SYNDHP83",18,0)
 ;             I for inverse
"RTN","SYNDHP83",19,0)
 ;   DHPIOE  - use internal or exernal mappings
"RTN","SYNDHP83",20,0)
 ;             I for internal SYN VistA (default)
"RTN","SYNDHP83",21,0)
 ;             H for external HealthConcourse
"RTN","SYNDHP83",22,0)
 ; Output:
"RTN","SYNDHP83",23,0)
 ;   RETSTA   - a delimited string that has the following
"RTN","SYNDHP83",24,0)
 ;              n^target_code
"RTN","SYNDHP83",25,0)
 ;              
"RTN","SYNDHP83",26,0)
 ;             -where n is a flag indicating success/failure of request
"RTN","SYNDHP83",27,0)
 ;                 1 - success
"RTN","SYNDHP83",28,0)
 ;                -1 - exception
"RTN","SYNDHP83",29,0)
 ;                target_code is the code that is the result of the mapping              
"RTN","SYNDHP83",30,0)
 ;             
"RTN","SYNDHP83",31,0)
 N C
"RTN","SYNDHP83",32,0)
 S C=","
"RTN","SYNDHP83",33,0)
 S RETSTA=$$MAP^SYNDHPMP(DHPMAP,DHPCODE,DHPDIR,DHPIOE)
"RTN","SYNDHP83",34,0)
 Q
"RTN","SYNDHP89")
0^17^B401561
"RTN","SYNDHP89",1,0)
SYNDHP89 ; HC/art/fjf - HealthConcourse - DHP REST handlers
"RTN","SYNDHP89",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP89",3,0)
 ;;
"RTN","SYNDHP89",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP89",5,0)
 ;
"RTN","SYNDHP89",6,0)
 Q
"RTN","SYNDHP89",7,0)
 ;  ------------------------------------------------------------
"RTN","SYNDHP89",8,0)
 ;  Patient Text Integration Utility Notes by ICN bridge routine
"RTN","SYNDHP89",9,0)
 ;  ------------------------------------------------------------
"RTN","SYNDHP89",10,0)
 ;
"RTN","SYNDHP89",11,0)
PATTIUI ; get patient conditions for one patient by ICN
"RTN","SYNDHP89",12,0)
 ; ** to be retired
"RTN","SYNDHP89",13,0)
 ;
"RTN","SYNDHP89",14,0)
 ;   DHPPATTIUICN
"RTN","SYNDHP89",15,0)
 ;
"RTN","SYNDHP89",16,0)
 ;D PARSEICN
"RTN","SYNDHP89",17,0)
 ;D PATTIUI^SYNDHP67(.RETSTA,DHPICN)
"RTN","SYNDHP89",18,0)
 ;D ADD^RGNETWWW(RETSTA_$C(13,10))
"RTN","SYNDHP89",19,0)
 Q
"RTN","SYNDHP91")
0^72^B40944851
"RTN","SYNDHP91",1,0)
SYNDHP91 ;DHP/fjf - HealthConcourse - Write care plans to VistA ;11/07/2018
"RTN","SYNDHP91",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNDHP91",3,0)
 ;;
"RTN","SYNDHP91",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP91",5,0)
 ;
"RTN","SYNDHP91",6,0)
 QUIT
"RTN","SYNDHP91",7,0)
 ;
"RTN","SYNDHP91",8,0)
 ;*//Input:
"RTN","SYNDHP91",9,0)
 ; a. Classification
"RTN","SYNDHP91",10,0)
 ; b. Activities SNOMED CT
"RTN","SYNDHP91",11,0)
 ; c. Goals - text and ptr to PL
"RTN","SYNDHP91",12,0)
 ; Status - fhir CODE
"RTN","SYNDHP91",13,0)
 ; Date
"RTN","SYNDHP91",14,0)
 ;
"RTN","SYNDHP91",15,0)
 ;
"RTN","SYNDHP91",16,0)
 ; 1.   Use data2pce to ingest careplans, activities & goals
"RTN","SYNDHP91",17,0)
 ; a.   Encounter
"RTN","SYNDHP91",18,0)
 ; b.   CarePlan points to encounter and the goals
"RTN","SYNDHP91",19,0)
 ; i.   V standard codes (SNOMED CT) - classification 
"RTN","SYNDHP91",20,0)
 ; c.   Goals - has text goal - points to condition/problems (reason for goal)
"RTN","SYNDHP91",21,0)
 ; i.   Use Healthfactors 
"RTN","SYNDHP91",22,0)
 ; ii.  Create goals HF category - config - add to configuration utility this will be for problem
"RTN","SYNDHP91",23,0)
 ; iii. For each goal create a health factor if doesn't already exist (laygo) (text from c above)
"RTN","SYNDHP91",24,0)
 ; iv.  Code which references the problem list
"RTN","SYNDHP91",25,0)
 ; v.   Entire text of goal goes in comment and say that goal addresses this problem  -> add SCT + desc code in there too
"RTN","SYNDHP91",26,0)
 ;
"RTN","SYNDHP91",27,0)
 ; d.
"RTN","SYNDHP91",28,0)
 ;
"RTN","SYNDHP91",29,0)
 ; Signature:
"RTN","SYNDHP91",30,0)
 ;Visit IEN
"RTN","SYNDHP91",31,0)
 ;Goals (array) text & code <- problem list code (SNOMED CT & or ICD)
"RTN","SYNDHP91",32,0)
 ;Activities (array) SNOMED code^status
"RTN","SYNDHP91",33,0)
 ;Classification SNOMED CT code
"RTN","SYNDHP91",34,0)
 ;CarePlan Status from FHIR set
"RTN","SYNDHP91",35,0)
 ;
"RTN","SYNDHP91",36,0)
 ;
"RTN","SYNDHP91",37,0)
 ;Generate TIU note for careplan and associate with encounter.
"RTN","SYNDHP91",38,0)
 ;//*
"RTN","SYNDHP91",39,0)
 ;
"RTN","SYNDHP91",40,0)
 ; HF for cat for careplan
"RTN","SYNDHP91",41,0)
 ; HF for careplan (use healthfactor manager
"RTN","SYNDHP91",42,0)
 ; HF for activity 
"RTN","SYNDHP91",43,0)
 ; pass to DATA2PCE
"RTN","SYNDHP91",44,0)
 ; 
"RTN","SYNDHP91",45,0)
 ;
"RTN","SYNDHP91",46,0)
 ; -------- Create Care Plan for Patient
"RTN","SYNDHP91",47,0)
 ;
"RTN","SYNDHP91",48,0)
CPLUPDT(RETSTA,DHPPAT,DHPVST,DHPCAT,DHPACT,DHPGOL,DHPSCT,DHPSDT,DHPEDT) ;  update
"RTN","SYNDHP91",49,0)
 ;
"RTN","SYNDHP91",50,0)
 ; Input:
"RTN","SYNDHP91",51,0)
 ;   DHPPAT   - Patient ICN
"RTN","SYNDHP91",52,0)
 ;   DHPVST   - Visit ID
"RTN","SYNDHP91",53,0)
 ;   DHPCAT   - Category ID (SCT code. text, and FHIR status - active, completed, etc)
"RTN","SYNDHP91",54,0)
 ;   DHPACT   - List of Activities (SCT code, text, and FHIR status - in-progress, etc)
"RTN","SYNDHP91",55,0)
 ;   DHPGOL   - List of Goals
"RTN","SYNDHP91",56,0)
 ;   DHPSCT   - Reason for CarePlan (SCT code) - Care Plan Addresses
"RTN","SYNDHP91",57,0)
 ;   DHPSDT   - CarePlan Period start
"RTN","SYNDHP91",58,0)
 ;   DHPEDT   - CarePlan period end
"RTN","SYNDHP91",59,0)
 ;
"RTN","SYNDHP91",60,0)
 ;
"RTN","SYNDHP91",61,0)
 ; Output:   RETSTA
"RTN","SYNDHP91",62,0)
 ;  1 - success
"RTN","SYNDHP91",63,0)
 ; -1 - failure -1^message
"RTN","SYNDHP91",64,0)
 ;
"RTN","SYNDHP91",65,0)
 I '$D(^DPT("AFICN",DHPPAT)) S RETSTA="-1^Patient not recognised" Q
"RTN","SYNDHP91",66,0)
 ;
"RTN","SYNDHP91",67,0)
 ;I $G(DHPSCT)="" S RETSTA="-1^SNOMED CT code is required" Q
"RTN","SYNDHP91",68,0)
 I $G(DHPVST)="" S RETSTA="-1^Visit IEN is required" Q
"RTN","SYNDHP91",69,0)
 I '$D(^AUPNVSIT(DHPVST)) S RETSTA="-1^Visit not found" Q
"RTN","SYNDHP91",70,0)
 ;
"RTN","SYNDHP91",71,0)
 ;
"RTN","SYNDHP91",72,0)
 ;
"RTN","SYNDHP91",73,0)
 S U="^",T="~"
"RTN","SYNDHP91",74,0)
 ;
"RTN","SYNDHP91",75,0)
 S DHPGOL=$G(DHPGOL)
"RTN","SYNDHP91",76,0)
 S DHPSCT=$G(DHPSCT)
"RTN","SYNDHP91",77,0)
 S DHPSDT=$P($$HL7TFM^XLFDT(DHPSDT),".",1)
"RTN","SYNDHP91",78,0)
 S DHPEDT=$P($$HL7TFM^XLFDT(DHPEDT),".",1)
"RTN","SYNDHP91",79,0)
 ;
"RTN","SYNDHP91",80,0)
 S VISIT=DHPVST
"RTN","SYNDHP91",81,0)
 S PATIEN=$O(^DPT("AFICN",DHPPAT,""),-1)
"RTN","SYNDHP91",82,0)
 S PACKAGE=$$FIND1^DIC(9.4,,"","?")
"RTN","SYNDHP91",83,0)
 S SOURCE="DHP DATA INGEST"
"RTN","SYNDHP91",84,0)
 S USER=$$DUZ^SYNDHP69
"RTN","SYNDHP91",85,0)
 S ERRDISP=""
"RTN","SYNDHP91",86,0)
 I $G(DEBUG)=1 S ERRDISP=1
"RTN","SYNDHP91",87,0)
 S CATCD=$P(DHPCAT,T)
"RTN","SYNDHP91",88,0)
 S CATTX=$P(DHPCAT,T,2)
"RTN","SYNDHP91",89,0)
 S CATST=$P(DHPCAT,T,3)
"RTN","SYNDHP91",90,0)
 ;S CONC=$$CODE^LEXTRAN(DHPSCT,"SCT",,,,,1)
"RTN","SYNDHP91",91,0)
 S ADDCD=$P(DHPSCT,U)
"RTN","SYNDHP91",92,0)
 S ADDTX=$P(DHPSCT,U,2)
"RTN","SYNDHP91",93,0)
 S ADDST=$P(DHPSCT,U,3)
"RTN","SYNDHP91",94,0)
 ;
"RTN","SYNDHP91",95,0)
 ; Call HF manager and retrieve HF for careplan category data or
"RTN","SYNDHP91",96,0)
 ;   add category HF and return data if it doesn't already exist 
"RTN","SYNDHP91",97,0)
 S CATDAT=$$HFCPCAT^SYNFHF(CATCD,CATTX)
"RTN","SYNDHP91",98,0)
 ;
"RTN","SYNDHP91",99,0)
 ; Call HF manager and retrieve HF for careplan
"RTN","SYNDHP91",100,0)
 ;   add careplan HF if it doesn't already exist
"RTN","SYNDHP91",101,0)
 S HFCAP=$$HFCP^SYNFHF(CATCD,CATTX,CATDAT)
"RTN","SYNDHP91",102,0)
 ;
"RTN","SYNDHP91",103,0)
 ; Call HF manager and retrieve HF for careplan addresses data or
"RTN","SYNDHP91",104,0)
 ;   add addresses HF and return data if it doesn't already exist 
"RTN","SYNDHP91",105,0)
 S ADDDAT=$$HFADDR^SYNFHF(ADDCD,ADDTX,CATDAT)
"RTN","SYNDHP91",106,0)
 ;
"RTN","SYNDHP91",107,0)
 ; create encounter array
"RTN","SYNDHP91",108,0)
 ;
"RTN","SYNDHP91",109,0)
 K ENCDATA
"RTN","SYNDHP91",110,0)
 ; 
"RTN","SYNDHP91",111,0)
 ;
"RTN","SYNDHP91",112,0)
 ; Careplan health factor
"RTN","SYNDHP91",113,0)
 ;
"RTN","SYNDHP91",114,0)
 S ENCDATA("HEALTH FACTOR",1,"HEALTH FACTOR")=+HFCAP
"RTN","SYNDHP91",115,0)
 S ENCDATA("HEALTH FACTOR",1,"EVENT D/T")=DHPSDT
"RTN","SYNDHP91",116,0)
 S ENCDATA("HEALTH FACTOR",1,"COMMENT")="Start: "_DHPSDT_" End: "_DHPEDT_" Status: "_CATST
"RTN","SYNDHP91",117,0)
 ;
"RTN","SYNDHP91",118,0)
 ; what health factor addresses
"RTN","SYNDHP91",119,0)
 ;
"RTN","SYNDHP91",120,0)
 S ENCDATA("HEALTH FACTOR",2,"HEALTH FACTOR")=+ADDDAT
"RTN","SYNDHP91",121,0)
 S ENCDATA("HEALTH FACTOR",2,"EVENT D/T")=DHPSDT
"RTN","SYNDHP91",122,0)
 S ENCDATA("HEALTH FACTOR",2,"COMMENT")="Start: "_DHPSDT_" End: "_DHPEDT ; _" Status: "_ADDST
"RTN","SYNDHP91",123,0)
 ;
"RTN","SYNDHP91",124,0)
 ; careplan activities
"RTN","SYNDHP91",125,0)
 ;
"RTN","SYNDHP91",126,0)
 I +CATDAT'=0 D
"RTN","SYNDHP91",127,0)
 .F I=1:1:$L(DHPACT,U) D
"RTN","SYNDHP91",128,0)
 ..S ACTS=$P(DHPACT,U,I)
"RTN","SYNDHP91",129,0)
 ..S ACTSCT=$P(ACTS,T)
"RTN","SYNDHP91",130,0)
 ..S ACTTXT=$P(ACTS,T,2)
"RTN","SYNDHP91",131,0)
 ..S ACTSTA=$P(ACTS,T,3)
"RTN","SYNDHP91",132,0)
 ..S HFACT=$$HFACT^SYNFHF(ACTSCT,ACTTXT,+CATDAT)
"RTN","SYNDHP91",133,0)
 ..S ENCDATA("HEALTH FACTOR",I+2,"HEALTH FACTOR")=+HFACT
"RTN","SYNDHP91",134,0)
 ..S ENCDATA("HEALTH FACTOR",I+2,"EVENT D/T")=DHPSDT
"RTN","SYNDHP91",135,0)
 ..S ENCDATA("HEALTH FACTOR",I+2,"COMMENT")="Start: "_DHPSDT_" End: "_DHPEDT_" Status: "_ACTSTA
"RTN","SYNDHP91",136,0)
 ; 
"RTN","SYNDHP91",137,0)
GOLS ; careplan goals
"RTN","SYNDHP91",138,0)
 ;
"RTN","SYNDHP91",139,0)
 F J=1:1:$L(DHPGOL,U) D
"RTN","SYNDHP91",140,0)
 .S GOLS=$P(DHPGOL,U,J)
"RTN","SYNDHP91",141,0)
 .S GOLSCT=$P(GOLS,T)
"RTN","SYNDHP91",142,0)
 .S GOLTXT=$P(GOLS,T,2)
"RTN","SYNDHP91",143,0)
 .S GOLSTA=$P(GOLS,T,3)
"RTN","SYNDHP91",144,0)
 .S HFACT=$$HFGOAL^SYNFHF(GOLSCT,+CATDAT,GOLTXT)
"RTN","SYNDHP91",145,0)
 .S ENCDATA("HEALTH FACTOR",J+I+2,"HEALTH FACTOR")=+HFACT
"RTN","SYNDHP91",146,0)
 .S ENCDATA("HEALTH FACTOR",J+I+2,"EVENT D/T")=DHPSDT
"RTN","SYNDHP91",147,0)
 .S ENCDATA("HEALTH FACTOR",J+I+2,"COMMENT")="Start: "_DHPSDT_" End: "_DHPEDT_" Status: "_GOLSTA
"RTN","SYNDHP91",148,0)
 ;
"RTN","SYNDHP91",149,0)
 ;
"RTN","SYNDHP91",150,0)
 S RETSTA=$$DATA2PCE^PXAI("ENCDATA",PACKAGE,SOURCE,.VISIT,USER,$G(ERRDISP),.ZZERR,$G(PPEDIT),.ZZERDESC,.ACCOUNT)
"RTN","SYNDHP91",151,0)
 D EVARS
"RTN","SYNDHP91",152,0)
 M RETSTA=ENCDATA
"RTN","SYNDHP91",153,0)
 Q
"RTN","SYNDHP91",154,0)
 ;
"RTN","SYNDHP91",155,0)
 ;
"RTN","SYNDHP91",156,0)
T1 ;
"RTN","SYNDHP91",157,0)
 ;
"RTN","SYNDHP91",158,0)
 D VARS
"RTN","SYNDHP91",159,0)
 D CPLUPDT(.ZXC,DHPPAT,DHPVST,DHPCAT,DHPACT,DHPGOL,DHPSCT,DHPSDT,DHPEDT)
"RTN","SYNDHP91",160,0)
 Q
"RTN","SYNDHP91",161,0)
 ; 
"RTN","SYNDHP91",162,0)
 ;s q=""""
"RTN","SYNDHP91",163,0)
 ;
"RTN","SYNDHP91",164,0)
 ;w q
"RTN","SYNDHP91",165,0)
 ;
"RTN","SYNDHP91",166,0)
 ;F I=1:1:7 s @$p(a(I),q,8)=$p(a(I),"=",2)
"RTN","SYNDHP91",167,0)
 ;
"RTN","SYNDHP91",168,0)
 ;a(1)="^%wd(17.040801,1,1227,"load","careplan",12,"parms","DHPACT")=409002~Food allergy diet~in-progress^58332002~Allergy education~in-progress"
"RTN","SYNDHP91",169,0)
 ;a(2)="^%wd(17.040801,1,1227,"load","careplan",12,"parms","DHPCAT")=326051000000105~Self care~active"
"RTN","SYNDHP91",170,0)
 ;a(3)="^%wd(17.040801,1,1227,"load","careplan",12,"parms","DHPEDT")="
"RTN","SYNDHP91",171,0)
 ;a(4)="^%wd(17.040801,1,1227,"load","careplan",12,"parms","DHPPAT")=1435855215V947437"
"RTN","SYNDHP91",172,0)
 ;a(5)="^%wd(17.040801,1,1227,"load","careplan",12,"parms","DHPSCT")="
"RTN","SYNDHP91",173,0)
 ;a(6)="^%wd(17.040801,1,1227,"load","careplan",12,"parms","DHPSDT")=2760829"
"RTN","SYNDHP91",174,0)
 ;a(7)="^%wd(17.040801,1,1227,"load","careplan",12,"parms","DHPVST")=34818"
"RTN","SYNDHP91",175,0)
 ;
"RTN","SYNDHP91",176,0)
VARS ;
"RTN","SYNDHP91",177,0)
 S DHPACT="409002~Food allergy diet~in-progress^58332002~Allergy education~in-progress"
"RTN","SYNDHP91",178,0)
 S DHPCAT="326051000000105~Self care~active"
"RTN","SYNDHP91",179,0)
 S DHPEDT=""
"RTN","SYNDHP91",180,0)
 S DHPPAT="1345112108V472042"
"RTN","SYNDHP91",181,0)
 S DHPSCT="230690007^Cerebrovascular accident^passive"
"RTN","SYNDHP91",182,0)
 S DHPSDT="19760829"
"RTN","SYNDHP91",183,0)
 S DHPVST="34885"
"RTN","SYNDHP91",184,0)
 S DHPGOL="15777000~Address patient knowledge deficit on diabetic self-care~in-progress^15777000"
"RTN","SYNDHP91",185,0)
 S DHPGOL=DHPGOL_"~Improve and maintenance of optimal foot health: aim at early detection of peripheral"
"RTN","SYNDHP91",186,0)
 S DHPGOL=DHPGOL_" vascular problems and neuropathy presumed due to diabetes; and prevention of diabetic"
"RTN","SYNDHP91",187,0)
 S DHPGOL=DHPGOL_" foot ulcer, gangrene~in-progress^15777000~Maintain blood pressure below 140/90 mmHg"
"RTN","SYNDHP91",188,0)
 S DHPGOL=DHPGOL_"~in-progress^15777000~Glucose [Mass/volume] in Blood < 108~in-progress^15777000"
"RTN","SYNDHP91",189,0)
 S DHPGOL=DHPGOL_"~Hemoglobin A1c total in Blood < 7.0~in-progress"
"RTN","SYNDHP91",190,0)
 Q
"RTN","SYNDHP91",191,0)
 ; 
"RTN","SYNDHP91",192,0)
EVARS ;
"RTN","SYNDHP91",193,0)
 S ENCDATA("IVARS","DHPACT")=DHPACT
"RTN","SYNDHP91",194,0)
 S ENCDATA("IVARS","DHPCAT")=DHPCAT
"RTN","SYNDHP91",195,0)
 S ENCDATA("IVARS","DHPEDT")=DHPEDT
"RTN","SYNDHP91",196,0)
 S ENCDATA("IVARS","DHPPAT")=DHPPAT
"RTN","SYNDHP91",197,0)
 S ENCDATA("IVARS","DHPSCT")=DHPSCT
"RTN","SYNDHP91",198,0)
 S ENCDATA("IVARS","DHPSDT")=DHPSDT
"RTN","SYNDHP91",199,0)
 S ENCDATA("IVARS","DHPVST")=DHPVST
"RTN","SYNDHP91",200,0)
 S ENCDATA("IVARS","DHPGOL")=DHPGOL
"RTN","SYNDHP91",201,0)
 Q
"RTN","SYNDHP92")
0^82^B9874705
"RTN","SYNDHP92",1,0)
SYNDHP92 ; HC/ART - HealthConcourse - DHP Save TIU Note ;01/26/2019
"RTN","SYNDHP92",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP92",3,0)
 ;;
"RTN","SYNDHP92",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP92",5,0)
 ;
"RTN","SYNDHP92",6,0)
 QUIT
"RTN","SYNDHP92",7,0)
 ;
"RTN","SYNDHP92",8,0)
CREATETIU(RETSTAT,DHPICN,TITLE,VISIT,TEXT,ESIG) ;save a TIU note for a patient
"RTN","SYNDHP92",9,0)
 ;Inputs: RETSTAT - return status, by reference
"RTN","SYNDHP92",10,0)
 ;        DHPICN  - patient ICN, required
"RTN","SYNDHP92",11,0)
 ;        TITLE   - pointer to the TIU DOCUMENT DEFINITION FILE (#8925.1), required
"RTN","SYNDHP92",12,0)
 ;        VISIT   - pointer to the Visit File (#9000010), required
"RTN","SYNDHP92",13,0)
 ;        TEXT    - input array with document identifiers and text, by reference, required
"RTN","SYNDHP92",14,0)
 ;          TEXT("TEXT",1,0)="abcd"
"RTN","SYNDHP92",15,0)
 ;          TEXT("TEXT",n,0)="wxyz"
"RTN","SYNDHP92",16,0)
 ;        ESIG - e-signature to sign note
"RTN","SYNDHP92",17,0)
 ;Output: RETSTAT - return status
"RTN","SYNDHP92",18,0)
 ;          IEN of the resulting entry in the TIU DOCUMENT FILE (#8925)
"RTN","SYNDHP92",19,0)
 ;       or -1^error message
"RTN","SYNDHP92",20,0)
 ;
"RTN","SYNDHP92",21,0)
 ; validate ICN
"RTN","SYNDHP92",22,0)
 I $G(DHPICN)="" S RETSTAT="-1^No patient identifier" QUIT
"RTN","SYNDHP92",23,0)
 I '$$UICNVAL^SYNDHPUTL(DHPICN) S RETSTAT="-1^Patient identifier not recognised" QUIT
"RTN","SYNDHP92",24,0)
 ; get patient IEN from ICN
"RTN","SYNDHP92",25,0)
 N PATIEN S PATIEN=$O(^DPT("AFICN",DHPICN,""))
"RTN","SYNDHP92",26,0)
 I PATIEN="" S RETSTAT="-1^AFICN x-ref issue" QUIT
"RTN","SYNDHP92",27,0)
 ; 
"RTN","SYNDHP92",28,0)
 ; validate TITLE
"RTN","SYNDHP92",29,0)
 I '$G(TITLE) S RETSTAT="-1^No title identifier" QUIT
"RTN","SYNDHP92",30,0)
 I '$D(^TIU(8925.1,TITLE,0)) S RETSTAT="-1^Title not found" QUIT
"RTN","SYNDHP92",31,0)
 ;
"RTN","SYNDHP92",32,0)
 ; validate VISIT
"RTN","SYNDHP92",33,0)
 I '$G(VISIT) S RETSTAT="-1^No visit identifier" QUIT
"RTN","SYNDHP92",34,0)
 I '$D(^AUPNVSIT(VISIT,0)) S RETSTAT="-1^Visit not found" QUIT
"RTN","SYNDHP92",35,0)
 N PAT S PAT=$$GET1^DIQ(9000010,VISIT_",",.05,"I")
"RTN","SYNDHP92",36,0)
 I PATIEN'=PAT S RETSTAT="-1^Visit is not for this patient" QUIT
"RTN","SYNDHP92",37,0)
 ;
"RTN","SYNDHP92",38,0)
 ; validate TEXT
"RTN","SYNDHP92",39,0)
 I '$D(TEXT) S RETSTAT="-1^No note text" QUIT
"RTN","SYNDHP92",40,0)
 ;
"RTN","SYNDHP92",41,0)
 ;optional parameters
"RTN","SYNDHP92",42,0)
 N VDATE S VDATE=""
"RTN","SYNDHP92",43,0)
 N VLOC S VLOC=""
"RTN","SYNDHP92",44,0)
 N VSTR S VSTR=""
"RTN","SYNDHP92",45,0)
 N SUPPRESS S SUPPRESS=0
"RTN","SYNDHP92",46,0)
 N NOASF S NOASF=1
"RTN","SYNDHP92",47,0)
 ;
"RTN","SYNDHP92",48,0)
 N VPROV S VPROV=$O(^AUPNVPRV("AD",VISIT,"")) ;visit provider ien
"RTN","SYNDHP92",49,0)
 I VPROV="" S RETSTAT="-1^no provider associated with visit" QUIT
"RTN","SYNDHP92",50,0)
 w "VPROV: ",VPROV,"    ",$$GET1^DIQ(200,VPROV_",",.01),!
"RTN","SYNDHP92",51,0)
 ;
"RTN","SYNDHP92",52,0)
 N TIUX
"RTN","SYNDHP92",53,0)
 S TIUX(.02)=PATIEN ;Patient IEN
"RTN","SYNDHP92",54,0)
 S TIUX(.01)=TITLE
"RTN","SYNDHP92",55,0)
 S TIUX(.03)=VISIT
"RTN","SYNDHP92",56,0)
 S TIUX(1201)=$$NOW^XLFDT() ;entry date/time
"RTN","SYNDHP92",57,0)
 S TIUX(1205)=$$GET1^DIQ(9000010,VISIT_",",.06,"I") ;hospital location
"RTN","SYNDHP92",58,0)
 S TIUX(1301)=$$GET1^DIQ(9000010,VISIT_",",.01,"I") ;reference date=Visit Date
"RTN","SYNDHP92",59,0)
 M TIUX=TEXT ;note text
"RTN","SYNDHP92",60,0)
 ;
"RTN","SYNDHP92",61,0)
 ;create the note
"RTN","SYNDHP92",62,0)
 D MAKE^TIUSRVP(.RETSTAT,PATIEN,TITLE,VDATE,VLOC,VISIT,.TIUX,VSTR,SUPPRESS,NOASF)
"RTN","SYNDHP92",63,0)
 I '+RETSTAT S RETSTAT="-1^Error creating note^"_RETSTAT QUIT
"RTN","SYNDHP92",64,0)
 ;
"RTN","SYNDHP92",65,0)
 N FDA
"RTN","SYNDHP92",66,0)
 N IENS S IENS=+RETSTAT_","
"RTN","SYNDHP92",67,0)
 S FDA(8925,IENS,1202)=VPROV
"RTN","SYNDHP92",68,0)
 S FDA(8925,IENS,1204)=VPROV
"RTN","SYNDHP92",69,0)
 S FDA(8925,IENS,1302)=VPROV
"RTN","SYNDHP92",70,0)
 D FILE^DIE("K","FDA","MSG")
"RTN","SYNDHP92",71,0)
 ;
"RTN","SYNDHP92",72,0)
 N NOTEIEN S NOTEIEN=+RETSTAT
"RTN","SYNDHP92",73,0)
 ;
"RTN","SYNDHP92",74,0)
 ;sign the note
"RTN","SYNDHP92",75,0)
 QUIT:$G(ESIG)=""
"RTN","SYNDHP92",76,0)
 N duzsave S duzsave=DUZ
"RTN","SYNDHP92",77,0)
 S DUZ=VPROV
"RTN","SYNDHP92",78,0)
 N RETVAL
"RTN","SYNDHP92",79,0)
 D SIGN^TIUSRVP(.RETVAL,NOTEIEN,$$ENCRYP^XUSRB1(ESIG))
"RTN","SYNDHP92",80,0)
 I +RETVAL S RETSTAT="-1^Error signing note^"_RETVAL
"RTN","SYNDHP92",81,0)
 S DUZ=duzsave
"RTN","SYNDHP92",82,0)
 ;
"RTN","SYNDHP92",83,0)
 QUIT
"RTN","SYNDHP92",84,0)
 ;
"RTN","SYNDHP99")
0^84^B15985554
"RTN","SYNDHP99",1,0)
SYNDHP99 ; HC/art - HealthConcourse - retrieve VistA data for a resource id ;05/08/2019
"RTN","SYNDHP99",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHP99",3,0)
 ;;
"RTN","SYNDHP99",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHP99",5,0)
 ;
"RTN","SYNDHP99",6,0)
 QUIT
"RTN","SYNDHP99",7,0)
 ;
"RTN","SYNDHP99",8,0)
GETREC(RETSTR,RESID) ; Get VistA record for Resource ID
"RTN","SYNDHP99",9,0)
 ;Inputs: RETSTR - return string, by reference
"RTN","SYNDHP99",10,0)
 ;        RESID  - resource id - V_site_file#_record#
"RTN","SYNDHP99",11,0)
 ;Output: RETSTR - VistA record as a JSON string
"RTN","SYNDHP99",12,0)
 ;              or error message   
"RTN","SYNDHP99",13,0)
 ;
"RTN","SYNDHP99",14,0)
 S ^TMP("ZZZ")=RESID_"^333"
"RTN","SYNDHP99",15,0)
 new UL set UL="_"
"RTN","SYNDHP99",16,0)
 new P set P="|"
"RTN","SYNDHP99",17,0)
 set DUZ=$$DUZ^SYNDHP69
"RTN","SYNDHP99",18,0)
 set RETSTR=""
"RTN","SYNDHP99",19,0)
 ;
"RTN","SYNDHP99",20,0)
 ;check parameter
"RTN","SYNDHP99",21,0)
 if $g(RESID)="" set RETSTR="{""error:"":""resourceId is null""}" QUIT
"RTN","SYNDHP99",22,0)
 if $e(RESID)'="V" set RETSTR="{""error:"":""this is not a VistA resourceId""}" QUIT
"RTN","SYNDHP99",23,0)
 if $p(RESID,UL,2)'=DUZ(2) set RETSTR="{""error:"":""this is not the site requested""}" QUIT
"RTN","SYNDHP99",24,0)
 if +$p(RESID,UL,3)=0 set RETSTR="{""error:"":""the file number must be numeric""}" QUIT
"RTN","SYNDHP99",25,0)
 if +$p(RESID,UL,4)=0 set RETSTR="{""error:"":""the record number must be numeric""}" QUIT
"RTN","SYNDHP99",26,0)
 ;
"RTN","SYNDHP99",27,0)
 ;load file array
"RTN","SYNDHP99",28,0)
 new IDX,FILES,VFILES,FNBR,EP,FNAME
"RTN","SYNDHP99",29,0)
 for IDX=1:1 set FILES=$p($t(FILELIST+IDX),";;",2) QUIT:FILES="zzzzz"  do
"RTN","SYNDHP99",30,0)
 . set FNBR=$p(FILES,P,1)
"RTN","SYNDHP99",31,0)
 . set EP=$p(FILES,P,2)
"RTN","SYNDHP99",32,0)
 . set FNAME=$p(FILES,P,3)
"RTN","SYNDHP99",33,0)
 . set VFILES(FNBR)=EP_P_FNAME
"RTN","SYNDHP99",34,0)
 ;zwrite VFILES
"RTN","SYNDHP99",35,0)
 ;
"RTN","SYNDHP99",36,0)
 new FILE,RECORD
"RTN","SYNDHP99",37,0)
 set FILE=$p(RESID,UL,3)
"RTN","SYNDHP99",38,0)
 set RECORD=$p(RESID,UL,4)
"RTN","SYNDHP99",39,0)
 if '$d(VFILES(FILE)) set RETSTR="{""error:"":""this file is currently not supported""}" QUIT
"RTN","SYNDHP99",40,0)
 set:FILE=2.98 RECORD=+$O(^DPT(RECORD,"S",0))_","_RECORD_","
"RTN","SYNDHP99",41,0)
 if $$GET1^DIQ(FILE,RECORD_",",.01)="" set RETSTR="{""error:"":""the record was not found""}" QUIT
"RTN","SYNDHP99",42,0)
 set RECORD=$p(RESID,UL,4)
"RTN","SYNDHP99",43,0)
 ;
"RTN","SYNDHP99",44,0)
 new GETTER
"RTN","SYNDHP99",45,0)
 set GETTER=$p($g(VFILES(FILE)),P,1)
"RTN","SYNDHP99",46,0)
 if GETTER="" set RETSTR="{""error:"":""fatal internal error""}" QUIT
"RTN","SYNDHP99",47,0)
 new ARRAY,JSONSTR
"RTN","SYNDHP99",48,0)
 set GETTER=GETTER_"(.ARRAY,RECORD,""J"",.RETSTR)"
"RTN","SYNDHP99",49,0)
 do @GETTER
"RTN","SYNDHP99",50,0)
 ;
"RTN","SYNDHP99",51,0)
 QUIT
"RTN","SYNDHP99",52,0)
 ;
"RTN","SYNDHP99",53,0)
FILELIST ;file#|GETer routine|file name
"RTN","SYNDHP99",54,0)
 ;;2|GETPATIENT^SYNDHP20|Patient
"RTN","SYNDHP99",55,0)
 ;;2.98|GETPATAPPT^SYNDHP25|Patient Appointments
"RTN","SYNDHP99",56,0)
 ;;4|GET1SITE^SYNDHP10|Institution
"RTN","SYNDHP99",57,0)
 ;;26.13|GET1FLAG^SYNDHP17|PRF Assignment (flags)
"RTN","SYNDHP99",58,0)
 ;;44|GETHLOC^SYNDHP22|Hospital location
"RTN","SYNDHP99",59,0)
 ;;63|GETLABS^SYNDHP21|Lab Data
"RTN","SYNDHP99",60,0)
 ;;120.5|GET1VITALS^SYNDHP16|GMRV Vital Measurement
"RTN","SYNDHP99",61,0)
 ;;120.8|GET1ALLERGY^SYNDHP16|Patient Allergies
"RTN","SYNDHP99",62,0)
 ;;124.3|GET1GMR^SYNDHP15|GMR Text
"RTN","SYNDHP99",63,0)
 ;;216.8|GET1NCP^SYNDHP15|Nurs Care Plan
"RTN","SYNDHP99",64,0)
 ;;404.51|GET1TEAM^SYNDHP18|Team
"RTN","SYNDHP99",65,0)
 ;;404.52|ASGNHIST^SYNDHP19|Position Assignment History
"RTN","SYNDHP99",66,0)
 ;;404.53|PRECHIST^SYNDHP19|Preceptor Assignment History
"RTN","SYNDHP99",67,0)
 ;;404.57|TEAMPOS^SYNDHP18|Team Position
"RTN","SYNDHP99",68,0)
 ;;404.58|GET1TEAM^SYNDHP18|Team History
"RTN","SYNDHP99",69,0)
 ;;404.59|TEAMPOS^SYNDHP18|Team Position History
"RTN","SYNDHP99",70,0)
 ;;627.8|GET1MHDX^SYNDHP17|Diagnostic Report-Mental Health
"RTN","SYNDHP99",71,0)
 ;;8925|GET1TIU^SYNDHP24|TIU Document
"RTN","SYNDHP99",72,0)
 ;;9000010|GET1VISIT^SYNDHP13|Visit
"RTN","SYNDHP99",73,0)
 ;;9000010.06|GET1VPROV^SYNDHP23|V Provider
"RTN","SYNDHP99",74,0)
 ;;9000010.07|GET1VPOV^SYNDHP13|V POV
"RTN","SYNDHP99",75,0)
 ;;9000010.11|GET1IMMUN^SYNDHP12|V Immunization
"RTN","SYNDHP99",76,0)
 ;;9000010.18|GET1VCPT^SYNDHP14|V CPT
"RTN","SYNDHP99",77,0)
 ;;9000010.23|GET1HLF^SYNDHP15|V Health Factors
"RTN","SYNDHP99",78,0)
 ;;9000010.71|GET1VSCODE^SYNDHP14|V Standard Codes
"RTN","SYNDHP99",79,0)
 ;;9000011|GET1PROB^SYNDHP11|Problem
"RTN","SYNDHP99",80,0)
 ;;zzzzz
"RTN","SYNDHP99",81,0)
 ;
"RTN","SYNDHP99",82,0)
T1 ;
"RTN","SYNDHP99",83,0)
 N RESID S RESID="V_500_9000010_34494"
"RTN","SYNDHP99",84,0)
 N RETSTA
"RTN","SYNDHP99",85,0)
 D GETREC(.RETSTA,RESID)
"RTN","SYNDHP99",86,0)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
"RTN","SYNDHP99",87,0)
 QUIT
"RTN","SYNDHP99",88,0)
 ;
"RTN","SYNDHP99",89,0)
T2 ;
"RTN","SYNDHP99",90,0)
 N RESID S RESID="V_500_2.98_33"
"RTN","SYNDHP99",91,0)
 N RETSTA
"RTN","SYNDHP99",92,0)
 D GETREC(.RETSTA,RESID)
"RTN","SYNDHP99",93,0)
 W $$ZW^SYNDHPUTL("RETSTA"),!!
"RTN","SYNDHP99",94,0)
 QUIT
"RTN","SYNDHP99",95,0)
 ;
"RTN","SYNDHPGEN")
0^77^B88669667
"RTN","SYNDHPGEN",1,0)
SYNDHPGEN ; HC/art - code generator ;05/08/2019
"RTN","SYNDHPGEN",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHPGEN",3,0)
 ;
"RTN","SYNDHPGEN",4,0)
 ;
"RTN","SYNDHPGEN",5,0)
 quit
"RTN","SYNDHPGEN",6,0)
 ;
"RTN","SYNDHPGEN",7,0)
GEN(RTN,ID,FILES) ; generate GETer code for a file
"RTN","SYNDHPGEN",8,0)
 ;inputs: ID - file name or abbreviation
"RTN","SYNDHPGEN",9,0)
 ;        FILES  - array of file numbers, by reference
"RTN","SYNDHPGEN",10,0)
 ;             FILES(1)=file number of file to extract
"RTN","SYNDHPGEN",11,0)
 ;             FILES(n)=file number^multiple level
"RTN","SYNDHPGEN",12,0)
 ;output: RTN - returned array of generated code, by reference
"RTN","SYNDHPGEN",13,0)
 ;        /tmp/genCode.txt - generated code (also written to the terminal screen)
"RTN","SYNDHPGEN",14,0)
 ;
"RTN","SYNDHPGEN",15,0)
 i $g(ID)="" w "0^ID is not defined",! quit
"RTN","SYNDHPGEN",16,0)
 i $g(FILES(1))="" w "0^FILES is not defined",! quit
"RTN","SYNDHPGEN",17,0)
 ;
"RTN","SYNDHPGEN",18,0)
 n IDtitle S IDtitle=$$TITLE^XLFSTR(ID)
"RTN","SYNDHPGEN",19,0)
 n cnt s cnt=0
"RTN","SYNDHPGEN",20,0)
 n fileCnt s fileCnt=0
"RTN","SYNDHPGEN",21,0)
 ; header
"RTN","SYNDHPGEN",22,0)
 s RTN(1)="GET1"_ID_"("_ID_","_ID_"IEN,RETJSON,"_ID_"J) ;get one "_IDtitle_" record"
"RTN","SYNDHPGEN",23,0)
 s RTN(2)=" ;inputs: "_ID_"IEN - "_IDtitle_" IEN"
"RTN","SYNDHPGEN",24,0)
 s RTN(3)=" ;        RETJSON - J = Return JSON"
"RTN","SYNDHPGEN",25,0)
 s RTN(4)=" ;output: "_ID_"  - array of "_IDtitle_" data, by reference"
"RTN","SYNDHPGEN",26,0)
 s RTN(5)=" ;        "_ID_"J - JSON structure of "_IDtitle_" data, by reference"
"RTN","SYNDHPGEN",27,0)
 s RTN(6)=" ;"
"RTN","SYNDHPGEN",28,0)
 ; initialization
"RTN","SYNDHPGEN",29,0)
 s RTN(7)=" I $G(DEBUG) W !,""--------------------------- "_IDtitle_" -----------------------------"",!"
"RTN","SYNDHPGEN",30,0)
 s RTN(8)=" N S S S=""_"""
"RTN","SYNDHPGEN",31,0)
 s RTN(9)=" N SITE S SITE=$P($$SITE^VASITE,""^"",3)"
"RTN","SYNDHPGEN",32,0)
 s cnt=10
"RTN","SYNDHPGEN",33,0)
 n i s i=""
"RTN","SYNDHPGEN",34,0)
 f  s i=$o(FILES(i)) q:i=""  d
"RTN","SYNDHPGEN",35,0)
 . s RTN(cnt)=" N FNBR"_i_" S FNBR"_i_"="_+FILES(i)_" ;"_$o(^DD(+FILES(i),0,"NM",""))
"RTN","SYNDHPGEN",36,0)
 . s cnt=cnt+1
"RTN","SYNDHPGEN",37,0)
 . s fileCnt=i
"RTN","SYNDHPGEN",38,0)
 s RTN(cnt)=" N IENS1 S IENS1="_ID_"IEN_"","""
"RTN","SYNDHPGEN",39,0)
 s cnt=cnt+1
"RTN","SYNDHPGEN",40,0)
 s RTN(cnt)=" ;"
"RTN","SYNDHPGEN",41,0)
 s cnt=cnt+1
"RTN","SYNDHPGEN",42,0)
 ; read record
"RTN","SYNDHPGEN",43,0)
 s RTN(cnt)=" N "_ID_"ARR,"_ID_"ERR"
"RTN","SYNDHPGEN",44,0)
 s cnt=cnt+1
"RTN","SYNDHPGEN",45,0)
 s RTN(cnt)=" D GETS^DIQ(FNBR1,IENS1,""**"",""EI"","""_ID_"ARR"","""_ID_"ERR"")"
"RTN","SYNDHPGEN",46,0)
 s cnt=cnt+1
"RTN","SYNDHPGEN",47,0)
 s RTN(cnt)=" ;I $G(DEBUG) W ! ZWRITE "_ID_"ARR"
"RTN","SYNDHPGEN",48,0)
 s cnt=cnt+1
"RTN","SYNDHPGEN",49,0)
 s RTN(cnt)=" ;I $G(DEBUG),$D("_ID_"ERR) W !,"">>ERROR<<"" W ! ZWRITE "_ID_"ERR"
"RTN","SYNDHPGEN",50,0)
 s cnt=cnt+1
"RTN","SYNDHPGEN",51,0)
 s RTN(cnt)=" I $D("_ID_"ERR) D  QUIT"
"RTN","SYNDHPGEN",52,0)
 s cnt=cnt+1
"RTN","SYNDHPGEN",53,0)
 s RTN(cnt)=" . S "_ID_"("""_IDtitle_""",""ERROR"")="_ID_"IEN"
"RTN","SYNDHPGEN",54,0)
 s cnt=cnt+1
"RTN","SYNDHPGEN",55,0)
 s RTN(cnt)=" . D:$G(RETJSON)=""J"" TOJASON^SYNDHPUTL(."_ID_",."_ID_"J)"
"RTN","SYNDHPGEN",56,0)
 s cnt=cnt+1
"RTN","SYNDHPGEN",57,0)
 s RTN(cnt)=" S "_ID_"("""_IDtitle_""","""_$$LOW^XLFSTR(ID)_"Ien"")="_ID_"IEN"
"RTN","SYNDHPGEN",58,0)
 s cnt=cnt+1
"RTN","SYNDHPGEN",59,0)
 s RTN(cnt)=" S "_ID_"("""_IDtitle_""",""resourceType"")=""xxxx"""
"RTN","SYNDHPGEN",60,0)
 s cnt=cnt+1
"RTN","SYNDHPGEN",61,0)
 s RTN(cnt)=" S "_ID_"("""_IDtitle_""",""resourceId"")=$$RESID^SYNDHP69(""V"",SITE)_S_FNBR1_S_"_ID_"IEN"
"RTN","SYNDHPGEN",62,0)
 s cnt=cnt+1
"RTN","SYNDHPGEN",63,0)
 ; populate array of field values
"RTN","SYNDHPGEN",64,0)
 n fields
"RTN","SYNDHPGEN",65,0)
 d meta^SYNDHPUTL(.fields,+FILES(1))
"RTN","SYNDHPGEN",66,0)
 n fieldNameCC,fieldType
"RTN","SYNDHPGEN",67,0)
 n field s field=""
"RTN","SYNDHPGEN",68,0)
 f  s field=$o(fields(field)) quit:field=""  d
"RTN","SYNDHPGEN",69,0)
 . s fieldNameCC=$p(fields(field),U,2)
"RTN","SYNDHPGEN",70,0)
 . s fieldType=$p(fields(field),U,3)
"RTN","SYNDHPGEN",71,0)
 . i fieldType'="M" D
"RTN","SYNDHPGEN",72,0)
 . . s RTN(cnt)=" S "_ID_"("""_IDtitle_""","""_fieldNameCC_""")=$G("_ID_"ARR(FNBR1,IENS1,"_field_",""E""))"
"RTN","SYNDHPGEN",73,0)
 . . s cnt=cnt+1
"RTN","SYNDHPGEN",74,0)
 . . i fieldType="P" d  ;pointer
"RTN","SYNDHPGEN",75,0)
 . . . s RTN(cnt)=" S "_ID_"("""_IDtitle_""","""_fieldNameCC_"Id"_""")=$G("_ID_"ARR(FNBR1,IENS1,"_field_",""I""))"
"RTN","SYNDHPGEN",76,0)
 . . . s cnt=cnt+1
"RTN","SYNDHPGEN",77,0)
 . . i fieldType="V" d  ;variable pointer
"RTN","SYNDHPGEN",78,0)
 . . . s RTN(cnt)=" S "_ID_"("""_IDtitle_""","""_fieldNameCC_"Id"_""")=$G("_ID_"ARR(FNBR1,IENS1,"_field_",""I""))"
"RTN","SYNDHPGEN",79,0)
 . . . s cnt=cnt+1
"RTN","SYNDHPGEN",80,0)
 . . i fieldType="S" d  ;set of codes
"RTN","SYNDHPGEN",81,0)
 . . . s RTN(cnt)=" S "_ID_"("""_IDtitle_""","""_fieldNameCC_"Cd"_""")=$G("_ID_"ARR(FNBR1,IENS1,"_field_",""I""))"
"RTN","SYNDHPGEN",82,0)
 . . . s cnt=cnt+1
"RTN","SYNDHPGEN",83,0)
 . . i fieldType="D" d  ;date
"RTN","SYNDHPGEN",84,0)
 . . . s RTN(cnt)=" S "_ID_"("""_IDtitle_""","""_fieldNameCC_"FM"_""")=$G("_ID_"ARR(FNBR1,IENS1,"_field_",""I""))"
"RTN","SYNDHPGEN",85,0)
 . . . s cnt=cnt+1
"RTN","SYNDHPGEN",86,0)
 . . . s RTN(cnt)=" S "_ID_"("""_IDtitle_""","""_fieldNameCC_"HL7"_""")=$$FMTHL7^XLFDT($G("_ID_"ARR(FNBR1,IENS1,"_field_",""I"")))"
"RTN","SYNDHPGEN",87,0)
 . . . s cnt=cnt+1
"RTN","SYNDHPGEN",88,0)
 . . . s RTN(cnt)=" S "_ID_"("""_IDtitle_""","""_fieldNameCC_"FHIR"_""")=$$FMTFHIR^SYNDHPUTL($G("_ID_"ARR(FNBR1,IENS1,"_field_",""I"")))"
"RTN","SYNDHPGEN",89,0)
 . . . s cnt=cnt+1
"RTN","SYNDHPGEN",90,0)
 ; multiples
"RTN","SYNDHPGEN",91,0)
 n multName1
"RTN","SYNDHPGEN",92,0)
 n i s i=1
"RTN","SYNDHPGEN",93,0)
 f  s i=$o(FILES(i)) q:i=""  d
"RTN","SYNDHPGEN",94,0)
 . s multName1=$$camelCase^SYNDHPUTL($o(^DD(+FILES(i),0,"NM","")))
"RTN","SYNDHPGEN",95,0)
 . s RTN(cnt)=" N IENS"_i_" S IENS"_i_"="""""
"RTN","SYNDHPGEN",96,0)
 . s cnt=cnt+1
"RTN","SYNDHPGEN",97,0)
 . s RTN(cnt)=" F  S IENS"_i_"=$O("_ID_"ARR(FNBR"_i_",IENS"_i_")) QUIT:IENS"_i_"=""""  D"
"RTN","SYNDHPGEN",98,0)
 . s cnt=cnt+1
"RTN","SYNDHPGEN",99,0)
 . n fields
"RTN","SYNDHPGEN",100,0)
 . d meta^SYNDHPUTL(.fields,+FILES(i))
"RTN","SYNDHPGEN",101,0)
 . n field s field=""
"RTN","SYNDHPGEN",102,0)
 . f  s field=$o(fields(field)) quit:field=""  d
"RTN","SYNDHPGEN",103,0)
 . . s fieldNameCC=$p(fields(field),U,2)
"RTN","SYNDHPGEN",104,0)
 . . s fieldType=$p(fields(field),U,3)
"RTN","SYNDHPGEN",105,0)
 . . s RTN(cnt)=" . S "_ID_"("""_IDtitle_""","""_multName1_"s"","""_multName1_""",+IENS"_i_","""_fieldNameCC_""")=$G("_ID_"ARR(FNBR"_i_",IENS"_i_","_field_",""E""))"
"RTN","SYNDHPGEN",106,0)
 . . s cnt=cnt+1
"RTN","SYNDHPGEN",107,0)
 . . i fieldType="P" d  ;pointer
"RTN","SYNDHPGEN",108,0)
 . . . s RTN(cnt)=" . S "_ID_"("""_IDtitle_""","""_multName1_"s"","""_multName1_""",+IENS"_i_","""_fieldNameCC_"Id"_""")=$G("_ID_"ARR(FNBR"_i_",IENS"_i_","_field_",""I""))"
"RTN","SYNDHPGEN",109,0)
 . . . s cnt=cnt+1
"RTN","SYNDHPGEN",110,0)
 . . i fieldType="V" d  ;variable pointer
"RTN","SYNDHPGEN",111,0)
 . . . s RTN(cnt)=" . S "_ID_"("""_IDtitle_""","""_multName1_"s"","""_multName1_""",+IENS"_i_","""_fieldNameCC_"Id"_""")=$G("_ID_"ARR(FNBR"_i_",IENS"_i_","_field_",""I""))"
"RTN","SYNDHPGEN",112,0)
 . . . s cnt=cnt+1
"RTN","SYNDHPGEN",113,0)
 . . i fieldType="S" d  ;set of codes
"RTN","SYNDHPGEN",114,0)
 . . . s RTN(cnt)=" . S "_ID_"("""_IDtitle_""","""_multName1_"s"","""_multName1_""",+IENS"_i_","""_fieldNameCC_"Cd"_""")=$G("_ID_"ARR(FNBR"_i_",IENS"_i_","_field_",""I""))"
"RTN","SYNDHPGEN",115,0)
 . . . s cnt=cnt+1
"RTN","SYNDHPGEN",116,0)
 . . i fieldType="D" d  ;date
"RTN","SYNDHPGEN",117,0)
 . . . s RTN(cnt)=" . S "_ID_"("""_IDtitle_""","""_multName1_"s"","""_multName1_""",+IENS"_i_","""_fieldNameCC_"FM"_""")=$G("_ID_"ARR(FNBR"_i_",IENS"_i_","_field_",""I""))"
"RTN","SYNDHPGEN",118,0)
 . . . s cnt=cnt+1
"RTN","SYNDHPGEN",119,0)
 . . . s RTN(cnt)=" . S "_ID_"("""_IDtitle_""","""_multName1_"s"","""_multName1_""",+IENS"_i_","""_fieldNameCC_"HL7"_""")=$$FMTHL7^XLFDT($G("_ID_"ARR(FNBR"_i_",IENS"_i_","_field_",""I"")))"
"RTN","SYNDHPGEN",120,0)
 . . . s cnt=cnt+1
"RTN","SYNDHPGEN",121,0)
 . . . s RTN(cnt)=" . S "_ID_"("""_IDtitle_""","""_multName1_"s"","""_multName1_""",+IENS"_i_","""_fieldNameCC_"FHIR"_""")=$$FMTFHIR^SYNDHPUTL($G("_ID_"ARR(FNBR"_i_",IENS"_i_","_field_",""I"")))"
"RTN","SYNDHPGEN",122,0)
 . . . s cnt=cnt+1
"RTN","SYNDHPGEN",123,0)
 . s RTN(cnt)=" . S "_ID_"("""_IDtitle_""","""_multName1_"s"","""_multName1_""",+IENS"_i_",""resourceId"")=$$RESID^SYNDHP69(""V"",SITE)_S_FNBR1_S_"_ID_"IEN_S_FNBR"_i_"_S_+IENS"_i
"RTN","SYNDHPGEN",124,0)
 . s cnt=cnt+1
"RTN","SYNDHPGEN",125,0)
 ; tail
"RTN","SYNDHPGEN",126,0)
 s RTN(cnt)=" ;"
"RTN","SYNDHPGEN",127,0)
 s cnt=cnt+1
"RTN","SYNDHPGEN",128,0)
 s RTN(cnt)=" ;I $G(DEBUG) W ! ZWRITE "_ID
"RTN","SYNDHPGEN",129,0)
 s cnt=cnt+1
"RTN","SYNDHPGEN",130,0)
 s RTN(cnt)=" ;"
"RTN","SYNDHPGEN",131,0)
 s cnt=cnt+1
"RTN","SYNDHPGEN",132,0)
 s RTN(cnt)=" D:$G(RETJSON)=""J"" TOJASON^SYNDHPUTL(."_ID_",."_ID_"J)"
"RTN","SYNDHPGEN",133,0)
 s cnt=cnt+1
"RTN","SYNDHPGEN",134,0)
 s RTN(cnt)=" ;"
"RTN","SYNDHPGEN",135,0)
 s cnt=cnt+1
"RTN","SYNDHPGEN",136,0)
 s RTN(cnt)=" QUIT"
"RTN","SYNDHPGEN",137,0)
 s cnt=cnt+1
"RTN","SYNDHPGEN",138,0)
 s RTN(cnt)=" ;"
"RTN","SYNDHPGEN",139,0)
 ;
"RTN","SYNDHPGEN",140,0)
 ; write the code
"RTN","SYNDHPGEN",141,0)
 n os s os=+$$GETOS^SYNDHPUTL()
"RTN","SYNDHPGEN",142,0)
 n dir s dir=""
"RTN","SYNDHPGEN",143,0)
 i os=1 s dir="[temp]"
"RTN","SYNDHPGEN",144,0)
 i os=2 s dir="c:\tmp"
"RTN","SYNDHPGEN",145,0)
 i os=3 s dir="/tmp"
"RTN","SYNDHPGEN",146,0)
 i dir="" w "Could not determine OS.",! quit
"RTN","SYNDHPGEN",147,0)
 i '$$OPEN^SYNDHPUTL("outFile",dir,"genCode.txt","W") w "Could not open output file.",! quit
"RTN","SYNDHPGEN",148,0)
 n i s i=""
"RTN","SYNDHPGEN",149,0)
 f  s i=$o(RTN(i)) quit:i=""  d
"RTN","SYNDHPGEN",150,0)
 . u 0 w RTN(i),!
"RTN","SYNDHPGEN",151,0)
 . u IO w RTN(i),!
"RTN","SYNDHPGEN",152,0)
 d CLOSE^SYNDHPUTL("outFile")
"RTN","SYNDHPGEN",153,0)
 quit
"RTN","SYNDHPGEN",154,0)
 ;
"RTN","SYNDHPGEN",155,0)
 ;>>>>>>>>>>> sample code for multiples, first & second levels coded above <<<<<<<<<<<<<
"RTN","SYNDHPGEN",156,0)
 ;
"RTN","SYNDHPGEN",157,0)
 S PROBLEM("Problem","shipboardHazardDefense")=$G(PROBARR(FNBR1,IENS,1.18,"E"))
"RTN","SYNDHPGEN",158,0)
 N IENS2 S IENS2=""
"RTN","SYNDHPGEN",159,0)
 F  S IENS2=$O(PROBARR(FNBR2,IENS2)) QUIT:IENS2=""  D
"RTN","SYNDHPGEN",160,0)
 . S PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"resourceId")="V_"_SITE_S_FNBR1_S_PROBIEN_S_FNBR2_S_+IENS2
"RTN","SYNDHPGEN",161,0)
 . S PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"noteFacilityId")=$G(PROBARR(FNBR2,IENS2,.01,"I"))
"RTN","SYNDHPGEN",162,0)
 . S PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"noteFacility")=$G(PROBARR(FNBR2,IENS2,.01,"E"))
"RTN","SYNDHPGEN",163,0)
 . N IENS3 S IENS3=""
"RTN","SYNDHPGEN",164,0)
 . F  S IENS3=$O(PROBARR(FNBR3,IENS3)) QUIT:IENS3=""  D
"RTN","SYNDHPGEN",165,0)
 . . S PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"notes","note",+IENS3,"resourceId")="V_"_SITE_S_FNBR1_S_PROBIEN_S_FNBR2_S_+IENS2_S_FNBR3_S_+IENS3
"RTN","SYNDHPGEN",166,0)
 . . S PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"notes","note",+IENS3,"noteNmbr")=$G(PROBARR(FNBR3,IENS3,.01,"E"))
"RTN","SYNDHPGEN",167,0)
 . . S PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"notes","note",+IENS3,"noteNarrative")=$G(PROBARR(FNBR3,IENS3,.03,"E"))
"RTN","SYNDHPGEN",168,0)
 . . S PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"notes","note",+IENS3,"statusCd")=$G(PROBARR(FNBR3,IENS3,.04,"I"))
"RTN","SYNDHPGEN",169,0)
 . . S PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"notes","note",+IENS3,"status")=$G(PROBARR(FNBR3,IENS3,.04,"E"))
"RTN","SYNDHPGEN",170,0)
 . . S PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"notes","note",+IENS3,"dateNoteAdded")=$G(PROBARR(FNBR3,IENS3,.05,"E"))
"RTN","SYNDHPGEN",171,0)
 . . S PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"notes","note",+IENS3,"dateNoteAddedFM")=$G(PROBARR(FNBR3,IENS3,.05,"I"))
"RTN","SYNDHPGEN",172,0)
 . . S PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"notes","note",+IENS3,"dateNoteAddedHL7")=$$FMTHL7^XLFDT($G(PROBARR(FNBR3,IENS3,.05,"I")))
"RTN","SYNDHPGEN",173,0)
 . . S PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"notes","note",+IENS3,"dateNoteAddedFHIR")=$$FMTFHIR^SYNDHPUTL($G(PROBARR(FNBR3,IENS3,.05,"I")))
"RTN","SYNDHPGEN",174,0)
 . . S PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"notes","note",+IENS3,"authorId")=$G(PROBARR(FNBR3,IENS3,.06,"I"))
"RTN","SYNDHPGEN",175,0)
 . . S PROBLEM("Problem","noteFacilitys","noteFacility",+IENS2,"notes","note",+IENS3,"author")=$G(PROBARR(FNBR3,IENS3,.06,"E"))
"RTN","SYNDHPGEN",176,0)
 ;
"RTN","SYNDHPIC")
0^112^B2165360
"RTN","SYNDHPIC",1,0)
SYNDHPIC ;AFHIL DHP/fjf - HealthConcourse - get ICNs list ;03/28/2019
"RTN","SYNDHPIC",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHPIC",3,0)
 Q
"RTN","SYNDHPIC",4,0)
 ;
"RTN","SYNDHPIC",5,0)
ICNS(RETSTA,DHPCNT,DHPJSON) ; list all ICNs in a namespace
"RTN","SYNDHPIC",6,0)
 ;
"RTN","SYNDHPIC",7,0)
 ; Input: 
"RTN","SYNDHPIC",8,0)
 ;   DHPCNT  - Number of ICN's to return
"RTN","SYNDHPIC",9,0)
 ;               nn - Integer
"RTN","SYNDHPIC",10,0)
 ;               A  - all (default)
"RTN","SYNDHPIC",11,0)
 ;   DHPJSON - Return format
"RTN","SYNDHPIC",12,0)
 ;               J for JSON (default)
"RTN","SYNDHPIC",13,0)
 ;               T for plain text
"RTN","SYNDHPIC",14,0)
 ; Output:
"RTN","SYNDHPIC",15,0)
 ;   ICN's in JSON format, or
"RTN","SYNDHPIC",16,0)
 ;   ICN's in semicolon delimited text string
"RTN","SYNDHPIC",17,0)
 ; 
"RTN","SYNDHPIC",18,0)
 N ICNAR,JSICNS,ICN,N,I
"RTN","SYNDHPIC",19,0)
 S DHPCNT=$G(DHPCNT)
"RTN","SYNDHPIC",20,0)
 S DHPCNT=$S(+DHPCNT>0:DHPCNT,1:"A")
"RTN","SYNDHPIC",21,0)
 S DHPJSON=$G(DHPJSON,"J")
"RTN","SYNDHPIC",22,0)
 S ICN=""
"RTN","SYNDHPIC",23,0)
 F I=1:1 S ICN=$O(^DPT("AFICN",ICN)) Q:ICN=""  Q:DHPCNT'="A"&(I>DHPCNT)  D
"RTN","SYNDHPIC",24,0)
 .S ICNAR(ICN)=""
"RTN","SYNDHPIC",25,0)
 ;
"RTN","SYNDHPIC",26,0)
 I DHPJSON="J" D
"RTN","SYNDHPIC",27,0)
 .; put ICN array into json format
"RTN","SYNDHPIC",28,0)
 .D ENCODE^XLFJSON("ICNAR","JSICNS")
"RTN","SYNDHPIC",29,0)
 .; merge array elements into one string
"RTN","SYNDHPIC",30,0)
 .S (RETSTA,N)="" F  S N=$O(JSICNS(N)) Q:N=""  S RETSTA=RETSTA_JSICNS(N)
"RTN","SYNDHPIC",31,0)
 I DHPJSON'="J" D
"RTN","SYNDHPIC",32,0)
 .S (RETSTA,N)="" F  S N=$O(ICNAR(N)) Q:N=""  S RETSTA=RETSTA_N_";"
"RTN","SYNDHPIC",33,0)
 Q
"RTN","SYNDHPIC",34,0)
 ;
"RTN","SYNDHPIC",35,0)
TEST ; tests
"RTN","SYNDHPIC",36,0)
T1 ; count
"RTN","SYNDHPIC",37,0)
 F FT="T","J","" D
"RTN","SYNDHPIC",38,0)
 .S CT=7
"RTN","SYNDHPIC",39,0)
 .D ICNS(.ZXC,CT,FT)
"RTN","SYNDHPIC",40,0)
 .W !!!,$$ZW^SYNDHPUTL("ZXC")
"RTN","SYNDHPIC",41,0)
 Q
"RTN","SYNDHPIC",42,0)
T2 ; all
"RTN","SYNDHPIC",43,0)
 F FT="T","J","" D
"RTN","SYNDHPIC",44,0)
 .S CT="A"
"RTN","SYNDHPIC",45,0)
 .D ICNS(.ZXC,"T")
"RTN","SYNDHPIC",46,0)
 .W !!!,$$ZW^SYNDHPUTL("ZXC")
"RTN","SYNDHPIC",47,0)
 Q
"RTN","SYNDHPMAP")
0^18^B1254900
"RTN","SYNDHPMAP",1,0)
SYNDHPMAP ; AFHIL/FJF terminology mapping
"RTN","SYNDHPMAP",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNDHPMAP",3,0)
 ;;
"RTN","SYNDHPMAP",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHPMAP",5,0)
 ;
"RTN","SYNDHPMAP",6,0)
MAP(MAP,CODE,DIR) ; Return a mapped code for a given code
"RTN","SYNDHPMAP",7,0)
 ; Input:
"RTN","SYNDHPMAP",8,0)
 ; MAP - mapping to be used
"RTN","SYNDHPMAP",9,0)
 ;       currently only map implemented are "sct2icd" (5/18/2018)
"RTN","SYNDHPMAP",10,0)
 ;                                          "sct2cpt" (5/15/2018)
"RTN","SYNDHPMAP",11,0)
 ;                                          "rxn2ndf" (5/15/2018)
"RTN","SYNDHPMAP",12,0)
 ; CODE - map source code
"RTN","SYNDHPMAP",13,0)
 ; DIR - direction of mapping
"RTN","SYNDHPMAP",14,0)
 ; D for direct (default)
"RTN","SYNDHPMAP",15,0)
 ; I for inverse
"RTN","SYNDHPMAP",16,0)
 ; 
"RTN","SYNDHPMAP",17,0)
 ; Output:
"RTN","SYNDHPMAP",18,0)
 ; 1^map target code
"RTN","SYNDHPMAP",19,0)
 ; or -1^exception
"RTN","SYNDHPMAP",20,0)
 ;
"RTN","SYNDHPMAP",21,0)
 ;Q 0_"^No longer used"
"RTN","SYNDHPMAP",22,0)
 N DOI,FN,TAR
"RTN","SYNDHPMAP",23,0)
 S FN="2002.030"
"RTN","SYNDHPMAP",24,0)
 S DIR=$G(DIR,"D")
"RTN","SYNDHPMAP",25,0)
 S DOI=$S(DIR="I":"inverse",1:"direct")
"RTN","SYNDHPMAP",26,0)
 I '$D(^SYN(FN,MAP)) Q "-1^map not recognised"
"RTN","SYNDHPMAP",27,0)
 I '$D(^SYN(FN,MAP,DOI,CODE)) Q "-1^code not mapped"
"RTN","SYNDHPMAP",28,0)
 S TAR=$O(^SYN(FN,MAP,DOI,CODE,""))
"RTN","SYNDHPMAP",29,0)
 I $E(TAR,$L(TAR))="?" S TAR=$TR(TAR,"?","A")
"RTN","SYNDHPMAP",30,0)
 Q "1^"_TAR
"RTN","SYNDHPMP")
0^20^B33584325
"RTN","SYNDHPMP",1,0)
SYNDHPMP ; AFHIL/FJF - HealthConcourse - terminology mapping ;03/26/2019
"RTN","SYNDHPMP",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNDHPMP",3,0)
 ;;
"RTN","SYNDHPMP",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHPMP",5,0)
 ;
"RTN","SYNDHPMP",6,0)
MAP(MAP,CODE,DIR,IOE) ; Return a mapped code for a given code
"RTN","SYNDHPMP",7,0)
 ; 
"RTN","SYNDHPMP",8,0)
 ;--------------------------------------------------------------------
"RTN","SYNDHPMP",9,0)
 ;
"RTN","SYNDHPMP",10,0)
 ; Input:
"RTN","SYNDHPMP",11,0)
 ;   MAP - mapping to be used
"RTN","SYNDHPMP",12,0)
 ;       currently the maps implemented are "sct2icd" (5/18/2018)
"RTN","SYNDHPMP",13,0)
 ;                                          "sct2cpt" (9/07/2018)
"RTN","SYNDHPMP",14,0)
 ;                                          "sct2icdnine" (8/28/2018)
"RTN","SYNDHPMP",15,0)
 ;                                          "mh2loinc" (9/07/2018)
"RTN","SYNDHPMP",16,0)
 ;                                          "mh2sct" (9/07/2018)
"RTN","SYNDHPMP",17,0)
 ;                                          "sct2hf" (9/07/2018)
"RTN","SYNDHPMP",18,0)
 ;                                          "flag2sct" (02/01/2019)
"RTN","SYNDHPMP",19,0)
 ;                                          "sct2vit" (02/01/2019)
"RTN","SYNDHPMP",20,0)
 ;                                          "ctpos2sct (02/01/2019)
"RTN","SYNDHPMP",21,0)
 ;                                          "rxn2ndf" (02/01/2019)
"RTN","SYNDHPMP",22,0)
 ;                                          "sct2os5" (02/02/2019)
"RTN","SYNDHPMP",23,0)
 ;
"RTN","SYNDHPMP",24,0)
 ;   CODE - map source code
"RTN","SYNDHPMP",25,0)
 ;   DIR  - direction of mapping
"RTN","SYNDHPMP",26,0)
 ;       D for direct (default)
"RTN","SYNDHPMP",27,0)
 ;       I for inverse
"RTN","SYNDHPMP",28,0)
 ;   IOE  - use internal or exernal mappings
"RTN","SYNDHPMP",29,0)
 ;       I for internal SYN VistA(default)
"RTN","SYNDHPMP",30,0)
 ;       H for external Health Concourse
"RTN","SYNDHPMP",31,0)
 ; 
"RTN","SYNDHPMP",32,0)
 ; Output:
"RTN","SYNDHPMP",33,0)
 ;   1^map target code
"RTN","SYNDHPMP",34,0)
 ;   or -1^exception
"RTN","SYNDHPMP",35,0)
 ;
"RTN","SYNDHPMP",36,0)
 ; -------------------------------------------------------------------
"RTN","SYNDHPMP",37,0)
 ; 
"RTN","SYNDHPMP",38,0)
MSTART ;
"RTN","SYNDHPMP",39,0)
 ;
"RTN","SYNDHPMP",40,0)
 N MAPA,MAPJ,MAPJ8,NODE,STA,RET,DOI,TAR,URL,C,P,SUB
"RTN","SYNDHPMP",41,0)
 S U="^",C=":",P="|"
"RTN","SYNDHPMP",42,0)
 S IOE=$S($G(IOE)="":"I",1:IOE)
"RTN","SYNDHPMP",43,0)
 I "|I|H|"'[(P_IOE_P) Q -1_U_"invalid IOE parameter"
"RTN","SYNDHPMP",44,0)
 S STA=1
"RTN","SYNDHPMP",45,0)
 I IOE'="I" D  Q STA_U_TAR
"RTN","SYNDHPMP",46,0)
 .; call the terminology server
"RTN","SYNDHPMP",47,0)
 .S RET=$$GETURL^XTHC10($$TRMURL(IOE),,"MAPJ")
"RTN","SYNDHPMP",48,0)
 .; check status of web call
"RTN","SYNDHPMP",49,0)
 .I +RET'=200 S STA=-1,TAR=+RET_C_$P(RET,U,2) Q
"RTN","SYNDHPMP",50,0)
 .; check for result returned from exernal server
"RTN","SYNDHPMP",51,0)
 .; change numbers in valueString attribute to string
"RTN","SYNDHPMP",52,0)
 .D NTS("MAPJ")
"RTN","SYNDHPMP",53,0)
 .; decode the JSON into M array 
"RTN","SYNDHPMP",54,0)
 .D DECODE^XLFJSON("MAPJ","MAPA")
"RTN","SYNDHPMP",55,0)
 .I '$D(MAPA) S STA=-1,TAR="code not mapped" Q
"RTN","SYNDHPMP",56,0)
 .; convert the number_" " back to a number
"RTN","SYNDHPMP",57,0)
 .D RMS("MAPA")
"RTN","SYNDHPMP",58,0)
 .S NODE="MAPA",TAR=""
"RTN","SYNDHPMP",59,0)
 .F  S NODE=$Q(@NODE) Q:NODE=""  Q:TAR'=""  D
"RTN","SYNDHPMP",60,0)
 ..Q:$QS(NODE,5)'="name"
"RTN","SYNDHPMP",61,0)
 ..Q:@NODE'="code"
"RTN","SYNDHPMP",62,0)
 ..S TAR=MAPA($QS(NODE,1),$QS(NODE,2),$QS(NODE,3),$QS(NODE,4),"valueString")
"RTN","SYNDHPMP",63,0)
 .I TAR="" S STA=-1,TAR="code not mapped" Q
"RTN","SYNDHPMP",64,0)
 ;I IOE'="I" Q 1_U_TAR
"RTN","SYNDHPMP",65,0)
 ;
"RTN","SYNDHPMP",66,0)
 ; if we are here then the caller passed I or null in the IOE parameter
"RTN","SYNDHPMP",67,0)
 ;
"RTN","SYNDHPMP",68,0)
 N DOI,FN,TAR
"RTN","SYNDHPMP",69,0)
 S FN="2002.030"
"RTN","SYNDHPMP",70,0)
 S DIR=$G(DIR,"D")
"RTN","SYNDHPMP",71,0)
 S DOI=$S(DIR="I":"inverse",1:"direct")
"RTN","SYNDHPMP",72,0)
 I '$D(^SYN(FN,MAP)) Q "-1^code not mapped"
"RTN","SYNDHPMP",73,0)
 I '$D(^SYN(FN,MAP,DOI,CODE)) Q "-1^code not mapped"
"RTN","SYNDHPMP",74,0)
 S TAR=$O(^SYN(FN,MAP,DOI,CODE,""))
"RTN","SYNDHPMP",75,0)
 I MAP="sct2icd" S TAR=$TR(TAR,"?","A")
"RTN","SYNDHPMP",76,0)
 ;W !,"Internal"
"RTN","SYNDHPMP",77,0)
 Q 1_U_TAR
"RTN","SYNDHPMP",78,0)
 ;
"RTN","SYNDHPMP",79,0)
 ;
"RTN","SYNDHPMP",80,0)
TRMURL(EXSRV) ; create url of mapping service
"RTN","SYNDHPMP",81,0)
 ;
"RTN","SYNDHPMP",82,0)
 ; once we have url - infuse it with mapping identifier and source code
"RTN","SYNDHPMP",83,0)
 ; currently Health Concourse is only supported external server
"RTN","SYNDHPMP",84,0)
 ; for additional servers add appropriate url builder below
"RTN","SYNDHPMP",85,0)
 ; 
"RTN","SYNDHPMP",86,0)
 ; Health Concourse
"RTN","SYNDHPMP",87,0)
 I EXSRV="H" D
"RTN","SYNDHPMP",88,0)
 .S URL="https://terminology-service.dev.openplatform.healthcare/vista2/"_MAP_"?searchString="_CODE
"RTN","SYNDHPMP",89,0)
 ;
"RTN","SYNDHPMP",90,0)
 ; Wolters Kluwer
"RTN","SYNDHPMP",91,0)
 ; I EXSRV="W" D
"RTN","SYNDHPMP",92,0)
 ; .S URL="https://Wolters Kluwer terminology-service_url with MAP and CODE"
"RTN","SYNDHPMP",93,0)
 ;
"RTN","SYNDHPMP",94,0)
 Q URL
"RTN","SYNDHPMP",95,0)
 ;
"RTN","SYNDHPMP",96,0)
MAPR(SURFORM,SFTYPE,MAOR) ; map reactions (SNOMED CT)
"RTN","SYNDHPMP",97,0)
 ; map an allergic reaction surface form to an SCT code
"RTN","SYNDHPMP",98,0)
 ; Input:
"RTN","SYNDHPMP",99,0)
 ;   SURFORM - surface form
"RTN","SYNDHPMP",100,0)
 ;   TYPE    - type of surface form
"RTN","SYNDHPMP",101,0)
 ;             I - IEN
"RTN","SYNDHPMP",102,0)
 ;             T - term
"RTN","SYNDHPMP",103,0)
 ;   MAOR    - allergen or reaction
"RTN","SYNDHPMP",104,0)
 ;             A - Allergen
"RTN","SYNDHPMP",105,0)
 ;             R - Reaction
"RTN","SYNDHPMP",106,0)
 ;
"RTN","SYNDHPMP",107,0)
 I SURFORM="" Q "-1^Surface form cannot be null"
"RTN","SYNDHPMP",108,0)
 I SFTYPE'="I",SFTYPE'="T" Q "-1^Type unrecognised - should be I or T"
"RTN","SYNDHPMP",109,0)
 I MAOR'="A",MAOR'="R" Q "-1^Allergy/Reaction indicator unrecognised - should be A or R"
"RTN","SYNDHPMP",110,0)
 N RSUB,INDX
"RTN","SYNDHPMP",111,0)
 S RSUB=$S(MAOR="A":"ALLERGENS",1:"REACTIONS")
"RTN","SYNDHPMP",112,0)
 S INDX=$S(SFTYPE="I":"ICT",1:"TCI")
"RTN","SYNDHPMP",113,0)
 I '$D(^SYN("2002.010",RSUB,INDX,SURFORM)) Q "unmapped"
"RTN","SYNDHPMP",114,0)
 QUIT $O(^SYN("2002.010",RSUB,INDX,SURFORM,""))
"RTN","SYNDHPMP",115,0)
 ;
"RTN","SYNDHPMP",116,0)
 ;
"RTN","SYNDHPMP",117,0)
TEST ; tests
"RTN","SYNDHPMP",118,0)
 ;
"RTN","SYNDHPMP",119,0)
T1(code) ; SNOMED CT to ICD
"RTN","SYNDHPMP",120,0)
 ; example SNOMED CT codes 37739004,37657006
"RTN","SYNDHPMP",121,0)
 n csys,intext,dirinv
"RTN","SYNDHPMP",122,0)
 f csys="sct2icd","sct2icdnine" d
"RTN","SYNDHPMP",123,0)
 .f intext="I","H" d
"RTN","SYNDHPMP",124,0)
 ..f dirinv="D" d
"RTN","SYNDHPMP",125,0)
 ...w !,csys," code ",code," ",$s(intext="I":"Internal",1:"External")
"RTN","SYNDHPMP",126,0)
 ...w !,$$MAP(csys,code,dirinv,intext)
"RTN","SYNDHPMP",127,0)
 Q
"RTN","SYNDHPMP",128,0)
 ;
"RTN","SYNDHPMP",129,0)
T2(code) ; mental health to SNOMED CT
"RTN","SYNDHPMP",130,0)
 ; example mental health codes PHQ-2,PHQ9,2
"RTN","SYNDHPMP",131,0)
 n csys,intext,dirinv
"RTN","SYNDHPMP",132,0)
 f csys="mh2sct" d
"RTN","SYNDHPMP",133,0)
 .f intext="I","H" d
"RTN","SYNDHPMP",134,0)
 ..f dirinv="D" d
"RTN","SYNDHPMP",135,0)
 ...w !,csys," code ",code," ",$s(intext="I":"Internal",1:"External")
"RTN","SYNDHPMP",136,0)
 ...w !,$$MAP(csys,code,dirinv,intext)
"RTN","SYNDHPMP",137,0)
 Q
"RTN","SYNDHPMP",138,0)
T3 ; new server (vista2) tests
"RTN","SYNDHPMP",139,0)
 ;
"RTN","SYNDHPMP",140,0)
T3V ;
"RTN","SYNDHPMP",141,0)
 K
"RTN","SYNDHPMP",142,0)
 ; sct2icd vista
"RTN","SYNDHPMP",143,0)
 S URLSV="https://terminology-service.dev.openplatform.healthcare/vista/sct2icd?searchString=37739004"
"RTN","SYNDHPMP",144,0)
 S RET=$$GETURL^XTHC10(URLSV,,"MAPSV")
"RTN","SYNDHPMP",145,0)
 D DECODE^XLFJSON("MAPSV","MAPSVO")
"RTN","SYNDHPMP",146,0)
 ; mh2sct vista
"RTN","SYNDHPMP",147,0)
 S URLMV="https://terminology-service.dev.openplatform.healthcare/vista/mh2sct?searchString=PHQ-2"
"RTN","SYNDHPMP",148,0)
 S RET=$$GETURL^XTHC10(URLMV,,"MAPMV") 
"RTN","SYNDHPMP",149,0)
 D DECODE^XLFJSON("MAPMV","MAPMVO")
"RTN","SYNDHPMP",150,0)
 ;
"RTN","SYNDHPMP",151,0)
 W !,URLSV,!!
"RTN","SYNDHPMP",152,0)
 ZW MAPSVO
"RTN","SYNDHPMP",153,0)
 w !!,URLMV,!!
"RTN","SYNDHPMP",154,0)
 ZW MAPMVO
"RTN","SYNDHPMP",155,0)
 ;
"RTN","SYNDHPMP",156,0)
 Q
"RTN","SYNDHPMP",157,0)
 ;
"RTN","SYNDHPMP",158,0)
T4V ;
"RTN","SYNDHPMP",159,0)
 K
"RTN","SYNDHPMP",160,0)
 ; sct2icd vista2
"RTN","SYNDHPMP",161,0)
 S URLSV="https://terminology-service.dev.openplatform.healthcare/vista2/sct2icd?searchString=37739004"
"RTN","SYNDHPMP",162,0)
 S RET=$$GETURL^XTHC10(URLSV,,"MAPSV")
"RTN","SYNDHPMP",163,0)
 ; now scan json in MPASV to find string that look like numbers
"RTN","SYNDHPMP",164,0)
 ; and convert them to strings by concateneating space
"RTN","SYNDHPMP",165,0)
 D NTS("MAPSV")
"RTN","SYNDHPMP",166,0)
 ; 
"RTN","SYNDHPMP",167,0)
 D DECODE^XLFJSON("MAPSV","MAPSVO")
"RTN","SYNDHPMP",168,0)
 ; now that json decodon complete remove space
"RTN","SYNDHPMP",169,0)
 ;D RMS("MAPSVO")
"RTN","SYNDHPMP",170,0)
 ; mh2sct vista
"RTN","SYNDHPMP",171,0)
 S URLMV="https://terminology-service.dev.openplatform.healthcare/vista2/mh2sct?searchString=PHQ-2"
"RTN","SYNDHPMP",172,0)
 S RET=$$GETURL^XTHC10(URLMV,,"MAPMV")
"RTN","SYNDHPMP",173,0)
 ; now scan json in MPAMV to find string that look like numbers
"RTN","SYNDHPMP",174,0)
 ; and convert them to strings by concateneating space
"RTN","SYNDHPMP",175,0)
 D NTS("MAPMV")
"RTN","SYNDHPMP",176,0)
 ;
"RTN","SYNDHPMP",177,0)
 D DECODE^XLFJSON("MAPMV","MAPMVO")
"RTN","SYNDHPMP",178,0)
 ;
"RTN","SYNDHPMP",179,0)
 W !,URLSV,!!
"RTN","SYNDHPMP",180,0)
 ZW MAPSVO
"RTN","SYNDHPMP",181,0)
 w !!,URLMV,!!
"RTN","SYNDHPMP",182,0)
 ZW MAPMVO
"RTN","SYNDHPMP",183,0)
 ;
"RTN","SYNDHPMP",184,0)
 Q
"RTN","SYNDHPMP",185,0)
NTS(JSONA) ; change numbers to string to accommodate XTHC10 quirk
"RTN","SYNDHPMP",186,0)
 ;
"RTN","SYNDHPMP",187,0)
 N N,VALUE
"RTN","SYNDHPMP",188,0)
 S N=JSONA
"RTN","SYNDHPMP",189,0)
 F  S N=$Q(@N) Q:N=""  D
"RTN","SYNDHPMP",190,0)
 .Q:@N'["valueString"
"RTN","SYNDHPMP",191,0)
 .S VALUE=$P($P(@N,":",2),"""",2)
"RTN","SYNDHPMP",192,0)
 .Q:VALUE'?1N.N
"RTN","SYNDHPMP",193,0)
 .S VALUE=VALUE_" "
"RTN","SYNDHPMP",194,0)
 .S $P(@N,"""",4)=VALUE
"RTN","SYNDHPMP",195,0)
 Q
"RTN","SYNDHPMP",196,0)
RMS(JSONA) ; convert numeric string to a number
"RTN","SYNDHPMP",197,0)
 ;
"RTN","SYNDHPMP",198,0)
 N N,VALUE
"RTN","SYNDHPMP",199,0)
 S N=JSONA
"RTN","SYNDHPMP",200,0)
 F  S N=$Q(@N) Q:N=""  D
"RTN","SYNDHPMP",201,0)
 .Q:N'["valueString"
"RTN","SYNDHPMP",202,0)
 .S VALUE=@N
"RTN","SYNDHPMP",203,0)
 .Q:VALUE'?1N.N1" "
"RTN","SYNDHPMP",204,0)
 .S VALUE=+VALUE
"RTN","SYNDHPMP",205,0)
 .S @N=VALUE
"RTN","SYNDHPMP",206,0)
 Q
"RTN","SYNDHPMP",207,0)
 
"RTN","SYNDHPMU")
0^73^B9921526
"RTN","SYNDHPMU",1,0)
SYNDHPMU ;
"RTN","SYNDHPMU",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHPMU",3,0)
 ;
"RTN","SYNDHPMU",4,0)
 ; mapping utilities
"RTN","SYNDHPMU",5,0)
charchk(x,char) ; check file x for character char
"RTN","SYNDHPMU",6,0)
 ; x     VistA file name
"RTN","SYNDHPMU",7,0)
 ; char  character to check for
"RTN","SYNDHPMU",8,0)
 d init
"RTN","SYNDHPMU",9,0)
 i $e(f)'=U s f=U_x
"RTN","SYNDHPMU",10,0)
 f  s f=$q(@f) q:f=""  i @f[char w !,f
"RTN","SYNDHPMU",11,0)
 q
"RTN","SYNDHPMU",12,0)
 ;
"RTN","SYNDHPMU",13,0)
convert(x,from,to) ; in file x convert char from to char to
"RTN","SYNDHPMU",14,0)
 d init
"RTN","SYNDHPMU",15,0)
 i $e(f)'=U s f=U_x
"RTN","SYNDHPMU",16,0)
 f  s f=$q(@f) q:f=""  i $g(@f)[from s @f=$tr(@f,from,to)
"RTN","SYNDHPMU",17,0)
 q
"RTN","SYNDHPMU",18,0)
 ; 
"RTN","SYNDHPMU",19,0)
init ;
"RTN","SYNDHPMU",20,0)
 s U="^",tab=$c(9)
"RTN","SYNDHPMU",21,0)
 q
"RTN","SYNDHPMU",22,0)
 ;
"RTN","SYNDHPMU",23,0)
hier ; build is-a hiererchy from SNOMED CT 
"RTN","SYNDHPMU",24,0)
 ; sct2_StatedRelationship_Full_US1000124_20180901.txt file
"RTN","SYNDHPMU",25,0)
 ;
"RTN","SYNDHPMU",26,0)
 d init
"RTN","SYNDHPMU",27,0)
 s isa=116680003 ; SNOMED CT is-a relationship concept ID
"RTN","SYNDHPMU",28,0)
 ;
"RTN","SYNDHPMU",29,0)
 s hierf=$na(^SYN(2002.047,"sct"))
"RTN","SYNDHPMU",30,0)
 s hd=$na(^zzffhier)
"RTN","SYNDHPMU",31,0)
 s n=0 f  s n=$o(@hd@(n)) q:+n=0  d
"RTN","SYNDHPMU",32,0)
 .s t=@hd@(n)
"RTN","SYNDHPMU",33,0)
 .q:$p(t,U,8)'=isa
"RTN","SYNDHPMU",34,0)
 .s par=$p(t,U,6)
"RTN","SYNDHPMU",35,0)
 .s chd=$p(t,U,5)
"RTN","SYNDHPMU",36,0)
 .s @hierf@("pc",par,chd)=""
"RTN","SYNDHPMU",37,0)
 .s @hierf@("cp",chd,par)=""
"RTN","SYNDHPMU",38,0)
 q
"RTN","SYNDHPMU",39,0)
 ;
"RTN","SYNDHPMU",40,0)
 ;
"RTN","SYNDHPMU",41,0)
 ;
"RTN","SYNDHPMU",42,0)
mapdesc ; add descendants of SNOMED CT code to "sct2icdnine" map
"RTN","SYNDHPMU",43,0)
 ;
"RTN","SYNDHPMU",44,0)
 ; scan down sct2icdnine map for sct codes
"RTN","SYNDHPMU",45,0)
 s map="sct2icdnine"
"RTN","SYNDHPMU",46,0)
 k ^tmp(map)
"RTN","SYNDHPMU",47,0)
 k ^tmp("validate")
"RTN","SYNDHPMU",48,0)
 s f=$na(^SYN("2002.030",map,"direct"))
"RTN","SYNDHPMU",49,0)
 s src=""
"RTN","SYNDHPMU",50,0)
 f  s src=$o(@f@(src)) q:src=""  d
"RTN","SYNDHPMU",51,0)
 .;w !,src r *rr
"RTN","SYNDHPMU",52,0)
 .;b:src=127009
"RTN","SYNDHPMU",53,0)
 .s tar=$o(@f@(src,""))
"RTN","SYNDHPMU",54,0)
 .;b:tar=127009
"RTN","SYNDHPMU",55,0)
 .s excsb1=$o(@f@(src,tar,""))
"RTN","SYNDHPMU",56,0)
 .k descs
"RTN","SYNDHPMU",57,0)
 .;d desc(src,"descs")
"RTN","SYNDHPMU",58,0)
 .d getdes(src,"descs")
"RTN","SYNDHPMU",59,0)
 .i '$d(descs) q
"RTN","SYNDHPMU",60,0)
 .;zw descs r *r
"RTN","SYNDHPMU",61,0)
 .m ^tmp("validate",src)=descs
"RTN","SYNDHPMU",62,0)
 .s desct=""
"RTN","SYNDHPMU",63,0)
 .f  s desct=$o(descs(desct)) q:desct=""  d
"RTN","SYNDHPMU",64,0)
 ..;b:desct=127009
"RTN","SYNDHPMU",65,0)
 ..;i $d(^tmp(map,"direct",desct)) q
"RTN","SYNDHPMU",66,0)
 ..s ^tmp(map,"direct",desct,tar,excsb1)=""
"RTN","SYNDHPMU",67,0)
 ;
"RTN","SYNDHPMU",68,0)
 ; merge additional maps into sct2icdnine map
"RTN","SYNDHPMU",69,0)
 m ^SYN("2002.030",map)=^tmp(map) 
"RTN","SYNDHPMU",70,0)
 q
"RTN","SYNDHPMU",71,0)
 ;
"RTN","SYNDHPMU",72,0)
 ;
"RTN","SYNDHPMU",73,0)
getdes(sct,outa) ;
"RTN","SYNDHPMU",74,0)
 ;
"RTN","SYNDHPMU",75,0)
 s m=$na(^SYN(2002.047,"sct","pc"))
"RTN","SYNDHPMU",76,0)
 ;
"RTN","SYNDHPMU",77,0)
 k res
"RTN","SYNDHPMU",78,0)
 ;
"RTN","SYNDHPMU",79,0)
 d next(sct)
"RTN","SYNDHPMU",80,0)
 ;
"RTN","SYNDHPMU",81,0)
 ;zw res
"RTN","SYNDHPMU",82,0)
 ;
"RTN","SYNDHPMU",83,0)
 s x="" f  s x=$o(res(x)) q:x=""  d next(x)
"RTN","SYNDHPMU",84,0)
 ;
"RTN","SYNDHPMU",85,0)
 m @outa=res
"RTN","SYNDHPMU",86,0)
 q
"RTN","SYNDHPMU",87,0)
 ;
"RTN","SYNDHPMU",88,0)
 ;s tar="" f  s tar=$o(res(tar)) q:tar=""  d
"RTN","SYNDHPMU",89,0)
 ;.w !,"=",tar
"RTN","SYNDHPMU",90,0)
 ;.s ^tmp(map,"direct",sct,tar,$i(^tmp(map,"direct",sct,tar)))=""
"RTN","SYNDHPMU",91,0)
 q
"RTN","SYNDHPMU",92,0)
next(s) ;
"RTN","SYNDHPMU",93,0)
 q:$o(@m@(s,""))=""
"RTN","SYNDHPMU",94,0)
 s next=""
"RTN","SYNDHPMU",95,0)
 f  s next=$o(@m@(s,next)) q:next=""  d
"RTN","SYNDHPMU",96,0)
 .s res(next)=""
"RTN","SYNDHPMU",97,0)
 q
"RTN","SYNDHPMU",98,0)
 ;
"RTN","SYNDHPMU",99,0)
xdesc(sct,desc) ; find descendants of SNOMED CT code sct
"RTN","SYNDHPMU",100,0)
 ;
"RTN","SYNDHPMU",101,0)
 ; sct  -  parent concept SCT ID
"RTN","SYNDHPMU",102,0)
 ; desc -  output array
"RTN","SYNDHPMU",103,0)
 ;
"RTN","SYNDHPMU",104,0)
 n chld,res
"RTN","SYNDHPMU",105,0)
 k res 
"RTN","SYNDHPMU",106,0)
 s res(sct)=""
"RTN","SYNDHPMU",107,0)
 s chld=""
"RTN","SYNDHPMU",108,0)
 f  s chld=$o(res(chld)) q:chld=""  d
"RTN","SYNDHPMU",109,0)
 .d des1(chld)
"RTN","SYNDHPMU",110,0)
 k res(sct)
"RTN","SYNDHPMU",111,0)
 m @desc=res
"RTN","SYNDHPMU",112,0)
 q
"RTN","SYNDHPMU",113,0)
 ;
"RTN","SYNDHPMU",114,0)
des1(par) ;
"RTN","SYNDHPMU",115,0)
 ; par  -  a parent concept SCT ID
"RTN","SYNDHPMU",116,0)
 n chld
"RTN","SYNDHPMU",117,0)
 s chld=""
"RTN","SYNDHPMU",118,0)
 f  s chld=$o(^SYN(2002.047,"sct","pc",par,chld)) q:chld=""  d
"RTN","SYNDHPMU",119,0)
 .s res(chld)=""
"RTN","SYNDHPMU",120,0)
 q
"RTN","SYNDHPMU",121,0)
 ;
"RTN","SYNDHPMU",122,0)
recov ;
"RTN","SYNDHPMU",123,0)
 k ^SYN("2002.030","sct2icdnine","direct")
"RTN","SYNDHPMU",124,0)
 m ^SYN("2002.030","sct2icdnine","direct")=^SYN("2002.030","zbksc2icdnine","direct")
"RTN","SYNDHPMU",125,0)
 q
"RTN","SYNDHPPOS")
0^21^B1340966
"RTN","SYNDHPPOS",1,0)
SYNDHPPOS ; General utility
"RTN","SYNDHPPOS",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHPPOS",3,0)
 ;
"RTN","SYNDHPPOS",4,0)
 ; DHP post install
"RTN","SYNDHPPOS",5,0)
DHPCON ; Add DHP connector proxy user to file 200
"RTN","SYNDHPPOS",6,0)
 q
"RTN","SYNDHPPOS",7,0)
PATTADDR ; generate some patient addresses
"RTN","SYNDHPPOS",8,0)
 ;
"RTN","SYNDHPPOS",9,0)
 S N=0 F  S N=$O(^DPT(N)) Q:+N=0  D
"RTN","SYNDHPPOS",10,0)
 .;I $$GET1^DIQ(2,N_",",.111)="",$$GET1^DIQ(2,N_",",.114)="" W !,$G(^DPT(N,.11)) D
"RTN","SYNDHPPOS",11,0)
 .I $$GET1^DIQ(2,N_",",.111)="" W !,$G(^DPT(N,.11)) D
"RTN","SYNDHPPOS",12,0)
 ..S City=^ZZADDR("CITY",$R(33)+1)
"RTN","SYNDHPPOS",13,0)
 ..S Street=^ZZADDR("STREET",$R(50)+1)
"RTN","SYNDHPPOS",14,0)
 ..S Num=$R(11000)+1
"RTN","SYNDHPPOS",15,0)
 ..;W !,Num,"   ",Street,"   ",City
"RTN","SYNDHPPOS",16,0)
 ..S STIEN=$$STATE($R(56)+1)
"RTN","SYNDHPPOS",17,0)
 ..;W " ",$$GET1^DIQ(5,STIEN_",",.01)
"RTN","SYNDHPPOS",18,0)
 ..S ZIP=$E(100000+$R(90000),2,6)
"RTN","SYNDHPPOS",19,0)
 ..K FDA
"RTN","SYNDHPPOS",20,0)
 ..S FDA(2,N_",",.111)=Num_" "_Street
"RTN","SYNDHPPOS",21,0)
 ..;S FDA(2,N_",",.114)=City
"RTN","SYNDHPPOS",22,0)
 ..;S FDA(2,N_",",.115)=STIEN
"RTN","SYNDHPPOS",23,0)
 ..;S FDA(2,N_",",.116)=ZIP
"RTN","SYNDHPPOS",24,0)
 ..D FILE^DIE(,"FDA")
"RTN","SYNDHPPOS",25,0)
 Q
"RTN","SYNDHPPOS",26,0)
STATE(NO) ;
"RTN","SYNDHPPOS",27,0)
 I $$GET1^DIQ(5,NO_",",.001)="" Q $$STATE($R(56)+1)
"RTN","SYNDHPPOS",28,0)
 Q NO
"RTN","SYNDHPPRV")
0^22^B335368
"RTN","SYNDHPPRV",1,0)
SYNDHPPRV ; Set up provider NPI in file 200
"RTN","SYNDHPPRV",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHPPRV",3,0)
 ;
"RTN","SYNDHPPRV",4,0)
 ;
"RTN","SYNDHPPRV",5,0)
CTRL ;
"RTN","SYNDHPPRV",6,0)
 S FN=200,N=0,NPI=999000000
"RTN","SYNDHPPRV",7,0)
 F  S N=$O(^VA(FN,N)) Q:+N=0  D
"RTN","SYNDHPPRV",8,0)
 .Q:$$GET1^DIQ(FN,N_",","NPI")'=""
"RTN","SYNDHPPRV",9,0)
 .S NPI=$I(NPI)
"RTN","SYNDHPPRV",10,0)
 .S NPIWCD=NPI_$$CKDIGIT^XUSNPI(NPI)
"RTN","SYNDHPPRV",11,0)
 .N FDA
"RTN","SYNDHPPRV",12,0)
 .S FDA(FN,N_",","NPI")=NPIWCD
"RTN","SYNDHPPRV",13,0)
 .D FILE^DIE("","FDA")
"RTN","SYNDHPPRV",14,0)
 .W !,N,"   -   ",NPIWCD
"RTN","SYNDHPPRV",15,0)
 Q
"RTN","SYNDHPTS1")
0^114^B11127832
"RTN","SYNDHPTS1",1,0)
SYNDHPTS1 ;AFHIL DHP/fjf/art - HealthConcourse - DHP REST handlers ;12/04/2018
"RTN","SYNDHPTS1",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHPTS1",3,0)
 ;
"RTN","SYNDHPTS1",4,0)
 ;
"RTN","SYNDHPTS1",5,0)
CTRL ;
"RTN","SYNDHPTS1",6,0)
 ;
"RTN","SYNDHPTS1",7,0)
 D GTCALLS
"RTN","SYNDHPTS1",8,0)
 S DHPFRDAT=18401231
"RTN","SYNDHPTS1",9,0)
 S DHPTODAT=20501231
"RTN","SYNDHPTS1",10,0)
 S DHPJSON=""
"RTN","SYNDHPTS1",11,0)
 S DHPICN="" F  S DHPICN=$O(^DPT("AFICN",DHPICN)) Q:DHPICN=""  D
"RTN","SYNDHPTS1",12,0)
 .;W !,DHPICN Q
"RTN","SYNDHPTS1",13,0)
 .;D PATLABI
"RTN","SYNDHPTS1",14,0)
 .;I RETSTA["2000-8" W !!!!!! ZW RETSTA
"RTN","SYNDHPTS1",15,0)
 .;Q
"RTN","SYNDHPTS1",16,0)
 .S CALL=""
"RTN","SYNDHPTS1",17,0)
 .F  S CALL=$O(CALLS(CALL)) Q:CALL=""  D
"RTN","SYNDHPTS1",18,0)
 ..;W !,"Before ",$G(CALL),! ;R *R
"RTN","SYNDHPTS1",19,0)
 ..;ZW  ;R !,ZZXC
"RTN","SYNDHPTS1",20,0)
 ..;W !!,"Still before",! ;R *R
"RTN","SYNDHPTS1",21,0)
 ..K RETSTA
"RTN","SYNDHPTS1",22,0)
 ..D @CALL
"RTN","SYNDHPTS1",23,0)
 ..W !!!! ZW RETSTA
"RTN","SYNDHPTS1",24,0)
 Q
"RTN","SYNDHPTS1",25,0)
GTCALLS ; set up call list
"RTN","SYNDHPTS1",26,0)
 F I=1:1 Q:$T(+I)=""  D
"RTN","SYNDHPTS1",27,0)
 .S LOC=$T(+I)
"RTN","SYNDHPTS1",28,0)
 .I $P(LOC," ")'="",$E(LOC,1,3)="PAT" S CALLS($P(LOC," "))=""
"RTN","SYNDHPTS1",29,0)
 Q
"RTN","SYNDHPTS1",30,0)
 ;
"RTN","SYNDHPTS1",31,0)
PATDEMI ; get patient demographics for one patient
"RTN","SYNDHPTS1",32,0)
 ;
"RTN","SYNDHPTS1",33,0)
 D PATDEMI^SYNDHP47(.RETSTA,DHPICN,DHPJSON)
"RTN","SYNDHPTS1",34,0)
 Q
"RTN","SYNDHPTS1",35,0)
 ;
"RTN","SYNDHPTS1",36,0)
PATCONI ; get patient conditions for one patient by ICN
"RTN","SYNDHPTS1",37,0)
 ;
"RTN","SYNDHPTS1",38,0)
 D PATCONI^SYNDHP03(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
"RTN","SYNDHPTS1",39,0)
 Q
"RTN","SYNDHPTS1",40,0)
 ;
"RTN","SYNDHPTS1",41,0)
 ;
"RTN","SYNDHPTS1",42,0)
PATENCI ; get patient encounters for one patient by ICN
"RTN","SYNDHPTS1",43,0)
 ;
"RTN","SYNDHPTS1",44,0)
 D PATENCI^SYNDHP40(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
"RTN","SYNDHPTS1",45,0)
 Q
"RTN","SYNDHPTS1",46,0)
 ;  
"RTN","SYNDHPTS1",47,0)
 ; --------------------------------------------------
"RTN","SYNDHPTS1",48,0)
 ;
"RTN","SYNDHPTS1",49,0)
PATMEDS ; get patient medication statement for one patient by ICN
"RTN","SYNDHPTS1",50,0)
 ;
"RTN","SYNDHPTS1",51,0)
 D PATMEDS^SYNDHP48(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
"RTN","SYNDHPTS1",52,0)
 Q
"RTN","SYNDHPTS1",53,0)
 ;
"RTN","SYNDHPTS1",54,0)
PATMEDA ; get patient medication administration for one patient by ICN
"RTN","SYNDHPTS1",55,0)
 ;
"RTN","SYNDHPTS1",56,0)
 D PATMEDA^SYNDHP48(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
"RTN","SYNDHPTS1",57,0)
 Q
"RTN","SYNDHPTS1",58,0)
 ;
"RTN","SYNDHPTS1",59,0)
PATMEDD ; get patient medication dispense for one patient by ICN
"RTN","SYNDHPTS1",60,0)
 ;
"RTN","SYNDHPTS1",61,0)
 D PATMEDD^SYNDHP48(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
"RTN","SYNDHPTS1",62,0)
 Q
"RTN","SYNDHPTS1",63,0)
 ;
"RTN","SYNDHPTS1",64,0)
PATVITI ; get patient vitals for one patient by ICN
"RTN","SYNDHPTS1",65,0)
 ;
"RTN","SYNDHPTS1",66,0)
 D PATVITI^SYNDHP01(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
"RTN","SYNDHPTS1",67,0)
 Q
"RTN","SYNDHPTS1",68,0)
 ;
"RTN","SYNDHPTS1",69,0)
PATHLFI ; get patient health factors for one patient
"RTN","SYNDHPTS1",70,0)
 ;
"RTN","SYNDHPTS1",71,0)
 D PATHLFI^SYNDHP09(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
"RTN","SYNDHPTS1",72,0)
 Q
"RTN","SYNDHPTS1",73,0)
 ;
"RTN","SYNDHPTS1",74,0)
PATPRCI ; get patient procedures for one patient
"RTN","SYNDHPTS1",75,0)
 ;
"RTN","SYNDHPTS1",76,0)
 D PATPRCI^SYNDHP04(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
"RTN","SYNDHPTS1",77,0)
 Q
"RTN","SYNDHPTS1",78,0)
 ;
"RTN","SYNDHPTS1",79,0)
PATALLI ; get patient allergies for one patient by ICN
"RTN","SYNDHPTS1",80,0)
 ;
"RTN","SYNDHPTS1",81,0)
 D PATALLI^SYNDHP57(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
"RTN","SYNDHPTS1",82,0)
 Q
"RTN","SYNDHPTS1",83,0)
 ;
"RTN","SYNDHPTS1",84,0)
 ;
"RTN","SYNDHPTS1",85,0)
PATDXREP ; get patient diagnostic report for one patient by ICN
"RTN","SYNDHPTS1",86,0)
 ;
"RTN","SYNDHPTS1",87,0)
 D PATDXRI^SYNDHP05(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
"RTN","SYNDHPTS1",88,0)
 Q
"RTN","SYNDHPTS1",89,0)
 ;
"RTN","SYNDHPTS1",90,0)
PATLABI ; get patient labs for one patient
"RTN","SYNDHPTS1",91,0)
 ;
"RTN","SYNDHPTS1",92,0)
 D PATLABI^SYNDHP53(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
"RTN","SYNDHPTS1",93,0)
 Q
"RTN","SYNDHPTS1",94,0)
 ;
"RTN","SYNDHPTS1",95,0)
PATPRVI ; get patient encounter providers for one patient
"RTN","SYNDHPTS1",96,0)
 ;
"RTN","SYNDHPTS1",97,0)
 D PATPRVI^SYNDHP54(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
"RTN","SYNDHPTS1",98,0)
 Q
"RTN","SYNDHPTS1",99,0)
 ;
"RTN","SYNDHPTS1",100,0)
PATAPTI ; get patient appointments for one patient
"RTN","SYNDHPTS1",101,0)
 ;
"RTN","SYNDHPTS1",102,0)
 D PATAPTI^SYNDHP41(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
"RTN","SYNDHPTS1",103,0)
 Q
"RTN","SYNDHPTS1",104,0)
 ;
"RTN","SYNDHPTS1",105,0)
PATFLGI ; get patient flags for one patient
"RTN","SYNDHPTS1",106,0)
 ;
"RTN","SYNDHPTS1",107,0)
 D PATFLGI^SYNDHP08(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
"RTN","SYNDHPTS1",108,0)
 Q
"RTN","SYNDHPTS1",109,0)
 ;
"RTN","SYNDHPTS1",110,0)
PATIMMI ; get patient immunizations for one patient
"RTN","SYNDHPTS1",111,0)
 ;
"RTN","SYNDHPTS1",112,0)
 D PATIMMI^SYNDHP02(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
"RTN","SYNDHPTS1",113,0)
 Q
"RTN","SYNDHPTS1",114,0)
 ;
"RTN","SYNDHPTS1",115,0)
PATGOLI ; get patient goals for one patient
"RTN","SYNDHPTS1",116,0)
 ;
"RTN","SYNDHPTS1",117,0)
 D PATGOLI^SYNDHP07(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
"RTN","SYNDHPTS1",118,0)
 Q
"RTN","SYNDHPTS1",119,0)
 ;
"RTN","SYNDHPTS1",120,0)
PATOBSI ; get patient observations for one patient
"RTN","SYNDHPTS1",121,0)
 ;
"RTN","SYNDHPTS1",122,0)
 D PATOBSI^SYNDHP56(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
"RTN","SYNDHPTS1",123,0)
 Q
"RTN","SYNDHPTS1",124,0)
 ;
"RTN","SYNDHPTS1",125,0)
PATCPALLI ; get all care plans for a patient
"RTN","SYNDHPTS1",126,0)
 ;
"RTN","SYNDHPTS1",127,0)
 D PATCPALLI^SYNDHP59(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT,DHPJSON)
"RTN","SYNDHPTS1",128,0)
 Q
"RTN","SYNDHPTS1",129,0)
 ;
"RTN","SYNDHPTS1",130,0)
PATCPI ; get one care plan for a patient
"RTN","SYNDHPTS1",131,0)
 ;
"RTN","SYNDHPTS1",132,0)
 ; need DHPVRESID for this call
"RTN","SYNDHPTS1",133,0)
 ;D PATCPI^SYNDHP59(.RETSTA,DHPICN,DHPVRESID,DHPJSON)
"RTN","SYNDHPTS1",134,0)
 Q
"RTN","SYNDHPTS1",135,0)
PATTIUI ; get patient notes for one patient by ICN
"RTN","SYNDHPTS1",136,0)
 ;
"RTN","SYNDHPTS1",137,0)
 D PATTIUI^SYNDHP67(.RETSTA,DHPICN,DHPFRDAT,DHPTODAT)
"RTN","SYNDHPTS1",138,0)
 Q
"RTN","SYNDHPTS1",139,0)
 ;
"RTN","SYNDHPUTL")
0^74^B31232465
"RTN","SYNDHPUTL",1,0)
SYNDHPUTL ; HC/art - HealthConcourse - various utilities ;04/08/2019
"RTN","SYNDHPUTL",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDHPUTL",3,0)
 ;;
"RTN","SYNDHPUTL",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNDHPUTL",5,0)
 ;
"RTN","SYNDHPUTL",6,0)
 QUIT
"RTN","SYNDHPUTL",7,0)
 ;
"RTN","SYNDHPUTL",8,0)
TOJASON(ARRAY,JSONSTR) ;convert input array to JSON string
"RTN","SYNDHPUTL",9,0)
 ;input:  ARRAY - input array
"RTN","SYNDHPUTL",10,0)
 ;output: JSONSTR - JSON string
"RTN","SYNDHPUTL",11,0)
 ;
"RTN","SYNDHPUTL",12,0)
 N ERR,TMP
"RTN","SYNDHPUTL",13,0)
 D ENCODE^XLFJSON("ARRAY","TMP","ERR")
"RTN","SYNDHPUTL",14,0)
 ;I $G(DEBUG),$D(ERR) W !,">>ERROR<<" ZWRITE ERR
"RTN","SYNDHPUTL",15,0)
 ;I $G(DEBUG) W ! ZWRITE TMP
"RTN","SYNDHPUTL",16,0)
 ;
"RTN","SYNDHPUTL",17,0)
 S JSONSTR=""
"RTN","SYNDHPUTL",18,0)
 N IDX S IDX=""
"RTN","SYNDHPUTL",19,0)
 F  S IDX=$O(TMP(IDX)) QUIT:IDX=""  D
"RTN","SYNDHPUTL",20,0)
 . S JSONSTR=JSONSTR_$G(TMP(IDX))
"RTN","SYNDHPUTL",21,0)
 ;I $G(DEBUG) W ! ZWRITE JSONSTR
"RTN","SYNDHPUTL",22,0)
 ;
"RTN","SYNDHPUTL",23,0)
 QUIT
"RTN","SYNDHPUTL",24,0)
 ;
"RTN","SYNDHPUTL",25,0)
TOFHIR(ARRAY,FHIRARRAY) ;create FHIR tagged array from input array
"RTN","SYNDHPUTL",26,0)
 ;input:  ARRAY - input array
"RTN","SYNDHPUTL",27,0)
 ;output: FHIRARRAY - FHIR array
"RTN","SYNDHPUTL",28,0)
 ;
"RTN","SYNDHPUTL",29,0)
 ;
"RTN","SYNDHPUTL",30,0)
 QUIT
"RTN","SYNDHPUTL",31,0)
 ;
"RTN","SYNDHPUTL",32,0)
meta(fields,fileNbr) ;return field metadata
"RTN","SYNDHPUTL",33,0)
 ;input: fileNbr - file number
"RTN","SYNDHPUTL",34,0)
 ;output: fields - return array
"RTN","SYNDHPUTL",35,0)
 ;        fields(fieldNbr)=fieldName^fieldNameCC^fieldType^fieldValueSet^pointsTo
"RTN","SYNDHPUTL",36,0)
 ;
"RTN","SYNDHPUTL",37,0)
 n node0,fieldName,fieldNameCC,fieldType,fieldValueSet,pointsTo
"RTN","SYNDHPUTL",38,0)
 n fieldNbr s fieldNbr=0
"RTN","SYNDHPUTL",39,0)
 f  s fieldNbr=$o(^DD(fileNbr,fieldNbr)) quit:'+fieldNbr  d
"RTN","SYNDHPUTL",40,0)
 . s node0=^DD(fileNbr,fieldNbr,0)
"RTN","SYNDHPUTL",41,0)
 . s fieldName=$p(node0,U,1)
"RTN","SYNDHPUTL",42,0)
 . s fieldNameCC=$$camelCase(fieldName)
"RTN","SYNDHPUTL",43,0)
 . s fieldType=$p(node0,U,2)
"RTN","SYNDHPUTL",44,0)
 . s fieldType=$s(+fieldType:"M",fieldType["P":"P",fieldType["F":"F",fieldType["D":"D",fieldType["N":"N",fieldType["S":"S",fieldType["C":"C",fieldType["V":"V",1:"")
"RTN","SYNDHPUTL",45,0)
 . s fieldValueSet=$s(fieldType="S":$p(node0,U,3),1:"")
"RTN","SYNDHPUTL",46,0)
 . s pointsTo=$s(fieldType="P":+$p($p(node0,U,2),"P",2),1:"")
"RTN","SYNDHPUTL",47,0)
 . s fields(fieldNbr)=fieldName_U_fieldNameCC_U_fieldType_U_fieldValueSet_U_pointsTo_U
"RTN","SYNDHPUTL",48,0)
 ;
"RTN","SYNDHPUTL",49,0)
 ;i $g(DEBUG) w !,"fields",! zwrite fields
"RTN","SYNDHPUTL",50,0)
 ;
"RTN","SYNDHPUTL",51,0)
 QUIT
"RTN","SYNDHPUTL",52,0)
 ;
"RTN","SYNDHPUTL",53,0)
camelCase(x) ;return a string in camel case
"RTN","SYNDHPUTL",54,0)
 ;input: x - string
"RTN","SYNDHPUTL",55,0)
 ;return: camel case string
"RTN","SYNDHPUTL",56,0)
 ;
"RTN","SYNDHPUTL",57,0)
 s x=$tr(x,"`-=[]\;',./~!@#$%^&*()_+{}|:""<>?","                                 ") ;eol is out here
"RTN","SYNDHPUTL",58,0)
 s x=$$TITLE^XLFSTR(x)
"RTN","SYNDHPUTL",59,0)
 s $p(x," ",1)=$$LOW^XLFSTR($p(x," ",1))
"RTN","SYNDHPUTL",60,0)
 s x=$$STRIP^XLFSTR(x," ")
"RTN","SYNDHPUTL",61,0)
 ;
"RTN","SYNDHPUTL",62,0)
 QUIT x
"RTN","SYNDHPUTL",63,0)
 ;
"RTN","SYNDHPUTL",64,0)
PATLIST ;Get list of patients from %wd graph
"RTN","SYNDHPUTL",65,0)
 ;
"RTN","SYNDHPUTL",66,0)
 N IEN,DFN,ICN,NAME
"RTN","SYNDHPUTL",67,0)
 W !,"Patient Name",?33,"Graph IEN",?45,"DFN",?55,"ICN",!
"RTN","SYNDHPUTL",68,0)
 S IEN=0
"RTN","SYNDHPUTL",69,0)
 F  S IEN=$O(^%wd(17.040801,1,IEN)) QUIT:'+IEN  DO
"RTN","SYNDHPUTL",70,0)
 . S DFN=$$ien2dfn^SYNFUTL(IEN)
"RTN","SYNDHPUTL",71,0)
 . S ICN=$$ien2icn^SYNFUTL(IEN)
"RTN","SYNDHPUTL",72,0)
 . S NAME=$$GET1^DIQ(2,DFN_",",.01)
"RTN","SYNDHPUTL",73,0)
 . W NAME,?35,IEN,?45,DFN,?55,ICN,!
"RTN","SYNDHPUTL",74,0)
 QUIT
"RTN","SYNDHPUTL",75,0)
 ;
"RTN","SYNDHPUTL",76,0)
GETOS() ;
"RTN","SYNDHPUTL",77,0)
 ;Determine OS
"RTN","SYNDHPUTL",78,0)
 NEW ZZOS
"RTN","SYNDHPUTL",79,0)
 SET ZZOS=$$OS^%ZOSV()
"RTN","SYNDHPUTL",80,0)
 SET ZZOS=$SELECT(ZZOS["VMS":"1-VMS",ZZOS["NT":"2-MSW",ZZOS["UNIX":"3-LINUX",1:"0-")
"RTN","SYNDHPUTL",81,0)
 ;W !,ZZOS,!
"RTN","SYNDHPUTL",82,0)
 QUIT ZZOS
"RTN","SYNDHPUTL",83,0)
 ;
"RTN","SYNDHPUTL",84,0)
OPEN(ZZFILE,ZZDIR,ZZFILENM,ZZMODE) ;Open a File
"RTN","SYNDHPUTL",85,0)
 ; Inputs - ZZFILE - File tag to open
"RTN","SYNDHPUTL",86,0)
 ;          ZZDIR - Host File Directory Name
"RTN","SYNDHPUTL",87,0)
 ;          ZZFILENM - File Name
"RTN","SYNDHPUTL",88,0)
 ;          ZZMODE - Open mode - R=Read, W=Write, A=Append
"RTN","SYNDHPUTL",89,0)
 ; Output - 1 if file was opened
"RTN","SYNDHPUTL",90,0)
 ;          0 if not opened
"RTN","SYNDHPUTL",91,0)
 ;          IO - opened device designator
"RTN","SYNDHPUTL",92,0)
 ;
"RTN","SYNDHPUTL",93,0)
 NEW POP
"RTN","SYNDHPUTL",94,0)
 DO OPEN^%ZISH(ZZFILE,ZZDIR,ZZFILENM,ZZMODE)
"RTN","SYNDHPUTL",95,0)
 IF POP DO  QUIT 0
"RTN","SYNDHPUTL",96,0)
 . USE 0
"RTN","SYNDHPUTL",97,0)
 . WRITE !,"ERROR: Could not open the file: ",ZZDIR,"\",ZZFILENM,!
"RTN","SYNDHPUTL",98,0)
 . WRITE "       Ensure the directory name is valid.",!
"RTN","SYNDHPUTL",99,0)
 QUIT 1
"RTN","SYNDHPUTL",100,0)
 ;
"RTN","SYNDHPUTL",101,0)
CLOSE(ZZFILE) ;Close a File
"RTN","SYNDHPUTL",102,0)
 ; Input  - ZZFILE - File tag to close
"RTN","SYNDHPUTL",103,0)
 ; Output - none
"RTN","SYNDHPUTL",104,0)
 ;
"RTN","SYNDHPUTL",105,0)
 DO CLOSE^%ZISH(ZZFILE)
"RTN","SYNDHPUTL",106,0)
 QUIT
"RTN","SYNDHPUTL",107,0)
 ;
"RTN","SYNDHPUTL",108,0)
EOF() ;Test for EOF
"RTN","SYNDHPUTL",109,0)
 ; Input  - none
"RTN","SYNDHPUTL",110,0)
 ; Output - 1 if end of file has been reached
"RTN","SYNDHPUTL",111,0)
 ;
"RTN","SYNDHPUTL",112,0)
 QUIT $$STATUS^%ZISH
"RTN","SYNDHPUTL",113,0)
 ;
"RTN","SYNDHPUTL",114,0)
GETDFN(ZZPNAME) ;Get patient's DFN
"RTN","SYNDHPUTL",115,0)
 ;Inputs - ZZPNAME - Patient name
"RTN","SYNDHPUTL",116,0)
 ;Returns - Patient DFN
"RTN","SYNDHPUTL",117,0)
 ;
"RTN","SYNDHPUTL",118,0)
 QUIT:$GET(ZZPNAME)="" "0^Missing name"
"RTN","SYNDHPUTL",119,0)
 ;
"RTN","SYNDHPUTL",120,0)
 NEW ZZDFN,ZZMSG
"RTN","SYNDHPUTL",121,0)
 SET ZZDFN=$$FIND1^DIC(2,,"BQUX",ZZPNAME,"B",,"ZZMSG")
"RTN","SYNDHPUTL",122,0)
 ;
"RTN","SYNDHPUTL",123,0)
 QUIT ZZDFN
"RTN","SYNDHPUTL",124,0)
 ;
"RTN","SYNDHPUTL",125,0)
GETIEN(ZZFILE,ZZNAME) ;Get IEN for name
"RTN","SYNDHPUTL",126,0)
 ;Inputs - ZZFILE - File number
"RTN","SYNDHPUTL",127,0)
 ;         ZZNAME - name (.01 field)
"RTN","SYNDHPUTL",128,0)
 ;Returns - IEN
"RTN","SYNDHPUTL",129,0)
 ;
"RTN","SYNDHPUTL",130,0)
 QUIT:$GET(ZZFILE)="" "0^Missing file number"
"RTN","SYNDHPUTL",131,0)
 QUIT:$GET(ZZNAME)="" "0^Missing name"
"RTN","SYNDHPUTL",132,0)
 ;
"RTN","SYNDHPUTL",133,0)
 NEW ZZIEN,ZZMSG
"RTN","SYNDHPUTL",134,0)
 SET ZZIEN=$$FIND1^DIC(ZZFILE,,"BQUX",ZZNAME,"B",,"ZZMSG")
"RTN","SYNDHPUTL",135,0)
 ;
"RTN","SYNDHPUTL",136,0)
 QUIT ZZIEN
"RTN","SYNDHPUTL",137,0)
 ;
"RTN","SYNDHPUTL",138,0)
UICN(PATIEN) ; ICN for IEN
"RTN","SYNDHPUTL",139,0)
 ; 
"RTN","SYNDHPUTL",140,0)
 Q $$GET1^DIQ(2,PATIEN_",",991.1)
"RTN","SYNDHPUTL",141,0)
 ;
"RTN","SYNDHPUTL",142,0)
ICN(IEN) ; obtain ICN
"RTN","SYNDHPUTL",143,0)
 N ICN
"RTN","SYNDHPUTL",144,0)
 S ICN=$$GET1^DIQ(2,IEN_",",991.1)
"RTN","SYNDHPUTL",145,0)
 I ICN="" D
"RTN","SYNDHPUTL",146,0)
 . S ICN=$$GET1^DIQ(2,IEN_",",991.01)_"V"_$$GET1^DIQ(2,IEN_",",991.02)
"RTN","SYNDHPUTL",147,0)
 Q ICN
"RTN","SYNDHPUTL",148,0)
 ;
"RTN","SYNDHPUTL",149,0)
UICNVAL(ICN) ; validate ICN
"RTN","SYNDHPUTL",150,0)
 ; Input: ICN
"RTN","SYNDHPUTL",151,0)
 ; Returns: 0 - invalid
"RTN","SYNDHPUTL",152,0)
 ;          1 - valid
"RTN","SYNDHPUTL",153,0)
 ;
"RTN","SYNDHPUTL",154,0)
 I $G(ICN)="" Q 0
"RTN","SYNDHPUTL",155,0)
 I '$D(^DPT("AFICN",ICN)) Q 0
"RTN","SYNDHPUTL",156,0)
 QUIT 1
"RTN","SYNDHPUTL",157,0)
 ;
"RTN","SYNDHPUTL",158,0)
USCTPT(SCT) ; SNOMED CT preferred term
"RTN","SYNDHPUTL",159,0)
 ;Input: SCT - SNOMED Code
"RTN","SYNDHPUTL",160,0)
 ;Returns: SCT Preferred Term
"RTN","SYNDHPUTL",161,0)
 ;
"RTN","SYNDHPUTL",162,0)
 N LEX,PREF
"RTN","SYNDHPUTL",163,0)
 S LEX=$$CODE^LEXTRAN(SCT,"SCT")
"RTN","SYNDHPUTL",164,0)
 S PREF=""
"RTN","SYNDHPUTL",165,0)
 I $D(LEX("P")) S PREF=LEX("P")
"RTN","SYNDHPUTL",166,0)
 Q PREF
"RTN","SYNDHPUTL",167,0)
 ;
"RTN","SYNDHPUTL",168,0)
DATECNVT(DATE) ;convert DATE to Fileman format
"RTN","SYNDHPUTL",169,0)
 ;
"RTN","SYNDHPUTL",170,0)
 I $G(DATE)="" QUIT ""
"RTN","SYNDHPUTL",171,0)
 N %DT S %DT="T"
"RTN","SYNDHPUTL",172,0)
 N X S X=DATE
"RTN","SYNDHPUTL",173,0)
 N Y
"RTN","SYNDHPUTL",174,0)
 D ^%DT
"RTN","SYNDHPUTL",175,0)
 QUIT Y
"RTN","SYNDHPUTL",176,0)
 ;
"RTN","SYNDHPUTL",177,0)
FMTFHIR(FMDATE) ;Convert Fileman date to FHIR date
"RTN","SYNDHPUTL",178,0)
 ;Inputs - FMDATE - Fileman date/time
"RTN","SYNDHPUTL",179,0)
 ;Returns - FHIR Date
"RTN","SYNDHPUTL",180,0)
 ;
"RTN","SYNDHPUTL",181,0)
 QUIT:$GET(FMDATE)="" ""
"RTN","SYNDHPUTL",182,0)
 ;
"RTN","SYNDHPUTL",183,0)
 NEW FHIRDATE SET FHIRDATE=""
"RTN","SYNDHPUTL",184,0)
 ;
"RTN","SYNDHPUTL",185,0)
 I $L(FMDATE)<7 QUIT ""
"RTN","SYNDHPUTL",186,0)
 I $L(FMDATE)=7 D  QUIT FHIRDATE
"RTN","SYNDHPUTL",187,0)
 . S FHIRDATE=$E(FMDATE,1,3)+1700_"-"_$E(FMDATE,4,5)_"-"_$E(FMDATE,6,7)
"RTN","SYNDHPUTL",188,0)
 ;
"RTN","SYNDHPUTL",189,0)
 N hl7,dtm,tz
"RTN","SYNDHPUTL",190,0)
 S hl7=$$FMTHL7^XLFDT(FMDATE)
"RTN","SYNDHPUTL",191,0)
 I hl7="" QUIT ""
"RTN","SYNDHPUTL",192,0)
 I hl7=-1 QUIT -1
"RTN","SYNDHPUTL",193,0)
 S dtm=$P(hl7,"-",1)
"RTN","SYNDHPUTL",194,0)
 S tz="-"_$E($P(hl7,"-",2),1,2)_":"_$E($P(hl7,"-",2),3,4)
"RTN","SYNDHPUTL",195,0)
 S FHIRDATE=$E(hl7,1,4)_"-"_$E(hl7,5,6)_"-"_$E(hl7,7,8)_"T"_$E(hl7,9,10)_":"_$E(hl7,11,12)_":"_$S(+$E(hl7,13,14)>0:$E(hl7,13,14),1:"00")_tz
"RTN","SYNDHPUTL",196,0)
 ;
"RTN","SYNDHPUTL",197,0)
 QUIT FHIRDATE
"RTN","SYNDHPUTL",198,0)
 ;
"RTN","SYNDHPUTL",199,0)
CTRLS(X) ; strip control characters
"RTN","SYNDHPUTL",200,0)
 N I,CTRLS
"RTN","SYNDHPUTL",201,0)
 S CTRLS=""
"RTN","SYNDHPUTL",202,0)
 F I=1:1:31,127:1:190 S CTRLS=CTRLS_$C(I)
"RTN","SYNDHPUTL",203,0)
 Q $TR(X,CTRLS)
"RTN","SYNDHPUTL",204,0)
 ;
"RTN","SYNDHPUTL",205,0)
ZW(VAR) ; simulate Cach or GT.M ZW or ZWRITE fuction
"RTN","SYNDHPUTL",206,0)
 ; VAR - variable to be ZWritten
"RTN","SYNDHPUTL",207,0)
 ; 
"RTN","SYNDHPUTL",208,0)
 N TSUB,I
"RTN","SYNDHPUTL",209,0)
 W $G(@VAR)
"RTN","SYNDHPUTL",210,0)
 S TSUB=VAR F I=1:1 S TSUB=$Q(@TSUB) Q:TSUB'[VAR  W !,TSUB,"=",@TSUB
"RTN","SYNDHPUTL",211,0)
 Q ""
"RTN","SYNDHPUTL",212,0)
 ;
"RTN","SYNDHPUTL",213,0)
ICNPAT(ICN) ; patient for ICN
"RTN","SYNDHPUTL",214,0)
 ; Input: ICN
"RTN","SYNDHPUTL",215,0)
 ; Returns: 0 - invalid
"RTN","SYNDHPUTL",216,0)
 ;          ICN^IEN^NAME - valid
"RTN","SYNDHPUTL",217,0)
 ;
"RTN","SYNDHPUTL",218,0)
 I $G(ICN)="" Q 0
"RTN","SYNDHPUTL",219,0)
 I '$D(^DPT("AFICN",ICN)) Q 0
"RTN","SYNDHPUTL",220,0)
 N PATIEN S PATIEN=$O(^DPT("AFICN",ICN,""))
"RTN","SYNDHPUTL",221,0)
 N PATNAME S PATNAME=$$GET1^DIQ(2,PATIEN,.01)
"RTN","SYNDHPUTL",222,0)
 QUIT ICN_U_PATIEN_U_PATNAME
"RTN","SYNDHPUTL",223,0)
 ;
"RTN","SYNDTS89")
0^111^B37105881
"RTN","SYNDTS89",1,0)
SYNDTS89 ;AFHIL/HC/fjf - HealthConcourse - REST service tester ;03/28/2019
"RTN","SYNDTS89",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNDTS89",3,0)
 ;;
"RTN","SYNDTS89",4,0)
 ; This routine tests the Health Concourse GETter REST services
"RTN","SYNDTS89",5,0)
 ;
"RTN","SYNDTS89",6,0)
 ; It specifically tests those services that have a request URL in the following format:
"RTN","SYNDTS89",7,0)
 ; http://ip-address-port/endpoint?ICN=icn&JSON=flag
"RTN","SYNDTS89",8,0)
 ; the architecture can be extended to accommodate those REST services
"RTN","SYNDTS89",9,0)
 ; that don't conveniently fit the above pattern
"RTN","SYNDTS89",10,0)
 ;
"RTN","SYNDTS89",11,0)
 ; the routine currently returns the REST call url for json and non-json
"RTN","SYNDTS89",12,0)
 ; plus the relevant data in the appropriate format for the resource 
"RTN","SYNDTS89",13,0)
 ;
"RTN","SYNDTS89",14,0)
ctrl(nopats,server) ;
"RTN","SYNDTS89",15,0)
 ; Input:
"RTN","SYNDTS89",16,0)
 ;   nopats - number of patiens per system
"RTN","SYNDTS89",17,0)
 ;     if nopats is not passed or evaluates to 0 then all patiens
"RTN","SYNDTS89",18,0)
 ;     will be tested
"RTN","SYNDTS89",19,0)
 ;   server - 
"RTN","SYNDTS89",20,0)
 ;     if server is not defined in url roots then then all servers 
"RTN","SYNDTS89",21,0)
 ;     will be tested
"RTN","SYNDTS89",22,0)
 ;          
"RTN","SYNDTS89",23,0)
 ;
"RTN","SYNDTS89",24,0)
 ; create array of urls of systems to be tested
"RTN","SYNDTS89",25,0)
 s server=$g(server,"none")
"RTN","SYNDTS89",26,0)
 d urlrts
"RTN","SYNDTS89",27,0)
 ;
"RTN","SYNDTS89",28,0)
 ; create array of patient data endpoints to be tested
"RTN","SYNDTS89",29,0)
 d endpoints
"RTN","SYNDTS89",30,0)
 ;
"RTN","SYNDTS89",31,0)
 ; start of scan by url by patient by endpoint
"RTN","SYNDTS89",32,0)
 s (icn,url,endpoint)=""
"RTN","SYNDTS89",33,0)
 s nopats=$g(nopats)
"RTN","SYNDTS89",34,0)
 s s=";"
"RTN","SYNDTS89",35,0)
 s urlab=""
"RTN","SYNDTS89",36,0)
 f  s urlab=$o(urlrt(urlab)) q:urlab=""  d
"RTN","SYNDTS89",37,0)
 .s url=urlrt(urlab)
"RTN","SYNDTS89",38,0)
 .; find ICN's in namespace denoted by url+port
"RTN","SYNDTS89",39,0)
 .s icns=$$icnstr(url)
"RTN","SYNDTS89",40,0)
 .i +nopats=0 s nopats=$l(icns,s)
"RTN","SYNDTS89",41,0)
 .s icns=$p(icns,s,1,nopats)
"RTN","SYNDTS89",42,0)
 .w !,"icns ",!,icns,!
"RTN","SYNDTS89",43,0)
 .; for namepace (specified by url+port) scan through ICN's
"RTN","SYNDTS89",44,0)
 .s pats=+$g(nopats)
"RTN","SYNDTS89",45,0)
 .i pats=0 s pats=$l(icns,s)
"RTN","SYNDTS89",46,0)
 .f i=1:1:pats s icn=$p(icns,s,i) q:icn=""  d
"RTN","SYNDTS89",47,0)
 ..;for ICN's scan through endpoints
"RTN","SYNDTS89",48,0)
 ..s endpoint=""
"RTN","SYNDTS89",49,0)
 ..f  s endpoint=$o(endpoints(endpoint)) q:endpoint=""  d
"RTN","SYNDTS89",50,0)
 ...f format="","J" d
"RTN","SYNDTS89",51,0)
 ....; build patient getter REST service URL and make call
"RTN","SYNDTS89",52,0)
 ....s RESTurl=$$RESTurl(url,endpoint,icn,,,format)
"RTN","SYNDTS89",53,0)
 ....w !,RESTurl,!
"RTN","SYNDTS89",54,0)
 ....s RET=$$GETURL^XTHC10(RESTurl,,"PDATA")
"RTN","SYNDTS89",55,0)
 ....i '$d(PDATA) w !,"no data" q
"RTN","SYNDTS89",56,0)
 ....s datstr=$$xthc2st(.PDATA)
"RTN","SYNDTS89",57,0)
 ....w !,datstr,!
"RTN","SYNDTS89",58,0)
 Q
"RTN","SYNDTS89",59,0)
 ;
"RTN","SYNDTS89",60,0)
icnstr(url) ; create icn string for system at url
"RTN","SYNDTS89",61,0)
 ; invokes DHPPATICNALL service
"RTN","SYNDTS89",62,0)
 ; Input:
"RTN","SYNDTS89",63,0)
 ;   url of system of interest
"RTN","SYNDTS89",64,0)
 ; Ouput:
"RTN","SYNDTS89",65,0)
 ;   semicolon delimited list of ICN's
"RTN","SYNDTS89",66,0)
 ;
"RTN","SYNDTS89",67,0)
 n s,icnurl,RET,icns
"RTN","SYNDTS89",68,0)
 s s=";"
"RTN","SYNDTS89",69,0)
 s icnurl=url_"DHPPATICNALL?JSON=T"
"RTN","SYNDTS89",70,0)
 s RET=$$GETURL^XTHC10(icnurl,,"icnar")
"RTN","SYNDTS89",71,0)
 i +RET=-1 q RET
"RTN","SYNDTS89",72,0)
 s icnar=""
"RTN","SYNDTS89",73,0)
 s icns=$$xthc2st(.icnar)
"RTN","SYNDTS89",74,0)
 q icns
"RTN","SYNDTS89",75,0)
 ;
"RTN","SYNDTS89",76,0)
xthc2st(array) ; combines array elements from XTHC10 into a single string
"RTN","SYNDTS89",77,0)
 ; Input
"RTN","SYNDTS89",78,0)
 ;   array passed by reference
"RTN","SYNDTS89",79,0)
 ;
"RTN","SYNDTS89",80,0)
 n string,n,sub
"RTN","SYNDTS89",81,0)
 s sub=$o(array(""))
"RTN","SYNDTS89",82,0)
 s string=array(sub)
"RTN","SYNDTS89",83,0)
 s n=""
"RTN","SYNDTS89",84,0)
 f  s n=$o(array(sub,n)) q:n=""  d
"RTN","SYNDTS89",85,0)
 .s string=string_array(sub,n)
"RTN","SYNDTS89",86,0)
 .k array(sub,n)
"RTN","SYNDTS89",87,0)
 q string
"RTN","SYNDTS89",88,0)
 ;
"RTN","SYNDTS89",89,0)
RESTurl(url,endpoint,icn,fromdt,todt,format) ; create REST service URL
"RTN","SYNDTS89",90,0)
 ;
"RTN","SYNDTS89",91,0)
 s fromdt=$g(fromdt)
"RTN","SYNDTS89",92,0)
 s todt=$g(todt)
"RTN","SYNDTS89",93,0)
 s format=$g(format)
"RTN","SYNDTS89",94,0)
 s url=url_endpoint_"?ICN="_icn
"RTN","SYNDTS89",95,0)
 s:format'="" url=url_"&JSON="_format
"RTN","SYNDTS89",96,0)
 s:fromdt'="" url=url_"&FRDAT="_fromdt
"RTN","SYNDTS89",97,0)
 s:todt'="" url=url_"&TODAT="_todt
"RTN","SYNDTS89",98,0)
 q url
"RTN","SYNDTS89",99,0)
 ;
"RTN","SYNDTS89",100,0)
urlrts ; set up roots urls for healthConcourse dev
"RTN","SYNDTS89",101,0)
 k urlrt
"RTN","SYNDTS89",102,0)
 n s,t
"RTN","SYNDTS89",103,0)
 s s=";"
"RTN","SYNDTS89",104,0)
 f i=1:1 s t=$t(urlli+i) q:t["urlend"  d
"RTN","SYNDTS89",105,0)
 .s urlrt($p(t,s,4))=$p(t,s,3)
"RTN","SYNDTS89",106,0)
 i $d(urlrt(server)) d
"RTN","SYNDTS89",107,0)
 .s t=urlrt(server)
"RTN","SYNDTS89",108,0)
 .k urlrt
"RTN","SYNDTS89",109,0)
 .s urlrt(server)=t
"RTN","SYNDTS89",110,0)
 q
"RTN","SYNDTS89",111,0)
 ;
"RTN","SYNDTS89",112,0)
urlli ; list of url roots
"RTN","SYNDTS89",113,0)
 ;;http://ec2-18-208-29-125.compute-1.amazonaws.com:8001/;awsdev;                AWS dev
"RTN","SYNDTS89",114,0)
 ;;http://ec2-18-208-29-125.compute-1.amazonaws.com:9080/;awsdevshm;             AWS dev shim
"RTN","SYNDTS89",115,0)
 ;;https://vista.dev.openplatform.healthcare/rgnet-web/;k8dev;                   k8 dev
"RTN","SYNDTS89",116,0)
 ;;https://vista.dev.openplatform.healthcare/vpr-web/;k8devshm;                  k8 dev shim
"RTN","SYNDTS89",117,0)
 ;;https://vista.demo-staging.openplatform.healthcare/rgnet-web/;k8demstag;      k8 demo-staging
"RTN","SYNDTS89",118,0)
 ;;https://vista.demo-staging.openplatform.healthcare/rgnet-web/;k8demstagshm;   k8 demo-staging shim
"RTN","SYNDTS89",119,0)
 ;;https://vista.demo.openplatform.healthcare/rgnet-web/;k8demo;                 k8 demo
"RTN","SYNDTS89",120,0)
 ;;https://vista.demo.openplatform.healthcare/vpr-web/;k8demoshm;                k8 demo shim 
"RTN","SYNDTS89",121,0)
 ;;https://vista-general.dev.openplatform.healthcare/rgnet-web/;targen;          tardis general
"RTN","SYNDTS89",122,0)
 ;;https://vista-general.dev.openplatform.healthcare/vpr-web/;targenshm;         tardis general shim
"RTN","SYNDTS89",123,0)
 ;;https://vista-emergency.dev.openplatform.healthcare/rgnet-web/;taremer;       tardis emergency
"RTN","SYNDTS89",124,0)
 ;;https://vista-emergency.dev.openplatform.healthcare/vpr-web/;taremershm;      tardis emergency shim
"RTN","SYNDTS89",125,0)
 ;;https://vista-specialization.dev.openplatform.healthcare/rgnet-web/;tarspec;  tardis specialization
"RTN","SYNDTS89",126,0)
 ;;https://vista-specialization.dev.openplatform.healthcare/vpr-web/;tarspecshm; tardis specialization shim
"RTN","SYNDTS89",127,0)
 ;;http://shadow.vistaplex.org/;shadvplex;                                       GT.M server
"RTN","SYNDTS89",128,0)
 ;;http://syn.vistaplex.org/;synvplex;                                           GT.M server
"RTN","SYNDTS89",129,0)
 ;;urlend
"RTN","SYNDTS89",130,0)
 q
"RTN","SYNDTS89",131,0)
 ;
"RTN","SYNDTS89",132,0)
endpoints ; for patient data by ICN
"RTN","SYNDTS89",133,0)
 ; pattern is DHPPATxxxxxICN
"RTN","SYNDTS89",134,0)
 ;
"RTN","SYNDTS89",135,0)
 n n,s,q,pat
"RTN","SYNDTS89",136,0)
 s n="",s="/",q=""""
"RTN","SYNDTS89",137,0)
 s pat=1_q_"DHPPAT"_q_"2.5e"_1_q_"ICN"_q_".e"
"RTN","SYNDTS89",138,0)
 f  s n=$o(^RGNET(996.52,"B",n)) q:n=""  d
"RTN","SYNDTS89",139,0)
 .i n?@pat s endpoints($p(n,s))=""
"RTN","SYNDTS89",140,0)
 q
"RTN","SYNDTS89",141,0)
 ;;;;
"RTN","SYNDTS89",142,0)
ts ;
"RTN","SYNDTS89",143,0)
 ;
"RTN","SYNDTS89",144,0)
 s url="http://ec2-18-208-29-125.compute-1.amazonaws.com:8001/"
"RTN","SYNDTS89",145,0)
 s endpoint="DHPPATVITICN"
"RTN","SYNDTS89",146,0)
 s icn="9993306312V376330"
"RTN","SYNDTS89",147,0)
 s RESTurl=$$RESTurl(url,endpoint,icn,,,"J")
"RTN","SYNDTS89",148,0)
 s RET=$$GETURL^XTHC10(RESTurl,,"PDATA")
"RTN","SYNDTS89",149,0)
 q
"RTN","SYNFALG")
0^23^B126847670
"RTN","SYNFALG",1,0)
SYNFALG ;ven/gpl - fhir loader utilities ; 2/20/18 4:11am
"RTN","SYNFALG",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNFALG",3,0)
 ;
"RTN","SYNFALG",4,0)
 ; Authored by George P. Lilly 2017-2018
"RTN","SYNFALG",5,0)
 ; (c) Sam Habiel 2018
"RTN","SYNFALG",6,0)
 ;
"RTN","SYNFALG",7,0)
 q
"RTN","SYNFALG",8,0)
 ;
"RTN","SYNFALG",9,0)
importAllergy(rtn,ien,args) ; entry point for loading Allergy for a patient
"RTN","SYNFALG",10,0)
 ; calls the intake Allergy web service directly
"RTN","SYNFALG",11,0)
 ;
"RTN","SYNFALG",12,0)
 n grtn
"RTN","SYNFALG",13,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFALG",14,0)
 d wsIntakeAllergy(.args,,.grtn,ien)
"RTN","SYNFALG",15,0)
 i $d(grtn) d  ; something was returned
"RTN","SYNFALG",16,0)
 . k @root@(ien,"load","allergy")
"RTN","SYNFALG",17,0)
 . m @root@(ien,"load","allergy")=grtn("allergy")
"RTN","SYNFALG",18,0)
 . if $g(args("debug"))=1 m rtn=grtn
"RTN","SYNFALG",19,0)
 s rtn("conditionsStatus","status")=$g(grtn("status","status"))
"RTN","SYNFALG",20,0)
 s rtn("conditionsStatus","loaded")=$g(grtn("status","loaded"))
"RTN","SYNFALG",21,0)
 s rtn("conditionsStatus","errors")=$g(grtn("status","errors"))
"RTN","SYNFALG",22,0)
 ;b
"RTN","SYNFALG",23,0)
 ;
"RTN","SYNFALG",24,0)
 ;
"RTN","SYNFALG",25,0)
 q
"RTN","SYNFALG",26,0)
 ;
"RTN","SYNFALG",27,0)
wsIntakeAllergy(args,body,result,ien) ; web service entry (post)
"RTN","SYNFALG",28,0)
 ; for intake of one or more Allergy. input are fhir resources
"RTN","SYNFALG",29,0)
 ; result is json and summarizes what was done
"RTN","SYNFALG",30,0)
 ; args include patientId
"RTN","SYNFALG",31,0)
 ; ien is specified for internal calls, where the json is already in a graph
"RTN","SYNFALG",32,0)
 n jtmp,json,jrslt,eval
"RTN","SYNFALG",33,0)
 ;i $g(ien)'="" if $$loadStatus("allergy","",ien)=1 d  q  ;
"RTN","SYNFALG",34,0)
 ;. s result("allergytatus","status")="alreadyLoaded"
"RTN","SYNFALG",35,0)
 i $g(ien)'="" d  ; internal call
"RTN","SYNFALG",36,0)
 . d getIntakeFhir^SYNFHIR("json",,"AllergyIntolerance",ien,1)
"RTN","SYNFALG",37,0)
 e  d  ; 
"RTN","SYNFALG",38,0)
 . ;s args("load")=0
"RTN","SYNFALG",39,0)
 . merge jtmp=BODY
"RTN","SYNFALG",40,0)
 . do DECODE^VPRJSON("jtmp","json")
"RTN","SYNFALG",41,0)
 ;
"RTN","SYNFALG",42,0)
 ;i '$d(json) d getRandomAllergy(.json)
"RTN","SYNFALG",43,0)
 ;
"RTN","SYNFALG",44,0)
 i '$d(json) q  ;
"RTN","SYNFALG",45,0)
 m ^gpl("gjson")=json
"RTN","SYNFALG",46,0)
 ;
"RTN","SYNFALG",47,0)
 ; determine the patient
"RTN","SYNFALG",48,0)
 ;
"RTN","SYNFALG",49,0)
 n dfn,eval
"RTN","SYNFALG",50,0)
 if $g(ien)'="" d  ;
"RTN","SYNFALG",51,0)
 . s dfn=$$ien2dfn^SYNFUTL(ien) ; look up dfn in the graph
"RTN","SYNFALG",52,0)
 else  d  ;
"RTN","SYNFALG",53,0)
 . s dfn=$g(args("dfn"))
"RTN","SYNFALG",54,0)
 . i dfn="" d  ;
"RTN","SYNFALG",55,0)
 . . n icn s icn=$g(args("icn"))
"RTN","SYNFALG",56,0)
 . . i icn'="" s dfn=$$icn2dfn^SYNFUTL(icn)
"RTN","SYNFALG",57,0)
 . . q:dfn=""
"RTN","SYNFALG",58,0)
 . . s ien=$$dfn2ien^SYNFUTL(dfn)
"RTN","SYNFALG",59,0)
 i $g(dfn)="" do  quit  ; need the patient
"RTN","SYNFALG",60,0)
 . s result("allergy",1,"log",1)="Error, patient not found.. terminating"
"RTN","SYNFALG",61,0)
 ;
"RTN","SYNFALG",62,0)
 new zi s zi=0
"RTN","SYNFALG",63,0)
 for  set zi=$order(json("entry",zi)) quit:+zi=0  do  ;
"RTN","SYNFALG",64,0)
 . ;
"RTN","SYNFALG",65,0)
 . ; define a place to log the processing of this entry
"RTN","SYNFALG",66,0)
 . ;
"RTN","SYNFALG",67,0)
 . new jlog set jlog=$name(eval("allergy",zi))
"RTN","SYNFALG",68,0)
 . ;
"RTN","SYNFALG",69,0)
 . ; insure that the resourceType is AllergyIntolerance
"RTN","SYNFALG",70,0)
 . ;
"RTN","SYNFALG",71,0)
 . new type set type=$get(json("entry",zi,"resource","resourceType"))
"RTN","SYNFALG",72,0)
 . if type'="AllergyIntolerance" do  quit  ;
"RTN","SYNFALG",73,0)
 . . set eval("allergy",zi,"vars","resourceType")=type
"RTN","SYNFALG",74,0)
 . . do log(jlog,"Resource type not AllergyIntolerance, skipping entry")
"RTN","SYNFALG",75,0)
 . set eval("allergy",zi,"vars","resourceType")=type
"RTN","SYNFALG",76,0)
 . ;
"RTN","SYNFALG",77,0)
 . ; see if this resource has already been loaded. if so, skip it
"RTN","SYNFALG",78,0)
 . ;
"RTN","SYNFALG",79,0)
 . if $g(ien)'="" if $$loadStatus("allergy",zi,ien)=1 do  quit  ;
"RTN","SYNFALG",80,0)
 . . d log(jlog,"Allergy already loaded, skipping")
"RTN","SYNFALG",81,0)
 . ;
"RTN","SYNFALG",82,0)
 . ; determine the codesystem of the allergy
"RTN","SYNFALG",83,0)
 . ;
"RTN","SYNFALG",84,0)
 . new codesystem set codesystem=$get(json("entry",zi,"resource","code","coding",1,"system"))
"RTN","SYNFALG",85,0)
 . do log(jlog,"code system is: "_codesystem)
"RTN","SYNFALG",86,0)
 . set eval("allergy",zi,"vars","codeSystem")=codesystem
"RTN","SYNFALG",87,0)
 . ;
"RTN","SYNFALG",88,0)
 . ; if rxnorm, call meds routine
"RTN","SYNFALG",89,0)
 . ; 
"RTN","SYNFALG",90,0)
 . i codesystem["rxnorm" do  q  ;
"RTN","SYNFALG",91,0)
 . . d MEDALGY^SYNFALG2(dfn,.root,.json,zi,.eval,.jlog,.args)
"RTN","SYNFALG",92,0)
 . ;
"RTN","SYNFALG",93,0)
 . ; determine Allergy snomed code  and display text
"RTN","SYNFALG",94,0)
 . ;
"RTN","SYNFALG",95,0)
 . ; determine the id of the resource
"RTN","SYNFALG",96,0)
 . ;
"RTN","SYNFALG",97,0)
 . ;new id set id=$get(json("entry",zi,"resource","id"))
"RTN","SYNFALG",98,0)
 . ;set eval("allergy",zi,"vars","id")=id
"RTN","SYNFALG",99,0)
 . ;d log(jlog,"ID is: "_id)
"RTN","SYNFALG",100,0)
 . ;
"RTN","SYNFALG",101,0)
 . new sctcode set sctcode=$get(json("entry",zi,"resource","code","coding",1,"code"))
"RTN","SYNFALG",102,0)
 . do log(jlog,"code is: "_sctcode)
"RTN","SYNFALG",103,0)
 . set eval("allergy",zi,"vars","code")=sctcode
"RTN","SYNFALG",104,0)
 . ;
"RTN","SYNFALG",105,0)
 . ;
"RTN","SYNFALG",106,0)
 . ; determine the onset date and time
"RTN","SYNFALG",107,0)
 . ;
"RTN","SYNFALG",108,0)
 . new onsetdate set onsetdate=$get(json("entry",zi,"resource","assertedDate"))
"RTN","SYNFALG",109,0)
 . do log(jlog,"onsetDateTime is: "_onsetdate)
"RTN","SYNFALG",110,0)
 . set eval("allergy",zi,"vars","onsetDateTime")=onsetdate
"RTN","SYNFALG",111,0)
 . new fmOnsetDateTime s fmOnsetDateTime=$$fhirTfm^SYNFUTL(onsetdate)
"RTN","SYNFALG",112,0)
 . i $l(fmOnsetDateTime)=14 s fmOnsetDateTime=$e(fmOnsetDateTime,1,12)
"RTN","SYNFALG",113,0)
 . d log(jlog,"fileman onsetDateTime is: "_fmOnsetDateTime)
"RTN","SYNFALG",114,0)
 . set eval("allergy",zi,"vars","fmOnsetDateTime")=fmOnsetDateTime ;
"RTN","SYNFALG",115,0)
 . new hl7OnsetDateTime s hl7OnsetDateTime=$$fhirThl7^SYNFUTL(onsetdate)
"RTN","SYNFALG",116,0)
 . d log(jlog,"hl7 onsetDateTime is: "_hl7OnsetDateTime)
"RTN","SYNFALG",117,0)
 . set eval("allergy",zi,"vars","hl7OnsetDateTime")=hl7OnsetDateTime ;
"RTN","SYNFALG",118,0)
 . ;
"RTN","SYNFALG",119,0)
 . ; determine clinical status (active vs inactive)
"RTN","SYNFALG",120,0)
 . ;
"RTN","SYNFALG",121,0)
 . n clinicalstatus set clinicalstatus=$get(json("entry",zi,"resource","verificationStatus"))
"RTN","SYNFALG",122,0)
 . ;
"RTN","SYNFALG",123,0)
 . ;
"RTN","SYNFALG",124,0)
 . ; set up to call the data loader
"RTN","SYNFALG",125,0)
 . ;
"RTN","SYNFALG",126,0)
 . ;ALLERGY^ISIIMP10(ISIRESUL,ISIMISC)          
"RTN","SYNFALG",127,0)
 .;;NAME             |TYPE       |FILE,FIELD |DESC
"RTN","SYNFALG",128,0)
 .;;-----------------------------------------------------------------------
"RTN","SYNFALG",129,0)
 .;;ALLERGEN         |FIELD      |120.82,.01 |
"RTN","SYNFALG",130,0)
 .;;SYMPTOM          |MULTIPLE   |120.83,.01 |Multiple,"|" (bar) delimited, working off #120.83
"RTN","SYNFALG",131,0)
 .;;PAT_SSN          |FIELD      |120.86,.01 |PATIENT (#2, .09) pointer
"RTN","SYNFALG",132,0)
 .;;ORIG_DATE        |FIELD      |120.8,4    |
"RTN","SYNFALG",133,0)
 .;;ORIGINTR         |FIELD      |120.8,5    |PERSON (#200)
"RTN","SYNFALG",134,0)
 .;;HISTORIC         |BOOLEEN    |           |1=HISTORICAL, 0=OBSERVED
"RTN","SYNFALG",135,0)
 .;;OBSRV_DT         |FIELD      |           |Observation Date (if HISTORIC=0)
"RTN","SYNFALG",136,0)
 .;
"RTN","SYNFALG",137,0)
 . n RESTA,ISIMISC
"RTN","SYNFALG",138,0)
 . ;
"RTN","SYNFALG",139,0)
 . s ISIMISC("ALLERGEN")=$get(json("entry",zi,"resource","code","coding",1,"display"))
"RTN","SYNFALG",140,0)
 . n algy s algy=$$ISGMR(sctcode)
"RTN","SYNFALG",141,0)
 . i algy'=-1 s ISIMISC("ALLERGEN")=$p(algy,"^",2)
"RTN","SYNFALG",142,0)
 . s eval("allergy",zi,"parms","ALLERGEN")=ISIMISC("ALLERGEN")
"RTN","SYNFALG",143,0)
 . ;
"RTN","SYNFALG",144,0)
 . s ISIMISC("SYMPTOM")=$get(json("entry",zi,"resource","reaction",1,"description"))
"RTN","SYNFALG",145,0)
 . s eval("allergy",zi,"parms","SYMPTOM")=ISIMISC("SYMPTOM")
"RTN","SYNFALG",146,0)
 . ;
"RTN","SYNFALG",147,0)
 . ;s ISIMISC("ORIGINTR")="USER,THREE"
"RTN","SYNFALG",148,0)
 . s ISIMISC("ORIGINTR")=$$USERNAME^SYNFALG
"RTN","SYNFALG",149,0)
 . s eval("allergy",zi,"parms","ORIGINTR")=ISIMISC("ORIGINTR")
"RTN","SYNFALG",150,0)
 . ;
"RTN","SYNFALG",151,0)
 . s DHPPAT=$$dfn2icn^SYNFUTL(dfn)
"RTN","SYNFALG",152,0)
 . s eval("allergy",zi,"parms","DHPPAT")=DHPPAT
"RTN","SYNFALG",153,0)
 . s ISIMISC("PAT_SSN")=$$GET1^DIQ(2,dfn_",",.09)
"RTN","SYNFALG",154,0)
 . s eval("allergy",zi,"parms","PAT_SSN")=ISIMISC("PAT_SSN")
"RTN","SYNFALG",155,0)
 . ;
"RTN","SYNFALG",156,0)
 . s DHPSCT=sctcode
"RTN","SYNFALG",157,0)
 . s eval("allergy",zi,"parms","DHPSCT")=DHPSCT
"RTN","SYNFALG",158,0)
 . ;
"RTN","SYNFALG",159,0)
 . s DHPCLNST=$S(clinicalstatus="Active":"A",1:"I")
"RTN","SYNFALG",160,0)
 . s eval("allergy",zi,"parms","DHPCLNST")=DHPCLNST
"RTN","SYNFALG",161,0)
 . ;
"RTN","SYNFALG",162,0)
 . s DHPONS=hl7OnsetDateTime
"RTN","SYNFALG",163,0)
 . s eval("allergy",zi,"parms","DHPONS")=DHPONS
"RTN","SYNFALG",164,0)
 . s ISIMISC("ORIG_DATE")=fmOnsetDateTime
"RTN","SYNFALG",165,0)
 . s eval("allergy",zi,"parms","ORIG_DATE")=ISIMISC("ORIG_DATE")
"RTN","SYNFALG",166,0)
 . s ISIMISC("HISTORIC")=1
"RTN","SYNFALG",167,0)
 . s eval("allergy",zi,"parms","HISTORIC")=ISIMISC("HISTORIC")
"RTN","SYNFALG",168,0)
 . ;
"RTN","SYNFALG",169,0)
 . s DHPPROV=$$MAP^SYNQLDM("OP","provider") ; map should return the NPI number
"RTN","SYNFALG",170,0)
 . s eval("allergy",zi,"parms","DHPPROV")=DHPPROV
"RTN","SYNFALG",171,0)
 . d log(jlog,"Provider NPI for outpatient is: "_DHPPROV)
"RTN","SYNFALG",172,0)
 . ;
"RTN","SYNFALG",173,0)
 . ;s DHPLOC=$$MAP^SYNQLDM("OP","location")
"RTN","SYNFALG",174,0)
 . ;n DHPLOCIEN s DHPLOCIEN=$o(^SC("B",DHPLOC,""))
"RTN","SYNFALG",175,0)
 . ;if DHPLOCIEN="" S DHPLOCIEN=4
"RTN","SYNFALG",176,0)
 . ;s eval("allergy",zi,"parms","DHPLOC")=DHPLOCIEN
"RTN","SYNFALG",177,0)
 . ;d log(jlog,"Location for outpatient is: #"_DHPLOCIEN_" "_DHPLOC)
"RTN","SYNFALG",178,0)
 . ;
"RTN","SYNFALG",179,0)
 . s eval("allergy",zi,"status","loadstatus")="readyToLoad"
"RTN","SYNFALG",180,0)
 . ;
"RTN","SYNFALG",181,0)
 . if $g(args("load"))=1 d  ; only load if told to
"RTN","SYNFALG",182,0)
 . . if $g(ien)'="" if $$loadStatus("allergy",zi,ien)=1 do  quit  ;
"RTN","SYNFALG",183,0)
 . . . d log(jlog,"Allergy already loaded, skipping")
"RTN","SYNFALG",184,0)
 . . d log(jlog,"Calling ALLERGY^ISIIMP10 to add allergy")
"RTN","SYNFALG",185,0)
 . . D ALLERGY^ISIIMP10(.RETSTA,.ISIMISC)
"RTN","SYNFALG",186,0)
 . . m eval("allergy",zi,"status")=RESTA
"RTN","SYNFALG",187,0)
 . . d log(jlog,"Return from data loader was: "_$g(ISIRC))
"RTN","SYNFALG",188,0)
 . . if +$g(RETSTA)=1 do  ;
"RTN","SYNFALG",189,0)
 . . . s eval("status","loaded")=$g(eval("status","loaded"))+1
"RTN","SYNFALG",190,0)
 . . . s eval("allergy",zi,"status","loadstatus")="loaded"
"RTN","SYNFALG",191,0)
 . . else  d  ;
"RTN","SYNFALG",192,0)
 . . . s eval("status","errors")=$g(eval("status","errors"))+1
"RTN","SYNFALG",193,0)
 . . . s eval("allergy",zi,"status","loadstatus")="notLoaded"
"RTN","SYNFALG",194,0)
 . . . s eval("allergy",zi,"status","loadMessage")=$g(RETSTA)
"RTN","SYNFALG",195,0)
 . . n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFALG",196,0)
 . . i $g(ien)'="" d  ;
"RTN","SYNFALG",197,0)
 . . . k @root@(ien,"load","allergy",zi)
"RTN","SYNFALG",198,0)
 . . . m @root@(ien,"load","allergy",zi)=eval("allergy",zi)
"RTN","SYNFALG",199,0)
 ;
"RTN","SYNFALG",200,0)
 if $get(args("debug"))=1 do  ;
"RTN","SYNFALG",201,0)
 . m jrslt("source")=json
"RTN","SYNFALG",202,0)
 . m jrslt("args")=args
"RTN","SYNFALG",203,0)
 . m jrslt("eval")=eval
"RTN","SYNFALG",204,0)
 m jrslt("allergyStatus")=eval("allergyStatus")
"RTN","SYNFALG",205,0)
 set jrslt("result","status")="ok"
"RTN","SYNFALG",206,0)
 set jrslt("result","loaded")=$g(eval("status","loaded"))
"RTN","SYNFALG",207,0)
 i $g(ien)'="" d  ; called internally
"RTN","SYNFALG",208,0)
 . m result=eval
"RTN","SYNFALG",209,0)
 . m result("status")=jrslt("result")
"RTN","SYNFALG",210,0)
 . m result("dfn")=dfn
"RTN","SYNFALG",211,0)
 . m result("ien")=ien
"RTN","SYNFALG",212,0)
 . ;b
"RTN","SYNFALG",213,0)
 e  d  ;
"RTN","SYNFALG",214,0)
 . d ENCODE^VPRJSON("jrslt","result")
"RTN","SYNFALG",215,0)
 . set HTTPRSP("mime")="application/json" 
"RTN","SYNFALG",216,0)
 q
"RTN","SYNFALG",217,0)
 ;
"RTN","SYNFALG",218,0)
USERNAME() ; extrinsic returns the name of the user
"RTN","SYNFALG",219,0)
 n duz
"RTN","SYNFALG",220,0)
 s duz=$$USERDUZ^SYNFALG2
"RTN","SYNFALG",221,0)
 q:duz="" -1
"RTN","SYNFALG",222,0)
 q $p(^VA(200,duz,0),"^",1)
"RTN","SYNFALG",223,0)
 ;
"RTN","SYNFALG",224,0)
log(ary,txt) ; adds a text line to @ary@("log")
"RTN","SYNFALG",225,0)
 s @ary@("log",$o(@ary@("log",""),-1)+1)=$g(txt)
"RTN","SYNFALG",226,0)
 q
"RTN","SYNFALG",227,0)
 ;
"RTN","SYNFALG",228,0)
loadStatus(typ,zx,zien) ; extrinsic return 1 if resource was loaded
"RTN","SYNFALG",229,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFALG",230,0)
 n rt s rt=0
"RTN","SYNFALG",231,0)
 i $g(zx)="" i $d(@root@(zien,"load",typ)) s rt=1 q rt
"RTN","SYNFALG",232,0)
 i $get(@root@(zien,"load",typ,zx,"status","loadstatus"))="loaded" s rt=1
"RTN","SYNFALG",233,0)
 q rt
"RTN","SYNFALG",234,0)
 ;
"RTN","SYNFALG",235,0)
testall ; run the allergy import on all imported patients
"RTN","SYNFALG",236,0)
 new root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFALG",237,0)
 new indx s indx=$na(@root@("POS","DFN"))
"RTN","SYNFALG",238,0)
 n dfn,ien,filter,reslt
"RTN","SYNFALG",239,0)
 s dfn=0
"RTN","SYNFALG",240,0)
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  d  ;
"RTN","SYNFALG",241,0)
 . s ien=$o(@indx@(dfn,""))
"RTN","SYNFALG",242,0)
 . q:ien=""
"RTN","SYNFALG",243,0)
 . s filter("dfn")=dfn
"RTN","SYNFALG",244,0)
 . k reslt
"RTN","SYNFALG",245,0)
 . d wsIntakeAllergy(.filter,,.reslt,ien)
"RTN","SYNFALG",246,0)
 q
"RTN","SYNFALG",247,0)
 ;
"RTN","SYNFALG",248,0)
testone(reslt,doload) ; run the allergy import on one imported patient
"RTN","SYNFALG",249,0)
 new root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFALG",250,0)
 new indx s indx=$na(@root@("POS","DFN"))
"RTN","SYNFALG",251,0)
 n dfn,ien,filter
"RTN","SYNFALG",252,0)
 n done s done=0
"RTN","SYNFALG",253,0)
 s dfn=0
"RTN","SYNFALG",254,0)
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  q:done   d  ;
"RTN","SYNFALG",255,0)
 . s ien=$o(@indx@(dfn,""))
"RTN","SYNFALG",256,0)
 . q:ien=""
"RTN","SYNFALG",257,0)
 . q:$d(@root@(ien,"load","allergy"))
"RTN","SYNFALG",258,0)
 . s filter("dfn")=dfn
"RTN","SYNFALG",259,0)
 . s filter("debug")=1
"RTN","SYNFALG",260,0)
 . i $g(doload)=1 s filter("load")=1
"RTN","SYNFALG",261,0)
 . k reslt
"RTN","SYNFALG",262,0)
 . d wsIntakeAllergy(.filter,,.reslt,ien)
"RTN","SYNFALG",263,0)
 . s done=1
"RTN","SYNFALG",264,0)
 q
"RTN","SYNFALG",265,0)
 ;
"RTN","SYNFALG",266,0)
getRandomAllergy(ary) ; make a web service call to get random allergies
"RTN","SYNFALG",267,0)
 n srvr
"RTN","SYNFALG",268,0)
 s srvr="http://postfhir.vistaplex.org:9080/"
"RTN","SYNFALG",269,0)
 i srvr["postfhir.vistaplex.org" s srvr="http://138.197.70.229:9080/"
"RTN","SYNFALG",270,0)
 i $g(^%WURL)["http://postfhir.vistaplex.org:9080" d  q  ;
"RTN","SYNFALG",271,0)
 . s srvr="localhost:9080/"
"RTN","SYNFALG",272,0)
 . n url
"RTN","SYNFALG",273,0)
 . s url=srvr_"randomAllergy"
"RTN","SYNFALG",274,0)
 . n ok,r1
"RTN","SYNFALG",275,0)
 . s ok=$$%^%WC(.r1,"GET",url)
"RTN","SYNFALG",276,0)
 . i '$d(r1) q  ;
"RTN","SYNFALG",277,0)
 . d DECODE^VPRJSON("r1","ary")
"RTN","SYNFALG",278,0)
 n url
"RTN","SYNFALG",279,0)
 s url=srvr_"randomAllergy"
"RTN","SYNFALG",280,0)
 n ret,json,jtmp
"RTN","SYNFALG",281,0)
 s ret=$$GETURL^XTHC10(url,,"jtmp")
"RTN","SYNFALG",282,0)
 d assemble^SYNFPUL("jtmp","json")
"RTN","SYNFALG",283,0)
 i '$d(json) q  ;
"RTN","SYNFALG",284,0)
 d DECODE^VPRJSON("json","ary")
"RTN","SYNFALG",285,0)
 q
"RTN","SYNFALG",286,0)
 ;
"RTN","SYNFALG",287,0)
ISGMR(CDE) ; extrinsic return the ien and allergy name in GMR ALLERGIES if any
"RTN","SYNFALG",288,0)
 ; CDE is a snomed code. returns -1 if not found
"RTN","SYNFALG",289,0)
 N VUID
"RTN","SYNFALG",290,0)
 S VUID=$$MAP^SYNQLDM(CDE)
"RTN","SYNFALG",291,0)
 ;W !,CDE," VUID:",VUID
"RTN","SYNFALG",292,0)
 I VUID="" Q -1
"RTN","SYNFALG",293,0)
 N IEN
"RTN","SYNFALG",294,0)
 S IEN=$O(^GMRD(120.82,"AVUID",VUID,""))
"RTN","SYNFALG",295,0)
 I IEN="" Q -1
"RTN","SYNFALG",296,0)
 N R1 S R1=IEN_"^"_$$GET1^DIQ(120.82,IEN_",",.01)
"RTN","SYNFALG",297,0)
 Q R1
"RTN","SYNFALG",298,0)
 ;
"RTN","SYNFALG",299,0)
QADDALGY(ALGY,ADATE,ien) ; adds an allergy to the queue to be processed
"RTN","SYNFALG",300,0)
 ; used by Problems processing include allergies in VistA allergies
"RTN","SYNFALG",301,0)
 ; ALGY is the name of the allergy. ADATE is the date of the allergy
"RTN","SYNFALG",302,0)
 ; ien is the patient being processed
"RTN","SYNFALG",303,0)
 i '$d(ien) q  ;
"RTN","SYNFALG",304,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFALG",305,0)
 n groot s groot=$na(@root@(ien,"load","ALLERGY2ADD"))
"RTN","SYNFALG",306,0)
 n aien s aien=$o(@groot@(" "),-1)+1
"RTN","SYNFALG",307,0)
 s @groot@(aien,"allergy")=$g(ALGY)
"RTN","SYNFALG",308,0)
 s @groot@(aien,"date")=$g(ADATE)
"RTN","SYNFALG",309,0)
 q
"RTN","SYNFALG",310,0)
 ;
"RTN","SYNFALG2")
0^24^B58295470
"RTN","SYNFALG2",1,0)
SYNFALG2 ;ven/gpl - fhir loader utilities ; 2/20/18 4:11am
"RTN","SYNFALG2",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNFALG2",3,0)
 ;
"RTN","SYNFALG2",4,0)
 ; Authored by George P. Lilly 2017-2018
"RTN","SYNFALG2",5,0)
 ; (c) Sam Habiel 2018
"RTN","SYNFALG2",6,0)
 ;
"RTN","SYNFALG2",7,0)
 QUIT
"RTN","SYNFALG2",8,0)
 ;
"RTN","SYNFALG2",9,0)
MEDALGY(dfn,root,json,zi,eval,jlog,args) ; allergy is rxnorm
"RTN","SYNFALG2",10,0)
 ;
"RTN","SYNFALG2",11,0)
 n SYNDFN,SYNRXN,SYNDF,SYNPA,SYNDUZ,SYNSS,SYNDATE,SYNCOMM
"RTN","SYNFALG2",12,0)
 ;
"RTN","SYNFALG2",13,0)
 S SYNDFN=dfn
"RTN","SYNFALG2",14,0)
 d log(jlog,"Patient DFN: "_SYNDFN)
"RTN","SYNFALG2",15,0)
 s eval("allergy",zi,"vars","dfn")=SYNDFN
"RTN","SYNFALG2",16,0)
 ;
"RTN","SYNFALG2",17,0)
 s SYNRXN=$get(json("entry",zi,"resource","code","coding",1,"code"))
"RTN","SYNFALG2",18,0)
 d log(jlog,"Allergin is RxNorm: "_SYNRXN)
"RTN","SYNFALG2",19,0)
 set eval("allergy",zi,"vars","code")=SYNRXN
"RTN","SYNFALG2",20,0)
 ;
"RTN","SYNFALG2",21,0)
 S SYNDUZ=$$USERDUZ
"RTN","SYNFALG2",22,0)
 d log(jlog,"Provider DUZ: "_SYNDUZ)
"RTN","SYNFALG2",23,0)
 s eval("allergy",zi,"vars","duz")=SYNDUZ
"RTN","SYNFALG2",24,0)
 ;
"RTN","SYNFALG2",25,0)
 new onsetdate set onsetdate=$get(json("entry",zi,"resource","assertedDate"))
"RTN","SYNFALG2",26,0)
 do log(jlog,"onsetDateTime is: "_onsetdate)
"RTN","SYNFALG2",27,0)
 set eval("allergy",zi,"vars","onsetDateTime")=onsetdate
"RTN","SYNFALG2",28,0)
 new fmOnsetDateTime s fmOnsetDateTime=$$fhirTfm^SYNFUTL(onsetdate)
"RTN","SYNFALG2",29,0)
 i $l(fmOnsetDateTime)=14 s fmOnsetDateTime=$e(fmOnsetDateTime,1,12)
"RTN","SYNFALG2",30,0)
 d log(jlog,"fileman onsetDateTime is: "_fmOnsetDateTime)
"RTN","SYNFALG2",31,0)
 set eval("allergy",zi,"vars","fmOnsetDateTime")=fmOnsetDateTime ;
"RTN","SYNFALG2",32,0)
 S SYNDATE=fmOnsetDateTime
"RTN","SYNFALG2",33,0)
 ;
"RTN","SYNFALG2",34,0)
 s eval("allergy",zi,"status","loadstatus")="readyToLoad"
"RTN","SYNFALG2",35,0)
 ;
"RTN","SYNFALG2",36,0)
 if $g(args("load"))=1 d  ; only load if told to
"RTN","SYNFALG2",37,0)
 . n ien s ien=$$dfn2ien^SYNFUTL(dfn) ;
"RTN","SYNFALG2",38,0)
 . if $g(ien)'="" if $$loadStatus^SYNFALG("allergy",zi,ien)=1 do  quit  ;
"RTN","SYNFALG2",39,0)
 . . d log(jlog,"Allergy already loaded, skipping")
"RTN","SYNFALG2",40,0)
 . d log(jlog,"Calling ADDMEDADR^SYNFALG2 to add allergy")
"RTN","SYNFALG2",41,0)
 . n ok
"RTN","SYNFALG2",42,0)
 . s ok=$$ADDMEDADR(SYNDFN,SYNRXN,,,SYNDUZ,,SYNDATE) ;
"RTN","SYNFALG2",43,0)
 . m eval("allergy",zi,"status")=ok
"RTN","SYNFALG2",44,0)
 . d log(jlog,"Return from data loader was: "_ok)
"RTN","SYNFALG2",45,0)
 . if +$g(ok)=1 do  ;
"RTN","SYNFALG2",46,0)
 . . s eval("status","loaded")=$g(eval("status","loaded"))+1
"RTN","SYNFALG2",47,0)
 . . s eval("allergy",zi,"status","loadstatus")="loaded"
"RTN","SYNFALG2",48,0)
 . else  d  ;
"RTN","SYNFALG2",49,0)
 . . s eval("status","errors")=$g(eval("status","errors"))+1
"RTN","SYNFALG2",50,0)
 . . s eval("allergy",zi,"status","loadstatus")="notLoaded"
"RTN","SYNFALG2",51,0)
 . . s eval("allergy",zi,"status","loadMessage")=ok
"RTN","SYNFALG2",52,0)
 . n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFALG2",53,0)
 . i $g(ien)'="" d  ;
"RTN","SYNFALG2",54,0)
 . . k @root@(ien,"load","allergy",zi)
"RTN","SYNFALG2",55,0)
 . . m @root@(ien,"load","allergy",zi)=eval("allergy",zi)
"RTN","SYNFALG2",56,0)
 ;
"RTN","SYNFALG2",57,0)
 q
"RTN","SYNFALG2",58,0)
 ;
"RTN","SYNFALG2",59,0)
USERDUZ() ; extrinsic returning the DUZ of the user
"RTN","SYNFALG2",60,0)
 n npi,duz
"RTN","SYNFALG2",61,0)
 s npi=$$MAP^SYNQLDM("OP","provider") ; map should return the NPI number
"RTN","SYNFALG2",62,0)
 s duz=$O(^VA(200,"ANPI",npi,""))
"RTN","SYNFALG2",63,0)
 q duz
"RTN","SYNFALG2",64,0)
 ;
"RTN","SYNFALG2",65,0)
log(ary,txt) ; adds a text line to @ary@("log")
"RTN","SYNFALG2",66,0)
 s @ary@("log",$o(@ary@("log",""),-1)+1)=$g(txt)
"RTN","SYNFALG2",67,0)
 q
"RTN","SYNFALG2",68,0)
 ;
"RTN","SYNFALG2",69,0)
ADDMEDADR(SYNDFN,SYNRXN,SYNDF,SYNPA,SYNDUZ,SYNSS,SYNDATE,SYNCOMM) ; [Public] Add an allergy/adrxn using a Medications RxNorm Code
"RTN","SYNFALG2",70,0)
 ; Uses IA#4682 to record an allergy in the patient's chart
"RTN","SYNFALG2",71,0)
 ;
"RTN","SYNFALG2",72,0)
 ; Input:
"RTN","SYNFALG2",73,0)
 ; - SYNDFN   (r) = DFN
"RTN","SYNFALG2",74,0)
 ; - SYNRXN   (r) = RxNorm Ingredient or Clinical Drug code
"RTN","SYNFALG2",75,0)
 ; - SYNDF    (o) = "D"rug or "F"ood
"RTN","SYNFALG2",76,0)
 ; - SYNPA    (o) = Nature of Reaction: "P"harmacologic or "A"llergic
"RTN","SYNFALG2",77,0)
 ; - SYNDUZ   (o) = Recorder of reaction
"RTN","SYNFALG2",78,0)
 ; - SYNSS    (o) = ";" delimited list of signs and symptoms
"RTN","SYNFALG2",79,0)
 ; - SYNDATE  (o) = Date of recording of signs and symptoms
"RTN","SYNFALG2",80,0)
 ; - .SYNCOMM (o) = Comments in 1,2,3 etc passed by reference
"RTN","SYNFALG2",81,0)
 ;
"RTN","SYNFALG2",82,0)
 ; Output:
"RTN","SYNFALG2",83,0)
 ; - Can be called as a routine; but you won't get any error information
"RTN","SYNFALG2",84,0)
 ; - with $$, you will get:
"RTN","SYNFALG2",85,0)
 ; - 0^note to sign (if any) or -1^error message
"RTN","SYNFALG2",86,0)
 ;
"RTN","SYNFALG2",87,0)
 ; Translate RXN to VUID
"RTN","SYNFALG2",88,0)
 ; get VUIDs
"RTN","SYNFALG2",89,0)
 ; Output like this: 50.6~4030995
"RTN","SYNFALG2",90,0)
 ; or -1^message
"RTN","SYNFALG2",91,0)
 n fileVUIDs s fileVUIDs=$$ETSRXN2VUID^SYNFMED(SYNRXN)
"RTN","SYNFALG2",92,0)
 i fileVUIDs<0 quit fileVUIDs
"RTN","SYNFALG2",93,0)
 ;
"RTN","SYNFALG2",94,0)
 ; Get the first one
"RTN","SYNFALG2",95,0)
 n firstFileVUID s firstFileVUID=$P(fileVUIDs,U)
"RTN","SYNFALG2",96,0)
 ;
"RTN","SYNFALG2",97,0)
 ; Error if not found
"RTN","SYNFALG2",98,0)
 if firstFileVUID="" quit:$quit "-2^no-suitable-vuid-term-was-CD-or-IN" quit
"RTN","SYNFALG2",99,0)
 ;
"RTN","SYNFALG2",100,0)
 kill ^TMP("SYN",$J) ; we put all the reactant info here
"RTN","SYNFALG2",101,0)
 ;
"RTN","SYNFALG2",102,0)
 ; find variable pointer
"RTN","SYNFALG2",103,0)
 new synvuid ; For Searching Compound Index
"RTN","SYNFALG2",104,0)
 set synvuid(1)=$p(firstFileVUID,"~",2)
"RTN","SYNFALG2",105,0)
 set synvuid(2)=1
"RTN","SYNFALG2",106,0)
 new file set file=$p(firstFileVUID,"~",1)
"RTN","SYNFALG2",107,0)
 if 'file set $ec=",u-no-supposed-to-happen,"
"RTN","SYNFALG2",108,0)
 new ien set ien=$$FIND1^DIC(file,"","XQ",.synvuid,"AMASTERVUID")
"RTN","SYNFALG2",109,0)
 if 'ien quit:$quit "-3^VUID-not-found. Is your NDF up to date?" quit
"RTN","SYNFALG2",110,0)
 ;
"RTN","SYNFALG2",111,0)
 new drugName set drugName=$$GET1^DIQ(file,ien,.01)
"RTN","SYNFALG2",112,0)
 ;
"RTN","SYNFALG2",113,0)
 ; load the data into the global for the API
"RTN","SYNFALG2",114,0)
 set ^TMP("SYN",$J,"GMRAGNT")=drugName_U_ien_";"_$piece($$ROOT^DILFD(file),U,2) ; variable pointer syntax
"RTN","SYNFALG2",115,0)
 set ^TMP("SYN",$J,"GMRATYPE")=$G(SYNDF,"D") ; Allergen type: Drug OR Food (D or F)
"RTN","SYNFALG2",116,0)
 set ^TMP("SYN",$J,"GMRANATR")=$G(SYNPA,"U") ; nature of reaction: Allergic or Pharmacologic (default unknown)
"RTN","SYNFALG2",117,0)
 set ^TMP("SYN",$J,"GMRAORIG")=$G(SYNDUZ,DUZ) ; Originator
"RTN","SYNFALG2",118,0)
 set ^TMP("SYN",$J,"GMRAORDT")=$G(SYNDATE,DT) ; Date of recording of reaction (not date of reaction)
"RTN","SYNFALG2",119,0)
 new ssErr set ssErr=0
"RTN","SYNFALG2",120,0)
 if $get(SYNSS)]"" do
"RTN","SYNFALG2",121,0)
 . set ^TMP("SYN",$J,"GMRASYMP",0)=$L(SYNSS,";") ; Signs and symptoms need to be entered by IENs
"RTN","SYNFALG2",122,0)
 . new i for i=1:1:$l(SYNSS,";") do  q:ssErr  ; put signs and symptoms in 1,2,3 etc
"RTN","SYNFALG2",123,0)
 .. new ssIEN set ssIEN=$$FIND1^DIC(120.83,,"QX",$piece(SYNSS,";",i),"B")
"RTN","SYNFALG2",124,0)
 .. if 'ssIEN set ssErr=1
"RTN","SYNFALG2",125,0)
 .. set ^TMP("SYN",$J,"GMRASYMP",i)=ssIEN_U_$piece(SYNSS,";",i)
"RTN","SYNFALG2",126,0)
 i ssErr quit:$quit "-4^one or more signs/symptoms cannot be found" quit
"RTN","SYNFALG2",127,0)
 set ^TMP("SYN",$J,"GMRACHT",0)=1 ; marked in chart
"RTN","SYNFALG2",128,0)
 set ^TMP("SYN",$J,"GMRACHT",1)=$$NOW^XLFDT() ; marked now
"RTN","SYNFALG2",129,0)
 set ^TMP("SYN",$J,"GMRAOBHX")="h" ; historical. No sense in doing "observed"
"RTN","SYNFALG2",130,0)
 if $data(SYNCOMM) merge ^TMP("SYN",$J,"GMRACMTS")=SYNCOMM
"RTN","SYNFALG2",131,0)
 ;
"RTN","SYNFALG2",132,0)
 ; call the API
"RTN","SYNFALG2",133,0)
 N ORY
"RTN","SYNFALG2",134,0)
 D UPDATE^GMRAGUI1(0,SYNDFN,$NA(^TMP("SYN",$J)))
"RTN","SYNFALG2",135,0)
 ;
"RTN","SYNFALG2",136,0)
 ; API return -1^message or 0^note to sign
"RTN","SYNFALG2",137,0)
 if $piece(ORY,U)=-1 quit:$quit -5_U_$piece(ORY,U,2) quit
"RTN","SYNFALG2",138,0)
 quit:$quit 0_U_$piece(ORY,U,2)
"RTN","SYNFALG2",139,0)
 quit
"RTN","SYNFALG2",140,0)
 ;
"RTN","SYNFALG2",141,0)
TEST D EN^%ut($T(+0),3) quit
"RTN","SYNFALG2",142,0)
STARTUP ; M-UNIT STARTUP
"RTN","SYNFALG2",143,0)
 ; Delete all traces of patients allergies from DFN 1
"RTN","SYNFALG2",144,0)
 ; ZEXCEPT: DFN
"RTN","SYNFALG2",145,0)
 S DFN=1
"RTN","SYNFALG2",146,0)
 N DIK,DA
"RTN","SYNFALG2",147,0)
 S DIK=$$ROOT^DILFD(120.86),DA=DFN D ^DIK
"RTN","SYNFALG2",148,0)
 S DIK="^GMR(120.8,"
"RTN","SYNFALG2",149,0)
 S DA=0
"RTN","SYNFALG2",150,0)
 F  S DA=$O(^GMR(120.8,"B",1,DA)) Q:'DA  D ^DIK
"RTN","SYNFALG2",151,0)
 QUIT
"RTN","SYNFALG2",152,0)
 ;
"RTN","SYNFALG2",153,0)
TADDMEDADR1 ; @TEST Simple allergen NOS - Contraceptive CD.
"RTN","SYNFALG2",154,0)
 ; ZEXCEPT: DFN
"RTN","SYNFALG2",155,0)
 N % S %=$$ADDMEDADR(DFN,831533)
"RTN","SYNFALG2",156,0)
 D CHKTF^%ut(+%=0)
"RTN","SYNFALG2",157,0)
 quit
"RTN","SYNFALG2",158,0)
 ;
"RTN","SYNFALG2",159,0)
TADDMEDADR2 ; @TEST Allergen as "food" (really penicillin IN)
"RTN","SYNFALG2",160,0)
 ; ZEXCEPT: DFN
"RTN","SYNFALG2",161,0)
 N % S %=$$ADDMEDADR(DFN,70618,"F")
"RTN","SYNFALG2",162,0)
 D CHKTF^%ut(+%=0)
"RTN","SYNFALG2",163,0)
 quit
"RTN","SYNFALG2",164,0)
 ;
"RTN","SYNFALG2",165,0)
TADDMEDADR3 ; @TEST Pharmacological or Allergic (Simvastatin CD)
"RTN","SYNFALG2",166,0)
 ; ZEXCEPT: DFN
"RTN","SYNFALG2",167,0)
 N % S %=$$ADDMEDADR(DFN,198211,"D","P")
"RTN","SYNFALG2",168,0)
 D CHKTF^%ut(+%=0)
"RTN","SYNFALG2",169,0)
 quit
"RTN","SYNFALG2",170,0)
 ;
"RTN","SYNFALG2",171,0)
TADDMEDADR4 ; @TEST Different Originator (Tamoxifen CD)
"RTN","SYNFALG2",172,0)
 ; ZEXCEPT: DFN
"RTN","SYNFALG2",173,0)
 N ORIG S ORIG=$O(^XUSEC("PROVIDER",""))
"RTN","SYNFALG2",174,0)
 N % S %=$$ADDMEDADR(DFN,313195,"D","P",ORIG)
"RTN","SYNFALG2",175,0)
 D CHKTF^%ut(+%=0)
"RTN","SYNFALG2",176,0)
 quit
"RTN","SYNFALG2",177,0)
 ;
"RTN","SYNFALG2",178,0)
TADDMEDADR5 ; @TEST Different Origination date (Aliskiren/Amlodipine IN)
"RTN","SYNFALG2",179,0)
 ; ZEXCEPT: DFN
"RTN","SYNFALG2",180,0)
 N ORIG S ORIG=$O(^XUSEC("PROVIDER",""))
"RTN","SYNFALG2",181,0)
 N % S %=$$ADDMEDADR(DFN,1009219,"D","P",ORIG,,$$FMADD^XLFDT(DT,-120))
"RTN","SYNFALG2",182,0)
 D CHKTF^%ut(+%=0)
"RTN","SYNFALG2",183,0)
 quit
"RTN","SYNFALG2",184,0)
 ;
"RTN","SYNFALG2",185,0)
TADDMEDADR6 ; @TEST Signs and symptoms singular (Cephalexin CD)
"RTN","SYNFALG2",186,0)
 ; ZEXCEPT: DFN
"RTN","SYNFALG2",187,0)
 N ORIG S ORIG=$O(^XUSEC("PROVIDER",""))
"RTN","SYNFALG2",188,0)
 N % S %=$$ADDMEDADR(DFN,309110,"D","A",ORIG,"HIVES",$$FMADD^XLFDT(DT,-120))
"RTN","SYNFALG2",189,0)
 D CHKTF^%ut(+%=0)
"RTN","SYNFALG2",190,0)
 quit
"RTN","SYNFALG2",191,0)
 ;
"RTN","SYNFALG2",192,0)
TADDMEDADR7 ; @TEST Signs and symptoms plural (Cephalexin IN)
"RTN","SYNFALG2",193,0)
 ; ZEXCEPT: DFN
"RTN","SYNFALG2",194,0)
 N ORIG S ORIG=$O(^XUSEC("PROVIDER",""))
"RTN","SYNFALG2",195,0)
 N % S %=$$ADDMEDADR(DFN,2231,"D","A",ORIG,"HIVES;RHINITIS;WHEEZING",$$FMADD^XLFDT(DT,-120))
"RTN","SYNFALG2",196,0)
 D CHKTF^%ut(+%=0)
"RTN","SYNFALG2",197,0)
 quit
"RTN","SYNFALG2",198,0)
 ;
"RTN","SYNFALG2",199,0)
TADDMEDADR8 ; @TEST Comments (Levothyroxine IN)
"RTN","SYNFALG2",200,0)
 ; ZEXCEPT: DFN
"RTN","SYNFALG2",201,0)
 N ORIG S ORIG=$O(^XUSEC("PROVIDER",""))
"RTN","SYNFALG2",202,0)
 N COMM S COMM(1)="This seems to only happen with specific forumlations of Synthroid"
"RTN","SYNFALG2",203,0)
 S COMM(2)="I think it's just the 125mcg (pink one)"
"RTN","SYNFALG2",204,0)
 N % S %=$$ADDMEDADR(DFN,10582,"D","A",ORIG,"HIVES;RHINITIS;WHEEZING",$$FMADD^XLFDT(DT,-120),.COMM)
"RTN","SYNFALG2",205,0)
 D CHKTF^%ut(+%=0)
"RTN","SYNFALG2",206,0)
 quit
"RTN","SYNFALG2",207,0)
 ;
"RTN","SYNFALG2",208,0)
TADDMEDERR1 ; @TEST Test error messages: -1 Bad Rxn
"RTN","SYNFALG2",209,0)
 ; ZEXCEPT: DFN
"RTN","SYNFALG2",210,0)
 N % S %=$$ADDMEDADR(DFN,83153328978194871234)
"RTN","SYNFALG2",211,0)
 D CHKTF^%ut(+%=-1)
"RTN","SYNFALG2",212,0)
 quit
"RTN","SYNFALG2",213,0)
TADDMEDERR2 ; @TEST Test error messages: -2 No VUID for Rxn - too hard
"RTN","SYNFALG2",214,0)
 ; ZEXCEPT: DFN
"RTN","SYNFALG2",215,0)
 quit
"RTN","SYNFALG2",216,0)
 ;
"RTN","SYNFALG2",217,0)
TADDMEDERR3 ; @TEST Test error messages: -3 NDF product cannot be found - too hard
"RTN","SYNFALG2",218,0)
 ; ZEXCEPT: DFN
"RTN","SYNFALG2",219,0)
 quit
"RTN","SYNFALG2",220,0)
 ;
"RTN","SYNFALG2",221,0)
TADDMEDERR4 ; @TEST Test error messages: -4 Bad S/S
"RTN","SYNFALG2",222,0)
 ; ZEXCEPT: DFN
"RTN","SYNFALG2",223,0)
 N ORIG S ORIG=$O(^XUSEC("PROVIDER",""))
"RTN","SYNFALG2",224,0)
 N % S %=$$ADDMEDADR(DFN,309110,"D","A",ORIG,"OIUSLDFKJLSKDJF",$$FMADD^XLFDT(DT,-120))
"RTN","SYNFALG2",225,0)
 D CHKTF^%ut(+%=-4)
"RTN","SYNFALG2",226,0)
 quit
"RTN","SYNFALG2",227,0)
 ;
"RTN","SYNFALG2",228,0)
TADDMEDERR5 ; @TEST Test error message: -5 API error
"RTN","SYNFALG2",229,0)
 ; ZEXCEPT: DFN
"RTN","SYNFALG2",230,0)
 N ORIG S ORIG=$O(^XUSEC("PROVIDER",""))
"RTN","SYNFALG2",231,0)
 N % S %=$$ADDMEDADR(DFN,2231,"D","A",ORIG,"HIVES;RHINITIS;WHEEZING",$$FMADD^XLFDT(DT,-120))
"RTN","SYNFALG2",232,0)
 D CHKTF^%ut(+%=-5)
"RTN","SYNFALG2",233,0)
 quit
"RTN","SYNFALG2",234,0)
 ;
"RTN","SYNFALG2",235,0)
SHUTDOWN ; M-UNIT SHUTDOWN
"RTN","SYNFALG2",236,0)
 ; ZEXCEPT: DFN
"RTN","SYNFALG2",237,0)
 K DFN
"RTN","SYNFALG2",238,0)
 QUIT
"RTN","SYNFALG2",239,0)
 ;
"RTN","SYNFAPT")
0^25^B89983171
"RTN","SYNFAPT",1,0)
SYNFAPT ;ven/gpl - fhir loader utilities ;2018-08-17  3:25 PM
"RTN","SYNFAPT",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNFAPT",3,0)
 ;
"RTN","SYNFAPT",4,0)
 ; Authored by George P. Lilly 2017-2018
"RTN","SYNFAPT",5,0)
 ;
"RTN","SYNFAPT",6,0)
 q
"RTN","SYNFAPT",7,0)
 ;
"RTN","SYNFAPT",8,0)
importAppointment(rtn,ien,args) ; entry point for loading Appointment for a patient
"RTN","SYNFAPT",9,0)
 ; calls the intake Appointment web service directly
"RTN","SYNFAPT",10,0)
 ;
"RTN","SYNFAPT",11,0)
 n grtn
"RTN","SYNFAPT",12,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFAPT",13,0)
 d wsIntakeAppointment(.args,,.grtn,ien)
"RTN","SYNFAPT",14,0)
 i $d(grtn) d  ; something was returned
"RTN","SYNFAPT",15,0)
 . k @root@(ien,"load","appointment")
"RTN","SYNFAPT",16,0)
 . m @root@(ien,"load","appointment")=grtn("appointment")
"RTN","SYNFAPT",17,0)
 . if $g(args("debug"))=1 m rtn=grtn
"RTN","SYNFAPT",18,0)
 s rtn("conditionsStatus","status")=$g(grtn("status","status"))
"RTN","SYNFAPT",19,0)
 s rtn("conditionsStatus","loaded")=$g(grtn("status","loaded"))
"RTN","SYNFAPT",20,0)
 s rtn("conditionsStatus","errors")=$g(grtn("status","errors"))
"RTN","SYNFAPT",21,0)
 ;b
"RTN","SYNFAPT",22,0)
 ;
"RTN","SYNFAPT",23,0)
 ;
"RTN","SYNFAPT",24,0)
 q
"RTN","SYNFAPT",25,0)
 ;
"RTN","SYNFAPT",26,0)
wsIntakeAppointment(args,body,result,ien)       ; web service entry (post)
"RTN","SYNFAPT",27,0)
 ; for intake of one or more Appointment. input are fhir resources
"RTN","SYNFAPT",28,0)
 ; result is json and summarizes what was done
"RTN","SYNFAPT",29,0)
 ; args include patientId
"RTN","SYNFAPT",30,0)
 ; ien is specified for internal calls, where the json is already in a graph
"RTN","SYNFAPT",31,0)
 n jtmp,json,jrslt,eval
"RTN","SYNFAPT",32,0)
 i $g(ien)'="" d  ; internal call
"RTN","SYNFAPT",33,0)
 . d getIntakeFhir^SYNFHIR("json",,"Appointment",ien,1)
"RTN","SYNFAPT",34,0)
 e  d  ; 
"RTN","SYNFAPT",35,0)
 . s args("load")=0
"RTN","SYNFAPT",36,0)
 . merge jtmp=BODY
"RTN","SYNFAPT",37,0)
 . do DECODE^VPRJSON("jtmp","json")
"RTN","SYNFAPT",38,0)
 ;if '$d(json) d  ; if no appointment, get a random set of appointments
"RTN","SYNFAPT",39,0)
 ;. d getRandomApt(.json) ; get a random set of appointments
"RTN","SYNFAPT",40,0)
 i '$d(json) q  ;
"RTN","SYNFAPT",41,0)
 m ^gpl("gjson")=json
"RTN","SYNFAPT",42,0)
 ;b
"RTN","SYNFAPT",43,0)
 ;
"RTN","SYNFAPT",44,0)
 ; determine the patient
"RTN","SYNFAPT",45,0)
 ;
"RTN","SYNFAPT",46,0)
 n dfn,eval
"RTN","SYNFAPT",47,0)
 if $g(ien)'="" d  ;
"RTN","SYNFAPT",48,0)
 . s dfn=$$ien2dfn^SYNFUTL(ien) ; look up dfn in the graph
"RTN","SYNFAPT",49,0)
 else  d  ;
"RTN","SYNFAPT",50,0)
 . s dfn=$g(args("dfn"))
"RTN","SYNFAPT",51,0)
 . i dfn="" d  ;
"RTN","SYNFAPT",52,0)
 . . n icn s icn=$g(args("icn"))
"RTN","SYNFAPT",53,0)
 . . i icn'="" s dfn=$$icn2dfn^SYNFUTL(icn)
"RTN","SYNFAPT",54,0)
 i $g(dfn)="" do  quit  ; need the patient
"RTN","SYNFAPT",55,0)
 . s result("appointment",1,"log",1)="Error, patient not found.. terminating"
"RTN","SYNFAPT",56,0)
 ;
"RTN","SYNFAPT",57,0)
 ;
"RTN","SYNFAPT",58,0)
 new zi s zi=0
"RTN","SYNFAPT",59,0)
 for  set zi=$order(json("entry",zi)) quit:+zi=0  do  ;
"RTN","SYNFAPT",60,0)
 . ;
"RTN","SYNFAPT",61,0)
 . ; define a place to log the processing of this entry
"RTN","SYNFAPT",62,0)
 . ;
"RTN","SYNFAPT",63,0)
 . new jlog set jlog=$name(eval("appointment",zi))
"RTN","SYNFAPT",64,0)
 . ;
"RTN","SYNFAPT",65,0)
 . ; insure that the resourceType is Apppointment
"RTN","SYNFAPT",66,0)
 . ;
"RTN","SYNFAPT",67,0)
 . new type set type=$get(json("entry",zi,"resource","resourceType"))
"RTN","SYNFAPT",68,0)
 . if type'="Appointment" do  quit  ;
"RTN","SYNFAPT",69,0)
 . . set eval("appointment",zi,"vars","resourceType")=type
"RTN","SYNFAPT",70,0)
 . . do log(jlog,"Resource type not Appointment, skipping entry")
"RTN","SYNFAPT",71,0)
 . set eval("appointment",zi,"vars","resourceType")=type
"RTN","SYNFAPT",72,0)
 . ;
"RTN","SYNFAPT",73,0)
 . ; see if this resource has already been loaded. if so, skip it
"RTN","SYNFAPT",74,0)
 . ;
"RTN","SYNFAPT",75,0)
 . if $g(ien)'="" if $$loadStatus("appointment",zi,ien)=1 do  quit  ;
"RTN","SYNFAPT",76,0)
 . . d log(jlog,"Appointment already loaded, skipping")
"RTN","SYNFAPT",77,0)
 . ;
"RTN","SYNFAPT",78,0)
 . ; determine the id of the resource
"RTN","SYNFAPT",79,0)
 . ;
"RTN","SYNFAPT",80,0)
 . ;new id set id=$get(json("entry",zi,"resource","id"))
"RTN","SYNFAPT",81,0)
 . ;set eval("appointment",zi,"vars","id")=id
"RTN","SYNFAPT",82,0)
 . ;d log(jlog,"ID is: "_id)
"RTN","SYNFAPT",83,0)
 . ;
"RTN","SYNFAPT",84,0)
 . ; determine the onset date and time
"RTN","SYNFAPT",85,0)
 . ;
"RTN","SYNFAPT",86,0)
 . new startdate set startdate=$get(json("entry",zi,"resource","start"))
"RTN","SYNFAPT",87,0)
 . do log(jlog,"startDateTime is: "_startdate)
"RTN","SYNFAPT",88,0)
 . set eval("appointment",zi,"vars","startDateTime")=startdate
"RTN","SYNFAPT",89,0)
 . new fmStartDateTime s fmStartDateTime=$$fhirTfm^SYNFUTL(startdate)
"RTN","SYNFAPT",90,0)
 . d log(jlog,"fileman startDateTime is: "_fmStartDateTime)
"RTN","SYNFAPT",91,0)
 . set eval("appointment",zi,"vars","fmStarttDateTime")=fmStartDateTime ;
"RTN","SYNFAPT",92,0)
 . new hl7StartDateTime s hl7StartDateTime=$$fhirThl7^SYNFUTL(startdate)
"RTN","SYNFAPT",93,0)
 . d log(jlog,"hl7 startDateTime is: "_hl7StartDateTime)
"RTN","SYNFAPT",94,0)
 . set eval("appointment",zi,"vars","hl7StartDateTime")=hl7StartDateTime ;
"RTN","SYNFAPT",95,0)
 . ;
"RTN","SYNFAPT",96,0)
 . ; determine clinical status (active vs inactive)
"RTN","SYNFAPT",97,0)
 . ;
"RTN","SYNFAPT",98,0)
 . n clinicalstatus set clinicalstatus=$get(json("entry",zi,"resource","status"))
"RTN","SYNFAPT",99,0)
 . ;
"RTN","SYNFAPT",100,0)
 . ; set up to call the data loader
"RTN","SYNFAPT",101,0)
 . ;
"RTN","SYNFAPT",102,0)
 . ;APPTADD(RETSTA,DHPPAT,DHPCLIN,DHPAPTDT,DHPLEN) ;Create appointment
"RTN","SYNFAPT",103,0)
 . ;
"RTN","SYNFAPT",104,0)
 . ; Input:
"RTN","SYNFAPT",105,0)
 . ;   DHPPAT   - Patient ICN (required)
"RTN","SYNFAPT",106,0)
 . ;   DHPCLIN  - Clinic Name (required)
"RTN","SYNFAPT",107,0)
 . ;   DHPAPTDT - Appointment Date & Time (required) all dates received in HL7 format
"RTN","SYNFAPT",108,0)
 . ;   DHPLEN   - Appointment length as minutes (optional, defaults to 15 mins.)
"RTN","SYNFAPT",109,0)
 . ;
"RTN","SYNFAPT",110,0)
 . ; Output:   RETSTA
"RTN","SYNFAPT",111,0)
 . ;  1 - success
"RTN","SYNFAPT",112,0)
 . ; -1 - failure -1^message
"RTN","SYNFAPT",113,0)
 . ;
"RTN","SYNFAPT",114,0)
 . n RETSTA,DHPPAT,DHPCLIN,DHPAPTDT,DHPLEN,DHPCIDT,DHPCODT
"RTN","SYNFAPT",115,0)
 . s (RETSTA,DHPPAT,DHPCLIN,DHPAPTDT,DHPLEN,DHPCIDT,DHPCODT)=""      ;Appointment update
"RTN","SYNFAPT",116,0)
 . ;
"RTN","SYNFAPT",117,0)
 . s DHPPAT=$$dfn2icn^SYNFUTL(dfn)
"RTN","SYNFAPT",118,0)
 . s eval("appointment",zi,"parms","DHPPAT")=DHPPAT
"RTN","SYNFAPT",119,0)
 . ;
"RTN","SYNFAPT",120,0)
 . s DHPAPTDT=hl7StartDateTime
"RTN","SYNFAPT",121,0)
 . s eval("appointment",zi,"parms","DHPAPTDT")=DHPAPTDT
"RTN","SYNFAPT",122,0)
 . ;
"RTN","SYNFAPT",123,0)
 . ;s DHPPROV=$$MAP^SYNQLDM("OP","provider") ; map should return the NPI number
"RTN","SYNFAPT",124,0)
 . ;n DHPPROVIEN s DHPPROVIEN=$o(^VA(200,"B",DHPPROV,""))
"RTN","SYNFAPT",125,0)
 . ;if DHPPROVIEN="" S DHPPROVIEN=3
"RTN","SYNFAPT",126,0)
 . ;s eval("appointment",zi,"parms","DHPPROV")=DHPPROV
"RTN","SYNFAPT",127,0)
 . ; log(jlog,"Provider NPI for outpatient is: "_DHPPROV)
"RTN","SYNFAPT",128,0)
 . ;
"RTN","SYNFAPT",129,0)
 . s DHPCLIN=$$MAP^SYNQLDM("OP","location")
"RTN","SYNFAPT",130,0)
 . n DHPLOCIEN s DHPLOCIEN=$o(^SC("B",DHPCLIN,""))
"RTN","SYNFAPT",131,0)
 . if DHPLOCIEN="" S DHPLOCIEN=4 S DHPCLIN=$$GET1^DIQ(44,DHPLOCIEN_",",.01)
"RTN","SYNFAPT",132,0)
 . s eval("appointment",zi,"parms","DHPCLIN")=DHPCLIN
"RTN","SYNFAPT",133,0)
 . d log(jlog,"Location for outpatient is: #"_DHPLOCIEN_" "_DHPCLIN)
"RTN","SYNFAPT",134,0)
 . ;
"RTN","SYNFAPT",135,0)
 . s eval("appointment",zi,"status","loadstatus")="readyToLoad"
"RTN","SYNFAPT",136,0)
 . ;
"RTN","SYNFAPT",137,0)
 . if $g(args("load"))=1 d  ; only load if told to
"RTN","SYNFAPT",138,0)
 . . if $g(ien)'="" if $$loadStatus("appointment",zi,ien)=1 do  quit  ;
"RTN","SYNFAPT",139,0)
 . . . d log(jlog,"Appointment already loaded, skipping")
"RTN","SYNFAPT",140,0)
 . . d log(jlog,"Calling APPTUPDT^SYNDHP62 to add appointment")
"RTN","SYNFAPT",141,0)
 . . D APPTADD^SYNDHP62(.RETSTA,DHPPAT,DHPCLIN,DHPAPTDT,DHPLEN) ;Create appointment
"RTN","SYNFAPT",142,0)
 . . ;D APPTUPDT^SYNDHP62(.RETSTA,DHPPAT,DHPCLIN,DHPAPTDT,DHPLEN,DHPCIDT,DHPCODT)        ;Appointment update
"RTN","SYNFAPT",143,0)
 . . m eval("appointment",zi,"status")=RETSTA
"RTN","SYNFAPT",144,0)
 . . d log(jlog,"Return from data loader was: "_$g(RETSTA))
"RTN","SYNFAPT",145,0)
 . . if +$g(RETSTA)=1 do  ;
"RTN","SYNFAPT",146,0)
 . . . s eval("status","loaded")=$g(eval("status","loaded"))+1
"RTN","SYNFAPT",147,0)
 . . . s eval("appointment",zi,"status","loadstatus")="loaded"
"RTN","SYNFAPT",148,0)
 . . else  d  ;
"RTN","SYNFAPT",149,0)
 . . . s eval("status","errors")=$g(eval("status","errors"))+1
"RTN","SYNFAPT",150,0)
 . . . s eval("appointment",zi,"status","loadstatus")="notLoaded"
"RTN","SYNFAPT",151,0)
 . . . s eval("appointment",zi,"status","loadMessage")=$g(RETSTA)
"RTN","SYNFAPT",152,0)
 . . n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFAPT",153,0)
 . . k @root@(ien,"load","appointment",zi)
"RTN","SYNFAPT",154,0)
 . . m @root@(ien,"load","appointment",zi)=eval("appointment",zi)
"RTN","SYNFAPT",155,0)
 ;
"RTN","SYNFAPT",156,0)
 if $get(args("debug"))=1 do  ;
"RTN","SYNFAPT",157,0)
 . m jrslt("source")=json
"RTN","SYNFAPT",158,0)
 . m jrslt("args")=args
"RTN","SYNFAPT",159,0)
 . m jrslt("eval")=eval
"RTN","SYNFAPT",160,0)
 m jrslt("appointmentStatus")=eval("appointmentStatus")
"RTN","SYNFAPT",161,0)
 set jrslt("result","status")="ok"
"RTN","SYNFAPT",162,0)
 set jrslt("result","loaded")=$g(eval("status","loaded"))
"RTN","SYNFAPT",163,0)
 i $g(ien)'="" d  ; called internally
"RTN","SYNFAPT",164,0)
 . m result=eval
"RTN","SYNFAPT",165,0)
 . m result("status")=jrslt("result")
"RTN","SYNFAPT",166,0)
 . m result("dfn")=dfn
"RTN","SYNFAPT",167,0)
 . m result("ien")=ien
"RTN","SYNFAPT",168,0)
 . ;b
"RTN","SYNFAPT",169,0)
 e  d  ;
"RTN","SYNFAPT",170,0)
 . d ENCODE^VPRJSON("jrslt","result")
"RTN","SYNFAPT",171,0)
 . set HTTPRSP("mime")="application/json" 
"RTN","SYNFAPT",172,0)
 q
"RTN","SYNFAPT",173,0)
 ;
"RTN","SYNFAPT",174,0)
log(ary,txt)    ; adds a text line to @ary@("log")
"RTN","SYNFAPT",175,0)
 s @ary@("log",$o(@ary@("log",""),-1)+1)=$g(txt)
"RTN","SYNFAPT",176,0)
 q
"RTN","SYNFAPT",177,0)
 ;
"RTN","SYNFAPT",178,0)
loadStatus(typ,zx,zien) ; extrinsic return 1 if resource was loaded
"RTN","SYNFAPT",179,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFAPT",180,0)
 n rt s rt=0
"RTN","SYNFAPT",181,0)
 i $g(zx)="" i $d(@root@(zien,"load",typ)) s rt=1 q rt
"RTN","SYNFAPT",182,0)
 i $get(@root@(zien,"load",typ,zx,"status","loadstatus"))="loaded" s rt=1
"RTN","SYNFAPT",183,0)
 q rt
"RTN","SYNFAPT",184,0)
 ;
"RTN","SYNFAPT",185,0)
testall ; run the appointment import on all imported patients
"RTN","SYNFAPT",186,0)
 new root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFAPT",187,0)
 new indx s indx=$na(@root@("POS","DFN"))
"RTN","SYNFAPT",188,0)
 n dfn,ien,filter,reslt
"RTN","SYNFAPT",189,0)
 s dfn=0
"RTN","SYNFAPT",190,0)
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  d  ;
"RTN","SYNFAPT",191,0)
 . s ien=$o(@indx@(dfn,""))
"RTN","SYNFAPT",192,0)
 . q:ien=""
"RTN","SYNFAPT",193,0)
 . s filter("dfn")=dfn
"RTN","SYNFAPT",194,0)
 . k reslt
"RTN","SYNFAPT",195,0)
 . d wsIntakeAppointment(.filter,,.reslt,ien)
"RTN","SYNFAPT",196,0)
 q
"RTN","SYNFAPT",197,0)
 ;
"RTN","SYNFAPT",198,0)
testone(reslt,doload)   ; run the appointment import on imported patient
"RTN","SYNFAPT",199,0)
 new root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFAPT",200,0)
 new indx s indx=$na(@root@("POS","DFN"))
"RTN","SYNFAPT",201,0)
 n dfn,ien,filter
"RTN","SYNFAPT",202,0)
 n done s done=0
"RTN","SYNFAPT",203,0)
 s dfn=0
"RTN","SYNFAPT",204,0)
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  q:done   d  ;
"RTN","SYNFAPT",205,0)
 . s ien=$o(@indx@(dfn,""))
"RTN","SYNFAPT",206,0)
 . q:ien=""
"RTN","SYNFAPT",207,0)
 . q:$d(@root@(ien,"load","appointment"))
"RTN","SYNFAPT",208,0)
 . s filter("dfn")=dfn
"RTN","SYNFAPT",209,0)
 . s filter("debug")=1
"RTN","SYNFAPT",210,0)
 . i $g(doload)=1 s filter("load")=1
"RTN","SYNFAPT",211,0)
 . k reslt
"RTN","SYNFAPT",212,0)
 . ;w !,"loading appointments for ien=",ien,!
"RTN","SYNFAPT",213,0)
 . d wsIntakeAppointment(.filter,,.reslt,ien)
"RTN","SYNFAPT",214,0)
 . ;zwr reslt
"RTN","SYNFAPT",215,0)
 . s done=1
"RTN","SYNFAPT",216,0)
 q
"RTN","SYNFAPT",217,0)
 ;
"RTN","SYNFAPT",218,0)
getRandomApt(ary)       ; make a web service call to get random appointments
"RTN","SYNFAPT",219,0)
 n srvr
"RTN","SYNFAPT",220,0)
 s srvr="http://postfhir.vistaplex.org:9080/"
"RTN","SYNFAPT",221,0)
 i srvr["postfhir.vistaplex.org" s srvr="http://138.197.70.229:9080/"
"RTN","SYNFAPT",222,0)
 i $g(^%WURL)["http://postfhir.vistaplex.org:9080" d  q  ;
"RTN","SYNFAPT",223,0)
 . s srvr="localhost:9080/"
"RTN","SYNFAPT",224,0)
 . n url
"RTN","SYNFAPT",225,0)
 . s url=srvr_"randomappointment"
"RTN","SYNFAPT",226,0)
 . n ok,r1
"RTN","SYNFAPT",227,0)
 . s ok=$$%^%WC(.r1,"GET",url)
"RTN","SYNFAPT",228,0)
 . i '$d(r1) q  ;
"RTN","SYNFAPT",229,0)
 . d DECODE^VPRJSON("r1","ary")
"RTN","SYNFAPT",230,0)
 n url
"RTN","SYNFAPT",231,0)
 s url=srvr_"randomAllergy"
"RTN","SYNFAPT",232,0)
 n ret,json,jtmp
"RTN","SYNFAPT",233,0)
 s ret=$$GETURL^XTHC10(url,,"jtmp")
"RTN","SYNFAPT",234,0)
 d assemble^SYNFPUL("jtmp","json")
"RTN","SYNFAPT",235,0)
 i '$d(json) q  ;
"RTN","SYNFAPT",236,0)
 d DECODE^VPRJSON("json","ary")
"RTN","SYNFAPT",237,0)
 q
"RTN","SYNFAPT",238,0)
 ;
"RTN","SYNFCON")
0^26^B75078002
"RTN","SYNFCON",1,0)
SYNFCON ;ven/gpl - fhir loader utilities ;2018-08-17  3:28 PM
"RTN","SYNFCON",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNFCON",3,0)
 ;
"RTN","SYNFCON",4,0)
 ; Authored by George P. Lilly 2017-2018
"RTN","SYNFCON",5,0)
 ;
"RTN","SYNFCON",6,0)
 q
"RTN","SYNFCON",7,0)
 ;
"RTN","SYNFCON",8,0)
importConditions(rtn,ien,args)  ; entry point for loading conditions for a patient
"RTN","SYNFCON",9,0)
 ; calls the intake Conditions web service directly
"RTN","SYNFCON",10,0)
 ;
"RTN","SYNFCON",11,0)
 n grtn
"RTN","SYNFCON",12,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFCON",13,0)
 d wsIntakeConditions(.args,,.grtn,ien)
"RTN","SYNFCON",14,0)
 i $d(grtn) d  ; something was returned
"RTN","SYNFCON",15,0)
 . k @root@(ien,"load","conditions")
"RTN","SYNFCON",16,0)
 . m @root@(ien,"load","conditions")=grtn("conditions")
"RTN","SYNFCON",17,0)
 . if $g(args("debug"))=1 m rtn=grtn
"RTN","SYNFCON",18,0)
 s rtn("conditionsStatus","status")=$g(grtn("status","status"))
"RTN","SYNFCON",19,0)
 s rtn("conditionsStatus","loaded")=$g(grtn("status","loaded"))
"RTN","SYNFCON",20,0)
 s rtn("conditionsStatus","errors")=$g(grtn("status","errors"))
"RTN","SYNFCON",21,0)
 ;b
"RTN","SYNFCON",22,0)
 ;
"RTN","SYNFCON",23,0)
 ;
"RTN","SYNFCON",24,0)
 q
"RTN","SYNFCON",25,0)
 ;
"RTN","SYNFCON",26,0)
wsIntakeConditions(args,body,result,ien)        ; web service entry (post)
"RTN","SYNFCON",27,0)
 ; for intake of one or more Conditions. input are fhir resources
"RTN","SYNFCON",28,0)
 ; result is json and summarizes what was done
"RTN","SYNFCON",29,0)
 ; args include patientId
"RTN","SYNFCON",30,0)
 ; ien is specified for internal calls, where the json is already in a graph
"RTN","SYNFCON",31,0)
 n jtmp,json,jrslt,eval
"RTN","SYNFCON",32,0)
 ;i $g(ien)'="" if $$loadStatus("conditions","",ien)=1 d  q  ;
"RTN","SYNFCON",33,0)
 ;. s result("conditionsStatus","status")="alreadyLoaded"
"RTN","SYNFCON",34,0)
 i $g(ien)'="" d  ; internal call
"RTN","SYNFCON",35,0)
 . d getIntakeFhir^SYNFHIR("json",,"Condition",ien,1)
"RTN","SYNFCON",36,0)
 e  d  ; 
"RTN","SYNFCON",37,0)
 . s args("load")=0
"RTN","SYNFCON",38,0)
 . merge jtmp=BODY
"RTN","SYNFCON",39,0)
 . do DECODE^VPRJSON("jtmp","json")
"RTN","SYNFCON",40,0)
 i '$d(json) q  ;
"RTN","SYNFCON",41,0)
 m ^gpl("gjson")=json
"RTN","SYNFCON",42,0)
 ;
"RTN","SYNFCON",43,0)
 ; determine the patient
"RTN","SYNFCON",44,0)
 ;
"RTN","SYNFCON",45,0)
 n dfn,eval
"RTN","SYNFCON",46,0)
 if $g(ien)'="" d  ;
"RTN","SYNFCON",47,0)
 . s dfn=$$ien2dfn^SYNFUTL(ien) ; look up dfn in the graph
"RTN","SYNFCON",48,0)
 else  d  ;
"RTN","SYNFCON",49,0)
 . s dfn=$g(args("dfn"))
"RTN","SYNFCON",50,0)
 . i dfn="" d  ;
"RTN","SYNFCON",51,0)
 . . n icn s icn=$g(args("icn"))
"RTN","SYNFCON",52,0)
 . . i icn'="" s dfn=$$icn2dfn^SYNFUTL(icn)
"RTN","SYNFCON",53,0)
 i $g(dfn)="" do  quit  ; need the patient
"RTN","SYNFCON",54,0)
 . s result("conditions",1,"log",1)="Error, patient not found.. terminating"
"RTN","SYNFCON",55,0)
 ;
"RTN","SYNFCON",56,0)
 ;
"RTN","SYNFCON",57,0)
 new zi s zi=0
"RTN","SYNFCON",58,0)
 for  set zi=$order(json("entry",zi)) quit:+zi=0  do  ;
"RTN","SYNFCON",59,0)
 . ;
"RTN","SYNFCON",60,0)
 . ; define a place to log the processing of this entry
"RTN","SYNFCON",61,0)
 . ;
"RTN","SYNFCON",62,0)
 . new jlog set jlog=$name(eval("conditions",zi))
"RTN","SYNFCON",63,0)
 . ;
"RTN","SYNFCON",64,0)
 . ; insure that the resourceType is Condition
"RTN","SYNFCON",65,0)
 . ;
"RTN","SYNFCON",66,0)
 . new type set type=$get(json("entry",zi,"resource","resourceType"))
"RTN","SYNFCON",67,0)
 . if type'="Condition" do  quit  ;
"RTN","SYNFCON",68,0)
 . . set eval("conditions",zi,"vars","resourceType")=type
"RTN","SYNFCON",69,0)
 . . do log(jlog,"Resource type not Condition, skipping entry")
"RTN","SYNFCON",70,0)
 . set eval("conditions",zi,"vars","resourceType")=type
"RTN","SYNFCON",71,0)
 . ;
"RTN","SYNFCON",72,0)
 . ; see if this resource has already been loaded. if so, skip it
"RTN","SYNFCON",73,0)
 . ;
"RTN","SYNFCON",74,0)
 . if $g(ien)'="" if $$loadStatus("conditions",zi,ien)=1 do  quit  ;
"RTN","SYNFCON",75,0)
 . . d log(jlog,"Vital sign already loaded, skipping")
"RTN","SYNFCON",76,0)
 . ;
"RTN","SYNFCON",77,0)
 . ; determine Conditions code, coding system, and display text
"RTN","SYNFCON",78,0)
 . ;
"RTN","SYNFCON",79,0)
 . ;
"RTN","SYNFCON",80,0)
 . ; determine the id of the resource
"RTN","SYNFCON",81,0)
 . ;
"RTN","SYNFCON",82,0)
 . new id set id=$get(json("entry",zi,"resource","id"))
"RTN","SYNFCON",83,0)
 . set eval("conditions",zi,"vars","id")=id
"RTN","SYNFCON",84,0)
 . d log(jlog,"ID is: "_id)
"RTN","SYNFCON",85,0)
 . ;
"RTN","SYNFCON",86,0)
 . new concode set concode=$get(json("entry",zi,"resource","code","coding",1,"code"))
"RTN","SYNFCON",87,0)
 . do log(jlog,"code is: "_concode)
"RTN","SYNFCON",88,0)
 . set eval("conditions",zi,"vars","code")=concode
"RTN","SYNFCON",89,0)
 . ;
"RTN","SYNFCON",90,0)
 . ;
"RTN","SYNFCON",91,0)
 . new codesystem set codesystem=$get(json("entry",zi,"resource","code","coding",1,"system"))
"RTN","SYNFCON",92,0)
 . do log(jlog,"code system is: "_codesystem)
"RTN","SYNFCON",93,0)
 . set eval("conditions",zi,"vars","codeSystem")=codesystem
"RTN","SYNFCON",94,0)
 . ;
"RTN","SYNFCON",95,0)
 . ; determine the code display text
"RTN","SYNFCON",96,0)
 . ;
"RTN","SYNFCON",97,0)
 . new context s context=$get(json("entry",zi,"resource","code","coding",1,"display"))
"RTN","SYNFCON",98,0)
 . do log(jlog,"display text is: "_context)
"RTN","SYNFCON",99,0)
 . set eval("conditions",zi,"vars","text")=context
"RTN","SYNFCON",100,0)
 . ;
"RTN","SYNFCON",101,0)
 . ; determine the effective date
"RTN","SYNFCON",102,0)
 . ;
"RTN","SYNFCON",103,0)
 . new effdate set effdate=$get(json("entry",zi,"resource","onsetDateTime"))
"RTN","SYNFCON",104,0)
 . do log(jlog,"effectiveDateTime is: "_effdate)
"RTN","SYNFCON",105,0)
 . set eval("conditions",zi,"vars","effectiveDateTime")=effdate
"RTN","SYNFCON",106,0)
 . new fmtime s fmtime=$$fhirTfm^SYNFUTL(effdate)
"RTN","SYNFCON",107,0)
 . d log(jlog,"fileman dateTime is: "_fmtime)
"RTN","SYNFCON",108,0)
 . set eval("conditions",zi,"vars","fmDateTime")=fmtime ;
"RTN","SYNFCON",109,0)
 . new hl7time s hl7time=$$fhirThl7^SYNFUTL(effdate)
"RTN","SYNFCON",110,0)
 . d log(jlog,"hl7 dateTime is: "_hl7time)
"RTN","SYNFCON",111,0)
 . set eval("conditions",zi,"vars","hl7DateTime")=hl7time ;
"RTN","SYNFCON",112,0)
 . ;
"RTN","SYNFCON",113,0)
 . ; determine the abatement date
"RTN","SYNFCON",114,0)
 . ;
"RTN","SYNFCON",115,0)
 . new abatedate set abatedate=$get(json("entry",zi,"resource","abatementDateTime"))
"RTN","SYNFCON",116,0)
 . do log(jlog,"abatementDateTime is: "_abatedate)
"RTN","SYNFCON",117,0)
 . set eval("conditions",zi,"vars","abatementDateTime")=effdate
"RTN","SYNFCON",118,0)
 . new fmtime s fmtime=$$fhirTfm^SYNFUTL(abatedate)
"RTN","SYNFCON",119,0)
 . d log(jlog,"fileman abatementDateTime is: "_fmtime)
"RTN","SYNFCON",120,0)
 . set eval("conditions",zi,"vars","fmAbatementDateTime")=fmtime ;
"RTN","SYNFCON",121,0)
 . new hl7time s hl7time=$$fhirThl7^SYNFUTL(abatedate)
"RTN","SYNFCON",122,0)
 . d log(jlog,"hl7 abatementDateTime is: "_hl7time)
"RTN","SYNFCON",123,0)
 . set eval("conditions",zi,"vars","hl7AbatementDateTime")=hl7time ;
"RTN","SYNFCON",124,0)
 . ;
"RTN","SYNFCON",125,0)
 . ; determine the status
"RTN","SYNFCON",126,0)
 . ;
"RTN","SYNFCON",127,0)
 . n constatus s constatus=$get(json("entry",zi,"resource","clinicalStatus"))
"RTN","SYNFCON",128,0)
 . do log(jlog,"Clinical Status is: "_constatus)
"RTN","SYNFCON",129,0)
 . set eval("conditions",zi,"vars","clinicalStatus")=constatus
"RTN","SYNFCON",130,0)
 . ;
"RTN","SYNFCON",131,0)
 . ; set up to call the data loader
"RTN","SYNFCON",132,0)
 . ;
"RTN","SYNFCON",133,0)
 . n RETSTA,DHPPAT,DHPSCT,DHPDTM,DHPPROV,DHPLOC,DHPTXT
"RTN","SYNFCON",134,0)
 . ;
"RTN","SYNFCON",135,0)
 . s DHPPAT=$$dfn2icn^SYNFUTL(dfn)
"RTN","SYNFCON",136,0)
 . s eval("conditions",zi,"parms","DHPPAT")=DHPPAT
"RTN","SYNFCON",137,0)
 . ;
"RTN","SYNFCON",138,0)
 . s DHPSCT=concode
"RTN","SYNFCON",139,0)
 . s eval("conditions",zi,"parms","DHPSCT")=DHPSCT
"RTN","SYNFCON",140,0)
 . ;
"RTN","SYNFCON",141,0)
 . s DHPTXT=context
"RTN","SYNFCON",142,0)
 . s eval("conditions",zi,"parms","DHPTXT")=DHPTXT
"RTN","SYNFCON",143,0)
 . ;
"RTN","SYNFCON",144,0)
 . ;
"RTN","SYNFCON",145,0)
 . s DHPDTM=hl7time
"RTN","SYNFCON",146,0)
 . s eval("conditions",zi,"parms","DHPDTM")=hl7time
"RTN","SYNFCON",147,0)
 . d log(jlog,"HL7 DateTime is: "_hl7time)
"RTN","SYNFCON",148,0)
 . ;
"RTN","SYNFCON",149,0)
 . s DHPPROV=$$MAP^SYNQLDM("OP","provider")
"RTN","SYNFCON",150,0)
 . n DHPPROVIEN s DHPPROVIEN=$o(^VA(200,"B",DHPPROV,""))
"RTN","SYNFCON",151,0)
 . if DHPPROVIEN="" S DHPPROVIEN=3
"RTN","SYNFCON",152,0)
 . s eval("conditions",zi,"parms","DHPPROV")=DHPPROVIEN
"RTN","SYNFCON",153,0)
 . d log(jlog,"Provider for outpatient is: #"_DHPPROVIEN_" "_DHPPROV)
"RTN","SYNFCON",154,0)
 . ;
"RTN","SYNFCON",155,0)
 . s DHPLOC=$$MAP^SYNQLDM("OP","location")
"RTN","SYNFCON",156,0)
 . n DHPLOCIEN s DHPLOCIEN=$o(^SC("B",DHPLOC,""))
"RTN","SYNFCON",157,0)
 . if DHPLOCIEN="" S DHPLOCIEN=4
"RTN","SYNFCON",158,0)
 . s eval("conditions",zi,"parms","DHPLOC")=DHPLOCIEN
"RTN","SYNFCON",159,0)
 . d log(jlog,"Location for outpatient is: #"_DHPLOCIEN_" "_DHPLOC)
"RTN","SYNFCON",160,0)
 . ;
"RTN","SYNFCON",161,0)
 . s eval("conditions",zi,"status","loadstatus")="readyToLoad"
"RTN","SYNFCON",162,0)
 . ;
"RTN","SYNFCON",163,0)
 . if $g(args("load"))=1 d  ; only load if told to
"RTN","SYNFCON",164,0)
 . . if $g(ien)'="" if $$loadStatus("conditions",zi,ien)=1 do  quit  ;
"RTN","SYNFCON",165,0)
 . . . d log(jlog,"Vital sign already loaded, skipping")
"RTN","SYNFCON",166,0)
 . . d log(jlog,"Calling data loader to add encounter")
"RTN","SYNFCON",167,0)
 . . d log(jlog,"Return from data loader was: "_$g(RETSTA))
"RTN","SYNFCON",168,0)
 . . if +$g(RETSTA)=1 do  ;
"RTN","SYNFCON",169,0)
 . . . s eval("status","loaded")=$g(eval("status","loaded"))+1
"RTN","SYNFCON",170,0)
 . . . s eval("conditions",zi,"status","loadstatus")="loaded"
"RTN","SYNFCON",171,0)
 . . else  s eval("status","errors")=$g(eval("status","errors"))+1
"RTN","SYNFCON",172,0)
 ;
"RTN","SYNFCON",173,0)
 if $get(args("debug"))=1 do  ;
"RTN","SYNFCON",174,0)
 . m jrslt("source")=json
"RTN","SYNFCON",175,0)
 . m jrslt("args")=args
"RTN","SYNFCON",176,0)
 . m jrslt("eval")=eval
"RTN","SYNFCON",177,0)
 m jrslt("conditionsStatus")=eval("conditionsStatus")
"RTN","SYNFCON",178,0)
 set jrslt("result","status")="ok"
"RTN","SYNFCON",179,0)
 set jrslt("result","loaded")=$g(eval("status","loaded"))
"RTN","SYNFCON",180,0)
 i $g(ien)'="" d  ; called internally
"RTN","SYNFCON",181,0)
 . m result=eval
"RTN","SYNFCON",182,0)
 . m result("status")=jrslt("result")
"RTN","SYNFCON",183,0)
 . ;b
"RTN","SYNFCON",184,0)
 e  d  ;
"RTN","SYNFCON",185,0)
 . d ENCODE^VPRJSON("jrslt","result")
"RTN","SYNFCON",186,0)
 . set HTTPRSP("mime")="application/json" 
"RTN","SYNFCON",187,0)
 q
"RTN","SYNFCON",188,0)
 ;
"RTN","SYNFCON",189,0)
log(ary,txt)    ; adds a text line to @ary@("log")
"RTN","SYNFCON",190,0)
 s @ary@("log",$o(@ary@("log",""),-1)+1)=$g(txt)
"RTN","SYNFCON",191,0)
 q
"RTN","SYNFCON",192,0)
 ;
"RTN","SYNFCON",193,0)
loadStatus(typ,zx,zien) ; extrinsic return 1 if resource was loaded
"RTN","SYNFCON",194,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFCON",195,0)
 n rt s rt=0
"RTN","SYNFCON",196,0)
 i $g(zx)="" i $d(@root@(zien,"load",typ)) s rt=1 q rt
"RTN","SYNFCON",197,0)
 i $get(@root@(zien,"load",typ,zx,"status","loadstatus"))="loaded" s rt=1
"RTN","SYNFCON",198,0)
 q rt
"RTN","SYNFCON",199,0)
 ;
"RTN","SYNFCON",200,0)
testall ; run the conditions import on all imported patients
"RTN","SYNFCON",201,0)
 new root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFCON",202,0)
 new indx s indx=$na(@root@("POS","DFN"))
"RTN","SYNFCON",203,0)
 n dfn,ien,filter,reslt
"RTN","SYNFCON",204,0)
 s dfn=0
"RTN","SYNFCON",205,0)
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  d  ;
"RTN","SYNFCON",206,0)
 . s ien=$o(@indx@(dfn,""))
"RTN","SYNFCON",207,0)
 . q:ien=""
"RTN","SYNFCON",208,0)
 . s filter("dfn")=dfn
"RTN","SYNFCON",209,0)
 . k reslt
"RTN","SYNFCON",210,0)
 . d wsIntakeConditions(.filter,,.reslt,ien)
"RTN","SYNFCON",211,0)
 q
"RTN","SYNFCON",212,0)
 ;
"RTN","SYNFCP")
0^78^B312469407
"RTN","SYNFCP",1,0)
SYNFCP ;ven/gpl - fhir loader utilities ;2018-08-17  3:27 PM
"RTN","SYNFCP",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNFCP",3,0)
 ;
"RTN","SYNFCP",4,0)
 ; Authored by George P. Lilly 2017-2019
"RTN","SYNFCP",5,0)
 ;
"RTN","SYNFCP",6,0)
 q
"RTN","SYNFCP",7,0)
 ;
"RTN","SYNFCP",8,0)
importCarePlan(rtn,ien,args)  ; entry point for loading Careplans for a patient
"RTN","SYNFCP",9,0)
 ; calls the intake Careplan web service directly
"RTN","SYNFCP",10,0)
 ;
"RTN","SYNFCP",11,0)
 n grtn
"RTN","SYNFCP",12,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFCP",13,0)
 d wsIntakeCareplan(.args,,.grtn,ien)
"RTN","SYNFCP",14,0)
 i $d(grtn) d  ; something was returned
"RTN","SYNFCP",15,0)
 . k @root@(ien,"load","careplan")
"RTN","SYNFCP",16,0)
 . m @root@(ien,"load","careplan")=grtn("careplan")
"RTN","SYNFCP",17,0)
 . if $g(args("debug"))=1 m rtn=grtn
"RTN","SYNFCP",18,0)
 s rtn("careplanStatus","status")=$g(grtn("status","status"))
"RTN","SYNFCP",19,0)
 s rtn("careplanStatus","loaded")=$g(grtn("status","loaded"))
"RTN","SYNFCP",20,0)
 s rtn("careplanStatus","errors")=$g(grtn("status","errors"))
"RTN","SYNFCP",21,0)
 ;b
"RTN","SYNFCP",22,0)
 ;
"RTN","SYNFCP",23,0)
 ;
"RTN","SYNFCP",24,0)
 q
"RTN","SYNFCP",25,0)
 ;
"RTN","SYNFCP",26,0)
wsIntakeCareplan(args,body,result,ien)        ; web service entry (post)
"RTN","SYNFCP",27,0)
 ; for intake of one or more Careplan. input are fhir resources
"RTN","SYNFCP",28,0)
 ; result is json and summarizes what was done
"RTN","SYNFCP",29,0)
 ; args include patientId
"RTN","SYNFCP",30,0)
 ; ien is specified for internal calls, where the json is already in a graph
"RTN","SYNFCP",31,0)
 n jtmp,json,jrslt,eval
"RTN","SYNFCP",32,0)
 ;i $g(ien)'="" if $$loadStatus("careplan","",ien)=1 d  q  ;
"RTN","SYNFCP",33,0)
 ;. s result("careplanStatus","status")="alreadyLoaded"
"RTN","SYNFCP",34,0)
 i $g(ien)'="" d  ; internal call
"RTN","SYNFCP",35,0)
 . d getIntakeFhir^SYNFHIR("json",,"CarePlan",ien,1)
"RTN","SYNFCP",36,0)
 e  d  ; 
"RTN","SYNFCP",37,0)
 . s args("load")=0
"RTN","SYNFCP",38,0)
 . merge jtmp=BODY
"RTN","SYNFCP",39,0)
 . do DECODE^VPRJSON("jtmp","json")
"RTN","SYNFCP",40,0)
 i '$d(json) q  ;
"RTN","SYNFCP",41,0)
 m ^gpl("gjson")=json
"RTN","SYNFCP",42,0)
 ;
"RTN","SYNFCP",43,0)
 ; determine the patient
"RTN","SYNFCP",44,0)
 ;
"RTN","SYNFCP",45,0)
 n dfn,eval
"RTN","SYNFCP",46,0)
 if $g(ien)'="" d  ;
"RTN","SYNFCP",47,0)
 . s dfn=$$ien2dfn^SYNFUTL(ien) ; look up dfn in the graph
"RTN","SYNFCP",48,0)
 else  d  ;
"RTN","SYNFCP",49,0)
 . s dfn=$g(args("dfn"))
"RTN","SYNFCP",50,0)
 . i dfn="" d  ;
"RTN","SYNFCP",51,0)
 . . n icn s icn=$g(args("icn"))
"RTN","SYNFCP",52,0)
 . . i icn'="" s dfn=$$icn2dfn^SYNFUTL(icn)
"RTN","SYNFCP",53,0)
 i $g(dfn)="" do  quit  ; need the patient
"RTN","SYNFCP",54,0)
 . s result("careplan",1,"log",1)="Error, patient not found.. terminating"
"RTN","SYNFCP",55,0)
 ;
"RTN","SYNFCP",56,0)
 ;
"RTN","SYNFCP",57,0)
 new zi s zi=0
"RTN","SYNFCP",58,0)
 for  set zi=$order(json("entry",zi)) quit:+zi=0  do  ;
"RTN","SYNFCP",59,0)
 . ;
"RTN","SYNFCP",60,0)
 . ; define a place to log the processing of this entry
"RTN","SYNFCP",61,0)
 . ;
"RTN","SYNFCP",62,0)
 . new jlog set jlog=$name(eval("careplan",zi))
"RTN","SYNFCP",63,0)
 . ;
"RTN","SYNFCP",64,0)
 . d log(jlog,"DFN: "_dfn)
"RTN","SYNFCP",65,0)
 . ;
"RTN","SYNFCP",66,0)
 . ; insure that the resourceType is CarePlan
"RTN","SYNFCP",67,0)
 . ;
"RTN","SYNFCP",68,0)
 . new type set type=$get(json("entry",zi,"resource","resourceType"))
"RTN","SYNFCP",69,0)
 . if type'="CarePlan" do  quit  ;
"RTN","SYNFCP",70,0)
 . . set eval("careplan",zi,"vars","resourceType")=type
"RTN","SYNFCP",71,0)
 . . do log(jlog,"Resource type not CarePlan, skipping entry")
"RTN","SYNFCP",72,0)
 . set eval("careplan",zi,"vars","resourceType")=type
"RTN","SYNFCP",73,0)
 . ;
"RTN","SYNFCP",74,0)
 . ; see if this resource has already been loaded. if so, skip it
"RTN","SYNFCP",75,0)
 . ;
"RTN","SYNFCP",76,0)
 . if $g(ien)'="" if $$loadStatus("condition",zi,ien)=1 do  quit  ;
"RTN","SYNFCP",77,0)
 . . d log(jlog,"CarePlan already loaded, skipping")
"RTN","SYNFCP",78,0)
 . ;
"RTN","SYNFCP",79,0)
 . ; determine CarePlan snomed code, coding system, and display text
"RTN","SYNFCP",80,0)
 . ;
"RTN","SYNFCP",81,0)
 . ;
"RTN","SYNFCP",82,0)
 . ; determine the id of the resource
"RTN","SYNFCP",83,0)
 . ;
"RTN","SYNFCP",84,0)
 . new id set id=$get(json("entry",zi,"resource","id"))
"RTN","SYNFCP",85,0)
 . set eval("careplan",zi,"vars","id")=id
"RTN","SYNFCP",86,0)
 . d log(jlog,"ID is: "_id)
"RTN","SYNFCP",87,0)
 . ;
"RTN","SYNFCP",88,0)
 . ;
"RTN","SYNFCP",89,0)
 . ; determine the encounter visit ien
"RTN","SYNFCP",90,0)
 . n encounterId
"RTN","SYNFCP",91,0)
 . s encounterId=$g(json("entry",zi,"resource","context","reference"))
"RTN","SYNFCP",92,0)
 . ;i encounterId["urn:uuid:" s encounterId=$p(encounterId,"urn:uuid:",2)
"RTN","SYNFCP",93,0)
 . s eval("careplan",zi,"vars","encounterId")=encounterId
"RTN","SYNFCP",94,0)
 . d log(jlog,"reference encounter ID is : "_encounterId)
"RTN","SYNFCP",95,0)
 . ;
"RTN","SYNFCP",96,0)
 . ; determine visit ien
"RTN","SYNFCP",97,0)
 . ;
"RTN","SYNFCP",98,0)
 . n visitIen s visitIen=$$visitIen^SYNFENC(ien,encounterId)
"RTN","SYNFCP",99,0)
 . s eval("careplan",zi,"vars","visitIen")=visitIen
"RTN","SYNFCP",100,0)
 . d log(jlog,"visit ien is: "_visitIen)
"RTN","SYNFCP",101,0)
 . n visitDate s visitDate=$$GET1^DIQ(9000010,visitIen_",",.01,"I")
"RTN","SYNFCP",102,0)
 . i visitDate'=-1 d  ;
"RTN","SYNFCP",103,0)
 . . s eval("careplan",zi,"vars","visitDate")=visitDate
"RTN","SYNFCP",104,0)
 . . d log(jlog,"visit date is: "_visitDate)
"RTN","SYNFCP",105,0)
 . e  d log(jlog,"visit date unknow")
"RTN","SYNFCP",106,0)
 . ;
"RTN","SYNFCP",107,0)
 . ; determine the category code
"RTN","SYNFCP",108,0)
 . ; 
"RTN","SYNFCP",109,0)
 . new sctcode set sctcode=$get(json("entry",zi,"resource","category",1,"coding",1,"code"))
"RTN","SYNFCP",110,0)
 . n cattext s cattext=$get(json("entry",zi,"resource","category",1,"coding",1,"display"))
"RTN","SYNFCP",111,0)
 . n x s $p(x,"-",80)=""
"RTN","SYNFCP",112,0)
 . do TONOTE^SYNFTIU(ien,encounterId,x)
"RTN","SYNFCP",113,0)
 . do TONOTE^SYNFTIU(ien,encounterId,"Care Plan Instituted")
"RTN","SYNFCP",114,0)
 . do TONOTE^SYNFTIU(ien,encounterId,"")
"RTN","SYNFCP",115,0)
 . do TONOTE^SYNFTIU(ien,encounterId,"Care Plan Category: ")
"RTN","SYNFCP",116,0)
 . do TONOTE^SYNFTIU(ien,encounterId,"  "_cattext_" (SCT:"_sctcode_")")
"RTN","SYNFCP",117,0)
 . do log(jlog,"category code is: "_sctcode)
"RTN","SYNFCP",118,0)
 . do log(jlog,"category text is: "_cattext)
"RTN","SYNFCP",119,0)
 . set eval("careplan",zi,"vars","code")=sctcode
"RTN","SYNFCP",120,0)
 . set eval("careplan",zi,"vars","categoryText")=cattext
"RTN","SYNFCP",121,0)
 . d log(jlog,"Care Plan Category Code: "_sctcode)
"RTN","SYNFCP",122,0)
 . d log(jlog,"Care Plan Category Text: "_cattext)
"RTN","SYNFCP",123,0)
 . n hfcat,hfcatien
"RTN","SYNFCP",124,0)
 . s hfcat=$$HFCPCAT^SYNFHF(sctcode,cattext)
"RTN","SYNFCP",125,0)
 . s hfcatien=+hfcat
"RTN","SYNFCP",126,0)
 . d log(jlog,"Care Plan Category HF: "_hfcat)
"RTN","SYNFCP",127,0)
 . n hfcp
"RTN","SYNFCP",128,0)
 . s hfcp=$$HFCP^SYNFHF(sctcode,cattext,hfcatien)
"RTN","SYNFCP",129,0)
 . d log(jlog,"Care Plan HF: "_hfcp)
"RTN","SYNFCP",130,0)
 . ;
"RTN","SYNFCP",131,0)
 . ; determine the "addresses" code
"RTN","SYNFCP",132,0)
 . ;
"RTN","SYNFCP",133,0)
 . n addcode s addcode=""
"RTN","SYNFCP",134,0)
 . i $g(json("entry",zi,"resource","addresses",1,"reference"))'="" d  ;
"RTN","SYNFCP",135,0)
 . . n condref
"RTN","SYNFCP",136,0)
 . . s condref=$g(json("entry",zi,"resource","addresses",1,"reference"))
"RTN","SYNFCP",137,0)
 . . q:condref=""
"RTN","SYNFCP",138,0)
 . . d log(jlog,"Addresses Condition Reference: "_condref)
"RTN","SYNFCP",139,0)
 . . s addcode=$$DX^SYNFCP(ien,condref)
"RTN","SYNFCP",140,0)
 . . d log(jlog,"Addresses Code: "_addcode)
"RTN","SYNFCP",141,0)
 . . d TONOTE^SYNFTIU(ien,encounterId,"Care Plan Addresses:")
"RTN","SYNFCP",142,0)
 . . d TONOTE^SYNFTIU(ien,encounterId,"  "_$p(addcode,"^",2)_"(SCT:"_$p(addcode,"^",1)_")")
"RTN","SYNFCP",143,0)
 . e  d log(jlog,"No Addresses Condition")
"RTN","SYNFCP",144,0)
 . ;
"RTN","SYNFCP",145,0)
 . ; the following will be needed for addresses diagnosis code
"RTN","SYNFCP",146,0)
 . ;
"RTN","SYNFCP",147,0)
 . ;n icdcode,notmapped,icdcodetype
"RTN","SYNFCP",148,0)
 . ;s notmapped=0
"RTN","SYNFCP",149,0)
 . ;i visitDate<3151001 s icdcodetype="icd9"
"RTN","SYNFCP",150,0)
 . ;e  s icdcodetype="icd10"
"RTN","SYNFCP",151,0)
 . ;d log(jlog,"icd code type is: "_icdcodetype)
"RTN","SYNFCP",152,0)
 . ;i icdcodetype="icd9" s icdcode=$$MAP^SYNDHPMP("sct2icdnine",sctcode)
"RTN","SYNFCP",153,0)
 . ;e  s icdcode=$$MAP^SYNDHPMP("sct2icd",sctcode)
"RTN","SYNFCP",154,0)
 . ;i +icdcode=-1 s notmapped=1
"RTN","SYNFCP",155,0)
 . ;d:notmapped MAPERR^SYNQLDM(sctcode,icdcodetype)
"RTN","SYNFCP",156,0)
 . ;do log(jlog,"icd mapping is: "_icdcode)
"RTN","SYNFCP",157,0)
 . ;do:notmapped log(jlog,"snomed code "_sctcode_" is not mapped")
"RTN","SYNFCP",158,0)
 . ;set eval("careplan",zi,"vars","mappedIcdCode")=icdcode
"RTN","SYNFCP",159,0)
 . ;
"RTN","SYNFCP",160,0)
 . ; determine the beginning date and time
"RTN","SYNFCP",161,0)
 . ;
"RTN","SYNFCP",162,0)
 . new begindate
"RTN","SYNFCP",163,0)
 . set begindate=$get(json("entry",zi,"resource","period","start"))
"RTN","SYNFCP",164,0)
 . do log(jlog,"beginDateTime is: "_begindate)
"RTN","SYNFCP",165,0)
 . set eval("careplan",zi,"vars","beginDateTime")=begindate
"RTN","SYNFCP",166,0)
 . new fmBeginDateTime s fmBeginDateTime=$$fhirTfm^SYNFUTL(begindate)
"RTN","SYNFCP",167,0)
 . d log(jlog,"fileman beginDateTime is: "_fmBeginDateTime)
"RTN","SYNFCP",168,0)
 . set eval("careplan",zi,"vars","fmBeginDateTime")=fmBeginDateTime ;
"RTN","SYNFCP",169,0)
 . new hl7BeginDateTime s hl7BeginDateTime=$$fhirThl7^SYNFUTL(begindate)
"RTN","SYNFCP",170,0)
 . d log(jlog,"hl7 beginDateTime is: "_hl7BeginDateTime)
"RTN","SYNFCP",171,0)
 . set eval("careplan",zi,"vars","hl7BeginDateTime")=hl7BeginDateTime ;
"RTN","SYNFCP",172,0)
 . ;
"RTN","SYNFCP",173,0)
 . ; determine the end date and time, if any
"RTN","SYNFCP",174,0)
 . ;
"RTN","SYNFCP",175,0)
 . new enddate set enddate=$get(json("entry",zi,"resource","period","end"))
"RTN","SYNFCP",176,0)
 . new hl7EndDateTime s hl7EndDateTime=""
"RTN","SYNFCP",177,0)
 . if enddate'="" d  ;
"RTN","SYNFCP",178,0)
 . . do log(jlog,"endDateTime is: "_enddate)
"RTN","SYNFCP",179,0)
 . . set eval("careplan",zi,"vars","endDateTime")=enddate
"RTN","SYNFCP",180,0)
 . . new fmEndDateTime s fmEndDateTime=$$fhirTfm^SYNFUTL(enddate)
"RTN","SYNFCP",181,0)
 . . d log(jlog,"fileman endDateTime is: "_fmEndDateTime)
"RTN","SYNFCP",182,0)
 . . set eval("careplan",zi,"vars","fmEndDateTime")=fmEndDateTime ;
"RTN","SYNFCP",183,0)
 . . s hl7EndDateTime=$$fhirThl7^SYNFUTL(enddate)
"RTN","SYNFCP",184,0)
 . . d log(jlog,"hl7 endDateTime is: "_hl7EndDateTime)
"RTN","SYNFCP",185,0)
 . . set eval("careplan",zi,"vars","hl7EndDateTime")=hl7EndDateTime ;
"RTN","SYNFCP",186,0)
 . else  d log(jlog,"no endDateTime")
"RTN","SYNFCP",187,0)
 . ;
"RTN","SYNFCP",188,0)
 . ; determine careplan status (active vs inactive)
"RTN","SYNFCP",189,0)
 . ;
"RTN","SYNFCP",190,0)
 . n careplanstatus 
"RTN","SYNFCP",191,0)
 . set careplanstatus=$get(json("entry",zi,"resource","status"))
"RTN","SYNFCP",192,0)
 . d log(jlog,"CarePlan Status: "_careplanstatus)
"RTN","SYNFCP",193,0)
 . n catstr
"RTN","SYNFCP",194,0)
 . s catstr=sctcode_"~"_cattext_"~"_careplanstatus
"RTN","SYNFCP",195,0)
 . d log(jlog,"Care Plan Category string: "_catstr)
"RTN","SYNFCP",196,0)
 . ;
"RTN","SYNFCP",197,0)
 . ; add begindate, enddate, and careplanstatus to note
"RTN","SYNFCP",198,0)
 . d TONOTE^SYNFTIU(ien,encounterId,"  Begin Date: "_$$FMTE^XLFDT(begindate))
"RTN","SYNFCP",199,0)
 . d TONOTE^SYNFTIU(ien,encounterId,"  End Date: "_$$FMTE^XLFDT(enddate))
"RTN","SYNFCP",200,0)
 . d TONOTE^SYNFTIU(ien,encounterId,"  Status: "_careplanstatus)
"RTN","SYNFCP",201,0)
 . ; determine the encounter visit ien
"RTN","SYNFCP",202,0)
 . ;n encounterId
"RTN","SYNFCP",203,0)
 . ;s encounterId=$g(json("entry",zi,"resource","context","reference"))
"RTN","SYNFCP",204,0)
 . ;i encounterId["urn:uuid:" s encounterId=$p(encounterId,"urn:uuid:",2)
"RTN","SYNFCP",205,0)
 . ;s eval("careplan",zi,"vars","encounterId")=encounterId
"RTN","SYNFCP",206,0)
 . ;d log(jlog,"reference encounter ID is : "_encounterId)
"RTN","SYNFCP",207,0)
 . ;
"RTN","SYNFCP",208,0)
 . ; determine visit ien
"RTN","SYNFCP",209,0)
 . ;
"RTN","SYNFCP",210,0)
 . ;n visitIen s visitIen=$$visitIen^SYNFENC(ien,encounterId)
"RTN","SYNFCP",211,0)
 . ;s eval("careplan",zi,"vars","visitIen")=visitIen
"RTN","SYNFCP",212,0)
 . ;d log(jlog,"visit ien is: "_visitIen)
"RTN","SYNFCP",213,0)
 . ; 
"RTN","SYNFCP",214,0)
 . ; activities
"RTN","SYNFCP",215,0)
 . ;
"RTN","SYNFCP",216,0)
 . n actary,actstr,actien,an
"RTN","SYNFCP",217,0)
 . s actien=0
"RTN","SYNFCP",218,0)
 . s actary=""
"RTN","SYNFCP",219,0)
 . s actstr=""
"RTN","SYNFCP",220,0)
 . s an=$na(json("entry",zi,"resource","activity"))
"RTN","SYNFCP",221,0)
 . i $d(@an) d TONOTE^SYNFTIU(ien,encounterId,"Care Plan Activities")
"RTN","SYNFCP",222,0)
 . f  s actien=$o(@an@(actien)) q:+actien=0  d  ;
"RTN","SYNFCP",223,0)
 . . i actstr'="" s actstr=actstr_"^"
"RTN","SYNFCP",224,0)
 . . s actary(actien,"code")=$g(@an@(actien,"detail","code","coding",1,"code"))
"RTN","SYNFCP",225,0)
 . . s actstr=actstr_$g(@an@(actien,"detail","code","coding",1,"code"))
"RTN","SYNFCP",226,0)
 . . s actary(actien,"text")=$g(@an@(actien,"detail","code","coding",1,"display"))
"RTN","SYNFCP",227,0)
 . . s actstr=actstr_"~"_$g(@an@(actien,"detail","code","coding",1,"display"))
"RTN","SYNFCP",228,0)
 . . s actary(actien,"system")=$g(@an@(actien,"detail","code","coding",1,"system"))
"RTN","SYNFCP",229,0)
 . . s actary(actien,"status")=$g(@an@(actien,"detail","status"))
"RTN","SYNFCP",230,0)
 . . d TONOTE^SYNFTIU(ien,encounterId,"  "_$g(actary(actien,"text"))_" (SCT:"_$g(actary(actien,"code"))_")")
"RTN","SYNFCP",231,0)
 . . d TONOTE^SYNFTIU(ien,encounterId,"    status: "_$g(actary(actien,"status")))
"RTN","SYNFCP",232,0)
 . . s actary(actien,"hf")=$$HFACT^SYNFHF($g(actary(actien,"code")),$g(actary(actien,"text")),hfcatien)
"RTN","SYNFCP",233,0)
 . . d log(jlog,"CP Activity HF: "_$g(actary(actien,"hf")))
"RTN","SYNFCP",234,0)
 . . s actstr=actstr_"~"_$g(@an@(actien,"detail","status"))
"RTN","SYNFCP",235,0)
 . m eval("careplan",zi,"vars","activities")=actary
"RTN","SYNFCP",236,0)
 . s eval("careplan",zi,"vars","actString")=actstr
"RTN","SYNFCP",237,0)
 . d log(jlog,"Activity string: "_actstr)
"RTN","SYNFCP",238,0)
 . ;
"RTN","SYNFCP",239,0)
 . ; goals
"RTN","SYNFCP",240,0)
 . ;
"RTN","SYNFCP",241,0)
 . n goalary,goalstr,goalien,gn,goalcnt,goalroot,goaladdr
"RTN","SYNFCP",242,0)
 . s goalcnt=0
"RTN","SYNFCP",243,0)
 . s goalien=0
"RTN","SYNFCP",244,0)
 . s goalary=""
"RTN","SYNFCP",245,0)
 . s goalstr=""
"RTN","SYNFCP",246,0)
 . s gn=$na(json("entry",zi,"resource","goal"))
"RTN","SYNFCP",247,0)
 . n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFCP",248,0)
 . n groot s groot=$na(@root@(ien,"json","entry"))
"RTN","SYNFCP",249,0)
 . f  s goalien=$o(@gn@(goalien)) q:+goalien=0  d  ;
"RTN","SYNFCP",250,0)
 . . s goalcnt=goalcnt+1
"RTN","SYNFCP",251,0)
 . . i goalcnt=1 d TONOTE^SYNFTIU(ien,encounterId,"Care Plan Goals")
"RTN","SYNFCP",252,0)
 . . i goalstr'="" s goalstr=goalstr_"^"
"RTN","SYNFCP",253,0)
 . . s goalroot=$na(@groot@(zi-goalcnt))
"RTN","SYNFCP",254,0)
 . . ;b
"RTN","SYNFCP",255,0)
 . . i $g(@goalroot@("resource","resourceType"))'="Goal" q  ;
"RTN","SYNFCP",256,0)
 . . ;
"RTN","SYNFCP",257,0)
 . . ; determine the "addresses" code for the goal
"RTN","SYNFCP",258,0)
 . . ;
"RTN","SYNFCP",259,0)
 . . n addcode s addcode=""
"RTN","SYNFCP",260,0)
 . . n addrref
"RTN","SYNFCP",261,0)
 . . s addrref=$g(@goalroot@("resource","addresses",1,"reference"))
"RTN","SYNFCP",262,0)
 . . i addrref'="" d  ;
"RTN","SYNFCP",263,0)
 . . . d log(jlog,"Goal Addresses Reference: "_addrref)
"RTN","SYNFCP",264,0)
 . . . s addcode=$$DX^SYNFCP(ien,addrref)
"RTN","SYNFCP",265,0)
 . . . d log(jlog,"Goal Addresses Code: "_addcode)
"RTN","SYNFCP",266,0)
 . . e  d log(jlog,"No Goal Addresses Condition")
"RTN","SYNFCP",267,0)
 . . s goalary(goalien,"code")=+addcode
"RTN","SYNFCP",268,0)
 . . s goalstr=goalstr_+addcode
"RTN","SYNFCP",269,0)
 . . s goalary(goalien,"text")=$g(@goalroot@("resource","description","text"))
"RTN","SYNFCP",270,0)
 . . s goalstr=goalstr_"~"_$g(@goalroot@("resource","description","text"))
"RTN","SYNFCP",271,0)
 . . s goalary(goalien,"system")="SCT"
"RTN","SYNFCP",272,0)
 . . s goalary(goalien,"status")=$g(@goalroot@("resource","status"))
"RTN","SYNFCP",273,0)
 . . d TONOTE^SYNFTIU(ien,encounterId,"  "_$g(goalary(goalien,"text")))
"RTN","SYNFCP",274,0)
 . . d TONOTE^SYNFTIU(ien,encounterId,"    Adresses Condition: "_$p(addcode,"^",2)_" (SCT:"_+addcode_")")
"RTN","SYNFCP",275,0)
 . . d TONOTE^SYNFTIU(ien,encounterId,"    status: "_$g(goalary(goalien,"status")))
"RTN","SYNFCP",276,0)
 . . s goalary(goalien,"hf")=$$HFGOAL^SYNFHF($g(goalary(goalien,"code")),hfcatien,$g(goalary(goalien,"text")),$tr(addcode,"^","-"))
"RTN","SYNFCP",277,0)
 . . d log(jlog,"CP Goal HF: "_$g(goalary(goalien,"hf")))
"RTN","SYNFCP",278,0)
 . . s goalstr=goalstr_"~"_$g(@goalroot@("resource","status"))
"RTN","SYNFCP",279,0)
 . m eval("careplan",zi,"vars","goals")=goalary
"RTN","SYNFCP",280,0)
 . s eval("careplan",zi,"vars","goalString")=goalstr
"RTN","SYNFCP",281,0)
 . d:goalstr'="" log(jlog,"Goal string: "_goalstr)
"RTN","SYNFCP",282,0)
 . ;
"RTN","SYNFCP",283,0)
 . ;b
"RTN","SYNFCP",284,0)
 . ;
"RTN","SYNFCP",285,0)
 . ; set up to call the data loader
"RTN","SYNFCP",286,0)
 . ;
"RTN","SYNFCP",287,0)
 . ;CPLUPDT(RETSTA,DHPPAT,DHPVST,DHPCAT,DHPACT,DHPGOL,DHPSCT,DHPSDT,DHPEDT) ;
"RTN","SYNFCP",288,0)
 . ;
"RTN","SYNFCP",289,0)
 . ; Input:
"RTN","SYNFCP",290,0)
 . ; DHPPAT - Patient ICN
"RTN","SYNFCP",291,0)
 . ; DHPVST - Visit ID
"RTN","SYNFCP",292,0)
 . ; DHPCAT - Category ID (SCT code. text,and FHIR status )
"RTN","SYNFCP",293,0)
 . ; DHPACT - List of Activities (SCT code, text, and FHIR status )
"RTN","SYNFCP",294,0)
 . ; DHPGOL - List of Goals
"RTN","SYNFCP",295,0)
 . ; DHPSCT - Reason for CarePlan (SCT code)
"RTN","SYNFCP",296,0)
 . ; DHPSDT - CarePlan Period start
"RTN","SYNFCP",297,0)
 . ; DHPEDT - CarePlan period end (optional)
"RTN","SYNFCP",298,0)
 . ;
"RTN","SYNFCP",299,0)
 . ;
"RTN","SYNFCP",300,0)
 . ; Output: RETSTA
"RTN","SYNFCP",301,0)
 . ; 1 - success
"RTN","SYNFCP",302,0)
 . ; -1 - failure -1^message . ; 
"RTN","SYNFCP",303,0)
 . ;
"RTN","SYNFCP",304,0)
 . n RETSTA,DHPPAT,DHPVST,DHPCAT,DHPGOL,DHPSCT,DHPSDT,DHPEDT ;CarePlan update
"RTN","SYNFCP",305,0)
 . s (DHPPAT,DHPVST,DHPCAT,DHPGOL,DHPSCT,DHPSDT,DHPEDT)="" ;CarePlan update
"RTN","SYNFCP",306,0)
 . ;
"RTN","SYNFCP",307,0)
 . s DHPPAT=$$dfn2icn^SYNFUTL(dfn)
"RTN","SYNFCP",308,0)
 . s eval("careplan",zi,"parms","DHPPAT")=DHPPAT
"RTN","SYNFCP",309,0)
 . ;
"RTN","SYNFCP",310,0)
 . s DHPVST=visitIen
"RTN","SYNFCP",311,0)
 . s eval("careplan",zi,"parms","DHPVST")=visitIen
"RTN","SYNFCP",312,0)
 . ;
"RTN","SYNFCP",313,0)
 . s DHPSCT=$s(addcode'="":+addcode,1:"")
"RTN","SYNFCP",314,0)
 . s eval("careplan",zi,"parms","DHPSCT")=DHPSCT
"RTN","SYNFCP",315,0)
 . ;
"RTN","SYNFCP",316,0)
 . s DHPCAT=$g(catstr)
"RTN","SYNFCP",317,0)
 . s eval("careplan",zi,"parms","DHPCAT")=DHPCAT
"RTN","SYNFCP",318,0)
 . ;
"RTN","SYNFCP",319,0)
 . s DHPSDT=$g(hl7BeginDateTime)
"RTN","SYNFCP",320,0)
 . s eval("careplan",zi,"parms","DHPSDT")=DHPSDT
"RTN","SYNFCP",321,0)
 . ;
"RTN","SYNFCP",322,0)
 . s DHPEDT=$g(hl7EndDateTime)
"RTN","SYNFCP",323,0)
 . s eval("careplan",zi,"parms","DHPEDT")=DHPEDT
"RTN","SYNFCP",324,0)
 . ;
"RTN","SYNFCP",325,0)
 . s DHPACT=actstr
"RTN","SYNFCP",326,0)
 . s eval("careplan",zi,"parms","DHPACT")=DHPACT
"RTN","SYNFCP",327,0)
 . ;
"RTN","SYNFCP",328,0)
 . s DHPGOL=goalstr
"RTN","SYNFCP",329,0)
 . s eval("careplan",zi,"parms","DHPGOL")=DHPGOL
"RTN","SYNFCP",330,0)
 . ;
"RTN","SYNFCP",331,0)
 . ;s DHPROV=$$MAP^SYNQLDM("OP","provider") ; map should return the NPI number
"RTN","SYNFCP",332,0)
 . ;s eval("careplan",zi,"parms","DHPROV")=DHPROV
"RTN","SYNFCP",333,0)
 . ;d log(jlog,"Provider NPI for outpatient is: "_DHPROV)
"RTN","SYNFCP",334,0)
 . ;
"RTN","SYNFCP",335,0)
 . ;s DHPLOC=$$MAP^SYNQLDM("OP","location")
"RTN","SYNFCP",336,0)
 . ;n DHPLOCIEN s DHPLOCIEN=$o(^SC("B",DHPLOC,""))
"RTN","SYNFCP",337,0)
 . ;if DHPLOCIEN="" S DHPLOCIEN=4
"RTN","SYNFCP",338,0)
 . ;s eval("careplan",zi,"parms","DHPLOC")=DHPLOCIEN
"RTN","SYNFCP",339,0)
 . ;d log(jlog,"Location for outpatient is: #"_DHPLOCIEN_" "_DHPLOC)
"RTN","SYNFCP",340,0)
 . ;
"RTN","SYNFCP",341,0)
 . s eval("careplan",zi,"status","loadstatus")="readyToLoad"
"RTN","SYNFCP",342,0)
 . ;
"RTN","SYNFCP",343,0)
 . if $g(args("load"))=1 d  ; only load if told to
"RTN","SYNFCP",344,0)
 . . if $g(ien)'="" if $$loadStatus("careplan",zi,ien)=1 do  quit  ;
"RTN","SYNFCP",345,0)
 . . . d log(jlog,"CarePlan already loaded, skipping")
"RTN","SYNFCP",346,0)
 . . d  ;  use DATA2PCE
"RTN","SYNFCP",347,0)
 . . . d log(jlog,"Calling CPLUPDT^SYNDHP91 to add care plans")
"RTN","SYNFCP",348,0)
 . . . D CPLUPDT^SYNDHP91(.RETSTA,DHPPAT,DHPVST,DHPCAT,DHPACT,DHPGOL,DHPSCT,DHPSDT,DHPEDT) ;
"RTN","SYNFCP",349,0)
 . . m eval("careplan",zi,"status")=RETSTA
"RTN","SYNFCP",350,0)
 . . i $g(DEBUG)=1 ZWR RETSTA
"RTN","SYNFCP",351,0)
 . . d log(jlog,"Return from data loader was: "_$g(RETSTA))
"RTN","SYNFCP",352,0)
 . . if +$g(RETSTA)=1 do  ;
"RTN","SYNFCP",353,0)
 . . . s eval("status","loaded")=$g(eval("status","loaded"))+1
"RTN","SYNFCP",354,0)
 . . . s eval("careplan",zi,"status","loadstatus")="loaded"
"RTN","SYNFCP",355,0)
 . . else  d  ;
"RTN","SYNFCP",356,0)
 . . . s eval("status","errors")=$g(eval("status","errors"))+1
"RTN","SYNFCP",357,0)
 . . . s eval("careplan",zi,"status","loadstatus")="notLoaded"
"RTN","SYNFCP",358,0)
 . . . s eval("careplan",zi,"status","loadMessage")=$g(RETSTA)
"RTN","SYNFCP",359,0)
 . . n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFCP",360,0)
 . . k @root@(ien,"load","careplan",zi)
"RTN","SYNFCP",361,0)
 . . m @root@(ien,"load","careplan",zi)=eval("careplan",zi)
"RTN","SYNFCP",362,0)
 ;
"RTN","SYNFCP",363,0)
 if $get(args("debug"))=1 do  ;
"RTN","SYNFCP",364,0)
 . m jrslt("source")=json
"RTN","SYNFCP",365,0)
 . m jrslt("args")=args
"RTN","SYNFCP",366,0)
 . m jrslt("eval")=eval
"RTN","SYNFCP",367,0)
 m jrslt("careplanStatus")=eval("careplanStatus")
"RTN","SYNFCP",368,0)
 set jrslt("result","status")="ok"
"RTN","SYNFCP",369,0)
 set jrslt("result","loaded")=$g(eval("status","loaded"))
"RTN","SYNFCP",370,0)
 i $g(ien)'="" d  ; called internally
"RTN","SYNFCP",371,0)
 . m result=eval
"RTN","SYNFCP",372,0)
 . m result("status")=jrslt("result")
"RTN","SYNFCP",373,0)
 . m result("dfn")=dfn
"RTN","SYNFCP",374,0)
 . m result("ien")=ien
"RTN","SYNFCP",375,0)
 . ;b
"RTN","SYNFCP",376,0)
 e  d  ;
"RTN","SYNFCP",377,0)
 . d ENCODE^VPRJSON("jrslt","result")
"RTN","SYNFCP",378,0)
 . set HTTPRSP("mime")="application/json" 
"RTN","SYNFCP",379,0)
 q
"RTN","SYNFCP",380,0)
 ;
"RTN","SYNFCP",381,0)
log(ary,txt)    ; adds a text line to @ary@("log")
"RTN","SYNFCP",382,0)
 s @ary@("log",$o(@ary@("log",""),-1)+1)=$g(txt)
"RTN","SYNFCP",383,0)
 w:$G(DEBUG) !,"      ",$G(txt)
"RTN","SYNFCP",384,0)
 q
"RTN","SYNFCP",385,0)
 ;
"RTN","SYNFCP",386,0)
loadStatus(typ,zx,zien) ; extrinsic return 1 if resource was loaded
"RTN","SYNFCP",387,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFCP",388,0)
 n rt s rt=0
"RTN","SYNFCP",389,0)
 i $g(zx)="" i $d(@root@(zien,"load",typ)) s rt=1 q rt
"RTN","SYNFCP",390,0)
 i '$d(@root@(zien,"load",typ,zx,"status")) q rt
"RTN","SYNFCP",391,0)
 i $get(@root@(zien,"load",typ,zx,"status","loadstatus"))="loaded" s rt=1
"RTN","SYNFCP",392,0)
 q rt
"RTN","SYNFCP",393,0)
 ;
"RTN","SYNFCP",394,0)
DX(ien,ptr,sep) ; extrinsic returns code^text for diagnosis in 
"RTN","SYNFCP",395,0)
 ; a condition pointed to by ptr in patient ien
"RTN","SYNFCP",396,0)
 ; sep is optional separator - default is "^"
"RTN","SYNFCP",397,0)
 i $g(sep)="" s sep="^"
"RTN","SYNFCP",398,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFCP",399,0)
 i '$d(@root@(ien,"SPO",ptr)) q ""
"RTN","SYNFCP",400,0)
 n sct,txt,rien
"RTN","SYNFCP",401,0)
 i $o(@root@(ien,"SPO",ptr,"type",""))'="Condition" q ""
"RTN","SYNFCP",402,0)
 s rien=$o(@root@(ien,"SPO",ptr,"rien",""))
"RTN","SYNFCP",403,0)
 q:rien="" ""
"RTN","SYNFCP",404,0)
 s sct=$g(@root@(ien,"json","entry",rien,"resource","code","coding",1,"code"))
"RTN","SYNFCP",405,0)
 q:sct="" ""
"RTN","SYNFCP",406,0)
 s txt=$g(@root@(ien,"json","entry",rien,"resource","code","coding",1,"display"))
"RTN","SYNFCP",407,0)
 q sct_sep_txt
"RTN","SYNFCP",408,0)
 ;
"RTN","SYNFCP",409,0)
testall ; run the careplan import on all imported patients
"RTN","SYNFCP",410,0)
 new root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFCP",411,0)
 new indx s indx=$na(@root@("POS","DFN"))
"RTN","SYNFCP",412,0)
 n dfn,ien,filter,reslt
"RTN","SYNFCP",413,0)
 s dfn=0
"RTN","SYNFCP",414,0)
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  d  ;
"RTN","SYNFCP",415,0)
 . s ien=$o(@indx@(dfn,""))
"RTN","SYNFCP",416,0)
 . q:ien=""
"RTN","SYNFCP",417,0)
 . s filter("dfn")=dfn
"RTN","SYNFCP",418,0)
 . k reslt
"RTN","SYNFCP",419,0)
 . d wsIntakeCareplan(.filter,,.reslt,ien)
"RTN","SYNFCP",420,0)
 q
"RTN","SYNFCP",421,0)
 ;
"RTN","SYNFCP",422,0)
testone(reslt,doload)   ; run the careplan import on all imported patients
"RTN","SYNFCP",423,0)
 new root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFCP",424,0)
 new indx s indx=$na(@root@("POS","DFN"))
"RTN","SYNFCP",425,0)
 n dfn,ien,filter
"RTN","SYNFCP",426,0)
 n done s done=0
"RTN","SYNFCP",427,0)
 s dfn=0
"RTN","SYNFCP",428,0)
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  q:done   d  ;
"RTN","SYNFCP",429,0)
 . s ien=$o(@indx@(dfn,""))
"RTN","SYNFCP",430,0)
 . q:ien=""
"RTN","SYNFCP",431,0)
 . q:$d(@root@(ien,"load","careplan"))
"RTN","SYNFCP",432,0)
 . s filter("dfn")=dfn
"RTN","SYNFCP",433,0)
 . s filter("debug")=1
"RTN","SYNFCP",434,0)
 . i $g(doload)=1 s filter("load")=1
"RTN","SYNFCP",435,0)
 . k reslt
"RTN","SYNFCP",436,0)
 . d wsIntakeCareplan(.filter,,.reslt,ien)
"RTN","SYNFCP",437,0)
 . s done=1
"RTN","SYNFCP",438,0)
 q
"RTN","SYNFCP",439,0)
 ;
"RTN","SYNFENC")
0^27^B161051849
"RTN","SYNFENC",1,0)
SYNFENC ;ven/gpl - fhir loader utilities ;2018-08-17  3:28 PM
"RTN","SYNFENC",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNFENC",3,0)
 ;
"RTN","SYNFENC",4,0)
 ; Authored by George P. Lilly 2017-2018
"RTN","SYNFENC",5,0)
 ;
"RTN","SYNFENC",6,0)
 q
"RTN","SYNFENC",7,0)
 ;
"RTN","SYNFENC",8,0)
importEncounters(rtn,ien,args)  ; entry point for loading encounters for a patient
"RTN","SYNFENC",9,0)
 ; calls the intake Encounters web service directly
"RTN","SYNFENC",10,0)
 ;
"RTN","SYNFENC",11,0)
 n grtn
"RTN","SYNFENC",12,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFENC",13,0)
 d wsIntakeEncounters(.args,,.grtn,ien)
"RTN","SYNFENC",14,0)
 i $d(grtn) d  ; something was returned
"RTN","SYNFENC",15,0)
 . k @root@(ien,"load","encounters")
"RTN","SYNFENC",16,0)
 . m @root@(ien,"load","encounters")=grtn("encounters")
"RTN","SYNFENC",17,0)
 . if $g(args("debug"))=1 m rtn=grtn
"RTN","SYNFENC",18,0)
 s rtn("encountersStatus","status")=$g(grtn("status","status"))
"RTN","SYNFENC",19,0)
 s rtn("encountersStatus","loaded")=$g(grtn("status","loaded"))
"RTN","SYNFENC",20,0)
 s rtn("encountersStatus","errors")=$g(grtn("status","errors"))
"RTN","SYNFENC",21,0)
 ;b
"RTN","SYNFENC",22,0)
 ;
"RTN","SYNFENC",23,0)
 ;
"RTN","SYNFENC",24,0)
 q
"RTN","SYNFENC",25,0)
 ;
"RTN","SYNFENC",26,0)
wsIntakeEncounters(args,body,result,ien)        ; web service entry (post)
"RTN","SYNFENC",27,0)
 ; for intake of one or more Encounters. input are fhir resources
"RTN","SYNFENC",28,0)
 ; result is json and summarizes what was done
"RTN","SYNFENC",29,0)
 ; args include patientId
"RTN","SYNFENC",30,0)
 ; ien is specified for internal calls, where the json is already in a graph
"RTN","SYNFENC",31,0)
 n jtmp,json,jrslt,eval
"RTN","SYNFENC",32,0)
 ;i $g(ien)'="" if $$loadStatus("encounters","",ien)=1 d  q  ;
"RTN","SYNFENC",33,0)
 ;. s result("encountersStatus","status")="alreadyLoaded"
"RTN","SYNFENC",34,0)
 i $g(ien)'="" d  ; internal call
"RTN","SYNFENC",35,0)
 . d getIntakeFhir^SYNFHIR("json",,"Encounter",ien,1)
"RTN","SYNFENC",36,0)
 e  d  ; 
"RTN","SYNFENC",37,0)
 . ;s args("load")=0
"RTN","SYNFENC",38,0)
 . merge jtmp=BODY
"RTN","SYNFENC",39,0)
 . do DECODE^VPRJSON("jtmp","json")
"RTN","SYNFENC",40,0)
 i '$d(json) q  ;
"RTN","SYNFENC",41,0)
 m ^gpl("gjson")=json
"RTN","SYNFENC",42,0)
 ;
"RTN","SYNFENC",43,0)
 ; determine the patient
"RTN","SYNFENC",44,0)
 ;
"RTN","SYNFENC",45,0)
 n dfn,eval
"RTN","SYNFENC",46,0)
 if $g(ien)'="" d  ;
"RTN","SYNFENC",47,0)
 . s dfn=$$ien2dfn^SYNFUTL(ien) ; look up dfn in the graph
"RTN","SYNFENC",48,0)
 else  d  ;
"RTN","SYNFENC",49,0)
 . s dfn=$g(args("dfn"))
"RTN","SYNFENC",50,0)
 . i dfn="" d  ;
"RTN","SYNFENC",51,0)
 . . n icn s icn=$g(args("icn"))
"RTN","SYNFENC",52,0)
 . . i icn'="" s dfn=$$icn2dfn^SYNFUTL(icn)
"RTN","SYNFENC",53,0)
 i $g(dfn)="" do  quit  ; need the patient
"RTN","SYNFENC",54,0)
 . s result("encounters",1,"log",1)="Error, patient not found.. terminating"
"RTN","SYNFENC",55,0)
 ;
"RTN","SYNFENC",56,0)
 ;
"RTN","SYNFENC",57,0)
 new zi s zi=0
"RTN","SYNFENC",58,0)
 for  set zi=$order(json("entry",zi)) quit:+zi=0  do  ;
"RTN","SYNFENC",59,0)
 . ;
"RTN","SYNFENC",60,0)
 . ; define a place to log the processing of this entry
"RTN","SYNFENC",61,0)
 . ;
"RTN","SYNFENC",62,0)
 . new jlog set jlog=$name(eval("encounters",zi))
"RTN","SYNFENC",63,0)
 . ;
"RTN","SYNFENC",64,0)
 . ; insure that the resourceType is Encounter
"RTN","SYNFENC",65,0)
 . ;
"RTN","SYNFENC",66,0)
 . new type set type=$get(json("entry",zi,"resource","resourceType"))
"RTN","SYNFENC",67,0)
 . if type'="Encounter" do  quit  ;
"RTN","SYNFENC",68,0)
 . . set eval("encounters",zi,"vars","resourceType")=type
"RTN","SYNFENC",69,0)
 . . do log(jlog,"Resource type not Observation, skipping entry")
"RTN","SYNFENC",70,0)
 . set eval("encounters",zi,"vars","resourceType")=type
"RTN","SYNFENC",71,0)
 . ;
"RTN","SYNFENC",72,0)
 . ; see if this resource has already been loaded. if so, skip it
"RTN","SYNFENC",73,0)
 . ;
"RTN","SYNFENC",74,0)
 . if $g(ien)'="" if $$loadStatus("encounters",zi,ien)=1 do  quit  ;
"RTN","SYNFENC",75,0)
 . . d log(jlog,"Vital sign already loaded, skipping")
"RTN","SYNFENC",76,0)
 . ;
"RTN","SYNFENC",77,0)
 . ; determine Encounters code, coding system, and display text
"RTN","SYNFENC",78,0)
 . ;
"RTN","SYNFENC",79,0)
 . ;
"RTN","SYNFENC",80,0)
 . ; determine the id of the resource
"RTN","SYNFENC",81,0)
 . ;
"RTN","SYNFENC",82,0)
 . new id set id=$get(json("entry",zi,"resource","id"))
"RTN","SYNFENC",83,0)
 . set eval("encounters",zi,"vars","id")=id
"RTN","SYNFENC",84,0)
 . d log(jlog,"ID is: "_id)
"RTN","SYNFENC",85,0)
 . ;
"RTN","SYNFENC",86,0)
 . new enccode set enccode=$get(json("entry",zi,"resource","type",1,"coding",1,"code"))
"RTN","SYNFENC",87,0)
 . ;n visitcpt s visitcpt=$$MAP^SYNQLDM(enccode)
"RTN","SYNFENC",88,0)
 . ;i visitcpt="" d  ;
"RTN","SYNFENC",89,0)
 . ;. d MAPERR^SYNQLDM(enccode,"sct2cpt")
"RTN","SYNFENC",90,0)
 . ;. d log(jlog,"-1^Encounter code does not map: "_enccode)
"RTN","SYNFENC",91,0)
 . i enccode="" s enccode=185349003 ; generic visit
"RTN","SYNFENC",92,0)
 . do log(jlog,"code is: "_enccode)
"RTN","SYNFENC",93,0)
 . set eval("encounters",zi,"vars","code")=enccode
"RTN","SYNFENC",94,0)
 . ;
"RTN","SYNFENC",95,0)
 . ;
"RTN","SYNFENC",96,0)
 . new codesystem set codesystem=$get(json("entry",zi,"resource","type",1,"coding",1,"system"))
"RTN","SYNFENC",97,0)
 . do log(jlog,"code system is: "_codesystem)
"RTN","SYNFENC",98,0)
 . set eval("encounters",zi,"vars","codeSystem")=codesystem
"RTN","SYNFENC",99,0)
 . ;
"RTN","SYNFENC",100,0)
 . ; determine the reason code and system (Encounter Diagnosis)
"RTN","SYNFENC",101,0)
 . ;
"RTN","SYNFENC",102,0)
 . n reasoncode s reasoncode=$get(json("entry",zi,"resource","reason","coding",1,"code"))
"RTN","SYNFENC",103,0)
 . d log(jlog,"reasonCode is: "_reasoncode)
"RTN","SYNFENC",104,0)
 . set eval("encounters",zi,"vars","reasonCode")=reasoncode
"RTN","SYNFENC",105,0)
 . ;
"RTN","SYNFENC",106,0)
 . ; determine reason code system
"RTN","SYNFENC",107,0)
 . ;
"RTN","SYNFENC",108,0)
 . new reasoncdsys set reasoncdsys=$get(json("entry",zi,"resource","reason","coding",1,"system"))
"RTN","SYNFENC",109,0)
 . d log(jlog,"reasonCode system is: "_reasoncdsys)
"RTN","SYNFENC",110,0)
 . set eval("encounters",zi,"vars","reasonCodeSys")=reasoncdsys
"RTN","SYNFENC",111,0)
 . ;
"RTN","SYNFENC",112,0)
 . ; determine the effective date
"RTN","SYNFENC",113,0)
 . ;
"RTN","SYNFENC",114,0)
 . new effdate set effdate=$get(json("entry",zi,"resource","period","start"))
"RTN","SYNFENC",115,0)
 . do log(jlog,"effectiveDateTime is: "_effdate)
"RTN","SYNFENC",116,0)
 . set eval("encounters",zi,"vars","effectiveDateTime")=effdate
"RTN","SYNFENC",117,0)
 . new fmtime s fmtime=$$fhirTfm^SYNFUTL(effdate)
"RTN","SYNFENC",118,0)
 . d log(jlog,"fileman dateTime is: "_fmtime)
"RTN","SYNFENC",119,0)
 . set eval("encounters",zi,"vars","fmDateTime")=fmtime ;
"RTN","SYNFENC",120,0)
 . new hl7time s hl7time=$$fhirThl7^SYNFUTL(effdate)
"RTN","SYNFENC",121,0)
 . d log(jlog,"hl7 dateTime is: "_hl7time)
"RTN","SYNFENC",122,0)
 . set eval("encounters",zi,"vars","hl7DateTime")=hl7time ;
"RTN","SYNFENC",123,0)
 . ;
"RTN","SYNFENC",124,0)
 . new effdateEnd set effdateEnd=$get(json("entry",zi,"resource","period","end"))
"RTN","SYNFENC",125,0)
 . do log(jlog,"endDateTime is: "_effdateEnd)
"RTN","SYNFENC",126,0)
 . set eval("encounters",zi,"vars","endDateTime")=effdateEnd
"RTN","SYNFENC",127,0)
 . new fmtimeEnd s fmtimeEnd=$$fhirTfm^SYNFUTL(effdateEnd)
"RTN","SYNFENC",128,0)
 . d log(jlog,"fileman endDateTime is: "_fmtimeEnd)
"RTN","SYNFENC",129,0)
 . set eval("encounters",zi,"vars","fmEndDateTime")=fmtimeEnd ;
"RTN","SYNFENC",130,0)
 . new hl7endTime s hl7endTime=$$fhirThl7^SYNFUTL(effdateEnd)
"RTN","SYNFENC",131,0)
 . d log(jlog,"hl7 endDateTime is: "_hl7endTime)
"RTN","SYNFENC",132,0)
 . set eval("encounters",zi,"vars","hl7endDateTime")=hl7endTime ;
"RTN","SYNFENC",133,0)
 . ;
"RTN","SYNFENC",134,0)
 . ; set up to call the data loader
"RTN","SYNFENC",135,0)
 . ;
"RTN","SYNFENC",136,0)
 . ;ENCTUPD(RETSTA,DHPPAT,STARTDT,ENDDT,ENCPROV,CLINIC,SCTDX,SCTCPT)     ;Encounter update
"RTN","SYNFENC",137,0)
 . ;
"RTN","SYNFENC",138,0)
 . n RETSTA,DHPPAT,STARTDT,ENDDT,ENCPROV,CLINIC,SCTDX,SCTCPT
"RTN","SYNFENC",139,0)
 . ;
"RTN","SYNFENC",140,0)
 . s DHPPAT=$$dfn2icn^SYNFUTL(dfn)
"RTN","SYNFENC",141,0)
 . s eval("encounters",zi,"parms","DHPPAT")=DHPPAT
"RTN","SYNFENC",142,0)
 . ;
"RTN","SYNFENC",143,0)
 . s SCTCPT=enccode
"RTN","SYNFENC",144,0)
 . s eval("encounters",zi,"parms","SCTCPT")=SCTCPT
"RTN","SYNFENC",145,0)
 . ;
"RTN","SYNFENC",146,0)
 . ; reason code
"RTN","SYNFENC",147,0)
 . s SCTDX=reasoncode
"RTN","SYNFENC",148,0)
 . s eval("encounters",zi,"parms","SCTDX")=SCTDX
"RTN","SYNFENC",149,0)
 . ;
"RTN","SYNFENC",150,0)
 . s STARTDT=hl7time
"RTN","SYNFENC",151,0)
 . s eval("encounters",zi,"parms","STARTDT")=hl7time
"RTN","SYNFENC",152,0)
 . d log(jlog,"HL7 StartDateTime is: "_hl7time)
"RTN","SYNFENC",153,0)
 . ;
"RTN","SYNFENC",154,0)
 . s ENDDT=hl7endTime
"RTN","SYNFENC",155,0)
 . s eval("encounters",zi,"parms","ENDDT")=ENDDT
"RTN","SYNFENC",156,0)
 . d log(jlog,"HL7 End DateTime is: "_ENDDT)
"RTN","SYNFENC",157,0)
 . ;
"RTN","SYNFENC",158,0)
 . ; reason code
"RTN","SYNFENC",159,0)
 . s SCTDX=reasoncode
"RTN","SYNFENC",160,0)
 . n icdcode,icdcodetype,notmapped,sctcode
"RTN","SYNFENC",161,0)
 . s icdcode=""
"RTN","SYNFENC",162,0)
 . s sctcode=reasoncode
"RTN","SYNFENC",163,0)
 . s notmapped=0
"RTN","SYNFENC",164,0)
 . ;i sctcode'="" q:'$d(^BSTS)  d
"RTN","SYNFENC",165,0)
 . i sctcode'=""  d  ;
"RTN","SYNFENC",166,0)
 . . i fmtime<3151001 s icdcodetype="icd9"
"RTN","SYNFENC",167,0)
 . . e  s icdcodetype="icd10"
"RTN","SYNFENC",168,0)
 . . d log(jlog,"icd code type is: "_icdcodetype)
"RTN","SYNFENC",169,0)
 . . i icdcodetype="icd9" s icdcode=$$MAP^SYNDHPMP("sct2icdnine",sctcode)
"RTN","SYNFENC",170,0)
 . . e  s icdcode=$$MAP^SYNDHPMP("sct2icd",sctcode)
"RTN","SYNFENC",171,0)
 . . i +icdcode=-1 s notmapped=1
"RTN","SYNFENC",172,0)
 . . d:notmapped MAPERR^SYNQLDM(sctcode,icdcodetype)
"RTN","SYNFENC",173,0)
 . . do log(jlog,"icd mapping is: "_icdcode)
"RTN","SYNFENC",174,0)
 . . do:notmapped log(jlog,"snomed code "_sctcode_" is not mapped")
"RTN","SYNFENC",175,0)
 . . set eval("conditions",zi,"vars","mappedIcdCode")=icdcode
"RTN","SYNFENC",176,0)
 . s eval("encounters",zi,"parms","SCTDX")=SCTDX
"RTN","SYNFENC",177,0)
 . ;
"RTN","SYNFENC",178,0)
 . s ENCPROV=$$MAP^SYNQLDM("OP","provider") ; map should return the NPI number
"RTN","SYNFENC",179,0)
 . ;n DHPPROVIEN s DHPPROVIEN=$o(^VA(200,"B",ENCPROV,"")) ; this has to be the NPI number
"RTN","SYNFENC",180,0)
 . ;if DHPPROVIEN="" S DHPPROVIEN=3
"RTN","SYNFENC",181,0)
 . s eval("encounters",zi,"parms","ENCPROV")=ENCPROV
"RTN","SYNFENC",182,0)
 . d log(jlog,"Provider for outpatient is: "_ENCPROV)
"RTN","SYNFENC",183,0)
 . ;
"RTN","SYNFENC",184,0)
 . s CLINIC=$$MAP^SYNQLDM("OP","location") ; map containes the name of the clinic file #44
"RTN","SYNFENC",185,0)
 . ;n DHPLOCIEN s DHPLOCIEN=$o(^SC("B",CLINIC,""))
"RTN","SYNFENC",186,0)
 . ;if DHPLOCIEN="" S DHPLOCIEN=4
"RTN","SYNFENC",187,0)
 . s eval("encounters",zi,"parms","CLINIC")=CLINIC
"RTN","SYNFENC",188,0)
 . d log(jlog,"Location for outpatient is: "_CLINIC)
"RTN","SYNFENC",189,0)
 . ;
"RTN","SYNFENC",190,0)
 . s eval("encounters",zi,"status","loadstatus")="readyToLoad"
"RTN","SYNFENC",191,0)
 . ;
"RTN","SYNFENC",192,0)
 . if $g(args("load"))=1 d  ; only load if told to
"RTN","SYNFENC",193,0)
 . . if $g(ien)="" n ien s ien=$$dfn2ien^SYNFUTL(dfn)
"RTN","SYNFENC",194,0)
 . . i ien="" q  ;
"RTN","SYNFENC",195,0)
 . . if $$loadStatus("encounters",zi,ien)=1 do  quit  ;
"RTN","SYNFENC",196,0)
 . . . d log(jlog,"Encounter already loaded, skipping")
"RTN","SYNFENC",197,0)
 . . d log(jlog,"Calling ENCTUPD^SYNDHP61 data loader to add encounter")
"RTN","SYNFENC",198,0)
 . . d ENCTUPD^SYNDHP61(.RETSTA,DHPPAT,STARTDT,ENDDT,ENCPROV,CLINIC,SCTDX,SCTCPT)        ;Encounter update
"RTN","SYNFENC",199,0)
 . . d log(jlog,"Return from data loader was: "_$g(RETSTA))
"RTN","SYNFENC",200,0)
 . . ;
"RTN","SYNFENC",201,0)
 . . m eval("encounters",zi,"status","return")=RETSTA
"RTN","SYNFENC",202,0)
 . . i $g(DEBUG)=1 ZWR RETSTA
"RTN","SYNFENC",203,0)
 . . n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFENC",204,0)
 . . n visitIen s visitIen=$p(RETSTA,"^",2) ; returned visit ien
"RTN","SYNFENC",205,0)
 . . i +visitIen>0 d
"RTN","SYNFENC",206,0)
 . . . ;
"RTN","SYNFENC",207,0)
 . . . n groot s groot=$na(@root@(ien))
"RTN","SYNFENC",208,0)
 . . . d setIndex^SYNFHIR(groot,id,"visitIen",visitIen) ; save the visit ien in the indexes
"RTN","SYNFENC",209,0)
 . . . s eval("encounters",zi,"visitIen")=visitIen
"RTN","SYNFENC",210,0)
 . . e  s visitIen=""
"RTN","SYNFENC",211,0)
 . . if +$g(RETSTA)=1 do  ;
"RTN","SYNFENC",212,0)
 . . . s eval("status","loaded")=$g(eval("status","loaded"))+1
"RTN","SYNFENC",213,0)
 . . . s eval("encounters",zi,"status","loadstatus")="loaded"
"RTN","SYNFENC",214,0)
 . . else  d  ;
"RTN","SYNFENC",215,0)
 . . . s eval("status","errors")=$g(eval("status","errors"))+1
"RTN","SYNFENC",216,0)
 . . . s eval("encounters",zi,"status","loadstatus")="notLoaded"
"RTN","SYNFENC",217,0)
 . . . s eval("encounters",zi,"status","loadMessage")=$g(RETSTA)
"RTN","SYNFENC",218,0)
 . . k @root@(ien,"load","encounters",zi)
"RTN","SYNFENC",219,0)
 . . m @root@(ien,"load","encounters",zi)=eval("encounters",zi)
"RTN","SYNFENC",220,0)
 ;
"RTN","SYNFENC",221,0)
 if $get(args("debug"))=1 do  ;
"RTN","SYNFENC",222,0)
 . m jrslt("source")=json
"RTN","SYNFENC",223,0)
 . m jrslt("args")=args
"RTN","SYNFENC",224,0)
 . m jrslt("eval")=eval
"RTN","SYNFENC",225,0)
 m jrslt("encountersStatus")=eval("encountersStatus")
"RTN","SYNFENC",226,0)
 set jrslt("result","status")="ok"
"RTN","SYNFENC",227,0)
 set jrslt("result","loaded")=$g(eval("status","loaded"))
"RTN","SYNFENC",228,0)
 i $g(ien)'="" d  ; called internally
"RTN","SYNFENC",229,0)
 . m result=eval
"RTN","SYNFENC",230,0)
 . m result("status")=jrslt("result")
"RTN","SYNFENC",231,0)
 . ;b
"RTN","SYNFENC",232,0)
 e  d  ;
"RTN","SYNFENC",233,0)
 . d ENCODE^VPRJSON("jrslt","result")
"RTN","SYNFENC",234,0)
 . set HTTPRSP("mime")="application/json" 
"RTN","SYNFENC",235,0)
 q
"RTN","SYNFENC",236,0)
 ;
"RTN","SYNFENC",237,0)
log(ary,txt)    ; adds a text line to @ary@("log")
"RTN","SYNFENC",238,0)
 s @ary@("log",$o(@ary@("log",""),-1)+1)=$g(txt)
"RTN","SYNFENC",239,0)
 w:$G(DEBUG) !,"      ",$G(txt)
"RTN","SYNFENC",240,0)
 q
"RTN","SYNFENC",241,0)
 ;
"RTN","SYNFENC",242,0)
loadStatus(typ,zx,zien) ; extrinsic return 1 if resource was loaded
"RTN","SYNFENC",243,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFENC",244,0)
 n rt s rt=0
"RTN","SYNFENC",245,0)
 i $g(zx)="" i $d(@root@(zien,"load",typ)) s rt=1 q rt
"RTN","SYNFENC",246,0)
 i $get(@root@(zien,"load",typ,zx,"status","loadstatus"))="loaded" s rt=1
"RTN","SYNFENC",247,0)
 q rt
"RTN","SYNFENC",248,0)
 ;
"RTN","SYNFENC",249,0)
visitIen(ien,encId)     ; extrinsic returns the visit ien for the Encounter ID
"RTN","SYNFENC",250,0)
 ; returns -1 if none found
"RTN","SYNFENC",251,0)
 i $g(encId)="" q -1
"RTN","SYNFENC",252,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFENC",253,0)
 n useenc s useenc=encId
"RTN","SYNFENC",254,0)
 i useenc["urn:uuid:" s useenc=$p(useenc,"urn:uuid:",2)
"RTN","SYNFENC",255,0)
 n vrtn
"RTN","SYNFENC",256,0)
 s vrtn=$o(@root@(ien,"SPO",useenc,"visitIen",""))
"RTN","SYNFENC",257,0)
 i vrtn="" s vrtn=-1
"RTN","SYNFENC",258,0)
 q vrtn
"RTN","SYNFENC",259,0)
 ;
"RTN","SYNFENC",260,0)
testall ; run the encounters import on all imported patients
"RTN","SYNFENC",261,0)
 new root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFENC",262,0)
 new indx s indx=$na(@root@("POS","DFN"))
"RTN","SYNFENC",263,0)
 n dfn,ien,filter,reslt
"RTN","SYNFENC",264,0)
 s dfn=0
"RTN","SYNFENC",265,0)
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  d  ;
"RTN","SYNFENC",266,0)
 . s ien=$o(@indx@(dfn,""))
"RTN","SYNFENC",267,0)
 . q:ien=""
"RTN","SYNFENC",268,0)
 . s filter("dfn")=dfn
"RTN","SYNFENC",269,0)
 . k reslt
"RTN","SYNFENC",270,0)
 . d wsIntakeEncounters(.filter,,.reslt,ien)
"RTN","SYNFENC",271,0)
 q
"RTN","SYNFENC",272,0)
 ;
"RTN","SYNFENC",273,0)
IMPORT(rtn,ien) ; encounters, immunizations, problems for patient ien
"RTN","SYNFENC",274,0)
 n filter
"RTN","SYNFENC",275,0)
 k rtn
"RTN","SYNFENC",276,0)
 s filter("load")=1
"RTN","SYNFENC",277,0)
 s filter("debug")=1
"RTN","SYNFENC",278,0)
 d importEncounters^SYNFENC(.rtn,ien,.filter)
"RTN","SYNFENC",279,0)
 d importImmu^SYNFIMM(.rtn,ien,.filter)
"RTN","SYNFENC",280,0)
 d importConditions^SYNFPR2(.rtn,ien,.filter)
"RTN","SYNFENC",281,0)
 q
"RTN","SYNFENC",282,0)
 ;
"RTN","SYNFENC",283,0)
 ;
"RTN","SYNFENC",284,0)
LOADALL(count) ; count is how many to do. default is 1000
"RTN","SYNFENC",285,0)
 D INITMAPS^SYNQLDM ; make sure map table is loaded
"RTN","SYNFENC",286,0)
 i '$d(count) s count=1000
"RTN","SYNFENC",287,0)
 n root s groot=$$setroot^%wd("fhir-intake")
"RTN","SYNFENC",288,0)
 n cnt s cnt=0
"RTN","SYNFENC",289,0)
 n %1 s %1=0
"RTN","SYNFENC",290,0)
 f  s %1=$o(@groot@(%1)) q:+%1=0  q:cnt=count  d  ;
"RTN","SYNFENC",291,0)
 . n eroot s eroot=$na(@groot@(%1,"load","encounters"))
"RTN","SYNFENC",292,0)
 . q:$d(@eroot)
"RTN","SYNFENC",293,0)
 . q:%1=33
"RTN","SYNFENC",294,0)
 . q:%1=82
"RTN","SYNFENC",295,0)
 . q:$g(@eroot@("loadstatus"))="started"
"RTN","SYNFENC",296,0)
 . s cnt=cnt+1
"RTN","SYNFENC",297,0)
 . s @eroot@("loadstatus")="started"
"RTN","SYNFENC",298,0)
 . n filter
"RTN","SYNFENC",299,0)
 . s filter("load")=1
"RTN","SYNFENC",300,0)
 . n g s $p(g,"+",80)="" w !,g
"RTN","SYNFENC",301,0)
 . w !,"loading "_%1_" "_$$FMTE^XLFDT($$NOW^XLFDT)
"RTN","SYNFENC",302,0)
 . w !,g
"RTN","SYNFENC",303,0)
 . n rtn
"RTN","SYNFENC",304,0)
 . ;d taskLabs^SYNFHIR(.rtn,%1,.filter)
"RTN","SYNFENC",305,0)
 . d importEncounters^SYNFENC(.rtn,%1,.filter)
"RTN","SYNFENC",306,0)
 . d importImmu^SYNFIMM(.rtn,%1,.filter)
"RTN","SYNFENC",307,0)
 . d importConditions^SYNFPRB(.rtn,%1,.filter)
"RTN","SYNFENC",308,0)
 . do importAppointment^SYNFAPT(.return,%1,.filter)
"RTN","SYNFENC",309,0)
 . ;do importMeds^SYNFMED2(.return,%1,.filter)
"RTN","SYNFENC",310,0)
 . do importProcedures^SYNFPROC(.return,%1,.filter)
"RTN","SYNFENC",311,0)
 q
"RTN","SYNFENC",312,0)
 ;
"RTN","SYNFENC",313,0)
NEXT(start) ; extrinsic which returns the next patient for encounter loading    
"RTN","SYNFENC",314,0)
 ; start is the dfn to start looking, default is zerro
"RTN","SYNFENC",315,0)
 i '$d(start) s start=0
"RTN","SYNFENC",316,0)
 n root s groot=$$setroot^%wd("fhir-intake")
"RTN","SYNFENC",317,0)
 n %1 s %1=start
"RTN","SYNFENC",318,0)
 n returnien s returnien=0
"RTN","SYNFENC",319,0)
 f  s %1=$o(@groot@(%1)) q:+%1=0  q:+returnien>0  d  ;
"RTN","SYNFENC",320,0)
 . n eroot s eroot=$na(@groot@(%1,"load","encounters"))
"RTN","SYNFENC",321,0)
 . q:$d(@eroot)
"RTN","SYNFENC",322,0)
 . q:%1=33
"RTN","SYNFENC",323,0)
 . q:%1=82
"RTN","SYNFENC",324,0)
 . q:$g(@eroot@("loadstatus"))="started"
"RTN","SYNFENC",325,0)
 . s returnien=%1
"RTN","SYNFENC",326,0)
 q returnien
"RTN","SYNFENC",327,0)
 ;
"RTN","SYNFGR")
0^28^B5992182
"RTN","SYNFGR",1,0)
SYNFGR  ;ven/gpl - fhir loader utilities ;2018-08-17  3:27 PM
"RTN","SYNFGR",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNFGR",3,0)
 ;
"RTN","SYNFGR",4,0)
 ; Authored by George P. Lilly 2017-2018
"RTN","SYNFGR",5,0)
 ;
"RTN","SYNFGR",6,0)
 q
"RTN","SYNFGR",7,0)
 ;
"RTN","SYNFGR",8,0)
resources(ary,lvl)      ; finds all the fhir resources and counts them up
"RTN","SYNFGR",9,0)
 ; returns ary, passed by name
"RTN","SYNFGR",10,0)
 ;
"RTN","SYNFGR",11,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFGR",12,0)
 n ien,rien
"RTN","SYNFGR",13,0)
 s (ien,rien)=0
"RTN","SYNFGR",14,0)
 f  s ien=$o(@root@(ien)) q:+ien=0  d  ;
"RTN","SYNFGR",15,0)
 . s rien=0
"RTN","SYNFGR",16,0)
 . f  s rien=$o(@root@(ien,"json","entry",rien)) q:+rien=0  d  ;
"RTN","SYNFGR",17,0)
 . . n rtype,rtext,rcode
"RTN","SYNFGR",18,0)
 . . s rtype=$g(@root@(ien,"json","entry",rien,"resource","resourceType"))
"RTN","SYNFGR",19,0)
 . . q:rtype=""
"RTN","SYNFGR",20,0)
 . . s @ary@(rtype)=$g(@ary@(rtype))+1
"RTN","SYNFGR",21,0)
 . . q:$g(lvl)<2
"RTN","SYNFGR",22,0)
 . . i rtype="Goal" d  ;
"RTN","SYNFGR",23,0)
 . . . s rtext=$g(@root@(ien,"json","entry",rien,"resource","description","text"))
"RTN","SYNFGR",24,0)
 . . . q:rtext=""
"RTN","SYNFGR",25,0)
 . . . s @ary@(rtype,rtext)=$g(@ary@(rtype,rtext))+1
"RTN","SYNFGR",26,0)
 . . i rtype="Observation" d  ;
"RTN","SYNFGR",27,0)
 . . . s rtext=$g(@root@(ien,"json","entry",rien,"resource","category",1,"coding",1,"code"))
"RTN","SYNFGR",28,0)
 . . . q:rtext=""
"RTN","SYNFGR",29,0)
 . . . ;i rtext="procedure" b
"RTN","SYNFGR",30,0)
 . . . s @ary@(rtype,rtext)=$g(@ary@(rtype,rtext))+1
"RTN","SYNFGR",31,0)
 . . i rtype="Procedure" d  ;
"RTN","SYNFGR",32,0)
 . . . s rtext=$g(@root@(ien,"json","entry",rien,"resource","code","text"))
"RTN","SYNFGR",33,0)
 . . . q:rtext=""
"RTN","SYNFGR",34,0)
 . . . s rcode=$g(@root@(ien,"json","entry",rien,"resource","code","coding",1,"code"))
"RTN","SYNFGR",35,0)
 . . . q:rcode=""
"RTN","SYNFGR",36,0)
 . . . s @ary@(rtype,rtext,rcode)=$g(@ary@(rtype,rtext,rcode))+1
"RTN","SYNFGR",37,0)
 . . i rtype="DiagnosticReport" d  ;
"RTN","SYNFGR",38,0)
 . . . s rtext=$g(@root@(ien,"json","entry",rien,"resource","code","coding",1,"display"))
"RTN","SYNFGR",39,0)
 . . . q:rtext=""
"RTN","SYNFGR",40,0)
 . . . s @ary@(rtype,rtext)=$g(@ary@(rtype,rtext))+1
"RTN","SYNFGR",41,0)
 q
"RTN","SYNFGR",42,0)
 ;
"RTN","SYNFHF")
0^79^B18591820
"RTN","SYNFHF",1,0)
SYNFHF  ;ven/gpl - fhir loader utilities ;2018-08-17  3:27 PM
"RTN","SYNFHF",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNFHF",3,0)
 ;
"RTN","SYNFHF",4,0)
 ; Authored by George P. Lilly 2017-2018
"RTN","SYNFHF",5,0)
 ;
"RTN","SYNFHF",6,0)
 ; Health Factors
"RTN","SYNFHF",7,0)
 q
"RTN","SYNFHF",8,0)
 ;
"RTN","SYNFHF",9,0)
HFCPCAT(CODE,TEXT) ; returns ien^name for the Health Factor Category
"RTN","SYNFHF",10,0)
 ; for the Care Plan category. This ien will be needed for all 
"RTN","SYNFHF",11,0)
 ; calls to get Care Plan, Activity, and Goal Health Factors
"RTN","SYNFHF",12,0)
 ;
"RTN","SYNFHF",13,0)
 n COMMENT
"RTN","SYNFHF",14,0)
 s COMMENT="SYN Care Plan Health Factor Category for: "_CODE_" "_TEXT
"RTN","SYNFHF",15,0)
 q $$GETHF("CPCAT","",CODE,TEXT,1,COMMENT,1)
"RTN","SYNFHF",16,0)
 ;
"RTN","SYNFHF",17,0)
HFCP(CODE,TEXT,CAT) ; returns ien^name for the Care Plan Health Factor
"RTN","SYNFHF",18,0)
 ; CAT is the ien^name (name optional) of the Health Factor Category
"RTN","SYNFHF",19,0)
 ; for this Care Plan Health Factor
"RTN","SYNFHF",20,0)
 ; CODE is the Snomed code for the Care Plan Category
"RTN","SYNFHF",21,0)
 ; TEXT is the Snomed text for the Care Plan Category
"RTN","SYNFHF",22,0)
 ; 
"RTN","SYNFHF",23,0)
 n COMMENT
"RTN","SYNFHF",24,0)
 s COMMENT="SYN Care Plan Health Factor for: "_CODE_" "_TEXT
"RTN","SYNFHF",25,0)
 q $$GETHF("CP",CAT,CODE,TEXT,0,COMMENT,1)
"RTN","SYNFHF",26,0)
 ;
"RTN","SYNFHF",27,0)
HFACT(CODE,TEXT,CAT) ; returns ien^name for a Care Plan Activity
"RTN","SYNFHF",28,0)
 ; in the Care Plan Category CAT (ien)
"RTN","SYNFHF",29,0)
 ;
"RTN","SYNFHF",30,0)
 n COMMENT
"RTN","SYNFHF",31,0)
 s COMMENT="SYN Care Plan Activity Health Factor for: "_CODE_" "_TEXT
"RTN","SYNFHF",32,0)
 q $$GETHF("ACT",CAT,CODE,TEXT,0,COMMENT,1)
"RTN","SYNFHF",33,0)
 ;
"RTN","SYNFHF",34,0)
HFADDR(CODE,TEXT,CAT) ; returns ien^name for a Care Plan Address HF
"RTN","SYNFHF",35,0)
 ; in the Care Plan Category CAT (ien)
"RTN","SYNFHF",36,0)
 ;
"RTN","SYNFHF",37,0)
 n COMMENT
"RTN","SYNFHF",38,0)
 s COMMENT="SYN Care Plan Adresses Health Factor for: "_CODE_" "_TEXT
"RTN","SYNFHF",39,0)
 q $$GETHF("ADDR",CAT,CODE,TEXT,0,COMMENT,1)
"RTN","SYNFHF",40,0)
 ;
"RTN","SYNFHF",41,0)
HFGOAL(CODE,CAT,TEXT,DIAG) ; returns ien^name for a Care Plan Goal
"RTN","SYNFHF",42,0)
 ; in the Care Plan Category CAT (ien) 
"RTN","SYNFHF",43,0)
 ; DIAG is the diagnosis code^text for the problem the goal addresses (opt)
"RTN","SYNFHF",44,0)
 ;
"RTN","SYNFHF",45,0)
 n COMMENT
"RTN","SYNFHF",46,0)
 s COMMENT=TEXT_" which addresses: "_$g(DIAG)
"RTN","SYNFHF",47,0)
 q $$GETHF("GOAL",$g(CAT),CODE,TEXT,0,COMMENT,1)
"RTN","SYNFHF",48,0)
 ;
"RTN","SYNFHF",49,0)
 ;
"RTN","SYNFHF",50,0)
HFPOV(CODE,TEXT) ; returns ien^name for the Purpose of Visit Health Factor
"RTN","SYNFHF",51,0)
 ; in the SYN POV  health factor category
"RTN","SYNFHF",52,0)
 ;
"RTN","SYNFHF",53,0)
 ;
"RTN","SYNFHF",54,0)
 N CMT0
"RTN","SYNFHF",55,0)
 s CMT0="SYN Purpose of Visit SNOMED Codes"
"RTN","SYNFHF",56,0)
 n ien
"RTN","SYNFHF",57,0)
 s ien=$$GETHF("POV",,"","Purpose of visit codes",1,CMT0,0)
"RTN","SYNFHF",58,0)
 n COMMENT
"RTN","SYNFHF",59,0)
 s COMMENT="SYN Purpose of Visit Health Factor for: "_CODE_" "_TEXT
"RTN","SYNFHF",60,0)
 q $$GETHF("POV",ien,CODE,TEXT,0,COMMENT,1)
"RTN","SYNFHF",61,0)
 ;
"RTN","SYNFHF",62,0)
HFPROC(CODE,TEXT) ; returns the ien^name of the Procedures Health Factor
"RTN","SYNFHF",63,0)
 ; in category SYN SNOMED PROCEDURES
"RTN","SYNFHF",64,0)
 ;
"RTN","SYNFHF",65,0)
 N CMT0
"RTN","SYNFHF",66,0)
 s CMT0="SYN Procedure Health Codes"
"RTN","SYNFHF",67,0)
 n ien
"RTN","SYNFHF",68,0)
 s ien=$$GETHF("POV",,"","Procedure codes",1,CMT0,0)
"RTN","SYNFHF",69,0)
 n COMMENT
"RTN","SYNFHF",70,0)
 s COMMENT="SYN Procedure Health Factor for: "_CODE_" "_TEXT
"RTN","SYNFHF",71,0)
 q $$GETHF("PROC",,CODE,TEXT,0,COMMENT,1)
"RTN","SYNFHF",72,0)
 ;
"RTN","SYNFHF",73,0)
 ; the following are private routines used by the above public APIs
"RTN","SYNFHF",74,0)
 ;
"RTN","SYNFHF",75,0)
GETHF(SYNCAT,HFCAT,CODE,TEXT,ISHFCAT,CMT,LAYGO) ;
"RTN","SYNFHF",76,0)
 ; returns ien^name of the health factor
"RTN","SYNFHF",77,0)
 ; SYNCAT is the text abbrieviation of the kind of health factor one of:
"RTN","SYNFHF",78,0)
 ;   CPCAT = care plan category
"RTN","SYNFHF",79,0)
 ;   CP = care plan
"RTN","SYNFHF",80,0)
 ;   ACT = care plan activity
"RTN","SYNFHF",81,0)
 ;   GOAL = care plan goal
"RTN","SYNFHF",82,0)
 ;   POV = purpose of visit
"RTN","SYNFHF",83,0)
 ;   PROC = SNOMED procedure
"RTN","SYNFHF",84,0)
 ; if ISHFCAT=1 the HEALTH FACTOR is a HEALTH FACTOR category
"RTN","SYNFHF",85,0)
 ; if LAYGO=1 the HEALTH FACTOR will be created if it does not exist
"RTN","SYNFHF",86,0)
 ;
"RTN","SYNFHF",87,0)
 n name,ien,cpart,nlen,cde,cdesys
"RTN","SYNFHF",88,0)
 s (cpart,cde,cdesys)=""
"RTN","SYNFHF",89,0)
 i CODE[":" d  ;
"RTN","SYNFHF",90,0)
 . s cpart=" ("_CODE_")"
"RTN","SYNFHF",91,0)
 . s cde=$p(CODE,":",2)
"RTN","SYNFHF",92,0)
 . s cdesys=$p(CODE,":",1)
"RTN","SYNFHF",93,0)
 e  d  ;
"RTN","SYNFHF",94,0)
 . q:$G(CODE)=""
"RTN","SYNFHF",95,0)
 . s cpart=" (SCT:"_CODE_")"
"RTN","SYNFHF",96,0)
 . s cde=CODE
"RTN","SYNFHF",97,0)
 . s cdesys="SCT"
"RTN","SYNFHF",98,0)
 s nlen=64-$l(cpart)
"RTN","SYNFHF",99,0)
 s name="SYN "_SYNCAT_" "_TEXT
"RTN","SYNFHF",100,0)
 i $l(name)>nlen s name=$e(name,1,nlen)
"RTN","SYNFHF",101,0)
 s name=name_cpart
"RTN","SYNFHF",102,0)
 s pname=TEXT ; print name
"RTN","SYNFHF",103,0)
 s name=$$UP^XLFSTR(name) ; hf name
"RTN","SYNFHF",104,0)
 i ISHFCAT=1 d  ; name for a health factor category
"RTN","SYNFHF",105,0)
 . i $l(name)>60 s name=$e(name,1,60) ; leave room for [C]
"RTN","SYNFHF",106,0)
 . s name=name_" [C]"
"RTN","SYNFHF",107,0)
 s ien=$o(^AUTTHF("B",name,""))
"RTN","SYNFHF",108,0)
 i ien'=""  q ien_"^"_name
"RTN","SYNFHF",109,0)
 ; hf not found
"RTN","SYNFHF",110,0)
 i $g(LAYGO)'=1 Q "-1^Health Factor not found: "_name
"RTN","SYNFHF",111,0)
 n FDA,fn,fncode
"RTN","SYNFHF",112,0)
 s fn=9999999.64
"RTN","SYNFHF",113,0)
 s fncode=9999999.66
"RTN","SYNFHF",114,0)
 s FDA(fn,"?+1,",.01)=name
"RTN","SYNFHF",115,0)
 s FDA(fn,"?+1,",.03)=+HFCAT
"RTN","SYNFHF",116,0)
 s FDA(fn,"?+1,",.08)="Y"
"RTN","SYNFHF",117,0)
 s FDA(fn,"?+1,",.1)=$s($G(ISHFCAT)=1:"C",1:"F")
"RTN","SYNFHF",118,0)
 s FDA(fn,"?+1,",100)="L"
"RTN","SYNFHF",119,0)
 s FDA(fn,"?+1,",200)=$G(CMT)
"RTN","SYNFHF",120,0)
 ;s FDA(fn,"?+1,",201)=$G(CMT) ; WORD PROCESSING FIELD
"RTN","SYNFHF",121,0)
 I $D(^DD(9999999.64,200)) D  ; this system has the codes subfile
"RTN","SYNFHF",122,0)
 . q:cdesys=""
"RTN","SYNFHF",123,0)
 . s FDA(fncode,"?+2,?+1,",.01)=cdesys ; always code system
"RTN","SYNFHF",124,0)
 . s FDA(fncode,"?+2,?+1,",1)=cde ; 
"RTN","SYNFHF",125,0)
 . s FDA(fncode,"?+2,?+1,",2)=$p($$NOW^XLFDT,".",1) ;
"RTN","SYNFHF",126,0)
 n err
"RTN","SYNFHF",127,0)
 D UPDIE(.FDA,.ien)
"RTN","SYNFHF",128,0)
 i ien="" s ien=$o(^AUTTHF("B",name,""))
"RTN","SYNFHF",129,0)
 q ien_"^"_name
"RTN","SYNFHF",130,0)
 ;
"RTN","SYNFHF",131,0)
UPDIE(ZFDA,ZIEN) ; INTERNAL ROUTINE TO CALL UPDATE^DIE AND CHECK FOR ERRORS
"RTN","SYNFHF",132,0)
 ; ZFDA IS PASSED BY REFERENCE
"RTN","SYNFHF",133,0)
 ; ZIEN IS PASSED BY REFERENCE
"RTN","SYNFHF",134,0)
 ;D:$G(DEBUG)
"RTN","SYNFHF",135,0)
 ;. ZWRITE ZFDA
"RTN","SYNFHF",136,0)
 ;. B
"RTN","SYNFHF",137,0)
 K ZERR
"RTN","SYNFHF",138,0)
 D CLEAN^DILF
"RTN","SYNFHF",139,0)
 D UPDATE^DIE("K","ZFDA","ZIEN","ZERR")
"RTN","SYNFHF",140,0)
 I $D(ZERR) ZWR ZERR
"RTN","SYNFHF",141,0)
 I '$G(TRUST) I $D(ZERR) S ZZERR=ZZERR ; ZZERR DOESN'T EXIST,
"RTN","SYNFHF",142,0)
 ; INVOKE THE ERROR TRAP IF TASKED
"RTN","SYNFHF",143,0)
 ;. W "ERROR",!
"RTN","SYNFHF",144,0)
 ;. ZWR ZERR
"RTN","SYNFHF",145,0)
 ;. B
"RTN","SYNFHF",146,0)
 K ZFDA
"RTN","SYNFHF",147,0)
 Q
"RTN","SYNFHF",148,0)
 ;
"RTN","SYNFHIR")
0^29^B132718622
"RTN","SYNFHIR",1,0)
SYNFHIR ;ven/gpl - fhir loader utilities ;2018-08-17  3:27 PM
"RTN","SYNFHIR",2,0)
 ;;0.2;VISTA SYN DATA LOADER;;Feb 07, 2019;Build 53
"RTN","SYNFHIR",3,0)
 ;
"RTN","SYNFHIR",4,0)
 ; Authored by George P. Lilly 2017-2018
"RTN","SYNFHIR",5,0)
 ;
"RTN","SYNFHIR",6,0)
 q
"RTN","SYNFHIR",7,0)
 ;
"RTN","SYNFHIR",8,0)
wsPostFHIR(ARGS,BODY,RESULT)    ; recieve from addpatient
"RTN","SYNFHIR",9,0)
 ;
"RTN","SYNFHIR",10,0)
 s U="^"
"RTN","SYNFHIR",11,0)
 ;S DUZ=1
"RTN","SYNFHIR",12,0)
 ;S DUZ("AG")="V"
"RTN","SYNFHIR",13,0)
 ;S DUZ(2)=500
"RTN","SYNFHIR",14,0)
 S USER=$$DUZ^SYNDHP69
"RTN","SYNFHIR",15,0)
 ;
"RTN","SYNFHIR",16,0)
 new json,ien,root,gr,id,return
"RTN","SYNFHIR",17,0)
 set root=$$setroot^%wd("fhir-intake")
"RTN","SYNFHIR",18,0)
 set id=$get(ARGS("id"))
"RTN","SYNFHIR",19,0)
 ;
"RTN","SYNFHIR",20,0)
 set ien=$order(@root@(" "),-1)+1
"RTN","SYNFHIR",21,0)
 set gr=$name(@root@(ien,"json"))
"RTN","SYNFHIR",22,0)
 merge json=BODY
"RTN","SYNFHIR",23,0)
 do decode^%webjson("json",gr)
"RTN","SYNFHIR",24,0)
 do indexFhir(ien)
"RTN","SYNFHIR",25,0)
 ;
"RTN","SYNFHIR",26,0)
 if id'="" do  ;
"RTN","SYNFHIR",27,0)
 . set @root@("B",id,ien)=""
"RTN","SYNFHIR",28,0)
 else  do  ;
"RTN","SYNFHIR",29,0)
 . ;
"RTN","SYNFHIR",30,0)
 ;
"RTN","SYNFHIR",31,0)
 if $get(ARGS("returngraph"))=1 do  ;
"RTN","SYNFHIR",32,0)
 . merge return("graph")=@root@(ien,"graph")
"RTN","SYNFHIR",33,0)
 set return("status")="ok"
"RTN","SYNFHIR",34,0)
 set return("id")=id
"RTN","SYNFHIR",35,0)
 set return("ien")=ien
"RTN","SYNFHIR",36,0)
 ;
"RTN","SYNFHIR",37,0)
 do importPatient^SYNFPAT(.return,ien)
"RTN","SYNFHIR",38,0)
 ;
"RTN","SYNFHIR",39,0)
 new rdfn set rdfn=$get(return("dfn"))
"RTN","SYNFHIR",40,0)
 if rdfn'="" set @root@("DFN",rdfn,ien)=""
"RTN","SYNFHIR",41,0)
 ;
"RTN","SYNFHIR",42,0)
 if rdfn'="" do  ; patient creation was successful
"RTN","SYNFHIR",43,0)
 . if $g(ARGS("load"))="" s ARGS("load")=1
"RTN","SYNFHIR",44,0)
 . ;do taskLabs(.return,ien,.ARGS)
"RTN","SYNFHIR",45,0)
 . DO importLabs^SYNFLAB(.return,ien,.ARGS)
"RTN","SYNFHIR",46,0)
 . do importVitals^SYNFVIT(.return,ien,.ARGS)
"RTN","SYNFHIR",47,0)
 . do importEncounters^SYNFENC(.return,ien,.ARGS)
"RTN","SYNFHIR",48,0)
 . do importImmu^SYNFIMM(.return,ien,.ARGS)
"RTN","SYNFHIR",49,0)
 . do importConditions^SYNFPR2(.return,ien,.ARGS)
"RTN","SYNFHIR",50,0)
 . do importAllergy^SYNFALG(.return,ien,.ARGS)
"RTN","SYNFHIR",51,0)
 . do importAppointment^SYNFAPT(.return,ien,.ARGS)
"RTN","SYNFHIR",52,0)
 . do importMeds^SYNFMED2(.return,ien,.ARGS)
"RTN","SYNFHIR",53,0)
 . do importProcedures^SYNFPROC(.return,ien,.ARGS)
"RTN","SYNFHIR",54,0)
 . do importCarePlan^SYNFCP(.return,ien,.ARGS)
"RTN","SYNFHIR",55,0)
 ;
"RTN","SYNFHIR",56,0)
 do encode^%webjson("return","RESULT")
"RTN","SYNFHIR",57,0)
 set HTTPRSP("mime")="application/json"
"RTN","SYNFHIR",58,0)
 ;
"RTN","SYNFHIR",59,0)
 quit 1
"RTN","SYNFHIR",60,0)
 ;
"RTN","SYNFHIR",61,0)
indexFhir(ien)  ; generate indexes for parsed fhir json
"RTN","SYNFHIR",62,0)
 ;
"RTN","SYNFHIR",63,0)
 new root set root=$$setroot^%wd("fhir-intake")
"RTN","SYNFHIR",64,0)
 if $get(ien)="" quit  ;
"RTN","SYNFHIR",65,0)
 ;
"RTN","SYNFHIR",66,0)
 new jroot set jroot=$name(@root@(ien,"json","entry")) ; root of the json
"RTN","SYNFHIR",67,0)
 if '$data(@jroot) quit  ; can't find the json to index
"RTN","SYNFHIR",68,0)
 ;
"RTN","SYNFHIR",69,0)
 new jindex set jindex=$name(@root@(ien)) ; root of the index
"RTN","SYNFHIR",70,0)
 d clearIndexes(jindex)
"RTN","SYNFHIR",71,0)
 ;
"RTN","SYNFHIR",72,0)
 new %wi s %wi=0
"RTN","SYNFHIR",73,0)
 for  set %wi=$order(@jroot@(%wi)) quit:+%wi=0  do  ;
"RTN","SYNFHIR",74,0)
 . new type
"RTN","SYNFHIR",75,0)
 . set type=$get(@jroot@(%wi,"resource","resourceType"))
"RTN","SYNFHIR",76,0)
 . if type="" do  quit  ;
"RTN","SYNFHIR",77,0)
 . . w !,"error resource type not found ien= ",ien," entry= ",%wi
"RTN","SYNFHIR",78,0)
 . set @jindex@("type",type,%wi)=""
"RTN","SYNFHIR",79,0)
 . d triples(jindex,$na(@jroot@(%wi)),%wi)
"RTN","SYNFHIR",80,0)
 quit
"RTN","SYNFHIR",81,0)
 ;
"RTN","SYNFHIR",82,0)
triples(index,ary,%wi)  ; index and array are passed by name
"RTN","SYNFHIR",83,0)
 ;
"RTN","SYNFHIR",84,0)
 i type="Patient" d  q  ;
"RTN","SYNFHIR",85,0)
 . n purl s purl=$g(@ary@("fullUrl"))
"RTN","SYNFHIR",86,0)
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
"RTN","SYNFHIR",87,0)
 . i $e(purl,$l(purl))="/" s purl=purl_%wi
"RTN","SYNFHIR",88,0)
 . d setIndex(index,purl,"type",type)
"RTN","SYNFHIR",89,0)
 . d setIndex(index,purl,"rien",%wi)
"RTN","SYNFHIR",90,0)
 i type="Encounter" d  q  ;
"RTN","SYNFHIR",91,0)
 . n purl s purl=$g(@ary@("fullUrl"))
"RTN","SYNFHIR",92,0)
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
"RTN","SYNFHIR",93,0)
 . i $e(purl,$l(purl))="/" s purl=purl_%wi
"RTN","SYNFHIR",94,0)
 . d setIndex(index,purl,"type",type)
"RTN","SYNFHIR",95,0)
 . d setIndex(index,purl,"rien",%wi)
"RTN","SYNFHIR",96,0)
 . n sdate s sdate=$g(@ary@("resource","period","start")) q:sdate=""
"RTN","SYNFHIR",97,0)
 . n hl7date s hl7date=$$fhirThl7^SYNFUTL(sdate)
"RTN","SYNFHIR",98,0)
 . d setIndex(index,purl,"dateTime",sdate)
"RTN","SYNFHIR",99,0)
 . d setIndex(index,purl,"hl7dateTime",hl7date)
"RTN","SYNFHIR",100,0)
 . n class s class=$g(@ary@("resource","class","code")) q:class=""
"RTN","SYNFHIR",101,0)
 . d setIndex(index,purl,"class",class)
"RTN","SYNFHIR",102,0)
 i type="Condition" d  q  ;
"RTN","SYNFHIR",103,0)
 . n purl s purl=$g(@ary@("fullUrl"))
"RTN","SYNFHIR",104,0)
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
"RTN","SYNFHIR",105,0)
 . i $e(purl,$l(purl))="/" s purl=purl_%wi
"RTN","SYNFHIR",106,0)
 . d setIndex(index,purl,"type",type)
"RTN","SYNFHIR",107,0)
 . d setIndex(index,purl,"rien",%wi)
"RTN","SYNFHIR",108,0)
 . n enc s enc=$g(@ary@("resource","context","reference")) q:enc=""
"RTN","SYNFHIR",109,0)
 . d setIndex(index,purl,"encounterReference",enc)
"RTN","SYNFHIR",110,0)
 . n pat s pat=$g(@ary@("resource","subject","reference")) q:pat=""
"RTN","SYNFHIR",111,0)
 . d setIndex(index,purl,"patientReference",pat)
"RTN","SYNFHIR",112,0)
 i type="Observation" d  q  ;
"RTN","SYNFHIR",113,0)
 . n purl s purl=$g(@ary@("fullUrl"))
"RTN","SYNFHIR",114,0)
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
"RTN","SYNFHIR",115,0)
 . i $e(purl,$l(purl))="/" s purl=purl_%wi
"RTN","SYNFHIR",116,0)
 . d setIndex(index,purl,"type",type)
"RTN","SYNFHIR",117,0)
 . d setIndex(index,purl,"rien",%wi)
"RTN","SYNFHIR",118,0)
 . n enc s enc=$g(@ary@("resource","context","reference")) q:enc=""
"RTN","SYNFHIR",119,0)
 . d setIndex(index,purl,"encounterReference",enc)
"RTN","SYNFHIR",120,0)
 . n pat s pat=$g(@ary@("resource","subject","reference")) q:pat=""
"RTN","SYNFHIR",121,0)
 . d setIndex(index,purl,"patientReference",pat)
"RTN","SYNFHIR",122,0)
 i type="Medication" d  q  ;
"RTN","SYNFHIR",123,0)
 . n purl s purl=$g(@ary@("fullUrl"))
"RTN","SYNFHIR",124,0)
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
"RTN","SYNFHIR",125,0)
 . i $e(purl,$l(purl))="/" s purl=purl_%wi
"RTN","SYNFHIR",126,0)
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
"RTN","SYNFHIR",127,0)
 . d setIndex(index,purl,"type",type)
"RTN","SYNFHIR",128,0)
 . d setIndex(index,purl,"rien",%wi)
"RTN","SYNFHIR",129,0)
 i type="medicationReference" d  q  ;
"RTN","SYNFHIR",130,0)
 . n purl s purl=$g(@ary@("fullUrl"))
"RTN","SYNFHIR",131,0)
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
"RTN","SYNFHIR",132,0)
 . i $e(purl,$l(purl))="/" s purl=purl_%wi
"RTN","SYNFHIR",133,0)
 . d setIndex(index,purl,"type",type)
"RTN","SYNFHIR",134,0)
 . d setIndex(index,purl,"rien",%wi)
"RTN","SYNFHIR",135,0)
 . n enc s enc=$g(@ary@("resource","context","reference")) q:enc=""
"RTN","SYNFHIR",136,0)
 . d setIndex(index,purl,"encounterReference",enc)
"RTN","SYNFHIR",137,0)
 . n pat s pat=$g(@ary@("resource","subject","reference")) q:pat=""
"RTN","SYNFHIR",138,0)
 . d setIndex(index,purl,"patientReference",pat)
"RTN","SYNFHIR",139,0)
 i type="Immunizationi" d  q  ;
"RTN","SYNFHIR",140,0)
 . n purl s purl=$g(@ary@("fullUrl"))
"RTN","SYNFHIR",141,0)
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
"RTN","SYNFHIR",142,0)
 . i $e(purl,$l(purl))="/" s purl=purl_%wi
"RTN","SYNFHIR",143,0)
 . d setIndex(index,purl,"type",type)
"RTN","SYNFHIR",144,0)
 . d setIndex(index,purl,"rien",%wi)
"RTN","SYNFHIR",145,0)
 . n enc s enc=$g(@ary@("resource","encounter","reference")) q:enc=""
"RTN","SYNFHIR",146,0)
 . d setIndex(index,purl,"encounterReference",enc)
"RTN","SYNFHIR",147,0)
 . n pat s pat=$g(@ary@("resource","patient","reference")) q:pat=""
"RTN","SYNFHIR",148,0)
 . d setIndex(index,purl,"patientReference",pat)
"RTN","SYNFHIR",149,0)
 n purl s purl=$g(@ary@("fullUrl"))
"RTN","SYNFHIR",150,0)
 i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
"RTN","SYNFHIR",151,0)
 i $e(purl,$l(purl))="/" s purl=purl_%wi
"RTN","SYNFHIR",152,0)
 d setIndex(index,purl,"type",type)
"RTN","SYNFHIR",153,0)
 d setIndex(index,purl,"rien",%wi)
"RTN","SYNFHIR",154,0)
 n enc s enc=$g(@ary@("resource","context","reference")) q:enc=""
"RTN","SYNFHIR",155,0)
 d setIndex(index,purl,"encounterReference",enc)
"RTN","SYNFHIR",156,0)
 n pat s pat=$g(@ary@("resource","subject","reference")) q:pat=""
"RTN","SYNFHIR",157,0)
 d setIndex(index,purl,"patientReference",pat)
"RTN","SYNFHIR",158,0)
 q
"RTN","SYNFHIR",159,0)
 ;
"RTN","SYNFHIR",160,0)
setIndex(gn,sub,pred,obj)       ; set the graph indexices
"RTN","SYNFHIR",161,0)
 ;n gn s gn=$$setroot^%wd("fhir-intake")
"RTN","SYNFHIR",162,0)
 q:sub=""
"RTN","SYNFHIR",163,0)
 q:pred=""
"RTN","SYNFHIR",164,0)
 q:obj=""
"RTN","SYNFHIR",165,0)
 s @gn@("SPO",sub,pred,obj)=""
"RTN","SYNFHIR",166,0)
 s @gn@("POS",pred,obj,sub)=""
"RTN","SYNFHIR",167,0)
 s @gn@("PSO",pred,sub,obj)=""
"RTN","SYNFHIR",168,0)
 s @gn@("OPS",obj,pred,sub)=""
"RTN","SYNFHIR",169,0)
 q
"RTN","SYNFHIR",170,0)
 ;
"RTN","SYNFHIR",171,0)
clearIndexes(gn)        ; kill the indexes
"RTN","SYNFHIR",172,0)
 k @gn@("SPO")
"RTN","SYNFHIR",173,0)
 k @gn@("POS")
"RTN","SYNFHIR",174,0)
 k @gn@("PSO")
"RTN","SYNFHIR",175,0)
 k @gn@("OPS")
"RTN","SYNFHIR",176,0)
 q
"RTN","SYNFHIR",177,0)
 ;
"RTN","SYNFHIR",178,0)
wsShow(rtn,filter)      ; web service to show the fhir
"RTN","SYNFHIR",179,0)
 new type set type=$get(filter("type"))
"RTN","SYNFHIR",180,0)
 new root set root=$$setroot^%wd("fhir-intake")
"RTN","SYNFHIR",181,0)
 ;
"RTN","SYNFHIR",182,0)
 new ien set ien=$g(filter("ien"))
"RTN","SYNFHIR",183,0)
 if ien="" d  ;
"RTN","SYNFHIR",184,0)
 . n icn
"RTN","SYNFHIR",185,0)
 . s icn=$g(filter("icn"))
"RTN","SYNFHIR",186,0)
 . q:icn=""
"RTN","SYNFHIR",187,0)
 . s ien=$o(@root@("ICN",icn,""))
"RTN","SYNFHIR",188,0)
 if ien="" d  ;
"RTN","SYNFHIR",189,0)
 . n dfn
"RTN","SYNFHIR",190,0)
 . s dfn=$g(filter("dfn"))
"RTN","SYNFHIR",191,0)
 . q:dfn=""
"RTN","SYNFHIR",192,0)
 . s ien=$o(@root@("DFN",dfn,""))
"RTN","SYNFHIR",193,0)
 if ien="" quit  ;
"RTN","SYNFHIR",194,0)
 ;
"RTN","SYNFHIR",195,0)
 new jroot set jroot=$name(@root@(ien,"json"))
"RTN","SYNFHIR",196,0)
 ;
"RTN","SYNFHIR",197,0)
 new jtmp,juse
"RTN","SYNFHIR",198,0)
 set juse=jroot
"RTN","SYNFHIR",199,0)
 if type'="" do  ;
"RTN","SYNFHIR",200,0)
 . do getIntakeFhir("jtmp",$g(filter("bundle")),type,ien,1)
"RTN","SYNFHIR",201,0)
 . ;do getIntakeFhir("jtmp",,type,ien,1)
"RTN","SYNFHIR",202,0)
 . set juse="jtmp"
"RTN","SYNFHIR",203,0)
 do encode^%webjson(juse,"rtn")
"RTN","SYNFHIR",204,0)
 s HTTPRSP("mime")="application/json"
"RTN","SYNFHIR",205,0)
 quit
"RTN","SYNFHIR",206,0)
 ;
"RTN","SYNFHIR",207,0)
getIntakeFhir(rtn,id,type,ien,plain)    ; returns fhir vars for patient bundle=id resourceType type
"RTN","SYNFHIR",208,0)
 ; id is the bundle date range to be returned, optional
"RTN","SYNFHIR",209,0)
 ; if id is not passed, all resources of the type are returned
"RTN","SYNFHIR",210,0)
 ; ien is required and is the graph ien of the patient
"RTN","SYNFHIR",211,0)
 ; rtn passed by name. it will overlay results in @rtn, so is additive
"RTN","SYNFHIR",212,0)
 ; if plain is 1 then the array is returned without the type as the first
"RTN","SYNFHIR",213,0)
 ;    element of each node
"RTN","SYNFHIR",214,0)
 ;
"RTN","SYNFHIR",215,0)
 new root set root=$$setroot^%wd("fhir-intake")
"RTN","SYNFHIR",216,0)
 if $g(ien)="" set ien=$order(@root@("B",id,""))
"RTN","SYNFHIR",217,0)
 if ien="" quit  ;
"RTN","SYNFHIR",218,0)
 ;
"RTN","SYNFHIR",219,0)
 if $get(type)="" set type="all"
"RTN","SYNFHIR",220,0)
 kill @rtn
"RTN","SYNFHIR",221,0)
 ;
"RTN","SYNFHIR",222,0)
 i $g(id)="" s id=""
"RTN","SYNFHIR",223,0)
 i $g(SYNBUNDLE)'="" S id=SYNBUNDLE
"RTN","SYNFHIR",224,0)
 ;
"RTN","SYNFHIR",225,0)
 if type'="all" do  quit  ;
"RTN","SYNFHIR",226,0)
 . do get1FhirType(rtn,root,ien,type,$get(plain),id)
"RTN","SYNFHIR",227,0)
 ;
"RTN","SYNFHIR",228,0)
 new jindex set jindex=$name(@root@(ien))
"RTN","SYNFHIR",229,0)
 new %wj set %wj=""
"RTN","SYNFHIR",230,0)
 for  set %wj=$order(@jindex@("type",%wj)) quit:%wj=""  do  ;
"RTN","SYNFHIR",231,0)
 . ;w !,"type ",%wj
"RTN","SYNFHIR",232,0)
 . do get1FhirType(rtn,root,ien,%wj,$get(plain),id)
"RTN","SYNFHIR",233,0)
 ;
"RTN","SYNFHIR",234,0)
 quit
"RTN","SYNFHIR",235,0)
 ;
"RTN","SYNFHIR",236,0)
get1FhirType(rtn,root,ien,type,plain,bundle)   ; get one resourceType from the json
"RTN","SYNFHIR",237,0)
 new %wi set %wi=0
"RTN","SYNFHIR",238,0)
 new jindex set jindex=$name(@root@(ien))
"RTN","SYNFHIR",239,0)
 if '$data(@jindex@("type",type)) quit  ;
"RTN","SYNFHIR",240,0)
 for  s %wi=$order(@jindex@("type",type,%wi)) quit:+%wi=0  do  ;
"RTN","SYNFHIR",241,0)
 . i $g(@jindex@(%wi,"bundle"))'=bundle q  ;
"RTN","SYNFHIR",242,0)
 . if $get(plain)=1 merge @rtn@("entry",%wi)=@root@(ien,"json","entry",%wi)
"RTN","SYNFHIR",243,0)
 . else  merge @rtn@(type,"entry",%wi)=@root@(ien,"json","entry",%wi)
"RTN","SYNFHIR",244,0)
 quit
"RTN","SYNFHIR",245,0)
 ;
"RTN","SYNFHIR",246,0)
fhir2graph(in,out)      ; transforms fhir to a graph
"RTN","SYNFHIR",247,0)
 ; in and out are passed by name
"RTN","SYNFHIR",248,0)
 ; detects if json parser has been run and will run it if not
"RTN","SYNFHIR",249,0)
 ;
"RTN","SYNFHIR",250,0)
 new json
"RTN","SYNFHIR",251,0)
 if $ql($q(@in@("")))<2 do decode^%webjson(in,"json") set in="json"
"RTN","SYNFHIR",252,0)
 ;
"RTN","SYNFHIR",253,0)
 new rootj
"RTN","SYNFHIR",254,0)
 set rootj=$na(@in@("entry"))
"RTN","SYNFHIR",255,0)
 new i,cnt
"RTN","SYNFHIR",256,0)
 for i=1:1:$order(@rootj@(" "),-1) do  ;
"RTN","SYNFHIR",257,0)
 . new rname
"RTN","SYNFHIR",258,0)
 . set rname=$get(@rootj@(i,"resource","resourceType"))
"RTN","SYNFHIR",259,0)
 . if rname="" do  quit  ;
"RTN","SYNFHIR",260,0)
 . . w !,"error no resourceType in entry: ",i
"RTN","SYNFHIR",261,0)
 . . ;zwrite @rootj@(i,*)
"RTN","SYNFHIR",262,0)
 . . b
"RTN","SYNFHIR",263,0)
 . if '$data(@out@(rname)) set cnt=1
"RTN","SYNFHIR",264,0)
 . else  set cnt=$order(@out@(rname,""),-1)+1
"RTN","SYNFHIR",265,0)
 . merge @out@(rname,cnt)=@rootj@(i,"resource")
"RTN","SYNFHIR",266,0)
 quit
"RTN","SYNFHIR",267,0)
 ;
"RTN","SYNFHIR",268,0)
taskLabs(return,ien,ARGS) ;load Labs with TASKMAN
"RTN","SYNFHIR",269,0)
 ;
"RTN","SYNFHIR",270,0)
 NEW YSDUZ,ZTRTN,ZTDESC,ZTDTH,ZTSAVE,ZTIO,PATIEN  ;,JOBNBR
"RTN","SYNFHIR",271,0)
 SET YSDUZ=DUZ
"RTN","SYNFHIR",272,0)
 SET ZTRTN="runLabs^SYNFHIR"
"RTN","SYNFHIR",273,0)
 SET ZTDESC="Load Patient Labs"
"RTN","SYNFHIR",274,0)
 SET ZTDTH=$H
"RTN","SYNFHIR",275,0)
 SET ZTIO=""
"RTN","SYNFHIR",276,0)
 SET JOBNBR=$J
"RTN","SYNFHIR",277,0)
 SET PATIEN=ien
"RTN","SYNFHIR",278,0)
 SET ZTSAVE("PATIEN")=""
"RTN","SYNFHIR",279,0)
 ;Submit the job to Taskman
"RTN","SYNFHIR",280,0)
 ;ZWRITE ARGS
"RTN","SYNFHIR",281,0)
 DO ^%ZTLOAD
"RTN","SYNFHIR",282,0)
 ;
"RTN","SYNFHIR",283,0)
 QUIT
"RTN","SYNFHIR",284,0)
 ;
"RTN","SYNFHIR",285,0)
runLabs ; This is what is submitted to Taskman
"RTN","SYNFHIR",286,0)
 NEW args,ien,return
"RTN","SYNFHIR",287,0)
 ;
"RTN","SYNFHIR",288,0)
 SET ien=PATIEN
"RTN","SYNFHIR",289,0)
 SET args("load")=1
"RTN","SYNFHIR",290,0)
 DO importLabs^SYNFLAB(.return,ien,.args)
"RTN","SYNFHIR",291,0)
 ;
"RTN","SYNFHIR",292,0)
 QUIT
"RTN","SYNFHIR",293,0)
 ;
"RTN","SYNFHIR",294,0)
getEntry(ary,ien,rien) ; returns one entry in ary, passed by name
"RTN","SYNFHIR",295,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFHIR",296,0)
 i '$d(@root@(ien,"json","entry",rien)) q  ;
"RTN","SYNFHIR",297,0)
 m @ary@("entry",rien)=@root@(ien,"json","entry",rien)
"RTN","SYNFHIR",298,0)
 q
"RTN","SYNFHIR",299,0)
 ;
"RTN","SYNFHIR",300,0)
loadStatus(ary,ien,rien) ; returns the "load" section of the patient graph
"RTN","SYNFHIR",301,0)
 ; if rien is not specified, all entries are included
"RTN","SYNFHIR",302,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFHIR",303,0)
 i '$d(@root@(ien)) q
"RTN","SYNFHIR",304,0)
 i $g(rien)="" d  q  ;
"RTN","SYNFHIR",305,0)
 . k @ary
"RTN","SYNFHIR",306,0)
 . m @ary@(ien)=@root@(ien,"load")
"RTN","SYNFHIR",307,0)
 n zi s zi=""
"RTN","SYNFHIR",308,0)
 f  s zi=$o(@root@(ien,"load",zi)) q:$d(@root@(ien,"load",zi,rien))
"RTN","SYNFHIR",309,0)
 k @ary
"RTN","SYNFHIR",310,0)
 m @ary@(ien,rien)=@root@(ien,"load",zi,rien)
"RTN","SYNFHIR",311,0)
 q
"RTN","SYNFHIR",312,0)
 ;
"RTN","SYNFHIR",313,0)
wsLoadStatus(rtn,filter) ; displays the load status
"RTN","SYNFHIR",314,0)
 ; filter must have ien or dfn to specify the patient
"RTN","SYNFHIR",315,0)
 ; optionally, entry number (rien) for a single entry
"RTN","SYNFHIR",316,0)
 ; if ien and dfn are both specified, dfn is used
"RTN","SYNFHIR",317,0)
 ; now supports latest=1 to show the load status of the lastest added patient
"RTN","SYNFHIR",318,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFHIR",319,0)
 n ien s ien=$g(filter("ien"))
"RTN","SYNFHIR",320,0)
 i $g(filter("latest"))=1 d  ;
"RTN","SYNFHIR",321,0)
 . set ien=$o(@root@(" "),-1)
"RTN","SYNFHIR",322,0)
 n dfn s dfn=$g(filter("dfn"))
"RTN","SYNFHIR",323,0)
 i dfn'="" s ien=$$dfn2ien^SYNFUTL(dfn)
"RTN","SYNFHIR",324,0)
 n rien s rien=$g(filter("rien"))
"RTN","SYNFHIR",325,0)
 q:ien=""
"RTN","SYNFHIR",326,0)
 n load
"RTN","SYNFHIR",327,0)
 d loadStatus("load",ien,rien)
"RTN","SYNFHIR",328,0)
 s filter("root")="load"
"RTN","SYNFHIR",329,0)
 s filter("local")=1
"RTN","SYNFHIR",330,0)
 d wsGLOBAL^SYNVPR(.rtn,.filter)
"RTN","SYNFHIR",331,0)
 q
"RTN","SYNFHIR",332,0)
 ;
"RTN","SYNFHIRU")
0^83^B98115799
"RTN","SYNFHIRU",1,0)
SYNFHIRU ;ven/gpl - fhir loader utilities ;2018-08-17  3:27 PM
"RTN","SYNFHIRU",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNFHIRU",3,0)
 ;
"RTN","SYNFHIRU",4,0)
 ; Authored by George P. Lilly 2017-2018
"RTN","SYNFHIRU",5,0)
 ;
"RTN","SYNFHIRU",6,0)
 q
"RTN","SYNFHIRU",7,0)
 ;
"RTN","SYNFHIRU",8,0)
wsUpdatePatient(ARGS,BODY,RESULT)    ; recieve from updatepatient
"RTN","SYNFHIRU",9,0)
 ;
"RTN","SYNFHIRU",10,0)
 s U="^"
"RTN","SYNFHIRU",11,0)
 ;S DUZ=1
"RTN","SYNFHIRU",12,0)
 ;S DUZ("AG")="V"
"RTN","SYNFHIRU",13,0)
 ;S DUZ(2)=500
"RTN","SYNFHIRU",14,0)
 S USER=$$DUZ^SYNDHP69
"RTN","SYNFHIRU",15,0)
 ;
"RTN","SYNFHIRU",16,0)
 new json,ien,root,gr,id,return
"RTN","SYNFHIRU",17,0)
 set root=$$setroot^%wd("fhir-intake")
"RTN","SYNFHIRU",18,0)
 set id=$get(ARGS("id"))
"RTN","SYNFHIRU",19,0)
 ;
"RTN","SYNFHIRU",20,0)
 ; first locate the patient to be updated
"RTN","SYNFHIRU",21,0)
 ;
"RTN","SYNFHIRU",22,0)
 n icn s icn=$g(ARGS("icn"))
"RTN","SYNFHIRU",23,0)
 i (icn="")&(id="") d  q 0 ; set http error to bad request
"RTN","SYNFHIRU",24,0)
 . s HTTPERR=400 ; bad request
"RTN","SYNFHIRU",25,0)
 s ien=$o(@root@("POS","ICN",icn,""))
"RTN","SYNFHIRU",26,0)
 i ien="" d  ; try id
"RTN","SYNFHIRU",27,0)
 . s ien=$o(@root@("POS","ICN",id,"")) ; ok to use id instead of icn
"RTN","SYNFHIRU",28,0)
 . i ien'="" s icn=id
"RTN","SYNFHIRU",29,0)
 i ien="" d  q 0 ; icn not found
"RTN","SYNFHIRU",30,0)
 . s HTTPERR=404
"RTN","SYNFHIRU",31,0)
 ;
"RTN","SYNFHIRU",32,0)
 merge json=BODY
"RTN","SYNFHIRU",33,0)
 i '$d(json) d  q 0 ;
"RTN","SYNFHIRU",34,0)
 . s HTTPERR=400
"RTN","SYNFHIRU",35,0)
 ;
"RTN","SYNFHIRU",36,0)
 n gr1,zi,cnt,rien ; initial entries
"RTN","SYNFHIRU",37,0)
 do DECODE^VPRJSON("json","gr1")
"RTN","SYNFHIRU",38,0)
 ;
"RTN","SYNFHIRU",39,0)
 ; shift resource numbers to fit in graph
"RTN","SYNFHIRU",40,0)
 ;
"RTN","SYNFHIRU",41,0)
 n lastrien s lastrien=$o(@root@(ien,"json","entry"," "),-1)
"RTN","SYNFHIRU",42,0)
 s zi=0 s cnt=0
"RTN","SYNFHIRU",43,0)
 f  s zi=$o(gr1("entry",zi)) q:+zi=0  d  ;
"RTN","SYNFHIRU",44,0)
 . s cnt=cnt+1
"RTN","SYNFHIRU",45,0)
 . s rien=lastrien+cnt
"RTN","SYNFHIRU",46,0)
 . m gr(ien,"json","entry",rien)=gr1("entry",zi)
"RTN","SYNFHIRU",47,0)
 ;
"RTN","SYNFHIRU",48,0)
 ;
"RTN","SYNFHIRU",49,0)
 do indexFhir(ien,"gr")
"RTN","SYNFHIRU",50,0)
 ;k ^gpl("gr")
"RTN","SYNFHIRU",51,0)
 ;m ^gpl("gr")=gr ; for debugging
"RTN","SYNFHIRU",52,0)
 ;
"RTN","SYNFHIRU",53,0)
 ;
"RTN","SYNFHIRU",54,0)
 if $get(ARGS("returngraph"))=1 do  ;
"RTN","SYNFHIRU",55,0)
 . merge return("graph")=gr
"RTN","SYNFHIRU",56,0)
 set return("status")="ok"
"RTN","SYNFHIRU",57,0)
 set return("icn")=icn
"RTN","SYNFHIRU",58,0)
 set return("ien")=ien
"RTN","SYNFHIRU",59,0)
 n bundle s bundle=$$bundleId($na(gr(ien)))
"RTN","SYNFHIRU",60,0)
 set return("bundle")=bundle
"RTN","SYNFHIRU",61,0)
 set ARGS("bundle")=bundle ; ingest only resources in this bundle
"RTN","SYNFHIRU",62,0)
 s SYNBUNDLE=bundle
"RTN","SYNFHIRU",63,0)
 ;
"RTN","SYNFHIRU",64,0)
 ; commit the bundle to the graph
"RTN","SYNFHIRU",65,0)
 m @root=gr
"RTN","SYNFHIRU",66,0)
 ;
"RTN","SYNFHIRU",67,0)
 new rdfn set rdfn=$o(@root@("SPO",ien,"DFN",""))
"RTN","SYNFHIRU",68,0)
 if rdfn'="" set @root@("DFN",rdfn,ien)=""
"RTN","SYNFHIRU",69,0)
 ;
"RTN","SYNFHIRU",70,0)
 if rdfn'="" do  ; patient creation was successful
"RTN","SYNFHIRU",71,0)
 . if $g(ARGS("load"))="" s ARGS("load")=1
"RTN","SYNFHIRU",72,0)
 . ;do taskLabs(.return,ien,.ARGS)
"RTN","SYNFHIRU",73,0)
 . DO importLabs^SYNFLAB(.return,ien,.ARGS)
"RTN","SYNFHIRU",74,0)
 . do importVitals^SYNFVIT(.return,ien,.ARGS)
"RTN","SYNFHIRU",75,0)
 . do importEncounters^SYNFENC(.return,ien,.ARGS)
"RTN","SYNFHIRU",76,0)
 . do importImmu^SYNFIMM(.return,ien,.ARGS)
"RTN","SYNFHIRU",77,0)
 . do importConditions^SYNFPR2(.return,ien,.ARGS)
"RTN","SYNFHIRU",78,0)
 . do importAllergy^SYNFALG(.return,ien,.ARGS)
"RTN","SYNFHIRU",79,0)
 . do importAppointment^SYNFAPT(.return,ien,.ARGS)
"RTN","SYNFHIRU",80,0)
 . do importMeds^SYNFMED2(.return,ien,.ARGS)
"RTN","SYNFHIRU",81,0)
 . do importProcedures^SYNFPROC(.return,ien,.ARGS)
"RTN","SYNFHIRU",82,0)
 . do importCarePlan^SYNFCP(.return,ien,.ARGS)
"RTN","SYNFHIRU",83,0)
 ;
"RTN","SYNFHIRU",84,0)
 k SYNBUNDLE
"RTN","SYNFHIRU",85,0)
 do ENCODE^VPRJSON("return","RESULT")
"RTN","SYNFHIRU",86,0)
 set HTTPRSP("mime")="application/json"
"RTN","SYNFHIRU",87,0)
 ;
"RTN","SYNFHIRU",88,0)
 quit 1
"RTN","SYNFHIRU",89,0)
 ;
"RTN","SYNFHIRU",90,0)
indexFhir(ien,root)  ; generate indexes for parsed fhir json
"RTN","SYNFHIRU",91,0)
 ;
"RTN","SYNFHIRU",92,0)
 i $g(root)="" set root=$$setroot^%wd("fhir-intake")
"RTN","SYNFHIRU",93,0)
 if $get(ien)="" quit  ;
"RTN","SYNFHIRU",94,0)
 ;
"RTN","SYNFHIRU",95,0)
 new jroot set jroot=$name(@root@(ien,"json","entry")) ; root of the json
"RTN","SYNFHIRU",96,0)
 if '$data(@jroot) quit  ; can't find the json to index
"RTN","SYNFHIRU",97,0)
 ;
"RTN","SYNFHIRU",98,0)
 new jindex set jindex=$name(@root@(ien)) ; root of the index
"RTN","SYNFHIRU",99,0)
 d clearIndexes(jindex)
"RTN","SYNFHIRU",100,0)
 ;
"RTN","SYNFHIRU",101,0)
 new %wi s %wi=0
"RTN","SYNFHIRU",102,0)
 for  set %wi=$order(@jroot@(%wi)) quit:+%wi=0  do  ;
"RTN","SYNFHIRU",103,0)
 . new type
"RTN","SYNFHIRU",104,0)
 . set type=$get(@jroot@(%wi,"resource","resourceType"))
"RTN","SYNFHIRU",105,0)
 . if type="" do  quit  ;
"RTN","SYNFHIRU",106,0)
 . . w !,"error resource type not found ien= ",ien," entry= ",%wi
"RTN","SYNFHIRU",107,0)
 . set @jindex@("type",type,%wi)=""
"RTN","SYNFHIRU",108,0)
 . d triples(jindex,$na(@jroot@(%wi)),%wi)
"RTN","SYNFHIRU",109,0)
 ;
"RTN","SYNFHIRU",110,0)
 n bund
"RTN","SYNFHIRU",111,0)
 s bund=$$bundleId(jindex)
"RTN","SYNFHIRU",112,0)
 s %wi=0
"RTN","SYNFHIRU",113,0)
 f  s %wi=$o(@jroot@(%wi)) q:+%wi=0  d  ;
"RTN","SYNFHIRU",114,0)
 . s @jindex@(%wi,"bundle")=bund
"RTN","SYNFHIRU",115,0)
 . d setIndex(jindex,%wi,"bundle",bund)
"RTN","SYNFHIRU",116,0)
 ;
"RTN","SYNFHIRU",117,0)
 quit
"RTN","SYNFHIRU",118,0)
 ;
"RTN","SYNFHIRU",119,0)
triples(index,ary,%wi)  ; index and array are passed by name
"RTN","SYNFHIRU",120,0)
 ;
"RTN","SYNFHIRU",121,0)
 i type="Patient" d  q  ;
"RTN","SYNFHIRU",122,0)
 . n purl s purl=$g(@ary@("fullUrl"))
"RTN","SYNFHIRU",123,0)
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
"RTN","SYNFHIRU",124,0)
 . i $e(purl,$l(purl))="/" s purl=purl_%wi
"RTN","SYNFHIRU",125,0)
 . d setIndex(index,purl,"type",type)
"RTN","SYNFHIRU",126,0)
 . d setIndex(index,purl,"rien",%wi)
"RTN","SYNFHIRU",127,0)
 i type="Encounter" d  q  ;
"RTN","SYNFHIRU",128,0)
 . n purl s purl=$g(@ary@("fullUrl"))
"RTN","SYNFHIRU",129,0)
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
"RTN","SYNFHIRU",130,0)
 . i $e(purl,$l(purl))="/" s purl=purl_%wi
"RTN","SYNFHIRU",131,0)
 . d setIndex(index,purl,"type",type)
"RTN","SYNFHIRU",132,0)
 . d setIndex(index,purl,"rien",%wi)
"RTN","SYNFHIRU",133,0)
 . n sdate s sdate=$g(@ary@("resource","period","start")) q:sdate=""
"RTN","SYNFHIRU",134,0)
 . n hl7date s hl7date=$$fhirThl7^SYNFUTL(sdate)
"RTN","SYNFHIRU",135,0)
 . d setIndex(index,purl,"dateTime",sdate)
"RTN","SYNFHIRU",136,0)
 . d setIndex(index,purl,"hl7dateTime",hl7date)
"RTN","SYNFHIRU",137,0)
 . n class s class=$g(@ary@("resource","class","code")) q:class=""
"RTN","SYNFHIRU",138,0)
 . d setIndex(index,purl,"class",class)
"RTN","SYNFHIRU",139,0)
 i type="Condition" d  q  ;
"RTN","SYNFHIRU",140,0)
 . n purl s purl=$g(@ary@("fullUrl"))
"RTN","SYNFHIRU",141,0)
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
"RTN","SYNFHIRU",142,0)
 . i $e(purl,$l(purl))="/" s purl=purl_%wi
"RTN","SYNFHIRU",143,0)
 . d setIndex(index,purl,"type",type)
"RTN","SYNFHIRU",144,0)
 . d setIndex(index,purl,"rien",%wi)
"RTN","SYNFHIRU",145,0)
 . n enc s enc=$g(@ary@("resource","context","reference")) q:enc=""
"RTN","SYNFHIRU",146,0)
 . d setIndex(index,purl,"encounterReference",enc)
"RTN","SYNFHIRU",147,0)
 . n pat s pat=$g(@ary@("resource","subject","reference")) q:pat=""
"RTN","SYNFHIRU",148,0)
 . d setIndex(index,purl,"patientReference",pat)
"RTN","SYNFHIRU",149,0)
 i type="Observation" d  q  ;
"RTN","SYNFHIRU",150,0)
 . n purl s purl=$g(@ary@("fullUrl"))
"RTN","SYNFHIRU",151,0)
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
"RTN","SYNFHIRU",152,0)
 . i $e(purl,$l(purl))="/" s purl=purl_%wi
"RTN","SYNFHIRU",153,0)
 . d setIndex(index,purl,"type",type)
"RTN","SYNFHIRU",154,0)
 . d setIndex(index,purl,"rien",%wi)
"RTN","SYNFHIRU",155,0)
 . n enc s enc=$g(@ary@("resource","context","reference")) q:enc=""
"RTN","SYNFHIRU",156,0)
 . d setIndex(index,purl,"encounterReference",enc)
"RTN","SYNFHIRU",157,0)
 . n pat s pat=$g(@ary@("resource","subject","reference")) q:pat=""
"RTN","SYNFHIRU",158,0)
 . d setIndex(index,purl,"patientReference",pat)
"RTN","SYNFHIRU",159,0)
 i type="Medication" d  q  ;
"RTN","SYNFHIRU",160,0)
 . n purl s purl=$g(@ary@("fullUrl"))
"RTN","SYNFHIRU",161,0)
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
"RTN","SYNFHIRU",162,0)
 . i $e(purl,$l(purl))="/" s purl=purl_%wi
"RTN","SYNFHIRU",163,0)
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
"RTN","SYNFHIRU",164,0)
 . d setIndex(index,purl,"type",type)
"RTN","SYNFHIRU",165,0)
 . d setIndex(index,purl,"rien",%wi)
"RTN","SYNFHIRU",166,0)
 i type="medicationReference" d  q  ;
"RTN","SYNFHIRU",167,0)
 . n purl s purl=$g(@ary@("fullUrl"))
"RTN","SYNFHIRU",168,0)
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
"RTN","SYNFHIRU",169,0)
 . i $e(purl,$l(purl))="/" s purl=purl_%wi
"RTN","SYNFHIRU",170,0)
 . d setIndex(index,purl,"type",type)
"RTN","SYNFHIRU",171,0)
 . d setIndex(index,purl,"rien",%wi)
"RTN","SYNFHIRU",172,0)
 . n enc s enc=$g(@ary@("resource","context","reference")) q:enc=""
"RTN","SYNFHIRU",173,0)
 . d setIndex(index,purl,"encounterReference",enc)
"RTN","SYNFHIRU",174,0)
 . n pat s pat=$g(@ary@("resource","subject","reference")) q:pat=""
"RTN","SYNFHIRU",175,0)
 . d setIndex(index,purl,"patientReference",pat)
"RTN","SYNFHIRU",176,0)
 i type="Immunizationi" d  q  ;
"RTN","SYNFHIRU",177,0)
 . n purl s purl=$g(@ary@("fullUrl"))
"RTN","SYNFHIRU",178,0)
 . i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
"RTN","SYNFHIRU",179,0)
 . i $e(purl,$l(purl))="/" s purl=purl_%wi
"RTN","SYNFHIRU",180,0)
 . d setIndex(index,purl,"type",type)
"RTN","SYNFHIRU",181,0)
 . d setIndex(index,purl,"rien",%wi)
"RTN","SYNFHIRU",182,0)
 . n enc s enc=$g(@ary@("resource","encounter","reference")) q:enc=""
"RTN","SYNFHIRU",183,0)
 . d setIndex(index,purl,"encounterReference",enc)
"RTN","SYNFHIRU",184,0)
 . n pat s pat=$g(@ary@("resource","patient","reference")) q:pat=""
"RTN","SYNFHIRU",185,0)
 . d setIndex(index,purl,"patientReference",pat)
"RTN","SYNFHIRU",186,0)
 n purl s purl=$g(@ary@("fullUrl"))
"RTN","SYNFHIRU",187,0)
 i purl="" s purl=type_"/"_$g(@ary@("resource","id"))
"RTN","SYNFHIRU",188,0)
 i $e(purl,$l(purl))="/" s purl=purl_%wi
"RTN","SYNFHIRU",189,0)
 d setIndex(index,purl,"type",type)
"RTN","SYNFHIRU",190,0)
 d setIndex(index,purl,"rien",%wi)
"RTN","SYNFHIRU",191,0)
 n enc s enc=$g(@ary@("resource","context","reference")) q:enc=""
"RTN","SYNFHIRU",192,0)
 d setIndex(index,purl,"encounterReference",enc)
"RTN","SYNFHIRU",193,0)
 n pat s pat=$g(@ary@("resource","subject","reference")) q:pat=""
"RTN","SYNFHIRU",194,0)
 d setIndex(index,purl,"patientReference",pat)
"RTN","SYNFHIRU",195,0)
 q
"RTN","SYNFHIRU",196,0)
 ;
"RTN","SYNFHIRU",197,0)
setIndex(gn,sub,pred,obj)       ; set the graph indexices
"RTN","SYNFHIRU",198,0)
 ;n gn s gn=$$setroot^%wd("fhir-intake")
"RTN","SYNFHIRU",199,0)
 q:sub=""
"RTN","SYNFHIRU",200,0)
 q:pred=""
"RTN","SYNFHIRU",201,0)
 q:obj=""
"RTN","SYNFHIRU",202,0)
 s @gn@("SPO",sub,pred,obj)=""
"RTN","SYNFHIRU",203,0)
 s @gn@("POS",pred,obj,sub)=""
"RTN","SYNFHIRU",204,0)
 s @gn@("PSO",pred,sub,obj)=""
"RTN","SYNFHIRU",205,0)
 s @gn@("OPS",obj,pred,sub)=""
"RTN","SYNFHIRU",206,0)
 q
"RTN","SYNFHIRU",207,0)
 ;
"RTN","SYNFHIRU",208,0)
bundleId(ary) ; extrinsic returns the bundle date range
"RTN","SYNFHIRU",209,0)
 n low,high
"RTN","SYNFHIRU",210,0)
 s low=$o(@ary@("POS","dateTime",""))
"RTN","SYNFHIRU",211,0)
 q:low="" ""
"RTN","SYNFHIRU",212,0)
 s high=$o(@ary@("POS","dateTime",""),-1)
"RTN","SYNFHIRU",213,0)
 s low=$p(low,"T",1)
"RTN","SYNFHIRU",214,0)
 s high=$p(high,"T",1)
"RTN","SYNFHIRU",215,0)
 q low_":"_high
"RTN","SYNFHIRU",216,0)
 ;
"RTN","SYNFHIRU",217,0)
clearIndexes(gn)        ; kill the indexes
"RTN","SYNFHIRU",218,0)
 k @gn@("SPO")
"RTN","SYNFHIRU",219,0)
 k @gn@("POS")
"RTN","SYNFHIRU",220,0)
 k @gn@("PSO")
"RTN","SYNFHIRU",221,0)
 k @gn@("OPS")
"RTN","SYNFHIRU",222,0)
 q
"RTN","SYNFHIRU",223,0)
 ;
"RTN","SYNFHIRU",224,0)
getEntry(ary,ien,rien) ; returns one entry in ary, passed by name
"RTN","SYNFHIRU",225,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFHIRU",226,0)
 i '$d(@root@(ien,"json","entry",rien)) q  ;
"RTN","SYNFHIRU",227,0)
 m @ary@("entry",rien)=@root@(ien,"json","entry",rien)
"RTN","SYNFHIRU",228,0)
 q
"RTN","SYNFHIRU",229,0)
 ;
"RTN","SYNFHIRU",230,0)
loadStatus(ary,ien,rien) ; returns the "load" section of the patient graph
"RTN","SYNFHIRU",231,0)
 ; if rien is not specified, all entries are included
"RTN","SYNFHIRU",232,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFHIRU",233,0)
 i '$d(@root@(ien)) q  
"RTN","SYNFHIRU",234,0)
 i $g(rien)="" d  q  ;
"RTN","SYNFHIRU",235,0)
 . k @ary
"RTN","SYNFHIRU",236,0)
 . m @ary@(ien)=@root@(ien,"load")
"RTN","SYNFHIRU",237,0)
 n zi s zi=""
"RTN","SYNFHIRU",238,0)
 f  s zi=$o(@root@(ien,"load",zi)) q:$d(@root@(ien,"load",zi,rien))
"RTN","SYNFHIRU",239,0)
 k @ary
"RTN","SYNFHIRU",240,0)
 m @ary@(ien,rien)=@root@(ien,"load",zi,rien)
"RTN","SYNFHIRU",241,0)
 q
"RTN","SYNFHIRU",242,0)
 ;
"RTN","SYNFHIRU",243,0)
wsLoadStatus(rtn,filter) ; displays the load status 
"RTN","SYNFHIRU",244,0)
 ; filter must have ien or dfn to specify the patient
"RTN","SYNFHIRU",245,0)
 ; optionally, entry number (rien) for a single entry
"RTN","SYNFHIRU",246,0)
 ; if ien and dfn are both specified, dfn is used
"RTN","SYNFHIRU",247,0)
 ; now supports latest=1 to show the load status of the lastest added patient
"RTN","SYNFHIRU",248,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFHIRU",249,0)
 n ien s ien=$g(filter("ien"))
"RTN","SYNFHIRU",250,0)
 i $g(filter("latest"))=1 d  ;
"RTN","SYNFHIRU",251,0)
 . set ien=$o(@root@(" "),-1)
"RTN","SYNFHIRU",252,0)
 n dfn s dfn=$g(filter("dfn"))
"RTN","SYNFHIRU",253,0)
 i dfn'="" s ien=$$dfn2ien^SYNFUTL(dfn)
"RTN","SYNFHIRU",254,0)
 n rien s rien=$g(filter("rien"))
"RTN","SYNFHIRU",255,0)
 q:ien=""
"RTN","SYNFHIRU",256,0)
 n load
"RTN","SYNFHIRU",257,0)
 d loadStatus("load",ien,rien)
"RTN","SYNFHIRU",258,0)
 s filter("root")="load"
"RTN","SYNFHIRU",259,0)
 s filter("local")=1
"RTN","SYNFHIRU",260,0)
 d wsGLOBAL^SYNVPR(.rtn,.filter)
"RTN","SYNFHIRU",261,0)
 q
"RTN","SYNFHIRU",262,0)
 ;
"RTN","SYNFIMM")
0^30^B86411217
"RTN","SYNFIMM",1,0)
SYNFIMM ;ven/gpl - fhir loader utilities ;2018-05-08  4:38 PM
"RTN","SYNFIMM",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNFIMM",3,0)
 ;
"RTN","SYNFIMM",4,0)
 ; Authored by George P. Lilly 2017-2018
"RTN","SYNFIMM",5,0)
 ;
"RTN","SYNFIMM",6,0)
 q
"RTN","SYNFIMM",7,0)
 ;
"RTN","SYNFIMM",8,0)
importImmu(rtn,ien,args) ; entry point for loading Immunizations for a patient
"RTN","SYNFIMM",9,0)
 ; calls the intake Immunizations web service directly
"RTN","SYNFIMM",10,0)
 ;
"RTN","SYNFIMM",11,0)
 n grtn
"RTN","SYNFIMM",12,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFIMM",13,0)
 d wsIntakeImmu(.args,,.grtn,ien)
"RTN","SYNFIMM",14,0)
 i $d(grtn) d  ; something was returned
"RTN","SYNFIMM",15,0)
 . k @root@(ien,"load","immunizations")
"RTN","SYNFIMM",16,0)
 . m @root@(ien,"load","immunizations")=grtn("immunizations")
"RTN","SYNFIMM",17,0)
 . if $g(args("debug"))=1 m rtn=grtn
"RTN","SYNFIMM",18,0)
 s rtn("immunizationsStatus","status")=$g(grtn("status","status"))
"RTN","SYNFIMM",19,0)
 s rtn("immunizationsStatus","loaded")=$g(grtn("status","loaded"))
"RTN","SYNFIMM",20,0)
 s rtn("immunizationsStatus","errors")=$g(grtn("status","errors"))
"RTN","SYNFIMM",21,0)
 ;b
"RTN","SYNFIMM",22,0)
 ;
"RTN","SYNFIMM",23,0)
 ;
"RTN","SYNFIMM",24,0)
 q
"RTN","SYNFIMM",25,0)
 ;
"RTN","SYNFIMM",26,0)
wsIntakeImmu(args,body,result,ien) ; web service entry (post)
"RTN","SYNFIMM",27,0)
 ; for intake of one or more Immunizations. input are fhir resources
"RTN","SYNFIMM",28,0)
 ; result is json and summarizes what was done
"RTN","SYNFIMM",29,0)
 ; args include patientId
"RTN","SYNFIMM",30,0)
 ; ien is specified for internal calls, where the json is already in a graph
"RTN","SYNFIMM",31,0)
 n jtmp,json,jrslt,eval
"RTN","SYNFIMM",32,0)
 ;i $g(ien)'="" if $$loadStatus("immunizations","",ien)=1 d  q  ;
"RTN","SYNFIMM",33,0)
 ;. s result("immunizationsStatus","status")="alreadyLoaded"
"RTN","SYNFIMM",34,0)
 i $g(ien)'="" d  ; internal call
"RTN","SYNFIMM",35,0)
 . d getIntakeFhir^SYNFHIR("json",,"Immunization",ien,1)
"RTN","SYNFIMM",36,0)
 e  d  ; 
"RTN","SYNFIMM",37,0)
 . s args("load")=0
"RTN","SYNFIMM",38,0)
 . merge jtmp=BODY
"RTN","SYNFIMM",39,0)
 . do DECODE^VPRJSON("jtmp","json")
"RTN","SYNFIMM",40,0)
 i '$d(json) q  ;
"RTN","SYNFIMM",41,0)
 m ^gpl("gjson")=json
"RTN","SYNFIMM",42,0)
 ;
"RTN","SYNFIMM",43,0)
 ; determine the patient
"RTN","SYNFIMM",44,0)
 ;
"RTN","SYNFIMM",45,0)
 n dfn,eval
"RTN","SYNFIMM",46,0)
 if $g(ien)'="" d  ;
"RTN","SYNFIMM",47,0)
 . s dfn=$$ien2dfn^SYNFUTL(ien) ; look up dfn in the graph
"RTN","SYNFIMM",48,0)
 else  d  ;
"RTN","SYNFIMM",49,0)
 . s dfn=$g(args("dfn"))
"RTN","SYNFIMM",50,0)
 . i dfn="" d  ;
"RTN","SYNFIMM",51,0)
 . . n icn s icn=$g(args("icn"))
"RTN","SYNFIMM",52,0)
 . . i icn'="" s dfn=$$icn2dfn^SYNFUTL(icn)
"RTN","SYNFIMM",53,0)
 i $g(dfn)="" do  quit  ; need the patient
"RTN","SYNFIMM",54,0)
 . s result("immunizations",1,"log",1)="Error, patient not found.. terminating"
"RTN","SYNFIMM",55,0)
 ;
"RTN","SYNFIMM",56,0)
 ;
"RTN","SYNFIMM",57,0)
 new zi s zi=0
"RTN","SYNFIMM",58,0)
 for  set zi=$order(json("entry",zi)) quit:+zi=0  do  ;
"RTN","SYNFIMM",59,0)
 . ;
"RTN","SYNFIMM",60,0)
 . ; define a place to log the processing of this entry
"RTN","SYNFIMM",61,0)
 . ;
"RTN","SYNFIMM",62,0)
 . new jlog set jlog=$name(eval("immunizations",zi))
"RTN","SYNFIMM",63,0)
 . ;
"RTN","SYNFIMM",64,0)
 . ; insure that the resourceType is Observation
"RTN","SYNFIMM",65,0)
 . ;
"RTN","SYNFIMM",66,0)
 . new type set type=$get(json("entry",zi,"resource","resourceType"))
"RTN","SYNFIMM",67,0)
 . if type'="Immunization" do  quit  ;
"RTN","SYNFIMM",68,0)
 . . set eval("immunizations",zi,"vars","resourceType")=type
"RTN","SYNFIMM",69,0)
 . . do log(jlog,"Resource type not Immunization, skipping entry")
"RTN","SYNFIMM",70,0)
 . set eval("immunizations",zi,"vars","resourceType")=type
"RTN","SYNFIMM",71,0)
 . ;
"RTN","SYNFIMM",72,0)
 . ; see if this resource has already been loaded. if so, skip it
"RTN","SYNFIMM",73,0)
 . ;
"RTN","SYNFIMM",74,0)
 . if $g(ien)'="" if $$loadStatus("immunization",zi,ien)=1 do  quit  ;
"RTN","SYNFIMM",75,0)
 . . d log(jlog,"Immunization already loaded, skipping")
"RTN","SYNFIMM",76,0)
 . ;
"RTN","SYNFIMM",77,0)
 . ; determine Immunization cvx code, coding system, and display text
"RTN","SYNFIMM",78,0)
 . ;
"RTN","SYNFIMM",79,0)
 . ;
"RTN","SYNFIMM",80,0)
 . ; determine the id of the resource
"RTN","SYNFIMM",81,0)
 . ;
"RTN","SYNFIMM",82,0)
 . ;new id set id=$get(json("entry",zi,"resource","id"))
"RTN","SYNFIMM",83,0)
 . ;set eval("immunizations",zi,"vars","id")=id
"RTN","SYNFIMM",84,0)
 . ;d log(jlog,"ID is: "_id)
"RTN","SYNFIMM",85,0)
 . ;
"RTN","SYNFIMM",86,0)
 . new cvxcode set cvxcode=$get(json("entry",zi,"resource","vaccineCode","coding",1,"code"))
"RTN","SYNFIMM",87,0)
 . do log(jlog,"code is: "_cvxcode)
"RTN","SYNFIMM",88,0)
 . set eval("immunizations",zi,"vars","code")=cvxcode
"RTN","SYNFIMM",89,0)
 . ;
"RTN","SYNFIMM",90,0)
 . ;
"RTN","SYNFIMM",91,0)
 . new codesystem set codesystem=$get(json("entry",zi,"resource","vaccineCode","coding",1,"system"))
"RTN","SYNFIMM",92,0)
 . do log(jlog,"code system is: "_codesystem)
"RTN","SYNFIMM",93,0)
 . set eval("immunizations",zi,"vars","codeSystem")=codesystem
"RTN","SYNFIMM",94,0)
 . ;
"RTN","SYNFIMM",95,0)
 . ; determine the effective date
"RTN","SYNFIMM",96,0)
 . ;
"RTN","SYNFIMM",97,0)
 . new effdate set effdate=$get(json("entry",zi,"resource","date"))
"RTN","SYNFIMM",98,0)
 . do log(jlog,"effectiveDateTime is: "_effdate)
"RTN","SYNFIMM",99,0)
 . set eval("immunizations",zi,"vars","effectiveDateTime")=effdate
"RTN","SYNFIMM",100,0)
 . new fmtime s fmtime=$$fhirTfm^SYNFUTL(effdate)
"RTN","SYNFIMM",101,0)
 . d log(jlog,"fileman dateTime is: "_fmtime)
"RTN","SYNFIMM",102,0)
 . set eval("immunizations",zi,"vars","fmDateTime")=fmtime ;
"RTN","SYNFIMM",103,0)
 . new hl7time s hl7time=$$fhirThl7^SYNFUTL(effdate)
"RTN","SYNFIMM",104,0)
 . d log(jlog,"hl7 dateTime is: "_hl7time)
"RTN","SYNFIMM",105,0)
 . set eval("immunizations",zi,"vars","hl7DateTime")=hl7time ;
"RTN","SYNFIMM",106,0)
 . ;
"RTN","SYNFIMM",107,0)
 . ; determine the encounter visit ien
"RTN","SYNFIMM",108,0)
 . n encounterId
"RTN","SYNFIMM",109,0)
 . s encounterId=$g(json("entry",zi,"resource","encounter","reference"))
"RTN","SYNFIMM",110,0)
 . i encounterId["urn:uuid:" s encounterId=$p(encounterId,"urn:uuid:",2)
"RTN","SYNFIMM",111,0)
 . s eval("immunizations",zi,"vars","encounterId")=encounterId
"RTN","SYNFIMM",112,0)
 . d log(jlog,"reference encounter ID is : "_encounterId)
"RTN","SYNFIMM",113,0)
 . ;
"RTN","SYNFIMM",114,0)
 . n visitIen s visitIen=$$visitIen^SYNFENC(ien,encounterId)
"RTN","SYNFIMM",115,0)
 . s eval("immunizations",zi,"vars","visitIen")=visitIen
"RTN","SYNFIMM",116,0)
 . d log(jlog,"visit ien is: "_visitIen)
"RTN","SYNFIMM",117,0)
 . ;
"RTN","SYNFIMM",118,0)
 . ; set up to call the data loader
"RTN","SYNFIMM",119,0)
 . ;
"RTN","SYNFIMM",120,0)
 . ;IMMUNUPD(RETSTA,DHPPAT,VISIT,IMMUNIZ,ANATLOC,ADMINRT,DOSE,EVENTDT,IMMPROV)  ;Immunization update
"RTN","SYNFIMM",121,0)
 . n RETSTA,DHPPAT,VISIT,IMMUNIZ,ANATLOC,ADMINRT,DOSE,EVENTDT,IMMPROV      ;Immunization update
"RTN","SYNFIMM",122,0)
 . s (DHPPAT,VISIT,IMMUNIZ,ANATLOC,ADMINRT,DOSE,EVENTDT,IMMPROV)=""      ;Immunization update
"RTN","SYNFIMM",123,0)
 . ;
"RTN","SYNFIMM",124,0)
 . s DHPPAT=$$dfn2icn^SYNFUTL(dfn)
"RTN","SYNFIMM",125,0)
 . s eval("immunizations",zi,"parms","DHPPAT")=DHPPAT
"RTN","SYNFIMM",126,0)
 . ;
"RTN","SYNFIMM",127,0)
 . s VISIT=visitIen
"RTN","SYNFIMM",128,0)
 . s eval("immunizations",zi,"parms","VISIT")=visitIen
"RTN","SYNFIMM",129,0)
 . ;
"RTN","SYNFIMM",130,0)
 . s IMMUNIZ=cvxcode
"RTN","SYNFIMM",131,0)
 . s eval("immunizations",zi,"parms","IMMUNIZ")=IMMUNIZ
"RTN","SYNFIMM",132,0)
 . ;
"RTN","SYNFIMM",133,0)
 . ;
"RTN","SYNFIMM",134,0)
 . s EVENTDT=hl7time
"RTN","SYNFIMM",135,0)
 . s eval("immunizations",zi,"parms","EVENTDT")=hl7time
"RTN","SYNFIMM",136,0)
 . d log(jlog,"HL7 DateTime is: "_hl7time)
"RTN","SYNFIMM",137,0)
 . ;
"RTN","SYNFIMM",138,0)
 . s IMMPROV=$$MAP^SYNQLDM("OP","provider") ; should map to an NPI
"RTN","SYNFIMM",139,0)
 . ;n DHPPROVIEN s DHPPROVIEN=$o(^VA(200,"B",IMMPROV,""))
"RTN","SYNFIMM",140,0)
 . ;if DHPPROVIEN="" S DHPPROVIEN=3
"RTN","SYNFIMM",141,0)
 . s eval("immunizations",zi,"parms","IMMPROV")=IMMPROV
"RTN","SYNFIMM",142,0)
 . d log(jlog,"Provider NPI for outpatient is: "_IMMPROV)
"RTN","SYNFIMM",143,0)
 . ;
"RTN","SYNFIMM",144,0)
 . s DHPLOC=$$MAP^SYNQLDM("OP","location")
"RTN","SYNFIMM",145,0)
 . n DHPLOCIEN s DHPLOCIEN=$o(^SC("B",DHPLOC,""))
"RTN","SYNFIMM",146,0)
 . if DHPLOCIEN="" S DHPLOCIEN=4
"RTN","SYNFIMM",147,0)
 . s eval("immunizations",zi,"parms","DHPLOC")=DHPLOCIEN
"RTN","SYNFIMM",148,0)
 . d log(jlog,"Location for outpatient is: #"_DHPLOCIEN_" "_DHPLOC)
"RTN","SYNFIMM",149,0)
 . ;
"RTN","SYNFIMM",150,0)
 . s eval("immunizations",zi,"status","loadstatus")="readyToLoad"
"RTN","SYNFIMM",151,0)
 . ;
"RTN","SYNFIMM",152,0)
 . if $g(args("load"))=1 d  ; only load if told to
"RTN","SYNFIMM",153,0)
 . . if $g(ien)'="" if $$loadStatus("immunizations",zi,ien)=1 do  quit  ;
"RTN","SYNFIMM",154,0)
 . . . d log(jlog,"Immunization already loaded, skipping")
"RTN","SYNFIMM",155,0)
 . . d log(jlog,"Calling IMMUNUPD^SYNDHP61 to add immunization")
"RTN","SYNFIMM",156,0)
 . . D IMMUNUPD^SYNDHP61(.RETSTA,DHPPAT,.VISIT,IMMUNIZ,ANATLOC,ADMINRT,DOSE,EVENTDT,IMMPROV) ;Immunization update
"RTN","SYNFIMM",157,0)
 . . m eval("immunizations",zi,"status")=RETSTA
"RTN","SYNFIMM",158,0)
 . . d log(jlog,"Return from data loader was: "_$g(RETSTA))
"RTN","SYNFIMM",159,0)
 . . if +$g(RETSTA)=1 do  ;
"RTN","SYNFIMM",160,0)
 . . . s eval("status","loaded")=$g(eval("status","loaded"))+1
"RTN","SYNFIMM",161,0)
 . . . s eval("immunizations",zi,"status","loadstatus")="loaded"
"RTN","SYNFIMM",162,0)
 . . else  d  ;
"RTN","SYNFIMM",163,0)
 . . . s eval("status","errors")=$g(eval("status","errors"))+1
"RTN","SYNFIMM",164,0)
 . . . s eval("immunizations",zi,"status","loadstatus")="notLoaded"
"RTN","SYNFIMM",165,0)
 . . . s eval("immunizations",zi,"status","loadMessage")=$g(RETSTA)
"RTN","SYNFIMM",166,0)
 . . n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFIMM",167,0)
 . . k @root@(ien,"load","immunizations",zi)
"RTN","SYNFIMM",168,0)
 . . m @root@(ien,"load","immunizations",zi)=eval("immunizations",zi)
"RTN","SYNFIMM",169,0)
 ;
"RTN","SYNFIMM",170,0)
 if $get(args("debug"))=1 do  ;
"RTN","SYNFIMM",171,0)
 . m jrslt("source")=json
"RTN","SYNFIMM",172,0)
 . m jrslt("args")=args
"RTN","SYNFIMM",173,0)
 . m jrslt("eval")=eval
"RTN","SYNFIMM",174,0)
 m jrslt("immunizationsStatus")=eval("immunizationsStatus")
"RTN","SYNFIMM",175,0)
 set jrslt("result","status")="ok"
"RTN","SYNFIMM",176,0)
 set jrslt("result","loaded")=$g(eval("status","loaded"))
"RTN","SYNFIMM",177,0)
 i $g(ien)'="" d  ; called internally
"RTN","SYNFIMM",178,0)
 . m result=eval
"RTN","SYNFIMM",179,0)
 . m result("status")=jrslt("result")
"RTN","SYNFIMM",180,0)
 . m result("dfn")=dfn
"RTN","SYNFIMM",181,0)
 . m result("ien")=ien
"RTN","SYNFIMM",182,0)
 . ;b
"RTN","SYNFIMM",183,0)
 e  d  ;
"RTN","SYNFIMM",184,0)
 . d ENCODE^VPRJSON("jrslt","result")
"RTN","SYNFIMM",185,0)
 . set HTTPRSP("mime")="application/json" 
"RTN","SYNFIMM",186,0)
 q
"RTN","SYNFIMM",187,0)
 ;
"RTN","SYNFIMM",188,0)
log(ary,txt) ; adds a text line to @ary@("log")
"RTN","SYNFIMM",189,0)
 s @ary@("log",$o(@ary@("log",""),-1)+1)=$g(txt)
"RTN","SYNFIMM",190,0)
 q
"RTN","SYNFIMM",191,0)
 ;
"RTN","SYNFIMM",192,0)
loadStatus(typ,zx,zien) ; extrinsic return 1 if resource was loaded
"RTN","SYNFIMM",193,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFIMM",194,0)
 n rt s rt=0
"RTN","SYNFIMM",195,0)
 i $g(zx)="" i $d(@root@(zien,"load",typ)) s rt=1 q rt
"RTN","SYNFIMM",196,0)
 i $get(@root@(zien,"load",typ,zx,"status","loadstatus"))="loaded" s rt=1
"RTN","SYNFIMM",197,0)
 q rt
"RTN","SYNFIMM",198,0)
 ;
"RTN","SYNFIMM",199,0)
testall ; run the immunizations import on all imported patients
"RTN","SYNFIMM",200,0)
 new root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFIMM",201,0)
 new indx s indx=$na(@root@("POS","DFN"))
"RTN","SYNFIMM",202,0)
 n dfn,ien,filter,reslt
"RTN","SYNFIMM",203,0)
 s dfn=0
"RTN","SYNFIMM",204,0)
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  d  ;
"RTN","SYNFIMM",205,0)
 . s ien=$o(@indx@(dfn,""))
"RTN","SYNFIMM",206,0)
 . q:ien=""
"RTN","SYNFIMM",207,0)
 . s filter("dfn")=dfn
"RTN","SYNFIMM",208,0)
 . k reslt
"RTN","SYNFIMM",209,0)
 . d wsIntakeImmu(.filter,,.reslt,ien)
"RTN","SYNFIMM",210,0)
 q
"RTN","SYNFIMM",211,0)
 ;
"RTN","SYNFIMM",212,0)
testone(reslt,doload) ; run the immunizations import on all imported patients
"RTN","SYNFIMM",213,0)
 new root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFIMM",214,0)
 new indx s indx=$na(@root@("POS","DFN"))
"RTN","SYNFIMM",215,0)
 n dfn,ien,filter
"RTN","SYNFIMM",216,0)
 n done s done=0
"RTN","SYNFIMM",217,0)
 s dfn=0
"RTN","SYNFIMM",218,0)
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  q:done   d  ;
"RTN","SYNFIMM",219,0)
 . s ien=$o(@indx@(dfn,""))
"RTN","SYNFIMM",220,0)
 . q:ien=""
"RTN","SYNFIMM",221,0)
 . q:$d(@root@(ien,"load","immunizations"))
"RTN","SYNFIMM",222,0)
 . s filter("dfn")=dfn
"RTN","SYNFIMM",223,0)
 . s filter("debug")=1
"RTN","SYNFIMM",224,0)
 . i $g(doload)=1 s filter("load")=1
"RTN","SYNFIMM",225,0)
 . k reslt
"RTN","SYNFIMM",226,0)
 . d wsIntakeImmu(.filter,,.reslt,ien)
"RTN","SYNFIMM",227,0)
 . s done=1
"RTN","SYNFIMM",228,0)
 q
"RTN","SYNFIMM",229,0)
 ;
"RTN","SYNFLAB")
0^31^B146417532
"RTN","SYNFLAB",1,0)
SYNFLAB ;ven/gpl - fhir loader utilities ;2018-05-08  4:23 PM
"RTN","SYNFLAB",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNFLAB",3,0)
 ;
"RTN","SYNFLAB",4,0)
 ; Authored by George P. Lilly 2017-2018
"RTN","SYNFLAB",5,0)
 ;
"RTN","SYNFLAB",6,0)
 q
"RTN","SYNFLAB",7,0)
 ;
"RTN","SYNFLAB",8,0)
importLabs(rtn,ien,args) ; entry point for loading labs for a patient
"RTN","SYNFLAB",9,0)
 ; calls the intake Labs web service directly
"RTN","SYNFLAB",10,0)
 ;
"RTN","SYNFLAB",11,0)
 n grtn
"RTN","SYNFLAB",12,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFLAB",13,0)
 n % s %=$$wsIntakeLabs(.args,,.grtn,ien)
"RTN","SYNFLAB",14,0)
 i $d(grtn) d  ; something was returned
"RTN","SYNFLAB",15,0)
 . k @root@(ien,"load","labs")
"RTN","SYNFLAB",16,0)
 . m @root@(ien,"load","labs")=grtn("labs")
"RTN","SYNFLAB",17,0)
 . if $g(args("debug"))=1 m rtn=grtn
"RTN","SYNFLAB",18,0)
 s rtn("labsStatus","status")=$g(grtn("status","status"))
"RTN","SYNFLAB",19,0)
 s rtn("labsStatus","loaded")=$g(grtn("status","loaded"))
"RTN","SYNFLAB",20,0)
 s rtn("labsStatus","errors")=$g(grtn("status","errors"))
"RTN","SYNFLAB",21,0)
 ;b
"RTN","SYNFLAB",22,0)
 ;
"RTN","SYNFLAB",23,0)
 ;
"RTN","SYNFLAB",24,0)
 q
"RTN","SYNFLAB",25,0)
 ;
"RTN","SYNFLAB",26,0)
wsIntakeLabs(args,body,result,ien) ; web service entry (post)
"RTN","SYNFLAB",27,0)
 ; for intake of one or more Lab results. input are fhir resources
"RTN","SYNFLAB",28,0)
 ; result is json and summarizes what was done
"RTN","SYNFLAB",29,0)
 ; args include patientId
"RTN","SYNFLAB",30,0)
 ; ien is specified for internal calls, where the json is already in a graph
"RTN","SYNFLAB",31,0)
 n jtmp,json,jrslt,eval
"RTN","SYNFLAB",32,0)
 ;i $g(ien)'="" if $$loadStatus("labs","",ien)=1 d  q  ;
"RTN","SYNFLAB",33,0)
 ;. s result("labsStatus","status")="alreadyLoaded"
"RTN","SYNFLAB",34,0)
 i $g(ien)'="" d  ; internal call
"RTN","SYNFLAB",35,0)
 . d getIntakeFhir^SYNFHIR("json",,"Observation",ien,1)
"RTN","SYNFLAB",36,0)
 e  d  ;
"RTN","SYNFLAB",37,0)
 . ;s args("load")=0
"RTN","SYNFLAB",38,0)
 . merge jtmp=BODY
"RTN","SYNFLAB",39,0)
 . do DECODE^VPRJSON("jtmp","json")
"RTN","SYNFLAB",40,0)
 i '$d(json) q 0  ;
"RTN","SYNFLAB",41,0)
 m ^gpl("gjson")=json
"RTN","SYNFLAB",42,0)
 ;
"RTN","SYNFLAB",43,0)
 ; determine the patient
"RTN","SYNFLAB",44,0)
 ;
"RTN","SYNFLAB",45,0)
 n dfn,eval
"RTN","SYNFLAB",46,0)
 if $g(ien)'="" d  ;
"RTN","SYNFLAB",47,0)
 . s dfn=$$ien2dfn^SYNFUTL(ien) ; look up dfn in the graph
"RTN","SYNFLAB",48,0)
 else  d  ;
"RTN","SYNFLAB",49,0)
 . s dfn=$g(args("dfn"))
"RTN","SYNFLAB",50,0)
 . i dfn="" d  ;
"RTN","SYNFLAB",51,0)
 . . n icn s icn=$g(args("icn"))
"RTN","SYNFLAB",52,0)
 . . i icn'="" s dfn=$$icn2dfn^SYNFUTL(icn)
"RTN","SYNFLAB",53,0)
 i $g(dfn)="" do  quit 0  ; need the patient
"RTN","SYNFLAB",54,0)
 . s result("labs",1,"log",1)="Error, patient not found.. terminating"
"RTN","SYNFLAB",55,0)
 ;
"RTN","SYNFLAB",56,0)
 ;
"RTN","SYNFLAB",57,0)
 new zi s zi=0
"RTN","SYNFLAB",58,0)
 for  set zi=$order(json("entry",zi)) quit:+zi=0  do  ;
"RTN","SYNFLAB",59,0)
 . ;
"RTN","SYNFLAB",60,0)
 . ; define a place to log the processing of this entry
"RTN","SYNFLAB",61,0)
 . ;
"RTN","SYNFLAB",62,0)
 . new jlog set jlog=$name(eval("labs",zi))
"RTN","SYNFLAB",63,0)
 . ;
"RTN","SYNFLAB",64,0)
 . ; insure that the resourceType is Observation
"RTN","SYNFLAB",65,0)
 . ;
"RTN","SYNFLAB",66,0)
 . new type set type=$get(json("entry",zi,"resource","resourceType"))
"RTN","SYNFLAB",67,0)
 . if type'="Observation" do  quit  ;
"RTN","SYNFLAB",68,0)
 . . set eval("labs",zi,"vars","resourceType")=type
"RTN","SYNFLAB",69,0)
 . . do log(jlog,"Resource type not Observation, skipping entry")
"RTN","SYNFLAB",70,0)
 . set eval("labs",zi,"vars","resourceType")=type
"RTN","SYNFLAB",71,0)
 . ;
"RTN","SYNFLAB",72,0)
 . ; determine the Observation category and quit if not labs
"RTN","SYNFLAB",73,0)
 . ;
"RTN","SYNFLAB",74,0)
 . new obstype set obstype=$get(json("entry",zi,"resource","category",1,"coding",1,"code"))
"RTN","SYNFLAB",75,0)
 . if obstype="" do  ; category is missing, try mapping the code
"RTN","SYNFLAB",76,0)
 . . new trycode,trydisp,tryy
"RTN","SYNFLAB",77,0)
 . . set trycode=$g(json("entry",zi,"resource","code","coding",1,"code"))
"RTN","SYNFLAB",78,0)
 . . set trydisp=$g(json("entry",zi,"resource","code","coding",1,"display"))
"RTN","SYNFLAB",79,0)
 . . s tryy=$$loinc2sct(trycode)
"RTN","SYNFLAB",80,0)
 . . if tryy="" d  quit  ;
"RTN","SYNFLAB",81,0)
 . . . d log(jlog,"Observation Category missing, not vital signs; code is: "_trycode_" "_trydisp)
"RTN","SYNFLAB",82,0)
 . . if tryy'="" set obstype="laboratory"
"RTN","SYNFLAB",83,0)
 . . d log(jlog,"Derived category is "_obstype)
"RTN","SYNFLAB",84,0)
 . ;
"RTN","SYNFLAB",85,0)
 . if obstype'="laboratory" do  quit  ;
"RTN","SYNFLAB",86,0)
 . . set eval("labs",zi,"vars","observationCategory")=obstype
"RTN","SYNFLAB",87,0)
 . . do log(jlog,"Observation Category is not laboratory, skipping")
"RTN","SYNFLAB",88,0)
 . set eval("labs",zi,"vars","observationCategory")=obstype
"RTN","SYNFLAB",89,0)
 . ;
"RTN","SYNFLAB",90,0)
 . ; see if this resource has already been loaded. if so, skip it
"RTN","SYNFLAB",91,0)
 . ;
"RTN","SYNFLAB",92,0)
 . if $g(ien)'="" if $$loadStatus("labs",zi,ien)=1 do  quit  ;
"RTN","SYNFLAB",93,0)
 . . d log(jlog,"Lab already loaded, skipping")
"RTN","SYNFLAB",94,0)
 . ;
"RTN","SYNFLAB",95,0)
 . ; determine Labs type, code, coding system, and display text
"RTN","SYNFLAB",96,0)
 . ;
"RTN","SYNFLAB",97,0)
 . new labtype set labtype=$get(json("entry",zi,"resource","code","text"))
"RTN","SYNFLAB",98,0)
 . if labtype="" set labtype=$get(json("entry",zi,"resource","code","coding",1,"display"))
"RTN","SYNFLAB",99,0)
 . do log(jlog,"Labs type is: "_labtype)
"RTN","SYNFLAB",100,0)
 . set eval("labs",zi,"vars","type")=labtype
"RTN","SYNFLAB",101,0)
 . ;
"RTN","SYNFLAB",102,0)
 . ; determine the id of the resource
"RTN","SYNFLAB",103,0)
 . ;
"RTN","SYNFLAB",104,0)
 . new id set id=$get(json("entry",zi,"resource","id"))
"RTN","SYNFLAB",105,0)
 . set eval("labs",zi,"vars","id")=id
"RTN","SYNFLAB",106,0)
 . d log(jlog,"ID is: "_id)
"RTN","SYNFLAB",107,0)
 . ;
"RTN","SYNFLAB",108,0)
 . new obscode set obscode=$get(json("entry",zi,"resource","code","coding",1,"code"))
"RTN","SYNFLAB",109,0)
 . do log(jlog,"code is: "_obscode)
"RTN","SYNFLAB",110,0)
 . set eval("labs",zi,"vars","code")=obscode
"RTN","SYNFLAB",111,0)
 . ;
"RTN","SYNFLAB",112,0)
 . s ^gpl("labs",obscode,labtype)=""
"RTN","SYNFLAB",113,0)
 . ;
"RTN","SYNFLAB",114,0)
 . new codesystem set codesystem=$get(json("entry",zi,"resource","code","coding",1,"system"))
"RTN","SYNFLAB",115,0)
 . do log(jlog,"code system is: "_codesystem)
"RTN","SYNFLAB",116,0)
 . set eval("labs",zi,"vars","codeSystem")=codesystem
"RTN","SYNFLAB",117,0)
 . ;
"RTN","SYNFLAB",118,0)
 . ; determine the value and units
"RTN","SYNFLAB",119,0)
 . ;
"RTN","SYNFLAB",120,0)
 . new value set value=$get(json("entry",zi,"resource","valueQuantity","value"))
"RTN","SYNFLAB",121,0)
 . do log(jlog,"value is: "_value)
"RTN","SYNFLAB",122,0)
 . set eval("labs",zi,"vars","value")=value
"RTN","SYNFLAB",123,0)
 . ;
"RTN","SYNFLAB",124,0)
 . new unit set unit=$get(json("entry",zi,"resource","valueQuantity","unit"))
"RTN","SYNFLAB",125,0)
 . do log(jlog,"units are: "_unit)
"RTN","SYNFLAB",126,0)
 . set eval("labs",zi,"vars","units")=unit
"RTN","SYNFLAB",127,0)
 . ;
"RTN","SYNFLAB",128,0)
 . ; determine the effective date
"RTN","SYNFLAB",129,0)
 . ;
"RTN","SYNFLAB",130,0)
 . new effdate set effdate=$get(json("entry",zi,"resource","effectiveDateTime"))
"RTN","SYNFLAB",131,0)
 . do log(jlog,"effectiveDateTime is: "_effdate)
"RTN","SYNFLAB",132,0)
 . set eval("labs",zi,"vars","effectiveDateTime")=effdate
"RTN","SYNFLAB",133,0)
 . new fmtime s fmtime=$$fhirTfm^SYNFUTL(effdate)
"RTN","SYNFLAB",134,0)
 . d log(jlog,"fileman dateTime is: "_fmtime)
"RTN","SYNFLAB",135,0)
 . set eval("labs",zi,"vars","fmDateTime")=fmtime ;
"RTN","SYNFLAB",136,0)
 . new hl7time s hl7time=$$fhirThl7^SYNFUTL(effdate)
"RTN","SYNFLAB",137,0)
 . d log(jlog,"hl7 dateTime is: "_hl7time)
"RTN","SYNFLAB",138,0)
 . set eval("labs",zi,"vars","hl7DateTime")=hl7time ;
"RTN","SYNFLAB",139,0)
 . ;
"RTN","SYNFLAB",140,0)
 . ; set up to call the data loader
"RTN","SYNFLAB",141,0)
 . ;
"RTN","SYNFLAB",142,0)
 . n RETSTA,DHPPAT,DHPSCT,DHPOBS,DHPUNT,DHPDTM,DHPPROV,DHPLOC,DHPLOINC
"RTN","SYNFLAB",143,0)
 . ;
"RTN","SYNFLAB",144,0)
 . s DHPPAT=$$dfn2icn^SYNFUTL(dfn)
"RTN","SYNFLAB",145,0)
 . s eval("labs",zi,"parms","DHPPAT")=DHPPAT
"RTN","SYNFLAB",146,0)
 . ;
"RTN","SYNFLAB",147,0)
 . ;n vistalab s vistalab=$$MAP^SYNQLDM(obscode)
"RTN","SYNFLAB",148,0)
 . s DHPLOINC=obscode
"RTN","SYNFLAB",149,0)
 . d log(jlog,"LOINC code is: "_DHPLOINC)
"RTN","SYNFLAB",150,0)
 . s eval("labs",zi,"parms","DHPLOINC")=DHPLOINC
"RTN","SYNFLAB",151,0)
 . ;
"RTN","SYNFLAB",152,0)
 . n vistalab s vistalab=$$graphmap^SYNGRAPH("loinc-lab-map",obscode)
"RTN","SYNFLAB",153,0)
 . i +vistalab=-1 s vistalab=$$graphmap^SYNGRAPH("loinc-lab-map"," "_obscode)
"RTN","SYNFLAB",154,0)
 . if +vistalab=-1 s vistalab=labtype
"RTN","SYNFLAB",155,0)
 . s vistalab=$$TRIM^XLFSTR(vistalab) ; get rid of trailing blanks
"RTN","SYNFLAB",156,0)
 . ;n sct s sct=$$loinc2sct(obscode) ; find the snomed code
"RTN","SYNFLAB",157,0)
 . ;i vistalab="" d  quit
"RTN","SYNFLAB",158,0)
 . ;. d log(jlog,"VistA lab not found for loinc code: "_obscode_" "_labtype_" -- skipping")
"RTN","SYNFLAB",159,0)
 . ;. s eval("labs",zi,"status","loadstatus")="cannotLoad"
"RTN","SYNFLAB",160,0)
 . ;. s eval("labs",zi,"status","issue")="VistA lab not found for loinc code: "_obscode_" "_labtype_" -- skipping"
"RTN","SYNFLAB",161,0)
 . ;. s eval("status","errors")=$g(eval("status","errors"))+1
"RTN","SYNFLAB",162,0)
 . s eval("labs",zi,"parms","DHPLAB")=vistalab
"RTN","SYNFLAB",163,0)
 . d log(jlog,"VistA Lab is: "_vistalab)
"RTN","SYNFLAB",164,0)
 . s DHPLAB=vistalab
"RTN","SYNFLAB",165,0)
 . ;
"RTN","SYNFLAB",166,0)
 . s DHPOBS=value
"RTN","SYNFLAB",167,0)
 . s recien=$o(^LAB(60,"B",DHPLAB,""))
"RTN","SYNFLAB",168,0)
 . n xform s xform=$$GET1^DIQ(60,recien_",",410)
"RTN","SYNFLAB",169,0)
 . n dec s dec=0
"RTN","SYNFLAB",170,0)
 . i xform["S Q9=" d
"RTN","SYNFLAB",171,0)
 . . s dec=+$p($p(xform,"""",2),",",3)
"RTN","SYNFLAB",172,0)
 . i $l($p(DHPOBS,".",2))>1 d
"RTN","SYNFLAB",173,0)
 . . s DHPOBS=$s(dec<4:$j(DHPOBS,1,dec),dec>3:$j(DHPOBS,1,3),1:$j(DHPOBS,1,0)) ; fix results with too many decimal places
"RTN","SYNFLAB",174,0)
 . s eval("labs",zi,"parms","DHPOBS")=DHPOBS
"RTN","SYNFLAB",175,0)
 . d log(jlog,"Value is: "_DHPOBS)
"RTN","SYNFLAB",176,0)
 . ;
"RTN","SYNFLAB",177,0)
 . ;i DHPLOINC="2093-3" s DHPOBS=$J(DHPOBS,1,0) ;Total Cholesterol
"RTN","SYNFLAB",178,0)
 . ;i DHPLOINC="33914-3" s DHPOBS=$J(DHPOBS,1,0) ;Estimated Glomerular Filtration Rate
"RTN","SYNFLAB",179,0)
 . ;i DHPLOINC="18262-6" s DHPOBS=$J(DHPOBS,1,0) ;Low Density Cholesterol
"RTN","SYNFLAB",180,0)
 . ;i DHPLOINC="2085-9" s DHPOBS=$J(DHPOBS,1,0) ;High Density Cholesterol
"RTN","SYNFLAB",181,0)
 . ;i DHPLOINC="2571-8" s DHPOBS=$J(DHPOBS,1,0) ;Tryglycerides
"RTN","SYNFLAB",182,0)
 . ;i DHPLOINC="2339-0" s DHPOBS=$J(DHPOBS,1,0) ;Glucose
"RTN","SYNFLAB",183,0)
 . ;
"RTN","SYNFLAB",184,0)
 . s DHPUNT=unit
"RTN","SYNFLAB",185,0)
 . s eval("labs",zi,"parms","DHPUNT")=unit
"RTN","SYNFLAB",186,0)
 . d log(jlog,"Units are: "_unit)
"RTN","SYNFLAB",187,0)
 . ;
"RTN","SYNFLAB",188,0)
 . s DHPDTM=hl7time
"RTN","SYNFLAB",189,0)
 . s eval("labs",zi,"parms","DHPDTM")=hl7time
"RTN","SYNFLAB",190,0)
 . d log(jlog,"HL7 DateTime is: "_hl7time)
"RTN","SYNFLAB",191,0)
 . ;
"RTN","SYNFLAB",192,0)
 . s DHPPROV=$$MAP^SYNQLDM("OP","provider")
"RTN","SYNFLAB",193,0)
 . n DHPPROVIEN s DHPPROVIEN=$o(^VA(200,"B",DHPPROV,""))
"RTN","SYNFLAB",194,0)
 . if DHPPROVIEN="" S DHPPROVIEN=3
"RTN","SYNFLAB",195,0)
 . s eval("labs",zi,"parms","DHPPROV")=DHPPROVIEN
"RTN","SYNFLAB",196,0)
 . d log(jlog,"Provider for outpatient is: #"_DHPPROVIEN_" "_DHPPROV)
"RTN","SYNFLAB",197,0)
 . ;
"RTN","SYNFLAB",198,0)
 . s DHPLOC=$$MAP^SYNQLDM("OP","location")
"RTN","SYNFLAB",199,0)
 . n DHPLOCIEN s DHPLOCIEN=$o(^SC("B",DHPLOC,""))
"RTN","SYNFLAB",200,0)
 . if DHPLOCIEN="" S DHPLOCIEN=4
"RTN","SYNFLAB",201,0)
 . s eval("labs",zi,"parms","DHPLOC")=DHPLOC
"RTN","SYNFLAB",202,0)
 . d log(jlog,"Location for outpatient is: #"_DHPLOCIEN_" "_DHPLOC)
"RTN","SYNFLAB",203,0)
 . ;
"RTN","SYNFLAB",204,0)
 . s eval("labs",zi,"status","loadstatus")="readyToLoad"
"RTN","SYNFLAB",205,0)
 . ;
"RTN","SYNFLAB",206,0)
 . if $g(args("load"))=1 d  ; only load if told to
"RTN","SYNFLAB",207,0)
 . . new (DHPPAT,DHPSCT,DHPOBS,DHPUNT,DHPDTM,DHPPROV,DHPLOC,DHPLOINC,DHPLAB,DUZ,DT,U,jlog,ien,zi,eval)
"RTN","SYNFLAB",208,0)
 . . if $g(ien)'="" if $$loadStatus("labs",zi,ien)=1 do  quit  ;
"RTN","SYNFLAB",209,0)
 . . . d log(jlog,"Lab already loaded, skipping")
"RTN","SYNFLAB",210,0)
 . . d log(jlog,"Calling LABADD^SYNDHP63 to add lab")
"RTN","SYNFLAB",211,0)
 . . ;LABADD(RETSTA,DHPPAT,DHPLOC,DHPTEST,DHPRSLT,DHPRSDT) ;Create lab test
"RTN","SYNFLAB",212,0)
 . . D LABADD^SYNDHP63(.RETSTA,DHPPAT,DHPLOC,DHPLAB,DHPOBS,DHPDTM,DHPLOINC)     ; labs update
"RTN","SYNFLAB",213,0)
 . . S ^ZZLABLOG(ien)=$G(RETSTA)
"RTN","SYNFLAB",214,0)
 . . d log(jlog,"Return from LABADD^SYNDHP63 was: "_$g(RETSTA))
"RTN","SYNFLAB",215,0)
 . . i $g(DEBUG)=1 ZWRITE RETSTA
"RTN","SYNFLAB",216,0)
 . . if +$g(RETSTA)=1 do  ;
"RTN","SYNFLAB",217,0)
 . . . s eval("status","loaded")=$g(eval("status","loaded"))+1
"RTN","SYNFLAB",218,0)
 . . . s eval("labs",zi,"status","loadstatus")="loaded"
"RTN","SYNFLAB",219,0)
 . . else  s eval("status","errors")=$g(eval("status","errors"))+1
"RTN","SYNFLAB",220,0)
 ;
"RTN","SYNFLAB",221,0)
 if $get(args("debug"))=1 do  ;
"RTN","SYNFLAB",222,0)
 . m jrslt("source")=json
"RTN","SYNFLAB",223,0)
 . m jrslt("args")=args
"RTN","SYNFLAB",224,0)
 . m jrslt("eval")=eval
"RTN","SYNFLAB",225,0)
 m jrslt("labsStatus")=eval("labsStatus")
"RTN","SYNFLAB",226,0)
 set jrslt("result","status")="ok"
"RTN","SYNFLAB",227,0)
 set jrslt("result","loaded")=$g(eval("status","loaded"))
"RTN","SYNFLAB",228,0)
 i $g(ien)'="" d  ; called internally
"RTN","SYNFLAB",229,0)
 . m result=eval
"RTN","SYNFLAB",230,0)
 . m result("status")=jrslt("result")
"RTN","SYNFLAB",231,0)
 . ;b
"RTN","SYNFLAB",232,0)
 e  d  ;
"RTN","SYNFLAB",233,0)
 . d ENCODE^VPRJSON("jrslt","result")
"RTN","SYNFLAB",234,0)
 . set HTTPRSP("mime")="application/json"
"RTN","SYNFLAB",235,0)
 q 1
"RTN","SYNFLAB",236,0)
 ;
"RTN","SYNFLAB",237,0)
log(ary,txt) ; adds a text line to @ary@("log")
"RTN","SYNFLAB",238,0)
 s @ary@("log",$o(@ary@("log",""),-1)+1)=$g(txt)
"RTN","SYNFLAB",239,0)
 w:$G(DEBUG) !,"      ",$G(txt)
"RTN","SYNFLAB",240,0)
 q
"RTN","SYNFLAB",241,0)
 ;
"RTN","SYNFLAB",242,0)
loadStatus(typ,zx,zien) ; extrinsic return 1 if resource was loaded
"RTN","SYNFLAB",243,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFLAB",244,0)
 n rt s rt=0
"RTN","SYNFLAB",245,0)
 i $g(zx)="" i $d(@root@(zien,"load",typ)) s rt=1 q rt
"RTN","SYNFLAB",246,0)
 i $get(@root@(zien,"load",typ,zx,"status","loadstatus"))="loaded" s rt=1
"RTN","SYNFLAB",247,0)
 q rt
"RTN","SYNFLAB",248,0)
loinc2sct(loinc) ; extrinsic returns a Snomed code for a Loinc code
"RTN","SYNFLAB",249,0)
 ; for labs
"RTN","SYNFLAB",250,0)
 ; thanks to Ferdi for the Snomed mapping
"RTN","SYNFLAB",251,0)
 ;
"RTN","SYNFLAB",252,0)
 ; here's what we got so far:
"RTN","SYNFLAB",253,0)
 ;^gpl("labs","29463-7","Body Weight")=""
"RTN","SYNFLAB",254,0)
 ;^gpl("labs","39156-5","Body Mass Index")="" ; oops
"RTN","SYNFLAB",255,0)
 ;^gpl("labs","55284-4","Blood Pressure")=""
"RTN","SYNFLAB",256,0)
 ;^gpl("labs","8302-2","Body Height")=""
"RTN","SYNFLAB",257,0)
 ;^gpl("labs","8331-1","Oral temperature")="" ;
"RTN","SYNFLAB",258,0)
 ;
"RTN","SYNFLAB",259,0)
 S SCTA("29463-7",27113001)="9^Body weight"
"RTN","SYNFLAB",260,0)
 S SCTA("8302-2",50373000)="8^Body height"
"RTN","SYNFLAB",261,0)
 S SCTA("55284-4",75367002)="1^Blood pressure"
"RTN","SYNFLAB",262,0)
 S SCTA(78564009)="5^Pulse rate"
"RTN","SYNFLAB",263,0)
 S SCTA("8331-1",386725007)="2^Body Temperature"
"RTN","SYNFLAB",264,0)
 S SCTA(86290005)="3^Respiration"
"RTN","SYNFLAB",265,0)
 S SCTA(48094003)="10^Abdominal girth measurement"
"RTN","SYNFLAB",266,0)
 S SCTA(21727005)="11^Audiometry"
"RTN","SYNFLAB",267,0)
 S SCTA(252465000)="21^Pulse oximetry"
"RTN","SYNFLAB",268,0)
 S SCTA(22253000)="22^Pain"
"RTN","SYNFLAB",269,0)
 ;
"RTN","SYNFLAB",270,0)
 q $o(SCTA(loinc,""))
"RTN","SYNFLAB",271,0)
 ;
"RTN","SYNFLAB",272,0)
testall ; run the labs import on all imported patients
"RTN","SYNFLAB",273,0)
 new root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFLAB",274,0)
 new indx s indx=$na(@root@("POS","DFN"))
"RTN","SYNFLAB",275,0)
 n dfn,ien,filter,reslt
"RTN","SYNFLAB",276,0)
 s dfn=0
"RTN","SYNFLAB",277,0)
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  d  ;
"RTN","SYNFLAB",278,0)
 . s ien=$o(@indx@(dfn,""))
"RTN","SYNFLAB",279,0)
 . q:ien=""
"RTN","SYNFLAB",280,0)
 . s filter("dfn")=dfn
"RTN","SYNFLAB",281,0)
 . k reslt
"RTN","SYNFLAB",282,0)
 . d wsIntakeLabs(.filter,,.reslt,ien)
"RTN","SYNFLAB",283,0)
 q
"RTN","SYNFLAB",284,0)
 ;
"RTN","SYNFLAB",285,0)
labsum ; summary of lab tests for patient ien pien
"RTN","SYNFLAB",286,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFLAB",287,0)
 n table
"RTN","SYNFLAB",288,0)
 n zzi s zzi=0
"RTN","SYNFLAB",289,0)
 f  s zzi=$o(@root@(zzi)) q:+zzi=0  d  ;
"RTN","SYNFLAB",290,0)
 . n labs
"RTN","SYNFLAB",291,0)
 . d getIntakeFhir^SYNFHIR("labs",,"Observation",zzi,1)
"RTN","SYNFLAB",292,0)
 . n zi s zi=0
"RTN","SYNFLAB",293,0)
 . f  s zi=$o(labs("entry",zi)) q:+zi=0  d  ;
"RTN","SYNFLAB",294,0)
 . . n groot s groot=$na(labs("entry",zi,"resource"))
"RTN","SYNFLAB",295,0)
 . . i $g(@groot@("category",1,"coding",1,"code"))'="laboratory" q  ;
"RTN","SYNFLAB",296,0)
 . . n loinc
"RTN","SYNFLAB",297,0)
 . . s loinc=$g(@groot@("code","coding",1,"code"))
"RTN","SYNFLAB",298,0)
 . . q:loinc=""
"RTN","SYNFLAB",299,0)
 . . ;i loinc="6082-2" b  ;
"RTN","SYNFLAB",300,0)
 . . n text s text=$g(@groot@("code","coding",1,"display"))
"RTN","SYNFLAB",301,0)
 . . i $d(table(loinc_" "_text)) d  ;
"RTN","SYNFLAB",302,0)
 . . . s table(loinc_" "_text)=table(loinc_" "_text)+1
"RTN","SYNFLAB",303,0)
 . . e  d  ;
"RTN","SYNFLAB",304,0)
 . . . s table(loinc_" "_text)=1
"RTN","SYNFLAB",305,0)
 . . . w !,"patient= "_zzi_" entry= "_zi,!
"RTN","SYNFLAB",306,0)
 . . . n rptary m rptary=@root@(zzi,"json","entry",zi,"resource")
"RTN","SYNFLAB",307,0)
 . . . zwrite rptary
"RTN","SYNFLAB",308,0)
 zwrite table
"RTN","SYNFLAB",309,0)
 q
"RTN","SYNFLAB",310,0)
 ;
"RTN","SYNFMED")
0^32^B217888743
"RTN","SYNFMED",1,0)
SYNFMED ;OSE/SMH - Add Medications to Patient Record;Dec 24, 2018@21:29
"RTN","SYNFMED",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNFMED",3,0)
 ; (C) 2018 Sam Habiel
"RTN","SYNFMED",4,0)
 ; See accompanying license for terms of use.
"RTN","SYNFMED",5,0)
 ;
"RTN","SYNFMED",6,0)
 ; TODO list
"RTN","SYNFMED",7,0)
 ; - Implement Web Services lookup
"RTN","SYNFMED",8,0)
 ; - See if you can add old meds (not on market) to VistA as patient drugs
"RTN","SYNFMED",9,0)
 ;
"RTN","SYNFMED",10,0)
RXN2MEDS(RXN) ; [Public] Get Drugs that are associated with an RxNorm
"RTN","SYNFMED",11,0)
 Q $$MATCHVM($$RXN2VUI(RXN))
"RTN","SYNFMED",12,0)
 ;
"RTN","SYNFMED",13,0)
RXN2VUI(RXN) ; [Public] Get ^ delimited VUIDs for an RxNorm
"RTN","SYNFMED",14,0)
 N VUIDS S VUIDS=""
"RTN","SYNFMED",15,0)
 n file
"RTN","SYNFMED",16,0)
 I $T(^ETSRXN)]"" d  quit VUIDS
"RTN","SYNFMED",17,0)
 . n fileVUIDs s fileVUIDs=$$ETSRXN2VUID(RXN)
"RTN","SYNFMED",18,0)
 . n i f i=1:1:$l(fileVUIDs,U) do
"RTN","SYNFMED",19,0)
 .. n fileVUID s fileVUID=$p(fileVUIDs,U,i)
"RTN","SYNFMED",20,0)
 .. s file=$p(fileVUID,"~")
"RTN","SYNFMED",21,0)
 .. i file'=50.68 quit
"RTN","SYNFMED",22,0)
 .. n vuid s vuid=$p(fileVUID,"~",2)
"RTN","SYNFMED",23,0)
 .. s VUIDS=VUIDS_vuid_U
"RTN","SYNFMED",24,0)
 . i $e(VUIDS,$l(VUIDS))=U S $E(VUIDS,$L(VUIDS))=""
"RTN","SYNFMED",25,0)
 ;
"RTN","SYNFMED",26,0)
 ; TODO: Rest is not implemented yet.
"RTN","SYNFMED",27,0)
 N URL S URL="https://urldefense.proofpoint.com/v2/url?u=https-3A__rxnav.nlm.nih.gov_REST_rxcui_-257BRXN-257D_property.json-3FpropName-3DVUID&d=DwIGAg&c=YC-d702opsuYKpiO2Bmlzg&r=eB2byuHqGYSl6WZ7RDYf1bvstA3WGqBWtfGBHGmVhGo&m=kwStjQ92-x-nfHapaaCBIrLM6PmehOLCy6kLF0XM-YI&s=Rg5ZS13K894gfUhNZGWW-e83KvJXkNH2fiuLKNh5A_c&e="
"RTN","SYNFMED",28,0)
 N % S %("{RXN}")=RXN
"RTN","SYNFMED",29,0)
 S URL=$$REPLACE^XLFSTR(URL,.%)
"RTN","SYNFMED",30,0)
 N C0CRETURN
"RTN","SYNFMED",31,0)
 D GET(.C0CRETURN,URL)
"RTN","SYNFMED",32,0)
 N C0COUT
"RTN","SYNFMED",33,0)
 D DECODE^XLFJSON($NA(C0CRETURN),$NA(C0COUT))
"RTN","SYNFMED",34,0)
 N J F J=0:0 S J=$O(C0COUT("propConceptGroup","propConcept",J)) Q:'J  D
"RTN","SYNFMED",35,0)
 . S VUIDS=VUIDS_C0COUT("propConceptGroup","propConcept",J,"propValue")_U
"RTN","SYNFMED",36,0)
 S $E(VUIDS,$L(VUIDS))="" ; rm trailing ^
"RTN","SYNFMED",37,0)
 QUIT VUIDS
"RTN","SYNFMED",38,0)
 ;
"RTN","SYNFMED",39,0)
RXN2NDC(RXN) ; [Public] Get ^ delimited NDCs for an RxNorm SCD
"RTN","SYNFMED",40,0)
 I $T(^ETSRXN)]"" Q $$ETSRXN2NDC(RXN)
"RTN","SYNFMED",41,0)
 ; TODO: Implement web service
"RTN","SYNFMED",42,0)
 QUIT
"RTN","SYNFMED",43,0)
 ;
"RTN","SYNFMED",44,0)
ETSRXN2VUID(RXN) ; [Private] Return delimited list of file~VUID^file~VUID based on ETS
"RTN","SYNFMED",45,0)
 ; Input: RxNorm Number for IN or CD TTY
"RTN","SYNFMED",46,0)
 ; Output: file~VUID~name^file~VUID~name..., where file is 50.6 or 50.68.
"RTN","SYNFMED",47,0)
 ;         or -1^vuid-not-found
"RTN","SYNFMED",48,0)
 ;
"RTN","SYNFMED",49,0)
 ; Translate RXN to VUID
"RTN","SYNFMED",50,0)
 new numVUID set numVUID=+$$RXN2OUT^ETSRXN(RXN)
"RTN","SYNFMED",51,0)
 if 'numVUID quit:$quit "-1^vuid-not-found" quit
"RTN","SYNFMED",52,0)
 ;
"RTN","SYNFMED",53,0)
 ; loop through VUIDs, and grab a good one (CD or IN)
"RTN","SYNFMED",54,0)
 ; ^TMP("ETSOUT",69531,831533,"VUID",1,0)="296833^831533^VANDF^AB^4031994^N"
"RTN","SYNFMED",55,0)
 ; ^TMP("ETSOUT",69531,831533,"VUID",1,1)="ERRIN 0.35MG TAB,28"
"RTN","SYNFMED",56,0)
 new done s done=0
"RTN","SYNFMED",57,0)
 new out set out=""
"RTN","SYNFMED",58,0)
 new vuid,name
"RTN","SYNFMED",59,0)
 new type,file
"RTN","SYNFMED",60,0)
 new i for i=0:0 set i=$o(^TMP("ETSOUT",$J,RXN,"VUID",i)) quit:'i  do  quit:done
"RTN","SYNFMED",61,0)
 . new node0 set node0=^TMP("ETSOUT",$J,RXN,"VUID",i,0)
"RTN","SYNFMED",62,0)
 . new node1 set node1=^TMP("ETSOUT",$J,RXN,"VUID",i,1)
"RTN","SYNFMED",63,0)
 . set type=$p(node0,U,4)
"RTN","SYNFMED",64,0)
 . if type'["CD"&(type'["IN") quit
"RTN","SYNFMED",65,0)
 . ;
"RTN","SYNFMED",66,0)
 . set vuid=$p(node0,U,5)
"RTN","SYNFMED",67,0)
 . set file=$s(type["CD":50.68,type["IN":50.6,1:1/0) ; any other type is invalid!
"RTN","SYNFMED",68,0)
 . set name=node1
"RTN","SYNFMED",69,0)
 . set out=out_file_"~"_vuid_"~"_name_U
"RTN","SYNFMED",70,0)
 if $extract(out,$length(out))=U set $extract(out,$length(out))=""
"RTN","SYNFMED",71,0)
 K ^TMP("ETSOUT",$J)
"RTN","SYNFMED",72,0)
 quit out
"RTN","SYNFMED",73,0)
 ;
"RTN","SYNFMED",74,0)
ETSRXN2NDC(RXN) ; [Private] Return delimited list of NDCs from RxNorm (only active ones)
"RTN","SYNFMED",75,0)
 ; Translate RXN to VUID
"RTN","SYNFMED",76,0)
 new numNDC set numNDC=$P($$RXN2OUT^ETSRXN(RXN),U,2)
"RTN","SYNFMED",77,0)
 if 'numNDC quit:$quit "" quit
"RTN","SYNFMED",78,0)
 ;
"RTN","SYNFMED",79,0)
 ; loop through NDCs, and grab good ones
"RTN","SYNFMED",80,0)
 ; ^TMP("ETSOUT",2199,831533,"NDC")=6
"RTN","SYNFMED",81,0)
 ; ^TMP("ETSOUT",2199,831533,"NDC",1,0)="600680^831533^831533^RXNORM^N"
"RTN","SYNFMED",82,0)
 ; ^TMP("ETSOUT",2199,831533,"NDC",1,1)="NDC"
"RTN","SYNFMED",83,0)
 ; ^TMP("ETSOUT",2199,831533,"NDC",1,2)="00555034458"
"RTN","SYNFMED",84,0)
 ; ^TMP("ETSOUT",2199,831533,"NDC",2,0)="600681^831533^831533^RXNORM^N"
"RTN","SYNFMED",85,0)
 ; ^TMP("ETSOUT",2199,831533,"NDC",2,1)="NDC"
"RTN","SYNFMED",86,0)
 ; ^TMP("ETSOUT",2199,831533,"NDC",2,2)="00555034479"
"RTN","SYNFMED",87,0)
 new out set out=""
"RTN","SYNFMED",88,0)
 new type,supp
"RTN","SYNFMED",89,0)
 new i for i=0:0 set i=$o(^TMP("ETSOUT",$J,RXN,"NDC",i)) quit:'i  do
"RTN","SYNFMED",90,0)
 . new node0 set node0=^TMP("ETSOUT",$J,RXN,"NDC",i,0)
"RTN","SYNFMED",91,0)
 . new ndc set ndc=^TMP("ETSOUT",$J,RXN,"NDC",i,2)
"RTN","SYNFMED",92,0)
 . set type=$p(node0,U,4)
"RTN","SYNFMED",93,0)
 . set supp=$p(node0,U,5)
"RTN","SYNFMED",94,0)
 . ;
"RTN","SYNFMED",95,0)
 . ; We want RxNorm NDCs that are not suppressed.
"RTN","SYNFMED",96,0)
 . i type'="RXNORM" quit
"RTN","SYNFMED",97,0)
 . i supp'="N" quit
"RTN","SYNFMED",98,0)
 . ;
"RTN","SYNFMED",99,0)
 . set out=out_ndc_U
"RTN","SYNFMED",100,0)
 if $extract(out,$length(out))=U set $extract(out,$length(out))=""
"RTN","SYNFMED",101,0)
 K ^TMP("ETSOUT",$J)
"RTN","SYNFMED",102,0)
 quit out
"RTN","SYNFMED",103,0)
 ;
"RTN","SYNFMED",104,0)
RXNCONV(RXN) ; [Private] Convert RxNorm CUI for non SCD to SCD drug
"RTN","SYNFMED",105,0)
 N FIXED S FIXED=$$RXNBAD(RXN)
"RTN","SYNFMED",106,0)
 I FIXED Q FIXED
"RTN","SYNFMED",107,0)
 ;
"RTN","SYNFMED",108,0)
 I $T(^ETSRXN)]"" Q $$ETSCONV(RXN)
"RTN","SYNFMED",109,0)
 S $EC=",U-UNIMPLEMENTED,"
"RTN","SYNFMED",110,0)
 ;
"RTN","SYNFMED",111,0)
RXNBAD(RXN) ; [Private] Synthea Bad RxNorm Codes Translation
"RTN","SYNFMED",112,0)
 N RXNBADDATA
"RTN","SYNFMED",113,0)
 N I,T F I=1:1 S T=$P($T(RXNBADDATA+I),";;",2) Q:T=""  S RXNBADDATA($P(T,";",1))=$P(T,";",2)
"RTN","SYNFMED",114,0)
 I $D(RXNBADDATA(RXN)) Q RXNBADDATA(RXN)
"RTN","SYNFMED",115,0)
 Q ""
"RTN","SYNFMED",116,0)
 ;
"RTN","SYNFMED",117,0)
RXNBADDATA ;;
"RTN","SYNFMED",118,0)
 ;;239981;477045
"RTN","SYNFMED",119,0)
 ;;389128;1363309
"RTN","SYNFMED",120,0)
 ;;--;--
"RTN","SYNFMED",121,0)
 ;;308056;1804799
"RTN","SYNFMED",122,0)
 ;;727374;1660014
"RTN","SYNFMED",123,0)
 ;;--;--
"RTN","SYNFMED",124,0)
 ;;564666;705129
"RTN","SYNFMED",125,0)
 ;;568530;311989
"RTN","SYNFMED",126,0)
 ;;573839;197319
"RTN","SYNFMED",127,0)
 ;;575020;105586
"RTN","SYNFMED",128,0)
 ;;575971;1736776
"RTN","SYNFMED",129,0)
 ;;596927;596926
"RTN","SYNFMED",130,0)
 ;;602735;310436
"RTN","SYNFMED",131,0)
 ;;607015;483438
"RTN","SYNFMED",132,0)
 ;;608680;313782
"RTN","SYNFMED",133,0)
 ;;617944;608139
"RTN","SYNFMED",134,0)
 ;;824184;562251
"RTN","SYNFMED",135,0)
 ;;849437;198014
"RTN","SYNFMED",136,0)
 ;;849727;849574
"RTN","SYNFMED",137,0)
 ;;896188;896209
"RTN","SYNFMED",138,0)
 ;;904420;904419
"RTN","SYNFMED",139,0)
 ;;996741;996740
"RTN","SYNFMED",140,0)
 ;;997221;997223
"RTN","SYNFMED",141,0)
 ;;1049544;1860154
"RTN","SYNFMED",142,0)
 ;;1049639;1049221
"RTN","SYNFMED",143,0)
 ;;1091166;1091392
"RTN","SYNFMED",144,0)
 ;;1094108;1094107
"RTN","SYNFMED",145,0)
 ;;1602593;1599803
"RTN","SYNFMED",146,0)
 ;;1648767;311995
"RTN","SYNFMED",147,0)
 ;;--;--
"RTN","SYNFMED",148,0)
 ;;392151;308182
"RTN","SYNFMED",149,0)
 ;;646250;389221
"RTN","SYNFMED",150,0)
 ;;727316;1870230
"RTN","SYNFMED",151,0)
 ;;834060;834061
"RTN","SYNFMED",152,0)
 ;;834101;834102
"RTN","SYNFMED",153,0)
 ;;1000128;1000126
"RTN","SYNFMED",154,0)
 ;;1000158;1000156
"RTN","SYNFMED",155,0)
 ;;1020137;1043400
"RTN","SYNFMED",156,0)
 ;;1111011;389221
"RTN","SYNFMED",157,0)
 ;;1366342;1366343
"RTN","SYNFMED",158,0)
 ;;1536586;1534809
"RTN","SYNFMED",159,0)
 ;;1803932;311282
"RTN","SYNFMED",160,0)
 ;;
"RTN","SYNFMED",161,0)
ETSCONV(RXN) ; [Private] Convert RxNorm CUI for non SCD to SCD drug using ETS
"RTN","SYNFMED",162,0)
 N SUC S SUC=$$GETDATA^ETSRXN(RXN)
"RTN","SYNFMED",163,0)
 I 'SUC Q "0^drug does not exist in RxNorm"
"RTN","SYNFMED",164,0)
 ;
"RTN","SYNFMED",165,0)
 ; Is this a semantic clinical drug? If so, just quit, returning this drug.
"RTN","SYNFMED",166,0)
 N SCD S SCD=$$ETSISSCD(RXN)
"RTN","SYNFMED",167,0)
 I SCD Q RXN
"RTN","SYNFMED",168,0)
 ;
"RTN","SYNFMED",169,0)
 ; Okay it isn't an SCD. Now we need to find out what type it is.
"RTN","SYNFMED",170,0)
 N TYPE S TYPE=$$ETSTYPE(RXN)
"RTN","SYNFMED",171,0)
 ;
"RTN","SYNFMED",172,0)
 ; Now convert the type (SBDC, SBD, SCDC to SCD)
"RTN","SYNFMED",173,0)
 ; zwrite ^TMP("ETSDATA",$J,RXN,*)
"RTN","SYNFMED",174,0)
 I TYPE="SBDC" S SCD=$$ETSCONVSBDC(RXN)
"RTN","SYNFMED",175,0)
 I TYPE="SCDC" S SCD=$$ETSCONVSCDC(RXN)
"RTN","SYNFMED",176,0)
 I TYPE="SBD"!(TYPE="BPCK") D
"RTN","SYNFMED",177,0)
 . N VUID S VUID=$$RXN2VUI(RXN)
"RTN","SYNFMED",178,0)
 . I VUID S SCD=RXN
"RTN","SYNFMED",179,0)
 . E  S SCD=$$ETSCONVSBD(RXN)
"RTN","SYNFMED",180,0)
 ;
"RTN","SYNFMED",181,0)
 ; Must have an SCD at this point
"RTN","SYNFMED",182,0)
 I 'SCD Q "0^Please send a message for Sam to investigate"
"RTN","SYNFMED",183,0)
 ;
"RTN","SYNFMED",184,0)
 QUIT SCD
"RTN","SYNFMED",185,0)
 ;
"RTN","SYNFMED",186,0)
ETSISSCD(RXN) ; [Private] Is RXN an SCD?
"RTN","SYNFMED",187,0)
 N RESULT S RESULT=0
"RTN","SYNFMED",188,0)
 N I,Z F I=0:0 S I=$O(^TMP("ETSDATA",$J,RXN,"RXCONSO",I)) Q:'I  S Z=^(I,0) D  Q:RESULT
"RTN","SYNFMED",189,0)
 . I $P(Z,U,4)="SCD" S RESULT=1
"RTN","SYNFMED",190,0)
 Q RESULT
"RTN","SYNFMED",191,0)
 ;
"RTN","SYNFMED",192,0)
ETSISBPCK(RXN) ; [Private] Is RXN a BPCK?
"RTN","SYNFMED",193,0)
 N RESULT S RESULT=0
"RTN","SYNFMED",194,0)
 N I,Z F I=0:0 S I=$O(^TMP("ETSDATA",$J,RXN,"RXCONSO",I)) Q:'I  S Z=^(I,0) D  Q:RESULT
"RTN","SYNFMED",195,0)
 . I $P(Z,U,4)="BPCK" S RESULT=1
"RTN","SYNFMED",196,0)
 Q RESULT
"RTN","SYNFMED",197,0)
 ;
"RTN","SYNFMED",198,0)
ETSTYPE(RXN) ; [Private] What's the type of this RXN? (called only when not SCD)
"RTN","SYNFMED",199,0)
 N RESULT S RESULT=""
"RTN","SYNFMED",200,0)
 N I,Z F I=0:0 S I=$O(^TMP("ETSDATA",$J,RXN,"RXCONSO",I)) Q:'I  S Z=^(I,0) D  Q:RESULT]""
"RTN","SYNFMED",201,0)
 . I $P(Z,U,3)="RXNORM" D
"RTN","SYNFMED",202,0)
 .. N TYPE S TYPE=$P(Z,U,4)
"RTN","SYNFMED",203,0)
 .. I TYPE="BPCK" S RESULT=TYPE
"RTN","SYNFMED",204,0)
 .. I TYPE="SBDC" S RESULT=TYPE
"RTN","SYNFMED",205,0)
 .. I TYPE="SBD"  S RESULT=TYPE
"RTN","SYNFMED",206,0)
 .. I TYPE="SCDC" S RESULT=TYPE
"RTN","SYNFMED",207,0)
 .. I TYPE="SCD"  S RESULT=TYPE
"RTN","SYNFMED",208,0)
 I "^SBDC^SBD^SCDC^"'[U_RESULT_U S $EC=",U-UNANTICIPATED-RXN-TYPE,"
"RTN","SYNFMED",209,0)
 Q RESULT
"RTN","SYNFMED",210,0)
 ;
"RTN","SYNFMED",211,0)
 ; For the below, everything looks sorta like this.
"RTN","SYNFMED",212,0)
 ; ^TMP("ETSDATA",1356,1111011,"RXNREL",1,0)="958970^1111011^RB^389221^has_tradename^RXNORM^^4096"
"RTN","SYNFMED",213,0)
 ; The 4096 we check for means the drug is currently prescribable. This prevents us from reaching
"RTN","SYNFMED",214,0)
 ; dead ends where the realtionship leads us to a drug not the market and thus may not be a drug
"RTN","SYNFMED",215,0)
 ; we can write for in VistA.
"RTN","SYNFMED",216,0)
 ;
"RTN","SYNFMED",217,0)
ETSCONVSBDC(RXN) ; [Private] Convert RxnCUI SBDC -> SCD
"RTN","SYNFMED",218,0)
 ; Convert to SCDC first and then to SCD
"RTN","SYNFMED",219,0)
 N RESULT S RESULT=0
"RTN","SYNFMED",220,0)
 N I,Z F I=0:0 S I=$O(^TMP("ETSDATA",$J,RXN,"RXNREL",I)) Q:'I  S Z=^(I,0) D  Q:RESULT
"RTN","SYNFMED",221,0)
 . I $P(Z,U,5)="consists_of",$P(Z,U,8)=4096 S RESULT=$P(Z,U,4)
"RTN","SYNFMED",222,0)
 N % S %=$$GETDATA^ETSRXN(RESULT) ; **WARNING: CONTEXT CHANGE**
"RTN","SYNFMED",223,0)
 Q $$ETSCONVSBD(RESULT)
"RTN","SYNFMED",224,0)
 ;
"RTN","SYNFMED",225,0)
ETSCONVSBD(RXN)  ; [Private] Convert RxnCUI SBD -> SCD
"RTN","SYNFMED",226,0)
 N RESULT S RESULT=0
"RTN","SYNFMED",227,0)
 N I,Z F I=0:0 S I=$O(^TMP("ETSDATA",$J,RXN,"RXNREL",I)) Q:'I  S Z=^(I,0) D  Q:RESULT
"RTN","SYNFMED",228,0)
 . I $P(Z,U,5)="has_tradename",$P(Z,U,8)=4096 S RESULT=$P(Z,U,4)
"RTN","SYNFMED",229,0)
 Q RESULT
"RTN","SYNFMED",230,0)
 ;
"RTN","SYNFMED",231,0)
ETSCONVSCDC(RXN) ; [Private] Convert RxnCUI SCDC -> SCD
"RTN","SYNFMED",232,0)
 N RESULT S RESULT=0
"RTN","SYNFMED",233,0)
 N I,Z F I=0:0 S I=$O(^TMP("ETSDATA",$J,RXN,"RXNREL",I)) Q:'I  S Z=^(I,0) D  Q:RESULT
"RTN","SYNFMED",234,0)
 . I $P(Z,U,5)="consists_of",$P(Z,U,8)=4096 S RESULT=$P(Z,U,4)
"RTN","SYNFMED",235,0)
 Q RESULT
"RTN","SYNFMED",236,0)
 ;
"RTN","SYNFMED",237,0)
MATCHVM(VUIDS) ; [Public] Match delimited list of VUIDs to delimited set of drugs (not one to one)
"RTN","SYNFMED",238,0)
 N MATCHES S MATCHES=""
"RTN","SYNFMED",239,0)
 N I,VUID
"RTN","SYNFMED",240,0)
 F I=1:1 S VUID=$P(VUIDS,U,I) Q:VUID=""  D
"RTN","SYNFMED",241,0)
 . N MATCH S MATCH=$$MATCHV1(VUID)
"RTN","SYNFMED",242,0)
 . I MATCH S MATCHES=MATCHES_MATCH_U
"RTN","SYNFMED",243,0)
 S $E(MATCHES,$L(MATCHES))="" ; rm trailing ^
"RTN","SYNFMED",244,0)
 QUIT MATCHES
"RTN","SYNFMED",245,0)
 ;
"RTN","SYNFMED",246,0)
 ;
"RTN","SYNFMED",247,0)
MATCHV1(VUID) ; [Public] Match a single VUID to a set of drugs.
"RTN","SYNFMED",248,0)
 N VAP S VAP=$$VUI2VAP(VUID) ; says it's supposed to be plural, but that's not possible??
"RTN","SYNFMED",249,0)
 I 'VAP S $EC=",U-VUID-SHOULD-NOT-BE-MISSING,"
"RTN","SYNFMED",250,0)
 N MEDS S MEDS=$$VAP2MED(VAP)
"RTN","SYNFMED",251,0)
 QUIT MEDS
"RTN","SYNFMED",252,0)
 ;
"RTN","SYNFMED",253,0)
VUI2VAP(VUID) ; $$ Public - Get VA Product IEN(s) from VUID
"RTN","SYNFMED",254,0)
 ; Input VUID by Value
"RTN","SYNFMED",255,0)
 ; Output: Extrinsic
"RTN","SYNFMED",256,0)
 D FIND^DIC(50.68,,"@","QP",VUID,,"AVUID") ; Find all in VUID index
"RTN","SYNFMED",257,0)
 N O S O="" ; Output
"RTN","SYNFMED",258,0)
 N I F I=0:0 S I=$O(^TMP("DILIST",$J,I)) Q:'I  S O=O_^(I,0)_U ; Concat results together
"RTN","SYNFMED",259,0)
 S O=$E(O,1,$L(O)-1) ; remove trailing ^
"RTN","SYNFMED",260,0)
 Q O
"RTN","SYNFMED",261,0)
 ;
"RTN","SYNFMED",262,0)
VAP2MED(VAPROD) ; $$ Public - Get Drug(s) using VA Product IEN
"RTN","SYNFMED",263,0)
 ; Un-Unit-testable: Drug files differ between sites.
"RTN","SYNFMED",264,0)
 ; Input: VA Product IEN By Value
"RTN","SYNFMED",265,0)
 ; OUtput: Caret delimited extrinsic
"RTN","SYNFMED",266,0)
 ; This code inspired from PSNAPIs
"RTN","SYNFMED",267,0)
 ; WHY THE HELL WOULD I USE A TEXT INDEX?
"RTN","SYNFMED",268,0)
 ; It's my only option. Creating new xrefs on the drug file doesn't help
"RTN","SYNFMED",269,0)
 ; as they are not filled out when adding a drug (IX[ALL]^DIK isn't called).
"RTN","SYNFMED",270,0)
 N MEDS S MEDS="" ; result
"RTN","SYNFMED",271,0)
 N PN,PN1 ; Product Name, abbreviated product name.
"RTN","SYNFMED",272,0)
 S PN=$P(^PSNDF(50.68,VAPROD,0),"^"),PN1=$E(PN,1,30)
"RTN","SYNFMED",273,0)
 N P50 S P50=0 ; looper through VAPN index which is DRUG file entry
"RTN","SYNFMED",274,0)
 F  S P50=$O(^PSDRUG("VAPN",PN1,P50)) Q:'P50  D  ; for each text match
"RTN","SYNFMED",275,0)
 . I $P(^PSDRUG(P50,"ND"),"^",3)=VAPROD S MEDS=$G(MEDS)_P50_U  ; check that the VA PRODUCT pointer is the same as ours.
"RTN","SYNFMED",276,0)
 S:MEDS MEDS=$E(MEDS,1,$L(MEDS)-1) ; remove trailing ^
"RTN","SYNFMED",277,0)
 Q MEDS
"RTN","SYNFMED",278,0)
 ;
"RTN","SYNFMED",279,0)
ADDDRUG(RXN,BARCODE) ; [Public] Add Drug to Drug File
"RTN","SYNFMED",280,0)
 ; Input: RXN - RxNorm Semantic Clinical Drug CUI by Value. Required.
"RTN","SYNFMED",281,0)
 ; Input: BARCODE - Wand Barcode. Optional. Pass exactly as wand reads minus control characters.
"RTN","SYNFMED",282,0)
 ; Output: Internal Entry Number
"RTN","SYNFMED",283,0)
 ;
"RTN","SYNFMED",284,0)
 ; Get first VUID for this RxNorm drug
"RTN","SYNFMED",285,0)
 N VUID S VUID=+$$RXN2VUI(RXN)
"RTN","SYNFMED",286,0)
 Q:'VUID ""
"RTN","SYNFMED",287,0)
 G NEXT
"RTN","SYNFMED",288,0)
ADDDRUG2(RXN,VUID) ;
"RTN","SYNFMED",289,0)
 ; ZEXCEPT: NDC,BARCODE
"RTN","SYNFMED",290,0)
NEXT ;
"RTN","SYNFMED",291,0)
 N PSSZ S PSSZ=1    ; Needed for the drug file to let me in!
"RTN","SYNFMED",292,0)
 ;
"RTN","SYNFMED",293,0)
 ; W "(debug) VUID for RxNorm CUI "_RXN_" is "_VUID,!
"RTN","SYNFMED",294,0)
 ;
"RTN","SYNFMED",295,0)
 ; IEN in 50.68
"RTN","SYNFMED",296,0)
 N C0XVUID ; For Searching Compound Index
"RTN","SYNFMED",297,0)
 S C0XVUID(1)=VUID
"RTN","SYNFMED",298,0)
 S C0XVUID(2)=1
"RTN","SYNFMED",299,0)
 N F5068IEN S F5068IEN=$$FIND1^DIC(50.68,"","XQ",.C0XVUID,"AMASTERVUID")
"RTN","SYNFMED",300,0)
 Q:'F5068IEN ""
"RTN","SYNFMED",301,0)
 ;
"RTN","SYNFMED",302,0)
 ; W "F 50.68 IEN (debug): "_F5068IEN,!
"RTN","SYNFMED",303,0)
 ;
"RTN","SYNFMED",304,0)
 ; Guard against adding the drug back in again.
"RTN","SYNFMED",305,0)
 N EXISTING S EXISTING=$$VAP2MED(F5068IEN)
"RTN","SYNFMED",306,0)
 I EXISTING Q EXISTING
"RTN","SYNFMED",307,0)
 ;
"RTN","SYNFMED",308,0)
 ; FDA Array
"RTN","SYNFMED",309,0)
 N C0XFDA
"RTN","SYNFMED",310,0)
 ;
"RTN","SYNFMED",311,0)
 ; Name, shortened
"RTN","SYNFMED",312,0)
 S C0XFDA(50,"+1,",.01)=$E($$GET1^DIQ(50.68,F5068IEN,.01),1,40)
"RTN","SYNFMED",313,0)
 ;
"RTN","SYNFMED",314,0)
 ; File BarCode as a Synonym for BCMA
"RTN","SYNFMED",315,0)
 I $L($G(BARCODE)) D
"RTN","SYNFMED",316,0)
 . S C0XFDA(50.1,"+2,+1,",.01)=BARCODE
"RTN","SYNFMED",317,0)
 . S C0XFDA(50.1,"+2,+1,",1)="Q"
"RTN","SYNFMED",318,0)
 ;
"RTN","SYNFMED",319,0)
 N NDCS S NDCS=$$RXN2NDC^SYNFMED(RXN)
"RTN","SYNFMED",320,0)
 N NDC S NDC=$P(NDCS,U,1)
"RTN","SYNFMED",321,0)
 ;
"RTN","SYNFMED",322,0)
 ; NDC field
"RTN","SYNFMED",323,0)
 I NDC S C0XFDA(50,"+1,",31)=$E(NDC,1,5)_"-"_$E(NDC,6,9)_"-"_$E(NDC,10,11)
"RTN","SYNFMED",324,0)
 ;
"RTN","SYNFMED",325,0)
 ; NDCs to synonyms
"RTN","SYNFMED",326,0)
 I NDCS]"" N C0XI F C0XI=1:1:$L(NDCS,U) D
"RTN","SYNFMED",327,0)
 . S NDC=$P(NDCS,U,C0XI)
"RTN","SYNFMED",328,0)
 . S C0XFDA(50.1,"+"_(C0XI+10)_",+1,",.01)=NDC
"RTN","SYNFMED",329,0)
 . S C0XFDA(50.1,"+"_(C0XI+10)_",+1,",1)="Q"
"RTN","SYNFMED",330,0)
 . S C0XFDA(50.1,"+"_(C0XI+10)_",+1,",2)=NDC
"RTN","SYNFMED",331,0)
 ;
"RTN","SYNFMED",332,0)
 ; Brand Names & NDCs
"RTN","SYNFMED",333,0)
 ; N NDCS
"RTN","SYNFMED",334,0)
 ; N URL S URL="https://urldefense.proofpoint.com/v2/url?u=https-3A__rxnav.nlm.nih.gov_REST_rxcui_-257BRXN-257D_ndcs.json&d=DwIGAg&c=YC-d702opsuYKpiO2Bmlzg&r=eB2byuHqGYSl6WZ7RDYf1bvstA3WGqBWtfGBHGmVhGo&m=kwStjQ92-x-nfHapaaCBIrLM6PmehOLCy6kLF0XM-YI&s=XbfMHATQu-t2zuLynioJexSigqQkZXXUr9zDjGooMII&e="
"RTN","SYNFMED",335,0)
 ; N % S %("{RXN}")=RXN
"RTN","SYNFMED",336,0)
 ; S URL=$$REPLACE^XLFSTR(URL,.%)
"RTN","SYNFMED",337,0)
 ; N C0CRETURN
"RTN","SYNFMED",338,0)
 ; D GET(.C0CRETURN,URL)
"RTN","SYNFMED",339,0)
 ; N C0COUT
"RTN","SYNFMED",340,0)
 ; D DECODE^XLFJSON($NA(C0CRETURN),$NA(C0COUT))
"RTN","SYNFMED",341,0)
 ; ZWRITE C0COUT
"RTN","SYNFMED",342,0)
 ; QUIT
"RTN","SYNFMED",343,0)
 ; ;
"RTN","SYNFMED",344,0)
 ; N BNS S BNS="" ; S BNS=$$RXN2BNS^C0CRXNLK(RXN) ; Brands
"RTN","SYNFMED",345,0)
 ; I $L(BNS) N I F I=1:1:$L(BNS,U) D
"RTN","SYNFMED",346,0)
 ; . N IENS S IENS=I+2
"RTN","SYNFMED",347,0)
 ; . S C0XFDA(50.1,"+"_IENS_",+1,",.01)=$$UP^XLFSTR($E($P(BNS,U,I),1,40))
"RTN","SYNFMED",348,0)
 ; . S C0XFDA(50.1,"+"_IENS_",+1,",1)="T"
"RTN","SYNFMED",349,0)
 ;
"RTN","SYNFMED",350,0)
 ;
"RTN","SYNFMED",351,0)
 ; Dispense Unit (string)
"RTN","SYNFMED",352,0)
 S C0XFDA(50,"+1,",14.5)=$$GET1^DIQ(50.68,F5068IEN,"VA DISPENSE UNIT")
"RTN","SYNFMED",353,0)
 ;
"RTN","SYNFMED",354,0)
 ; National Drug File Entry (pointer to 50.6)
"RTN","SYNFMED",355,0)
 S C0XFDA(50,"+1,",20)="`"_$$GET1^DIQ(50.68,F5068IEN,"VA GENERIC NAME","I")
"RTN","SYNFMED",356,0)
 ;
"RTN","SYNFMED",357,0)
 ; VA Product Name (string)
"RTN","SYNFMED",358,0)
 S C0XFDA(50,"+1,",21)=$E($$GET1^DIQ(50.68,F5068IEN,.01),1,70)
"RTN","SYNFMED",359,0)
 ;
"RTN","SYNFMED",360,0)
 ; PSNDF VA PRODUCT NAME ENTRY (pointer to 50.68)
"RTN","SYNFMED",361,0)
 S C0XFDA(50,"+1,",22)="`"_F5068IEN
"RTN","SYNFMED",362,0)
 ;
"RTN","SYNFMED",363,0)
 ; DEA, SPECIAL HDLG (string)
"RTN","SYNFMED",364,0)
 D  ; From ^PSNMRG ; ZEXCEPT: n
"RTN","SYNFMED",365,0)
 . N CS S CS=$$GET1^DIQ(50.68,F5068IEN,"CS FEDERAL SCHEDULE","I")
"RTN","SYNFMED",366,0)
 . S CS=$S(CS?1(1"2n",1"3n"):+CS_"C",+CS=2!(+CS=3)&(CS'["C"):+CS_"A",1:CS)
"RTN","SYNFMED",367,0)
 . S C0XFDA(50,"+1,",3)=CS
"RTN","SYNFMED",368,0)
 ;
"RTN","SYNFMED",369,0)
 ; NATIONAL DRUG CLASS (pointer to 50.605) (triggers VA Classification field)
"RTN","SYNFMED",370,0)
 S C0XFDA(50,"+1,",25)="`"_$$GET1^DIQ(50.68,F5068IEN,"PRIMARY VA DRUG CLASS","I")
"RTN","SYNFMED",371,0)
 ;
"RTN","SYNFMED",372,0)
 ; Right Now, I don't file the following which ^PSNMRG does (cuz I don't need them)
"RTN","SYNFMED",373,0)
 ; - Package Size (derived from NDC/UPN file)
"RTN","SYNFMED",374,0)
 ; - Package Type (ditto)
"RTN","SYNFMED",375,0)
 ; - CMOP ID (from $$PROD2^PSNAPIS)
"RTN","SYNFMED",376,0)
 ; - National Formulary Indicator (from 50.68)
"RTN","SYNFMED",377,0)
 ;
"RTN","SYNFMED",378,0)
 ; Next Step is to kill Old OI if Dosage Form doesn't match
"RTN","SYNFMED",379,0)
 ; Won't do that here as it's assumed any drugs that's added is new.
"RTN","SYNFMED",380,0)
 ; This happens at ^PSNPSS
"RTN","SYNFMED",381,0)
 ;
"RTN","SYNFMED",382,0)
 ; Now add drug to drug file, as we need the IEN for the dosages call.
"RTN","SYNFMED",383,0)
 N C0XERR,C0XIEN
"RTN","SYNFMED",384,0)
 D UPDATE^DIE("E","C0XFDA","C0XIEN","C0XERR")
"RTN","SYNFMED",385,0)
 S:$D(C0XERR) $EC=",U1,"
"RTN","SYNFMED",386,0)
 ;
"RTN","SYNFMED",387,0)
 ; Next Step: Kill off old doses and add new ones.
"RTN","SYNFMED",388,0)
 D EN2^PSSUTIL(C0XIEN(1))
"RTN","SYNFMED",389,0)
 ;
"RTN","SYNFMED",390,0)
 ; Mark uses for the Drug; use the undocumented Silent call in PSSGIU
"RTN","SYNFMED",391,0)
 N PSIUDA,PSIUX ; Expected Input variables
"RTN","SYNFMED",392,0)
 S PSIUDA=C0XIEN(1),PSIUX="O^Outpatient Pharmacy" D ENS^PSSGIU
"RTN","SYNFMED",393,0)
 S PSIUDA=C0XIEN(1),PSIUX="U^Unit Dose" D ENS^PSSGIU
"RTN","SYNFMED",394,0)
 S PSIUDA=C0XIEN(1),PSIUX="X^Non-VA Med" D ENS^PSSGIU
"RTN","SYNFMED",395,0)
 ;
"RTN","SYNFMED",396,0)
 ; Get VA Generic text and VA Product pointer for Orderable Item creation plus dosage form information
"RTN","SYNFMED",397,0)
 N VAGENP S VAGENP=$P(^PSDRUG(C0XIEN(1),"ND"),U) ; VA Generic Pointer
"RTN","SYNFMED",398,0)
 N VAGEN S VAGEN=$$VAGN^PSNAPIS(VAGENP) ; VA Generic Full name
"RTN","SYNFMED",399,0)
 N VAPRODP S VAPRODP=$P(^PSDRUG(C0XIEN(1),"ND"),U,3) ; VA Product Pointer
"RTN","SYNFMED",400,0)
 N DOSAGE S DOSAGE=$$PSJDF^PSNAPIS(0,VAPRODP) ; IEN of dose form in 50.606 ^ Text
"RTN","SYNFMED",401,0)
 N DOSEPTR S DOSEPTR=$P(DOSAGE,U) ; ditto
"RTN","SYNFMED",402,0)
 N DOSEFORM S DOSEFORM=$P(DOSAGE,U,2) ;ditto
"RTN","SYNFMED",403,0)
 ;
"RTN","SYNFMED",404,0)
 ; Get the (possibly new) Orderable Item Text
"RTN","SYNFMED",405,0)
 N VAG40 S VAG40=$E(VAGEN,1,40) ; Max length of .01 field
"RTN","SYNFMED",406,0)
 ;
"RTN","SYNFMED",407,0)
 ; See if there is an existing orderable item already. If so, populate the Pharmacy Orderable item on drug file.
"RTN","SYNFMED",408,0)
 N OI S OI=$O(^PS(50.7,"ADF",VAG40,DOSEPTR,""))
"RTN","SYNFMED",409,0)
 ;
"RTN","SYNFMED",410,0)
 ; Otherwise, add a new one. (See MCHAN+12^PSSPOIMN)
"RTN","SYNFMED",411,0)
 N FLAGNEWOI S FLAGNEWOI=0
"RTN","SYNFMED",412,0)
 I 'OI D
"RTN","SYNFMED",413,0)
 . N C0XFDA,C0XERR
"RTN","SYNFMED",414,0)
 . S C0XFDA(50.7,"+1,",.01)=VAG40
"RTN","SYNFMED",415,0)
 . S C0XFDA(50.7,"+1,",.02)=DOSEPTR
"RTN","SYNFMED",416,0)
 . D UPDATE^DIE("",$NA(C0XFDA),$NA(OI),$NA(C0XERR))
"RTN","SYNFMED",417,0)
 . I $D(C0XERR) S $EC=",U1,"
"RTN","SYNFMED",418,0)
 . S OI=OI(1) ; For ease of use...
"RTN","SYNFMED",419,0)
 . S FLAGNEWOI=1
"RTN","SYNFMED",420,0)
 ;
"RTN","SYNFMED",421,0)
 ; Add the orderable Item to the drug file.
"RTN","SYNFMED",422,0)
 N C0XFDA,C0XERR S C0XFDA(50,C0XIEN(1)_",",2.1)=OI ; Orderable Item
"RTN","SYNFMED",423,0)
 D FILE^DIE("",$NA(C0XFDA),$NA(C0XERR))
"RTN","SYNFMED",424,0)
 ;
"RTN","SYNFMED",425,0)
 ; Mailman throws an error into DIERR, which ANNOYS me! So we won't check for errors here.
"RTN","SYNFMED",426,0)
 ; S:$D(C0XERR) $EC=",U1,"
"RTN","SYNFMED",427,0)
 ; Special $ZSTEP to find the problem: zp @$zpos b:($g(olddierr)'=$g(DIERR))  s olddierr=$g(DIERR) zstep into
"RTN","SYNFMED",428,0)
 ;
"RTN","SYNFMED",429,0)
 ; Previously, we did the CPRS HL7 message here; but we don't need to anymore. The OI xref does it for us.
"RTN","SYNFMED",430,0)
 ;
"RTN","SYNFMED",431,0)
EX QUIT C0XIEN(1)
"RTN","SYNFMED",432,0)
 ;
"RTN","SYNFMED",433,0)
GET(RETURN,URL) ; [Public] Get a URL
"RTN","SYNFMED",434,0)
 ; ZEXCEPT: %XOBWERR
"RTN","SYNFMED",435,0)
 ;
"RTN","SYNFMED",436,0)
 ; Timeout
"RTN","SYNFMED",437,0)
 N TO S TO=5
"RTN","SYNFMED",438,0)
 N HEADERS
"RTN","SYNFMED",439,0)
 ; Action
"RTN","SYNFMED",440,0)
 N STATUS S STATUS=$$GETURL^XTHC10(URL,TO,$NA(RETURN)),HEADERS("STATUS")=STATUS
"RTN","SYNFMED",441,0)
 ;
"RTN","SYNFMED",442,0)
 ; ZWRITE HEADERS
"RTN","SYNFMED",443,0)
 ; ZWRITE RETURN
"RTN","SYNFMED",444,0)
 ;
"RTN","SYNFMED",445,0)
 ; Check status code to be 200.
"RTN","SYNFMED",446,0)
 I "^200^302^"'[HEADERS("STATUS") S %XOBWERR=HEADERS("STATUS"),$EC=",UXOBWHTTP,"
"RTN","SYNFMED",447,0)
 QUIT
"RTN","SYNFMED",448,0)
 ;
"RTN","SYNFMED",449,0)
WRITERXRXN(PSODFN,RXNCUI,RXDATE) ; [$$/D Public] Create a new prescription for a patient using RxNorm SCD CUI
"RTN","SYNFMED",450,0)
 ; Input: PSODFN = DFN
"RTN","SYNFMED",451,0)
 ; Input: RXNCUI = RxNorm CUI. ONLY SCD, SCDC, SBDC, or SBD types only
"RTN","SYNFMED",452,0)
 ; Input: RXDATE = Prescription Date
"RTN","SYNFMED",453,0)
 ;
"RTN","SYNFMED",454,0)
 ; $$ Output: Prescription Number (not IEN) or -1^error message or -2^error message
"RTN","SYNFMED",455,0)
 ;
"RTN","SYNFMED",456,0)
 ; Convert RXNCUI to SCD
"RTN","SYNFMED",457,0)
 N RXNCDCUI S RXNCDCUI=$$RXNCONV(RXNCUI)
"RTN","SYNFMED",458,0)
 I 'RXNCDCUI Q -2_U_"RxNorm CUI "_RXNCUI_" is not a valid RxNorm. Please check using RxNav or similar"
"RTN","SYNFMED",459,0)
 ;
"RTN","SYNFMED",460,0)
 N DRUG S DRUG=$$ADDDRUG(RXNCDCUI)
"RTN","SYNFMED",461,0)
 I 'DRUG Q -1_U_"RxNorm CUI "_RXNCDCUI_" could not be resolved into a drug."
"RTN","SYNFMED",462,0)
 S DRUG=$P(DRUG,U) ; in case we get multiple drugs back; reported by George.
"RTN","SYNFMED",463,0)
 I $QUIT QUIT $$WRITERXPS(PSODFN,DRUG,RXDATE)
"RTN","SYNFMED",464,0)
 D WRITERXPS(PSODFN,DRUG,RXDATE)
"RTN","SYNFMED",465,0)
 QUIT
"RTN","SYNFMED",466,0)
 ;
"RTN","SYNFMED",467,0)
WRITERXPS(PSODFN,DRUG,RXDATE) ; [$$/D Public] Create a new prescription for a patient using drug IEN
"RTN","SYNFMED",468,0)
 ; Input: PSODFN = DFN
"RTN","SYNFMED",469,0)
 ; Input: DRUG = Drug (file 50) IEN
"RTN","SYNFMED",470,0)
 ; Input: RXDATE = Prescription Date
"RTN","SYNFMED",471,0)
 ; $$ Output: Prescription Number (not IEN) or -1^error message
"RTN","SYNFMED",472,0)
 ;
"RTN","SYNFMED",473,0)
 ; Site Parameters (see PSOLSET)
"RTN","SYNFMED",474,0)
 N PSOSITE S PSOSITE=$$PSOSITE^SYNINIT()
"RTN","SYNFMED",475,0)
 N PSOPAR,PSOPAR7,PSOSYS,PSODTCUT,PSOPRPAS
"RTN","SYNFMED",476,0)
 S PSOPAR=$G(^PS(59,PSOSITE,1)),PSOPAR7=$G(^PS(59,PSOSITE,"IB")),PSOSYS=$G(^PS(59.7,1,40.1)) D CUTDATE^PSOFUNC
"RTN","SYNFMED",477,0)
 ;
"RTN","SYNFMED",478,0)
 ; Add Patient to File 55 DINUMMED to 2
"RTN","SYNFMED",479,0)
 N FDA,IEN,DIERR
"RTN","SYNFMED",480,0)
 S FDA(55,"?+1,",.01)="`"_PSODFN
"RTN","SYNFMED",481,0)
 S IEN(1)=PSODFN
"RTN","SYNFMED",482,0)
 S FDA(55,"?+1,",3)="OPC" ; A convenient Patient Status
"RTN","SYNFMED",483,0)
 D UPDATE^DIE("E","FDA","IEN")
"RTN","SYNFMED",484,0)
 I $D(DIERR) S $EC=",U-UPDATE-FAILED,"
"RTN","SYNFMED",485,0)
 ;
"RTN","SYNFMED",486,0)
 ; Pharmacist (we use the value multiple times)
"RTN","SYNFMED",487,0)
 N SYNPHARM S SYNPHARM=$$PHARM^SYNINIT()
"RTN","SYNFMED",488,0)
 ; Drug Array we will pass by reference
"RTN","SYNFMED",489,0)
 N PSONEW
"RTN","SYNFMED",490,0)
 ;
"RTN","SYNFMED",491,0)
 ; Call to get drug demographics
"RTN","SYNFMED",492,0)
 N PSOY
"RTN","SYNFMED",493,0)
 S PSOY=DRUG
"RTN","SYNFMED",494,0)
 S PSOY(0)=^PSDRUG(DRUG,0)
"RTN","SYNFMED",495,0)
 N PSODRUG
"RTN","SYNFMED",496,0)
 D SET^PSODRG
"RTN","SYNFMED",497,0)
 M PSONEW=PSODRUG
"RTN","SYNFMED",498,0)
 ;
"RTN","SYNFMED",499,0)
 ; Days and refills
"RTN","SYNFMED",500,0)
 S PSONEW("ISSUE DATE")=RXDATE
"RTN","SYNFMED",501,0)
 S PSONEW("FILL DATE")=RXDATE
"RTN","SYNFMED",502,0)
 S PSONEW("DAYS SUPPLY")=30
"RTN","SYNFMED",503,0)
 S PSONEW("# OF REFILLS")=1
"RTN","SYNFMED",504,0)
 ;
"RTN","SYNFMED",505,0)
 ; Pharmacist here!
"RTN","SYNFMED",506,0)
 S PSONEW("VERIFY")=1
"RTN","SYNFMED",507,0)
 S PSONEW("PHARMACIST")=SYNPHARM
"RTN","SYNFMED",508,0)
 S PSONEW("CLERK CODE")=SYNPHARM ; Needed for CPRS for "Entered By" field.
"RTN","SYNFMED",509,0)
 ;
"RTN","SYNFMED",510,0)
 ; Provider
"RTN","SYNFMED",511,0)
 S PSONEW("PROVIDER")=$$PROV^SYNINIT()
"RTN","SYNFMED",512,0)
 ;
"RTN","SYNFMED",513,0)
 ; Clinic
"RTN","SYNFMED",514,0)
 S PSONEW("CLINIC")=$$HL^SYNINIT()
"RTN","SYNFMED",515,0)
 ;
"RTN","SYNFMED",516,0)
 ; Get Prescription Number
"RTN","SYNFMED",517,0)
 D AUTO^PSONRXN
"RTN","SYNFMED",518,0)
 ;
"RTN","SYNFMED",519,0)
 N SYNRXN S SYNRXN=PSONEW("RX #")
"RTN","SYNFMED",520,0)
 ;
"RTN","SYNFMED",521,0)
 ; Dosage
"RTN","SYNFMED",522,0)
 S PSONEW("ENT")=1
"RTN","SYNFMED",523,0)
 S PSONEW("DOSE",PSONEW("ENT"))="ONE TABLET DAILY"
"RTN","SYNFMED",524,0)
 ;
"RTN","SYNFMED",525,0)
 ; Copay
"RTN","SYNFMED",526,0)
 N PSOSCP S PSOSCP=""
"RTN","SYNFMED",527,0)
 ;
"RTN","SYNFMED",528,0)
 ; Quantity
"RTN","SYNFMED",529,0)
 S PSONEW("QTY")=30 ; Non-sense number
"RTN","SYNFMED",530,0)
 ;
"RTN","SYNFMED",531,0)
 ; Counseling
"RTN","SYNFMED",532,0)
 N PSOCOU,PSOCOUU
"RTN","SYNFMED",533,0)
 S PSOCOU=1,PSOCOUU=1
"RTN","SYNFMED",534,0)
 ;
"RTN","SYNFMED",535,0)
 ; Nature of order
"RTN","SYNFMED",536,0)
 N PSONOOR S PSONOOR="W"
"RTN","SYNFMED",537,0)
 ;
"RTN","SYNFMED",538,0)
 ; Mail/Window - defaults to mail; override to Window
"RTN","SYNFMED",539,0)
 S PSONEW("MAIL/WINDOW")="W"
"RTN","SYNFMED",540,0)
 ;
"RTN","SYNFMED",541,0)
 ; Patient Status
"RTN","SYNFMED",542,0)
 S PSONEW("PATIENT STATUS")=$$FIND1^DIC(53,,"QX","OPC")
"RTN","SYNFMED",543,0)
 ;
"RTN","SYNFMED",544,0)
 ; File in 52
"RTN","SYNFMED",545,0)
 D EN^PSON52(.PSONEW)
"RTN","SYNFMED",546,0)
 ;
"RTN","SYNFMED",547,0)
 ; Needed for release later (see PSODISP)
"RTN","SYNFMED",548,0)
 N PSIN S PSIN=+$P($G(^PS(59.7,1,49.99)),"^",2)
"RTN","SYNFMED",549,0)
 N SYNRXIEN S SYNRXIEN=PSONEW("IRXN")
"RTN","SYNFMED",550,0)
 ;
"RTN","SYNFMED",551,0)
 ; HL7 to OE/RR to update the Order File
"RTN","SYNFMED",552,0)
 D EOJ^PSONEW
"RTN","SYNFMED",553,0)
 ;
"RTN","SYNFMED",554,0)
 ; Print Prescription (required for releasing)
"RTN","SYNFMED",555,0)
 ; NB: We are not checking for POP
"RTN","SYNFMED",556,0)
 N IOP S IOP="NULL"
"RTN","SYNFMED",557,0)
 N %ZIS S %ZIS=0
"RTN","SYNFMED",558,0)
 D ^%ZIS U IO
"RTN","SYNFMED",559,0)
 ; Ignore POP as we don't care if we can't write to device. We want IOST specs.
"RTN","SYNFMED",560,0)
 ; ZEXCEPT: %WNULL from the webserver
"RTN","SYNFMED",561,0)
 I $D(%WNULL) S IO=%WNULL U %WNULL
"RTN","SYNFMED",562,0)
 N PPL S PPL=SYNRXIEN_","
"RTN","SYNFMED",563,0)
 N PDUZ S PDUZ=SYNPHARM
"RTN","SYNFMED",564,0)
 D DQ^PSOLBL
"RTN","SYNFMED",565,0)
 ;
"RTN","SYNFMED",566,0)
 ; Release Prescription
"RTN","SYNFMED",567,0)
 N POERR S POERR=1
"RTN","SYNFMED",568,0)
 N RXP S RXP=SYNRXIEN
"RTN","SYNFMED",569,0)
 N PSRH S PSRH=SYNPHARM
"RTN","SYNFMED",570,0)
 D BATCH^PSODISP
"RTN","SYNFMED",571,0)
 I '$D(%WNULL) D ^%ZISC
"RTN","SYNFMED",572,0)
 ;
"RTN","SYNFMED",573,0)
 QUIT:$QUIT SYNRXN QUIT
"RTN","SYNFMED",574,0)
 ;
"RTN","SYNFMED",575,0)
TEST D EN^%ut("SYNFMEDT",3) QUIT
"RTN","SYNFMED2")
0^33^B111812418
"RTN","SYNFMED2",1,0)
SYNFMED2        ;ven/gpl - fhir loader utilities ;2018-08-17  3:27 PM
"RTN","SYNFMED2",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNFMED2",3,0)
 ;
"RTN","SYNFMED2",4,0)
 ; Authored by George P. Lilly 2017-2018
"RTN","SYNFMED2",5,0)
 ;
"RTN","SYNFMED2",6,0)
 q
"RTN","SYNFMED2",7,0)
 ;
"RTN","SYNFMED2",8,0)
importMeds(rtn,ien,args)        ; entry point for loading Medications for a patient
"RTN","SYNFMED2",9,0)
 ; calls the intake Medications web service directly
"RTN","SYNFMED2",10,0)
 ;
"RTN","SYNFMED2",11,0)
 n grtn
"RTN","SYNFMED2",12,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFMED2",13,0)
 d wsIntakeMeds(.args,,.grtn,ien)
"RTN","SYNFMED2",14,0)
 i $d(grtn) d  ; something was returned
"RTN","SYNFMED2",15,0)
 . k @root@(ien,"load","meds")
"RTN","SYNFMED2",16,0)
 . m @root@(ien,"load","meds")=grtn("meds")
"RTN","SYNFMED2",17,0)
 . if $g(args("debug"))=1 m rtn=grtn
"RTN","SYNFMED2",18,0)
 s rtn("conditionsStatus","status")=$g(grtn("status","status"))
"RTN","SYNFMED2",19,0)
 s rtn("conditionsStatus","loaded")=$g(grtn("status","loaded"))
"RTN","SYNFMED2",20,0)
 s rtn("conditionsStatus","errors")=$g(grtn("status","errors"))
"RTN","SYNFMED2",21,0)
 ;b
"RTN","SYNFMED2",22,0)
 ;
"RTN","SYNFMED2",23,0)
 ;
"RTN","SYNFMED2",24,0)
 q
"RTN","SYNFMED2",25,0)
 ;
"RTN","SYNFMED2",26,0)
wsIntakeMeds(args,body,result,ien)      ; web service entry (post)
"RTN","SYNFMED2",27,0)
 ; for intake of one or more Meds. input are fhir resources
"RTN","SYNFMED2",28,0)
 ; result is json and summarizes what was done
"RTN","SYNFMED2",29,0)
 ; args include patientId
"RTN","SYNFMED2",30,0)
 ; ien is specified for internal calls, where the json is already in a graph
"RTN","SYNFMED2",31,0)
 n jtmp,json,jrslt,eval
"RTN","SYNFMED2",32,0)
 ;i $g(ien)'="" if $$loadStatus("meds","",ien)=1 d  q  ;
"RTN","SYNFMED2",33,0)
 ;. s result("medstatus","status")="alreadyLoaded"
"RTN","SYNFMED2",34,0)
 i $g(ien)'="" d  ; internal call
"RTN","SYNFMED2",35,0)
 . d getIntakeFhir^SYNFHIR("json",,"MedicationRequest",ien,1)
"RTN","SYNFMED2",36,0)
 e  d  ; 
"RTN","SYNFMED2",37,0)
 . merge jtmp=BODY
"RTN","SYNFMED2",38,0)
 . do DECODE^VPRJSON("jtmp","json")
"RTN","SYNFMED2",39,0)
 ;
"RTN","SYNFMED2",40,0)
 ;i '$d(json) d getRandomMeds(.json)
"RTN","SYNFMED2",41,0)
 ;
"RTN","SYNFMED2",42,0)
 i '$d(json) q  ;
"RTN","SYNFMED2",43,0)
 m ^gpl("gjson")=json
"RTN","SYNFMED2",44,0)
 ;
"RTN","SYNFMED2",45,0)
 ; determine the patient
"RTN","SYNFMED2",46,0)
 ;
"RTN","SYNFMED2",47,0)
 n dfn,eval
"RTN","SYNFMED2",48,0)
 if $g(ien)'="" d  ;
"RTN","SYNFMED2",49,0)
 . s dfn=$$ien2dfn^SYNFUTL(ien) ; look up dfn in the graph
"RTN","SYNFMED2",50,0)
 else  d  ;
"RTN","SYNFMED2",51,0)
 . s dfn=$g(args("dfn"))
"RTN","SYNFMED2",52,0)
 . i dfn="" d  ;
"RTN","SYNFMED2",53,0)
 . . n icn s icn=$g(args("icn"))
"RTN","SYNFMED2",54,0)
 . . i icn'="" s dfn=$$icn2dfn^SYNFUTL(icn)
"RTN","SYNFMED2",55,0)
 i $g(dfn)="" do  quit  ; need the patient
"RTN","SYNFMED2",56,0)
 . s result("meds",1,"log",1)="Error, patient not found.. terminating"
"RTN","SYNFMED2",57,0)
 ;
"RTN","SYNFMED2",58,0)
 new zi s zi=0
"RTN","SYNFMED2",59,0)
 for  set zi=$order(json("entry",zi)) quit:+zi=0  do  ;
"RTN","SYNFMED2",60,0)
 . ;
"RTN","SYNFMED2",61,0)
 . ; define a place to log the processing of this entry
"RTN","SYNFMED2",62,0)
 . ;
"RTN","SYNFMED2",63,0)
 . new jlog set jlog=$name(eval("meds",zi))
"RTN","SYNFMED2",64,0)
 . ;
"RTN","SYNFMED2",65,0)
 . ; insure that the resourceType is MedicationRequest
"RTN","SYNFMED2",66,0)
 . ;
"RTN","SYNFMED2",67,0)
 . new type set type=$get(json("entry",zi,"resource","resourceType"))
"RTN","SYNFMED2",68,0)
 . if type'="MedicationRequest" do  quit  ;
"RTN","SYNFMED2",69,0)
 . . set eval("meds",zi,"vars","resourceType")=type
"RTN","SYNFMED2",70,0)
 . . do log(jlog,"Resource type not MedicationRequest, skipping entry")
"RTN","SYNFMED2",71,0)
 . set eval("meds",zi,"vars","resourceType")=type
"RTN","SYNFMED2",72,0)
 . ;
"RTN","SYNFMED2",73,0)
 . ; see if this resource has already been loaded. if so, skip it
"RTN","SYNFMED2",74,0)
 . ;
"RTN","SYNFMED2",75,0)
 . if $g(ien)'="" if $$loadStatus("meds",zi,ien)=1 do  quit  ;
"RTN","SYNFMED2",76,0)
 . . d log(jlog,"Meds already loaded, skipping")
"RTN","SYNFMED2",77,0)
 . ;
"RTN","SYNFMED2",78,0)
 . ; determine Meds rxnorm code, coding system, and display text
"RTN","SYNFMED2",79,0)
 . ;
"RTN","SYNFMED2",80,0)
 . n med,rxnorm,codesystem,drugname
"RTN","SYNFMED2",81,0)
 . i $d(json("entry",zi,"resource","medicationCodeableConcept")) d  ;
"RTN","SYNFMED2",82,0)
 . . n gmed s gmed=$na(json("entry",zi,"resource","medicationCodeableConcept"))
"RTN","SYNFMED2",83,0)
 . . s rxnorm=$g(@gmed@("coding",1,"code"))
"RTN","SYNFMED2",84,0)
 . . q:rxnorm=""
"RTN","SYNFMED2",85,0)
 . . s drugname=$g(@gmed@("coding",1,"display"))
"RTN","SYNFMED2",86,0)
 . . s codesystem=$g(@gmed@("coding",1,"system"))
"RTN","SYNFMED2",87,0)
 . . s codesystem=$re($p($re(codesystem),"/"))
"RTN","SYNFMED2",88,0)
 . e  d  ;
"RTN","SYNFMED2",89,0)
 . . d getEntry^SYNFHIR("med",ien,zi-1) ; meds are in the previous entry
"RTN","SYNFMED2",90,0)
 . . n gmed s gmed=$na(med("entry",zi-1,"resource"))
"RTN","SYNFMED2",91,0)
 . . q:$g(@gmed@("resourceType"))'="Medication"
"RTN","SYNFMED2",92,0)
 . . s rxnorm=$g(@gmed@("code","coding",1,"code"))
"RTN","SYNFMED2",93,0)
 . . q:rxnorm=""
"RTN","SYNFMED2",94,0)
 . . s drugname=$g(@gmed@("code","coding",1,"display"))
"RTN","SYNFMED2",95,0)
 . . s codesystem=$g(@gmed@("code","coding",1,"system"))
"RTN","SYNFMED2",96,0)
 . . s codesystem=$re($p($re(codesystem),"/"))
"RTN","SYNFMED2",97,0)
 . ;
"RTN","SYNFMED2",98,0)
 . q:$g(rxnorm)=""
"RTN","SYNFMED2",99,0)
 . ;i rxnorm=897122 d  q  ;
"RTN","SYNFMED2",100,0)
 . ;. do log(jlog,"skipping unloadable drug, 3 ML liraglutide 6 MG/ML Pen Injector rxnorm= "_rxnorm)
"RTN","SYNFMED2",101,0)
 . ;i rxnorm=313782 d  q  ;
"RTN","SYNFMED2",102,0)
 . ;. do log(jlog,"skipping unloadable drug rxnorm= "_313782)
"RTN","SYNFMED2",103,0)
 . do log(jlog,"rxnorm code is: "_rxnorm)
"RTN","SYNFMED2",104,0)
 . set eval("meds",zi,"vars","rxnorm")=rxnorm
"RTN","SYNFMED2",105,0)
 . do log(jlog,"drug name is: "_drugname)
"RTN","SYNFMED2",106,0)
 . set eval("meds",zi,"vars","drugname")=drugname
"RTN","SYNFMED2",107,0)
 . ;
"RTN","SYNFMED2",108,0)
 . ;
"RTN","SYNFMED2",109,0)
 . do log(jlog,"code system is: "_codesystem)
"RTN","SYNFMED2",110,0)
 . set eval("meds",zi,"vars","codeSystem")=codesystem
"RTN","SYNFMED2",111,0)
 . ;
"RTN","SYNFMED2",112,0)
 . ; determine the order date and time
"RTN","SYNFMED2",113,0)
 . ;
"RTN","SYNFMED2",114,0)
 . new orderdate set orderdate=$get(json("entry",zi,"resource","authoredOn"))
"RTN","SYNFMED2",115,0)
 . do log(jlog,"orderdateTime is: "_orderdate)
"RTN","SYNFMED2",116,0)
 . set eval("meds",zi,"vars","orderdateTime")=orderdate
"RTN","SYNFMED2",117,0)
 . new fmOrderDateTime s fmOrderDateTime=$$fhirTfm^SYNFUTL(orderdate)
"RTN","SYNFMED2",118,0)
 . d log(jlog,"fileman orderdateTime is: "_fmOrderDateTime)
"RTN","SYNFMED2",119,0)
 . set eval("meds",zi,"vars","fmOrderdateTime")=fmOrderDateTime ;
"RTN","SYNFMED2",120,0)
 . new hl7OrderdateTime s hl7OrderdateTime=$$fhirThl7^SYNFUTL(orderdate)
"RTN","SYNFMED2",121,0)
 . d log(jlog,"hl7 orderdateTime is: "_hl7OrderdateTime)
"RTN","SYNFMED2",122,0)
 . set eval("meds",zi,"vars","hl7OrderdateTime")=hl7OrderdateTime ;
"RTN","SYNFMED2",123,0)
 . ;
"RTN","SYNFMED2",124,0)
 . ; determine clinical status (active vs inactive)
"RTN","SYNFMED2",125,0)
 . ;
"RTN","SYNFMED2",126,0)
 . n clinicalstatus set clinicalstatus=$get(json("entry",zi,"resource","verificationStatus"))
"RTN","SYNFMED2",127,0)
 . ;
"RTN","SYNFMED2",128,0)
 . ;
"RTN","SYNFMED2",129,0)
 . ; set up to call the data loader
"RTN","SYNFMED2",130,0)
 . ;
"RTN","SYNFMED2",131,0)
 . ;
"RTN","SYNFMED2",132,0)
 . if $g(args("load"))=1 d  ; only load if told to
"RTN","SYNFMED2",133,0)
 . . if $g(ien)'="" if $$loadStatus("meds",zi,ien)=1 do  quit  ;
"RTN","SYNFMED2",134,0)
 . . . d log(jlog,"Meds already loaded, skipping")
"RTN","SYNFMED2",135,0)
 . . d log(jlog,"Calling WRITERXRXN^SYNFMED to add meds")
"RTN","SYNFMED2",136,0)
 . . n RESTA
"RTN","SYNFMED2",137,0)
 . . S RESTA=$$WRITERXRXN^SYNFMED(dfn,rxnorm,fmOrderDateTime)
"RTN","SYNFMED2",138,0)
 . . m eval("meds",zi,"status")=RESTA
"RTN","SYNFMED2",139,0)
 . . d log(jlog,"Response from WRITERXRXN^SYNFMED is: "_RESTA)
"RTN","SYNFMED2",140,0)
 . . d log(jlog,"Medication: "_rxnorm_" "_drugname)
"RTN","SYNFMED2",141,0)
 . . if RESTA>1 d  ; success
"RTN","SYNFMED2",142,0)
 . . . s eval("status","loaded")=$g(eval("status","loaded"))+1
"RTN","SYNFMED2",143,0)
 . . . s eval("meds",zi,"status","loadstatus")="loaded"
"RTN","SYNFMED2",144,0)
 . . else  d  ;
"RTN","SYNFMED2",145,0)
 . . . s eval("status","errors")=$g(eval("status","errors"))+1
"RTN","SYNFMED2",146,0)
 . . . s eval("meds",zi,"status","loadstatus")="notLoaded"
"RTN","SYNFMED2",147,0)
 . . . s eval("meds",zi,"status","loadMessage")=$g(RETSTA)
"RTN","SYNFMED2",148,0)
 . . . d log(jlog,"Medication failed to load: "_$g(RETSTA))
"RTN","SYNFMED2",149,0)
 . . n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFMED2",150,0)
 . . k @root@(ien,"load","meds",zi)
"RTN","SYNFMED2",151,0)
 . . m @root@(ien,"load","meds",zi)=eval("meds",zi)
"RTN","SYNFMED2",152,0)
 ;
"RTN","SYNFMED2",153,0)
 if $get(args("debug"))=1 do  ;
"RTN","SYNFMED2",154,0)
 . m jrslt("source")=json
"RTN","SYNFMED2",155,0)
 . m jrslt("args")=args
"RTN","SYNFMED2",156,0)
 . m jrslt("eval")=eval
"RTN","SYNFMED2",157,0)
 m jrslt("medsStatus")=eval("medsStatus")
"RTN","SYNFMED2",158,0)
 set jrslt("result","status")="ok"
"RTN","SYNFMED2",159,0)
 set jrslt("result","loaded")=$g(eval("status","loaded"))
"RTN","SYNFMED2",160,0)
 i $g(ien)'="" d  ; called internally
"RTN","SYNFMED2",161,0)
 . m result=eval
"RTN","SYNFMED2",162,0)
 . m result("status")=jrslt("result")
"RTN","SYNFMED2",163,0)
 . m result("dfn")=dfn
"RTN","SYNFMED2",164,0)
 . m result("ien")=ien
"RTN","SYNFMED2",165,0)
 . ;b
"RTN","SYNFMED2",166,0)
 e  d  ;
"RTN","SYNFMED2",167,0)
 . d ENCODE^VPRJSON("jrslt","result")
"RTN","SYNFMED2",168,0)
 . set HTTPRSP("mime")="application/json" 
"RTN","SYNFMED2",169,0)
 q
"RTN","SYNFMED2",170,0)
 ;
"RTN","SYNFMED2",171,0)
log(ary,txt)    ; adds a text line to @ary@("log")
"RTN","SYNFMED2",172,0)
 s @ary@("log",$o(@ary@("log",""),-1)+1)=$g(txt)
"RTN","SYNFMED2",173,0)
 w:$G(DEBUG) !,"      ",$G(txt)
"RTN","SYNFMED2",174,0)
 q
"RTN","SYNFMED2",175,0)
 ;
"RTN","SYNFMED2",176,0)
loadStatus(typ,zx,zien) ; extrinsic return 1 if resource was loaded
"RTN","SYNFMED2",177,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFMED2",178,0)
 n rt s rt=0
"RTN","SYNFMED2",179,0)
 i $g(zx)="" i $d(@root@(zien,"load",typ)) s rt=1 q rt
"RTN","SYNFMED2",180,0)
 i $get(@root@(zien,"load",typ,zx,"status","loadstatus"))="loaded" s rt=1
"RTN","SYNFMED2",181,0)
 q rt
"RTN","SYNFMED2",182,0)
 ;
"RTN","SYNFMED2",183,0)
testall(limit,start)    ; run the meds import on all imported patients
"RTN","SYNFMED2",184,0)
 ;; next line added for DUZ setup because of <UNDEFINED>ENTDFLT+12^XPAR1 *DUZ(2)
"RTN","SYNFMED2",185,0)
 S USER=$$DUZ^SYNDHP69()
"RTN","SYNFMED2",186,0)
 ;; 
"RTN","SYNFMED2",187,0)
 i $g(limit)="" s limit=1
"RTN","SYNFMED2",188,0)
 n cnt s cnt=0
"RTN","SYNFMED2",189,0)
 new root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFMED2",190,0)
 new indx s indx=$na(@root@("POS","DFN"))
"RTN","SYNFMED2",191,0)
 n dfn,ien,filter,reslt
"RTN","SYNFMED2",192,0)
 s dfn=0
"RTN","SYNFMED2",193,0)
 i $g(start)'="" s dfn=start
"RTN","SYNFMED2",194,0)
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  q:cnt=limit  d  ;
"RTN","SYNFMED2",195,0)
 . s ien=$o(@indx@(dfn,""))
"RTN","SYNFMED2",196,0)
 . q:ien=""
"RTN","SYNFMED2",197,0)
 . q:ien=19
"RTN","SYNFMED2",198,0)
 . s cnt=cnt+1
"RTN","SYNFMED2",199,0)
 . s filter("dfn")=dfn
"RTN","SYNFMED2",200,0)
 . s filter("load")=1
"RTN","SYNFMED2",201,0)
 . k reslt
"RTN","SYNFMED2",202,0)
 . w !,"meds for ien: ",ien," dfn= ",dfn
"RTN","SYNFMED2",203,0)
 . d wsIntakeMeds(.filter,,.reslt,ien)
"RTN","SYNFMED2",204,0)
 q
"RTN","SYNFMED2",205,0)
 ;
"RTN","SYNFMED2",206,0)
testone(reslt,doload)   ; run the meds import on one imported patient
"RTN","SYNFMED2",207,0)
 new root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFMED2",208,0)
 new indx s indx=$na(@root@("POS","DFN"))
"RTN","SYNFMED2",209,0)
 n dfn,ien,filter
"RTN","SYNFMED2",210,0)
 n done s done=0
"RTN","SYNFMED2",211,0)
 s dfn=0
"RTN","SYNFMED2",212,0)
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  q:done   d  ;
"RTN","SYNFMED2",213,0)
 . s ien=$o(@indx@(dfn,""))
"RTN","SYNFMED2",214,0)
 . q:ien=""
"RTN","SYNFMED2",215,0)
 . ;q:$d(@root@(ien,"load","meds"))
"RTN","SYNFMED2",216,0)
 . s filter("dfn")=dfn
"RTN","SYNFMED2",217,0)
 . s filter("debug")=1
"RTN","SYNFMED2",218,0)
 . i $g(doload)=1 s filter("load")=1
"RTN","SYNFMED2",219,0)
 . k reslt
"RTN","SYNFMED2",220,0)
 . w !,"calling wsIntakeMeds for ien: ",ien
"RTN","SYNFMED2",221,0)
 . d wsIntakeMeds(.filter,,.reslt,ien)
"RTN","SYNFMED2",222,0)
 . s done=1
"RTN","SYNFMED2",223,0)
 q
"RTN","SYNFMED2",224,0)
 ;
"RTN","SYNFMED2",225,0)
getRandomMeds(ary) ; make a web service call to get random allergies
"RTN","SYNFMED2",226,0)
 n srvr
"RTN","SYNFMED2",227,0)
 s srvr="http://postfhir.vistaplex.org:9080/"
"RTN","SYNFMED2",228,0)
 i srvr["postfhir.vistaplex.org" s srvr="http://138.197.70.229:9080/"
"RTN","SYNFMED2",229,0)
 i $g(^%WURL)["http://postfhir.vistaplex.org:9080" d  q  ;
"RTN","SYNFMED2",230,0)
 . s srvr="localhost:9080/"
"RTN","SYNFMED2",231,0)
 . n url
"RTN","SYNFMED2",232,0)
 . s url=srvr_"randommeds"
"RTN","SYNFMED2",233,0)
 . n ok,r1
"RTN","SYNFMED2",234,0)
 . s ok=$$%^%WC(.r1,"GET",url)
"RTN","SYNFMED2",235,0)
 . i '$d(r1) q  ;
"RTN","SYNFMED2",236,0)
 . d DECODE^VPRJSON("r1","ary")
"RTN","SYNFMED2",237,0)
 n url
"RTN","SYNFMED2",238,0)
 s url=srvr_"randommeds"
"RTN","SYNFMED2",239,0)
 n ret,json,jtmp
"RTN","SYNFMED2",240,0)
 s ret=$$GETURL^XTHC10(url,,"jtmp")
"RTN","SYNFMED2",241,0)
 d assemble^SYNFPUL("jtmp","json")
"RTN","SYNFMED2",242,0)
 i '$d(json) q  ;
"RTN","SYNFMED2",243,0)
 d DECODE^VPRJSON("json","ary")
"RTN","SYNFMED2",244,0)
 q
"RTN","SYNFMED2",245,0)
 ;
"RTN","SYNFMED2",246,0)
medsum ; search all loaded patients and catelog the procedure codes
"RTN","SYNFMED2",247,0)
 n root,json,ien,table
"RTN","SYNFMED2",248,0)
 s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFMED2",249,0)
 s ien=0
"RTN","SYNFMED2",250,0)
 f  s ien=$o(@root@(ien)) q:+ien=0  d  ;
"RTN","SYNFMED2",251,0)
 . k json
"RTN","SYNFMED2",252,0)
 . d getIntakeFhir^SYNFHIR("json",,"MedicationRequest",ien,1)
"RTN","SYNFMED2",253,0)
 . n cde,txt,rien
"RTN","SYNFMED2",254,0)
 . s rien=0
"RTN","SYNFMED2",255,0)
 . f  s rien=$o(json("entry",rien)) q:+rien=0  d  ;
"RTN","SYNFMED2",256,0)
 . . n med
"RTN","SYNFMED2",257,0)
 . . d getEntry^SYNFHIR("med",ien,rien-1) ; meds are in the previous entry
"RTN","SYNFMED2",258,0)
 . . n gmed s gmed=$na(med("entry",rien-1,"resource"))
"RTN","SYNFMED2",259,0)
 . . q:$g(@gmed@("resourceType"))'="Medication"
"RTN","SYNFMED2",260,0)
 . . s cde=$g(@gmed@("code","coding",1,"code"))
"RTN","SYNFMED2",261,0)
 . . q:cde=""
"RTN","SYNFMED2",262,0)
 . . s txt=$g(@gmed@("code","coding",1,"display"))
"RTN","SYNFMED2",263,0)
 . . n sys s sys=$g(@gmed@("code","coding",1,"system"))
"RTN","SYNFMED2",264,0)
 . . s sys=$re($p($re(sys),"/"))
"RTN","SYNFMED2",265,0)
 . . s txt=txt_" - "_sys
"RTN","SYNFMED2",266,0)
 . . n stat
"RTN","SYNFMED2",267,0)
 . . s stat=$g(^%wd(17.040801,3,ien,"load","meds",rien,"status"))
"RTN","SYNFMED2",268,0)
 . . i stat["CUI" d  ;
"RTN","SYNFMED2",269,0)
 . . . n cui
"RTN","SYNFMED2",270,0)
 . . . s cui=$p($p(stat,"CUI ",2)," ",1)
"RTN","SYNFMED2",271,0)
 . . . s notloaded(cui)=""
"RTN","SYNFMED2",272,0)
 . . i '$d(table(cde_" "_txt)) s table(cde_" "_txt)=1 q  ;
"RTN","SYNFMED2",273,0)
 . . s table(cde_" "_txt)=$g(table(cde_" "_txt))+1
"RTN","SYNFMED2",274,0)
 zwrite table
"RTN","SYNFMED2",275,0)
 zwrite notloaded
"RTN","SYNFMED2",276,0)
 q
"RTN","SYNFMED2",277,0)
 ;
"RTN","SYNFMEDT")
0^34^B66688950
"RTN","SYNFMEDT",1,0)
SYNFMEDT ;OSE/SMH - Unit Tests for Synthetic Medications;Jun 11 2018
"RTN","SYNFMEDT",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNFMEDT",3,0)
 ;
"RTN","SYNFMEDT",4,0)
 D EN^%ut($T(+0),2,1)
"RTN","SYNFMEDT",5,0)
 QUIT
"RTN","SYNFMEDT",6,0)
 ;
"RTN","SYNFMEDT",7,0)
STARTUP ; M-Unit Startup
"RTN","SYNFMEDT",8,0)
 ; ZEXCEPT: DFN,DRGRXN
"RTN","SYNFMEDT",9,0)
 N DA,DIK
"RTN","SYNFMEDT",10,0)
 S DRGRXN=313195
"RTN","SYNFMEDT",11,0)
 S DFN=1
"RTN","SYNFMEDT",12,0)
 N DRG S DRG=$$ADDDRUG^SYNFMED(DRGRXN) ; This finds it and also creates it; but normally it will be there from previous test runs
"RTN","SYNFMEDT",13,0)
 D KILLONEDRUG(DRG)
"RTN","SYNFMEDT",14,0)
 ;
"RTN","SYNFMEDT",15,0)
 ; Delete patient rx data
"RTN","SYNFMEDT",16,0)
 N DIU S DIU(0)="" ; Tell the pharmacy package that we are Fileman doing dirty cleanup work.
"RTN","SYNFMEDT",17,0)
 N PSOI F PSOI=0:0 S PSOI=$O(^PS(55,DFN,"P",PSOI)) Q:'PSOI  D
"RTN","SYNFMEDT",18,0)
 . N RXIEN S RXIEN=^PS(55,DFN,"P",PSOI,0)
"RTN","SYNFMEDT",19,0)
 . I $D(^PSRX(RXIEN,"OR1")) N ORNUM S ORNUM=$P(^("OR1"),U,2) S DA=ORNUM,DIK="^OR(100," D ^DIK
"RTN","SYNFMEDT",20,0)
 . S DIK="^PSRX(",DA=RXIEN D ^DIK
"RTN","SYNFMEDT",21,0)
 S DA=DFN,DIK="^PS(55," D ^DIK
"RTN","SYNFMEDT",22,0)
 ;
"RTN","SYNFMEDT",23,0)
 QUIT
"RTN","SYNFMEDT",24,0)
 ;
"RTN","SYNFMEDT",25,0)
SHUTDOWN ; M-Unit Shutdown
"RTN","SYNFMEDT",26,0)
 ; ZEXCEPT: DFN,DRGRXN
"RTN","SYNFMEDT",27,0)
 K DFN
"RTN","SYNFMEDT",28,0)
 K DRGRXN
"RTN","SYNFMEDT",29,0)
 QUIT
"RTN","SYNFMEDT",30,0)
 ;
"RTN","SYNFMEDT",31,0)
T0 ; @TEST Test $$ETSRXN2VUID^SYNFMED API
"RTN","SYNFMEDT",32,0)
 D CHKTF^%ut($$ETSRXN2VUID^SYNFMED(831533)["50.68~4031994~ERRIN 0.35MG TAB,28")
"RTN","SYNFMEDT",33,0)
 D CHKTF^%ut($$ETSRXN2VUID^SYNFMED(70618)["50.6~4019880~PENICILLIN")
"RTN","SYNFMEDT",34,0)
 D CHKTF^%ut($$ETSRXN2VUID^SYNFMED(198211)["50.68~4016607~SIMVASTATIN 40MG TAB,UD")
"RTN","SYNFMEDT",35,0)
 D CHKTF^%ut($$ETSRXN2VUID^SYNFMED(313195)["50.68~4004891~TAMOXIFEN CITRATE 20MG TAB")
"RTN","SYNFMEDT",36,0)
 D CHKTF^%ut($$ETSRXN2VUID^SYNFMED(1009219)["50.6~4030995~ALISKIREN/AMLODIPINE")
"RTN","SYNFMEDT",37,0)
 D CHKTF^%ut($$ETSRXN2VUID^SYNFMED(309110)["50.68~4007024~CEPHALEXIN 125MG/5ML SUSP")
"RTN","SYNFMEDT",38,0)
 D CHKTF^%ut($$ETSRXN2VUID^SYNFMED(2231)["50.6~4018891~CEPHALEXIN")
"RTN","SYNFMEDT",39,0)
 D CHKTF^%ut($$ETSRXN2VUID^SYNFMED(10582)["50.6~4022126~LEVOTHYROXINE")
"RTN","SYNFMEDT",40,0)
 QUIT
"RTN","SYNFMEDT",41,0)
 ;
"RTN","SYNFMEDT",42,0)
T1 ; @TEST Test get VUIDs
"RTN","SYNFMEDT",43,0)
 D CHKTF^%ut($$RXN2VUI^SYNFMED(1014675)[4033356)
"RTN","SYNFMEDT",44,0)
 D CHKTF^%ut($$RXN2VUI^SYNFMED(197379)[4014051)
"RTN","SYNFMEDT",45,0)
 QUIT
"RTN","SYNFMEDT",46,0)
 ;
"RTN","SYNFMEDT",47,0)
T2 ; @TEST Get Local Matches for VUID (no actual tests as drug file is local)
"RTN","SYNFMEDT",48,0)
 W " "
"RTN","SYNFMEDT",49,0)
 W $$MATCHV1^SYNFMED(4004876)," "
"RTN","SYNFMEDT",50,0)
 W $$MATCHV1^SYNFMED(4033365)," "
"RTN","SYNFMEDT",51,0)
 W $$MATCHV1^SYNFMED(4014051)," "
"RTN","SYNFMEDT",52,0)
 D SUCCEED^%ut
"RTN","SYNFMEDT",53,0)
 QUIT
"RTN","SYNFMEDT",54,0)
 ;
"RTN","SYNFMEDT",55,0)
T3 ; @TEST Get Local Matches for RxNorm (no actual tests as drug file is local)
"RTN","SYNFMEDT",56,0)
 W $$RXN2MEDS^SYNFMED(1014675)," " ; Ceterizine capsule
"RTN","SYNFMEDT",57,0)
 W $$RXN2MEDS^SYNFMED(197379)," "  ; Atenolol 100
"RTN","SYNFMEDT",58,0)
 W $$RXN2MEDS^SYNFMED(1085640)," " ;  Triamcinolone Acetonide 0.005 MG/MG Topical Ointment
"RTN","SYNFMEDT",59,0)
 D SUCCEED^%ut
"RTN","SYNFMEDT",60,0)
 QUIT
"RTN","SYNFMEDT",61,0)
 ;
"RTN","SYNFMEDT",62,0)
T4 ; @TEST Write Rx Using Drug IEN
"RTN","SYNFMEDT",63,0)
 ; ZEXCEPT: DFN,DRGRXN
"RTN","SYNFMEDT",64,0)
 N DA,DIK
"RTN","SYNFMEDT",65,0)
 N DRUG S DRUG=$$ADDDRUG^SYNFMED(DRGRXN)
"RTN","SYNFMEDT",66,0)
 N RXN S RXN=$$WRITERXPS^SYNFMED(DFN,DRUG,DT)
"RTN","SYNFMEDT",67,0)
 N RXIEN S RXIEN=$$FIND1^DIC(52,,"QX",RXN,"B")
"RTN","SYNFMEDT",68,0)
 N RX0 S RX0=^PSRX(RXIEN,0)
"RTN","SYNFMEDT",69,0)
 N PAT S PAT=$P(RX0,U,2)
"RTN","SYNFMEDT",70,0)
 N DRG S DRG=$P(RX0,U,6)
"RTN","SYNFMEDT",71,0)
 D CHKEQ^%ut(PAT,1,"Patient is not correct")
"RTN","SYNFMEDT",72,0)
 D CHKEQ^%ut(DRG,DRUG,"Drug is not correct")
"RTN","SYNFMEDT",73,0)
 D CHKTF^%ut($O(^PSRX(RXIEN,"L",0)),"Label does not exist")
"RTN","SYNFMEDT",74,0)
 D CHKTF^%ut($$GET1^DIQ(52,RXIEN,"RELEASED DATE/TIME","I"),"Release date/time doesn't exist")
"RTN","SYNFMEDT",75,0)
 QUIT
"RTN","SYNFMEDT",76,0)
 ;
"RTN","SYNFMEDT",77,0)
T5 ; @TEST Write Rx Using Drug RxNorm SCD
"RTN","SYNFMEDT",78,0)
 ; ZEXCEPT: DFN,DRGRXN
"RTN","SYNFMEDT",79,0)
 N RXN S RXN=$$WRITERXRXN^SYNFMED(DFN,DRGRXN,DT) ; Tamoxifen Citrate 20mg tab
"RTN","SYNFMEDT",80,0)
 N RXIEN S RXIEN=$$FIND1^DIC(52,,"QX",RXN,"B")
"RTN","SYNFMEDT",81,0)
 N RX0 S RX0=^PSRX(RXIEN,0)
"RTN","SYNFMEDT",82,0)
 N PAT S PAT=$P(RX0,U,2)
"RTN","SYNFMEDT",83,0)
 N DRG S DRG=$P(RX0,U,6)
"RTN","SYNFMEDT",84,0)
 N DRGNM S DRGNM=$P(^PSDRUG(DRG,0),U)
"RTN","SYNFMEDT",85,0)
 D CHKEQ^%ut(PAT,1,"Patient is not correct")
"RTN","SYNFMEDT",86,0)
 D CHKTF^%ut(DRGNM["TAMOXIFEN","Drug is not correct")
"RTN","SYNFMEDT",87,0)
 D CHKTF^%ut($O(^PSRX(RXIEN,"L",0)),"Label does not exist")
"RTN","SYNFMEDT",88,0)
 D CHKTF^%ut($$GET1^DIQ(52,RXIEN,"RELEASED DATE/TIME","I"),"Release date/time doesn't exist")
"RTN","SYNFMEDT",89,0)
 QUIT
"RTN","SYNFMEDT",90,0)
 ;
"RTN","SYNFMEDT",91,0)
T55 ; @TEST Write an Rx with a bad Rxnorm number
"RTN","SYNFMEDT",92,0)
 ; ZEXCEPT: DFN,DRGRXN
"RTN","SYNFMEDT",93,0)
 N RXN S RXN=$$WRITERXRXN^SYNFMED(DFN,989892842342,DT) ; Tamoxifen Citrate 20mg tab
"RTN","SYNFMEDT",94,0)
 D CHKTF^%ut(RXN<0)
"RTN","SYNFMEDT",95,0)
 QUIT
"RTN","SYNFMEDT",96,0)
 ;
"RTN","SYNFMEDT",97,0)
T56 ; @TEST Write an Rx with no NDCs on the market
"RTN","SYNFMEDT",98,0)
 ; ZEXCEPT: DFN,DRGRXN
"RTN","SYNFMEDT",99,0)
 N RXN S RXN=$$WRITERXRXN^SYNFMED(DFN,282464,DT) ; Acetaminophen 160 MG Oral Tablet
"RTN","SYNFMEDT",100,0)
 D CHKTF^%ut(RXN>0)
"RTN","SYNFMEDT",101,0)
 QUIT
"RTN","SYNFMEDT",102,0)
 ;
"RTN","SYNFMEDT",103,0)
T57 ; @TEST Write an Rx with mulitple matches for drug
"RTN","SYNFMEDT",104,0)
 ; doesn't cause a crash on my system, but here for George and company to test
"RTN","SYNFMEDT",105,0)
 ; ZEXCEPT: DFN,DRGRXN
"RTN","SYNFMEDT",106,0)
 N RXN S RXN=$$WRITERXRXN^SYNFMED(DFN,313782,DT) ; Acetaminophen 325 MG Oral Tablet
"RTN","SYNFMEDT",107,0)
 D CHKTF^%ut(RXN>0)
"RTN","SYNFMEDT",108,0)
 QUIT
"RTN","SYNFMEDT",109,0)
 ;
"RTN","SYNFMEDT",110,0)
T58 ; @TEST Write an Rx with Lirugatide (RXN # 897122)
"RTN","SYNFMEDT",111,0)
 ; ZEXCEPT: DFN,DRGRXN
"RTN","SYNFMEDT",112,0)
 N RXN S RXN=$$WRITERXRXN^SYNFMED(DFN,897122,DT) ; Acetaminophen 325 MG Oral Tablet
"RTN","SYNFMEDT",113,0)
 D CHKTF^%ut(RXN>0)
"RTN","SYNFMEDT",114,0)
 QUIT
"RTN","SYNFMEDT",115,0)
VUI2VAPT ; @TEST Get VA Product IEN from VUID
"RTN","SYNFMEDT",116,0)
 N L F L=1:1 N LN S LN=$T(VUI2VAPD+L) Q:LN["<<END>>"  Q:LN=""  D
"RTN","SYNFMEDT",117,0)
 . N VUID S VUID=$P(LN,";",3)
"RTN","SYNFMEDT",118,0)
 . N VAP S VAP=$P(LN,";",4)
"RTN","SYNFMEDT",119,0)
 . D CHKEQ^%ut($$VUI2VAP^SYNFMED(VUID),VAP,"Translation from VUID to VA PRODUCT failed")
"RTN","SYNFMEDT",120,0)
 QUIT
"RTN","SYNFMEDT",121,0)
 ;
"RTN","SYNFMEDT",122,0)
VUI2VAPD ; @DATA - Data for above test
"RTN","SYNFMEDT",123,0)
 ;;4006455;5932
"RTN","SYNFMEDT",124,0)
 ;;4002369;1784
"RTN","SYNFMEDT",125,0)
 ;;4000874;252
"RTN","SYNFMEDT",126,0)
 ;;4003335;2756
"RTN","SYNFMEDT",127,0)
 ;;4002469;1884
"RTN","SYNFMEDT",128,0)
 ;;4009488;9046^10090
"RTN","SYNFMEDT",129,0)
 ;;<<END>>
"RTN","SYNFMEDT",130,0)
 ;
"RTN","SYNFMEDT",131,0)
T6 ; @TEST Get NDCs for a drug
"RTN","SYNFMEDT",132,0)
 D CHKTF^%ut($$RXN2NDC^SYNFMED(198211)["16252050890")
"RTN","SYNFMEDT",133,0)
 QUIT
"RTN","SYNFMEDT",134,0)
 ;
"RTN","SYNFMEDT",135,0)
T7 ; @TEST Analysis of meds that don't load
"RTN","SYNFMEDT",136,0)
 N I,T F I=1:1 S T=$T(T7L+I),T=$P(T,";;",2) Q:T=""  D
"RTN","SYNFMEDT",137,0)
 . N SCD S SCD=$$ETSCONV^SYNFMED(T)
"RTN","SYNFMEDT",138,0)
 . I 'SCD QUIT
"RTN","SYNFMEDT",139,0)
 . N % S %=$$GETDATA^ETSRXN(SCD)
"RTN","SYNFMEDT",140,0)
 . D CHKTF^%ut(%)
"RTN","SYNFMEDT",141,0)
 . D CHKTF^%ut($$ETSISSCD^SYNFMED(SCD)!$$ETSISBPCK^SYNFMED(SCD))
"RTN","SYNFMEDT",142,0)
 QUIT
"RTN","SYNFMEDT",143,0)
 ;
"RTN","SYNFMEDT",144,0)
T7L ; @DATA
"RTN","SYNFMEDT",145,0)
 ;;239981
"RTN","SYNFMEDT",146,0)
 ;;308056
"RTN","SYNFMEDT",147,0)
 ;;389128
"RTN","SYNFMEDT",148,0)
 ;;392151
"RTN","SYNFMEDT",149,0)
 ;;564666
"RTN","SYNFMEDT",150,0)
 ;;568530
"RTN","SYNFMEDT",151,0)
 ;;573839
"RTN","SYNFMEDT",152,0)
 ;;575020
"RTN","SYNFMEDT",153,0)
 ;;575971
"RTN","SYNFMEDT",154,0)
 ;;596927
"RTN","SYNFMEDT",155,0)
 ;;602735
"RTN","SYNFMEDT",156,0)
 ;;607015
"RTN","SYNFMEDT",157,0)
 ;;608680
"RTN","SYNFMEDT",158,0)
 ;;617944
"RTN","SYNFMEDT",159,0)
 ;;646250
"RTN","SYNFMEDT",160,0)
 ;;727316
"RTN","SYNFMEDT",161,0)
 ;;727374
"RTN","SYNFMEDT",162,0)
 ;;824184
"RTN","SYNFMEDT",163,0)
 ;;831533
"RTN","SYNFMEDT",164,0)
 ;;834060
"RTN","SYNFMEDT",165,0)
 ;;834101
"RTN","SYNFMEDT",166,0)
 ;;849437
"RTN","SYNFMEDT",167,0)
 ;;849727
"RTN","SYNFMEDT",168,0)
 ;;896188
"RTN","SYNFMEDT",169,0)
 ;;904420
"RTN","SYNFMEDT",170,0)
 ;;996741
"RTN","SYNFMEDT",171,0)
 ;;997221
"RTN","SYNFMEDT",172,0)
 ;;1000128
"RTN","SYNFMEDT",173,0)
 ;;1000158
"RTN","SYNFMEDT",174,0)
 ;;1020137
"RTN","SYNFMEDT",175,0)
 ;;1049544
"RTN","SYNFMEDT",176,0)
 ;;1049639
"RTN","SYNFMEDT",177,0)
 ;;1091166
"RTN","SYNFMEDT",178,0)
 ;;1094108
"RTN","SYNFMEDT",179,0)
 ;;1111011
"RTN","SYNFMEDT",180,0)
 ;;1359133
"RTN","SYNFMEDT",181,0)
 ;;1366342
"RTN","SYNFMEDT",182,0)
 ;;1536586
"RTN","SYNFMEDT",183,0)
 ;;1602593
"RTN","SYNFMEDT",184,0)
 ;;1648767
"RTN","SYNFMEDT",185,0)
 ;;1803932
"RTN","SYNFMEDT",186,0)
 ;;
"RTN","SYNFMEDT",187,0)
T8 ; @TEST Add drugs for patients from T7L
"RTN","SYNFMEDT",188,0)
 ; ZEXCEPT: DFN,DRGRXN
"RTN","SYNFMEDT",189,0)
 N SYNI,SYNT F SYNI=1:1 S SYNT=$T(T7L+SYNI),SYNT=$P(SYNT,";;",2) Q:SYNT=""  D
"RTN","SYNFMEDT",190,0)
 . ; W SYNT," "
"RTN","SYNFMEDT",191,0)
 . N RXN S RXN=$$WRITERXRXN^SYNFMED(DFN,SYNT,DT)
"RTN","SYNFMEDT",192,0)
 . ; W RXN,!
"RTN","SYNFMEDT",193,0)
 . D CHKTF^%ut(RXN>0)
"RTN","SYNFMEDT",194,0)
 QUIT
"RTN","SYNFMEDT",195,0)
 ;
"RTN","SYNFMEDT",196,0)
KILLDRUG ; [Public] Remove all Drug Data
"RTN","SYNFMEDT",197,0)
 ; WARNING: DO NOT CALL THIS UNLESS YOU ARE ON A BRAND NEW SYSTEM AND ARE TESTING.
"RTN","SYNFMEDT",198,0)
 D DT^DICRW ; Min FM Vars
"RTN","SYNFMEDT",199,0)
 D MES^XPDUTL("Killing Drug (50)") D DRUG
"RTN","SYNFMEDT",200,0)
 D MES^XPDUTL("Killing Pharmacy Orderable Item (OI) (50.7)") D PO
"RTN","SYNFMEDT",201,0)
 D MES^XPDUTL("Killing Drug Text (51.7)") D DRUGTEXT
"RTN","SYNFMEDT",202,0)
 D MES^XPDUTL("Killing IV Additives (52.6)") D IVADD
"RTN","SYNFMEDT",203,0)
 D MES^XPDUTL("Killing IV Solutions (52.7)") D IVSOL
"RTN","SYNFMEDT",204,0)
 D MES^XPDUTL("Killing Drug Electrolytes (50.4)") D DRUGELEC
"RTN","SYNFMEDT",205,0)
 D MES^XPDUTL("Removing Pharmacy OIs from the Orderable Item (101.43)") D O
"RTN","SYNFMEDT",206,0)
 D MES^XPDUTL("Syncing the Order Quick View (101.44)") D CPRS
"RTN","SYNFMEDT",207,0)
 QUIT
"RTN","SYNFMEDT",208,0)
 ;
"RTN","SYNFMEDT",209,0)
KILLONEDRUG(DRG) ; [Public] Kill just one drug
"RTN","SYNFMEDT",210,0)
 ; Called by the Unit Test
"RTN","SYNFMEDT",211,0)
 ;
"RTN","SYNFMEDT",212,0)
 ; Get OI
"RTN","SYNFMEDT",213,0)
 N DIK,DA
"RTN","SYNFMEDT",214,0)
 N OI S OI=+^PSDRUG(DRG,2)
"RTN","SYNFMEDT",215,0)
 ;
"RTN","SYNFMEDT",216,0)
 ; Delete drug
"RTN","SYNFMEDT",217,0)
 S DA=DRG,DIK="^PSDRUG(" D ^DIK
"RTN","SYNFMEDT",218,0)
 I 'OI QUIT
"RTN","SYNFMEDT",219,0)
 ;
"RTN","SYNFMEDT",220,0)
 ; Delete OI
"RTN","SYNFMEDT",221,0)
 S DA=OI,DIK="^PS(50.7," D ^DIK
"RTN","SYNFMEDT",222,0)
 ;
"RTN","SYNFMEDT",223,0)
 ; Delete CPRS synced version of OI
"RTN","SYNFMEDT",224,0)
 N OERROI S OERROI=$O(^ORD(101.43,"ID",OI_";99PSP",""))
"RTN","SYNFMEDT",225,0)
 I OERROI S DIK="^ORD(101.43,",DA=OERROI D ^DIK
"RTN","SYNFMEDT",226,0)
 ;
"RTN","SYNFMEDT",227,0)
 ; Update CPRS view of pharmacy OIs
"RTN","SYNFMEDT",228,0)
 D CPRS
"RTN","SYNFMEDT",229,0)
 QUIT
"RTN","SYNFMEDT",230,0)
 ;
"RTN","SYNFMEDT",231,0)
RESTOCK ; [Public] Restock CPRS Orderable Items from new Drug & Pharmacy Orderable Item
"RTN","SYNFMEDT",232,0)
 ; File. Public Entry Point.
"RTN","SYNFMEDT",233,0)
 ; Call this after repopulating the drug file (50) and the pharmacy orderable
"RTN","SYNFMEDT",234,0)
 ; item file (50.7)
"RTN","SYNFMEDT",235,0)
 N PSOIEN ; Looper variable
"RTN","SYNFMEDT",236,0)
 D DT^DICRW ; Establish FM Basic Variables
"RTN","SYNFMEDT",237,0)
 ;
"RTN","SYNFMEDT",238,0)
 ; Loop through Orderable Item file and call
"RTN","SYNFMEDT",239,0)
 ; 1. The Active/Inactive Updater for the Orderable Item
"RTN","SYNFMEDT",240,0)
 ; 2. the protocol file updater to CPRS Files
"RTN","SYNFMEDT",241,0)
 S PSOIEN=0 F  S PSOIEN=$O(^PS(50.7,PSOIEN)) Q:'PSOIEN  D
"RTN","SYNFMEDT",242,0)
 . D MES^XPDUTL("Syncing Pharamcy Orderable Item "_PSOIEN)
"RTN","SYNFMEDT",243,0)
 . D EN^PSSPOIDT(PSOIEN),EN2^PSSHL1(PSOIEN,"MUP")
"RTN","SYNFMEDT",244,0)
 D CPRS ; Update Orderable Item View files
"RTN","SYNFMEDT",245,0)
 QUIT
"RTN","SYNFMEDT",246,0)
 ;
"RTN","SYNFMEDT",247,0)
 ; -- END Public Entry Points --
"RTN","SYNFMEDT",248,0)
 ;
"RTN","SYNFMEDT",249,0)
 ; -- The rest is private --
"RTN","SYNFMEDT",250,0)
DRUG ; Kill Drug File; Private
"RTN","SYNFMEDT",251,0)
 N DA,DIK
"RTN","SYNFMEDT",252,0)
 S DIK="^PSDRUG("
"RTN","SYNFMEDT",253,0)
 F DA=0:0 S DA=$O(^PSDRUG(DA)) Q:'DA  D ^DIK
"RTN","SYNFMEDT",254,0)
 S $P(^PSDRUG(0),U,3,4)=""
"RTN","SYNFMEDT",255,0)
 K ^DIA(50)
"RTN","SYNFMEDT",256,0)
 QUIT
"RTN","SYNFMEDT",257,0)
 ;
"RTN","SYNFMEDT",258,0)
PO ; Kill Pharmacy Orderable Items; Private
"RTN","SYNFMEDT",259,0)
 N %1 S %1=^PS(50.7,0)
"RTN","SYNFMEDT",260,0)
 K ^PS(50.7)
"RTN","SYNFMEDT",261,0)
 S ^PS(50.7,0)=%1
"RTN","SYNFMEDT",262,0)
 S $P(^PS(50.7,0),"^",3,4)=""
"RTN","SYNFMEDT",263,0)
 QUIT
"RTN","SYNFMEDT",264,0)
 ;
"RTN","SYNFMEDT",265,0)
DRUGTEXT ; Kill Drug Text Entries ; Private
"RTN","SYNFMEDT",266,0)
 N %1 S %1=^PS(51.7,0)
"RTN","SYNFMEDT",267,0)
 K ^PS(51.7)
"RTN","SYNFMEDT",268,0)
 S ^PS(51.7,0)=%1
"RTN","SYNFMEDT",269,0)
 S $P(^PS(51.7,0),"^",3,4)=""
"RTN","SYNFMEDT",270,0)
 QUIT
"RTN","SYNFMEDT",271,0)
 ;
"RTN","SYNFMEDT",272,0)
IVADD ; Kill IV Additives ; Private
"RTN","SYNFMEDT",273,0)
 N %1 S %1=^PS(52.6,0)
"RTN","SYNFMEDT",274,0)
 K ^PS(52.6)
"RTN","SYNFMEDT",275,0)
 S ^PS(52.6,0)=%1
"RTN","SYNFMEDT",276,0)
 S $P(^PS(52.6,0),"^",3,4)=""
"RTN","SYNFMEDT",277,0)
 QUIT
"RTN","SYNFMEDT",278,0)
 ;
"RTN","SYNFMEDT",279,0)
IVSOL ; Kill IV Solutions ; Private
"RTN","SYNFMEDT",280,0)
 N %1 S %1=^PS(52.7,0)
"RTN","SYNFMEDT",281,0)
 K ^PS(52.7)
"RTN","SYNFMEDT",282,0)
 S ^PS(52.7,0)=%1
"RTN","SYNFMEDT",283,0)
 S $P(^PS(52.7,0),"^",3,4)=""
"RTN","SYNFMEDT",284,0)
 QUIT
"RTN","SYNFMEDT",285,0)
 ;
"RTN","SYNFMEDT",286,0)
DRUGELEC ; Kill Drug Electrolytes ; Private
"RTN","SYNFMEDT",287,0)
 N %1 S %1=^PS(50.4,0)
"RTN","SYNFMEDT",288,0)
 K ^PS(50.4)
"RTN","SYNFMEDT",289,0)
 S ^PS(50.4,0)=%1
"RTN","SYNFMEDT",290,0)
 S $P(^PS(50.4,0),"^",3,4)=""
"RTN","SYNFMEDT",291,0)
 QUIT
"RTN","SYNFMEDT",292,0)
 ;
"RTN","SYNFMEDT",293,0)
O ; Kill off Pharamcy Order Items (Only!) in the Orderable Item file; Private
"RTN","SYNFMEDT",294,0)
 N DA ; Used in For loop below
"RTN","SYNFMEDT",295,0)
 N DIK S DIK="^ORD(101.43,"
"RTN","SYNFMEDT",296,0)
 N I S I=0
"RTN","SYNFMEDT",297,0)
 FOR  S I=$O(^ORD(101.43,"ID",I)) QUIT:I=""  DO
"RTN","SYNFMEDT",298,0)
 . I I["PSP" S DA=$O(^ORD(101.43,"ID",I,"")) D ^DIK
"RTN","SYNFMEDT",299,0)
 QUIT
"RTN","SYNFMEDT",300,0)
 ;
"RTN","SYNFMEDT",301,0)
CPRS ; Now, update the CPRS lists (sync with Orderable Item file) -
"RTN","SYNFMEDT",302,0)
 ; Uses a CPRS API to do this; Private
"RTN","SYNFMEDT",303,0)
 ; Next 3 variables are required as inputs
"RTN","SYNFMEDT",304,0)
 N ATTEMPT S ATTEMPT=0 ; Attempt to Update
"RTN","SYNFMEDT",305,0)
 N UPDTIME S UPDTIME=$HOROLOG ; Update Time
"RTN","SYNFMEDT",306,0)
 N DGNM ; Dialog Name
"RTN","SYNFMEDT",307,0)
 ; IVA RX -> Additives; IVB RX -> Solutions
"RTN","SYNFMEDT",308,0)
 ; IVM RX -> Inpatient Meds for Outpatients
"RTN","SYNFMEDT",309,0)
 ; NV RX -> Non-VA Meds ; O RX -> Outpatient
"RTN","SYNFMEDT",310,0)
 ; UD RX -> Unit Dose
"RTN","SYNFMEDT",311,0)
 FOR DGNM="IVA RX","IVB RX","IVM RX","NV RX","O RX","UD RX" DO
"RTN","SYNFMEDT",312,0)
 . D MES^XPDUTL(" --> Rebuilding "_DGNM)
"RTN","SYNFMEDT",313,0)
 . D FVBLD^ORWUL
"RTN","SYNFMEDT",314,0)
 QUIT
"RTN","SYNFMEDT",315,0)
 ;
"RTN","SYNFPAT")
0^35^B132681980
"RTN","SYNFPAT",1,0)
SYNFPAT ;ven/gpl - fhir loader utilities ;2018-05-08  4:18 PM
"RTN","SYNFPAT",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNFPAT",3,0)
 ;
"RTN","SYNFPAT",4,0)
 ; Authored by George P. Lilly 2017-2018
"RTN","SYNFPAT",5,0)
 ;
"RTN","SYNFPAT",6,0)
 q
"RTN","SYNFPAT",7,0)
 ;
"RTN","SYNFPAT",8,0)
importPatient(rtn,ien) ; register and import a fhir patient (demographics only)
"RTN","SYNFPAT",9,0)
 ;
"RTN","SYNFPAT",10,0)
 if $get(ien)="" quit
"RTN","SYNFPAT",11,0)
 new fhir
"RTN","SYNFPAT",12,0)
 do getIntakeFhir^SYNFHIR("fhir",,"Patient",ien)
"RTN","SYNFPAT",13,0)
 ;
"RTN","SYNFPAT",14,0)
 ; set up logging and parameter area
"RTN","SYNFPAT",15,0)
 ;
"RTN","SYNFPAT",16,0)
 new PLD merge PLD=@$$setPLD^SYNFUTL(ien,"Patient")
"RTN","SYNFPAT",17,0)
 new parms set parms=PLD("parms") ; global name of where to put the parms
"RTN","SYNFPAT",18,0)
 ;
"RTN","SYNFPAT",19,0)
 if $g(@PLD("status")@("loadStatus"))="loaded" do  quit  ;
"RTN","SYNFPAT",20,0)
 . new zdfn s zdfn=$g(@PLD("status")@("DFN"))
"RTN","SYNFPAT",21,0)
 . do log^SYNFUTL("Patient "_ien_" already loaded DFN= "_zdfn)
"RTN","SYNFPAT",22,0)
 . set rtn("loadStatus")="already loaded"
"RTN","SYNFPAT",23,0)
 . set rtn("dfn")=zdfn
"RTN","SYNFPAT",24,0)
 ;
"RTN","SYNFPAT",25,0)
 kill @PLD("parms")
"RTN","SYNFPAT",26,0)
 kill @PLD("log")
"RTN","SYNFPAT",27,0)
 ;
"RTN","SYNFPAT",28,0)
 do log^SYNFUTL("Patient load begins for fhirien= "_ien)
"RTN","SYNFPAT",29,0)
 ;
"RTN","SYNFPAT",30,0)
 ; name
"RTN","SYNFPAT",31,0)
 ;
"RTN","SYNFPAT",32,0)
 new patname
"RTN","SYNFPAT",33,0)
 set patname=$$patname("fhir") 
"RTN","SYNFPAT",34,0)
 if patname'="" do  ;
"RTN","SYNFPAT",35,0)
 . set @parms@("NAME")=patname
"RTN","SYNFPAT",36,0)
 . do log^SYNFUTL("Patient name is: "_patname)
"RTN","SYNFPAT",37,0)
 else  do log^SYNFUTL("Patient Name Error")
"RTN","SYNFPAT",38,0)
 ; need to find the entry for the Patient resource
"RTN","SYNFPAT",39,0)
 ;
"RTN","SYNFPAT",40,0)
 n zntry s zntry=$o(fhir("Patient","entry",""))
"RTN","SYNFPAT",41,0)
 ;
"RTN","SYNFPAT",42,0)
 ;
"RTN","SYNFPAT",43,0)
 ; gender
"RTN","SYNFPAT",44,0)
 ;
"RTN","SYNFPAT",45,0)
 new psex
"RTN","SYNFPAT",46,0)
 set psex=$get(fhir("Patient","entry",zntry,"resource","gender"))
"RTN","SYNFPAT",47,0)
 if psex'="" do  ;
"RTN","SYNFPAT",48,0)
 . do log^SYNFUTL("Patient gender is: "_psex)
"RTN","SYNFPAT",49,0)
 . set @parms@("SEX")=$select(psex="male":"M",psex="female":"F",1:"F")
"RTN","SYNFPAT",50,0)
 else  do log^SYNFUTL("Patient gender not found")
"RTN","SYNFPAT",51,0)
 ;
"RTN","SYNFPAT",52,0)
 ; date of birth
"RTN","SYNFPAT",53,0)
 ;
"RTN","SYNFPAT",54,0)
 new dob
"RTN","SYNFPAT",55,0)
 set dob=$get(fhir("Patient","entry",zntry,"resource","birthDate"))
"RTN","SYNFPAT",56,0)
 if dob'="" do  ;
"RTN","SYNFPAT",57,0)
 . new X,Y
"RTN","SYNFPAT",58,0)
 . set X=dob
"RTN","SYNFPAT",59,0)
 . do ^%DT
"RTN","SYNFPAT",60,0)
 . if Y=-1 do log^SYNFUTL("Patient date of birth error "_dob) quit  ;
"RTN","SYNFPAT",61,0)
 . set @parms@("DOB")=Y
"RTN","SYNFPAT",62,0)
 else  do log^SYNFUTL("Patient date of birth error "_dob)
"RTN","SYNFPAT",63,0)
 ;
"RTN","SYNFPAT",64,0)
 ; id - fhir id, not ICN
"RTN","SYNFPAT",65,0)
 ;
"RTN","SYNFPAT",66,0)
 new pid
"RTN","SYNFPAT",67,0)
 set pid=$get(fhir("Patient","entry",zntry,"resource","id"))
"RTN","SYNFPAT",68,0)
 if pid="" s pid=$get(fhir("Patient","entry",zntry,"resource","identifier",1,"value"))
"RTN","SYNFPAT",69,0)
 if pid="" do log^SYNFUTL("Patient ID is missing")
"RTN","SYNFPAT",70,0)
 else  do  ;
"RTN","SYNFPAT",71,0)
 . set @parms@("ID")=pid
"RTN","SYNFPAT",72,0)
 . do log^SYNFUTL("Patient ID is "_pid)
"RTN","SYNFPAT",73,0)
 ;
"RTN","SYNFPAT",74,0)
 ; ethnicity code
"RTN","SYNFPAT",75,0)
 ;
"RTN","SYNFPAT",76,0)
 do INITMAPS^SYNQLDM
"RTN","SYNFPAT",77,0)
 new eary,ecd
"RTN","SYNFPAT",78,0)
 ;do adb^SYNFUTL("eary","fhir","text","ethnicity") ; array defined by 
"RTN","SYNFPAT",79,0)
 ;set ecd=$get(eary("coding",1,"code")) ; the ethnic code
"RTN","SYNFPAT",80,0)
 set ecd=$$deriveCode("fhir","us-core-ethnicity",zntry)
"RTN","SYNFPAT",81,0)
 if ecd'="" d  ;
"RTN","SYNFPAT",82,0)
 . do log^SYNFUTL("Ethnicity code is "_ecd)
"RTN","SYNFPAT",83,0)
 . new ecdn
"RTN","SYNFPAT",84,0)
 . set ecdn=$$MAP^SYNQLDM(ecd)
"RTN","SYNFPAT",85,0)
 . if ecdn="" do  quit  ;
"RTN","SYNFPAT",86,0)
 . . do log^SYNFUTL("Ethnicity code "_ecd_" does not map")
"RTN","SYNFPAT",87,0)
 . set @parms@("ETHNICITY")=ecdn
"RTN","SYNFPAT",88,0)
 else  do log^SYNFUTL("Ethnicity code missing")
"RTN","SYNFPAT",89,0)
 ;
"RTN","SYNFPAT",90,0)
 ; race code
"RTN","SYNFPAT",91,0)
 ;
"RTN","SYNFPAT",92,0)
 new rary,rcd
"RTN","SYNFPAT",93,0)
 ;do adb^SYNFUTL("rary","fhir","text","race") ; array defined by 
"RTN","SYNFPAT",94,0)
 ;set rcd=$get(rary("coding",1,"code")) ; the ethnic code
"RTN","SYNFPAT",95,0)
 set rcd=$$deriveCode("fhir","us-core-race",zntry)
"RTN","SYNFPAT",96,0)
 if rcd'="" d  ;
"RTN","SYNFPAT",97,0)
 . do log^SYNFUTL("Race code is "_rcd)
"RTN","SYNFPAT",98,0)
 . new rcdn
"RTN","SYNFPAT",99,0)
 . set rcdn=$$MAP^SYNQLDM(rcd)
"RTN","SYNFPAT",100,0)
 . if rcdn="" do  quit  ;
"RTN","SYNFPAT",101,0)
 . . do log^SYNFUTL("Race code "_rcd_" does not map")
"RTN","SYNFPAT",102,0)
 . set @parms@("RACE")=rcdn
"RTN","SYNFPAT",103,0)
 else  do log^SYNFUTL("Race code missing")
"RTN","SYNFPAT",104,0)
 ;
"RTN","SYNFPAT",105,0)
 ; address
"RTN","SYNFPAT",106,0)
 ;
"RTN","SYNFPAT",107,0)
 s @parms@("CITY")=$g(fhir("Patient","entry",zntry,"resource","address",1,"city"))
"RTN","SYNFPAT",108,0)
 s @parms@("STATE")=$g(fhir("Patient","entry",zntry,"resource","address",1,"state"))
"RTN","SYNFPAT",109,0)
 s @parms@("ZIP")=$g(fhir("Patient","entry",zntry,"resource","address",1,"postalCode"))
"RTN","SYNFPAT",110,0)
 s @parms@("STREET_ADD1")=$g(fhir("Patient","entry",zntry,"resource","address",1,"line",1))
"RTN","SYNFPAT",111,0)
 s @parms@("PH_NUM")=$g(fhir("Patient","entry",zntry,"resource","telecom",1,"value"))
"RTN","SYNFPAT",112,0)
 s @parms@("IMP_TYPE")="I" ; individual not batch load
"RTN","SYNFPAT",113,0)
 s @parms@("SSN")=$$patssn("fhir")
"RTN","SYNFPAT",114,0)
 s @parms@("MARITAL_STATUS")=$get(fhir("Patient","entry",zntry,"resource","maritalStatus","coding",1,"code"))
"RTN","SYNFPAT",115,0)
 ;
"RTN","SYNFPAT",116,0)
 ; call import routine
"RTN","SYNFPAT",117,0)
 ;
"RTN","SYNFPAT",118,0)
 n MISC
"RTN","SYNFPAT",119,0)
 m MISC=@parms
"RTN","SYNFPAT",120,0)
 n ISIRC s ISIRC=$$IMPORTPT^ISIIMP03(.MISC)
"RTN","SYNFPAT",121,0)
 d log^SYNFUTL("Called IMPORTPT^ISIIMP03 to import patient")
"RTN","SYNFPAT",122,0)
 d log^SYNFUTL("Return code from Import: "_ISIRC)
"RTN","SYNFPAT",123,0)
 d log^SYNFUTL("Return values from Import: "_$G(ISIRESUL(1)))
"RTN","SYNFPAT",124,0)
 i ISIRC="" do  quit  ;
"RTN","SYNFPAT",125,0)
 . d log^SYNFUTL("No return from patient load")
"RTN","SYNFPAT",126,0)
 . s rtn("status")="Patient load error"
"RTN","SYNFPAT",127,0)
 n zdfn s zdfn=0
"RTN","SYNFPAT",128,0)
 i $g(ISIRESUL(1))'="" s zdfn=$P(ISIRESUL(1),"^",1)
"RTN","SYNFPAT",129,0)
 ;
"RTN","SYNFPAT",130,0)
 ; load failed
"RTN","SYNFPAT",131,0)
 ;
"RTN","SYNFPAT",132,0)
 i +zdfn<1 d  q  ;
"RTN","SYNFPAT",133,0)
 . s rtn("loadStatus")="notLoaded"
"RTN","SYNFPAT",134,0)
 . s rtn("loadMessage")=ISIRC
"RTN","SYNFPAT",135,0)
 . s @PLD("status")@("loadStatus")="notLoaded"
"RTN","SYNFPAT",136,0)
 . s @PLD("status")@("loadMessage")=ISIRC
"RTN","SYNFPAT",137,0)
 ;
"RTN","SYNFPAT",138,0)
 ; load successful
"RTN","SYNFPAT",139,0)
 ;
"RTN","SYNFPAT",140,0)
 new icn set icn=$$newIcn2(zdfn,pid)
"RTN","SYNFPAT",141,0)
 if icn'=-1 s @PLD("status")@("ICN")=icn
"RTN","SYNFPAT",142,0)
 s @PLD("status")@("DFN")=zdfn
"RTN","SYNFPAT",143,0)
 s @PLD("status")@("loadStatus")="loaded"
"RTN","SYNFPAT",144,0)
 set @PLD("index")@("DFN",zdfn,ien)=""
"RTN","SYNFPAT",145,0)
 set @PLD("index")@("ICN",icn,ien)=""
"RTN","SYNFPAT",146,0)
 set @PLD("index")@(ien,"DFN",zdfn)=""
"RTN","SYNFPAT",147,0)
 set @PLD("index")@(ien,"ICN",icn)=""
"RTN","SYNFPAT",148,0)
 d setIndex^SYNFUTL(ien,"DFN",zdfn)
"RTN","SYNFPAT",149,0)
 d setIndex^SYNFUTL(ien,"ICN",icn)
"RTN","SYNFPAT",150,0)
 ;
"RTN","SYNFPAT",151,0)
 s rtn("dfn")=zdfn
"RTN","SYNFPAT",152,0)
 s rtn("loadStatus")="loaded" 
"RTN","SYNFPAT",153,0)
 if icn'=-1 s rtn("icn")=icn
"RTN","SYNFPAT",154,0)
 ;
"RTN","SYNFPAT",155,0)
 quit
"RTN","SYNFPAT",156,0)
 ;
"RTN","SYNFPAT",157,0)
deriveCode(zary,zname,zntry) ; finds the code for ethnicity and race
"RTN","SYNFPAT",158,0)
 ;
"RTN","SYNFPAT",159,0)
 n zary2,zdex,zz1,zurl,done,zcode
"RTN","SYNFPAT",160,0)
 s zcode=""
"RTN","SYNFPAT",161,0)
 s done=0
"RTN","SYNFPAT",162,0)
 s zzi=0
"RTN","SYNFPAT",163,0)
 f  s zzi=$o(@zary@("Patient","entry",zntry,"resource","extension",zzi)) q:+zzi=0  q:done  d  ;
"RTN","SYNFPAT",164,0)
 . s zurl=$g(@zary@("Patient","entry",zntry,"resource","extension",zzi,"url"))
"RTN","SYNFPAT",165,0)
 . i $$urlEnd^SYNFUTL(zurl)=zname d  ;
"RTN","SYNFPAT",166,0)
 . . m zary2=@zary@("Patient","entry",zntry,"resource","extension",zzi)
"RTN","SYNFPAT",167,0)
 . . d valueDex2^SYNFUTL("zary2","zdex")
"RTN","SYNFPAT",168,0)
 . . q:'$d(zdex)
"RTN","SYNFPAT",169,0)
 . . s zcode=$o(zdex("code",""))
"RTN","SYNFPAT",170,0)
 . . q:zcode=""
"RTN","SYNFPAT",171,0)
 . . s done=1
"RTN","SYNFPAT",172,0)
 q zcode
"RTN","SYNFPAT",173,0)
 ;
"RTN","SYNFPAT",174,0)
patname(ary) ; ary is passed by name
"RTN","SYNFPAT",175,0)
 new given,family
"RTN","SYNFPAT",176,0)
 n zntry s zntry=$o(@ary@("Patient","entry","")) ; which resource is the Patient
"RTN","SYNFPAT",177,0)
 ;
"RTN","SYNFPAT",178,0)
 ; Synthea patient resources are 1; new fhir Patient resources are 2
"RTN","SYNFPAT",179,0)
 ;
"RTN","SYNFPAT",180,0)
 set family=$get(@ary@("Patient","entry",zntry,"resource","name",1,"family"))
"RTN","SYNFPAT",181,0)
 set given=$get(@ary@("Patient","entry",zntry,"resource","name",1,"given",1))
"RTN","SYNFPAT",182,0)
 if family="" quit ""
"RTN","SYNFPAT",183,0)
 if given="" quit ""
"RTN","SYNFPAT",184,0)
 new X,Y
"RTN","SYNFPAT",185,0)
 set X=family
"RTN","SYNFPAT",186,0)
 x ^%ZOSF("UPPERCASE")
"RTN","SYNFPAT",187,0)
 set family=Y
"RTN","SYNFPAT",188,0)
 set X=given
"RTN","SYNFPAT",189,0)
 x ^%ZOSF("UPPERCASE")
"RTN","SYNFPAT",190,0)
 set given=Y
"RTN","SYNFPAT",191,0)
 ;
"RTN","SYNFPAT",192,0)
 quit family_","_given
"RTN","SYNFPAT",193,0)
 ;
"RTN","SYNFPAT",194,0)
patssn(fary) ; extrinsic returns the ssn of the patient extracted from
"RTN","SYNFPAT",195,0)
 ; the fhir array, passed by name
"RTN","SYNFPAT",196,0)
 new ssnref,tary,ssn
"RTN","SYNFPAT",197,0)
 ; set ssnref="http://standardhealthrecord.org/fhir/StructureDefinition/shr-demographics-SocialSecurityNumber-extension"
"RTN","SYNFPAT",198,0)
 set ssnref="http://hl7.org/fhir/sid/us-ssn"
"RTN","SYNFPAT",199,0)
 do adb^SYNFUTL("tary",fary,"system",ssnref) ; array defined by
"RTN","SYNFPAT",200,0)
 ;
"RTN","SYNFPAT",201,0)
 set ssn=$get(tary("value"))
"RTN","SYNFPAT",202,0)
 if ssn["-" set ssn=$tr(ssn,"-","")
"RTN","SYNFPAT",203,0)
 quit ssn
"RTN","SYNFPAT",204,0)
 ;
"RTN","SYNFPAT",205,0)
 ; sample patient fhir
"RTN","SYNFPAT",206,0)
 ;g("Patient","entry",1,"fullUrl")="urn:uuid:a13f2440-a3ec-419a-8259-82710d695fdf"
"RTN","SYNFPAT",207,0)
 ;g("Patient","entry",1,"resource","address",1,"city")="Fitchburg"
"RTN","SYNFPAT",208,0)
 ;g("Patient","entry",1,"resource","address",1,"country")="US"
"RTN","SYNFPAT",209,0)
 ;g("Patient","entry",1,"resource","address",1,"extension",1,"extension",1,"url")="latitude"
"RTN","SYNFPAT",210,0)
 ;g("Patient","entry",1,"resource","address",1,"extension",1,"extension",1,"valueDecimal")=42.562168065623744
"RTN","SYNFPAT",211,0)
 ;g("Patient","entry",1,"resource","address",1,"extension",1,"extension",2,"url")="longitude"
"RTN","SYNFPAT",212,0)
 ;g("Patient","entry",1,"resource","address",1,"extension",1,"extension",2,"valueDecimal")=-71.81748413047194
"RTN","SYNFPAT",213,0)
 ;g("Patient","entry",1,"resource","address",1,"extension",1,"url")="http://hl7.org/fhir/StructureDefinition/geolocation"
"RTN","SYNFPAT",214,0)
 ;g("Patient","entry",1,"resource","address",1,"line",1)="9802 Bosco Field"
"RTN","SYNFPAT",215,0)
 ;g("Patient","entry",1,"resource","address",1,"line",2)="Suite 454"
"RTN","SYNFPAT",216,0)
 ;g("Patient","entry",1,"resource","address",1,"postalCode")="01420"
"RTN","SYNFPAT",217,0)
 ;g("Patient","entry",1,"resource","address",1,"state")="MA"
"RTN","SYNFPAT",218,0)
 ;g("Patient","entry",1,"resource","birthDate")="1925-06-02"
"RTN","SYNFPAT",219,0)
 ;g("Patient","entry",1,"resource","communication",1,"language","coding",1,"code")="en-US"
"RTN","SYNFPAT",220,0)
 ;g("Patient","entry",1,"resource","communication",1,"language","coding",1,"display")="English (United States)"
"RTN","SYNFPAT",221,0)
 ;g("Patient","entry",1,"resource","communication",1,"language","coding",1,"system")="http://hl7.org/fhir/ValueSet/languages"
"RTN","SYNFPAT",222,0)
 ;g("Patient","entry",1,"resource","deceasedDateTime")="2002-10-08T06:31:48-04:00"
"RTN","SYNFPAT",223,0)
 ;g("Patient","entry",1,"resource","extension",1,"url")="http://hl7.org/fhir/us/core/StructureDefinition/us-core-race"
"RTN","SYNFPAT",224,0)
 ;g("Patient","entry",1,"resource","extension",1,"valueCodeableConcept","coding",1,"code")="2106-3"
"RTN","SYNFPAT",225,0)
 ;g("Patient","entry",1,"resource","extension",1,"valueCodeableConcept","coding",1,"display")="White"
"RTN","SYNFPAT",226,0)
 ;g("Patient","entry",1,"resource","extension",1,"valueCodeableConcept","coding",1,"system")="http://hl7.org/fhir/v3/Race"
"RTN","SYNFPAT",227,0)
 ;g("Patient","entry",1,"resource","extension",1,"valueCodeableConcept","text")="race"
"RTN","SYNFPAT",228,0)
 ;g("Patient","entry",1,"resource","extension",2,"url")="http://hl7.org/fhir/us/core/StructureDefinition/us-core-ethnicity"
"RTN","SYNFPAT",229,0)
 ;g("Patient","entry",1,"resource","extension",2,"valueCodeableConcept","coding",1,"code")="2186-5"
"RTN","SYNFPAT",230,0)
 ;g("Patient","entry",1,"resource","extension",2,"valueCodeableConcept","coding",1,"display")="Nonhispanic"
"RTN","SYNFPAT",231,0)
 ;g("Patient","entry",1,"resource","extension",2,"valueCodeableConcept","coding",1,"system")="http://hl7.org/fhir/v3/Ethnicity"
"RTN","SYNFPAT",232,0)
 ;g("Patient","entry",1,"resource","extension",2,"valueCodeableConcept","text")="ethnicity"
"RTN","SYNFPAT",233,0)
 ;g("Patient","entry",1,"resource","extension",3,"url")="http://hl7.org/fhir/StructureDefinition/birthPlace"
"RTN","SYNFPAT",234,0)
 ;g("Patient","entry",1,"resource","extension",3,"valueAddress","city")="Easton"
"RTN","SYNFPAT",235,0)
 ;g("Patient","entry",1,"resource","extension",3,"valueAddress","country")="US"
"RTN","SYNFPAT",236,0)
 ;g("Patient","entry",1,"resource","extension",3,"valueAddress","state")="MA"
"RTN","SYNFPAT",237,0)
 ;g("Patient","entry",1,"resource","extension",4,"url")="http://hl7.org/fhir/StructureDefinition/patient-mothersMaidenName"
"RTN","SYNFPAT",238,0)
 ;g("Patient","entry",1,"resource","extension",4,"valueString")="Jeramie91 Waelchi310"
"RTN","SYNFPAT",239,0)
 ;g("Patient","entry",1,"resource","extension",5,"url")="http://hl7.org/fhir/us/core/StructureDefinition/us-core-birthsex"
"RTN","SYNFPAT",240,0)
 ;g("Patient","entry",1,"resource","extension",5,"valueCode")="M"
"RTN","SYNFPAT",241,0)
 ;g("Patient","entry",1,"resource","extension",6,"url")="http://hl7.org/fhir/StructureDefinition/patient-interpreterRequired"
"RTN","SYNFPAT",242,0)
 ;g("Patient","entry",1,"resource","extension",6,"valueBoolean")="false"
"RTN","SYNFPAT",243,0)
 ;g("Patient","entry",1,"resource","extension",7,"url")="http://standardhealthrecord.org/fhir/StructureDefinition/shr-actor-FictionalPerson-extension"
"RTN","SYNFPAT",244,0)
 ;g("Patient","entry",1,"resource","extension",7,"valueBoolean")="true"
"RTN","SYNFPAT",245,0)
 ;g("Patient","entry",1,"resource","extension",8,"url")="http://standardhealthrecord.org/fhir/StructureDefinition/shr-demographics-FathersName-extension"
"RTN","SYNFPAT",246,0)
 ;g("Patient","entry",1,"resource","extension",8,"valueHumanName","text")="Veronica383 Abbott509"
"RTN","SYNFPAT",247,0)
 ;g("Patient","entry",1,"resource","extension",9,"url")="http://standardhealthrecord.org/fhir/StructureDefinition/shr-demographics-SocialSecurityNumber-extension"
"RTN","SYNFPAT",248,0)
 ;g("Patient","entry",1,"resource","extension",9,"valueString")="999-67-7452"
"RTN","SYNFPAT",249,0)
 ;g("Patient","entry",1,"resource","gender")="male"
"RTN","SYNFPAT",250,0)
 ;g("Patient","entry",1,"resource","id")="a13f2440-a3ec-419a-8259-82710d695fdf"
"RTN","SYNFPAT",251,0)
 ;g("Patient","entry",1,"resource","identifier",1,"system")="https://github.com/synthetichealth/synthea"
"RTN","SYNFPAT",252,0)
 ;g("Patient","entry",1,"resource","identifier",1,"value")="72bcbb80-2cbd-4523-82c1-30a34e08a72a"
"RTN","SYNFPAT",253,0)
 ;g("Patient","entry",1,"resource","identifier",2,"system")="http://hl7.org/fhir/sid/us-ssn"
"RTN","SYNFPAT",254,0)
 ;g("Patient","entry",1,"resource","identifier",2,"type","coding",1,"code")="SB"
"RTN","SYNFPAT",255,0)
 ;g("Patient","entry",1,"resource","identifier",2,"type","coding",1,"system")="http://hl7.org/fhir/identifier-type"
"RTN","SYNFPAT",256,0)
 ;g("Patient","entry",1,"resource","identifier",2,"value")=999677452
"RTN","SYNFPAT",257,0)
 ;g("Patient","entry",1,"resource","identifier",2,"value","\s")=""
"RTN","SYNFPAT",258,0)
 ;g("Patient","entry",1,"resource","identifier",3,"system")="urn:oid:2.16.840.1.113883.4.3.25"
"RTN","SYNFPAT",259,0)
 ;g("Patient","entry",1,"resource","identifier",3,"type","coding",1,"code")="DL"
"RTN","SYNFPAT",260,0)
 ;g("Patient","entry",1,"resource","identifier",3,"type","coding",1,"system")="http://hl7.org/fhir/v2/0203"
"RTN","SYNFPAT",261,0)
 ;g("Patient","entry",1,"resource","identifier",3,"value")="S99925046"
"RTN","SYNFPAT",262,0)
 ;g("Patient","entry",1,"resource","maritalStatus","coding",1,"code")="M"
"RTN","SYNFPAT",263,0)
 ;g("Patient","entry",1,"resource","maritalStatus","coding",1,"system")="http://hl7.org/fhir/v3/MaritalStatus"
"RTN","SYNFPAT",264,0)
 ;g("Patient","entry",1,"resource","maritalStatus","text")="M"
"RTN","SYNFPAT",265,0)
 ;g("Patient","entry",1,"resource","meta","profile",1)="http://standardhealthrecord.org/fhir/StructureDefinition/shr-demographics-PersonOfRecord"
"RTN","SYNFPAT",266,0)
 ;g("Patient","entry",1,"resource","multipleBirthBoolean")="false"
"RTN","SYNFPAT",267,0)
 ;g("Patient","entry",1,"resource","name",1,"family")="Abbott509"
"RTN","SYNFPAT",268,0)
 ;g("Patient","entry",1,"resource","name",1,"given",1)="Arlie395"
"RTN","SYNFPAT",269,0)
 ;g("Patient","entry",1,"resource","name",1,"prefix",1)="Mr."
"RTN","SYNFPAT",270,0)
 ;g("Patient","entry",1,"resource","name",1,"use")="official"
"RTN","SYNFPAT",271,0)
 ;g("Patient","entry",1,"resource","resourceType")="Patient"
"RTN","SYNFPAT",272,0)
 ;g("Patient","entry",1,"resource","telecom",1,"system")="phone"
"RTN","SYNFPAT",273,0)
 ;g("Patient","entry",1,"resource","telecom",1,"use")="home"
"RTN","SYNFPAT",274,0)
 ;g("Patient","entry",1,"resource","telecom",1,"value")="(454) 841-5126"
"RTN","SYNFPAT",275,0)
 ;g("Patient","entry",1,"resource","text","div")="<div>Generated by <a href=""https://github.com/synthetichealth/synthea"""
"RTN","SYNFPAT",276,0)
 ;g("Patient","entry",1,"resource","text","div","\",1)=">Synthea</a>. Version identifier: 4d02400401b9fab839e47bf5b2f1f6a8c683ab55</div>"
"RTN","SYNFPAT",277,0)
 ;g("Patient","entry",1,"resource","text","status")="generated"
"RTN","SYNFPAT",278,0)
 ;
"RTN","SYNFPAT",279,0)
 ; patient load template (D LOADMISC^ISIIMPU1(.G))
"RTN","SYNFPAT",280,0)
 ;G("CITY")="FIELD|.114"
"RTN","SYNFPAT",281,0)
 ;G("DFN_NAME")="PARAM|"
"RTN","SYNFPAT",282,0)
 ;G("DOB")="FIELD|.03"
"RTN","SYNFPAT",283,0)
 ;G("EMPLOY_STAT")="FIELD|.31115"
"RTN","SYNFPAT",284,0)
 ;G("ETHNICITY")="FIELD|2.06,.01"
"RTN","SYNFPAT",285,0)
 ;G("IMP_BATCH_NUM")="PARAM|"
"RTN","SYNFPAT",286,0)
 ;G("IMP_TYPE")="PARAM|"
"RTN","SYNFPAT",287,0)
 ;G("INSUR_TYPE")="FIELD|2.312,.01"
"RTN","SYNFPAT",288,0)
 ;G("LOW_DOB")="PARAM|.03"
"RTN","SYNFPAT",289,0)
 ;G("MARITAL_STATUS")="FIELD|.05"
"RTN","SYNFPAT",290,0)
 ;G("MRG_SOURCE")="FIELD|.01"
"RTN","SYNFPAT",291,0)
 ;G("NAME")="FIELD|.01"
"RTN","SYNFPAT",292,0)
 ;G("NAME_MASK")="MASK|.01"
"RTN","SYNFPAT",293,0)
 ;G("OCCUPATION")="FIELD|.07"
"RTN","SYNFPAT",294,0)
 ;G("PH_NUM")="FIELD|.131"
"RTN","SYNFPAT",295,0)
 ;G("PH_NUM_MASK")="MASK|.131"
"RTN","SYNFPAT",296,0)
 ;G("RACE")="FIELD|2.02,.01"
"RTN","SYNFPAT",297,0)
 ;G("SEX")="FIELD|.02"
"RTN","SYNFPAT",298,0)
 ;G("SSN")="FIELD|.09"
"RTN","SYNFPAT",299,0)
 ;G("SSN_MASK")="MASK|.09"
"RTN","SYNFPAT",300,0)
 ;G("STATE")="FIELD|.115"
"RTN","SYNFPAT",301,0)
 ;G("STREET_ADD1")="FIELD|.111"
"RTN","SYNFPAT",302,0)
 ;G("STREET_ADD2")="FIELD|.112"
"RTN","SYNFPAT",303,0)
 ;G("TEMPLATE")="PARAM|"
"RTN","SYNFPAT",304,0)
 ;G("TYPE")="FIELD|391"
"RTN","SYNFPAT",305,0)
 ;G("UP_DOB")="PARAM|.03"
"RTN","SYNFPAT",306,0)
 ;G("VETERAN")="FIELD|1901"
"RTN","SYNFPAT",307,0)
 ;G("ZIP_4")="FIELD|.1112"
"RTN","SYNFPAT",308,0)
 ;G("ZIP_4_MASK")="MASK|.1112
"RTN","SYNFPAT",309,0)
 ;"
"RTN","SYNFPAT",310,0)
newIcn(dfn) ; extrinsic which creates a new ICN for the patient
"RTN","SYNFPAT",311,0)
 ; if none exists. returns the ICN
"RTN","SYNFPAT",312,0)
 ;
"RTN","SYNFPAT",313,0)
 new tmpicn
"RTN","SYNFPAT",314,0)
 set tmpicn=$$icn(dfn)
"RTN","SYNFPAT",315,0)
 if tmpicn'=-1 do  quit tmpicn  
"RTN","SYNFPAT",316,0)
 . n ien s ien=$$dfn2ien^SYNFUTL(dfn)
"RTN","SYNFPAT",317,0)
 . if ien'="" do setIndex^SYNFUTL(ien,"ICN",tmpicn)
"RTN","SYNFPAT",318,0)
 ;
"RTN","SYNFPAT",319,0)
 ; lock here
"RTN","SYNFPAT",320,0)
 ;
"RTN","SYNFPAT",321,0)
 set tmpicn=$o(^DPT("AICN",99999999999),-1)+1
"RTN","SYNFPAT",322,0)
 if tmpicn=1 s tmpicn=50000001 ; first ICN in the system
"RTN","SYNFPAT",323,0)
 ;
"RTN","SYNFPAT",324,0)
 ;991.01    INTEGRATION CONTROL NUMBER (NJ12,0Xa), [MPI;1]          
"RTN","SYNFPAT",325,0)
 ;991.02    ICN CHECKSUM (Fa), [MPI;2]
"RTN","SYNFPAT",326,0)
 ;991.1     FULL ICN (FXa), [MPI;10]
"RTN","SYNFPAT",327,0)
 ;
"RTN","SYNFPAT",328,0)
 new fda,tchk
"RTN","SYNFPAT",329,0)
 set tchk=$$CHECKDG^MPIFSPC(tmpicn)
"RTN","SYNFPAT",330,0)
 set fda(2,dfn_",",991.01)=tmpicn
"RTN","SYNFPAT",331,0)
 set fda(2,dfn_",",991.02)=tchk
"RTN","SYNFPAT",332,0)
 set fda(2,dfn_",",991.1)=tmpicn_"V"_tchk
"RTN","SYNFPAT",333,0)
 do UPDATE^DIE("","fda",,"err")
"RTN","SYNFPAT",334,0)
 if $data(err) do  quit -1
"RTN","SYNFPAT",335,0)
 . D ^ZTER
"RTN","SYNFPAT",336,0)
 ;
"RTN","SYNFPAT",337,0)
 new ficn s ficn=tmpicn_"V"_tchk
"RTN","SYNFPAT",338,0)
 S ^DPT("AFICN",ficn,dfn)=""
"RTN","SYNFPAT",339,0)
 S ^DPT("ARFICN",dfn,ficn)=""
"RTN","SYNFPAT",340,0)
 ;
"RTN","SYNFPAT",341,0)
 n ien s ien=$$dfn2ien^SYNFUTL(dfn)
"RTN","SYNFPAT",342,0)
 if ien'="" do setIndex^SYNFUTL(ien,"ICN",ficn)
"RTN","SYNFPAT",343,0)
 ;
"RTN","SYNFPAT",344,0)
 quit ficn
"RTN","SYNFPAT",345,0)
 ;
"RTN","SYNFPAT",346,0)
icn(dfn) ; extrinsic returns the ICN of the patient
"RTN","SYNFPAT",347,0)
 ; returns -1 if none exists
"RTN","SYNFPAT",348,0)
 new zicn
"RTN","SYNFPAT",349,0)
 set zicn=$$GET1^DIQ(2,dfn_",",991.01)
"RTN","SYNFPAT",350,0)
 ;set zicn=$o(^DPT("AICN",dfn,""))
"RTN","SYNFPAT",351,0)
 if zicn="" q -1
"RTN","SYNFPAT",352,0)
 ;
"RTN","SYNFPAT",353,0)
 quit zicn_"V"_$$CHECKDG^MPIFSPC(zicn)
"RTN","SYNFPAT",354,0)
 ;
"RTN","SYNFPAT",355,0)
newIcn2(dfn,pid) ; extrinsic which creates a new ICN for the patient based on the Synthea patient id (pid)
"RTN","SYNFPAT",356,0)
 ; returns the ICN
"RTN","SYNFPAT",357,0)
 ;
"RTN","SYNFPAT",358,0)
 i $g(pid)="" d  ; pid not provided.. go find it
"RTN","SYNFPAT",359,0)
 . n fien s fien=$$dfn2ien^SYNFUTL(dfn)
"RTN","SYNFPAT",360,0)
 . s pid=$$ien2pid^SYNFUTL(fien)
"RTN","SYNFPAT",361,0)
 i $g(pid)="" q -1
"RTN","SYNFPAT",362,0)
 new tmpicn
"RTN","SYNFPAT",363,0)
 ;
"RTN","SYNFPAT",364,0)
 s tmpicn=$$pid2icn^SYNFUTL(pid) ; generate the icn from the pid
"RTN","SYNFPAT",365,0)
 ;
"RTN","SYNFPAT",366,0)
 ;991.01    INTEGRATION CONTROL NUMBER (NJ12,0Xa), [MPI;1]          
"RTN","SYNFPAT",367,0)
 ;991.02    ICN CHECKSUM (Fa), [MPI;2]
"RTN","SYNFPAT",368,0)
 ;991.1     FULL ICN (FXa), [MPI;10]
"RTN","SYNFPAT",369,0)
 ;
"RTN","SYNFPAT",370,0)
 new fda,tchk,err
"RTN","SYNFPAT",371,0)
 set tchk=$$CHECKDG^MPIFSPC(tmpicn)
"RTN","SYNFPAT",372,0)
 i +dfn=0 b
"RTN","SYNFPAT",373,0)
 set fda(2,dfn_",",991.01)=tmpicn
"RTN","SYNFPAT",374,0)
 set fda(2,dfn_",",991.02)=tchk
"RTN","SYNFPAT",375,0)
 set fda(2,dfn_",",991.1)=tmpicn_"V"_tchk
"RTN","SYNFPAT",376,0)
 do UPDATE^DIE("","fda",,"err")
"RTN","SYNFPAT",377,0)
 if $data(err) do  quit -1
"RTN","SYNFPAT",378,0)
 . D ^ZTER
"RTN","SYNFPAT",379,0)
 . zwrite err
"RTN","SYNFPAT",380,0)
 ;
"RTN","SYNFPAT",381,0)
 new ficn s ficn=tmpicn_"V"_tchk
"RTN","SYNFPAT",382,0)
 S ^DPT("AFICN",ficn,dfn)=""
"RTN","SYNFPAT",383,0)
 S ^DPT("ARFICN",dfn,ficn)=""
"RTN","SYNFPAT",384,0)
 ;
"RTN","SYNFPAT",385,0)
 n ien s ien=$$dfn2ien^SYNFUTL(dfn)
"RTN","SYNFPAT",386,0)
 if ien'="" do setIndex^SYNFUTL(ien,"ICN",ficn)
"RTN","SYNFPAT",387,0)
 ;
"RTN","SYNFPAT",388,0)
 quit ficn
"RTN","SYNFPAT",389,0)
 ;
"RTN","SYNFPAT",390,0)
fixindex1 ; create the ICN and DFN indexes
"RTN","SYNFPAT",391,0)
 d clearIndexes^SYNFUTL ; blow away the indexes
"RTN","SYNFPAT",392,0)
 n gn,zi
"RTN","SYNFPAT",393,0)
 s gn=$$setroot^%wd("fhir-intake")
"RTN","SYNFPAT",394,0)
 s zi=0
"RTN","SYNFPAT",395,0)
 f  s zi=$o(@gn@(zi)) q:+zi=0  d  ;
"RTN","SYNFPAT",396,0)
 . n gn2,dfn,icn
"RTN","SYNFPAT",397,0)
 . s gn2=$na(@gn@(zi,"load","Patient","status"))
"RTN","SYNFPAT",398,0)
 . ;w !,gn2," ",$g(@gn2@("DFN"))
"RTN","SYNFPAT",399,0)
 . s dfn=$g(@gn2@("DFN"))
"RTN","SYNFPAT",400,0)
 . q:dfn=""
"RTN","SYNFPAT",401,0)
 . ;s icn=$g(@gn2@("ICN"))
"RTN","SYNFPAT",402,0)
 . s icn=$o(^DPT("ARFICN",dfn,""))
"RTN","SYNFPAT",403,0)
 . q:icn=""
"RTN","SYNFPAT",404,0)
 . s @gn@(zi,"DFN",dfn)=""
"RTN","SYNFPAT",405,0)
 . d setIndex^SYNFUTL(zi,"DFN",dfn)
"RTN","SYNFPAT",406,0)
 . i icn'="" d  
"RTN","SYNFPAT",407,0)
 . . s @gn@(zi,"ICN",icn)=""
"RTN","SYNFPAT",408,0)
 . . d setIndex^SYNFUTL(zi,"ICN",icn)
"RTN","SYNFPAT",409,0)
 q
"RTN","SYNFPAT",410,0)
 ;
"RTN","SYNFPAT",411,0)
fixicn1 ; fix all DPT ICN indexes
"RTN","SYNFPAT",412,0)
 k ^DPT("AICN")
"RTN","SYNFPAT",413,0)
 K ^DPT("AFICN")
"RTN","SYNFPAT",414,0)
 K ^DPT("ARFICN")
"RTN","SYNFPAT",415,0)
 n zi s zi=0
"RTN","SYNFPAT",416,0)
 f  s zi=$o(^DPT(zi)) q:+zi=0  d  ;
"RTN","SYNFPAT",417,0)
 . n icn,icnck
"RTN","SYNFPAT",418,0)
 . s icn=$$GET1^DIQ(2,zi_",",991.01)
"RTN","SYNFPAT",419,0)
 . s icnck=$$GET1^DIQ(2,zi_",",991.02)
"RTN","SYNFPAT",420,0)
 . q:icn=""
"RTN","SYNFPAT",421,0)
 . q:icnck=""
"RTN","SYNFPAT",422,0)
 . n ficn s ficn=icn_"V"_icnck
"RTN","SYNFPAT",423,0)
 . s ^DPT("AICN",icn,zi)=""
"RTN","SYNFPAT",424,0)
 . s ^DPT("AFICN",ficn,zi)=""
"RTN","SYNFPAT",425,0)
 . s ^DPT("ARFICN",zi,ficn)=""
"RTN","SYNFPAT",426,0)
 q
"RTN","SYNFPAT",427,0)
 ;
"RTN","SYNFPAT",428,0)
genAllIcns ; regenerates all ICNs; insterts in PATIENT file and regenerates indexes
"RTN","SYNFPAT",429,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFPAT",430,0)
 n zi s zi=0
"RTN","SYNFPAT",431,0)
 f  s zi=$o(@root@(zi)) q:+zi=0  d  ;
"RTN","SYNFPAT",432,0)
 . n pid,dfn,icn
"RTN","SYNFPAT",433,0)
 . s pid=$$ien2pid^SYNFUTL(zi)
"RTN","SYNFPAT",434,0)
 . s dfn=$$ien2dfn^SYNFUTL(zi)
"RTN","SYNFPAT",435,0)
 . i dfn<1 q
"RTN","SYNFPAT",436,0)
 . i pid="" q
"RTN","SYNFPAT",437,0)
 . s icn=$$newIcn2^SYNFPAT(dfn,pid)
"RTN","SYNFPAT",438,0)
 . w !,"fien: "_zi_" dfn: "_dfn_" pid: "_pid_" icn: "_icn
"RTN","SYNFPAT",439,0)
 d fixicn1 ; fix ^DPT indexes
"RTN","SYNFPAT",440,0)
 d fixindex1 ; fix graph indexes
"RTN","SYNFPAT",441,0)
 q
"RTN","SYNFPAT",442,0)
 ;
"RTN","SYNFPR2")
0^36^B124320391
"RTN","SYNFPR2",1,0)
SYNFPR2 ;ven/gpl - fhir loader utilities ;2018-08-17  3:27 PM
"RTN","SYNFPR2",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNFPR2",3,0)
 ;
"RTN","SYNFPR2",4,0)
 ; Authored by George P. Lilly 2017-2018
"RTN","SYNFPR2",5,0)
 ;
"RTN","SYNFPR2",6,0)
 ; use SYNDHP61 instead of SYNDHP62 for problem update
"RTN","SYNFPR2",7,0)
 q
"RTN","SYNFPR2",8,0)
 ;
"RTN","SYNFPR2",9,0)
importConditions(rtn,ien,args)   ; entry point for loading Problems for a patient
"RTN","SYNFPR2",10,0)
 ; calls the intake Conditions web service directly
"RTN","SYNFPR2",11,0)
 ;
"RTN","SYNFPR2",12,0)
 n grtn
"RTN","SYNFPR2",13,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFPR2",14,0)
 d wsIntakeConditions(.args,,.grtn,ien)
"RTN","SYNFPR2",15,0)
 i $d(grtn) d  ; something was returned
"RTN","SYNFPR2",16,0)
 . k @root@(ien,"load","conditions")
"RTN","SYNFPR2",17,0)
 . m @root@(ien,"load","conditions")=grtn("conditions")
"RTN","SYNFPR2",18,0)
 . if $g(args("debug"))=1 m rtn=grtn
"RTN","SYNFPR2",19,0)
 s rtn("conditionsStatus","status")=$g(grtn("status","status"))
"RTN","SYNFPR2",20,0)
 s rtn("conditionsStatus","loaded")=$g(grtn("status","loaded"))
"RTN","SYNFPR2",21,0)
 s rtn("conditionsStatus","errors")=$g(grtn("status","errors"))
"RTN","SYNFPR2",22,0)
 ;b
"RTN","SYNFPR2",23,0)
 ;
"RTN","SYNFPR2",24,0)
 ;
"RTN","SYNFPR2",25,0)
 q
"RTN","SYNFPR2",26,0)
 ;
"RTN","SYNFPR2",27,0)
wsIntakeConditions(args,body,result,ien)               ; web service entry (post)
"RTN","SYNFPR2",28,0)
 ; for intake of one or more Conditions. input are fhir resources
"RTN","SYNFPR2",29,0)
 ; result is json and summarizes what was done
"RTN","SYNFPR2",30,0)
 ; args include patientId
"RTN","SYNFPR2",31,0)
 ; ien is specified for internal calls, where the json is already in a graph
"RTN","SYNFPR2",32,0)
 n jtmp,json,jrslt,eval
"RTN","SYNFPR2",33,0)
 ;i $g(ien)'="" if $$loadStatus("conditions","",ien)=1 d  q  ;
"RTN","SYNFPR2",34,0)
 ;. s result("conditionsStatus","status")="alreadyLoaded"
"RTN","SYNFPR2",35,0)
 i $g(ien)'="" d  ; internal call
"RTN","SYNFPR2",36,0)
 . d getIntakeFhir^SYNFHIR("json",,"Condition",ien,1)
"RTN","SYNFPR2",37,0)
 e  d  ; 
"RTN","SYNFPR2",38,0)
 . s args("load")=0
"RTN","SYNFPR2",39,0)
 . merge jtmp=BODY
"RTN","SYNFPR2",40,0)
 . do DECODE^VPRJSON("jtmp","json")
"RTN","SYNFPR2",41,0)
 i '$d(json) q  ;
"RTN","SYNFPR2",42,0)
 m ^gpl("gjson")=json
"RTN","SYNFPR2",43,0)
 ;
"RTN","SYNFPR2",44,0)
 ; determine the patient
"RTN","SYNFPR2",45,0)
 ;
"RTN","SYNFPR2",46,0)
 n dfn,eval
"RTN","SYNFPR2",47,0)
 if $g(ien)'="" d  ;
"RTN","SYNFPR2",48,0)
 . s dfn=$$ien2dfn^SYNFUTL(ien) ; look up dfn in the graph
"RTN","SYNFPR2",49,0)
 else  d  ;
"RTN","SYNFPR2",50,0)
 . s dfn=$g(args("dfn"))
"RTN","SYNFPR2",51,0)
 . i dfn="" d  ;
"RTN","SYNFPR2",52,0)
 . . n icn s icn=$g(args("icn"))
"RTN","SYNFPR2",53,0)
 . . i icn'="" s dfn=$$icn2dfn^SYNFUTL(icn)
"RTN","SYNFPR2",54,0)
 i $g(dfn)="" do  quit  ; need the patient
"RTN","SYNFPR2",55,0)
 . s result("conditions",1,"log",1)="Error, patient not found.. terminating"
"RTN","SYNFPR2",56,0)
 ;
"RTN","SYNFPR2",57,0)
 ;
"RTN","SYNFPR2",58,0)
 new zi s zi=0
"RTN","SYNFPR2",59,0)
 for  set zi=$order(json("entry",zi)) quit:+zi=0  do  ;
"RTN","SYNFPR2",60,0)
 . ;
"RTN","SYNFPR2",61,0)
 . ; define a place to log the processing of this entry
"RTN","SYNFPR2",62,0)
 . ;
"RTN","SYNFPR2",63,0)
 . new jlog set jlog=$name(eval("conditions",zi))
"RTN","SYNFPR2",64,0)
 . ;
"RTN","SYNFPR2",65,0)
 . ; insure that the resourceType is Observation
"RTN","SYNFPR2",66,0)
 . ;
"RTN","SYNFPR2",67,0)
 . new type set type=$get(json("entry",zi,"resource","resourceType"))
"RTN","SYNFPR2",68,0)
 . if type'="Condition" do  quit  ;
"RTN","SYNFPR2",69,0)
 . . set eval("conditions",zi,"vars","resourceType")=type
"RTN","SYNFPR2",70,0)
 . . do log(jlog,"Resource type not Condition, skipping entry")
"RTN","SYNFPR2",71,0)
 . set eval("conditions",zi,"vars","resourceType")=type
"RTN","SYNFPR2",72,0)
 . ;
"RTN","SYNFPR2",73,0)
 . ; see if this resource has already been loaded. if so, skip it
"RTN","SYNFPR2",74,0)
 . ;
"RTN","SYNFPR2",75,0)
 . if $g(ien)'="" if $$loadStatus("condition",zi,ien)=1 do  quit  ;
"RTN","SYNFPR2",76,0)
 . . d log(jlog,"Condition already loaded, skipping")
"RTN","SYNFPR2",77,0)
 . ;
"RTN","SYNFPR2",78,0)
 . ; determine Condition snomed code, coding system, and display text
"RTN","SYNFPR2",79,0)
 . ;
"RTN","SYNFPR2",80,0)
 . ;
"RTN","SYNFPR2",81,0)
 . ; determine the id of the resource
"RTN","SYNFPR2",82,0)
 . ;
"RTN","SYNFPR2",83,0)
 . ;new id set id=$get(json("entry",zi,"resource","id"))
"RTN","SYNFPR2",84,0)
 . ;set eval("conditions",zi,"vars","id")=id
"RTN","SYNFPR2",85,0)
 . ;d log(jlog,"ID is: "_id)
"RTN","SYNFPR2",86,0)
 . ;
"RTN","SYNFPR2",87,0)
 . new sctcode set sctcode=$get(json("entry",zi,"resource","code","coding",1,"code"))
"RTN","SYNFPR2",88,0)
 . do log(jlog,"code is: "_sctcode)
"RTN","SYNFPR2",89,0)
 . set eval("conditions",zi,"vars","code")=sctcode
"RTN","SYNFPR2",90,0)
 . ;
"RTN","SYNFPR2",91,0)
 . ;
"RTN","SYNFPR2",92,0)
 . new codesystem set codesystem=$get(json("entry",zi,"resource","code","coding",1,"system"))
"RTN","SYNFPR2",93,0)
 . do log(jlog,"code system is: "_codesystem)
"RTN","SYNFPR2",94,0)
 . set eval("conditions",zi,"vars","codeSystem")=codesystem
"RTN","SYNFPR2",95,0)
 . ;
"RTN","SYNFPR2",96,0)
 . ; determine the onset date and time
"RTN","SYNFPR2",97,0)
 . ;
"RTN","SYNFPR2",98,0)
 . new onsetdate set onsetdate=$get(json("entry",zi,"resource","onsetDateTime"))
"RTN","SYNFPR2",99,0)
 . do log(jlog,"onsetDateTime is: "_onsetdate)
"RTN","SYNFPR2",100,0)
 . set eval("conditions",zi,"vars","onsetDateTime")=onsetdate
"RTN","SYNFPR2",101,0)
 . new fmOnsetDateTime s fmOnsetDateTime=$$fhirTfm^SYNFUTL(onsetdate)
"RTN","SYNFPR2",102,0)
 . d log(jlog,"fileman onsetDateTime is: "_fmOnsetDateTime)
"RTN","SYNFPR2",103,0)
 . set eval("conditions",zi,"vars","fmOnsetDateTime")=fmOnsetDateTime ;
"RTN","SYNFPR2",104,0)
 . new hl7OnsetDateTime s hl7OnsetDateTime=$$fhirThl7^SYNFUTL(onsetdate)
"RTN","SYNFPR2",105,0)
 . d log(jlog,"hl7 onsetDateTime is: "_hl7OnsetDateTime)
"RTN","SYNFPR2",106,0)
 . set eval("conditions",zi,"vars","hl7OnsetDateTime")=hl7OnsetDateTime ;
"RTN","SYNFPR2",107,0)
 . ;
"RTN","SYNFPR2",108,0)
 . ; determine the abatement date and time, if any
"RTN","SYNFPR2",109,0)
 . ;
"RTN","SYNFPR2",110,0)
 . new abatementdate set abatementdate=$get(json("entry",zi,"resource","abatementDateTime"))
"RTN","SYNFPR2",111,0)
 . if abatementdate'="" d  ;
"RTN","SYNFPR2",112,0)
 . . do log(jlog,"abatementDateTime is: "_abatementdate)
"RTN","SYNFPR2",113,0)
 . . set eval("conditions",zi,"vars","abatementDateTime")=abatementdate
"RTN","SYNFPR2",114,0)
 . . new fmAbatementDateTime s fmAbatementDateTime=$$fhirTfm^SYNFUTL(abatementdate)
"RTN","SYNFPR2",115,0)
 . . d log(jlog,"fileman abatementDateTime is: "_fmAbatementDateTime)
"RTN","SYNFPR2",116,0)
 . . set eval("conditions",zi,"vars","fmAbatementDateTime")=fmAbatementDateTime ;
"RTN","SYNFPR2",117,0)
 . . new hl7AbatementDateTime s hl7AbatementDateTime=$$fhirThl7^SYNFUTL(abatementdate)
"RTN","SYNFPR2",118,0)
 . . d log(jlog,"hl7 abatementDateTime is: "_hl7AbatementDateTime)
"RTN","SYNFPR2",119,0)
 . . set eval("conditions",zi,"vars","hl7AbatementDateTime")=hl7AbatementDateTime ;
"RTN","SYNFPR2",120,0)
 . else  d log(jlog,"no abatementDateTime")
"RTN","SYNFPR2",121,0)
 . ;
"RTN","SYNFPR2",122,0)
 . ; determine clinical status (active vs inactive)
"RTN","SYNFPR2",123,0)
 . ;
"RTN","SYNFPR2",124,0)
 . n clinicalstatus set clinicalstatus=$get(json("entry",zi,"resource","clinicalStatus"))
"RTN","SYNFPR2",125,0)
 . i $get(abatementdate)'="" set clinicalstatus="inactive" ; VistA doesn't allow active problems with a resolution date
"RTN","SYNFPR2",126,0)
 . ;
"RTN","SYNFPR2",127,0)
 . ; determine the encounter visit ien
"RTN","SYNFPR2",128,0)
 . n encounterId
"RTN","SYNFPR2",129,0)
 . s encounterId=$g(json("entry",zi,"resource","context","reference"))
"RTN","SYNFPR2",130,0)
 . i encounterId["urn:uuid:" s encounterId=$p(encounterId,"urn:uuid:",2)
"RTN","SYNFPR2",131,0)
 . s eval("conditions",zi,"vars","encounterId")=encounterId
"RTN","SYNFPR2",132,0)
 . d log(jlog,"reference encounter ID is : "_encounterId)
"RTN","SYNFPR2",133,0)
 . ;
"RTN","SYNFPR2",134,0)
 . ; determine visit ien
"RTN","SYNFPR2",135,0)
 . ;
"RTN","SYNFPR2",136,0)
 . n visitIen s visitIen=$$visitIen^SYNFENC(ien,encounterId)
"RTN","SYNFPR2",137,0)
 . s eval("conditions",zi,"vars","visitIen")=visitIen
"RTN","SYNFPR2",138,0)
 . d log(jlog,"visit ien is: "_visitIen)
"RTN","SYNFPR2",139,0)
 . ;
"RTN","SYNFPR2",140,0)
 . ; ckeck to see if the problem is an allergy in VistA
"RTN","SYNFPR2",141,0)
 . ;
"RTN","SYNFPR2",142,0)
 . n algy s algy=$$ISGMR^SYNFALG(sctcode)
"RTN","SYNFPR2",143,0)
 . i algy'=-1 d  ; this condition is an allergy in VistA
"RTN","SYNFPR2",144,0)
 . . n aname s aname=$p(algy,"^",2)
"RTN","SYNFPR2",145,0)
 . . d QADDALGY^SYNFALG(aname,fmOnsetDateTime,ien)
"RTN","SYNFPR2",146,0)
 . ;
"RTN","SYNFPR2",147,0)
 . ; set up to call the data loader
"RTN","SYNFPR2",148,0)
 . ;
"RTN","SYNFPR2",149,0)
 . ;PRBUPDT(RETSTA,DHPPAT,DHPVST,DHPROV,DHPONS,DHPABT,DHPCLNST,DHPSCT)   ;Problem/Condition update - deprecated
"RTN","SYNFPR2",150,0)
 . ;PROBUPD(RETSTA,DHPPAT,DHPSCT,DHPSDES,DHPROV,DHPDTM,DHPRID) ; problems update - use this one
"RTN","SYNFPR2",151,0)
 . n RETSTA,DHPPAT,DHPSCT,DHPSDES,DHPROV,DHPDTM,DHPRID ;
"RTN","SYNFPR2",152,0)
 . ;n RETSTA,DHPPAT,DHPVST,DHPROV,DHPONS,DHPABT,DHPCLNST,DHPSCT ;Problem/Condition update
"RTN","SYNFPR2",153,0)
 . ;s (DHPPAT,DHPVST,DHPROV,DHPONS,DHPABT,DHPCLNST,DHPSCT)=""      ;Condition update
"RTN","SYNFPR2",154,0)
 . s (DHPPAT,DHPSCT,DHPSDES,DHPROV,DHPDTM,DHPRID)=""
"RTN","SYNFPR2",155,0)
 . ;
"RTN","SYNFPR2",156,0)
 . s DHPPAT=$$dfn2icn^SYNFUTL(dfn)
"RTN","SYNFPR2",157,0)
 . s eval("conditions",zi,"parms","DHPPAT")=DHPPAT
"RTN","SYNFPR2",158,0)
 . ;
"RTN","SYNFPR2",159,0)
 . s DHPVST=visitIen
"RTN","SYNFPR2",160,0)
 . s eval("conditions",zi,"parms","DHPVST")=visitIen
"RTN","SYNFPR2",161,0)
 . ;
"RTN","SYNFPR2",162,0)
 . s DHPSCT=sctcode
"RTN","SYNFPR2",163,0)
 . s eval("conditions",zi,"parms","DHPSCT")=DHPSCT
"RTN","SYNFPR2",164,0)
 . ;
"RTN","SYNFPR2",165,0)
 . ;s DHPCLNST=$S(clinicalstatus="Active":"A",1:"I")
"RTN","SYNFPR2",166,0)
 . ;s eval("conditions",zi,"parms","DHPCLNST")=DHPCLNST
"RTN","SYNFPR2",167,0)
 . ;
"RTN","SYNFPR2",168,0)
 . s DHPDTM=hl7OnsetDateTime
"RTN","SYNFPR2",169,0)
 . s eval("conditions",zi,"parms","DHPDTM")=DHPDTM
"RTN","SYNFPR2",170,0)
 . ;
"RTN","SYNFPR2",171,0)
 . s DHPPROV=$$MAP^SYNQLDM("OP","provider") ; map should return the NPI number
"RTN","SYNFPR2",172,0)
 . ;n DHPPROVIEN s DHPPROVIEN=$o(^VA(200,"B",IMMPROV,""))
"RTN","SYNFPR2",173,0)
 . ;if DHPPROVIEN="" S DHPPROVIEN=3
"RTN","SYNFPR2",174,0)
 . s eval("conditions",zi,"parms","DHPPROV")=DHPPROV
"RTN","SYNFPR2",175,0)
 . d log(jlog,"Provider NPI for outpatient is: "_DHPPROV)
"RTN","SYNFPR2",176,0)
 . ;
"RTN","SYNFPR2",177,0)
 . ;s DHPLOC=$$MAP^SYNQLDM("OP","location")
"RTN","SYNFPR2",178,0)
 . ;n DHPLOCIEN s DHPLOCIEN=$o(^SC("B",DHPLOC,""))
"RTN","SYNFPR2",179,0)
 . ;if DHPLOCIEN="" S DHPLOCIEN=4
"RTN","SYNFPR2",180,0)
 . ;s eval("conditions",zi,"parms","DHPLOC")=DHPLOCIEN
"RTN","SYNFPR2",181,0)
 . ;d log(jlog,"Location for outpatient is: #"_DHPLOCIEN_" "_DHPLOC)
"RTN","SYNFPR2",182,0)
 . ;
"RTN","SYNFPR2",183,0)
 . s eval("conditions",zi,"status","loadstatus")="readyToLoad"
"RTN","SYNFPR2",184,0)
 . ;
"RTN","SYNFPR2",185,0)
 . if $g(args("load"))=1 d  ; only load if told to
"RTN","SYNFPR2",186,0)
 . . if $g(ien)'="" if $$loadStatus("conditions",zi,ien)=1 do  quit  ;
"RTN","SYNFPR2",187,0)
 . . . d log(jlog,"Condition already loaded, skipping")
"RTN","SYNFPR2",188,0)
 . . d log(jlog,"Calling PROBUPD^SYNDHP61 to add condition")
"RTN","SYNFPR2",189,0)
 . . D PROBUPD^SYNDHP61(.RETSTA,DHPPAT,DHPSCT,DHPSDES,DHPROV,DHPDTM,DHPRID) ; problems update - use this one
"RTN","SYNFPR2",190,0)
 . . ;D PRBUPDT^SYNDHP62(.RETSTA,DHPPAT,DHPVST,DHPROV,DHPONS,DHPABT,DHPCLNST,DHPSCT)      ;Problem/Condition update
"RTN","SYNFPR2",191,0)
 . . m eval("conditions",zi,"status")=RETSTA
"RTN","SYNFPR2",192,0)
 . . d log(jlog,"Return from data loader was: "_$g(RETSTA))
"RTN","SYNFPR2",193,0)
 . . if +$g(RETSTA)=1 do  ;
"RTN","SYNFPR2",194,0)
 . . . s eval("status","loaded")=$g(eval("status","loaded"))+1
"RTN","SYNFPR2",195,0)
 . . . s eval("conditions",zi,"status","loadstatus")="loaded"
"RTN","SYNFPR2",196,0)
 . . else  d  ;
"RTN","SYNFPR2",197,0)
 . . . s eval("status","errors")=$g(eval("status","errors"))+1
"RTN","SYNFPR2",198,0)
 . . . s eval("conditions",zi,"status","loadstatus")="notLoaded"
"RTN","SYNFPR2",199,0)
 . . . s eval("conditions",zi,"status","loadMessage")=$g(RETSTA)
"RTN","SYNFPR2",200,0)
 . . n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFPR2",201,0)
 . . k @root@(ien,"load","conditions",zi)
"RTN","SYNFPR2",202,0)
 . . m @root@(ien,"load","conditions",zi)=eval("conditions",zi)
"RTN","SYNFPR2",203,0)
 ;
"RTN","SYNFPR2",204,0)
 if $get(args("debug"))=1 do  ;
"RTN","SYNFPR2",205,0)
 . m jrslt("source")=json
"RTN","SYNFPR2",206,0)
 . m jrslt("args")=args
"RTN","SYNFPR2",207,0)
 . m jrslt("eval")=eval
"RTN","SYNFPR2",208,0)
 m jrslt("conditionsStatus")=eval("conditionsStatus")
"RTN","SYNFPR2",209,0)
 set jrslt("result","status")="ok"
"RTN","SYNFPR2",210,0)
 set jrslt("result","loaded")=$g(eval("status","loaded"))
"RTN","SYNFPR2",211,0)
 i $g(ien)'="" d  ; called internally
"RTN","SYNFPR2",212,0)
 . m result=eval
"RTN","SYNFPR2",213,0)
 . m result("status")=jrslt("result")
"RTN","SYNFPR2",214,0)
 . m result("dfn")=dfn
"RTN","SYNFPR2",215,0)
 . m result("ien")=ien
"RTN","SYNFPR2",216,0)
 . ;b
"RTN","SYNFPR2",217,0)
 e  d  ;
"RTN","SYNFPR2",218,0)
 . d ENCODE^VPRJSON("jrslt","result")
"RTN","SYNFPR2",219,0)
 . set HTTPRSP("mime")="application/json" 
"RTN","SYNFPR2",220,0)
 q
"RTN","SYNFPR2",221,0)
 ;
"RTN","SYNFPR2",222,0)
log(ary,txt)       ; adds a text line to @ary@("log")
"RTN","SYNFPR2",223,0)
 s @ary@("log",$o(@ary@("log",""),-1)+1)=$g(txt)
"RTN","SYNFPR2",224,0)
 q
"RTN","SYNFPR2",225,0)
 ;
"RTN","SYNFPR2",226,0)
loadStatus(typ,zx,zien) ; extrinsic return 1 if resource was loaded
"RTN","SYNFPR2",227,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFPR2",228,0)
 n rt s rt=0
"RTN","SYNFPR2",229,0)
 i $g(zx)="" i $d(@root@(zien,"load",typ)) s rt=1 q rt
"RTN","SYNFPR2",230,0)
 i $get(@root@(zien,"load",typ,zx,"status","loadstatus"))="loaded" s rt=1
"RTN","SYNFPR2",231,0)
 q rt
"RTN","SYNFPR2",232,0)
 ;
"RTN","SYNFPR2",233,0)
testall ; run the conditions import on all imported patients
"RTN","SYNFPR2",234,0)
 new root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFPR2",235,0)
 new indx s indx=$na(@root@("POS","DFN"))
"RTN","SYNFPR2",236,0)
 n dfn,ien,filter,reslt
"RTN","SYNFPR2",237,0)
 s dfn=0
"RTN","SYNFPR2",238,0)
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  d  ;
"RTN","SYNFPR2",239,0)
 . s ien=$o(@indx@(dfn,""))
"RTN","SYNFPR2",240,0)
 . q:ien=""
"RTN","SYNFPR2",241,0)
 . s filter("dfn")=dfn
"RTN","SYNFPR2",242,0)
 . k reslt
"RTN","SYNFPR2",243,0)
 . d wsIntakeConditions(.filter,,.reslt,ien)
"RTN","SYNFPR2",244,0)
 q
"RTN","SYNFPR2",245,0)
 ;
"RTN","SYNFPR2",246,0)
testone(reslt,doload)     ; run the conditions import on all imported patients
"RTN","SYNFPR2",247,0)
 new root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFPR2",248,0)
 new indx s indx=$na(@root@("POS","DFN"))
"RTN","SYNFPR2",249,0)
 n dfn,ien,filter
"RTN","SYNFPR2",250,0)
 n done s done=0
"RTN","SYNFPR2",251,0)
 s dfn=0
"RTN","SYNFPR2",252,0)
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  q:done   d  ;
"RTN","SYNFPR2",253,0)
 . s ien=$o(@indx@(dfn,""))
"RTN","SYNFPR2",254,0)
 . q:ien=""
"RTN","SYNFPR2",255,0)
 . q:$d(@root@(ien,"load","conditions"))
"RTN","SYNFPR2",256,0)
 . s filter("dfn")=dfn
"RTN","SYNFPR2",257,0)
 . s filter("debug")=1
"RTN","SYNFPR2",258,0)
 . i $g(doload)=1 s filter("load")=1
"RTN","SYNFPR2",259,0)
 . k reslt
"RTN","SYNFPR2",260,0)
 . d wsIntakeConditions(.filter,,.reslt,ien)
"RTN","SYNFPR2",261,0)
 . s done=1
"RTN","SYNFPR2",262,0)
 q
"RTN","SYNFPR2",263,0)
 ;
"RTN","SYNFPRB")
0^37^B148551726
"RTN","SYNFPRB",1,0)
SYNFPRB ;ven/gpl - fhir loader utilities ;2018-08-17  3:27 PM
"RTN","SYNFPRB",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNFPRB",3,0)
 ;
"RTN","SYNFPRB",4,0)
 ; Authored by George P. Lilly 2017-2018
"RTN","SYNFPRB",5,0)
 ;
"RTN","SYNFPRB",6,0)
 q
"RTN","SYNFPRB",7,0)
 ;
"RTN","SYNFPRB",8,0)
importConditions(rtn,ien,args)  ; entry point for loading Problems for a patient
"RTN","SYNFPRB",9,0)
 ; calls the intake Conditions web service directly
"RTN","SYNFPRB",10,0)
 ;
"RTN","SYNFPRB",11,0)
 n grtn
"RTN","SYNFPRB",12,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFPRB",13,0)
 d wsIntakeConditions(.args,,.grtn,ien)
"RTN","SYNFPRB",14,0)
 i $d(grtn) d  ; something was returned
"RTN","SYNFPRB",15,0)
 . k @root@(ien,"load","conditions")
"RTN","SYNFPRB",16,0)
 . m @root@(ien,"load","conditions")=grtn("conditions")
"RTN","SYNFPRB",17,0)
 . if $g(args("debug"))=1 m rtn=grtn
"RTN","SYNFPRB",18,0)
 s rtn("conditionsStatus","status")=$g(grtn("status","status"))
"RTN","SYNFPRB",19,0)
 s rtn("conditionsStatus","loaded")=$g(grtn("status","loaded"))
"RTN","SYNFPRB",20,0)
 s rtn("conditionsStatus","errors")=$g(grtn("status","errors"))
"RTN","SYNFPRB",21,0)
 ;b
"RTN","SYNFPRB",22,0)
 ;
"RTN","SYNFPRB",23,0)
 ;
"RTN","SYNFPRB",24,0)
 q
"RTN","SYNFPRB",25,0)
 ;
"RTN","SYNFPRB",26,0)
wsIntakeConditions(args,body,result,ien)        ; web service entry (post)
"RTN","SYNFPRB",27,0)
 ; for intake of one or more Conditions. input are fhir resources
"RTN","SYNFPRB",28,0)
 ; result is json and summarizes what was done
"RTN","SYNFPRB",29,0)
 ; args include patientId
"RTN","SYNFPRB",30,0)
 ; ien is specified for internal calls, where the json is already in a graph
"RTN","SYNFPRB",31,0)
 n jtmp,json,jrslt,eval
"RTN","SYNFPRB",32,0)
 ;i $g(ien)'="" if $$loadStatus("conditions","",ien)=1 d  q  ;
"RTN","SYNFPRB",33,0)
 ;. s result("conditionsStatus","status")="alreadyLoaded"
"RTN","SYNFPRB",34,0)
 i $g(ien)'="" d  ; internal call
"RTN","SYNFPRB",35,0)
 . d getIntakeFhir^SYNFHIR("json",,"Condition",ien,1)
"RTN","SYNFPRB",36,0)
 e  d  ; 
"RTN","SYNFPRB",37,0)
 . s args("load")=0
"RTN","SYNFPRB",38,0)
 . merge jtmp=BODY
"RTN","SYNFPRB",39,0)
 . do DECODE^VPRJSON("jtmp","json")
"RTN","SYNFPRB",40,0)
 i '$d(json) q  ;
"RTN","SYNFPRB",41,0)
 m ^gpl("gjson")=json
"RTN","SYNFPRB",42,0)
 ;
"RTN","SYNFPRB",43,0)
 ; determine the patient
"RTN","SYNFPRB",44,0)
 ;
"RTN","SYNFPRB",45,0)
 n dfn,eval
"RTN","SYNFPRB",46,0)
 if $g(ien)'="" d  ;
"RTN","SYNFPRB",47,0)
 . s dfn=$$ien2dfn^SYNFUTL(ien) ; look up dfn in the graph
"RTN","SYNFPRB",48,0)
 else  d  ;
"RTN","SYNFPRB",49,0)
 . s dfn=$g(args("dfn"))
"RTN","SYNFPRB",50,0)
 . i dfn="" d  ;
"RTN","SYNFPRB",51,0)
 . . n icn s icn=$g(args("icn"))
"RTN","SYNFPRB",52,0)
 . . i icn'="" s dfn=$$icn2dfn^SYNFUTL(icn)
"RTN","SYNFPRB",53,0)
 i $g(dfn)="" do  quit  ; need the patient
"RTN","SYNFPRB",54,0)
 . s result("conditions",1,"log",1)="Error, patient not found.. terminating"
"RTN","SYNFPRB",55,0)
 ;
"RTN","SYNFPRB",56,0)
 ;
"RTN","SYNFPRB",57,0)
 new zi s zi=0
"RTN","SYNFPRB",58,0)
 for  set zi=$order(json("entry",zi)) quit:+zi=0  do  ;
"RTN","SYNFPRB",59,0)
 . ;
"RTN","SYNFPRB",60,0)
 . ; define a place to log the processing of this entry
"RTN","SYNFPRB",61,0)
 . ;
"RTN","SYNFPRB",62,0)
 . new jlog set jlog=$name(eval("conditions",zi))
"RTN","SYNFPRB",63,0)
 . ;
"RTN","SYNFPRB",64,0)
 . ; insure that the resourceType is Observation
"RTN","SYNFPRB",65,0)
 . ;
"RTN","SYNFPRB",66,0)
 . new type set type=$get(json("entry",zi,"resource","resourceType"))
"RTN","SYNFPRB",67,0)
 . if type'="Condition" do  quit  ;
"RTN","SYNFPRB",68,0)
 . . set eval("conditions",zi,"vars","resourceType")=type
"RTN","SYNFPRB",69,0)
 . . do log(jlog,"Resource type not Condition, skipping entry")
"RTN","SYNFPRB",70,0)
 . set eval("conditions",zi,"vars","resourceType")=type
"RTN","SYNFPRB",71,0)
 . ;
"RTN","SYNFPRB",72,0)
 . ; see if this resource has already been loaded. if so, skip it
"RTN","SYNFPRB",73,0)
 . ;
"RTN","SYNFPRB",74,0)
 . if $g(ien)'="" if $$loadStatus("condition",zi,ien)=1 do  quit  ;
"RTN","SYNFPRB",75,0)
 . . d log(jlog,"Condition already loaded, skipping")
"RTN","SYNFPRB",76,0)
 . ;
"RTN","SYNFPRB",77,0)
 . ; determine Condition snomed code, coding system, and display text
"RTN","SYNFPRB",78,0)
 . ;
"RTN","SYNFPRB",79,0)
 . ;
"RTN","SYNFPRB",80,0)
 . ; determine the id of the resource
"RTN","SYNFPRB",81,0)
 . ;
"RTN","SYNFPRB",82,0)
 . ;new id set id=$get(json("entry",zi,"resource","id"))
"RTN","SYNFPRB",83,0)
 . ;set eval("conditions",zi,"vars","id")=id
"RTN","SYNFPRB",84,0)
 . ;d log(jlog,"ID is: "_id)
"RTN","SYNFPRB",85,0)
 . ;
"RTN","SYNFPRB",86,0)
 . ;
"RTN","SYNFPRB",87,0)
 . ; determine the encounter visit ien
"RTN","SYNFPRB",88,0)
 . n encounterId
"RTN","SYNFPRB",89,0)
 . s encounterId=$g(json("entry",zi,"resource","context","reference"))
"RTN","SYNFPRB",90,0)
 . i encounterId["urn:uuid:" s encounterId=$p(encounterId,"urn:uuid:",2)
"RTN","SYNFPRB",91,0)
 . s eval("conditions",zi,"vars","encounterId")=encounterId
"RTN","SYNFPRB",92,0)
 . d log(jlog,"reference encounter ID is : "_encounterId)
"RTN","SYNFPRB",93,0)
 . ;
"RTN","SYNFPRB",94,0)
 . ; determine visit ien
"RTN","SYNFPRB",95,0)
 . ;
"RTN","SYNFPRB",96,0)
 . n visitIen s visitIen=$$visitIen^SYNFENC(ien,encounterId)
"RTN","SYNFPRB",97,0)
 . s eval("conditions",zi,"vars","visitIen")=visitIen
"RTN","SYNFPRB",98,0)
 . d log(jlog,"visit ien is: "_visitIen)
"RTN","SYNFPRB",99,0)
 . n visitDate s visitDate=$$GET1^DIQ(9000010,visitIen_",",.01,"I")
"RTN","SYNFPRB",100,0)
 . i visitDate'=-1 d  ;
"RTN","SYNFPRB",101,0)
 . . s eval("conditions",zi,"vars","visitDate")=visitDate
"RTN","SYNFPRB",102,0)
 . . d log(jlog,"visit date is: "_visitDate)
"RTN","SYNFPRB",103,0)
 . e  d log(jlog,"visit date unknow")
"RTN","SYNFPRB",104,0)
 . ;
"RTN","SYNFPRB",105,0)
 . ; determine the code
"RTN","SYNFPRB",106,0)
 . ; 
"RTN","SYNFPRB",107,0)
 . new sctcode set sctcode=$get(json("entry",zi,"resource","code","coding",1,"code"))
"RTN","SYNFPRB",108,0)
 . do log(jlog,"code is: "_sctcode)
"RTN","SYNFPRB",109,0)
 . set eval("conditions",zi,"vars","code")=sctcode
"RTN","SYNFPRB",110,0)
 . n icdcode,notmapped,icdcodetype
"RTN","SYNFPRB",111,0)
 . s notmapped=0
"RTN","SYNFPRB",112,0)
 . i visitDate<3151001 s icdcodetype="icd9"
"RTN","SYNFPRB",113,0)
 . e  s icdcodetype="icd10"
"RTN","SYNFPRB",114,0)
 . d log(jlog,"icd code type is: "_icdcodetype)
"RTN","SYNFPRB",115,0)
 . i icdcodetype="icd9" s icdcode=$$MAP^SYNDHPMP("sct2icdnine",sctcode)
"RTN","SYNFPRB",116,0)
 . e  s icdcode=$$MAP^SYNDHPMP("sct2icd",sctcode)
"RTN","SYNFPRB",117,0)
 . i +icdcode=-1 s notmapped=1
"RTN","SYNFPRB",118,0)
 . d:notmapped MAPERR^SYNQLDM(sctcode,icdcodetype)
"RTN","SYNFPRB",119,0)
 . do log(jlog,"icd mapping is: "_icdcode)
"RTN","SYNFPRB",120,0)
 . do:notmapped log(jlog,"snomed code "_sctcode_" is not mapped")
"RTN","SYNFPRB",121,0)
 . set eval("conditions",zi,"vars","mappedIcdCode")=icdcode
"RTN","SYNFPRB",122,0)
 . ;
"RTN","SYNFPRB",123,0)
 . ; determine the onset date and time
"RTN","SYNFPRB",124,0)
 . ;
"RTN","SYNFPRB",125,0)
 . new onsetdate set onsetdate=$get(json("entry",zi,"resource","onsetDateTime"))
"RTN","SYNFPRB",126,0)
 . do log(jlog,"onsetDateTime is: "_onsetdate)
"RTN","SYNFPRB",127,0)
 . set eval("conditions",zi,"vars","onsetDateTime")=onsetdate
"RTN","SYNFPRB",128,0)
 . new fmOnsetDateTime s fmOnsetDateTime=$$fhirTfm^SYNFUTL(onsetdate)
"RTN","SYNFPRB",129,0)
 . d log(jlog,"fileman onsetDateTime is: "_fmOnsetDateTime)
"RTN","SYNFPRB",130,0)
 . set eval("conditions",zi,"vars","fmOnsetDateTime")=fmOnsetDateTime ;
"RTN","SYNFPRB",131,0)
 . new hl7OnsetDateTime s hl7OnsetDateTime=$$fhirThl7^SYNFUTL(onsetdate)
"RTN","SYNFPRB",132,0)
 . d log(jlog,"hl7 onsetDateTime is: "_hl7OnsetDateTime)
"RTN","SYNFPRB",133,0)
 . set eval("conditions",zi,"vars","hl7OnsetDateTime")=hl7OnsetDateTime ;
"RTN","SYNFPRB",134,0)
 . ;
"RTN","SYNFPRB",135,0)
 . ; determine the abatement date and time, if any
"RTN","SYNFPRB",136,0)
 . ;
"RTN","SYNFPRB",137,0)
 . new abatementdate set abatementdate=$get(json("entry",zi,"resource","abatementDateTime"))
"RTN","SYNFPRB",138,0)
 . if abatementdate'="" d  ;
"RTN","SYNFPRB",139,0)
 . . do log(jlog,"abatementDateTime is: "_abatementdate)
"RTN","SYNFPRB",140,0)
 . . set eval("conditions",zi,"vars","abatementDateTime")=abatementdate
"RTN","SYNFPRB",141,0)
 . . new fmAbatementDateTime s fmAbatementDateTime=$$fhirTfm^SYNFUTL(abatementdate)
"RTN","SYNFPRB",142,0)
 . . d log(jlog,"fileman abatementDateTime is: "_fmAbatementDateTime)
"RTN","SYNFPRB",143,0)
 . . set eval("conditions",zi,"vars","fmAbatementDateTime")=fmAbatementDateTime ;
"RTN","SYNFPRB",144,0)
 . . new hl7AbatementDateTime s hl7AbatementDateTime=$$fhirThl7^SYNFUTL(abatementdate)
"RTN","SYNFPRB",145,0)
 . . d log(jlog,"hl7 abatementDateTime is: "_hl7AbatementDateTime)
"RTN","SYNFPRB",146,0)
 . . set eval("conditions",zi,"vars","hl7AbatementDateTime")=hl7AbatementDateTime ;
"RTN","SYNFPRB",147,0)
 . else  d log(jlog,"no abatementDateTime")
"RTN","SYNFPRB",148,0)
 . ;
"RTN","SYNFPRB",149,0)
 . ; determine clinical status (active vs inactive)
"RTN","SYNFPRB",150,0)
 . ;
"RTN","SYNFPRB",151,0)
 . n clinicalstatus set clinicalstatus=$get(json("entry",zi,"resource","clinicalStatus"))
"RTN","SYNFPRB",152,0)
 . i $get(abatementdate)'="" set clinicalstatus="inactive" ; VistA doesn't allow active problems with a resolution date
"RTN","SYNFPRB",153,0)
 . ;
"RTN","SYNFPRB",154,0)
 . ; determine the encounter visit ien
"RTN","SYNFPRB",155,0)
 . n encounterId
"RTN","SYNFPRB",156,0)
 . s encounterId=$g(json("entry",zi,"resource","context","reference"))
"RTN","SYNFPRB",157,0)
 . i encounterId["urn:uuid:" s encounterId=$p(encounterId,"urn:uuid:",2)
"RTN","SYNFPRB",158,0)
 . s eval("conditions",zi,"vars","encounterId")=encounterId
"RTN","SYNFPRB",159,0)
 . d log(jlog,"reference encounter ID is : "_encounterId)
"RTN","SYNFPRB",160,0)
 . ;
"RTN","SYNFPRB",161,0)
 . ; determine visit ien
"RTN","SYNFPRB",162,0)
 . ;
"RTN","SYNFPRB",163,0)
 . n visitIen s visitIen=$$visitIen^SYNFENC(ien,encounterId)
"RTN","SYNFPRB",164,0)
 . s eval("conditions",zi,"vars","visitIen")=visitIen
"RTN","SYNFPRB",165,0)
 . d log(jlog,"visit ien is: "_visitIen)
"RTN","SYNFPRB",166,0)
 . ;
"RTN","SYNFPRB",167,0)
 . ; set up to call the data loader
"RTN","SYNFPRB",168,0)
 . ;
"RTN","SYNFPRB",169,0)
 . ;PRBUPDT(RETSTA,DHPPAT,DHPVST,DHPROV,DHPONS,DHPABT,DHPCLNST,DHPSCT)   ;Problem/Condition update
"RTN","SYNFPRB",170,0)
 . n RETSTA,DHPPAT,DHPVST,DHPROV,DHPONS,DHPABT,DHPCLNST,DHPSCT ;Problem/Condition update
"RTN","SYNFPRB",171,0)
 . s (DHPPAT,DHPVST,DHPROV,DHPONS,DHPABT,DHPCLNST,DHPSCT)=""      ;Condition update
"RTN","SYNFPRB",172,0)
 . ;
"RTN","SYNFPRB",173,0)
 . s DHPPAT=$$dfn2icn^SYNFUTL(dfn)
"RTN","SYNFPRB",174,0)
 . s eval("conditions",zi,"parms","DHPPAT")=DHPPAT
"RTN","SYNFPRB",175,0)
 . ;
"RTN","SYNFPRB",176,0)
 . s DHPVST=visitIen
"RTN","SYNFPRB",177,0)
 . s eval("conditions",zi,"parms","DHPVST")=visitIen
"RTN","SYNFPRB",178,0)
 . ;
"RTN","SYNFPRB",179,0)
 . s DHPSCT=sctcode
"RTN","SYNFPRB",180,0)
 . s eval("conditions",zi,"parms","DHPSCT")=DHPSCT
"RTN","SYNFPRB",181,0)
 . ;
"RTN","SYNFPRB",182,0)
 . s DHPCLNST=$S(clinicalstatus="Active":"A",1:"I")
"RTN","SYNFPRB",183,0)
 . s eval("conditions",zi,"parms","DHPCLNST")=DHPCLNST
"RTN","SYNFPRB",184,0)
 . ;
"RTN","SYNFPRB",185,0)
 . s DHPONS=hl7OnsetDateTime
"RTN","SYNFPRB",186,0)
 . s eval("conditions",zi,"parms","DHPONS")=DHPONS
"RTN","SYNFPRB",187,0)
 . ;
"RTN","SYNFPRB",188,0)
 . s DHPROV=$$MAP^SYNQLDM("OP","provider") ; map should return the NPI number
"RTN","SYNFPRB",189,0)
 . ;n DHPPROVIEN s DHPPROVIEN=$o(^VA(200,"B",IMMPROV,""))
"RTN","SYNFPRB",190,0)
 . ;if DHPPROVIEN="" S DHPPROVIEN=3
"RTN","SYNFPRB",191,0)
 . s eval("conditions",zi,"parms","DHPROV")=DHPROV
"RTN","SYNFPRB",192,0)
 . d log(jlog,"Provider NPI for outpatient is: "_DHPROV)
"RTN","SYNFPRB",193,0)
 . ;
"RTN","SYNFPRB",194,0)
 . ;s DHPLOC=$$MAP^SYNQLDM("OP","location")
"RTN","SYNFPRB",195,0)
 . ;n DHPLOCIEN s DHPLOCIEN=$o(^SC("B",DHPLOC,""))
"RTN","SYNFPRB",196,0)
 . ;if DHPLOCIEN="" S DHPLOCIEN=4
"RTN","SYNFPRB",197,0)
 . ;s eval("conditions",zi,"parms","DHPLOC")=DHPLOCIEN
"RTN","SYNFPRB",198,0)
 . ;d log(jlog,"Location for outpatient is: #"_DHPLOCIEN_" "_DHPLOC)
"RTN","SYNFPRB",199,0)
 . ;
"RTN","SYNFPRB",200,0)
 . s eval("conditions",zi,"status","loadstatus")="readyToLoad"
"RTN","SYNFPRB",201,0)
 . ;
"RTN","SYNFPRB",202,0)
 . if $g(args("load"))=1 d  ; only load if told to
"RTN","SYNFPRB",203,0)
 . . if $g(ien)'="" if $$loadStatus("conditions",zi,ien)=1 do  quit  ;
"RTN","SYNFPRB",204,0)
 . . . d log(jlog,"Condition already loaded, skipping")
"RTN","SYNFPRB",205,0)
 . . i notmapped d  ; snomed code does not map to icd code, can't use DATA2PCE
"RTN","SYNFPRB",206,0)
 . . . d log(jlog,"Calling PROBUPD^SYNDHP61 to add condition")
"RTN","SYNFPRB",207,0)
 . . . n DHPSDES,DHPRID,DHPDTM S (DHPSDES,DHPRID)=""
"RTN","SYNFPRB",208,0)
 . . . s DHPDTM=DHPONS
"RTN","SYNFPRB",209,0)
 . . . D PROBUPD^SYNDHP61(.RETSTA,DHPPAT,DHPSCT,DHPSDES,DHPROV,DHPDTM,DHPRID) ; update problem list with Snomed code
"RTN","SYNFPRB",210,0)
 . . i 'notmapped d  ; snomed code does map, use DATA2PCE to add problem to problem list
"RTN","SYNFPRB",211,0)
 . . . d log(jlog,"Calling PRBUPDT^SYNDHP62 to add snomed condition")
"RTN","SYNFPRB",212,0)
 . . . D PRBUPDT^SYNDHP62(.RETSTA,DHPPAT,DHPVST,DHPROV,DHPONS,DHPABT,DHPCLNST,DHPSCT)    ;Problem/Condition update
"RTN","SYNFPRB",213,0)
 . . m eval("conditions",zi,"status")=RETSTA
"RTN","SYNFPRB",214,0)
 . . i $g(DEBUG)=1 ZW RETSTA
"RTN","SYNFPRB",215,0)
 . . d log(jlog,"Return from data loader was: "_$g(RETSTA))
"RTN","SYNFPRB",216,0)
 . . if +$g(RETSTA)=1 do  ;
"RTN","SYNFPRB",217,0)
 . . . s eval("status","loaded")=$g(eval("status","loaded"))+1
"RTN","SYNFPRB",218,0)
 . . . s eval("conditions",zi,"status","loadstatus")="loaded"
"RTN","SYNFPRB",219,0)
 . . else  d  ;
"RTN","SYNFPRB",220,0)
 . . . s eval("status","errors")=$g(eval("status","errors"))+1
"RTN","SYNFPRB",221,0)
 . . . s eval("conditions",zi,"status","loadstatus")="notLoaded"
"RTN","SYNFPRB",222,0)
 . . . s eval("conditions",zi,"status","loadMessage")=$g(RETSTA)
"RTN","SYNFPRB",223,0)
 . . n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFPRB",224,0)
 . . k @root@(ien,"load","conditions",zi)
"RTN","SYNFPRB",225,0)
 . . m @root@(ien,"load","conditions",zi)=eval("conditions",zi)
"RTN","SYNFPRB",226,0)
 ;
"RTN","SYNFPRB",227,0)
 if $get(args("debug"))=1 do  ;
"RTN","SYNFPRB",228,0)
 . m jrslt("source")=json
"RTN","SYNFPRB",229,0)
 . m jrslt("args")=args
"RTN","SYNFPRB",230,0)
 . m jrslt("eval")=eval
"RTN","SYNFPRB",231,0)
 m jrslt("conditionsStatus")=eval("conditionsStatus")
"RTN","SYNFPRB",232,0)
 set jrslt("result","status")="ok"
"RTN","SYNFPRB",233,0)
 set jrslt("result","loaded")=$g(eval("status","loaded"))
"RTN","SYNFPRB",234,0)
 i $g(ien)'="" d  ; called internally
"RTN","SYNFPRB",235,0)
 . m result=eval
"RTN","SYNFPRB",236,0)
 . m result("status")=jrslt("result")
"RTN","SYNFPRB",237,0)
 . m result("dfn")=dfn
"RTN","SYNFPRB",238,0)
 . m result("ien")=ien
"RTN","SYNFPRB",239,0)
 . ;b
"RTN","SYNFPRB",240,0)
 e  d  ;
"RTN","SYNFPRB",241,0)
 . d ENCODE^VPRJSON("jrslt","result")
"RTN","SYNFPRB",242,0)
 . set HTTPRSP("mime")="application/json" 
"RTN","SYNFPRB",243,0)
 q
"RTN","SYNFPRB",244,0)
 ;
"RTN","SYNFPRB",245,0)
log(ary,txt)    ; adds a text line to @ary@("log")
"RTN","SYNFPRB",246,0)
 s @ary@("log",$o(@ary@("log",""),-1)+1)=$g(txt)
"RTN","SYNFPRB",247,0)
 w:$G(DEBUG) !,"      ",$G(txt)
"RTN","SYNFPRB",248,0)
 q
"RTN","SYNFPRB",249,0)
 ;
"RTN","SYNFPRB",250,0)
loadStatus(typ,zx,zien) ; extrinsic return 1 if resource was loaded
"RTN","SYNFPRB",251,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFPRB",252,0)
 n rt s rt=0
"RTN","SYNFPRB",253,0)
 i $g(zx)="" i $d(@root@(zien,"load",typ)) s rt=1 q rt
"RTN","SYNFPRB",254,0)
 i $get(@root@(zien,"load",typ,zx,"status","loadstatus"))="loaded" s rt=1
"RTN","SYNFPRB",255,0)
 q rt
"RTN","SYNFPRB",256,0)
 ;
"RTN","SYNFPRB",257,0)
testall ; run the conditions import on all imported patients
"RTN","SYNFPRB",258,0)
 new root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFPRB",259,0)
 new indx s indx=$na(@root@("POS","DFN"))
"RTN","SYNFPRB",260,0)
 n dfn,ien,filter,reslt
"RTN","SYNFPRB",261,0)
 s dfn=0
"RTN","SYNFPRB",262,0)
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  d  ;
"RTN","SYNFPRB",263,0)
 . s ien=$o(@indx@(dfn,""))
"RTN","SYNFPRB",264,0)
 . q:ien=""
"RTN","SYNFPRB",265,0)
 . s filter("dfn")=dfn
"RTN","SYNFPRB",266,0)
 . k reslt
"RTN","SYNFPRB",267,0)
 . d wsIntakeConditions(.filter,,.reslt,ien)
"RTN","SYNFPRB",268,0)
 q
"RTN","SYNFPRB",269,0)
 ;
"RTN","SYNFPRB",270,0)
testone(reslt,doload)   ; run the conditions import on all imported patients
"RTN","SYNFPRB",271,0)
 new root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFPRB",272,0)
 new indx s indx=$na(@root@("POS","DFN"))
"RTN","SYNFPRB",273,0)
 n dfn,ien,filter
"RTN","SYNFPRB",274,0)
 n done s done=0
"RTN","SYNFPRB",275,0)
 s dfn=0
"RTN","SYNFPRB",276,0)
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  q:done   d  ;
"RTN","SYNFPRB",277,0)
 . s ien=$o(@indx@(dfn,""))
"RTN","SYNFPRB",278,0)
 . q:ien=""
"RTN","SYNFPRB",279,0)
 . q:$d(@root@(ien,"load","conditions"))
"RTN","SYNFPRB",280,0)
 . s filter("dfn")=dfn
"RTN","SYNFPRB",281,0)
 . s filter("debug")=1
"RTN","SYNFPRB",282,0)
 . i $g(doload)=1 s filter("load")=1
"RTN","SYNFPRB",283,0)
 . k reslt
"RTN","SYNFPRB",284,0)
 . d wsIntakeConditions(.filter,,.reslt,ien)
"RTN","SYNFPRB",285,0)
 . s done=1
"RTN","SYNFPRB",286,0)
 q
"RTN","SYNFPRB",287,0)
 ;
"RTN","SYNFPROC")
0^52^B88197706
"RTN","SYNFPROC",1,0)
SYNFPROC ;ven/gpl - fhir loader utilities ;2018-08-17  3:28 PM
"RTN","SYNFPROC",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNFPROC",3,0)
 ;
"RTN","SYNFPROC",4,0)
 ; Authored by George P. Lilly 2017-2018
"RTN","SYNFPROC",5,0)
 ;
"RTN","SYNFPROC",6,0)
 ; 
"RTN","SYNFPROC",7,0)
 q
"RTN","SYNFPROC",8,0)
 ;
"RTN","SYNFPROC",9,0)
importProcedures(rtn,ien,args)  ; entry point for loading Procedures for a patient
"RTN","SYNFPROC",10,0)
 ; calls the intake Procedures web service directly
"RTN","SYNFPROC",11,0)
 ;
"RTN","SYNFPROC",12,0)
 n grtn
"RTN","SYNFPROC",13,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFPROC",14,0)
 d wsIntakeProcedures(.args,,.grtn,ien)
"RTN","SYNFPROC",15,0)
 i $d(grtn) d  ; something was returned
"RTN","SYNFPROC",16,0)
 . k @root@(ien,"load","procedures")
"RTN","SYNFPROC",17,0)
 . m @root@(ien,"load","procedures")=grtn("procedures")
"RTN","SYNFPROC",18,0)
 . if $g(args("debug"))=1 m rtn=grtn
"RTN","SYNFPROC",19,0)
 s rtn("conditionsStatus","status")=$g(grtn("status","status"))
"RTN","SYNFPROC",20,0)
 s rtn("conditionsStatus","loaded")=$g(grtn("status","loaded"))
"RTN","SYNFPROC",21,0)
 s rtn("conditionsStatus","errors")=$g(grtn("status","errors"))
"RTN","SYNFPROC",22,0)
 ;b
"RTN","SYNFPROC",23,0)
 ;
"RTN","SYNFPROC",24,0)
 ;
"RTN","SYNFPROC",25,0)
 q
"RTN","SYNFPROC",26,0)
 ;
"RTN","SYNFPROC",27,0)
wsIntakeProcedures(args,body,result,ien) ; web service entry (post)
"RTN","SYNFPROC",28,0)
 ; for intake of one or more Procedures. input are fhir resources
"RTN","SYNFPROC",29,0)
 ; result is json and summarizes what was done
"RTN","SYNFPROC",30,0)
 ; args include patientId
"RTN","SYNFPROC",31,0)
 ; ien is specified for internal calls, where the json is already in a graph
"RTN","SYNFPROC",32,0)
 n jtmp,json,jrslt,eval
"RTN","SYNFPROC",33,0)
 ;i $g(ien)'="" if $$loadStatus("procedures","",ien)=1 d  q  ;
"RTN","SYNFPROC",34,0)
 ;. s result("proceduresStatus","status")="alreadyLoaded"
"RTN","SYNFPROC",35,0)
 i $g(ien)'="" d  ; internal call
"RTN","SYNFPROC",36,0)
 . d getIntakeFhir^SYNFHIR("json",,"Procedure",ien,1)
"RTN","SYNFPROC",37,0)
 e  d  ; 
"RTN","SYNFPROC",38,0)
 . s args("load")=0
"RTN","SYNFPROC",39,0)
 . merge jtmp=BODY
"RTN","SYNFPROC",40,0)
 . do DECODE^VPRJSON("jtmp","json")
"RTN","SYNFPROC",41,0)
 i '$d(json) q  ;
"RTN","SYNFPROC",42,0)
 m ^gpl("gjson")=json
"RTN","SYNFPROC",43,0)
 ;
"RTN","SYNFPROC",44,0)
 ; determine the patient
"RTN","SYNFPROC",45,0)
 ;
"RTN","SYNFPROC",46,0)
 n dfn,eval
"RTN","SYNFPROC",47,0)
 if $g(ien)'="" d  ;
"RTN","SYNFPROC",48,0)
 . s dfn=$$ien2dfn^SYNFUTL(ien) ; look up dfn in the graph
"RTN","SYNFPROC",49,0)
 else  d  ;
"RTN","SYNFPROC",50,0)
 . s dfn=$g(args("dfn"))
"RTN","SYNFPROC",51,0)
 . i dfn="" d  ;
"RTN","SYNFPROC",52,0)
 . . n icn s icn=$g(args("icn"))
"RTN","SYNFPROC",53,0)
 . . i icn'="" s dfn=$$icn2dfn^SYNFUTL(icn)
"RTN","SYNFPROC",54,0)
 i $g(dfn)="" do  quit  ; need the patient
"RTN","SYNFPROC",55,0)
 . s result("procedures",1,"log",1)="Error, patient not found.. terminating"
"RTN","SYNFPROC",56,0)
 ;
"RTN","SYNFPROC",57,0)
 ;
"RTN","SYNFPROC",58,0)
 new zi s zi=0
"RTN","SYNFPROC",59,0)
 for  set zi=$order(json("entry",zi)) quit:+zi=0  do  ;
"RTN","SYNFPROC",60,0)
 . ;
"RTN","SYNFPROC",61,0)
 . ; define a place to log the processing of this entry
"RTN","SYNFPROC",62,0)
 . ;
"RTN","SYNFPROC",63,0)
 . new jlog set jlog=$name(eval("procedures",zi))
"RTN","SYNFPROC",64,0)
 . ;
"RTN","SYNFPROC",65,0)
 . ; insure that the resourceType is Procedure
"RTN","SYNFPROC",66,0)
 . ;
"RTN","SYNFPROC",67,0)
 . new type set type=$get(json("entry",zi,"resource","resourceType"))
"RTN","SYNFPROC",68,0)
 . if type'="Procedure" do  quit  ;
"RTN","SYNFPROC",69,0)
 . . set eval("procedures",zi,"vars","resourceType")=type
"RTN","SYNFPROC",70,0)
 . . do log(jlog,"Resource type not Procedure, skipping entry")
"RTN","SYNFPROC",71,0)
 . set eval("procedures",zi,"vars","resourceType")=type
"RTN","SYNFPROC",72,0)
 . ;
"RTN","SYNFPROC",73,0)
 . ; see if this resource has already been loaded. if so, skip it
"RTN","SYNFPROC",74,0)
 . ;
"RTN","SYNFPROC",75,0)
 . if $g(ien)'="" if $$loadStatus("procedure",zi,ien)=1 do  quit  ;
"RTN","SYNFPROC",76,0)
 . . d log(jlog,"Procedure already loaded, skipping")
"RTN","SYNFPROC",77,0)
 . ;
"RTN","SYNFPROC",78,0)
 . ; determine Procedure snomed code, coding system, and display text
"RTN","SYNFPROC",79,0)
 . ;
"RTN","SYNFPROC",80,0)
 . new sctcode set sctcode=$get(json("entry",zi,"resource","code","coding",1,"code"))
"RTN","SYNFPROC",81,0)
 . do log(jlog,"code is: "_sctcode)
"RTN","SYNFPROC",82,0)
 . set eval("procedures",zi,"vars","code")=sctcode
"RTN","SYNFPROC",83,0)
 . ;
"RTN","SYNFPROC",84,0)
 . ;
"RTN","SYNFPROC",85,0)
 . new codesystem set codesystem=$get(json("entry",zi,"resource","code","coding",1,"system"))
"RTN","SYNFPROC",86,0)
 . do log(jlog,"code system is: "_codesystem)
"RTN","SYNFPROC",87,0)
 . set eval("procedures",zi,"vars","codeSystem")=codesystem
"RTN","SYNFPROC",88,0)
 . ;
"RTN","SYNFPROC",89,0)
 . ; determine the date and time
"RTN","SYNFPROC",90,0)
 . ;
"RTN","SYNFPROC",91,0)
 . new performeddate set performeddate=$get(json("entry",zi,"resource","performedDateTime"))
"RTN","SYNFPROC",92,0)
 . i performeddate="" set performeddate=$get(json("entry",zi,"resource","performedPeriod","start"))
"RTN","SYNFPROC",93,0)
 . do log(jlog,"onsetDateTime is: "_performeddate)
"RTN","SYNFPROC",94,0)
 . set eval("procedures",zi,"vars","performedDateTime")=performeddate
"RTN","SYNFPROC",95,0)
 . new fmOnsetDateTime s fmOnsetDateTime=$$fhirTfm^SYNFUTL(performeddate)
"RTN","SYNFPROC",96,0)
 . d log(jlog,"fileman onsetDateTime is: "_fmOnsetDateTime)
"RTN","SYNFPROC",97,0)
 . set eval("procedures",zi,"vars","fmOnsetDateTime")=fmOnsetDateTime ;
"RTN","SYNFPROC",98,0)
 . new hl7OnsetDateTime s hl7OnsetDateTime=$$fhirThl7^SYNFUTL(performeddate)
"RTN","SYNFPROC",99,0)
 . d log(jlog,"hl7 onsetDateTime is: "_hl7OnsetDateTime)
"RTN","SYNFPROC",100,0)
 . set eval("procedures",zi,"vars","hl7OnsetDateTime")=hl7OnsetDateTime ;
"RTN","SYNFPROC",101,0)
 . ;
"RTN","SYNFPROC",102,0)
 . ;
"RTN","SYNFPROC",103,0)
 . ; determine the encounter visit ien
"RTN","SYNFPROC",104,0)
 . n encounterId
"RTN","SYNFPROC",105,0)
 . s encounterId=$g(json("entry",zi,"resource","context","reference"))
"RTN","SYNFPROC",106,0)
 . i encounterId["urn:uuid:" s encounterId=$p(encounterId,"urn:uuid:",2)
"RTN","SYNFPROC",107,0)
 . s eval("procedures",zi,"vars","encounterId")=encounterId
"RTN","SYNFPROC",108,0)
 . d log(jlog,"reference encounter ID is : "_encounterId)
"RTN","SYNFPROC",109,0)
 . ;
"RTN","SYNFPROC",110,0)
 . ; determine visit ien
"RTN","SYNFPROC",111,0)
 . ;
"RTN","SYNFPROC",112,0)
 . n visitIen s visitIen=$$visitIen^SYNFENC(ien,encounterId)
"RTN","SYNFPROC",113,0)
 . s eval("procedures",zi,"vars","visitIen")=visitIen
"RTN","SYNFPROC",114,0)
 . d log(jlog,"visit ien is: "_visitIen)
"RTN","SYNFPROC",115,0)
 . ;
"RTN","SYNFPROC",116,0)
 . ; set up to call the data loader
"RTN","SYNFPROC",117,0)
 . ;
"RTN","SYNFPROC",118,0)
 . ;PRCADD(RETSTA,DHPPAT,DHPVST,DHPCNT,DHPDSCT,DHPDTM)
"RTN","SYNFPROC",119,0)
 . n RETSTA,DHPPAT,DHPVST,DHPCNT,DHPDSCT,DHPDTM ;
"RTN","SYNFPROC",120,0)
 . s (DHPPAT,DHPVST,DHPCNT,DHPDSCT,DHPDTM)=""
"RTN","SYNFPROC",121,0)
 . ;
"RTN","SYNFPROC",122,0)
 . s DHPPAT=$$dfn2icn^SYNFUTL(dfn)
"RTN","SYNFPROC",123,0)
 . s eval("procedures",zi,"parms","DHPPAT")=DHPPAT
"RTN","SYNFPROC",124,0)
 . ;
"RTN","SYNFPROC",125,0)
 . s DHPCNT=1 ; always one procedure per resource
"RTN","SYNFPROC",126,0)
 . ;
"RTN","SYNFPROC",127,0)
 . s DHPVST=visitIen
"RTN","SYNFPROC",128,0)
 . s eval("procedures",zi,"parms","DHPVST")=visitIen
"RTN","SYNFPROC",129,0)
 . ;
"RTN","SYNFPROC",130,0)
 . s DHPDSCT=sctcode
"RTN","SYNFPROC",131,0)
 . s eval("procedures",zi,"parms","DHPDSCT")=DHPDSCT
"RTN","SYNFPROC",132,0)
 . ;
"RTN","SYNFPROC",133,0)
 . s DHPDTM=hl7OnsetDateTime
"RTN","SYNFPROC",134,0)
 . s eval("procedures",zi,"parms","DHPDTM")=DHPDTM
"RTN","SYNFPROC",135,0)
 . ;
"RTN","SYNFPROC",136,0)
 . ;
"RTN","SYNFPROC",137,0)
 . s eval("procedures",zi,"status","loadstatus")="readyToLoad"
"RTN","SYNFPROC",138,0)
 . ;
"RTN","SYNFPROC",139,0)
 . if $g(args("load"))=1 d  ; only load if told to
"RTN","SYNFPROC",140,0)
 . . if $g(ien)'="" if $$loadStatus("procedures",zi,ien)=1 do  quit  ;
"RTN","SYNFPROC",141,0)
 . . . d log(jlog,"Procedure already loaded, skipping")
"RTN","SYNFPROC",142,0)
 . . d log(jlog,"Calling PRCADD^SYNDHP65 to add procedure")
"RTN","SYNFPROC",143,0)
 . . D PRCADD^SYNDHP65(.RETSTA,DHPPAT,DHPVST,DHPCNT,DHPDSCT,DHPDTM) ; procedures update
"RTN","SYNFPROC",144,0)
 . . m eval("procedures",zi,"status")=RETSTA
"RTN","SYNFPROC",145,0)
 . . d log(jlog,"Return from data loader was: "_$g(RETSTA))
"RTN","SYNFPROC",146,0)
 . . if +$g(RETSTA)=1 do  ;
"RTN","SYNFPROC",147,0)
 . . . s eval("status","loaded")=$g(eval("status","loaded"))+1
"RTN","SYNFPROC",148,0)
 . . . s eval("procedures",zi,"status","loadstatus")="loaded"
"RTN","SYNFPROC",149,0)
 . . else  d  ;
"RTN","SYNFPROC",150,0)
 . . . s eval("status","errors")=$g(eval("status","errors"))+1
"RTN","SYNFPROC",151,0)
 . . . s eval("procedures",zi,"status","loadstatus")="notLoaded"
"RTN","SYNFPROC",152,0)
 . . . s eval("procedures",zi,"status","loadMessage")=$g(RETSTA)
"RTN","SYNFPROC",153,0)
 . . n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFPROC",154,0)
 . . k @root@(ien,"load","procedures",zi)
"RTN","SYNFPROC",155,0)
 . . m @root@(ien,"load","procedures",zi)=eval("procedures",zi)
"RTN","SYNFPROC",156,0)
 ;
"RTN","SYNFPROC",157,0)
 if $get(args("debug"))=1 do  ;
"RTN","SYNFPROC",158,0)
 . m jrslt("source")=json
"RTN","SYNFPROC",159,0)
 . m jrslt("args")=args
"RTN","SYNFPROC",160,0)
 . m jrslt("eval")=eval
"RTN","SYNFPROC",161,0)
 m jrslt("proceduresStatus")=eval("proceduresStatus")
"RTN","SYNFPROC",162,0)
 set jrslt("result","status")="ok"
"RTN","SYNFPROC",163,0)
 set jrslt("result","loaded")=$g(eval("status","loaded"))
"RTN","SYNFPROC",164,0)
 i $g(ien)'="" d  ; called internally
"RTN","SYNFPROC",165,0)
 . m result=eval
"RTN","SYNFPROC",166,0)
 . m result("status")=jrslt("result")
"RTN","SYNFPROC",167,0)
 . m result("dfn")=dfn
"RTN","SYNFPROC",168,0)
 . m result("ien")=ien
"RTN","SYNFPROC",169,0)
 . ;b
"RTN","SYNFPROC",170,0)
 e  d  ;
"RTN","SYNFPROC",171,0)
 . d ENCODE^VPRJSON("jrslt","result")
"RTN","SYNFPROC",172,0)
 . set HTTPRSP("mime")="application/json" 
"RTN","SYNFPROC",173,0)
 q
"RTN","SYNFPROC",174,0)
 ;
"RTN","SYNFPROC",175,0)
log(ary,txt)  ; adds a text line to @ary@("log")
"RTN","SYNFPROC",176,0)
 s @ary@("log",$o(@ary@("log",""),-1)+1)=$g(txt)
"RTN","SYNFPROC",177,0)
 w:$G(DEBUG) !,"      ",$G(txt)
"RTN","SYNFPROC",178,0)
 q
"RTN","SYNFPROC",179,0)
 ;
"RTN","SYNFPROC",180,0)
loadStatus(typ,zx,zien) ; extrinsic return 1 if resource was loaded
"RTN","SYNFPROC",181,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFPROC",182,0)
 n rt s rt=0
"RTN","SYNFPROC",183,0)
 i $g(zx)="" i $d(@root@(zien,"load",typ)) s rt=1 q rt
"RTN","SYNFPROC",184,0)
 i $get(@root@(zien,"load",typ,zx,"status","loadstatus"))="loaded" s rt=1
"RTN","SYNFPROC",185,0)
 q rt
"RTN","SYNFPROC",186,0)
 ;
"RTN","SYNFPROC",187,0)
testall ; run the procedures import on all imported patients
"RTN","SYNFPROC",188,0)
 new root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFPROC",189,0)
 new indx s indx=$na(@root@("POS","DFN"))
"RTN","SYNFPROC",190,0)
 n dfn,ien,filter,reslt
"RTN","SYNFPROC",191,0)
 s dfn=" "
"RTN","SYNFPROC",192,0)
 f  s dfn=$o(@indx@(dfn),-1) q:+dfn=0  d  ;
"RTN","SYNFPROC",193,0)
 . s ien=$o(@indx@(dfn,""))
"RTN","SYNFPROC",194,0)
 . q:ien=""
"RTN","SYNFPROC",195,0)
 . s filter("dfn")=dfn
"RTN","SYNFPROC",196,0)
 . s filter("load")=1
"RTN","SYNFPROC",197,0)
 . k reslt
"RTN","SYNFPROC",198,0)
 . d wsIntakeProcedures(.filter,,.reslt,ien)
"RTN","SYNFPROC",199,0)
 q
"RTN","SYNFPROC",200,0)
 ;
"RTN","SYNFPROC",201,0)
testone(reslt,doload,ien) ; run the procedures import on one patients
"RTN","SYNFPROC",202,0)
 ; ien is optional but will be used if specified
"RTN","SYNFPROC",203,0)
 new root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFPROC",204,0)
 new indx s indx=$na(@root@("POS","DFN"))
"RTN","SYNFPROC",205,0)
 n dfn,filter
"RTN","SYNFPROC",206,0)
 n done s done=0
"RTN","SYNFPROC",207,0)
 s dfn=0
"RTN","SYNFPROC",208,0)
 i $g(ien)="" f  s dfn=$o(@indx@(dfn)) q:+dfn=0  q:done  d  ;
"RTN","SYNFPROC",209,0)
 . s ien=$o(@indx@(dfn,""))
"RTN","SYNFPROC",210,0)
 . q:ien=""
"RTN","SYNFPROC",211,0)
 . q:$d(@root@(ien,"load","procedures"))
"RTN","SYNFPROC",212,0)
 . s done=1
"RTN","SYNFPROC",213,0)
 i $g(ien)'="" d  ;
"RTN","SYNFPROC",214,0)
 . s filter("dfn")=$g(dfn)
"RTN","SYNFPROC",215,0)
 . s filter("debug")=1
"RTN","SYNFPROC",216,0)
 . i $g(doload)=1 s filter("load")=1
"RTN","SYNFPROC",217,0)
 . k reslt
"RTN","SYNFPROC",218,0)
 . d wsIntakeProcedures(.filter,,.reslt,ien)
"RTN","SYNFPROC",219,0)
 . s done=1
"RTN","SYNFPROC",220,0)
 q
"RTN","SYNFPROC",221,0)
 ;
"RTN","SYNFPROC",222,0)
procsum ; search all loaded patients and catelog the procedure codes
"RTN","SYNFPROC",223,0)
 n root,json,ien,table
"RTN","SYNFPROC",224,0)
 s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFPROC",225,0)
 s ien=0
"RTN","SYNFPROC",226,0)
 f  s ien=$o(@root@(ien)) q:+ien=0  d  ;
"RTN","SYNFPROC",227,0)
 . k json
"RTN","SYNFPROC",228,0)
 . d getIntakeFhir^SYNFHIR("json",,"Procedure",ien,1)
"RTN","SYNFPROC",229,0)
 . n cde,txt,rien
"RTN","SYNFPROC",230,0)
 . s rien=0
"RTN","SYNFPROC",231,0)
 . f  s rien=$o(json("entry",rien)) q:+rien=0  d  ;
"RTN","SYNFPROC",232,0)
 . . n gn s gn=$na(json("entry",rien,"resource"))
"RTN","SYNFPROC",233,0)
 . . s cde=$g(@gn@("code","coding",1,"code"))
"RTN","SYNFPROC",234,0)
 . . q:cde=""
"RTN","SYNFPROC",235,0)
 . . s txt=$g(@gn@("code","coding",1,"display"))
"RTN","SYNFPROC",236,0)
 . . i '$d(table(cde)) s table(cde_" "_txt)=1 q  ;
"RTN","SYNFPROC",237,0)
 . . s table(cde,txt)=$g(table(cde,txt))+1
"RTN","SYNFPROC",238,0)
 n zi s zi=""
"RTN","SYNFPROC",239,0)
 f  s zi=$o(table(zi)) q:zi=""  d  ;
"RTN","SYNFPROC",240,0)
 . w !,zi
"RTN","SYNFPROC",241,0)
 . ;w "|"
"RTN","SYNFPROC",242,0)
 . ;w $o(table(zi,""))
"RTN","SYNFPROC",243,0)
 ;zwr table
"RTN","SYNFPROC",244,0)
 q
"RTN","SYNFPROC",245,0)
 ;
"RTN","SYNFPUL")
0^38^B151812862
"RTN","SYNFPUL",1,0)
SYNFPUL ;ven/gpl - fhir loader utilities ;2018-08-17  3:26 PM
"RTN","SYNFPUL",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNFPUL",3,0)
 ;
"RTN","SYNFPUL",4,0)
 ; Authored by George P. Lilly 2017-2018
"RTN","SYNFPUL",5,0)
 ;
"RTN","SYNFPUL",6,0)
 ;
"RTN","SYNFPUL",7,0)
 ; patient list pull routines
"RTN","SYNFPUL",8,0)
 q
"RTN","SYNFPUL",9,0)
 ;
"RTN","SYNFPUL",10,0)
wsPull(rtn,filter)      ; pull web service. assumes url to list is passed as filter("listurl")=url
"RTN","SYNFPUL",11,0)
 ;
"RTN","SYNFPUL",12,0)
 n groot s groot=$$setroot^%wd("patient-lists")
"RTN","SYNFPUL",13,0)
 ;
"RTN","SYNFPUL",14,0)
 n listurl s listurl=$g(filter("listurl"))
"RTN","SYNFPUL",15,0)
 q:listurl=""
"RTN","SYNFPUL",16,0)
 i listurl["synthea1m.vistaplex.org" d  ;
"RTN","SYNFPUL",17,0)
 . s listurl="http://138.197.147.128"_$p(listurl,"synthea1m.vistaplex.org",2)
"RTN","SYNFPUL",18,0)
 ;
"RTN","SYNFPUL",19,0)
 n listname
"RTN","SYNFPUL",20,0)
 s listname=$re($p($re(listurl),"/",1))
"RTN","SYNFPUL",21,0)
 i listname[":" s listname=$p(listname,":",2)
"RTN","SYNFPUL",22,0)
 i listname["?" s listname=$p(listname,"?",1)
"RTN","SYNFPUL",23,0)
 ;
"RTN","SYNFPUL",24,0)
 n ret,json,jtmp
"RTN","SYNFPUL",25,0)
 s ret=$$GETURL^XTHC10(listurl,,"jtmp")
"RTN","SYNFPUL",26,0)
 d assemble("jtmp","json")
"RTN","SYNFPUL",27,0)
 ;s ret=$$%^%WC(.json,"GET",listurl)
"RTN","SYNFPUL",28,0)
 w !,"return is: ",ret,!
"RTN","SYNFPUL",29,0)
 ;zwrite json
"RTN","SYNFPUL",30,0)
 ;
"RTN","SYNFPUL",31,0)
 n lien,jary
"RTN","SYNFPUL",32,0)
 s lien=$o(@groot@("B",listname,""))
"RTN","SYNFPUL",33,0)
 i lien'="" k @groot@(lien)
"RTN","SYNFPUL",34,0)
 e  set lien=$order(@groot@(" "),-1)+1
"RTN","SYNFPUL",35,0)
 s @groot@("B",listname,lien)=""
"RTN","SYNFPUL",36,0)
 ;
"RTN","SYNFPUL",37,0)
 set gr=$name(@groot@(lien,"list"))
"RTN","SYNFPUL",38,0)
 do DECODE^VPRJSON("json",gr)
"RTN","SYNFPUL",39,0)
 s @gr@("listname")=listname
"RTN","SYNFPUL",40,0)
 do indexList(lien)
"RTN","SYNFPUL",41,0)
 s rtn("listien")=lien
"RTN","SYNFPUL",42,0)
 ;
"RTN","SYNFPUL",43,0)
 w !
"RTN","SYNFPUL",44,0)
 ;zwrite @gr@(*)
"RTN","SYNFPUL",45,0)
 ;
"RTN","SYNFPUL",46,0)
 q
"RTN","SYNFPUL",47,0)
 ;
"RTN","SYNFPUL",48,0)
testpull        ;
"RTN","SYNFPUL",49,0)
 s lurl="http://synthea1m.vistaplex.org:9080/see/tag:random-over50-notDead-M-10-2?format=json"
"RTN","SYNFPUL",50,0)
 s filter("listurl")=lurl
"RTN","SYNFPUL",51,0)
 d wsPull(.g,.filter)
"RTN","SYNFPUL",52,0)
 q
"RTN","SYNFPUL",53,0)
 ;
"RTN","SYNFPUL",54,0)
indexList(ien)  ; produce the index for a patient list
"RTN","SYNFPUL",55,0)
 ;
"RTN","SYNFPUL",56,0)
 n lroot s lroot=$$setroot^%wd("patient-lists")
"RTN","SYNFPUL",57,0)
 n zi s zi=""
"RTN","SYNFPUL",58,0)
 f  s zi=$o(@lroot@(ien,"list","items",zi)) q:zi=""  d  ;
"RTN","SYNFPUL",59,0)
 . n title s title=$g(@lroot@(ien,"list","items",zi,"title"))
"RTN","SYNFPUL",60,0)
 . s @lroot@(ien,"B",title,zi)=""
"RTN","SYNFPUL",61,0)
 q
"RTN","SYNFPUL",62,0)
 ;
"RTN","SYNFPUL",63,0)
wsLol(rtn,filter)       ; list of list web service
"RTN","SYNFPUL",64,0)
 ;
"RTN","SYNFPUL",65,0)
 n groot s groot=$$setroot^%wd("list-of-lists")
"RTN","SYNFPUL",66,0)
 ;
"RTN","SYNFPUL",67,0)
 n listurl s listurl="http://synthea1m.vistaplex.org:9080/see/rand*?format=json"
"RTN","SYNFPUL",68,0)
 ;n listurl s listurl="http://138.197.147.128:9080/see/rand*?format=json"
"RTN","SYNFPUL",69,0)
 ;
"RTN","SYNFPUL",70,0)
 n listname
"RTN","SYNFPUL",71,0)
 s listname=listurl
"RTN","SYNFPUL",72,0)
 ;s listname=$re($p($re(listurl),"/",1))
"RTN","SYNFPUL",73,0)
 ;i listname[":" s listname=$p(listname,":",2)
"RTN","SYNFPUL",74,0)
 i listname["?" s listname=$p(listname,"?",1)
"RTN","SYNFPUL",75,0)
 ;
"RTN","SYNFPUL",76,0)
 n zret,json,jtmp
"RTN","SYNFPUL",77,0)
 ;s zret=$$GETURL^XTHC10(listurl,,"jtmp")
"RTN","SYNFPUL",78,0)
 ;d assemble("jtmp","json")
"RTN","SYNFPUL",79,0)
 s zret=$$%^%WC(.json,"GET",listurl)
"RTN","SYNFPUL",80,0)
 ;w !,"return is: ",zret,!
"RTN","SYNFPUL",81,0)
 ;zwrite json
"RTN","SYNFPUL",82,0)
 ;
"RTN","SYNFPUL",83,0)
 n lien,jary
"RTN","SYNFPUL",84,0)
 s lien=$o(@groot@("B",listname,""))
"RTN","SYNFPUL",85,0)
 i lien'="" k @groot@(lien)
"RTN","SYNFPUL",86,0)
 e  set lien=$order(@groot@(" "),-1)+1
"RTN","SYNFPUL",87,0)
 s @groot@("B",listname,lien)=""
"RTN","SYNFPUL",88,0)
 ;
"RTN","SYNFPUL",89,0)
 set gr=$name(@groot@(lien,"list"))
"RTN","SYNFPUL",90,0)
 do DECODE^VPRJSON("json",gr)
"RTN","SYNFPUL",91,0)
 s @gr@("listname")=listname
"RTN","SYNFPUL",92,0)
 do indexLol(lien)
"RTN","SYNFPUL",93,0)
 k @gr@("listname")
"RTN","SYNFPUL",94,0)
 ;
"RTN","SYNFPUL",95,0)
 s rtn=$na(^TMP("SYNFHIR",$J))
"RTN","SYNFPUL",96,0)
 k @rtn
"RTN","SYNFPUL",97,0)
 n jout m jout=@gr
"RTN","SYNFPUL",98,0)
 k jout("listname")
"RTN","SYNFPUL",99,0)
 ;m @rtn=json
"RTN","SYNFPUL",100,0)
 d ENCODE^VPRJSON("jout",rtn)
"RTN","SYNFPUL",101,0)
 set HTTPRSP("mime")="application/json"
"RTN","SYNFPUL",102,0)
 q
"RTN","SYNFPUL",103,0)
 ;
"RTN","SYNFPUL",104,0)
wsLol2(rtn,filter)      ; list of list web service
"RTN","SYNFPUL",105,0)
 ;
"RTN","SYNFPUL",106,0)
 n groot s groot=$$setroot^%wd("list-of-lists")
"RTN","SYNFPUL",107,0)
 ;
"RTN","SYNFPUL",108,0)
 ;n listurl s listurl="http://synthea1m.vistaplex.org:9080/see/rand*?format=json"
"RTN","SYNFPUL",109,0)
 n listurl s listurl="http://138.197.147.128:9080/see/rand*?format=json"
"RTN","SYNFPUL",110,0)
 ;
"RTN","SYNFPUL",111,0)
 n listname
"RTN","SYNFPUL",112,0)
 s listname=listurl
"RTN","SYNFPUL",113,0)
 ;s listname=$re($p($re(listurl),"/",1))
"RTN","SYNFPUL",114,0)
 ;i listname[":" s listname=$p(listname,":",2)
"RTN","SYNFPUL",115,0)
 i listname["?" s listname=$p(listname,"?",1)
"RTN","SYNFPUL",116,0)
 ;
"RTN","SYNFPUL",117,0)
 n zret,json,jtmp
"RTN","SYNFPUL",118,0)
 ;s zret=$$GETURL^XTHC10(listurl,,"jtmp")
"RTN","SYNFPUL",119,0)
 ;d assemble("jtmp","json")
"RTN","SYNFPUL",120,0)
 s zret=$$%^%WC(.json,"GET",listurl)
"RTN","SYNFPUL",121,0)
 ;w !,"return is: ",zret,!
"RTN","SYNFPUL",122,0)
 ;zwrite json
"RTN","SYNFPUL",123,0)
 ;
"RTN","SYNFPUL",124,0)
 ;n lien,jary
"RTN","SYNFPUL",125,0)
 ;s lien=$o(@groot@("B",listname,""))
"RTN","SYNFPUL",126,0)
 ;i lien'="" k @groot@(lien)
"RTN","SYNFPUL",127,0)
 ;e  set lien=$order(@groot@(" "),-1)+1
"RTN","SYNFPUL",128,0)
 ;s @groot@("B",listname,lien)=""
"RTN","SYNFPUL",129,0)
 ;
"RTN","SYNFPUL",130,0)
 ;set gr=$name(@groot@(lien,"list"))
"RTN","SYNFPUL",131,0)
 ;do DECODE^VPRJSON("json",gr)
"RTN","SYNFPUL",132,0)
 ;s @gr@("listname")=listname
"RTN","SYNFPUL",133,0)
 ;do indexLol(lien)
"RTN","SYNFPUL",134,0)
 ;k @gr@("listname")
"RTN","SYNFPUL",135,0)
 ;
"RTN","SYNFPUL",136,0)
 s rtn=$na(^TMP("SYNFHIR",$J))
"RTN","SYNFPUL",137,0)
 k @rtn
"RTN","SYNFPUL",138,0)
 ;n jout m jout=@gr
"RTN","SYNFPUL",139,0)
 ;k jout("listname")
"RTN","SYNFPUL",140,0)
 m @rtn=json
"RTN","SYNFPUL",141,0)
 ;d ENCODE^VPRJSON("jout",rtn)
"RTN","SYNFPUL",142,0)
 set HTTPRSP("mime")="application/json"
"RTN","SYNFPUL",143,0)
 q
"RTN","SYNFPUL",144,0)
 ;
"RTN","SYNFPUL",145,0)
indexLol(ien)   ;
"RTN","SYNFPUL",146,0)
 ;
"RTN","SYNFPUL",147,0)
 n lroot s lroot=$$setroot^%wd("list-of-lists")
"RTN","SYNFPUL",148,0)
 n zi s zi=""
"RTN","SYNFPUL",149,0)
 f  s zi=$o(@lroot@(ien,"list","items",zi)) q:zi=""  d  ;
"RTN","SYNFPUL",150,0)
 . n title s title=$g(@lroot@(ien,"list","items",zi,"title"))
"RTN","SYNFPUL",151,0)
 . s @lroot@(ien,"B",title,zi)=""
"RTN","SYNFPUL",152,0)
 q
"RTN","SYNFPUL",153,0)
 ;
"RTN","SYNFPUL",154,0)
getlol  ; get list of lists
"RTN","SYNFPUL",155,0)
 ;
"RTN","SYNFPUL",156,0)
 n groot s groot=$$setroot^%wd("list-of-lists")
"RTN","SYNFPUL",157,0)
 ;
"RTN","SYNFPUL",158,0)
 n listurl
"RTN","SYNFPUL",159,0)
 ;s listurl="http://synthea1m.vistaplex.org:9080/see/dhp-vista*?format=json"
"RTN","SYNFPUL",160,0)
 s listurl="http://138.197.147.128:9080/see/dhp-vista*?format=json"
"RTN","SYNFPUL",161,0)
 ;
"RTN","SYNFPUL",162,0)
 n listname
"RTN","SYNFPUL",163,0)
 s listname=listurl
"RTN","SYNFPUL",164,0)
 i listname["?" s listname=$p(listname,"?",1)
"RTN","SYNFPUL",165,0)
 ;
"RTN","SYNFPUL",166,0)
 q:$d(@groot@("B",listname))  ; list already loaded
"RTN","SYNFPUL",167,0)
 ;
"RTN","SYNFPUL",168,0)
 n zret,json,jtmp
"RTN","SYNFPUL",169,0)
 ;s zret=$$%^%WC(.json,"GET",listurl)
"RTN","SYNFPUL",170,0)
 s zret=$$GETURL^XTHC10(listurl,,"jtmp")
"RTN","SYNFPUL",171,0)
 d assemble("jtmp","json")
"RTN","SYNFPUL",172,0)
 w !,"return is: ",zret,!
"RTN","SYNFPUL",173,0)
 ;zwrite json
"RTN","SYNFPUL",174,0)
 ;
"RTN","SYNFPUL",175,0)
 n lien,jary
"RTN","SYNFPUL",176,0)
 s lien=$o(@groot@("B",listname,""))
"RTN","SYNFPUL",177,0)
 i lien'="" k @groot@(lien)
"RTN","SYNFPUL",178,0)
 e  set lien=$order(@groot@(" "),-1)+1
"RTN","SYNFPUL",179,0)
 s @groot@("B",listname,lien)=""
"RTN","SYNFPUL",180,0)
 ;
"RTN","SYNFPUL",181,0)
 set gr=$name(@groot@(lien,"list"))
"RTN","SYNFPUL",182,0)
 do DECODE^VPRJSON("json",gr)
"RTN","SYNFPUL",183,0)
 s @gr@("listname")=listname
"RTN","SYNFPUL",184,0)
 do indexLol(lien)
"RTN","SYNFPUL",185,0)
 ;
"RTN","SYNFPUL",186,0)
 q
"RTN","SYNFPUL",187,0)
 ;
"RTN","SYNFPUL",188,0)
assemble(in,out)        ; reassemble json from the pieces
"RTN","SYNFPUL",189,0)
 n zi,zj
"RTN","SYNFPUL",190,0)
 s @out=""
"RTN","SYNFPUL",191,0)
 s zi=0
"RTN","SYNFPUL",192,0)
 f  s zi=$o(@in@(zi)) q:+zi=0  d  ;
"RTN","SYNFPUL",193,0)
 . s @out=@out_@in@(zi)
"RTN","SYNFPUL",194,0)
 . s zj=0
"RTN","SYNFPUL",195,0)
 . f  s zj=$o(@in@(zi,zj)) q:+zj=0  d  ;
"RTN","SYNFPUL",196,0)
 . . s @out=@out_$g(@in@(zi,zj))
"RTN","SYNFPUL",197,0)
 q
"RTN","SYNFPUL",198,0)
 ;
"RTN","SYNFPUL",199,0)
load1list(zlist)        ;
"RTN","SYNFPUL",200,0)
 n lroot s lroot=$$setroot^%wd("patient-lists")
"RTN","SYNFPUL",201,0)
 n lolroot s lolroot=$$setroot^%wd("list-of-lists")
"RTN","SYNFPUL",202,0)
 n uselist
"RTN","SYNFPUL",203,0)
 ;s uselist="http://synthea1m.vistaplex.org:9080/see/dhp-vista*"
"RTN","SYNFPUL",204,0)
 s uselist="http://138.197.147.128:9080/see/dhp-vista*"
"RTN","SYNFPUL",205,0)
 n lolien s lolien=$o(@lolroot@("B",uselist,"")) ; ien of the list of lists
"RTN","SYNFPUL",206,0)
 ;
"RTN","SYNFPUL",207,0)
 n uselist2 s uselist2=zlist
"RTN","SYNFPUL",208,0)
 n zl
"RTN","SYNFPUL",209,0)
 s zl=$o(@lolroot@(lolien,"B",uselist2,""))
"RTN","SYNFPUL",210,0)
 i zl="" d  q  ;
"RTN","SYNFPUL",211,0)
 . w !,"Error, list not found: "_uselist2
"RTN","SYNFPUL",212,0)
 ;
"RTN","SYNFPUL",213,0)
 n ltitle s ltitle=$g(@lolroot@(lolien,"list","items",zl,"title"))
"RTN","SYNFPUL",214,0)
 n lurl s lurl=$g(@lolroot@(lolien,"list","items",zl,"url"))
"RTN","SYNFPUL",215,0)
 ;
"RTN","SYNFPUL",216,0)
 i lurl="" d  q  ;
"RTN","SYNFPUL",217,0)
 . w !,"error list url not found"
"RTN","SYNFPUL",218,0)
 ;
"RTN","SYNFPUL",219,0)
 n lien
"RTN","SYNFPUL",220,0)
 s lien=$o(@lroot@("B",ltitle,""))
"RTN","SYNFPUL",221,0)
 i lien'="" d  q lien  ;
"RTN","SYNFPUL",222,0)
 . w !,"list already loaded: "_ltitle_" ien: "_lien
"RTN","SYNFPUL",223,0)
 ;
"RTN","SYNFPUL",224,0)
 w !,"title: ",ltitle
"RTN","SYNFPUL",225,0)
 w !,"url: ",lurl
"RTN","SYNFPUL",226,0)
 ;
"RTN","SYNFPUL",227,0)
 n filter s filter("listurl")=lurl
"RTN","SYNFPUL",228,0)
 n lret
"RTN","SYNFPUL",229,0)
 d wsPull(.lret,.filter)
"RTN","SYNFPUL",230,0)
 ;
"RTN","SYNFPUL",231,0)
 s lien=$g(lret("listien"))
"RTN","SYNFPUL",232,0)
 i lien="" d  q  ;
"RTN","SYNFPUL",233,0)
 . w !,"error, list ien not returned"
"RTN","SYNFPUL",234,0)
 ;
"RTN","SYNFPUL",235,0)
 q lien
"RTN","SYNFPUL",236,0)
 ;
"RTN","SYNFPUL",237,0)
test1pat(rtn,start,end) ;
"RTN","SYNFPUL",238,0)
 k rtn
"RTN","SYNFPUL",239,0)
 n lroot s lroot=$$setroot^%wd("patient-lists")
"RTN","SYNFPUL",240,0)
 n uselist s uselist="dhp-vista-1000-1"
"RTN","SYNFPUL",241,0)
 n listien s listien=$o(@lroot@("B",uselist,""))
"RTN","SYNFPUL",242,0)
 q:listien=""
"RTN","SYNFPUL",243,0)
 n listroot s listroot=$na(@lroot@(listien,"list","items"))
"RTN","SYNFPUL",244,0)
 n pid,purl
"RTN","SYNFPUL",245,0)
 i $g(start)="" s start=1
"RTN","SYNFPUL",246,0)
 i $g(end)="" s end=start
"RTN","SYNFPUL",247,0)
 n num
"RTN","SYNFPUL",248,0)
 f num=start:1:end d
"RTN","SYNFPUL",249,0)
 . s pid=$g(@listroot@(num,"title"))
"RTN","SYNFPUL",250,0)
 . s purl=$g(@listroot@(num,"url"))
"RTN","SYNFPUL",251,0)
 . n filter
"RTN","SYNFPUL",252,0)
 . s filter("id")=pid
"RTN","SYNFPUL",253,0)
 . s filter("url")=purl
"RTN","SYNFPUL",254,0)
 . q:purl=""
"RTN","SYNFPUL",255,0)
 . d wsLoadPat(.rtn,.filter)
"RTN","SYNFPUL",256,0)
 q
"RTN","SYNFPUL",257,0)
 ;
"RTN","SYNFPUL",258,0)
loadpats(rtn,listien)   ;
"RTN","SYNFPUL",259,0)
 k rtn
"RTN","SYNFPUL",260,0)
 n lroot s lroot=$$setroot^%wd("patient-lists")
"RTN","SYNFPUL",261,0)
 n froot s froot=$$setroot^%wd("fhir-intake")
"RTN","SYNFPUL",262,0)
 q:listien=""
"RTN","SYNFPUL",263,0)
 n listroot s listroot=$na(@lroot@(listien,"list","items"))
"RTN","SYNFPUL",264,0)
 n pid,purl
"RTN","SYNFPUL",265,0)
 n num s num=0
"RTN","SYNFPUL",266,0)
 f  s num=$o(@listroot@(num)) q:+num=0  d  ;
"RTN","SYNFPUL",267,0)
 . s pid=$g(@listroot@(num,"title"))
"RTN","SYNFPUL",268,0)
 . s purl=$g(@listroot@(num,"url"))
"RTN","SYNFPUL",269,0)
 . n filter
"RTN","SYNFPUL",270,0)
 . s filter("id")=pid
"RTN","SYNFPUL",271,0)
 . s filter("url")=purl
"RTN","SYNFPUL",272,0)
 . q:purl=""
"RTN","SYNFPUL",273,0)
 . i $d(@froot@("B",pid)) d  q  ; already loaded
"RTN","SYNFPUL",274,0)
 . . w !,"patient already loaded: "_pid
"RTN","SYNFPUL",275,0)
 . w !,"loading patient "_pid
"RTN","SYNFPUL",276,0)
 . d wsLoadPat(.rtn,.filter)
"RTN","SYNFPUL",277,0)
 q
"RTN","SYNFPUL",278,0)
 ;
"RTN","SYNFPUL",279,0)
wsLoadPat(zrtn,zfilter) ; load one patient from a URL
"RTN","SYNFPUL",280,0)
 ; zfilter("url")=patienturl
"RTN","SYNFPUL",281,0)
 ; zfilter("id")=patientID
"RTN","SYNFPUL",282,0)
 ; returns same as wsPostFHIR^SYNFHIR
"RTN","SYNFPUL",283,0)
 ;
"RTN","SYNFPUL",284,0)
 s U="^"
"RTN","SYNFPUL",285,0)
 ;
"RTN","SYNFPUL",286,0)
 n ret,json,purl
"RTN","SYNFPUL",287,0)
 s purl=$g(zfilter("url"))
"RTN","SYNFPUL",288,0)
 q:purl=""
"RTN","SYNFPUL",289,0)
 i purl["synthea1m.vistaplex.org" d  ;
"RTN","SYNFPUL",290,0)
 . s purl="http://138.197.147.128"_$p(purl,"synthea1m.vistaplex.org",2)
"RTN","SYNFPUL",291,0)
 ;
"RTN","SYNFPUL",292,0)
 ;s ret=$$%^%WC(.json,"GET",purl)
"RTN","SYNFPUL",293,0)
 n jtmp
"RTN","SYNFPUL",294,0)
 s ret=$$GETURL^XTHC10(purl,,"jtmp")
"RTN","SYNFPUL",295,0)
 d assemble("jtmp","json")
"RTN","SYNFPUL",296,0)
 i +ret=-1 d  s $ec=",u-error,"
"RTN","SYNFPUL",297,0)
 . w !,ret," ",purl
"RTN","SYNFPUL",298,0)
 ;
"RTN","SYNFPUL",299,0)
 ;
"RTN","SYNFPUL",300,0)
 new ien,root,gr,id,return
"RTN","SYNFPUL",301,0)
 set root=$$setroot^%wd("fhir-intake")
"RTN","SYNFPUL",302,0)
 set id=$get(zfilter("id"))
"RTN","SYNFPUL",303,0)
 ;
"RTN","SYNFPUL",304,0)
 set ien=$order(@root@(" "),-1)+1
"RTN","SYNFPUL",305,0)
 set gr=$name(@root@(ien,"json"))
"RTN","SYNFPUL",306,0)
 do DECODE^VPRJSON("json",gr)
"RTN","SYNFPUL",307,0)
 do indexFhir^SYNFHIR(ien)
"RTN","SYNFPUL",308,0)
 W:ien#500=0 !,"Patient # "_ien_" "_$$FMTE^XLFDT($$NOW^XLFDT)
"RTN","SYNFPUL",309,0)
 ;
"RTN","SYNFPUL",310,0)
 if id'="" do  ;
"RTN","SYNFPUL",311,0)
 . set @root@("B",id,ien)=""
"RTN","SYNFPUL",312,0)
 else  do  ;
"RTN","SYNFPUL",313,0)
 . ;
"RTN","SYNFPUL",314,0)
 ;
"RTN","SYNFPUL",315,0)
 if $get(ARGS("returngraph"))=1 do  ;
"RTN","SYNFPUL",316,0)
 . merge return("graph")=@root@(ien,"graph")
"RTN","SYNFPUL",317,0)
 set return("status")="ok"
"RTN","SYNFPUL",318,0)
 set return("id")=id
"RTN","SYNFPUL",319,0)
 set return("ien")=ien
"RTN","SYNFPUL",320,0)
 ;
"RTN","SYNFPUL",321,0)
 do importPatient^SYNFPAT(.return,ien)
"RTN","SYNFPUL",322,0)
 ;
"RTN","SYNFPUL",323,0)
 new rdfn set rdfn=$get(return("dfn"))
"RTN","SYNFPUL",324,0)
 if rdfn'="" set @root@("DFN",rdfn,ien)=""
"RTN","SYNFPUL",325,0)
 ;
"RTN","SYNFPUL",326,0)
 if rdfn'="" do  ; patient creation was successful
"RTN","SYNFPUL",327,0)
 . if $g(ARGS("load"))="" s ARGS("load")=1
"RTN","SYNFPUL",328,0)
 . do importVitals^SYNFVIT(.return,ien,.ARGS)
"RTN","SYNFPUL",329,0)
 . do importEncounters^SYNFENC(.return,ien,.ARGS)
"RTN","SYNFPUL",330,0)
 . do importImmu^SYNFIMM(.return,ien,.ARGS)
"RTN","SYNFPUL",331,0)
 . do importConditions^SYNFPRB(.return,ien,.ARGS)
"RTN","SYNFPUL",332,0)
 . do importAllergy^SYNFALG(.return,ien,.ARGS)
"RTN","SYNFPUL",333,0)
 . do importAppointment^SYNFAPT(.return,ien,.ARGS)
"RTN","SYNFPUL",334,0)
 . do importMeds^SYNFMED2(.return,ien,.ARGS)
"RTN","SYNFPUL",335,0)
 . do importProcedures^SYNFPROC(.return,ien,.ARGS)
"RTN","SYNFPUL",336,0)
 . do importLabs^SYNFLAB(.return,ien,.ARGS)
"RTN","SYNFPUL",337,0)
 . ;do taskLabs^SYNFHIR(.return,ien,.ARGS)
"RTN","SYNFPUL",338,0)
 ;
"RTN","SYNFPUL",339,0)
 ;do ENCODE^VPRJSON("return","RESULT")
"RTN","SYNFPUL",340,0)
 ;do ENCODE^VPRJSON("return","zrtn")
"RTN","SYNFPUL",341,0)
 set HTTPRSP("mime")="application/json"
"RTN","SYNFPUL",342,0)
 ;
"RTN","SYNFPUL",343,0)
 quit
"RTN","SYNFPUL",344,0)
 ;
"RTN","SYNFPUL",345,0)
TEST1K  ; test loading first 1000 patients in the lists
"RTN","SYNFPUL",346,0)
 d getlol ; get the list of lists
"RTN","SYNFPUL",347,0)
 n lstien ; ien in patient-lists that we will process
"RTN","SYNFPUL",348,0)
 n lname s lname="dhp-vista-1000-1" ; name of the first list
"RTN","SYNFPUL",349,0)
 s lstien=$$load1list(lname) ; load the first list and return the ien
"RTN","SYNFPUL",350,0)
 d loadpats(.return,lstien) ; load the patients from the first list
"RTN","SYNFPUL",351,0)
 q
"RTN","SYNFPUL",352,0)
 ;
"RTN","SYNFPUL",353,0)
LOADALL ; load all 50000 patients
"RTN","SYNFPUL",354,0)
 d getlol ; get the list of lists
"RTN","SYNFPUL",355,0)
 n lstien ; ien in patient-lists that we will process
"RTN","SYNFPUL",356,0)
 n tlname s tlname="dhp-vista-1000-" ; template for the list names
"RTN","SYNFPUL",357,0)
 n ii
"RTN","SYNFPUL",358,0)
 f ii=1:1:50 d  ; for all 50 lists
"RTN","SYNFPUL",359,0)
 . s lname=tlname_ii ; name of the list
"RTN","SYNFPUL",360,0)
 . s lstien=$$load1list(lname) ; load the list and return the ien
"RTN","SYNFPUL",361,0)
 . d loadpats(.return,lstien) ; load the patients from the list
"RTN","SYNFPUL",362,0)
 q
"RTN","SYNFPUL",363,0)
 ;
"RTN","SYNFPUL",364,0)
CLEANGRAPH      ;
"RTN","SYNFPUL",365,0)
 ;
"RTN","SYNFPUL",366,0)
 n groot s groot=$$setroot^%wd("fhir-intake")
"RTN","SYNFPUL",367,0)
 n zi,zj,zk
"RTN","SYNFPUL",368,0)
 s (zi,zj,zk)=""
"RTN","SYNFPUL",369,0)
 f  s zi=$o(@groot@("B",zi)) q:zi=""  d  ;
"RTN","SYNFPUL",370,0)
 . s zj=$o(@groot@("B",zi,""))
"RTN","SYNFPUL",371,0)
 . s zk=$o(@groot@("B",zi,zj))
"RTN","SYNFPUL",372,0)
 . i zk'="" d  ; a duplicate
"RTN","SYNFPUL",373,0)
 . . i $$ien2dfn^SYNFUTL(zk)'="" q  ; has a VistA record
"RTN","SYNFPUL",374,0)
 . . w !,"removing ien: "_zk_" name: "_zi
"RTN","SYNFPUL",375,0)
 . . k @groot@(zk) ; clear the graph
"RTN","SYNFPUL",376,0)
 . . k @groot@("B",zi,zk) ; remove from the index
"RTN","SYNFPUL",377,0)
 q
"RTN","SYNFPUL",378,0)
 ;
"RTN","SYNFTIU")
0^80^B5720830
"RTN","SYNFTIU",1,0)
SYNFTIU  ;ven/gpl - fhir loader utilities ;2018-08-17  3:27 PM
"RTN","SYNFTIU",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNFTIU",3,0)
 ;
"RTN","SYNFTIU",4,0)
 ; Authored by George P. Lilly 2017-2018
"RTN","SYNFTIU",5,0)
 ;
"RTN","SYNFTIU",6,0)
 ; Encounter TIU note utilities
"RTN","SYNFTIU",7,0)
 q
"RTN","SYNFTIU",8,0)
 ;
"RTN","SYNFTIU",9,0)
TONOTE(ien,enc,line) ; insert a line to the note associated with encounter enc
"RTN","SYNFTIU",10,0)
 ; enc is a pointer to the encounter
"RTN","SYNFTIU",11,0)
 ; ien identifies the patient graph
"RTN","SYNFTIU",12,0)
 ;
"RTN","SYNFTIU",13,0)
 n nroot s nroot=$$NOTEPTR^SYNFTIU(ien,enc)
"RTN","SYNFTIU",14,0)
 q:nroot=""
"RTN","SYNFTIU",15,0)
 ;w !,"add to note: ",line
"RTN","SYNFTIU",16,0)
 i $l(line)>80 d  ;
"RTN","SYNFTIU",17,0)
 . n tline s tline(0)=line
"RTN","SYNFTIU",18,0)
 . 
"RTN","SYNFTIU",19,0)
 . d WRAP^DIKCU2(.tline,80)
"RTN","SYNFTIU",20,0)
 . ;ZWRITE tline
"RTN","SYNFTIU",21,0)
 . n zi
"RTN","SYNFTIU",22,0)
 . f zi=0:1:$o(tline(" "),-1) d  ;
"RTN","SYNFTIU",23,0)
 . . s @nroot@($o(@nroot@(" "),-1)+zi)=tline(zi)
"RTN","SYNFTIU",24,0)
 e  s @nroot@($o(@nroot@(" "),-1)+1)=line
"RTN","SYNFTIU",25,0)
 q
"RTN","SYNFTIU",26,0)
 ;
"RTN","SYNFTIU",27,0)
NOTEPTR(ien,enc) ; returns a global pointer to the note for this encounter
"RTN","SYNFTIU",28,0)
 ; ien is the patient graph
"RTN","SYNFTIU",29,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFTIU",30,0)
 n groot s groot=$na(@root@(ien))
"RTN","SYNFTIU",31,0)
 n encien s encien=$o(@groot@("PSO","rien",enc,""))
"RTN","SYNFTIU",32,0)
 q:encien="" ""
"RTN","SYNFTIU",33,0)
 n nroot s nroot=$na(@groot@("load","encounters",encien,"note"))
"RTN","SYNFTIU",34,0)
 q nroot
"RTN","SYNFTIU",35,0)
 ;
"RTN","SYNFTIU",36,0)
KILLNOTE(ien,enc) ; kill the note for this encounter
"RTN","SYNFTIU",37,0)
 ; used for testing
"RTN","SYNFTIU",38,0)
 n knote s knote=$$NOTEPTR^SYNFTIU(ien,enc)
"RTN","SYNFTIU",39,0)
 q:'$d(@knote)
"RTN","SYNFTIU",40,0)
 k @knote
"RTN","SYNFTIU",41,0)
 q
"RTN","SYNFTIU",42,0)
 ;
"RTN","SYNFTIU",43,0)
CLRNOTES(ien,rien) ; kill all notes for patient ien
"RTN","SYNFTIU",44,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFTIU",45,0)
 n groot s groot=$na(@root@(ien,"load","encounters"))
"RTN","SYNFTIU",46,0)
 n zi s zi=0
"RTN","SYNFTIU",47,0)
 f  s zi=$o(@groot@(zi)) q:+zi=0  d  ;
"RTN","SYNFTIU",48,0)
 . k @groot@(zi,"note")
"RTN","SYNFTIU",49,0)
 . w !,"kill ",groot," ",zi," note"
"RTN","SYNFTIU",50,0)
 q
"RTN","SYNFTIU",51,0)
 ;
"RTN","SYNFTIU",52,0)
T1 ;
"RTN","SYNFTIU",53,0)
 s ien=1640
"RTN","SYNFTIU",54,0)
 s enc="urn:uuid:02eb455c-787c-4abb-8f39-a9675a2db35c"
"RTN","SYNFTIU",55,0)
 w !,"note pointer: ",$$NOTEPTR^SYNFTIU(ien,enc)
"RTN","SYNFTIU",56,0)
 q
"RTN","SYNFTIU",57,0)
 ;
"RTN","SYNFTIU",58,0)
T2 ;
"RTN","SYNFTIU",59,0)
 s ien=1640
"RTN","SYNFTIU",60,0)
 s enc="urn:uuid:02eb455c-787c-4abb-8f39-a9675a2db35c"
"RTN","SYNFTIU",61,0)
 d KILLNOTE^SYNFTIU(ien,enc)
"RTN","SYNFTIU",62,0)
 d TONOTE^SYNFTIU(ien,enc,"Test Note Creation")
"RTN","SYNFTIU",63,0)
 d TONOTE^SYNFTIU(ien,enc,"Patient ien: "_ien)
"RTN","SYNFTIU",64,0)
 d TONOTE^SYNFTIU(ien,enc,"Encounter Id: "_enc)
"RTN","SYNFTIU",65,0)
 q
"RTN","SYNFTIU",66,0)
 ;
"RTN","SYNFUTL")
0^39^B46964285
"RTN","SYNFUTL",1,0)
SYNFUTL ;ven/gpl - fhir loader utilities ;2018-08-17  3:26 PM
"RTN","SYNFUTL",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNFUTL",3,0)
 ;
"RTN","SYNFUTL",4,0)
 ; Authored by George P. Lilly 2017-2018
"RTN","SYNFUTL",5,0)
 ;
"RTN","SYNFUTL",6,0)
 q
"RTN","SYNFUTL",7,0)
 ;
"RTN","SYNFUTL",8,0)
initPLD(ien,element)    ; initializes the PLD pointers in the fhir graph
"RTN","SYNFUTL",9,0)
 new root set root=$$setroot^%wd("fhir-intake")
"RTN","SYNFUTL",10,0)
 set @root@(ien,"load",element,"PLD","parms")=$name(@root@(ien,"load",element,"parms"))
"RTN","SYNFUTL",11,0)
 set @root@(ien,"load",element,"PLD","log")=$name(@root@(ien,"load",element,"log"))
"RTN","SYNFUTL",12,0)
 set @root@(ien,"load",element,"PLD","verify")=$name(@root@(ien,"load",element,"verify"))
"RTN","SYNFUTL",13,0)
 set @root@(ien,"load",element,"PLD","status")=$name(@root@(ien,"load",element,"status"))
"RTN","SYNFUTL",14,0)
 set @root@(ien,"load",element,"PLD","index")=root
"RTN","SYNFUTL",15,0)
 quit
"RTN","SYNFUTL",16,0)
 ;
"RTN","SYNFUTL",17,0)
setPLD(ien,element)     ; extrinsic which returns the global name containing the PLD for this element
"RTN","SYNFUTL",18,0)
 new root set root=$$setroot^%wd("fhir-intake")
"RTN","SYNFUTL",19,0)
 if '$data(@root@(ien,"load",element,"PLD")) do initPLD(ien,element)
"RTN","SYNFUTL",20,0)
 quit $name(@root@(ien,"load","Patient","PLD"))
"RTN","SYNFUTL",21,0)
 ;
"RTN","SYNFUTL",22,0)
log(txt)        ; logs a line to the log array defined by PLD("log")
"RTN","SYNFUTL",23,0)
 if '$data(PLD("log")) do  quit  ;
"RTN","SYNFUTL",24,0)
 . w !,"Error log array not defined ",txt
"RTN","SYNFUTL",25,0)
 do addto(PLD("log"),txt)
"RTN","SYNFUTL",26,0)
 quit
"RTN","SYNFUTL",27,0)
 ;
"RTN","SYNFUTL",28,0)
addto(dest,string)      ; add string to list dest
"RTN","SYNFUTL",29,0)
 ; dest is passed by name
"RTN","SYNFUTL",30,0)
 new %ii
"RTN","SYNFUTL",31,0)
 set %ii=$order(@dest@("AAAAA"),-1)+1
"RTN","SYNFUTL",32,0)
 set @dest@(%ii)=string
"RTN","SYNFUTL",33,0)
 set @dest@(0)=%ii ; count
"RTN","SYNFUTL",34,0)
 quit
"RTN","SYNFUTL",35,0)
 ;
"RTN","SYNFUTL",36,0)
addArray(dest,array)    ; add array to list dest
"RTN","SYNFUTL",37,0)
 ; dest and array are passed by name
"RTN","SYNFUTL",38,0)
 new %ii
"RTN","SYNFUTL",39,0)
 set %ii=$order(@dest@("AAAAA"),-1)+1
"RTN","SYNFUTL",40,0)
 new %ij set %ij=0
"RTN","SYNFUTL",41,0)
 for  set %ij=$order(@array@(%ij)) quit:'%ij  do  ;
"RTN","SYNFUTL",42,0)
 . set @dest@(%ii)=$get(@array@(%ij))
"RTN","SYNFUTL",43,0)
 . set @dest@(0)=%ii ; count
"RTN","SYNFUTL",44,0)
 . set %ii=%ii+1
"RTN","SYNFUTL",45,0)
 quit
"RTN","SYNFUTL",46,0)
 ;
"RTN","SYNFUTL",47,0)
setIndex(sub,pred,obj)  ; set the graph indexices
"RTN","SYNFUTL",48,0)
 n gn s gn=$$setroot^%wd("fhir-intake")
"RTN","SYNFUTL",49,0)
 q:sub=""
"RTN","SYNFUTL",50,0)
 q:pred=""
"RTN","SYNFUTL",51,0)
 q:obj=""
"RTN","SYNFUTL",52,0)
 s @gn@("SPO",sub,pred,obj)=""
"RTN","SYNFUTL",53,0)
 s @gn@("POS",pred,obj,sub)=""
"RTN","SYNFUTL",54,0)
 s @gn@("PSO",pred,sub,obj)=""
"RTN","SYNFUTL",55,0)
 s @gn@("OPS",obj,pred,sub)=""
"RTN","SYNFUTL",56,0)
 q
"RTN","SYNFUTL",57,0)
 ;
"RTN","SYNFUTL",58,0)
clearIndexes    ; do this carefully
"RTN","SYNFUTL",59,0)
 n gn s gn=$$setroot^%wd("fhir-intake")
"RTN","SYNFUTL",60,0)
 k @gn@("SPO")
"RTN","SYNFUTL",61,0)
 k @gn@("POS")
"RTN","SYNFUTL",62,0)
 k @gn@("PSO")
"RTN","SYNFUTL",63,0)
 k @gn@("OPS")
"RTN","SYNFUTL",64,0)
 q
"RTN","SYNFUTL",65,0)
 ; 
"RTN","SYNFUTL",66,0)
fhirTfm(dtin)   ; extrinsic which returns the fileman dateTime 
"RTN","SYNFUTL",67,0)
 ; for the FHIR format input ie 2017-04-28T01:28:28-04:00
"RTN","SYNFUTL",68,0)
 n tdt
"RTN","SYNFUTL",69,0)
 s tdt=$tr(dtin,":")
"RTN","SYNFUTL",70,0)
 s tdt=$tr(tdt,"T")
"RTN","SYNFUTL",71,0)
 s tdt=$e(tdt,1,4)_$e(tdt,6,7)_$e(tdt,9,21)
"RTN","SYNFUTL",72,0)
 q $$HL7TFM^XLFDT(tdt)
"RTN","SYNFUTL",73,0)
 ;
"RTN","SYNFUTL",74,0)
fhirThl7(dtin)  ; extrinsic which returns the HL7 dateTime 
"RTN","SYNFUTL",75,0)
 ; for the FHIR format input ie 2017-04-28T01:28:28-04:00
"RTN","SYNFUTL",76,0)
 ; example hl7 returned: 20170428012828-0400
"RTN","SYNFUTL",77,0)
 n tdt
"RTN","SYNFUTL",78,0)
 s tdt=$tr(dtin,":")
"RTN","SYNFUTL",79,0)
 s tdt=$tr(tdt,"T")
"RTN","SYNFUTL",80,0)
 s tdt=$e(tdt,1,4)_$e(tdt,6,7)_$e(tdt,9,21)
"RTN","SYNFUTL",81,0)
 q tdt
"RTN","SYNFUTL",82,0)
 ;
"RTN","SYNFUTL",83,0)
ien2dfn(ien)    ; extrinsic returns the patient DFN given the graph ien
"RTN","SYNFUTL",84,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFUTL",85,0)
 q $o(@root@("PSO","DFN",ien,""))
"RTN","SYNFUTL",86,0)
 ;
"RTN","SYNFUTL",87,0)
dfn2ien(dfn)    ; extrinsic returns the graph ien given the DFN
"RTN","SYNFUTL",88,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFUTL",89,0)
 q $o(@root@("POS","DFN",dfn,""))
"RTN","SYNFUTL",90,0)
 ;
"RTN","SYNFUTL",91,0)
ien2icn(ien)    ; extrinsic returns the patient ICN given the graph ien
"RTN","SYNFUTL",92,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFUTL",93,0)
 q $o(@root@("PSO","ICN",ien,""))
"RTN","SYNFUTL",94,0)
 ;
"RTN","SYNFUTL",95,0)
icn2ien(icn)    ; extrinsic returns the graph ien given the DFN
"RTN","SYNFUTL",96,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFUTL",97,0)
 q $o(@root@("POS","ICN",icn,""))
"RTN","SYNFUTL",98,0)
 ;
"RTN","SYNFUTL",99,0)
dfn2icn(dfn)    ; extrinsic returns the ICN given the patient DFN
"RTN","SYNFUTL",100,0)
 n ien s ien=$$dfn2ien(dfn)
"RTN","SYNFUTL",101,0)
 q $$ien2icn(ien)
"RTN","SYNFUTL",102,0)
 ;
"RTN","SYNFUTL",103,0)
icn2dfn(icn)    ; extrinsic returns the DFN given the patient ICN
"RTN","SYNFUTL",104,0)
 n ien s ien=$$icn2ien(icn)
"RTN","SYNFUTL",105,0)
 q $$ien2dfn(ien)
"RTN","SYNFUTL",106,0)
 ;
"RTN","SYNFUTL",107,0)
urlEnd(zurl)    ; extrinsic which return the last part of a url 
"RTN","SYNFUTL",108,0)
 ; (the part after the final /
"RTN","SYNFUTL",109,0)
 q $re($p($re(zurl),"/",1))
"RTN","SYNFUTL",110,0)
 ;
"RTN","SYNFUTL",111,0)
testValueDex()  ; 
"RTN","SYNFUTL",112,0)
 ;new fhir
"RTN","SYNFUTL",113,0)
 do getIntakeFhir^SYNFHIR("testfhir",,"Patient",1)
"RTN","SYNFUTL",114,0)
 do valueDex("testfhir","value")
"RTN","SYNFUTL",115,0)
 ;zwrite fhir
"RTN","SYNFUTL",116,0)
 quit
"RTN","SYNFUTL",117,0)
 ;
"RTN","SYNFUTL",118,0)
valueDex(ary,indx)      ; creates index indx of values of the array
"RTN","SYNFUTL",119,0)
 ;
"RTN","SYNFUTL",120,0)
 new ind
"RTN","SYNFUTL",121,0)
 new fi s fi=$query(@ary@(""))
"RTN","SYNFUTL",122,0)
 ;new fi s fi=""
"RTN","SYNFUTL",123,0)
 set ind(indx,@fi)=fi
"RTN","SYNFUTL",124,0)
 for  set fi=$query(@fi) quit:fi=""  do  ;
"RTN","SYNFUTL",125,0)
 . ;w !,@fi," ",fi
"RTN","SYNFUTL",126,0)
 . if @fi="" quit
"RTN","SYNFUTL",127,0)
 . set ind(indx,@fi)=fi
"RTN","SYNFUTL",128,0)
 . ;write !,fi," ",@fi
"RTN","SYNFUTL",129,0)
 ;zwrite ind
"RTN","SYNFUTL",130,0)
 merge @ary=ind
"RTN","SYNFUTL",131,0)
 quit
"RTN","SYNFUTL",132,0)
 ;
"RTN","SYNFUTL",133,0)
valueDex2(ary,indx)     ; creates index indx of values of the array
"RTN","SYNFUTL",134,0)
 ; this one simplifies indx
"RTN","SYNFUTL",135,0)
 new ind
"RTN","SYNFUTL",136,0)
 new fi s fi=$query(@ary@(""))
"RTN","SYNFUTL",137,0)
 set ind(indx,@fi)=fi
"RTN","SYNFUTL",138,0)
 for  set fi=$query(@fi) quit:fi=""  do  ;
"RTN","SYNFUTL",139,0)
 . ;w !,@fi," ",fi
"RTN","SYNFUTL",140,0)
 . if @fi="" quit
"RTN","SYNFUTL",141,0)
 . set ind($qs(fi,$ql(fi)),@fi)=fi
"RTN","SYNFUTL",142,0)
 . ;write !,fi," ",@fi
"RTN","SYNFUTL",143,0)
 ;zwrite ind
"RTN","SYNFUTL",144,0)
 merge @indx=ind
"RTN","SYNFUTL",145,0)
 quit
"RTN","SYNFUTL",146,0)
 ;
"RTN","SYNFUTL",147,0)
testAdb()       ; test Array Defined By
"RTN","SYNFUTL",148,0)
 new fhir
"RTN","SYNFUTL",149,0)
 do getIntakeFhir^SYNFHIR("fhir",,"Patient",1)
"RTN","SYNFUTL",150,0)
 do adb("fhirrace","fhir","text","race")
"RTN","SYNFUTL",151,0)
 zwrite fhirrace
"RTN","SYNFUTL",152,0)
 ;
"RTN","SYNFUTL",153,0)
 ; expected results:
"RTN","SYNFUTL",154,0)
 ;d testAdb^SYNFUTL
"RTN","SYNFUTL",155,0)
 ;fhirrace("coding",1,"code")="2106-3"
"RTN","SYNFUTL",156,0)
 ;fhirrace("coding",1,"display")="White"
"RTN","SYNFUTL",157,0)
 ;fhirrace("coding",1,"system")="http://hl7.org/fhir/v3/Race"
"RTN","SYNFUTL",158,0)
 ;fhirrace("text")="race"
"RTN","SYNFUTL",159,0)
 ;
"RTN","SYNFUTL",160,0)
 quit
"RTN","SYNFUTL",161,0)
 ;
"RTN","SYNFUTL",162,0)
adb(rtn,ary,pred,obj)   ; returns the array defined by the predicate and object
"RTN","SYNFUTL",163,0)
 if '$d(@ary@("value")) do valueDex(ary,"value")
"RTN","SYNFUTL",164,0)
 new ref
"RTN","SYNFUTL",165,0)
 set ref=@ary@("value",obj) 
"RTN","SYNFUTL",166,0)
 if ref'[pred quit  ;
"RTN","SYNFUTL",167,0)
 do replace(.ref,","""_pred_"""","")
"RTN","SYNFUTL",168,0)
 ;w !,ref b
"RTN","SYNFUTL",169,0)
 merge @rtn=@ref
"RTN","SYNFUTL",170,0)
 quit
"RTN","SYNFUTL",171,0)
 ;
"RTN","SYNFUTL",172,0)
replace(ln,cur,repl)    ; replace current with replacment in line ln
"RTN","SYNFUTL",173,0)
 new where set where=$find(ln,cur)
"RTN","SYNFUTL",174,0)
 quit:where=0 ; this might not work for cur at the end of ln, please test
"RTN","SYNFUTL",175,0)
 set ln=$extract(ln,1,where-$length(cur)-1)_repl_$extract(ln,where,$length(ln))
"RTN","SYNFUTL",176,0)
 quit
"RTN","SYNFUTL",177,0)
 ;
"RTN","SYNFUTL",178,0)
hex2dec(hex) ; extrinsic returns the decimal conversion of hex number hex
"RTN","SYNFUTL",179,0)
 n ii,dec,dig
"RTN","SYNFUTL",180,0)
 s dec=0
"RTN","SYNFUTL",181,0)
 s hex=$tr(hex,"ABCDEF","abcdef")
"RTN","SYNFUTL",182,0)
 f ii=1:1:$l(hex) s dig=$f("0123456789abcdef",$e(hex,ii)) q:'dig  s dec=(dec*16)+(dig-2)
"RTN","SYNFUTL",183,0)
 q dec
"RTN","SYNFUTL",184,0)
 ;
"RTN","SYNFUTL",185,0)
ien2pid(fien) ; extrinsic returns the patient id from the fhir-intake graph ien=fien
"RTN","SYNFUTL",186,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFUTL",187,0)
 n pid
"RTN","SYNFUTL",188,0)
 set pid=$o(@root@(fien,"POS","type","Patient",""))
"RTN","SYNFUTL",189,0)
 q pid
"RTN","SYNFUTL",190,0)
 ;
"RTN","SYNFUTL",191,0)
pid2icn(pid) ; generate an ICN from a pid
"RTN","SYNFUTL",192,0)
 ; example of a pid: urn:uuid:0a01efae-0662-41ae-a20d-4646ce42b687
"RTN","SYNFUTL",193,0)
 n hpid s hpid=$p(pid,"-",5)
"RTN","SYNFUTL",194,0)
 q:hpid="" -1
"RTN","SYNFUTL",195,0)
 n dpid
"RTN","SYNFUTL",196,0)
 s dpid=$$hex2dec(hpid)
"RTN","SYNFUTL",197,0)
 s dpid=$e(dpid,1,10) ; icn is the first 10 decimal digits
"RTN","SYNFUTL",198,0)
 q dpid
"RTN","SYNFUTL",199,0)
 ;
"RTN","SYNFUTL",200,0)
testIcnGen(fien) ; extrinsic generates an ICN for fhir patient fien
"RTN","SYNFUTL",201,0)
 n pid s pid=$$ien2pid(fien)
"RTN","SYNFUTL",202,0)
 n icn s icn=$$pid2icn(pid)
"RTN","SYNFUTL",203,0)
 n chk s chk=$$CHECKDG^MPIFSPC(icn)
"RTN","SYNFUTL",204,0)
 q icn_"V"_chk
"RTN","SYNFUTL",205,0)
 ;
"RTN","SYNFVF")
0^40^B37830226
"RTN","SYNFVF",1,0)
SYNFVF  ;ven/gpl - fhir loader utilities ;2018-08-17  3:28 PM
"RTN","SYNFVF",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNFVF",3,0)
 ;
"RTN","SYNFVF",4,0)
 ; Authored by George P. Lilly 2018
"RTN","SYNFVF",5,0)
 ;
"RTN","SYNFVF",6,0)
 q
"RTN","SYNFVF",7,0)
 ;
"RTN","SYNFVF",8,0)
 ; utilities to pull FHIR resources for VistA patients
"RTN","SYNFVF",9,0)
 ;
"RTN","SYNFVF",10,0)
vurl()  ; extrinsic returns the url for VistA get fhir
"RTN","SYNFVF",11,0)
 q "https://vista-fhir-dev.openplatform.healthcare/api/Patient/"
"RTN","SYNFVF",12,0)
 ;
"RTN","SYNFVF",13,0)
wsIcnList(rtn,filter)   ; web service to return a list of ICNs for vista patients
"RTN","SYNFVF",14,0)
 n dnfmin,dfnmax
"RTN","SYNFVF",15,0)
 s dfnmin=$g(filter("dfnmin"))
"RTN","SYNFVF",16,0)
 i dfnmin="" s dfnmin=$o(^DPT(0))
"RTN","SYNFVF",17,0)
 s dfnmax=$g(filter("dfnmax"))
"RTN","SYNFVF",18,0)
 i dfnmax="" s dfnmax=$o(^DPT("  "),-1)
"RTN","SYNFVF",19,0)
 ;
"RTN","SYNFVF",20,0)
 n tbl ; table of full ICNs sorted by dfn
"RTN","SYNFVF",21,0)
 d sortAFICN(.tbl)
"RTN","SYNFVF",22,0)
 ;
"RTN","SYNFVF",23,0)
 n rtn1 ; json return before decode
"RTN","SYNFVF",24,0)
 n zi s zi=+$o(tbl(dfnmin),-1)
"RTN","SYNFVF",25,0)
 f  s zi=$o(tbl(zi)) q:+zi=0  q:zi>dfnmax  d  ;
"RTN","SYNFVF",26,0)
 . n zj s zj=""
"RTN","SYNFVF",27,0)
 . f  s zj=$o(tbl(zi,zj)) q:zj=""  d  ;
"RTN","SYNFVF",28,0)
 . . s rtn1("return",zi,zj,"icn")=zj
"RTN","SYNFVF",29,0)
 . . s rtn1("return",zi,zj,"dfn")=zi
"RTN","SYNFVF",30,0)
 ;m rtn=rtn1
"RTN","SYNFVF",31,0)
 d ENCODE^VPRJSON("rtn1","rtn")
"RTN","SYNFVF",32,0)
 q
"RTN","SYNFVF",33,0)
 ;
"RTN","SYNFVF",34,0)
sortAFICN(ary)  ; sort the AFICN index by dfn
"RTN","SYNFVF",35,0)
 n zii s zii=""
"RTN","SYNFVF",36,0)
 f  s zii=$o(^DPT("AFICN",zii)) q:+zii=0  d  ;
"RTN","SYNFVF",37,0)
 . n zdfn
"RTN","SYNFVF",38,0)
 . s zdfn=$o(^DPT("AFICN",zii,""))
"RTN","SYNFVF",39,0)
 . s ary(zdfn,zii)=""
"RTN","SYNFVF",40,0)
 q
"RTN","SYNFVF",41,0)
 ;
"RTN","SYNFVF",42,0)
getVehuIcns     ; get the Dev VEHU ICNs and stores them in a graph
"RTN","SYNFVF",43,0)
 n gn,root
"RTN","SYNFVF",44,0)
 d purgegraph^%wd("vehu-icns")
"RTN","SYNFVF",45,0)
 s root=$$setroot^%wd("vehu-icns")
"RTN","SYNFVF",46,0)
 s gn="http://wip.vistaplex.org:9080/icnlist?dfnmax=100000"
"RTN","SYNFVF",47,0)
 s ok=$$%^%WC(.g,"GET",gn)
"RTN","SYNFVF",48,0)
 d DECODE^VPRJSON("g","g2")
"RTN","SYNFVF",49,0)
 ;
"RTN","SYNFVF",50,0)
 n zi,zj s (zi,zj)=""
"RTN","SYNFVF",51,0)
 f  s zi=$o(g2("return",zi)) q:zi=""  d  ;
"RTN","SYNFVF",52,0)
 . f  s zj=$o(g2("return",zi,zj)) q:zj=""  d  ;
"RTN","SYNFVF",53,0)
 . . s @root@(zi,zj)=""
"RTN","SYNFVF",54,0)
 . . s @root@("ICN",zj,zi)=""
"RTN","SYNFVF",55,0)
 ;
"RTN","SYNFVF",56,0)
 q
"RTN","SYNFVF",57,0)
 ;
"RTN","SYNFVF",58,0)
getAllergies    ; get VEHU allergies fhir resources
"RTN","SYNFVF",59,0)
 ;
"RTN","SYNFVF",60,0)
 n icnroot s icnroot=$$setroot^%wd("vehu-icns")
"RTN","SYNFVF",61,0)
 ;
"RTN","SYNFVF",62,0)
 d purgegraph^%wd("fhir-vista-AllergyIntolerance")
"RTN","SYNFVF",63,0)
 n zicn s zicn=""
"RTN","SYNFVF",64,0)
 f  s zicn=$o(@icnroot@("ICN",zicn)) q:zicn=""  d  ;
"RTN","SYNFVF",65,0)
 . n domain,entries
"RTN","SYNFVF",66,0)
 . s domain="AllergyIntolerance"
"RTN","SYNFVF",67,0)
 . d getDomain("entries",domain,zicn)
"RTN","SYNFVF",68,0)
 . i '$d(entries) q  ;
"RTN","SYNFVF",69,0)
 . s entries("ICN")=zicn
"RTN","SYNFVF",70,0)
 . s entries("DFN")=$o(@icnroot@("ICN",zicn,""))
"RTN","SYNFVF",71,0)
 . s zien=$$storeGraph("entries","fhir-vista-"_domain,zicn)
"RTN","SYNFVF",72,0)
 q
"RTN","SYNFVF",73,0)
 ;
"RTN","SYNFVF",74,0)
getAppointments ; get VEHU appointment fhir resources
"RTN","SYNFVF",75,0)
 ;
"RTN","SYNFVF",76,0)
 n icnroot s icnroot=$$setroot^%wd("vehu-icns")
"RTN","SYNFVF",77,0)
 ;
"RTN","SYNFVF",78,0)
 d purgegraph^%wd("fhir-vista-Appointment")
"RTN","SYNFVF",79,0)
 n zicn s zicn=""
"RTN","SYNFVF",80,0)
 f  s zicn=$o(@icnroot@("ICN",zicn)) q:zicn=""  d  ;
"RTN","SYNFVF",81,0)
 . n domain,entries
"RTN","SYNFVF",82,0)
 . s domain="Appointment"
"RTN","SYNFVF",83,0)
 . d getDomain("entries",domain,zicn)
"RTN","SYNFVF",84,0)
 . i '$d(entries) q  ;
"RTN","SYNFVF",85,0)
 . s entries("ICN")=zicn
"RTN","SYNFVF",86,0)
 . s entries("DFN")=$o(@icnroot@("ICN",zicn,""))
"RTN","SYNFVF",87,0)
 . s zien=$$storeGraph("entries","fhir-vista-"_domain,zicn)
"RTN","SYNFVF",88,0)
 q
"RTN","SYNFVF",89,0)
 ;
"RTN","SYNFVF",90,0)
getProcedures   ; get VEHU procedure fhir resources
"RTN","SYNFVF",91,0)
 ;
"RTN","SYNFVF",92,0)
 n icnroot s icnroot=$$setroot^%wd("vehu-icns")
"RTN","SYNFVF",93,0)
 ;
"RTN","SYNFVF",94,0)
 d purgegraph^%wd("fhir-vista-Procedure")
"RTN","SYNFVF",95,0)
 n zicn s zicn=""
"RTN","SYNFVF",96,0)
 f  s zicn=$o(@icnroot@("ICN",zicn)) q:zicn=""  d  ;
"RTN","SYNFVF",97,0)
 . n domain,entries
"RTN","SYNFVF",98,0)
 . s domain="Procedure"
"RTN","SYNFVF",99,0)
 . d getDomain("entries",domain,zicn)
"RTN","SYNFVF",100,0)
 . i '$d(entries) q  ;
"RTN","SYNFVF",101,0)
 . s entries("ICN")=zicn
"RTN","SYNFVF",102,0)
 . s entries("DFN")=$o(@icnroot@("ICN",zicn,""))
"RTN","SYNFVF",103,0)
 . s zien=$$storeGraph("entries","fhir-vista-"_domain,zicn)
"RTN","SYNFVF",104,0)
 q
"RTN","SYNFVF",105,0)
 ;
"RTN","SYNFVF",106,0)
getDomain(rtn,domain,icn)       ; pull domain entries for VistA patient ICN
"RTN","SYNFVF",107,0)
 n gn2
"RTN","SYNFVF",108,0)
 s gn2="https://vista-fhir-dev.openplatform.healthcare/api/Patient/"
"RTN","SYNFVF",109,0)
 ;
"RTN","SYNFVF",110,0)
 n url,fhir,r1
"RTN","SYNFVF",111,0)
 s url=gn2_icn_"/"_domain
"RTN","SYNFVF",112,0)
 s ok=$$%^%WC(.fhir,"GET",url)
"RTN","SYNFVF",113,0)
 d DECODE^VPRJSON("fhir","r1")
"RTN","SYNFVF",114,0)
 m @rtn@("entry")=r1("entry")
"RTN","SYNFVF",115,0)
 ;
"RTN","SYNFVF",116,0)
 q
"RTN","SYNFVF",117,0)
 ;
"RTN","SYNFVF",118,0)
storeGraph(ary,graph,id)        ; stores an array ary, passed by name
"RTN","SYNFVF",119,0)
 ; into graphname graph with B index id
"RTN","SYNFVF",120,0)
 ; extrinsic, returns the ien
"RTN","SYNFVF",121,0)
 ;
"RTN","SYNFVF",122,0)
 i graph="" s graph="misc"
"RTN","SYNFVF",123,0)
 n root set root=$$setroot^%wd(graph)
"RTN","SYNFVF",124,0)
 ;
"RTN","SYNFVF",125,0)
 n ien,rien
"RTN","SYNFVF",126,0)
 s ien=$o(@root@(" "),-1)+1
"RTN","SYNFVF",127,0)
 ;
"RTN","SYNFVF",128,0)
 m @root@(ien)=@ary
"RTN","SYNFVF",129,0)
 ;
"RTN","SYNFVF",130,0)
 s @root@("B",id,ien)=""
"RTN","SYNFVF",131,0)
 ;
"RTN","SYNFVF",132,0)
 q ien
"RTN","SYNFVF",133,0)
 ;
"RTN","SYNFVF",134,0)
wsGetAllergy(rtn,filter)        ; web service to pull a random allergy from 
"RTN","SYNFVF",135,0)
 ; graph fhir-vista-Allergy
"RTN","SYNFVF",136,0)
 ;
"RTN","SYNFVF",137,0)
 n root s root=$$setroot^%wd("fhir-vista-AllergyIntolerance")
"RTN","SYNFVF",138,0)
 n max
"RTN","SYNFVF",139,0)
 s max=$o(@root@(" "),-1)
"RTN","SYNFVF",140,0)
 i +max=0 q  ; nothing to pull
"RTN","SYNFVF",141,0)
 n ien s ien=$r(max)
"RTN","SYNFVF",142,0)
 i '$d(@root@(ien)) s ien=$r(max)
"RTN","SYNFVF",143,0)
 n r1
"RTN","SYNFVF",144,0)
 s r1=$na(@root@(ien))
"RTN","SYNFVF",145,0)
 i $g(filter("format"))="mumps" d  q  ;
"RTN","SYNFVF",146,0)
 . m rtn=@r1
"RTN","SYNFVF",147,0)
 d ENCODE^VPRJSON(r1,"rtn")
"RTN","SYNFVF",148,0)
 q
"RTN","SYNFVF",149,0)
 ; 
"RTN","SYNFVF",150,0)
wsGetAppointment(rtn,filter)    ; web service to pull a random appointments from 
"RTN","SYNFVF",151,0)
 ; graph fhir-vista-Appointment
"RTN","SYNFVF",152,0)
 ;
"RTN","SYNFVF",153,0)
 n root s root=$$setroot^%wd("fhir-vista-Appointment")
"RTN","SYNFVF",154,0)
 n max
"RTN","SYNFVF",155,0)
 s max=$o(@root@(" "),-1)
"RTN","SYNFVF",156,0)
 i +max=0 q  ; nothing to pull
"RTN","SYNFVF",157,0)
 n ien s ien=$r(max)
"RTN","SYNFVF",158,0)
 i '$d(@root@(ien)) s ien=$r(max)
"RTN","SYNFVF",159,0)
 n r1
"RTN","SYNFVF",160,0)
 s r1=$na(@root@(ien))
"RTN","SYNFVF",161,0)
 i $g(filter("format"))="mumps" d  q  ;
"RTN","SYNFVF",162,0)
 . m rtn=@r1
"RTN","SYNFVF",163,0)
 d ENCODE^VPRJSON(r1,"rtn")
"RTN","SYNFVF",164,0)
 q
"RTN","SYNFVF",165,0)
 ; 
"RTN","SYNFVF",166,0)
wsGetProcedure(rtn,filter)      ; web service to pull a random procedure from 
"RTN","SYNFVF",167,0)
 ; graph fhir-vista-Procedure
"RTN","SYNFVF",168,0)
 ;
"RTN","SYNFVF",169,0)
 n root s root=$$setroot^%wd("fhir-vista-Procedure")
"RTN","SYNFVF",170,0)
 n max
"RTN","SYNFVF",171,0)
 s max=$o(@root@(" "),-1)
"RTN","SYNFVF",172,0)
 i +max=0 q  ; nothing to pull
"RTN","SYNFVF",173,0)
 n ien s ien=$r(max)
"RTN","SYNFVF",174,0)
 i '$d(@root@(ien)) s ien=$r(max)
"RTN","SYNFVF",175,0)
 n r1
"RTN","SYNFVF",176,0)
 s r1=$na(@root@(ien))
"RTN","SYNFVF",177,0)
 i $g(filter("format"))="mumps" d  q  ;
"RTN","SYNFVF",178,0)
 . m rtn=@r1
"RTN","SYNFVF",179,0)
 d ENCODE^VPRJSON(r1,"rtn")
"RTN","SYNFVF",180,0)
 q
"RTN","SYNFVF",181,0)
 ; 
"RTN","SYNFVIT")
0^41^B133906664
"RTN","SYNFVIT",1,0)
SYNFVIT ;ven/gpl - fhir loader utilities ;2018-05-08  4:23 PM
"RTN","SYNFVIT",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNFVIT",3,0)
 ;
"RTN","SYNFVIT",4,0)
 ; Authored by George P. Lilly 2017-2018
"RTN","SYNFVIT",5,0)
 ;
"RTN","SYNFVIT",6,0)
 q
"RTN","SYNFVIT",7,0)
 ;
"RTN","SYNFVIT",8,0)
importVitals(rtn,ien,args) ; entry point for loading vitals for a patient
"RTN","SYNFVIT",9,0)
 ; calls the intake Vitals web service directly
"RTN","SYNFVIT",10,0)
 ;
"RTN","SYNFVIT",11,0)
 n grtn
"RTN","SYNFVIT",12,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFVIT",13,0)
 n % s %=$$wsIntakeVitals(.args,,.grtn,ien)
"RTN","SYNFVIT",14,0)
 i $d(grtn) d  ; something was returned
"RTN","SYNFVIT",15,0)
 . k @root@(ien,"load","vitals")
"RTN","SYNFVIT",16,0)
 . m @root@(ien,"load","vitals")=grtn("vitals")
"RTN","SYNFVIT",17,0)
 . if $g(args("debug"))=1 m rtn=grtn
"RTN","SYNFVIT",18,0)
 s rtn("vitalsStatus","status")=$g(grtn("status","status"))
"RTN","SYNFVIT",19,0)
 s rtn("vitalsStatus","loaded")=$g(grtn("status","loaded"))
"RTN","SYNFVIT",20,0)
 s rtn("vitalsStatus","errors")=$g(grtn("status","errors"))
"RTN","SYNFVIT",21,0)
 ;b
"RTN","SYNFVIT",22,0)
 ;
"RTN","SYNFVIT",23,0)
 ;
"RTN","SYNFVIT",24,0)
 q
"RTN","SYNFVIT",25,0)
 ;
"RTN","SYNFVIT",26,0)
wsIntakeVitals(args,body,result,ien) ; web service entry (post)
"RTN","SYNFVIT",27,0)
 ; for intake of one or more Vital signs. input are fhir resources
"RTN","SYNFVIT",28,0)
 ; result is json and summarizes what was done
"RTN","SYNFVIT",29,0)
 ; args include patientId
"RTN","SYNFVIT",30,0)
 ; ien is specified for internal calls, where the json is already in a graph
"RTN","SYNFVIT",31,0)
 n jtmp,json,jrslt,eval
"RTN","SYNFVIT",32,0)
 ;i $g(ien)'="" if $$loadStatus("vitals","",ien)=1 d  q  ;
"RTN","SYNFVIT",33,0)
 ;. s result("vitalsStatus","status")="alreadyLoaded"
"RTN","SYNFVIT",34,0)
 i $g(ien)'="" d  ; internal call
"RTN","SYNFVIT",35,0)
 . d getIntakeFhir^SYNFHIR("json",,"Observation",ien,1)
"RTN","SYNFVIT",36,0)
 e  d  ; 
"RTN","SYNFVIT",37,0)
 . ;s args("load")=0
"RTN","SYNFVIT",38,0)
 . merge jtmp=BODY
"RTN","SYNFVIT",39,0)
 . do DECODE^VPRJSON("jtmp","json")
"RTN","SYNFVIT",40,0)
 i '$d(json) q 0  ;
"RTN","SYNFVIT",41,0)
 m ^gpl("gjson")=json
"RTN","SYNFVIT",42,0)
 ;
"RTN","SYNFVIT",43,0)
 ; determine the patient
"RTN","SYNFVIT",44,0)
 ;
"RTN","SYNFVIT",45,0)
 n dfn,eval
"RTN","SYNFVIT",46,0)
 if $g(ien)'="" d  ;
"RTN","SYNFVIT",47,0)
 . s dfn=$$ien2dfn^SYNFUTL(ien) ; look up dfn in the graph
"RTN","SYNFVIT",48,0)
 else  d  ;
"RTN","SYNFVIT",49,0)
 . s dfn=$g(args("dfn"))
"RTN","SYNFVIT",50,0)
 . i dfn="" d  ;
"RTN","SYNFVIT",51,0)
 . . n icn s icn=$g(args("icn"))
"RTN","SYNFVIT",52,0)
 . . i icn'="" s dfn=$$icn2dfn^SYNFUTL(icn)
"RTN","SYNFVIT",53,0)
 i $g(dfn)="" do  quit 0  ; need the patient
"RTN","SYNFVIT",54,0)
 . s result("vitals",1,"log",1)="Error, patient not found.. terminating"
"RTN","SYNFVIT",55,0)
 ;
"RTN","SYNFVIT",56,0)
 ;
"RTN","SYNFVIT",57,0)
 new zi s zi=0
"RTN","SYNFVIT",58,0)
 for  set zi=$order(json("entry",zi)) quit:+zi=0  do  ;
"RTN","SYNFVIT",59,0)
 . ;
"RTN","SYNFVIT",60,0)
 . ; define a place to log the processing of this entry
"RTN","SYNFVIT",61,0)
 . ;
"RTN","SYNFVIT",62,0)
 . new jlog set jlog=$name(eval("vitals",zi))
"RTN","SYNFVIT",63,0)
 . ;
"RTN","SYNFVIT",64,0)
 . ; insure that the resourceType is Observation
"RTN","SYNFVIT",65,0)
 . ;
"RTN","SYNFVIT",66,0)
 . new type set type=$get(json("entry",zi,"resource","resourceType"))
"RTN","SYNFVIT",67,0)
 . if type'="Observation" do  quit  ;
"RTN","SYNFVIT",68,0)
 . . set eval("vitals",zi,"vars","resourceType")=type
"RTN","SYNFVIT",69,0)
 . . do log(jlog,"Resource type not Observation, skipping entry")
"RTN","SYNFVIT",70,0)
 . set eval("vitals",zi,"vars","resourceType")=type
"RTN","SYNFVIT",71,0)
 . ;
"RTN","SYNFVIT",72,0)
 . ; determine the Observation category and quit if not vital-signs
"RTN","SYNFVIT",73,0)
 . ;
"RTN","SYNFVIT",74,0)
 . new obstype set obstype=$get(json("entry",zi,"resource","category",1,"coding",1,"code"))
"RTN","SYNFVIT",75,0)
 . if obstype="" do  ; category is missing, try mapping the code
"RTN","SYNFVIT",76,0)
 . . new trycode,trydisp,tryy 
"RTN","SYNFVIT",77,0)
 . . set trycode=$g(json("entry",zi,"resource","code","coding",1,"code"))
"RTN","SYNFVIT",78,0)
 . . set trydisp=$g(json("entry",zi,"resource","code","coding",1,"display"))
"RTN","SYNFVIT",79,0)
 . . s tryy=$$loinc2sct(trycode)
"RTN","SYNFVIT",80,0)
 . . if tryy="" d  quit  ;
"RTN","SYNFVIT",81,0)
 . . . d log(jlog,"Observation Category missing, not vital signs; code is: "_trycode_" "_trydisp)
"RTN","SYNFVIT",82,0)
 . . if tryy'="" set obstype="vital-signs"
"RTN","SYNFVIT",83,0)
 . . d log(jlog,"Derived category is "_obstype)
"RTN","SYNFVIT",84,0)
 . ;
"RTN","SYNFVIT",85,0)
 . if obstype'="vital-signs" do  quit  ;
"RTN","SYNFVIT",86,0)
 . . set eval("vitals",zi,"vars","observationCategory")=obstype
"RTN","SYNFVIT",87,0)
 . . do log(jlog,"Observation Category is not vital-signs, skipping")
"RTN","SYNFVIT",88,0)
 . set eval("vitals",zi,"vars","observationCategory")=obstype
"RTN","SYNFVIT",89,0)
 . ;
"RTN","SYNFVIT",90,0)
 . ; see if this resource has already been loaded. if so, skip it
"RTN","SYNFVIT",91,0)
 . ;
"RTN","SYNFVIT",92,0)
 . if $g(ien)'="" if $$loadStatus("vitals",zi,ien)=1 do  quit  ;
"RTN","SYNFVIT",93,0)
 . . d log(jlog,"Vital sign already loaded, skipping")
"RTN","SYNFVIT",94,0)
 . ;
"RTN","SYNFVIT",95,0)
 . ; determine Vitals type, code, coding system, and display text
"RTN","SYNFVIT",96,0)
 . ;
"RTN","SYNFVIT",97,0)
 . new vittype set vittype=$get(json("entry",zi,"resource","code","text"))
"RTN","SYNFVIT",98,0)
 . if vittype="" set vittype=$get(json("entry",zi,"resource","code","coding",1,"display"))
"RTN","SYNFVIT",99,0)
 . do log(jlog,"Vitals type is: "_vittype)
"RTN","SYNFVIT",100,0)
 . set eval("vitals",zi,"vars","type")=vittype
"RTN","SYNFVIT",101,0)
 . ;
"RTN","SYNFVIT",102,0)
 . ; determine the id of the resource
"RTN","SYNFVIT",103,0)
 . ;
"RTN","SYNFVIT",104,0)
 . new id set id=$get(json("entry",zi,"resource","id"))
"RTN","SYNFVIT",105,0)
 . set eval("vitals",zi,"vars","id")=id
"RTN","SYNFVIT",106,0)
 . d log(jlog,"ID is: "_id)
"RTN","SYNFVIT",107,0)
 . ;
"RTN","SYNFVIT",108,0)
 . new obscode set obscode=$get(json("entry",zi,"resource","code","coding",1,"code"))
"RTN","SYNFVIT",109,0)
 . do log(jlog,"code is: "_obscode)
"RTN","SYNFVIT",110,0)
 . set eval("vitals",zi,"vars","code")=obscode
"RTN","SYNFVIT",111,0)
 . ;
"RTN","SYNFVIT",112,0)
 . s ^gpl("vitals",obscode,vittype)=""
"RTN","SYNFVIT",113,0)
 . ; here's what we got so far:
"RTN","SYNFVIT",114,0)
 . ;^gpl("vitals","29463-7","Body Weight")=""
"RTN","SYNFVIT",115,0)
 . ;^gpl("vitals","39156-5","Body Mass Index")=""
"RTN","SYNFVIT",116,0)
 . ;^gpl("vitals","55284-4","Blood Pressure")=""
"RTN","SYNFVIT",117,0)
 . ;^gpl("vitals","8302-2","Body Height")=""
"RTN","SYNFVIT",118,0)
 . ;^gpl("vitals","8331-1","Oral temperature")=""
"RTN","SYNFVIT",119,0)
 . ;
"RTN","SYNFVIT",120,0)
 . new codesystem set codesystem=$get(json("entry",zi,"resource","code","coding",1,"system"))
"RTN","SYNFVIT",121,0)
 . do log(jlog,"code system is: "_codesystem)
"RTN","SYNFVIT",122,0)
 . set eval("vitals",zi,"vars","codeSystem")=codesystem
"RTN","SYNFVIT",123,0)
 . ;
"RTN","SYNFVIT",124,0)
 . ; determine the value and units
"RTN","SYNFVIT",125,0)
 . ;
"RTN","SYNFVIT",126,0)
 . new value set value=$get(json("entry",zi,"resource","valueQuantity","value"))
"RTN","SYNFVIT",127,0)
 . do log(jlog,"value is: "_value)
"RTN","SYNFVIT",128,0)
 . set eval("vitals",zi,"vars","value")=value
"RTN","SYNFVIT",129,0)
 . ;
"RTN","SYNFVIT",130,0)
 . new unit set unit=$get(json("entry",zi,"resource","valueQuantity","unit"))
"RTN","SYNFVIT",131,0)
 . do log(jlog,"units are: "_unit)
"RTN","SYNFVIT",132,0)
 . set eval("vitals",zi,"vars","units")=unit
"RTN","SYNFVIT",133,0)
 . ;
"RTN","SYNFVIT",134,0)
 . ; fix blood preasure readings (combine two readings to one)
"RTN","SYNFVIT",135,0)
 . ;
"RTN","SYNFVIT",136,0)
 . if obscode="55284-4" do  ; Blood Pressure
"RTN","SYNFVIT",137,0)
 . . new tmpjson,systolic,diastolic,combined
"RTN","SYNFVIT",138,0)
 . . merge tmpjson=json("entry",zi)
"RTN","SYNFVIT",139,0)
 . . d log(jlog,"Combining Blood Pressure values")
"RTN","SYNFVIT",140,0)
 . . n tn s tn=$na(tmpjson("resource","component"))
"RTN","SYNFVIT",141,0)
 . . n tx
"RTN","SYNFVIT",142,0)
 . . f tx=1,2  d  ;
"RTN","SYNFVIT",143,0)
 . . . if $g(@tn@(tx,"code","coding",1,"code"))="8480-6" d  ; Systolic Blood Pressure
"RTN","SYNFVIT",144,0)
 . . . . s systolic("units")=$g(@tn@(tx,"valueQuantity","unit"))
"RTN","SYNFVIT",145,0)
 . . . . s unit=systolic("units")
"RTN","SYNFVIT",146,0)
 . . . . s systolic("value")=$g(@tn@(tx,"valueQuantity","value"))
"RTN","SYNFVIT",147,0)
 . . . . s value=systolic("value")
"RTN","SYNFVIT",148,0)
 . . . . d log(jlog,("Systolic value is: "_systolic("value")))
"RTN","SYNFVIT",149,0)
 . . . if $g(@tn@(tx,"code","coding",1,"code"))="8462-4" d  ; Diastolic Blood Pressure
"RTN","SYNFVIT",150,0)
 . . . . s diastolic("units")=$g(@tn@(tx,"valueQuantity","unit"))
"RTN","SYNFVIT",151,0)
 . . . . s unit=diastolic("units")
"RTN","SYNFVIT",152,0)
 . . . . s diastolic("value")=$g(@tn@(tx,"valueQuantity","value"))
"RTN","SYNFVIT",153,0)
 . . . . s value=diastolic("value")
"RTN","SYNFVIT",154,0)
 . . . . d log(jlog,("Diastolic value is: "_diastolic("value")))
"RTN","SYNFVIT",155,0)
 . . s combined=$g(systolic("value"))_"/"_$g(diastolic("value"))
"RTN","SYNFVIT",156,0)
 . . s value=combined
"RTN","SYNFVIT",157,0)
 . . d log(jlog,"Combined Blood Pressure value is: "_combined)
"RTN","SYNFVIT",158,0)
 . . set eval("vitals",zi,"vars","value")=combined
"RTN","SYNFVIT",159,0)
 . . set eval("vitals",zi,"vars","units")=$g(diastolic("units"))
"RTN","SYNFVIT",160,0)
 . . d log(jlog,"Blood Pressure units are: "_$g(diastolic("units")))
"RTN","SYNFVIT",161,0)
 . . ;b
"RTN","SYNFVIT",162,0)
 . ;
"RTN","SYNFVIT",163,0)
 . ; determine the effective date
"RTN","SYNFVIT",164,0)
 . ;
"RTN","SYNFVIT",165,0)
 . new effdate set effdate=$get(json("entry",zi,"resource","effectiveDateTime"))
"RTN","SYNFVIT",166,0)
 . do log(jlog,"effectiveDateTime is: "_effdate)
"RTN","SYNFVIT",167,0)
 . set eval("vitals",zi,"vars","effectiveDateTime")=effdate
"RTN","SYNFVIT",168,0)
 . new fmtime s fmtime=$$fhirTfm^SYNFUTL(effdate)
"RTN","SYNFVIT",169,0)
 . d log(jlog,"fileman dateTime is: "_fmtime)
"RTN","SYNFVIT",170,0)
 . set eval("vitals",zi,"vars","fmDateTime")=fmtime ;
"RTN","SYNFVIT",171,0)
 . new hl7time s hl7time=$$fhirThl7^SYNFUTL(effdate)
"RTN","SYNFVIT",172,0)
 . d log(jlog,"hl7 dateTime is: "_hl7time)
"RTN","SYNFVIT",173,0)
 . set eval("vitals",zi,"vars","hl7DateTime")=hl7time ;
"RTN","SYNFVIT",174,0)
 . ;
"RTN","SYNFVIT",175,0)
 . ; set up to call the data loader
"RTN","SYNFVIT",176,0)
 . ;
"RTN","SYNFVIT",177,0)
 . n RETSTA,DHPPAT,DHPSCT,DHPOBS,DHPUNT,DHPDTM,DHPPROV,DHPLOC
"RTN","SYNFVIT",178,0)
 . ;
"RTN","SYNFVIT",179,0)
 . s DHPPAT=$$dfn2icn^SYNFUTL(dfn)
"RTN","SYNFVIT",180,0)
 . s eval("vitals",zi,"parms","DHPPAT")=DHPPAT
"RTN","SYNFVIT",181,0)
 . ;
"RTN","SYNFVIT",182,0)
 . n sct s sct=$$loinc2sct(obscode) ; find the snomed code
"RTN","SYNFVIT",183,0)
 . i sct="" d  quit
"RTN","SYNFVIT",184,0)
 . . d log(jlog,"Snomed Code not found for vitals code: "_obscode_" -- skipping")
"RTN","SYNFVIT",185,0)
 . . s eval("vitals",zi,"status","loadstatus")="cannotLoad"
"RTN","SYNFVIT",186,0)
 . . s eval("vitals",zi,"status","issue")="Snomed Code not found for vitals code: "_obscode_" -- skipping"
"RTN","SYNFVIT",187,0)
 . . s eval("status","errors")=$g(eval("status","errors"))+1
"RTN","SYNFVIT",188,0)
 . s eval("vitals",zi,"parms","DHPSCT")=sct
"RTN","SYNFVIT",189,0)
 . d log(jlog,"Snomed Code is: "_sct)
"RTN","SYNFVIT",190,0)
 . s DHPSCT=sct
"RTN","SYNFVIT",191,0)
 . ;
"RTN","SYNFVIT",192,0)
 . s DHPOBS=value
"RTN","SYNFVIT",193,0)
 . s eval("vitals",zi,"parms","DHPOBS")=value
"RTN","SYNFVIT",194,0)
 . d log(jlog,"Value is: "_value)
"RTN","SYNFVIT",195,0)
 . ;
"RTN","SYNFVIT",196,0)
 . s DHPUNT=unit
"RTN","SYNFVIT",197,0)
 . s eval("vitals",zi,"parms","DHPUNT")=unit
"RTN","SYNFVIT",198,0)
 . d log(jlog,"Units are: "_unit)
"RTN","SYNFVIT",199,0)
 . ;
"RTN","SYNFVIT",200,0)
 . s DHPDTM=hl7time
"RTN","SYNFVIT",201,0)
 . s eval("vitals",zi,"parms","DHPDTM")=hl7time
"RTN","SYNFVIT",202,0)
 . d log(jlog,"HL7 DateTime is: "_hl7time)
"RTN","SYNFVIT",203,0)
 . ;
"RTN","SYNFVIT",204,0)
 . s DHPPROV=$$MAP^SYNQLDM("OP","provider")
"RTN","SYNFVIT",205,0)
 . n DHPPROVIEN s DHPPROVIEN=$o(^VA(200,"B",DHPPROV,""))
"RTN","SYNFVIT",206,0)
 . if DHPPROVIEN="" S DHPPROVIEN=3
"RTN","SYNFVIT",207,0)
 . s eval("vitals",zi,"parms","DHPPROV")=DHPPROVIEN
"RTN","SYNFVIT",208,0)
 . d log(jlog,"Provider for outpatient is: #"_DHPPROVIEN_" "_DHPPROV)
"RTN","SYNFVIT",209,0)
 . ;
"RTN","SYNFVIT",210,0)
 . s DHPLOC=$$MAP^SYNQLDM("OP","location")
"RTN","SYNFVIT",211,0)
 . n DHPLOCIEN s DHPLOCIEN=$o(^SC("B",DHPLOC,""))
"RTN","SYNFVIT",212,0)
 . if DHPLOCIEN="" S DHPLOCIEN=4
"RTN","SYNFVIT",213,0)
 . s eval("vitals",zi,"parms","DHPLOC")=DHPLOCIEN
"RTN","SYNFVIT",214,0)
 . d log(jlog,"Location for outpatient is: #"_DHPLOCIEN_" "_DHPLOC)
"RTN","SYNFVIT",215,0)
 . ;
"RTN","SYNFVIT",216,0)
 . s eval("vitals",zi,"status","loadstatus")="readyToLoad"
"RTN","SYNFVIT",217,0)
 . ;
"RTN","SYNFVIT",218,0)
 . if $g(args("load"))=1 d  ; only load if told to
"RTN","SYNFVIT",219,0)
 . . if $g(ien)'="" if $$loadStatus("vitals",zi,ien)=1 do  quit  ;
"RTN","SYNFVIT",220,0)
 . . . d log(jlog,"Vital sign already loaded, skipping")
"RTN","SYNFVIT",221,0)
 . . d log(jlog,"Calling VITUPD^SYNDHP61 to add vital")
"RTN","SYNFVIT",222,0)
 . . D VITUPD^SYNDHP61(.RETSTA,DHPPAT,DHPSCT,DHPOBS,DHPUNT,DHPDTM,DHPPROV,DHPLOC)       ; vitals update
"RTN","SYNFVIT",223,0)
 . . d log(jlog,"Return from VITUPD^SYNDHP61 was: "_$g(RETSTA))
"RTN","SYNFVIT",224,0)
 . . if +$g(RETSTA)=1 do  ;
"RTN","SYNFVIT",225,0)
 . . . s eval("status","loaded")=$g(eval("status","loaded"))+1
"RTN","SYNFVIT",226,0)
 . . . s eval("vitals",zi,"status","loadstatus")="loaded"
"RTN","SYNFVIT",227,0)
 . . else  s eval("status","errors")=$g(eval("status","errors"))+1
"RTN","SYNFVIT",228,0)
 ;
"RTN","SYNFVIT",229,0)
 if $get(args("debug"))=1 do  ;
"RTN","SYNFVIT",230,0)
 . m jrslt("source")=json
"RTN","SYNFVIT",231,0)
 . m jrslt("args")=args
"RTN","SYNFVIT",232,0)
 . m jrslt("eval")=eval
"RTN","SYNFVIT",233,0)
 m jrslt("vitalsStatus")=eval("vitalsStatus")
"RTN","SYNFVIT",234,0)
 set jrslt("result","status")="ok"
"RTN","SYNFVIT",235,0)
 set jrslt("result","loaded")=$g(eval("status","loaded"))
"RTN","SYNFVIT",236,0)
 i $g(ien)'="" d  ; called internally
"RTN","SYNFVIT",237,0)
 . m result=eval
"RTN","SYNFVIT",238,0)
 . m result("status")=jrslt("result")
"RTN","SYNFVIT",239,0)
 . ;b
"RTN","SYNFVIT",240,0)
 e  d  ;
"RTN","SYNFVIT",241,0)
 . d ENCODE^VPRJSON("jrslt","result")
"RTN","SYNFVIT",242,0)
 . set HTTPRSP("mime")="application/json" 
"RTN","SYNFVIT",243,0)
 q 1
"RTN","SYNFVIT",244,0)
 ;
"RTN","SYNFVIT",245,0)
log(ary,txt) ; adds a text line to @ary@("log")
"RTN","SYNFVIT",246,0)
 s @ary@("log",$o(@ary@("log",""),-1)+1)=$g(txt)
"RTN","SYNFVIT",247,0)
 q
"RTN","SYNFVIT",248,0)
 ;
"RTN","SYNFVIT",249,0)
loadStatus(typ,zx,zien) ; extrinsic return 1 if resource was loaded
"RTN","SYNFVIT",250,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFVIT",251,0)
 n rt s rt=0
"RTN","SYNFVIT",252,0)
 i $g(zx)="" i $d(@root@(zien,"load",typ)) s rt=1 q rt
"RTN","SYNFVIT",253,0)
 i $get(@root@(zien,"load",typ,zx,"status","loadstatus"))="loaded" s rt=1
"RTN","SYNFVIT",254,0)
 q rt
"RTN","SYNFVIT",255,0)
loinc2sct(loinc) ; extrinsic returns a Snomed code for a Loinc code
"RTN","SYNFVIT",256,0)
 ; for vitals
"RTN","SYNFVIT",257,0)
 ; thanks to Ferdi for the Snomed mapping
"RTN","SYNFVIT",258,0)
 ;
"RTN","SYNFVIT",259,0)
 ; here's what we got so far:
"RTN","SYNFVIT",260,0)
 ;^gpl("vitals","29463-7","Body Weight")=""
"RTN","SYNFVIT",261,0)
 ;^gpl("vitals","39156-5","Body Mass Index")="" ; oops
"RTN","SYNFVIT",262,0)
 ;^gpl("vitals","55284-4","Blood Pressure")=""
"RTN","SYNFVIT",263,0)
 ;^gpl("vitals","8302-2","Body Height")=""
"RTN","SYNFVIT",264,0)
 ;^gpl("vitals","8331-1","Oral temperature")="" ;
"RTN","SYNFVIT",265,0)
 ;
"RTN","SYNFVIT",266,0)
 S SCTA("29463-7",27113001)="9^Body weight"
"RTN","SYNFVIT",267,0)
 S SCTA("8302-2",50373000)="8^Body height"
"RTN","SYNFVIT",268,0)
 S SCTA("55284-4",75367002)="1^Blood pressure"
"RTN","SYNFVIT",269,0)
 S SCTA(78564009)="5^Pulse rate"
"RTN","SYNFVIT",270,0)
 S SCTA("8331-1",386725007)="2^Body Temperature"
"RTN","SYNFVIT",271,0)
 S SCTA(86290005)="3^Respiration"
"RTN","SYNFVIT",272,0)
 S SCTA(48094003)="10^Abdominal girth measurement"
"RTN","SYNFVIT",273,0)
 S SCTA(21727005)="11^Audiometry"
"RTN","SYNFVIT",274,0)
 S SCTA(252465000)="21^Pulse oximetry"
"RTN","SYNFVIT",275,0)
 S SCTA(22253000)="22^Pain"
"RTN","SYNFVIT",276,0)
 ;
"RTN","SYNFVIT",277,0)
 q $o(SCTA(loinc,""))
"RTN","SYNFVIT",278,0)
 ;
"RTN","SYNFVIT",279,0)
testall ; run the vitals import on all imported patients
"RTN","SYNFVIT",280,0)
 new root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNFVIT",281,0)
 new indx s indx=$na(@root@("POS","DFN"))
"RTN","SYNFVIT",282,0)
 n dfn,ien,filter,reslt
"RTN","SYNFVIT",283,0)
 s dfn=0
"RTN","SYNFVIT",284,0)
 f  s dfn=$o(@indx@(dfn)) q:+dfn=0  d  ;
"RTN","SYNFVIT",285,0)
 . s ien=$o(@indx@(dfn,""))
"RTN","SYNFVIT",286,0)
 . q:ien=""
"RTN","SYNFVIT",287,0)
 . s filter("dfn")=dfn
"RTN","SYNFVIT",288,0)
 . k reslt
"RTN","SYNFVIT",289,0)
 . d wsIntakeVitals(.filter,,.reslt,ien)
"RTN","SYNFVIT",290,0)
 q
"RTN","SYNFVIT",291,0)
 ;
"RTN","SYNGBLLD")
0^50^B144653085
"RTN","SYNGBLLD",1,0)
SYNGBLLD ; HC/ART - HealthConcourse - DHP load data in ^SYN("2002.030" global ;02/04/2019
"RTN","SYNGBLLD",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNGBLLD",3,0)
 ;;
"RTN","SYNGBLLD",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNGBLLD",5,0)
 ;
"RTN","SYNGBLLD",6,0)
 QUIT
"RTN","SYNGBLLD",7,0)
 ;
"RTN","SYNGBLLD",8,0)
EN ;load all
"RTN","SYNGBLLD",9,0)
 ;
"RTN","SYNGBLLD",10,0)
 D LOADMH
"RTN","SYNGBLLD",11,0)
 D LOADCPT
"RTN","SYNGBLLD",12,0)
 D LOADHF
"RTN","SYNGBLLD",13,0)
 D LOADVIT
"RTN","SYNGBLLD",14,0)
 D LOADPOS
"RTN","SYNGBLLD",15,0)
 D LOADFLAG
"RTN","SYNGBLLD",16,0)
 ;
"RTN","SYNGBLLD",17,0)
 QUIT
"RTN","SYNGBLLD",18,0)
 ;
"RTN","SYNGBLLD",19,0)
LOADMH ;load ^SYN mapping table for mental health instruments
"RTN","SYNGBLLD",20,0)
 N IDX,INSTRUMT,TESTID,TESTNAME,LOINC,SNOMED
"RTN","SYNGBLLD",21,0)
 K ^SYN("2002.030","mh2loinc")
"RTN","SYNGBLLD",22,0)
 K ^SYN("2002.030","mh2sct")
"RTN","SYNGBLLD",23,0)
 ;LOINC
"RTN","SYNGBLLD",24,0)
 S IDX=0
"RTN","SYNGBLLD",25,0)
 F  S IDX=IDX+1,INSTRUMT=$P($T(MHLOINC+IDX),";;",2) QUIT:INSTRUMT="zzzzz"  D
"RTN","SYNGBLLD",26,0)
 . S TESTID=$P(INSTRUMT,U,1)
"RTN","SYNGBLLD",27,0)
 . S TESTNAME=$P(INSTRUMT,U,2)
"RTN","SYNGBLLD",28,0)
 . S LOINC=$P(INSTRUMT,U,3)
"RTN","SYNGBLLD",29,0)
 . S:(TESTID'="")&(LOINC'="") ^SYN("2002.030","mh2loinc","direct",TESTID,LOINC)=""
"RTN","SYNGBLLD",30,0)
 . S:(TESTNAME'="")&(LOINC'="") ^SYN("2002.030","mh2loinc","direct",TESTNAME,LOINC)=""
"RTN","SYNGBLLD",31,0)
 . S:(TESTID'="")&(LOINC'="") ^SYN("2002.030","mh2loinc","inverse",LOINC,TESTID)=""
"RTN","SYNGBLLD",32,0)
 ;SNOMED
"RTN","SYNGBLLD",33,0)
 S IDX=0
"RTN","SYNGBLLD",34,0)
 F  S IDX=IDX+1,INSTRUMT=$P($T(MHSNOMED+IDX),";;",2) QUIT:INSTRUMT="zzzzz"  D
"RTN","SYNGBLLD",35,0)
 . S TESTID=$P(INSTRUMT,U,1)
"RTN","SYNGBLLD",36,0)
 . S TESTNAME=$P(INSTRUMT,U,2)
"RTN","SYNGBLLD",37,0)
 . S SNOMED=$P(INSTRUMT,U,3)
"RTN","SYNGBLLD",38,0)
 . S:(TESTID'="")&(SNOMED'="") ^SYN("2002.030","mh2sct","direct",TESTID,SNOMED)=""
"RTN","SYNGBLLD",39,0)
 . S:(TESTNAME'="")&(SNOMED'="") ^SYN("2002.030","mh2sct","direct",TESTNAME,SNOMED)=""
"RTN","SYNGBLLD",40,0)
 . S:(TESTID'="")&(SNOMED'="") ^SYN("2002.030","mh2sct","inverse",SNOMED,TESTID)=""
"RTN","SYNGBLLD",41,0)
 ;
"RTN","SYNGBLLD",42,0)
 QUIT
"RTN","SYNGBLLD",43,0)
 ;
"RTN","SYNGBLLD",44,0)
LOADCPT ;load ^SYN mapping table for SCT to CPT
"RTN","SYNGBLLD",45,0)
 N IDX,LINE,LOINC,SCT,CPT,DESC
"RTN","SYNGBLLD",46,0)
 K ^SYN("2002.030","sct2cpt")
"RTN","SYNGBLLD",47,0)
 S IDX=0
"RTN","SYNGBLLD",48,0)
 F  S IDX=IDX+1,LINE=$P($T(CPT2SCT+IDX),";;",2) QUIT:LINE="zzzzz"  D
"RTN","SYNGBLLD",49,0)
 . S CPT=$P(LINE,U,1)
"RTN","SYNGBLLD",50,0)
 . S SCT=$P(LINE,U,2)
"RTN","SYNGBLLD",51,0)
 . S DESC=$P(LINE,U,3)
"RTN","SYNGBLLD",52,0)
 . I CPT'="",SCT'="" D
"RTN","SYNGBLLD",53,0)
 . . S ^SYN("2002.030","sct2cpt","direct",SCT,CPT)=DESC
"RTN","SYNGBLLD",54,0)
 . . S ^SYN("2002.030","sct2cpt","inverse",CPT,SCT)=DESC
"RTN","SYNGBLLD",55,0)
 ;
"RTN","SYNGBLLD",56,0)
 QUIT
"RTN","SYNGBLLD",57,0)
 ;
"RTN","SYNGBLLD",58,0)
LOADHF ;load ^SYN mapping table for SCT to health factors
"RTN","SYNGBLLD",59,0)
 N IDX,LINE,SCT,HFIEN,DESC
"RTN","SYNGBLLD",60,0)
 K ^SYN("2002.030","sct2hf")
"RTN","SYNGBLLD",61,0)
 S IDX=0
"RTN","SYNGBLLD",62,0)
 F  S IDX=IDX+1,LINE=$P($T(SCT2HF+IDX),";;",2) QUIT:LINE="zzzzz"  D
"RTN","SYNGBLLD",63,0)
 . S SCT=$P(LINE,U,1)
"RTN","SYNGBLLD",64,0)
 . S HFIEN=$P(LINE,U,2)
"RTN","SYNGBLLD",65,0)
 . S DESC=$P(LINE,U,3)
"RTN","SYNGBLLD",66,0)
 . I SCT'="",HFIEN'="" D
"RTN","SYNGBLLD",67,0)
 . . S ^SYN("2002.030","sct2hf","direct",SCT,HFIEN)=DESC
"RTN","SYNGBLLD",68,0)
 . . S ^SYN("2002.030","sct2hf","inverse",HFIEN,SCT)=DESC
"RTN","SYNGBLLD",69,0)
 ;
"RTN","SYNGBLLD",70,0)
 QUIT
"RTN","SYNGBLLD",71,0)
 ;
"RTN","SYNGBLLD",72,0)
LOADVIT ;load ^SYN mapping table for SCT to health factors
"RTN","SYNGBLLD",73,0)
 ; VistA Vital Type (file 120.51)
"RTN","SYNGBLLD",74,0)
 N IDX,LINE,SCT,VITIEN,DESC
"RTN","SYNGBLLD",75,0)
 K ^SYN("2002.030","sct2vit")
"RTN","SYNGBLLD",76,0)
 S IDX=0
"RTN","SYNGBLLD",77,0)
 F  S IDX=IDX+1,LINE=$P($T(SCT2VIT+IDX),";;",2) QUIT:LINE="zzzzz"  D
"RTN","SYNGBLLD",78,0)
 . S SCT=$P(LINE,U,1)
"RTN","SYNGBLLD",79,0)
 . S VITIEN=$P(LINE,U,2)
"RTN","SYNGBLLD",80,0)
 . S DESC=$P(LINE,U,3)
"RTN","SYNGBLLD",81,0)
 . I SCT'="",VITIEN'="" D
"RTN","SYNGBLLD",82,0)
 . . S ^SYN("2002.030","sct2vit","direct",SCT,VITIEN)=DESC
"RTN","SYNGBLLD",83,0)
 . . S ^SYN("2002.030","sct2vit","inverse",VITIEN,SCT)=DESC
"RTN","SYNGBLLD",84,0)
 ;
"RTN","SYNGBLLD",85,0)
 QUIT
"RTN","SYNGBLLD",86,0)
 ;
"RTN","SYNGBLLD",87,0)
LOADPOS ;load ^SYN mapping table for care team positions
"RTN","SYNGBLLD",88,0)
 N IDX,POSITION,POSID,POSNAME,SNOMED
"RTN","SYNGBLLD",89,0)
 K ^SYN("2002.030","ctpos2sct")
"RTN","SYNGBLLD",90,0)
 S IDX=0
"RTN","SYNGBLLD",91,0)
 F  S IDX=IDX+1,POSITION=$P($T(POSSCT+IDX),";;",2) QUIT:POSITION="zzzzz"  D
"RTN","SYNGBLLD",92,0)
 . S POSID=$P(POSITION,U,1)
"RTN","SYNGBLLD",93,0)
 . S POSNAME=$P(POSITION,U,2)
"RTN","SYNGBLLD",94,0)
 . S SNOMED=$P(POSITION,U,3)
"RTN","SYNGBLLD",95,0)
 . S:(POSID'="")&(SNOMED'="") ^SYN("2002.030","ctpos2sct","direct",POSID,SNOMED)=""
"RTN","SYNGBLLD",96,0)
 . S:(POSNAME'="")&(SNOMED'="") ^SYN("2002.030","ctpos2sct","direct",POSNAME,SNOMED)=""
"RTN","SYNGBLLD",97,0)
 . S:(POSID'="")&(SNOMED'="") ^SYN("2002.030","ctpos2sct","inverse",SNOMED,POSID)=""
"RTN","SYNGBLLD",98,0)
 ;
"RTN","SYNGBLLD",99,0)
 QUIT
"RTN","SYNGBLLD",100,0)
 ;
"RTN","SYNGBLLD",101,0)
LOADFLAG ;load ^SYN mapping table for patient flags
"RTN","SYNGBLLD",102,0)
 N IDX,FLAGS,FLAGID,FLAGNAME,SNOMED
"RTN","SYNGBLLD",103,0)
 K ^SYN("2002.030","flag2sct")
"RTN","SYNGBLLD",104,0)
 S IDX=0
"RTN","SYNGBLLD",105,0)
 F  S IDX=IDX+1,FLAGS=$P($T(FLAGSCT+IDX),";;",2) QUIT:FLAGS="zzzzz"  D
"RTN","SYNGBLLD",106,0)
 . S FLAGID=$P(FLAGS,U,1)
"RTN","SYNGBLLD",107,0)
 . S FLAGNAME=$P(FLAGS,U,3)
"RTN","SYNGBLLD",108,0)
 . S SNOMED=$P(FLAGS,U,2)
"RTN","SYNGBLLD",109,0)
 . S:(FLAGID'="")&(SNOMED'="") ^SYN("2002.030","flag2sct","direct",FLAGID,SNOMED)=FLAGNAME
"RTN","SYNGBLLD",110,0)
 . S:(FLAGID'="")&(SNOMED'="") ^SYN("2002.030","flag2sct","inverse",SNOMED,FLAGID)=FLAGNAME
"RTN","SYNGBLLD",111,0)
 ;
"RTN","SYNGBLLD",112,0)
 QUIT
"RTN","SYNGBLLD",113,0)
 ;
"RTN","SYNGBLLD",114,0)
MHLOINC ; id^name^loinc
"RTN","SYNGBLLD",115,0)
 ;;5^AUDC^
"RTN","SYNGBLLD",116,0)
 ;;11^BDI2^89209-1
"RTN","SYNGBLLD",117,0)
 ;;^CESD-R^89205-9
"RTN","SYNGBLLD",118,0)
 ;;159^GAD-7^70274-6
"RTN","SYNGBLLD",119,0)
 ;;89^GDS^48544-1
"RTN","SYNGBLLD",120,0)
 ;;65^MORSE FALL SCALE^59460-6
"RTN","SYNGBLLD",121,0)
 ;;56^PC PTSD^71754-6
"RTN","SYNGBLLD",122,0)
 ;;71^PHQ-2^55758-7
"RTN","SYNGBLLD",123,0)
 ;;42^PHQ9^44249-1
"RTN","SYNGBLLD",124,0)
 ;;177^VR-12^72009-4
"RTN","SYNGBLLD",125,0)
 ;;^VR-12 T score^72017-7
"RTN","SYNGBLLD",126,0)
 ;;^Suicide Risk^89560-7
"RTN","SYNGBLLD",127,0)
 ;;^PROMIS-10 score^71970-8
"RTN","SYNGBLLD",128,0)
 ;;^PROMIS-10 T score^71969-0
"RTN","SYNGBLLD",129,0)
 ;;^PCLC^70221-7
"RTN","SYNGBLLD",130,0)
 ;;zzzzz
"RTN","SYNGBLLD",131,0)
 ;
"RTN","SYNGBLLD",132,0)
MHSNOMED ; id^name^sct^desc
"RTN","SYNGBLLD",133,0)
 ;;71^PHQ-2^454711000124102^Depression screening using Patient Health Questionnaire Two-Item score (procedure)
"RTN","SYNGBLLD",134,0)
 ;;42^PHQ9^715252007^Depression screening using Patient Health Questionnaire Nine Item score (procedure)
"RTN","SYNGBLLD",135,0)
 ;;zzzzz
"RTN","SYNGBLLD",136,0)
 ;
"RTN","SYNGBLLD",137,0)
CPT2SCT ; cpt^sct^cpt desc
"RTN","SYNGBLLD",138,0)
 ;;10060^428297005^Excision of Cyst
"RTN","SYNGBLLD",139,0)
 ;;11000^19780006^Debridement of Infection of Skin
"RTN","SYNGBLLD",140,0)
 ;;20225^56241004^Bone Marrow Biopsy
"RTN","SYNGBLLD",141,0)
 ;;27299^28181007^Operation on hip joint
"RTN","SYNGBLLD",142,0)
 ;;44391^73761001^Colonoscopy
"RTN","SYNGBLLD",143,0)
 ;;47562^45595009^Laparoscopic cholecystectomy
"RTN","SYNGBLLD",144,0)
 ;;49315^80146002^Appendectomy
"RTN","SYNGBLLD",145,0)
 ;;55250^22523008^Vasectomy
"RTN","SYNGBLLD",146,0)
 ;;64721^10431008^Neuroplasty of median nerve at carpal tunnel
"RTN","SYNGBLLD",147,0)
 ;;77056^71388002^Mammogram Both Breasts
"RTN","SYNGBLLD",148,0)
 ;;99201^185347001^Office/outpatient visit new
"RTN","SYNGBLLD",149,0)
 ;;99202^185349003^Office/outpatient visit new
"RTN","SYNGBLLD",150,0)
 ;;99205^308335008^Office/outpatient visit new
"RTN","SYNGBLLD",151,0)
 ;;99213^185345009^Office/outpatient visit est
"RTN","SYNGBLLD",152,0)
 ;;99238^308646001^Hospital discharge day
"RTN","SYNGBLLD",153,0)
 ;;99241^394701000^Office consultation
"RTN","SYNGBLLD",154,0)
 ;;99281^50849002^Emergency dept visit
"RTN","SYNGBLLD",155,0)
 ;;99285^4525004^Emergency dept visit
"RTN","SYNGBLLD",156,0)
 ;;99381^183478001^INIT PM E/M NEW PAT INF
"RTN","SYNGBLLD",157,0)
 ;;99383^170258001^PREV VISIT NEW AGE 5-11
"RTN","SYNGBLLD",158,0)
 ;;99408^105355005^
"RTN","SYNGBLLD",159,0)
 ;;59426^424441002^
"RTN","SYNGBLLD",160,0)
 ;;99218^183460006^
"RTN","SYNGBLLD",161,0)
 ;;59425^424619006^
"RTN","SYNGBLLD",162,0)
 ;;55810^10492003^
"RTN","SYNGBLLD",163,0)
 ;;77427^84755001^
"RTN","SYNGBLLD",164,0)
 ;;59400^10745001^
"RTN","SYNGBLLD",165,0)
 ;;66840^10178000^
"RTN","SYNGBLLD",166,0)
 ;;44388^12350003^
"RTN","SYNGBLLD",167,0)
 ;;27130^15163009^
"RTN","SYNGBLLD",168,0)
 ;;59409^177184002^
"RTN","SYNGBLLD",169,0)
 ;;27447^179344006^
"RTN","SYNGBLLD",170,0)
 ;;65235^13767004^
"RTN","SYNGBLLD",171,0)
 ;;90937^108241001^
"RTN","SYNGBLLD",172,0)
 ;;90653^442333005^
"RTN","SYNGBLLD",173,0)
 ;;45378^444783004^
"RTN","SYNGBLLD",174,0)
 ;;D1206^234723000^
"RTN","SYNGBLLD",175,0)
 ;;zzzzz
"RTN","SYNGBLLD",176,0)
 ;;10120^^Remove foreign body
"RTN","SYNGBLLD",177,0)
 ;;99211^^Office/outpatient visit established
"RTN","SYNGBLLD",178,0)
 ;
"RTN","SYNGBLLD",179,0)
SCT2HF ; sct^hf ien^desc
"RTN","SYNGBLLD",180,0)
 ;;266919005^5^Never smoked tobacco
"RTN","SYNGBLLD",181,0)
 ;;405746006^2^Current non-smoker
"RTN","SYNGBLLD",182,0)
 ;;8517006^4^Ex-smoker
"RTN","SYNGBLLD",183,0)
 ;;266890009^15^Family History of Alcoholism
"RTN","SYNGBLLD",184,0)
 ;;219006^12^Current drinker of alcohol
"RTN","SYNGBLLD",185,0)
 ;;371434005^13^History of alcohol abuse
"RTN","SYNGBLLD",186,0)
 ;;zzzzz
"RTN","SYNGBLLD",187,0)
 ;
"RTN","SYNGBLLD",188,0)
SCT2VIT ; sct^vital ien^desc  (VistA Vital Type (file 120.51))
"RTN","SYNGBLLD",189,0)
 ;;27113001^9^Body weight
"RTN","SYNGBLLD",190,0)
 ;;50373000^8^Body height
"RTN","SYNGBLLD",191,0)
 ;;75367002^1^Blood pressure
"RTN","SYNGBLLD",192,0)
 ;;78564009^5^Pulse rate
"RTN","SYNGBLLD",193,0)
 ;;386725007^2^Body Temperature
"RTN","SYNGBLLD",194,0)
 ;;86290005^3^Respiration
"RTN","SYNGBLLD",195,0)
 ;;48094003^10^Abdominal girth measurement
"RTN","SYNGBLLD",196,0)
 ;;21727005^11^Audiometry
"RTN","SYNGBLLD",197,0)
 ;;252465000^21^Pulse oximetry
"RTN","SYNGBLLD",198,0)
 ;;22253000^22^Pain
"RTN","SYNGBLLD",199,0)
 ;;zzzzz
"RTN","SYNGBLLD",200,0)
 ;
"RTN","SYNGBLLD",201,0)
POSSCT ; id^name^sct
"RTN","SYNGBLLD",202,0)
 ;;45^ADDICTION THERAPIST^
"RTN","SYNGBLLD",203,0)
 ;;46^ADDICTION THERAPIST (MHTC)^
"RTN","SYNGBLLD",204,0)
 ;;13^ADMIN COORDINATOR^106331006
"RTN","SYNGBLLD",205,0)
 ;;56^ADMINISTRATIVE ASSOCIATE^224608005
"RTN","SYNGBLLD",206,0)
 ;;58^ADVANCE PRACTICE ASSOCIATE PROVIDER^
"RTN","SYNGBLLD",207,0)
 ;;71^ADVANCE PRACTICE NURSE^
"RTN","SYNGBLLD",208,0)
 ;;72^ADVANCE PRACTICE NURSE (MHTC)^
"RTN","SYNGBLLD",209,0)
 ;;57^ANTICOAG CLINICAL PHARMACIST^
"RTN","SYNGBLLD",210,0)
 ;;59^ASSOCIATE PROVIDER^
"RTN","SYNGBLLD",211,0)
 ;;26^CARE MANAGER^184154008
"RTN","SYNGBLLD",212,0)
 ;;28^CASE MANAGER^768832004^nurse case manager 445451001
"RTN","SYNGBLLD",213,0)
 ;;43^CHAPLAIN^225725005
"RTN","SYNGBLLD",214,0)
 ;;44^CHAPLAIN (MHTC)^225725005
"RTN","SYNGBLLD",215,0)
 ;;60^CLINICAL ASSOCIATE^
"RTN","SYNGBLLD",216,0)
 ;;22^CLINICAL NURSE SPECIALIST^
"RTN","SYNGBLLD",217,0)
 ;;37^CLINICAL NURSE SPECIALIST (MHTC)^
"RTN","SYNGBLLD",218,0)
 ;;8^CLINICAL PHARMACIST^734293001
"RTN","SYNGBLLD",219,0)
 ;;38^CLINICAL PHARMACIST (MHTC)^734293001
"RTN","SYNGBLLD",220,0)
 ;;30^DESIGNATED WOMEN'S HEALTH PROVIDER
"RTN","SYNGBLLD",221,0)
 ;;61^FELLOW^
"RTN","SYNGBLLD",222,0)
 ;;27^HEALTH TECHNICIAN^
"RTN","SYNGBLLD",223,0)
 ;;17^INTERN (PHYSICIAN)^
"RTN","SYNGBLLD",224,0)
 ;;73^LEAD COORDINATOR^76882100
"RTN","SYNGBLLD",225,0)
 ;;39^LPC^
"RTN","SYNGBLLD",226,0)
 ;;40^LPC (MHTC)^
"RTN","SYNGBLLD",227,0)
 ;;19^MAS CLERK^
"RTN","SYNGBLLD",228,0)
 ;;18^MEDICAL STUDENT^398130009
"RTN","SYNGBLLD",229,0)
 ;;41^MFT^
"RTN","SYNGBLLD",230,0)
 ;;42^MFT (MHTC)^
"RTN","SYNGBLLD",231,0)
 ;;7^NURSE (LPN)^442251000124100
"RTN","SYNGBLLD",232,0)
 ;;62^NURSE (LVN)^
"RTN","SYNGBLLD",233,0)
 ;;6^NURSE (RN)^224535009
"RTN","SYNGBLLD",234,0)
 ;;47^NURSE (RN) (MHTC)^224563006
"RTN","SYNGBLLD",235,0)
 ;;4^NURSE PRACTITIONER^224571005
"RTN","SYNGBLLD",236,0)
 ;;35^NURSE PRACTITIONER (MHTC)^224571005
"RTN","SYNGBLLD",237,0)
 ;;63^NURSE PRACTITIONER ASSOCIATE PROVIDER^
"RTN","SYNGBLLD",238,0)
 ;;48^OCCUPATIONAL THERAPIST^80546007
"RTN","SYNGBLLD",239,0)
 ;;49^OCCUPATIONAL THERAPIST (MHTC)^80546007
"RTN","SYNGBLLD",240,0)
 ;;15^OTHER^
"RTN","SYNGBLLD",241,0)
 ;;21^PACT CLINICAL PHARMACIST^734293001
"RTN","SYNGBLLD",242,0)
 ;;14^PATIENT SERVICES ASSISTANT^
"RTN","SYNGBLLD",243,0)
 ;;64^PEER SUPPORT APPRENTICE^
"RTN","SYNGBLLD",244,0)
 ;;65^PEER SUPPORT SPECIALIST^
"RTN","SYNGBLLD",245,0)
 ;;74^PEER SUPPORT SPECIALIST (MHTC)^
"RTN","SYNGBLLD",246,0)
 ;;55^PEER SUPPORT STAFF^
"RTN","SYNGBLLD",247,0)
 ;;5^PHYSICIAN ASSISTANT^449161006
"RTN","SYNGBLLD",248,0)
 ;;36^PHYSICIAN ASSISTANT (MHTC)^449161006
"RTN","SYNGBLLD",249,0)
 ;;66^PHYSICIAN ASSISTANT ASSOCIATE PROVIDER^
"RTN","SYNGBLLD",250,0)
 ;;1^PHYSICIAN-ATTENDING^405279007
"RTN","SYNGBLLD",251,0)
 ;;2^PHYSICIAN-PRIMARY CARE^446050000
"RTN","SYNGBLLD",252,0)
 ;;10^PHYSICIAN-PSYCHIATRIST^80584001
"RTN","SYNGBLLD",253,0)
 ;;34^PHYSICIAN-PSYCHIATRIST (MHTC)^80584001
"RTN","SYNGBLLD",254,0)
 ;;3^PHYSICIAN-SUBSPECIALTY^
"RTN","SYNGBLLD",255,0)
 ;;67^PRIMARY CARE PROVIDER^453231000124104
"RTN","SYNGBLLD",256,0)
 ;;11^PSYCHOLOGIST^59944000
"RTN","SYNGBLLD",257,0)
 ;;31^PSYCHOLOGIST (MHTC)^59944000
"RTN","SYNGBLLD",258,0)
 ;;53^RECREATION THERAPIST^
"RTN","SYNGBLLD",259,0)
 ;;54^RECREATION THERAPIST (MHTC)^
"RTN","SYNGBLLD",260,0)
 ;;20^REGISTERED DIETITIAN^309399009
"RTN","SYNGBLLD",261,0)
 ;;12^REHAB/PSYCH TECHNICIAN^
"RTN","SYNGBLLD",262,0)
 ;;33^REHAB/PSYCH TECHNICIAN (MHTC)^
"RTN","SYNGBLLD",263,0)
 ;;16^RESIDENT (PHYSICIAN)^309360001
"RTN","SYNGBLLD",264,0)
 ;;9^SOCIAL WORKER^158950001
"RTN","SYNGBLLD",265,0)
 ;;32^SOCIAL WORKER (MHTC)^80292009
"RTN","SYNGBLLD",266,0)
 ;;68^SURROGATE CARE MANAGER^184154008
"RTN","SYNGBLLD",267,0)
 ;;70^SURROGATE CLINICAL ASSOCIATE^
"RTN","SYNGBLLD",268,0)
 ;;69^SURROGATE PRIMARY CARE PROVIDER^453231000124104
"RTN","SYNGBLLD",269,0)
 ;;25^TCM CLINICAL CASE MANAGER^
"RTN","SYNGBLLD",270,0)
 ;;24^TCM PROGRAM MANAGER^
"RTN","SYNGBLLD",271,0)
 ;;23^TCM TRANSITION PATIENT ADVOCATE^
"RTN","SYNGBLLD",272,0)
 ;;29^TRAINEE^
"RTN","SYNGBLLD",273,0)
 ;;50^VOC REHAB SPEC/COUNSELOR^
"RTN","SYNGBLLD",274,0)
 ;;51^VOC REHAB SPEC/COUNSELOR (MHTC)^
"RTN","SYNGBLLD",275,0)
 ;;zzzzz
"RTN","SYNGBLLD",276,0)
 ;
"RTN","SYNGBLLD",277,0)
FLAGSCT ;
"RTN","SYNGBLLD",278,0)
 ;;FALL RISK^129839007^Fall Risk
"RTN","SYNGBLLD",279,0)
 ;;WANDERER^704448006^Wanderer
"RTN","SYNGBLLD",280,0)
 ;;BEHAVIORAL^277843001^Behavioral
"RTN","SYNGBLLD",281,0)
 ;;HIGH RISK FOR SUICIDE^394685004^High risk for suicide
"RTN","SYNGBLLD",282,0)
 ;;zzzzz
"RTN","SYNGBLLD",283,0)
 ;
"RTN","SYNGBLLD",284,0)
LOADREF(MH2LOINC,LOINC2MH,MH2SNOMED) ;load temp code arrays
"RTN","SYNGBLLD",285,0)
 N IDX,INSTRU,LOINCODE,TESTID,TESTNAME,LOINC
"RTN","SYNGBLLD",286,0)
 ;LOINC
"RTN","SYNGBLLD",287,0)
 S IDX=0
"RTN","SYNGBLLD",288,0)
 F  S IDX=IDX+1,INSTRUMT=$P($T(LOINC+IDX),";;",2) Q:INSTRUMT="zzzzz"  D
"RTN","SYNGBLLD",289,0)
 . S TESTID=$P(INSTRUMT,U,1)
"RTN","SYNGBLLD",290,0)
 . S TESTNAME=$P(INSTRUMT,U,2)
"RTN","SYNGBLLD",291,0)
 . S LOINC=$P(INSTRUMT,U,3)
"RTN","SYNGBLLD",292,0)
 . S:TESTID'="" MH2LOINC(TESTID)=LOINC
"RTN","SYNGBLLD",293,0)
 . S:TESTNAME'="" MH2LOINC(TESTNAME)=LOINC
"RTN","SYNGBLLD",294,0)
 . S:LOINC'="" LOINC2MH(LOINC)=TESTID_U_TESTNAME
"RTN","SYNGBLLD",295,0)
 ;SNOMED
"RTN","SYNGBLLD",296,0)
 S IDX=0
"RTN","SYNGBLLD",297,0)
 F  S IDX=IDX+1,INSTRUMT=$P($T(SNOMED+IDX),";;",2) Q:INSTRUMT="zzzzz"  D
"RTN","SYNGBLLD",298,0)
 . S TESTID=$P(INSTRUMT,U,1)
"RTN","SYNGBLLD",299,0)
 . S TESTNAME=$P(INSTRUMT,U,2)
"RTN","SYNGBLLD",300,0)
 . S SNOMED=$P(INSTRUMT,U,3)
"RTN","SYNGBLLD",301,0)
 . S:TESTID'="" MH2SNOMED(TESTID)=SNOMED
"RTN","SYNGBLLD",302,0)
 . S:TESTNAME'="" MH2SNOMED(TESTNAME)=SNOMED
"RTN","SYNGBLLD",303,0)
 ;
"RTN","SYNGBLLD",304,0)
 QUIT
"RTN","SYNGBLLD",305,0)
 ;
"RTN","SYNGBLLD",306,0)
PRCSCT ; CPT to SNOMED CT map for procedures
"RTN","SYNGBLLD",307,0)
 K SCTA,SCTX
"RTN","SYNGBLLD",308,0)
 S SCTA(308335008)="99205^OFFICE VISIT"
"RTN","SYNGBLLD",309,0)
 S SCTA(428297005)="10060^Excision of Cyst"
"RTN","SYNGBLLD",310,0)
 S SCTA(22523008)="55250^Vasectomy"
"RTN","SYNGBLLD",311,0)
 S SCTA(73761001)="44391^Colonoscopy"
"RTN","SYNGBLLD",312,0)
 S SCTA(56241004)="20225^Bone Marrow Biopsy"
"RTN","SYNGBLLD",313,0)
 S SCTA(10431008)="64721^Neuroplasty of median nerve at carpal tunnel"
"RTN","SYNGBLLD",314,0)
 S SCTA(28181007)="27299^Operation on hip joint"
"RTN","SYNGBLLD",315,0)
 S SCTA(80146002)="49315^Appendectomy"
"RTN","SYNGBLLD",316,0)
 S SCTA(19780006)="11000^Debridement of Infection of Skin"
"RTN","SYNGBLLD",317,0)
 S SCTA(45595009)="47562^Laparoscopic cholecystectomy"
"RTN","SYNGBLLD",318,0)
 ; map incoming SNOMED CT code to VistA Vital Type (file 120.51)
"RTN","SYNGBLLD",319,0)
 S SCTX("10060")="428297005^Excision of Cyst"
"RTN","SYNGBLLD",320,0)
 S SCTX("20225")="56241004^Bone Marrow Biopsy"
"RTN","SYNGBLLD",321,0)
 S SCTX("27299")="28181007^Operation on hip joint"
"RTN","SYNGBLLD",322,0)
 S SCTX("44391")="73761001^Colonoscopy"
"RTN","SYNGBLLD",323,0)
 S SCTX("49315")="80146002^Appendectomy"
"RTN","SYNGBLLD",324,0)
 S SCTX("55250")="22523008^Vasectomy"
"RTN","SYNGBLLD",325,0)
 S SCTX("64721")="10431008^Neuroplasty of median nerve at carpal tunnel"
"RTN","SYNGBLLD",326,0)
 S SCTX("11000")="19780006^Debridement of Infection of Skin"
"RTN","SYNGBLLD",327,0)
 S SCTX("47562")="45595009^Laparoscopic cholecystectomy"
"RTN","SYNGBLLD",328,0)
 Q
"RTN","SYNGBLLD",329,0)
 ; 
"RTN","SYNGBLLD",330,0)
HLFSCT ; SNOMED CT MAP for health factors
"RTN","SYNGBLLD",331,0)
 K SCTA,SCTX
"RTN","SYNGBLLD",332,0)
 S SCTA(266919005)="5^Never smoked tobacco"
"RTN","SYNGBLLD",333,0)
 S SCTA(405746006)="2^Current non-smoker"
"RTN","SYNGBLLD",334,0)
 S SCTA(8517006)="4^Ex-smoker"
"RTN","SYNGBLLD",335,0)
 S SCTA(266890009)="15^Family History of Alcoholism"
"RTN","SYNGBLLD",336,0)
 S SCTA(219006)="12^Current drinker of alcohol"
"RTN","SYNGBLLD",337,0)
 S SCTA(371434005)="13^History of alcohol abuse"
"RTN","SYNGBLLD",338,0)
 ; map incoming SNOMED CT code to VistA Vital Type (file 120.51)
"RTN","SYNGBLLD",339,0)
 S SCTX("5")="266919005^Never smoked tobacco"
"RTN","SYNGBLLD",340,0)
 S SCTX("2")="405746006^Current non-smoker"
"RTN","SYNGBLLD",341,0)
 S SCTX("4")="8517006^Ex-smoker"
"RTN","SYNGBLLD",342,0)
 S SCTX("15")="266890009^Family History of Alcoholism"
"RTN","SYNGBLLD",343,0)
 S SCTX("13")="371434005^History of Alcoholism"
"RTN","SYNGBLLD",344,0)
 S SCTX("12")="219009^Current drinker of alcohol"
"RTN","SYNGBLLD",345,0)
 Q 
"RTN","SYNGBLLD",346,0)
 ;
"RTN","SYNGRAPH")
0^42^B20344027
"RTN","SYNGRAPH",1,0)
SYNFGRAPH       ;ven/gpl - fhir loader utilities ;2018-08-17  3:26 PM
"RTN","SYNGRAPH",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNGRAPH",3,0)
 ;
"RTN","SYNGRAPH",4,0)
 ; Authored by George P. Lilly 2017-2018
"RTN","SYNGRAPH",5,0)
 ;
"RTN","SYNGRAPH",6,0)
 q
"RTN","SYNGRAPH",7,0)
 ;
"RTN","SYNGRAPH",8,0)
index(graph) ; will create a pos and ops index at the place pointed to by graph
"RTN","SYNGRAPH",9,0)
 ; graph is passed by name
"RTN","SYNGRAPH",10,0)
 ;
"RTN","SYNGRAPH",11,0)
 i $d(@graph@("pos")) k @graph@("pos")
"RTN","SYNGRAPH",12,0)
 i $d(@graph@("ops")) k @graph@("ops")
"RTN","SYNGRAPH",13,0)
 n zi s zi=0
"RTN","SYNGRAPH",14,0)
 f  s zi=$o(@graph@(zi)) q:+zi=0  d  ;
"RTN","SYNGRAPH",15,0)
 . n zj,zv
"RTN","SYNGRAPH",16,0)
 . s zj=""
"RTN","SYNGRAPH",17,0)
 . f  s zj=$o(@graph@(zi,zj)) q:zj=""  d  ;
"RTN","SYNGRAPH",18,0)
 . . s zv=$g(@graph@(zi,zj))
"RTN","SYNGRAPH",19,0)
 . . q:zv=""
"RTN","SYNGRAPH",20,0)
 . . s @graph@("pos",zj,zv,zi)=""
"RTN","SYNGRAPH",21,0)
 . . s @graph@("ops",zv,zj,zi)=""
"RTN","SYNGRAPH",22,0)
 q
"RTN","SYNGRAPH",23,0)
 ;
"RTN","SYNGRAPH",24,0)
graphmap(graph,code,otype,itype) ; extrinsic mapping function using a graph
"RTN","SYNGRAPH",25,0)
 ; graph is a pointer to the graph passed by name
"RTN","SYNGRAPH",26,0)
 ; code is the subject to map
"RTN","SYNGRAPH",27,0)
 ; otype is the predicate for the result
"RTN","SYNGRAPH",28,0)
 ; itype is the predicate for the subject (optional)
"RTN","SYNGRAPH",29,0)
 ;
"RTN","SYNGRAPH",30,0)
 ;i '$d(@graph@("pos")) d  ;
"RTN","SYNGRAPH",31,0)
 i $e(graph,1,1)'="^" d  ;
"RTN","SYNGRAPH",32,0)
 . n root s root=$$setroot^%wd(graph)
"RTN","SYNGRAPH",33,0)
 . s graph=$g(@root@("index","root"))
"RTN","SYNGRAPH",34,0)
 i $g(graph)="" q "-1^Error, can't find graph"
"RTN","SYNGRAPH",35,0)
 i '$d(@graph@("pos")) q "-1^Error, can't find index"
"RTN","SYNGRAPH",36,0)
 n gien,ipred,opred
"RTN","SYNGRAPH",37,0)
 s ipred=$g(itype)
"RTN","SYNGRAPH",38,0)
 i ipred="" s ipred=$o(@graph@("ops",code,""))
"RTN","SYNGRAPH",39,0)
 ;w !,"ipred= "_ipred
"RTN","SYNGRAPH",40,0)
 i ipred="" q "-1^Code not found"
"RTN","SYNGRAPH",41,0)
 s gien=$o(@graph@("ops",code,ipred,""))
"RTN","SYNGRAPH",42,0)
 ;w !,"gien= "_gien,!
"RTN","SYNGRAPH",43,0)
 ;zwrite @graph@(gien,*)
"RTN","SYNGRAPH",44,0)
 ;w !,graph
"RTN","SYNGRAPH",45,0)
 s opred=$g(otype)
"RTN","SYNGRAPH",46,0)
 i opred="" s opred=$o(@graph@(gien,ipred))
"RTN","SYNGRAPH",47,0)
 i opred="" s opred=$o(@graph@(gien,ipred),-1)
"RTN","SYNGRAPH",48,0)
 ;w !,"opred= "_opred
"RTN","SYNGRAPH",49,0)
 q $g(@graph@(gien,opred))
"RTN","SYNGRAPH",50,0)
 ;
"RTN","SYNGRAPH",51,0)
 s gien=$o(@graph@("ops"))
"RTN","SYNGRAPH",52,0)
 n ugraph s ugraph=""
"RTN","SYNGRAPH",53,0)
 i '$d(@graph@("pos")) d  ; fix the pointer
"RTN","SYNGRAPH",54,0)
 . i $d(@graph@("graph","pos")) s ugraph=$na(@graph@("graph"))
"RTN","SYNGRAPH",55,0)
 . n graphname s graphname=$o(@graph@("graph",""))
"RTN","SYNGRAPH",56,0)
 . i graphname="" s ugraph="" q  ; don't understand this graph
"RTN","SYNGRAPH",57,0)
 . i $d(@graph@("graph",graphname,"pos")) s ugraph=$na(@graph@("graph",graphname))
"RTN","SYNGRAPH",58,0)
 q
"RTN","SYNGRAPH",59,0)
 ;
"RTN","SYNGRAPH",60,0)
getGraphMap(rtn,graph,ipred,iobj,opred,oobj) ; retrieve a section of the graph
"RTN","SYNGRAPH",61,0)
 ; extrinsic return 1 on success and -1 on failure
"RTN","SYNGRAPH",62,0)
 ; identified by predicate ipred with object iobj
"RTN","SYNGRAPH",63,0)
 ; if opred (output predicate) and/or oobj (output object) are specified,
"RTN","SYNGRAPH",64,0)
 ;  they are treated and a "and" condition on the retrieval
"RTN","SYNGRAPH",65,0)
 ;
"RTN","SYNGRAPH",66,0)
 n root s root=$$setroot^%wd(graph)
"RTN","SYNGRAPH",67,0)
 n groot s groot=$g(@root@("index","root"))
"RTN","SYNGRAPH",68,0)
 i groot="" q "-1^can't find graph root"
"RTN","SYNGRAPH",69,0)
 i '$d(@groot@("pos")) q "-1^can't find graph index"
"RTN","SYNGRAPH",70,0)
 k @rtn
"RTN","SYNGRAPH",71,0)
 ;
"RTN","SYNGRAPH",72,0)
 n gien
"RTN","SYNGRAPH",73,0)
 i $g(iobj)'="" i $o(@groot@("ops",iobj,""))'="" d  ;
"RTN","SYNGRAPH",74,0)
 . i $g(ipred)'="" d  q  ;
"RTN","SYNGRAPH",75,0)
 . . s gien=$o(@groot@("pos",ipred,iobj,""))
"RTN","SYNGRAPH",76,0)
 . . m @rtn=@groot@(gien)
"RTN","SYNGRAPH",77,0)
 . n tpred
"RTN","SYNGRAPH",78,0)
 . s tpred=$o(@groot@("ops",iobj,""))
"RTN","SYNGRAPH",79,0)
 . s gien=$o(@groot@("pos",tpred,iobj,""))
"RTN","SYNGRAPH",80,0)
 . m @rtn=@groot@(gien)
"RTN","SYNGRAPH",81,0)
 i $d(@rtn) q 1
"RTN","SYNGRAPH",82,0)
 q "-1^No Match"
"RTN","SYNGRAPH",83,0)
 ;
"RTN","SYNGRAPH",84,0)
getGraph(url,gname) ; get a graph from a web service
"RTN","SYNGRAPH",85,0)
 ;
"RTN","SYNGRAPH",86,0)
 q:'$d(gname)
"RTN","SYNGRAPH",87,0)
 i $$rootOf^%wd(gname)'=-1 d  q  ;
"RTN","SYNGRAPH",88,0)
 . w !,"error, graph exists: "_gname
"RTN","SYNGRAPH",89,0)
 n root s root=$$setroot^%wd(gname)
"RTN","SYNGRAPH",90,0)
 n %,json,grf
"RTN","SYNGRAPH",91,0)
 s %=$$%^%WC(.json,"GET",url)
"RTN","SYNGRAPH",92,0)
 w !,"result= ",%
"RTN","SYNGRAPH",93,0)
 i '$d(json) d  q  ;
"RTN","SYNGRAPH",94,0)
 . w !,"error, nothing returned"
"RTN","SYNGRAPH",95,0)
 d DECODE^VPRJSON("json","grf")
"RTN","SYNGRAPH",96,0)
 m @root=grf
"RTN","SYNGRAPH",97,0)
 n indx,rindx
"RTN","SYNGRAPH",98,0)
 s indx=$o(@root@(0))
"RTN","SYNGRAPH",99,0)
 s rindx=$na(@root@(indx))
"RTN","SYNGRAPH",100,0)
 s @root@("index","root")=rindx
"RTN","SYNGRAPH",101,0)
 d index(rindx)
"RTN","SYNGRAPH",102,0)
 q
"RTN","SYNGRAPH",103,0)
 ;
"RTN","SYNGRAPH",104,0)
wsGetGraph(RTN,FILTER) ; web service returns the requested graph FILTER("graph")="graph"
"RTN","SYNGRAPH",105,0)
 ; this is the server side of getGraph above
"RTN","SYNGRAPH",106,0)
 n graph s graph=$g(FILTER("graph"))
"RTN","SYNGRAPH",107,0)
 i graph="" d  q  ;
"RTN","SYNGRAPH",108,0)
 . s RTN="-1^please specify a graph"
"RTN","SYNGRAPH",109,0)
 ;n root s root=$$rootOf^%wd(graph)
"RTN","SYNGRAPH",110,0)
 n root s root=$$setroot^%wd(graph)
"RTN","SYNGRAPH",111,0)
 i +root=-1 d  q  ;
"RTN","SYNGRAPH",112,0)
 . s RTN="-1^graph not found"
"RTN","SYNGRAPH",113,0)
 ;
"RTN","SYNGRAPH",114,0)
 ;n json
"RTN","SYNGRAPH",115,0)
 ;s json=$$setroot^%wd(graph_"-json")
"RTN","SYNGRAPH",116,0)
 ;i +json'=-1 s RTN=json q  ;
"RTN","SYNGRAPH",117,0)
 ;s json=$$setroot^%wd(graph_"-json")
"RTN","SYNGRAPH",118,0)
 S RTN=$na(^TMP("SYNOUT",$J))
"RTN","SYNGRAPH",119,0)
 K @RTN
"RTN","SYNGRAPH",120,0)
 d ENCODE^VPRJSON(root,RTN)
"RTN","SYNGRAPH",121,0)
 q
"RTN","SYNGRAPH",122,0)
 ;
"RTN","SYNGRAPH",123,0)
loincMap() ; create the lonic-lab-map
"RTN","SYNGRAPH",124,0)
 n root s root=$$setroot^%wd("loinc-lab-map")
"RTN","SYNGRAPH",125,0)
 k @root
"RTN","SYNGRAPH",126,0)
 n src s src=$$rootOf^%wd("loinc-code-map")
"RTN","SYNGRAPH",127,0)
 s src=$na(@src@("loinc-codes-map-1.csv"))
"RTN","SYNGRAPH",128,0)
 n zi s zi=0
"RTN","SYNGRAPH",129,0)
 f  s zi=$o(@src@(zi)) q:+zi=0  d  ;
"RTN","SYNGRAPH",130,0)
 . n zj s zj=""
"RTN","SYNGRAPH",131,0)
 . f  s zj=$o(@src@(zi,zj)) q:zj=""  d  ;
"RTN","SYNGRAPH",132,0)
 . . n zt s zt=$$TRIM^XLFSTR(@src@(zi,zj))
"RTN","SYNGRAPH",133,0)
 . . q:zt=""
"RTN","SYNGRAPH",134,0)
 . . s @root@("graph","map",zi,zj)=zt
"RTN","SYNGRAPH",135,0)
 s rindx=$na(@root@("graph","map"))
"RTN","SYNGRAPH",136,0)
 s @root@("index","root")=rindx
"RTN","SYNGRAPH",137,0)
 d index(rindx)
"RTN","SYNGRAPH",138,0)
 q
"RTN","SYNGRAPH",139,0)
 ;
"RTN","SYNINIT")
0^43^B143229486
"RTN","SYNINIT",1,0)
SYNINIT ;OSEHRA/SMH - Initilization Code for Synthetic Data Loader;May 23 2018
"RTN","SYNINIT",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNINIT",3,0)
 ;
"RTN","SYNINIT",4,0)
 ; (c) Sam Habiel 2018
"RTN","SYNINIT",5,0)
 ; Licensed under Apache 2.0.
"RTN","SYNINIT",6,0)
 ;
"RTN","SYNINIT",7,0)
EN ; [Public; called by KIDS; do everything in this file]
"RTN","SYNINIT",8,0)
 D LOADHAND
"RTN","SYNINIT",9,0)
 D MES^XPDUTL("")
"RTN","SYNINIT",10,0)
 D MES^XPDUTL("Syn Patients Importer Init")
"RTN","SYNINIT",11,0)
 D MES^XPDUTL("Provider "_$$PROV())
"RTN","SYNINIT",12,0)
 D MES^XPDUTL("Pharmacist "_$$PHARM())
"RTN","SYNINIT",13,0)
 D MES^XPDUTL("Hospital Location "_$$HL())
"RTN","SYNINIT",14,0)
 D MES^XPDUTL("Fixing AMIE thingy") D AMIE
"RTN","SYNINIT",15,0)
 D MES^XPDUTL("Fixing IB ACTION TYPE file") D IBACTION
"RTN","SYNINIT",16,0)
 D MES^XPDUTL("Setting up Outpatient Pharmacy "_$$PHRSS())
"RTN","SYNINIT",17,0)
 QUIT
"RTN","SYNINIT",18,0)
 ;
"RTN","SYNINIT",19,0)
 ; NUMBER: 10                              HTTP VERB: POST                         URI: addcondition
"RTN","SYNINIT",20,0)
 ; EXECUTION ENDPOINT: wsIntakeConditions^SYNFCON
"RTN","SYNINIT",21,0)
 ;
"RTN","SYNINIT",22,0)
LOADHAND ; [Public] Load URL handlers
"RTN","SYNINIT",23,0)
 W !!,"LOADING URL HANDLERS",!
"RTN","SYNINIT",24,0)
 N I,IEN F I=1:1 N LN S LN=$P($T(LH+I),";;",2,99) Q:LN=""  D  ; Read inline
"RTN","SYNINIT",25,0)
 . N NREF S NREF=$P(LN,"=") ; variable name reference
"RTN","SYNINIT",26,0)
 . I $E(NREF)="^" S NREF=$NA(@NREF) ; convert IEN to actual value
"RTN","SYNINIT",27,0)
 . N TESTNODE S TESTNODE="" ; for $DATA testing
"RTN","SYNINIT",28,0)
 . I $QS(NREF,2)="B" S TESTNODE=$NA(@NREF,5) ; Get all subs b4 IEN
"RTN","SYNINIT",29,0)
 . I $L(TESTNODE),$D(@TESTNODE) DO  QUIT  ; If node exists in B index
"RTN","SYNINIT",30,0)
 . . WRITE TESTNODE_" ALREADY INSTALLED",!  ; say so
"RTN","SYNINIT",31,0)
 . . KILL ^%W(17.6001,IEN) ; and delete the stuff we entered
"RTN","SYNINIT",32,0)
 . S @LN  ; okay to set.
"RTN","SYNINIT",33,0)
 QUIT
"RTN","SYNINIT",34,0)
LH ;; START
"RTN","SYNINIT",35,0)
 ;;IEN=$O(^%W(17.6001," "),-1)+1
"RTN","SYNINIT",36,0)
 ;;^%W(17.6001,IEN,0)="POST"
"RTN","SYNINIT",37,0)
 ;;^%W(17.6001,IEN,1)="addpatient/*"
"RTN","SYNINIT",38,0)
 ;;^%W(17.6001,IEN,2)="wsPostFHIR^SYNFHIR"
"RTN","SYNINIT",39,0)
 ;;^%W(17.6001,"B","POST","addpatient/*","wsPostFHIR^SYNFHIR",IEN)=""
"RTN","SYNINIT",40,0)
 ;;IEN=IEN+1
"RTN","SYNINIT",41,0)
 ;;^%W(17.6001,IEN,0)="GET"
"RTN","SYNINIT",42,0)
 ;;^%W(17.6001,IEN,1)="showfhir/*"
"RTN","SYNINIT",43,0)
 ;;^%W(17.6001,IEN,2)="wsShow^SYNFHIR"
"RTN","SYNINIT",44,0)
 ;;^%W(17.6001,"B","GET","showfhir/*","wsShow^SYNFHIR",IEN)=""
"RTN","SYNINIT",45,0)
 ;;IEN=IEN+1
"RTN","SYNINIT",46,0)
 ;;^%W(17.6001,IEN,0)="GET"
"RTN","SYNINIT",47,0)
 ;;^%W(17.6001,IEN,1)="vpr/*"
"RTN","SYNINIT",48,0)
 ;;^%W(17.6001,IEN,2)="wsVPR^SYNVPR"
"RTN","SYNINIT",49,0)
 ;;^%W(17.6001,"B","GET","vpr/*","wsVPR^SYNVPR",IEN)=""
"RTN","SYNINIT",50,0)
 ;;IEN=IEN+1
"RTN","SYNINIT",51,0)
 ;;^%W(17.6001,IEN,0)="GET"
"RTN","SYNINIT",52,0)
 ;;^%W(17.6001,IEN,1)="global/{root}"
"RTN","SYNINIT",53,0)
 ;;^%W(17.6001,IEN,2)="wsGLOBAL^SYNVPR"
"RTN","SYNINIT",54,0)
 ;;^%W(17.6001,"B","GET","global/{root}","wsGLOBAL^SYNVPR",IEN)=""
"RTN","SYNINIT",55,0)
 ;;IEN=IEN+1
"RTN","SYNINIT",56,0)
 ;;^%W(17.6001,IEN,0)="POST"
"RTN","SYNINIT",57,0)
 ;;^%W(17.6001,IEN,1)="addvitals/*"
"RTN","SYNINIT",58,0)
 ;;^%W(17.6001,IEN,2)="wsIntakeVitals^SYNFVIT"
"RTN","SYNINIT",59,0)
 ;;^%W(17.6001,"B","POST","addvitals/*","wsIntakeVitals^SYNFVIT",IEN)=""
"RTN","SYNINIT",60,0)
 ;;IEN=IEN+1
"RTN","SYNINIT",61,0)
 ;;^%W(17.6001,IEN,0)="POST"
"RTN","SYNINIT",62,0)
 ;;^%W(17.6001,IEN,1)="addencounter"
"RTN","SYNINIT",63,0)
 ;;^%W(17.6001,IEN,2)="wsIntakeEncounters^SYNFENC"
"RTN","SYNINIT",64,0)
 ;;^%W(17.6001,"B","POST","addencounter","wsIntakeEncounters^SYNFENC",IEN)=""
"RTN","SYNINIT",65,0)
 ;;IEN=IEN+1
"RTN","SYNINIT",66,0)
 ;;^%W(17.6001,IEN,0)="POST"
"RTN","SYNINIT",67,0)
 ;;^%W(17.6001,IEN,1)="addcondition"
"RTN","SYNINIT",68,0)
 ;;^%W(17.6001,IEN,2)="wsIntakeConditions^SYNFCON"
"RTN","SYNINIT",69,0)
 ;;^%W(17.6001,"B","POST","addcondition","wsIntakeConditions^SYNFCON",IEN)=""
"RTN","SYNINIT",70,0)
 ;;^%W(17.6001,0)="WEB SERVICE URL HANDLER^17.6001S^"_IEN_"^"_IEN
"RTN","SYNINIT",71,0)
 ;;
"RTN","SYNINIT",72,0)
 ;
"RTN","SYNINIT",73,0)
PROV() ;[Public $$] Create Generic Provider for Synthetic Patients
"RTN","SYNINIT",74,0)
 ; ASSUMPTION: DUZ MUST HAVE XUMGR OTHERWISE FILEMAN WILL BLOCK YOU!
"RTN","SYNINIT",75,0)
 N NAME S NAME="PROVIDER,UNKNOWN SYNTHEA" ; Constant
"RTN","SYNINIT",76,0)
 Q:$O(^VA(200,"B",NAME,0)) $O(^(0)) ; Quit if the entry exists with entry
"RTN","SYNINIT",77,0)
 ;
"RTN","SYNINIT",78,0)
 N C0XFDA,C0XIEN,C0XERR,DIERR
"RTN","SYNINIT",79,0)
 S C0XFDA(200,"?+1,",.01)=NAME
"RTN","SYNINIT",80,0)
 S C0XFDA(200,"?+1,",1)="USP" ; Initials
"RTN","SYNINIT",81,0)
 S C0XFDA(200,"?+1,",28)=100 ; Mail Code
"RTN","SYNINIT",82,0)
 S C0XFDA(200,"?+1,",53.1)=1 ; Authorized to write meds
"RTN","SYNINIT",83,0)
 S C0XFDA(200.05,"?+2,?+1,",.01)="`144" ; Person Class - Allopathic docs.
"RTN","SYNINIT",84,0)
 S C0XFDA(200.05,"?+2,?+1,",2)=2700101 ; Date active
"RTN","SYNINIT",85,0)
 ;
"RTN","SYNINIT",86,0)
 ; Security keys
"RTN","SYNINIT",87,0)
 S C0XFDA(200.051,"?+3,?+1,",.01)="PROVIDER"
"RTN","SYNINIT",88,0)
 S C0XFDA(200.051,"?+4,?+1,",.01)="ORES"
"RTN","SYNINIT",89,0)
 ;
"RTN","SYNINIT",90,0)
 ; Access and Verify Codes so we can log in as the provider if we want to
"RTN","SYNINIT",91,0)
 ; We must pre-hash them as that's not in the IT
"RTN","SYNINIT",92,0)
 S C0XFDA(200,"?+1,",2)=$$EN^XUSHSH("SYNPROV123") ; ac
"RTN","SYNINIT",93,0)
 S C0XFDA(200,"?+1,",11)=$$EN^XUSHSH("SYNPROV123!!") ; vc
"RTN","SYNINIT",94,0)
 S C0XFDA(200,"?+1,",7.2)=1 ; verify code never expires
"RTN","SYNINIT",95,0)
 ;
"RTN","SYNINIT",96,0)
 ; Electronic Signature
"RTN","SYNINIT",97,0)
 ; Input transform hashes this guy
"RTN","SYNINIT",98,0)
 S C0XFDA(200,"?+1,",20.4)="123456"
"RTN","SYNINIT",99,0)
 ;
"RTN","SYNINIT",100,0)
 ; Primary Menu
"RTN","SYNINIT",101,0)
 S C0XFDA(200,"?+1,",201)="`"_$$FIND1^DIC(19,,"QX","XUCORE","B")
"RTN","SYNINIT",102,0)
 ;
"RTN","SYNINIT",103,0)
 ; Secondary Menu (CPRS, etc)
"RTN","SYNINIT",104,0)
 S C0XFDA(200.03,"?+5,?+1,",.01)="`"_$$FIND1^DIC(19,,"QX","OR CPRS GUI CHART","B")
"RTN","SYNINIT",105,0)
 ;
"RTN","SYNINIT",106,0)
 ; Restrict Patient Selection
"RTN","SYNINIT",107,0)
 S C0XFDA(200,"?+1,",101.01)="NO"
"RTN","SYNINIT",108,0)
 ;
"RTN","SYNINIT",109,0)
 ; CPRS Tabs
"RTN","SYNINIT",110,0)
 S C0XFDA(200.010113,"?+6,?+1,",.01)="COR"
"RTN","SYNINIT",111,0)
 S C0XFDA(200.010113,"?+6,?+1,",.02)="T-1"
"RTN","SYNINIT",112,0)
 ;
"RTN","SYNINIT",113,0)
 ; Service/Section
"RTN","SYNINIT",114,0)
 S C0XFDA(200,"?+1,",29)="`"_$$MEDSS()
"RTN","SYNINIT",115,0)
 ;
"RTN","SYNINIT",116,0)
 ; NPI - Ferdi made this one up.
"RTN","SYNINIT",117,0)
 S C0XFDA(200,"?+1,",41.99)="9990000348"
"RTN","SYNINIT",118,0)
 ;
"RTN","SYNINIT",119,0)
 N DIC S DIC(0)="" ; An XREF in File 200 requires this.
"RTN","SYNINIT",120,0)
 D UPDATE^DIE("E",$NA(C0XFDA),$NA(C0XIEN),$NA(C0XERR)) ; Typical UPDATE
"RTN","SYNINIT",121,0)
 I $D(DIERR) S $EC=",U1,"
"RTN","SYNINIT",122,0)
 ;
"RTN","SYNINIT",123,0)
 ; Fix verify code change date to the far future
"RTN","SYNINIT",124,0)
 N FDA
"RTN","SYNINIT",125,0)
 S FDA(200,C0XIEN(1)_",",11.2)=$$FMTH^XLFDT($$FMADD^XLFDT(DT,3000))
"RTN","SYNINIT",126,0)
 ;
"RTN","SYNINIT",127,0)
 ; Signature block. Do this as internal values to prevent name check in 20.2.
"RTN","SYNINIT",128,0)
 S FDA(200,C0XIEN(1)_",",20.2)="SYNTHETIC PROVIDER, MD"
"RTN","SYNINIT",129,0)
 S FDA(200,C0XIEN(1)_",",20.3)="Staff Physician"
"RTN","SYNINIT",130,0)
 ;
"RTN","SYNINIT",131,0)
 D FILE^DIE(,$NA(FDA))
"RTN","SYNINIT",132,0)
 I $D(DIERR) S $EC=",U1,"
"RTN","SYNINIT",133,0)
 ;
"RTN","SYNINIT",134,0)
 Q C0XIEN(1) ;Provider IEN
"RTN","SYNINIT",135,0)
 ;
"RTN","SYNINIT",136,0)
PHARM() ;[Public $$] Create Generic Provider for Synthetic Patients
"RTN","SYNINIT",137,0)
 ; ASSUMPTION: DUZ MUST HAVE XUMGR OTHERWISE FILEMAN WILL BLOCK YOU!
"RTN","SYNINIT",138,0)
 N NAME S NAME="PHARMACIST,UNKNOWN SYNTHEA" ; Constant
"RTN","SYNINIT",139,0)
 Q:$O(^VA(200,"B",NAME,0)) $O(^(0)) ; Quit if the entry exists with entry
"RTN","SYNINIT",140,0)
 ;
"RTN","SYNINIT",141,0)
 N C0XFDA,C0XIEN,C0XERR,DIERR
"RTN","SYNINIT",142,0)
 S C0XFDA(200,"?+1,",.01)=NAME
"RTN","SYNINIT",143,0)
 S C0XFDA(200,"?+1,",1)="UST" ; Initials
"RTN","SYNINIT",144,0)
 S C0XFDA(200,"?+1,",28)=111 ; Mail Code
"RTN","SYNINIT",145,0)
 S C0XFDA(200.05,"?+2,?+1,",.01)="`246" ; Person Class - Pharmacist
"RTN","SYNINIT",146,0)
 S C0XFDA(200.05,"?+2,?+1,",2)=2700101 ; Date active
"RTN","SYNINIT",147,0)
 ;
"RTN","SYNINIT",148,0)
 ; Security keys
"RTN","SYNINIT",149,0)
 S C0XFDA(200.051,"?+3,?+1,",.01)="PSORPH"
"RTN","SYNINIT",150,0)
 S C0XFDA(200.051,"?+4,?+1,",.01)="ORELSE"
"RTN","SYNINIT",151,0)
 ;
"RTN","SYNINIT",152,0)
 ; Access and Verify Codes so we can log in as the provider if we want to
"RTN","SYNINIT",153,0)
 ; We must pre-hash them as that's not in the IT
"RTN","SYNINIT",154,0)
 S C0XFDA(200,"?+1,",2)=$$EN^XUSHSH("SYNPHARM123") ; ac
"RTN","SYNINIT",155,0)
 S C0XFDA(200,"?+1,",11)=$$EN^XUSHSH("SYNPHARM123!!") ; vc
"RTN","SYNINIT",156,0)
 S C0XFDA(200,"?+1,",7.2)=1 ; verify code never expires
"RTN","SYNINIT",157,0)
 ;
"RTN","SYNINIT",158,0)
 ; Electronic Signature
"RTN","SYNINIT",159,0)
 ; Input transform hashes this guy
"RTN","SYNINIT",160,0)
 S C0XFDA(200,"?+1,",20.4)="123456"
"RTN","SYNINIT",161,0)
 ;
"RTN","SYNINIT",162,0)
 ; Primary Menu
"RTN","SYNINIT",163,0)
 S C0XFDA(200,"?+1,",201)="`"_$$FIND1^DIC(19,,"QX","XUCORE","B")
"RTN","SYNINIT",164,0)
 ;
"RTN","SYNINIT",165,0)
 ; Secondary Menu (CPRS, etc)
"RTN","SYNINIT",166,0)
 S C0XFDA(200.03,"?+5,?+1,",.01)="`"_$$FIND1^DIC(19,,"QX","OR CPRS GUI CHART","B")
"RTN","SYNINIT",167,0)
 ;
"RTN","SYNINIT",168,0)
 ; Restrict Patient Selection
"RTN","SYNINIT",169,0)
 S C0XFDA(200,"?+1,",101.01)="NO"
"RTN","SYNINIT",170,0)
 ;
"RTN","SYNINIT",171,0)
 ; CPRS Tabs
"RTN","SYNINIT",172,0)
 S C0XFDA(200.010113,"?+6,?+1,",.01)="COR"
"RTN","SYNINIT",173,0)
 S C0XFDA(200.010113,"?+6,?+1,",.02)="T-1"
"RTN","SYNINIT",174,0)
 ;
"RTN","SYNINIT",175,0)
 ; Service/Section
"RTN","SYNINIT",176,0)
 S C0XFDA(200,"?+1,",29)="`"_$$PHRSS()
"RTN","SYNINIT",177,0)
 ;
"RTN","SYNINIT",178,0)
 N DIC S DIC(0)="" ; An XREF in File 200 requires this.
"RTN","SYNINIT",179,0)
 D UPDATE^DIE("E",$NA(C0XFDA),$NA(C0XIEN),$NA(C0XERR)) ; Typical UPDATE
"RTN","SYNINIT",180,0)
 I $D(DIERR) S $EC=",U1,"
"RTN","SYNINIT",181,0)
 ;
"RTN","SYNINIT",182,0)
 ; Fix verify code change date to the far future
"RTN","SYNINIT",183,0)
 N FDA
"RTN","SYNINIT",184,0)
 S FDA(200,C0XIEN(1)_",",11.2)=$$FMTH^XLFDT($$FMADD^XLFDT(DT,3000))
"RTN","SYNINIT",185,0)
 ;
"RTN","SYNINIT",186,0)
 ; Signature block. Do this as internal values to prevent name check in 20.2.
"RTN","SYNINIT",187,0)
 S FDA(200,C0XIEN(1)_",",20.2)="SYNTHETIC PHARMACIST, RPH"
"RTN","SYNINIT",188,0)
 S FDA(200,C0XIEN(1)_",",20.3)="Staff Pharmacist"
"RTN","SYNINIT",189,0)
 ;
"RTN","SYNINIT",190,0)
 D FILE^DIE(,$NA(FDA))
"RTN","SYNINIT",191,0)
 I $D(DIERR) S $EC=",U1,"
"RTN","SYNINIT",192,0)
 ;
"RTN","SYNINIT",193,0)
 Q C0XIEN(1) ;Provider IEN
"RTN","SYNINIT",194,0)
 ;
"RTN","SYNINIT",195,0)
MEDSS() ; [Public $$] Create Medical Service/Section
"RTN","SYNINIT",196,0)
 N NAME S NAME="MEDICINE"
"RTN","SYNINIT",197,0)
 Q:$O(^DIC(49,"B",NAME,0)) $O(^(0))
"RTN","SYNINIT",198,0)
 ;
"RTN","SYNINIT",199,0)
 N FDA,IEN,DIERR
"RTN","SYNINIT",200,0)
 S FDA(49,"?+1,",.01)=NAME
"RTN","SYNINIT",201,0)
 S FDA(49,"?+1,",1)="MED"
"RTN","SYNINIT",202,0)
 S FDA(49,"?+1,",1.5)="MED"
"RTN","SYNINIT",203,0)
 S FDA(49,"?+1,",1.7)="PATIENT CARE"
"RTN","SYNINIT",204,0)
 D UPDATE^DIE("E",$NA(FDA),$NA(IEN))
"RTN","SYNINIT",205,0)
 I $D(DIERR) S $EC=",U1,"
"RTN","SYNINIT",206,0)
 QUIT IEN(1)
"RTN","SYNINIT",207,0)
 ;
"RTN","SYNINIT",208,0)
PHRSS() ; [Public $$] Create Pharmacy Service/Section
"RTN","SYNINIT",209,0)
 N NAME S NAME="PHARMACY"
"RTN","SYNINIT",210,0)
 Q:$O(^DIC(49,"B",NAME,0)) $O(^(0))
"RTN","SYNINIT",211,0)
 ;
"RTN","SYNINIT",212,0)
 N FDA,IEN,DIERR
"RTN","SYNINIT",213,0)
 S FDA(49,"?+1,",.01)=NAME
"RTN","SYNINIT",214,0)
 S FDA(49,"?+1,",1)="PHR"
"RTN","SYNINIT",215,0)
 S FDA(49,"?+1,",1.5)="PHR"
"RTN","SYNINIT",216,0)
 S FDA(49,"?+1,",1.6)="`"_$$MEDSS()
"RTN","SYNINIT",217,0)
 S FDA(49,"?+1,",1.7)="PATIENT CARE"
"RTN","SYNINIT",218,0)
 D UPDATE^DIE("E",$NA(FDA),$NA(IEN))
"RTN","SYNINIT",219,0)
 I $D(DIERR) S $EC=",U1,"
"RTN","SYNINIT",220,0)
 QUIT IEN(1)
"RTN","SYNINIT",221,0)
 ;
"RTN","SYNINIT",222,0)
IBACTION ; [Public] Fix IB ACTION TYPE file (350.1) PSO entries to point to PHARMACY service/section
"RTN","SYNINIT",223,0)
 ; Required in order to be able to set-up pharmacy site parameters
"RTN","SYNINIT",224,0)
 ;
"RTN","SYNINIT",225,0)
 N FDA,IEN
"RTN","SYNINIT",226,0)
 ;
"RTN","SYNINIT",227,0)
 ; Get Pharmacy SS entry
"RTN","SYNINIT",228,0)
 N PHRSS S PHRSS=$$PHRSS()
"RTN","SYNINIT",229,0)
 ;
"RTN","SYNINIT",230,0)
 ; Get PSO entries
"RTN","SYNINIT",231,0)
 D FIND^DIC(350.1,,"@","PQE","PSO","*","B")
"RTN","SYNINIT",232,0)
 ;
"RTN","SYNINIT",233,0)
 ; Create FDA and file
"RTN","SYNINIT",234,0)
 N SYNI F SYNI=0:0 S SYNI=$O(^TMP("DILIST",$J,SYNI)) Q:'SYNI  S IEN=^(SYNI,0) S FDA(350.1,IEN_",",.04)=PHRSS
"RTN","SYNINIT",235,0)
 D FILE^DIE("",$NA(FDA))
"RTN","SYNINIT",236,0)
 ;
"RTN","SYNINIT",237,0)
 QUIT
"RTN","SYNINIT",238,0)
 ;
"RTN","SYNINIT",239,0)
HL() ; [Public $$] Generic Hospital Location Entry
"RTN","SYNINIT",240,0)
 N NAME S NAME="GENERAL MEDICINE" ; Constant
"RTN","SYNINIT",241,0)
 Q:$O(^SC("B",NAME,0)) $O(^(0)) ; Quit if the entry exists with the entry
"RTN","SYNINIT",242,0)
 ;
"RTN","SYNINIT",243,0)
 N C0XFDA,C0XIEN,C0XERR,DIERR
"RTN","SYNINIT",244,0)
 S C0XFDA(44,"?+1,",.01)=NAME
"RTN","SYNINIT",245,0)
 S C0XFDA(44,"?+1,",2)="C" ; Type - Clinic
"RTN","SYNINIT",246,0)
 S C0XFDA(44,"?+1,",2.1)=1 ; Type Extension - Clinic
"RTN","SYNINIT",247,0)
 S C0XFDA(44,"?+1,",3)=+$$SITE^VASITE() ; Institution - Default institution
"RTN","SYNINIT",248,0)
 S C0XFDA(44,"?+1,",8)=295 ; STOP CODE NUMBER - Primary Care
"RTN","SYNINIT",249,0)
 S C0XFDA(44,"?+1,",9)="M" ; SERVICE
"RTN","SYNINIT",250,0)
 S C0XFDA(44,"?+1,",2502)="N" ; NON-COUNT CLINIC
"RTN","SYNINIT",251,0)
 D UPDATE^DIE("",$NA(C0XFDA),$NA(C0XIEN),$NA(C0XERR))
"RTN","SYNINIT",252,0)
 I $D(DIERR) S $EC=",U1,"
"RTN","SYNINIT",253,0)
 Q C0XIEN(1) ; HL IEN
"RTN","SYNINIT",254,0)
 ;
"RTN","SYNINIT",255,0)
AMIE ; [Public] Fix "AMIE LINK OUT OF ORDER" message
"RTN","SYNINIT",256,0)
 N IEN S IEN=$$FIND1^DIC(101,,"QX","DVBA C&P SCHD EVENT","B")
"RTN","SYNINIT",257,0)
 Q:'IEN
"RTN","SYNINIT",258,0)
 N FDA,DIERR
"RTN","SYNINIT",259,0)
 S FDA(101,IEN_",",2)="@" ; DISABLE field
"RTN","SYNINIT",260,0)
 D FILE^DIE("",$NA(FDA))
"RTN","SYNINIT",261,0)
 I $D(DIERR) S $EC=",U1,"
"RTN","SYNINIT",262,0)
 QUIT
"RTN","SYNINIT",263,0)
 ;
"RTN","SYNINIT",264,0)
PSOSITE() ; [Public $$] Add a default pharmacy site
"RTN","SYNINIT",265,0)
 N NAME S NAME="SYNTHETIC PATIENTS"
"RTN","SYNINIT",266,0)
 I $O(^PS(59,"B",NAME,0)) Q $O(^(0))
"RTN","SYNINIT",267,0)
 ;
"RTN","SYNINIT",268,0)
 N SITENUMBER
"RTN","SYNINIT",269,0)
 N SITEIEN
"RTN","SYNINIT",270,0)
 N % S %=$$SITE^VASITE()
"RTN","SYNINIT",271,0)
 S SITEIEN=$P(%,U)
"RTN","SYNINIT",272,0)
 S SITENUMBER=$P(%,U,3)
"RTN","SYNINIT",273,0)
 ;
"RTN","SYNINIT",274,0)
 N FDA,DIERR,IEN
"RTN","SYNINIT",275,0)
 S FDA(59,"?+1,",.01)=NAME
"RTN","SYNINIT",276,0)
 S FDA(59,"?+1,",.02)="1934 OLD GALLOWS ROAD" ; MAILING FRANK STREET ADDRESS
"RTN","SYNINIT",277,0)
 S FDA(59,"?+1,",.03)=571 ; AREA CODE
"RTN","SYNINIT",278,0)
 S FDA(59,"?+1,",.04)="999-9999" ; PHONE NUMBER
"RTN","SYNINIT",279,0)
 S FDA(59,"?+1,",.05)=22182 ; Zip code
"RTN","SYNINIT",280,0)
 S FDA(59,"?+1,",.06)=SITENUMBER ; Site Number
"RTN","SYNINIT",281,0)
 S FDA(59,"?+1,",.07)="VIENNA" ; CITY
"RTN","SYNINIT",282,0)
 S FDA(59,"?+1,",.17)=1 ; SHALL COMPUTER ASSIGN RX #S
"RTN","SYNINIT",283,0)
 S FDA(59,"?+1,",4)=1   ; NEW LABEL STOCK
"RTN","SYNINIT",284,0)
 S FDA(59,"?+1,",100)="`"_SITEIEN ; RELATED INSTITUTION
"RTN","SYNINIT",285,0)
 S FDA(59,"?+1,",101)="`"_SITEIEN ; NPI INSTITUTION
"RTN","SYNINIT",286,0)
 S FDA(59,"?+1,",1000)=0 ; NARCOTICS NUMBERED DIFFERENTLY
"RTN","SYNINIT",287,0)
 S FDA(59,"?+1,",1001)=1 ; NARCOTIC LOWER BOUND
"RTN","SYNINIT",288,0)
 S FDA(59,"?+1,",1002)=1 ; NARCOTIC UPPER BOUND
"RTN","SYNINIT",289,0)
 S FDA(59,"?+1,",1003)="`"_$$PHRSS() ; IB SERVICE/SECTION
"RTN","SYNINIT",290,0)
 S FDA(59,"?+1,",2001)=100000000 ; PRESCRIPTION # LOWER BOUND
"RTN","SYNINIT",291,0)
 S FDA(59,"?+1,",2002)=999999999 ; PRESCRIPTION # UPPER BOUND
"RTN","SYNINIT",292,0)
 S FDA(59.08,"?+2,?+1,",.01)="`"_SITEIEN ; CPRS ORDERING INSTITUTION
"RTN","SYNINIT",293,0)
 D UPDATE^DIE("E",$NA(FDA),$NA(IEN))
"RTN","SYNINIT",294,0)
 I $D(DIERR) S $EC=",U1,"
"RTN","SYNINIT",295,0)
 Q IEN(1)
"RTN","SYNINIT",296,0)
 ;
"RTN","SYNINIT",297,0)
TEST D EN^%ut($T(+0),3) QUIT
"RTN","SYNINIT",298,0)
 ;
"RTN","SYNINIT",299,0)
TESTPROV ; @TEST Test adding a provider
"RTN","SYNINIT",300,0)
 N NAME S NAME="PROVIDER,UNKNOWN SYNTHEA" ; Constant
"RTN","SYNINIT",301,0)
 N PROV S PROV=$$FIND1^DIC(200,,"QX",NAME,"B")
"RTN","SYNINIT",302,0)
 I PROV N DA,DIK S DA=PROV,DIK="^VA(200," D ^DIK
"RTN","SYNINIT",303,0)
 S PROV=$$PROV()
"RTN","SYNINIT",304,0)
 D CHKTF^%ut(PROV>0)
"RTN","SYNINIT",305,0)
 QUIT
"RTN","SYNINIT",306,0)
 ;
"RTN","SYNINIT",307,0)
TESTPHARM ; @TEST Test adding a pharmacist
"RTN","SYNINIT",308,0)
 N NAME S NAME="PHARMACIST,UNKNOWN SYNTHEA" ; Constant
"RTN","SYNINIT",309,0)
 N PHARM S PHARM=$$FIND1^DIC(200,,"QX",NAME,"B")
"RTN","SYNINIT",310,0)
 I PHARM N DA,DIK S DA=PHARM,DIK="^VA(200," D ^DIK
"RTN","SYNINIT",311,0)
 S PHARM=$$PHARM()
"RTN","SYNINIT",312,0)
 D CHKTF^%ut(PHARM>0)
"RTN","SYNINIT",313,0)
 QUIT
"RTN","SYNINIT",314,0)
 ;
"RTN","SYNINIT",315,0)
TESTHL ; @TEST Test adding a clinic
"RTN","SYNINIT",316,0)
 N NAME S NAME="GENERAL MEDICINE" ; Constant
"RTN","SYNINIT",317,0)
 N HL S HL=$$FIND1^DIC(44,,"QX",NAME,"B")
"RTN","SYNINIT",318,0)
 I HL N DA,DIK S DA=HL,DIK="^SC(" D ^DIK
"RTN","SYNINIT",319,0)
 S HL=$$HL()
"RTN","SYNINIT",320,0)
 D CHKTF^%ut(HL>0)
"RTN","SYNINIT",321,0)
 QUIT
"RTN","SYNINIT",322,0)
 ;
"RTN","SYNINIT",323,0)
TESTLH ; @Test Load Handlers
"RTN","SYNINIT",324,0)
 ; WARNING: NAKED REFERENCES ALL OVER HERE!
"RTN","SYNINIT",325,0)
 N IEN
"RTN","SYNINIT",326,0)
 S IEN=$O(^%W(17.6001,"B","POST","addpatient/*","wsPostFHIR^SYNFHIR",""))
"RTN","SYNINIT",327,0)
 K ^(IEN),^%W(17.6001,IEN)
"RTN","SYNINIT",328,0)
 S IEN=$O(^%W(17.6001,"B","GET","showfhir/*","wsShow^SYNFHIR",""))
"RTN","SYNINIT",329,0)
 K ^(IEN),^%W(17.6001,IEN)
"RTN","SYNINIT",330,0)
 S IEN=$O(^%W(17.6001,"B","GET","vpr/*","wsVPR^SYNVPR",""))
"RTN","SYNINIT",331,0)
 K ^(IEN),^%W(17.6001,IEN)
"RTN","SYNINIT",332,0)
 S IEN=$O(^%W(17.6001,"B","GET","global/{root}","wsGLOBAL^SYNVPR",""))
"RTN","SYNINIT",333,0)
 K ^(IEN),^%W(17.6001,IEN)
"RTN","SYNINIT",334,0)
 S IEN=$O(^%W(17.6001,"B","POST","addvitals/*","wsIntakeVitals^SYNFVIT",""))
"RTN","SYNINIT",335,0)
 K ^(IEN),^%W(17.6001,IEN)
"RTN","SYNINIT",336,0)
 S IEN=$O(^%W(17.6001,"B","POST","addencounter","wsIntakeEncounters^SYNFENC",""))
"RTN","SYNINIT",337,0)
 K ^(IEN),^%W(17.6001,IEN)
"RTN","SYNINIT",338,0)
 S IEN=$O(^%W(17.6001,"B","POST","addcondition","wsIntakeConditions^SYNFCON",""))
"RTN","SYNINIT",339,0)
 K ^(IEN),^%W(17.6001,IEN)
"RTN","SYNINIT",340,0)
 ; /WARNING: NAKED REFERENCES ALL OVER HERE!
"RTN","SYNINIT",341,0)
 ;
"RTN","SYNINIT",342,0)
 D LOADHAND
"RTN","SYNINIT",343,0)
 K IEN
"RTN","SYNINIT",344,0)
 S IEN=$O(^%W(17.6001,"B","POST","addpatient/*","wsPostFHIR^SYNFHIR",""))
"RTN","SYNINIT",345,0)
 D CHKTF^%ut(IEN)
"RTN","SYNINIT",346,0)
 K IEN
"RTN","SYNINIT",347,0)
 S IEN=$O(^%W(17.6001,"B","GET","showfhir/*","wsShow^SYNFHIR",""))
"RTN","SYNINIT",348,0)
 D CHKTF^%ut(IEN)
"RTN","SYNINIT",349,0)
 K IEN
"RTN","SYNINIT",350,0)
 S IEN=$O(^%W(17.6001,"B","GET","vpr/*","wsVPR^SYNVPR",""))
"RTN","SYNINIT",351,0)
 D CHKTF^%ut(IEN)
"RTN","SYNINIT",352,0)
 K IEN
"RTN","SYNINIT",353,0)
 S IEN=$O(^%W(17.6001,"B","GET","global/{root}","wsGLOBAL^SYNVPR",""))
"RTN","SYNINIT",354,0)
 D CHKTF^%ut(IEN)
"RTN","SYNINIT",355,0)
 K IEN
"RTN","SYNINIT",356,0)
 S IEN=$O(^%W(17.6001,"B","POST","addvitals/*","wsIntakeVitals^SYNFVIT",""))
"RTN","SYNINIT",357,0)
 D CHKTF^%ut(IEN)
"RTN","SYNINIT",358,0)
 K IEN
"RTN","SYNINIT",359,0)
 S IEN=$O(^%W(17.6001,"B","POST","addencounter","wsIntakeEncounters^SYNFENC",""))
"RTN","SYNINIT",360,0)
 D CHKTF^%ut(IEN)
"RTN","SYNINIT",361,0)
 K IEN
"RTN","SYNINIT",362,0)
 S IEN=$O(^%W(17.6001,"B","POST","addcondition","wsIntakeConditions^SYNFCON",""))
"RTN","SYNINIT",363,0)
 D CHKTF^%ut(IEN)
"RTN","SYNINIT",364,0)
 K IEN
"RTN","SYNINIT",365,0)
 QUIT
"RTN","SYNINIT",366,0)
 ;
"RTN","SYNINIT",367,0)
TESTAMIE ; @TEST AMIE
"RTN","SYNINIT",368,0)
 N IEN S IEN=$$FIND1^DIC(101,,"QX","DVBA C&P SCHD EVENT","B")
"RTN","SYNINIT",369,0)
 N FDA
"RTN","SYNINIT",370,0)
 S FDA(101,IEN_",",2)="AMIE LINK OUT OF ORDER" ; DISABLE field
"RTN","SYNINIT",371,0)
 D FILE^DIE("",$NA(FDA))
"RTN","SYNINIT",372,0)
 D AMIE
"RTN","SYNINIT",373,0)
 D CHKTF^%ut($P(^ORD(101,IEN,0),U,3)="")
"RTN","SYNINIT",374,0)
 QUIT
"RTN","SYNINIT",375,0)
 ;
"RTN","SYNINIT",376,0)
TESTIBACT ; @TEST IB Action Fix
"RTN","SYNINIT",377,0)
 D IBACTION
"RTN","SYNINIT",378,0)
 N PHRSS S PHRSS=$$PHRSS()
"RTN","SYNINIT",379,0)
 ;
"RTN","SYNINIT",380,0)
 ; We confirm through the index that we have six entries pointing to pharmacy
"RTN","SYNINIT",381,0)
 N CNT S CNT=0
"RTN","SYNINIT",382,0)
 N I F I=0:0 S I=$O(^IBE(350.1,"C",PHRSS,I)) Q:'I  S CNT=CNT+1
"RTN","SYNINIT",383,0)
 D CHKTF^%ut(CNT=6)
"RTN","SYNINIT",384,0)
 QUIT
"RTN","SYNINIT",385,0)
 ;
"RTN","SYNINIT",386,0)
TESTPSOSITE ; @TEST Adding Outpatient Site
"RTN","SYNINIT",387,0)
 N DA,DIK S DA=1,DIK="^PS(59," D ^DIK
"RTN","SYNINIT",388,0)
 N % S %=$$PSOSITE()
"RTN","SYNINIT",389,0)
 D CHKTF^%ut(%=1)
"RTN","SYNINIT",390,0)
 QUIT
"RTN","SYNINIT",391,0)
 ;
"RTN","SYNKIDS")
0^44^B91099127
"RTN","SYNKIDS",1,0)
SYNKIDS ; OSE/SMH - Synthea Installer ; 8/16/18 5:02pm
"RTN","SYNKIDS",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNKIDS",3,0)
 ;
"RTN","SYNKIDS",4,0)
 ; WARNING: THIS ROUTINE IS A BAD EXAMPLE FOR ANYBODY TRYING TO WRITE GOOD CODE.
"RTN","SYNKIDS",5,0)
 ; I SHOUDLN'T BE DOING HALF OF THE THINGS HERE, BUT I HAVE NO CHOICE RIGHT NOW.
"RTN","SYNKIDS",6,0)
 ;
"RTN","SYNKIDS",7,0)
 ; --SAM
"RTN","SYNKIDS",8,0)
 ;
"RTN","SYNKIDS",9,0)
ENV ; [Fallthrough]
"RTN","SYNKIDS",10,0)
 QUIT
"RTN","SYNKIDS",11,0)
 ;
"RTN","SYNKIDS",12,0)
CACHE() Q $L($SY,",")'=2
"RTN","SYNKIDS",13,0)
GTM()   Q +$SY=47
"RTN","SYNKIDS",14,0)
 ;
"RTN","SYNKIDS",15,0)
TRAN ; [KIDS] - Transport from source system (BAD! SHOULD BE A FILEMAN FILE)
"RTN","SYNKIDS",16,0)
 M @XPDGREF@("SYN")=^SYN
"RTN","SYNKIDS",17,0)
 QUIT
"RTN","SYNKIDS",18,0)
 ;
"RTN","SYNKIDS",19,0)
PRE ; [KIDS] - Pre Install -- all for Cache
"RTN","SYNKIDS",20,0)
 D CACHEMAP("%w")
"RTN","SYNKIDS",21,0)
 D CACHEMAP("%W")
"RTN","SYNKIDS",22,0)
 D CACHEMAP("%s")
"RTN","SYNKIDS",23,0)
 D CACHETLS
"RTN","SYNKIDS",24,0)
 QUIT
"RTN","SYNKIDS",25,0)
 ;
"RTN","SYNKIDS",26,0)
POST ; [KIDS] - Post Install
"RTN","SYNKIDS",27,0)
 DO POSTRO
"RTN","SYNKIDS",28,0)
 DO POSTWWW
"RTN","SYNKIDS",29,0)
 DO POSTSYN
"RTN","SYNKIDS",30,0)
 QUIT
"RTN","SYNKIDS",31,0)
 ;
"RTN","SYNKIDS",32,0)
POSTSYN ; [Private] Restore SYN global
"RTN","SYNKIDS",33,0)
 ; Resore data from saved global
"RTN","SYNKIDS",34,0)
 ; Next line makes this safe to run in dev mode
"RTN","SYNKIDS",35,0)
 I $D(XPDGREF)#2,$D(@XPDGREF@("SYN")) D
"RTN","SYNKIDS",36,0)
 . K ^SYN("2002.010")
"RTN","SYNKIDS",37,0)
 . K ^SYN("2002.020")
"RTN","SYNKIDS",38,0)
 . K ^SYN("2002.030")
"RTN","SYNKIDS",39,0)
 . M ^SYN=@XPDGREF@("SYN")
"RTN","SYNKIDS",40,0)
 ;
"RTN","SYNKIDS",41,0)
 ; Initialize Synthea
"RTN","SYNKIDS",42,0)
 D ^SYNINIT
"RTN","SYNKIDS",43,0)
 QUIT
"RTN","SYNKIDS",44,0)
 ;
"RTN","SYNKIDS",45,0)
POSTRO ; [Private] Download and Import RO Files
"RTN","SYNKIDS",46,0)
 D MES^XPDUTL("Downloading MASH...")
"RTN","SYNKIDS",47,0)
 D INSTALLRO("https://cdn.rawgit.com/OSEHRA/VistA-FHIR-Data-Loader/master/mash/mash-1-v0.ro")
"RTN","SYNKIDS",48,0)
 D MES^XPDUTL("Downloading MWS...")
"RTN","SYNKIDS",49,0)
 D INSTALLRO("https://cdn.rawgit.com/shabiel/M-Web-Server/0.1.4/dist/WWWINIT.RSA")
"RTN","SYNKIDS",50,0)
 D INSTALLRO("https://cdn.rawgit.com/shabiel/M-Web-Server/0.1.4/dist/MWS.RSA")
"RTN","SYNKIDS",51,0)
 QUIT
"RTN","SYNKIDS",52,0)
 ;
"RTN","SYNKIDS",53,0)
POSTWWW ; [Private] Initialize MWS
"RTN","SYNKIDS",54,0)
 D ^%WINIT
"RTN","SYNKIDS",55,0)
 D LOADHAND^WWWINIT
"RTN","SYNKIDS",56,0)
 N PORT F PORT=9080:1 Q:$$PORTOK^WWWINIT(PORT)
"RTN","SYNKIDS",57,0)
 D JOB^VPRJREQ(PORT)
"RTN","SYNKIDS",58,0)
 N SERVER S SERVER="http://localhost:"_PORT_"/"
"RTN","SYNKIDS",59,0)
 D MES^XPDUTL("")
"RTN","SYNKIDS",60,0)
 D MES^XPDUTL("Mumps Web Services is now listening to port "_PORT)
"RTN","SYNKIDS",61,0)
 D MES^XPDUTL("Visit "_SERVER_" to see the home page.")
"RTN","SYNKIDS",62,0)
 D MES^XPDUTL("Also, try the sample web services...")
"RTN","SYNKIDS",63,0)
 D MES^XPDUTL(" - "_SERVER_"xml")
"RTN","SYNKIDS",64,0)
 D MES^XPDUTL(" - "_SERVER_"ping")
"RTN","SYNKIDS",65,0)
 QUIT
"RTN","SYNKIDS",66,0)
 ;
"RTN","SYNKIDS",67,0)
 ;
"RTN","SYNKIDS",68,0)
INSTALLRO(URL) ; [Private] Download and Install RO files
"RTN","SYNKIDS",69,0)
 ; Get current directory (GT.M may need it to write routines later)
"RTN","SYNKIDS",70,0)
 N PWD S PWD=$$PWD()
"RTN","SYNKIDS",71,0)
 ;
"RTN","SYNKIDS",72,0)
 ; Change to temporary directory (a bit complex for Windows)
"RTN","SYNKIDS",73,0)
 D CDTMPDIR
"RTN","SYNKIDS",74,0)
 ;
"RTN","SYNKIDS",75,0)
 ; Get temp dir
"RTN","SYNKIDS",76,0)
 N TMPDIR S TMPDIR=$$PWD()
"RTN","SYNKIDS",77,0)
 ;
"RTN","SYNKIDS",78,0)
 ; Download the files from Github into temp directory
"RTN","SYNKIDS",79,0)
 D DOWNLOAD(URL)
"RTN","SYNKIDS",80,0)
 ;
"RTN","SYNKIDS",81,0)
 ; Go back to the old directory
"RTN","SYNKIDS",82,0)
 D CD(PWD)
"RTN","SYNKIDS",83,0)
 ;
"RTN","SYNKIDS",84,0)
 ; Silently install RSA -- fur GT.M pass the GTM directory in case we need it.
"RTN","SYNKIDS",85,0)
 new filename set filename=$p(URL,"/",$l(URL,"/"))
"RTN","SYNKIDS",86,0)
 I $$CACHE DO RICACHE(TMPDIR_filename)
"RTN","SYNKIDS",87,0)
 I $$GTM DO RIGTM(TMPDIR_filename,,PWD)
"RTN","SYNKIDS",88,0)
 QUIT
"RTN","SYNKIDS",89,0)
 ;
"RTN","SYNKIDS",90,0)
PWD() ; $$ - Get current directory
"RTN","SYNKIDS",91,0)
 Q:$$CACHE $ZU(168)
"RTN","SYNKIDS",92,0)
 Q:$$GTM $ZD
"RTN","SYNKIDS",93,0)
 S $EC=",U-NOT-IMPLEMENTED,"
"RTN","SYNKIDS",94,0)
 QUIT
"RTN","SYNKIDS",95,0)
 ;
"RTN","SYNKIDS",96,0)
CDTMPDIR ; Proc - Change to temporary directory
"RTN","SYNKIDS",97,0)
 I $$GTM S $ZD="/tmp/" QUIT  ; GT.M
"RTN","SYNKIDS",98,0)
 I $$CACHE S %=$ZU(168,^%SYS("TempDir")) QUIT  ; Cache
"RTN","SYNKIDS",99,0)
 S $EC=",U-NOT-IMPLEMENTED,"
"RTN","SYNKIDS",100,0)
 QUIT
"RTN","SYNKIDS",101,0)
 ;
"RTN","SYNKIDS",102,0)
CD(DIR) ; Proc - Change to the old directory
"RTN","SYNKIDS",103,0)
 I $$CACHE N % S %=$ZU(168,DIR) QUIT
"RTN","SYNKIDS",104,0)
 I $$GTM S $ZD=DIR QUIT
"RTN","SYNKIDS",105,0)
 QUIT
"RTN","SYNKIDS",106,0)
 ;
"RTN","SYNKIDS",107,0)
CACHEMAP(G) ; Map Globals and Routines away from %SYS in Cache
"RTN","SYNKIDS",108,0)
 ; ZEXCEPT: AddGlobalMapping,Class,Config,Configuration,Create,Get,GetErrorText,GetGlobalMapping,MapRoutines,MapGlobals,Namespaces,Status,class - these are all part of Cache class names
"RTN","SYNKIDS",109,0)
 ; Get current namespace
"RTN","SYNKIDS",110,0)
 I $$GTM QUIT
"RTN","SYNKIDS",111,0)
 ;
"RTN","SYNKIDS",112,0)
 S G=G_"*"
"RTN","SYNKIDS",113,0)
 N NMSP
"RTN","SYNKIDS",114,0)
 I $P($P($ZV,") ",2),"(")<2012 S NMSP=$ZU(5)
"RTN","SYNKIDS",115,0)
 I $P($P($ZV,") ",2),"(")>2011 S NMSP=$NAMESPACE
"RTN","SYNKIDS",116,0)
 ;
"RTN","SYNKIDS",117,0)
 N $ET S $ET="ZN NMSP D ^%ZTER S $EC="""""
"RTN","SYNKIDS",118,0)
 ;
"RTN","SYNKIDS",119,0)
 ZN "%SYS" ; Go to SYS
"RTN","SYNKIDS",120,0)
 ;
"RTN","SYNKIDS",121,0)
 ; Props
"RTN","SYNKIDS",122,0)
 N PROP
"RTN","SYNKIDS",123,0)
 N % S %=##Class(Config.Namespaces).Get(NMSP,.PROP) ; Get all namespace properties
"RTN","SYNKIDS",124,0)
 I '% W !,"Error="_$SYSTEM.Status.GetErrorText(%) S $EC=",U-CONFIG-FAIL," QUIT
"RTN","SYNKIDS",125,0)
 ;
"RTN","SYNKIDS",126,0)
 N DBG S DBG=PROP("Globals")  ; get the database globals location
"RTN","SYNKIDS",127,0)
 N DBR S DBR=PROP("Routines") ; get the database routines location
"RTN","SYNKIDS",128,0)
 ;
"RTN","SYNKIDS",129,0)
 ; the following is needed for the call to MapGlobals.Create below, is not set in above call
"RTN","SYNKIDS",130,0)
 S PROP("Database")=NMSP
"RTN","SYNKIDS",131,0)
 ;
"RTN","SYNKIDS",132,0)
 ; Map %ut globals away from %SYS
"RTN","SYNKIDS",133,0)
 N %
"RTN","SYNKIDS",134,0)
 S %=##class(Config.Configuration).GetGlobalMapping(NMSP,G,"",DBG,DBG)
"RTN","SYNKIDS",135,0)
 I '% S %=##class(Config.Configuration).AddGlobalMapping(NMSP,G,"",DBG,DBG)
"RTN","SYNKIDS",136,0)
 I '% W !,"Error="_$SYSTEM.Status.GetErrorText(%) S $EC=",U-CONFIG-FAIL," QUIT
"RTN","SYNKIDS",137,0)
 ;
"RTN","SYNKIDS",138,0)
 ; Map %ut routines away from %SYS
"RTN","SYNKIDS",139,0)
 N PROPRTN S PROPRTN("Database")=DBR
"RTN","SYNKIDS",140,0)
 N % S %=##Class(Config.MapRoutines).Get(NMSP,G,.PROPRTN)
"RTN","SYNKIDS",141,0)
 S PROPRTN("Database")=DBR  ; Cache seems to like deleting this
"RTN","SYNKIDS",142,0)
 I '% S %=##Class(Config.MapRoutines).Create(NMSP,G,.PROPRTN)
"RTN","SYNKIDS",143,0)
 I '% W !,"Error="_$SYSTEM.Status.GetErrorText(%) S $EC=",U-CONFIG-FAIL," QUIT
"RTN","SYNKIDS",144,0)
 ZN NMSP ; Go back
"RTN","SYNKIDS",145,0)
 QUIT
"RTN","SYNKIDS",146,0)
 ;
"RTN","SYNKIDS",147,0)
CACHETLS ; Create a client SSL/TLS config on Cache
"RTN","SYNKIDS",148,0)
 I $$GTM QUIT
"RTN","SYNKIDS",149,0)
 ;
"RTN","SYNKIDS",150,0)
 ; Create the configuration
"RTN","SYNKIDS",151,0)
 N $NAMESPACE S $NAMESPACE="%SYS"
"RTN","SYNKIDS",152,0)
 n config,status
"RTN","SYNKIDS",153,0)
 n % s %=##class(Security.SSLConfigs).Exists("encrypt_only",.config,.status) ; check if config exists
"RTN","SYNKIDS",154,0)
 i '% d
"RTN","SYNKIDS",155,0)
 . n prop s prop("Name")="encrypt_only"
"RTN","SYNKIDS",156,0)
 . s %=##class(Security.SSLConfigs).Create("encrypt_only",.prop) ; create a default ssl config
"RTN","SYNKIDS",157,0)
 . i '% w $SYSTEM.Status.GetErrorText(%) s $ec=",u-cache-error,"
"RTN","SYNKIDS",158,0)
 . s %=##class(Security.SSLConfigs).Exists("encrypt_only",.config,.status) ; get config
"RTN","SYNKIDS",159,0)
 e  s %=config.Activate()
"RTN","SYNKIDS",160,0)
 ;
"RTN","SYNKIDS",161,0)
 ; Test it by connecting to encrypted.google.com
"RTN","SYNKIDS",162,0)
 n rtn
"RTN","SYNKIDS",163,0)
 d config.TestConnection("encrypted.google.com",443,.rtn)
"RTN","SYNKIDS",164,0)
 i rtn w "TLS/SSL client configured on Cache as config name 'encrypt_only'",!
"RTN","SYNKIDS",165,0)
 e  w "Cannot configure TLS/SSL on Cache",! s $ec=",u-cache-error,"
"RTN","SYNKIDS",166,0)
 QUIT
"RTN","SYNKIDS",167,0)
 ;
"RTN","SYNKIDS",168,0)
DOWNLOAD(URL) ; Download the files from Github
"RTN","SYNKIDS",169,0)
 D:$$CACHE DOWNCACH(URL)
"RTN","SYNKIDS",170,0)
 D:$$GTM DOWNGTM(URL)
"RTN","SYNKIDS",171,0)
 QUIT
"RTN","SYNKIDS",172,0)
 ;
"RTN","SYNKIDS",173,0)
DOWNCACH(URL) ; Download for Cache
"RTN","SYNKIDS",174,0)
 ; Download and save
"RTN","SYNKIDS",175,0)
 set httprequest=##class(%Net.HttpRequest).%New()
"RTN","SYNKIDS",176,0)
 if $e(URL,1,5)="https" do
"RTN","SYNKIDS",177,0)
 . set httprequest.Https=1
"RTN","SYNKIDS",178,0)
 . set httprequest.SSLConfiguration="encrypt_only"
"RTN","SYNKIDS",179,0)
 new server set server=$p(URL,"://",2),server=$p(server,"/")
"RTN","SYNKIDS",180,0)
 new port set port=$p(server,":",2)
"RTN","SYNKIDS",181,0)
 new filepath set filepath=$p(URL,"://",2),filepath=$p(filepath,"/",2,99)
"RTN","SYNKIDS",182,0)
 new filename set filename=$p(filepath,"/",$l(filepath,"/"))
"RTN","SYNKIDS",183,0)
 set httprequest.Server=server
"RTN","SYNKIDS",184,0)
 if port set httprequest.Port=port
"RTN","SYNKIDS",185,0)
 set httprequest.Timeout=5
"RTN","SYNKIDS",186,0)
 new status set status=httprequest.Get(filepath)
"RTN","SYNKIDS",187,0)
 new response set response=httprequest.HttpResponse.Data
"RTN","SYNKIDS",188,0)
 new sysfile set sysfile=##class(%Stream.FileBinary).%New()
"RTN","SYNKIDS",189,0)
 set status=sysfile.FilenameSet(filename)
"RTN","SYNKIDS",190,0)
 set status=sysfile.CopyFromAndSave(response)
"RTN","SYNKIDS",191,0)
 set status=sysfile.%Close()
"RTN","SYNKIDS",192,0)
 QUIT
"RTN","SYNKIDS",193,0)
 ;
"RTN","SYNKIDS",194,0)
DOWNGTM(URL) ; Download for GT.M
"RTN","SYNKIDS",195,0)
 N CMD S CMD="curl -s -L -O "_URL
"RTN","SYNKIDS",196,0)
 O "pipe":(shell="/bin/sh":command=CMD)::"pipe"
"RTN","SYNKIDS",197,0)
 U "pipe" C "pipe"
"RTN","SYNKIDS",198,0)
 QUIT
"RTN","SYNKIDS",199,0)
 ;
"RTN","SYNKIDS",200,0)
RIGTM(ROPATH,FF,GTMDIR) ; Silent Routine Input for GT.M
"RTN","SYNKIDS",201,0)
 ; ROPATH = full path to routine archive
"RTN","SYNKIDS",202,0)
 ; FF = Form Feed 1 = Yes 0 = No. Optional.
"RTN","SYNKIDS",203,0)
 ; GTMDIR = GTM directory in case gtmroutines is relative to current dir
"RTN","SYNKIDS",204,0)
 ;
"RTN","SYNKIDS",205,0)
 ; Check inputs
"RTN","SYNKIDS",206,0)
 I $ZPARSE(ROPATH)="" S $EC=",U-NO-SUCH-FILE,"
"RTN","SYNKIDS",207,0)
 S FF=$G(FF,0)
"RTN","SYNKIDS",208,0)
 ;
"RTN","SYNKIDS",209,0)
 ; Convert line endings from that other Mumps
"RTN","SYNKIDS",210,0)
 O "pipe":(shell="/bin/sh":command="perl -pi -e 's/\r\n?/\n/g' "_ROPATH:parse)::"pipe"
"RTN","SYNKIDS",211,0)
 U "pipe" C "pipe"
"RTN","SYNKIDS",212,0)
 ;
"RTN","SYNKIDS",213,0)
 ; Set end of routine
"RTN","SYNKIDS",214,0)
 N EOR
"RTN","SYNKIDS",215,0)
 I FF S EOR=$C(13,12)
"RTN","SYNKIDS",216,0)
 E  S EOR=""
"RTN","SYNKIDS",217,0)
 ;
"RTN","SYNKIDS",218,0)
 ; Get output directory
"RTN","SYNKIDS",219,0)
 N D D PARSEZRO(.D,$ZROUTINES)
"RTN","SYNKIDS",220,0)
 N OUTDIR S OUTDIR=$$ZRO1ST(.D)
"RTN","SYNKIDS",221,0)
 ;
"RTN","SYNKIDS",222,0)
 ; If output directory is relative, append GTM directory to it.
"RTN","SYNKIDS",223,0)
 I $E(OUTDIR)'="/" S OUTDIR=GTMDIR_OUTDIR
"RTN","SYNKIDS",224,0)
 ;
"RTN","SYNKIDS",225,0)
 ; Open use RO/RSA
"RTN","SYNKIDS",226,0)
 O ROPATH:(readonly:block=2048:record=2044:rewind):0 E  S $EC=",U-ERR-OPEN-FILE,"
"RTN","SYNKIDS",227,0)
 U ROPATH
"RTN","SYNKIDS",228,0)
 ;
"RTN","SYNKIDS",229,0)
 ; Discard first two lines
"RTN","SYNKIDS",230,0)
 N X,Y R X:0,Y:0
"RTN","SYNKIDS",231,0)
 ;
"RTN","SYNKIDS",232,0)
 F  D  Q:$ZEOF
"RTN","SYNKIDS",233,0)
 . ; Read routine info line
"RTN","SYNKIDS",234,0)
 . N RTNINFO R RTNINFO:0
"RTN","SYNKIDS",235,0)
 . Q:$ZEOF
"RTN","SYNKIDS",236,0)
 . ;
"RTN","SYNKIDS",237,0)
 . ; Routine Name is 1st piece
"RTN","SYNKIDS",238,0)
 . N RTNNAME S RTNNAME=$P(RTNINFO,"^")
"RTN","SYNKIDS",239,0)
 . ;
"RTN","SYNKIDS",240,0)
 . ; Check routine name
"RTN","SYNKIDS",241,0)
 . I RTNNAME="" QUIT
"RTN","SYNKIDS",242,0)
 . I RTNNAME'?1(1"%",1A).99AN S $EC=",U-INVALID-ROUTINE-NAME,"
"RTN","SYNKIDS",243,0)
 . ;
"RTN","SYNKIDS",244,0)
 . ; Path to save routine, and save
"RTN","SYNKIDS",245,0)
 . N SAVEPATH S SAVEPATH=OUTDIR_$TR(RTNNAME,"%","_")_".m"
"RTN","SYNKIDS",246,0)
 . O SAVEPATH:(newversion:noreadonly:blocksize=2048:recordsize=2044)
"RTN","SYNKIDS",247,0)
 . F  U ROPATH R Y:0 Q:Y=EOR  Q:$ZEOF  U SAVEPATH W $S(Y="":" ",1:Y),!
"RTN","SYNKIDS",248,0)
 . C SAVEPATH
"RTN","SYNKIDS",249,0)
 . ZL $TR(RTNNAME,"%","_"):"-nowarning"
"RTN","SYNKIDS",250,0)
 ;
"RTN","SYNKIDS",251,0)
 C ROPATH
"RTN","SYNKIDS",252,0)
 ;
"RTN","SYNKIDS",253,0)
 QUIT  ; Done
"RTN","SYNKIDS",254,0)
 ;
"RTN","SYNKIDS",255,0)
PARSEZRO(DIRS,ZRO) ; Parse $zroutines properly into an array
"RTN","SYNKIDS",256,0)
 ; Eat spaces
"RTN","SYNKIDS",257,0)
 F  Q:($E(ZRO)'=" ")  S ZRO=$E(ZRO,2,999)
"RTN","SYNKIDS",258,0)
 ;
"RTN","SYNKIDS",259,0)
 N PIECE
"RTN","SYNKIDS",260,0)
 N I
"RTN","SYNKIDS",261,0)
 F I=1:1:$L(ZRO," ") S PIECE(I)=$P(ZRO," ",I)
"RTN","SYNKIDS",262,0)
 N CNT S CNT=1
"RTN","SYNKIDS",263,0)
 F I=0:0 S I=$O(PIECE(I)) Q:'I  D
"RTN","SYNKIDS",264,0)
 . S DIRS(CNT)=$G(DIRS(CNT))_PIECE(I)
"RTN","SYNKIDS",265,0)
 . I DIRS(CNT)["("&(DIRS(CNT)[")") S CNT=CNT+1 QUIT
"RTN","SYNKIDS",266,0)
 . I DIRS(CNT)'["("&(DIRS(CNT)'[")") S CNT=CNT+1 QUIT
"RTN","SYNKIDS",267,0)
 . S DIRS(CNT)=DIRS(CNT)_" " ; prep for next piece
"RTN","SYNKIDS",268,0)
 QUIT
"RTN","SYNKIDS",269,0)
 ;
"RTN","SYNKIDS",270,0)
ZRO1ST(DIRS) ; $$ Get first routine directory
"RTN","SYNKIDS",271,0)
 ; TODO: Deal with .so.
"RTN","SYNKIDS",272,0)
 N OUT ; $$ return
"RTN","SYNKIDS",273,0)
 N %1 S %1=DIRS(1) ; 1st directory
"RTN","SYNKIDS",274,0)
 ; Parse with (...)
"RTN","SYNKIDS",275,0)
 I %1["(" DO
"RTN","SYNKIDS",276,0)
 . S OUT=$P(%1,"(",2)
"RTN","SYNKIDS",277,0)
 . I OUT[" " S OUT=$P(OUT," ")
"RTN","SYNKIDS",278,0)
 . E  S OUT=$P(OUT,")")
"RTN","SYNKIDS",279,0)
 ; no parens
"RTN","SYNKIDS",280,0)
 E  S OUT=%1
"RTN","SYNKIDS",281,0)
 ;
"RTN","SYNKIDS",282,0)
 ; Add trailing slash
"RTN","SYNKIDS",283,0)
 I $E(OUT,$L(OUT))'="/" S OUT=OUT_"/"
"RTN","SYNKIDS",284,0)
 QUIT OUT
"RTN","SYNKIDS",285,0)
 ;
"RTN","SYNKIDS",286,0)
RICACHE(ROPATH) ; Silent Routine Input for Cache
"RTN","SYNKIDS",287,0)
 D $SYSTEM.Process.SetZEOF(1) ; Cache stuff!!
"RTN","SYNKIDS",288,0)
 I $ZSEARCH(ROPATH)="" S $EC=",U-NO-SUCH-FILE,"
"RTN","SYNKIDS",289,0)
 N EOR S EOR=""
"RTN","SYNKIDS",290,0)
 ;
"RTN","SYNKIDS",291,0)
 ; Open using Stream Format (TERMs are CR/LF/FF)
"RTN","SYNKIDS",292,0)
 O ROPATH:("RS"):0 E  S $EC=",U-ERR-OPEN-FILE,"
"RTN","SYNKIDS",293,0)
 U ROPATH
"RTN","SYNKIDS",294,0)
 ;
"RTN","SYNKIDS",295,0)
 ; Discard first two lines
"RTN","SYNKIDS",296,0)
 N X,Y R X:2,Y:2
"RTN","SYNKIDS",297,0)
 ;
"RTN","SYNKIDS",298,0)
 F  D  Q:$ZEOF
"RTN","SYNKIDS",299,0)
 . ; Read routine info line
"RTN","SYNKIDS",300,0)
 . N RTNINFO R RTNINFO:2
"RTN","SYNKIDS",301,0)
 . Q:$ZEOF
"RTN","SYNKIDS",302,0)
 . ;
"RTN","SYNKIDS",303,0)
 . ; Routine Name is 1st piece
"RTN","SYNKIDS",304,0)
 . N RTNNAME S RTNNAME=$P(RTNINFO,"^")
"RTN","SYNKIDS",305,0)
 . ;
"RTN","SYNKIDS",306,0)
 . ; Check routine name
"RTN","SYNKIDS",307,0)
 . I RTNNAME="" QUIT
"RTN","SYNKIDS",308,0)
 . I RTNNAME'?1(1"%",1A).99AN S $EC=",U-INVALID-ROUTINE-NAME,"
"RTN","SYNKIDS",309,0)
 . ;
"RTN","SYNKIDS",310,0)
 . N RTNCODE,L S L=1
"RTN","SYNKIDS",311,0)
 . F  R Y:2 Q:Y=EOR  Q:$ZEOF  S RTNCODE(L)=Y,L=L+1
"RTN","SYNKIDS",312,0)
 . S RTNCODE(0)=L-1 ; required for Cache
"RTN","SYNKIDS",313,0)
 . D ROUTINE^%R(RTNNAME_".INT",.RTNCODE,.ERR,"CS",0)
"RTN","SYNKIDS",314,0)
 ;
"RTN","SYNKIDS",315,0)
 C ROPATH
"RTN","SYNKIDS",316,0)
 ;
"RTN","SYNKIDS",317,0)
 QUIT  ; Done
"RTN","SYNPRE1")
0^^B579511
"RTN","SYNPRE1",1,0)
SYNPRE1 ; HC/art - HealthConcourse - Pre Install for SYN*1.0*2 ;04/10/2019
"RTN","SYNPRE1",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNPRE1",3,0)
 ;;
"RTN","SYNPRE1",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNPRE1",5,0)
 ;
"RTN","SYNPRE1",6,0)
 QUIT
"RTN","SYNPRE1",7,0)
 ;
"RTN","SYNPRE1",8,0)
EN ;
"RTN","SYNPRE1",9,0)
 ;Delete the global for the NETSERV HTTP ENDPOINT file
"RTN","SYNPRE1",10,0)
 ;Standard data will be loaded
"RTN","SYNPRE1",11,0)
 ;
"RTN","SYNPRE1",12,0)
 KILL ^RGNET(996.52)
"RTN","SYNPRE1",13,0)
 SET ^RGNET(996.52,0)="NETSERV HTTP ENDPOINT^996.52^0^0"
"RTN","SYNPRE1",14,0)
 ;
"RTN","SYNPRE1",15,0)
 QUIT
"RTN","SYNPRE1",16,0)
 ;
"RTN","SYNQLDM")
0^45^B141739825
"RTN","SYNQLDM",1,0)
SYNQLDM ; GPL - QRDA loader entry routines ;2018-08-17  3:25 PM
"RTN","SYNQLDM",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNQLDM",3,0)
 ;
"RTN","SYNQLDM",4,0)
 ; Authored by George P. Lilly 2016-2018
"RTN","SYNQLDM",5,0)
 ;
"RTN","SYNQLDM",6,0)
 Q
"RTN","SYNQLDM",7,0)
 ;
"RTN","SYNQLDM",8,0)
INITMAPS        ; initialize maps 
"RTN","SYNQLDM",9,0)
 N G
"RTN","SYNQLDM",10,0)
 S G=$NA(^XTMP("SYNQLD","MAPS"))
"RTN","SYNQLDM",11,0)
 K @G
"RTN","SYNQLDM",12,0)
 N MAP
"RTN","SYNQLDM",13,0)
 ; SOP (payment?)
"RTN","SYNQLDM",14,0)
 S MAP="SOP"
"RTN","SYNQLDM",15,0)
 S @G@(MAP,"CODE","394","OTHER")=""
"RTN","SYNQLDM",16,0)
 ; race
"RTN","SYNQLDM",17,0)
 S MAP="race"
"RTN","SYNQLDM",18,0)
 S @G@(MAP,"CODE","1002-5","AMERICAN INDIAN OR ALASKA NATI")=""
"RTN","SYNQLDM",19,0)
 S @G@(MAP,"CODE","2028-9","ASIAN")=""
"RTN","SYNQLDM",20,0)
 S @G@(MAP,"CODE","2054-5","BLACK OR AFRICAN AMERICAN")=""
"RTN","SYNQLDM",21,0)
 S @G@(MAP,"CODE","2076-8","NATIVE HAWAIIAN OR OTHER PACIFIC ISLANDER")=""
"RTN","SYNQLDM",22,0)
 S @G@(MAP,"CODE","2106-3","WHITE")=""
"RTN","SYNQLDM",23,0)
 S @G@(MAP,"CODE","213101","DECLINED TO SPECIFY")=""
"RTN","SYNQLDM",24,0)
 S @G@(MAP,"CODE","9999-4","UNKNOWN BY PATIENT")=""
"RTN","SYNQLDM",25,0)
 ; ethnicity
"RTN","SYNQLDM",26,0)
 S MAP="ethnicity"
"RTN","SYNQLDM",27,0)
 S @G@(MAP,"CODE","21350-2","HISPANIC OR LATINO")=""
"RTN","SYNQLDM",28,0)
 S @G@(MAP,"CODE","2186-5","NOT HISPANIC OR LATINO")=""
"RTN","SYNQLDM",29,0)
 S @G@(MAP,"CODE","213101","DECLINED TO ANSWER")=""
"RTN","SYNQLDM",30,0)
 ; Health Factors - SNOMED
"RTN","SYNQLDM",31,0)
 S MAP="HF"
"RTN","SYNQLDM",32,0)
 S @G@(MAP,"CODE","4525004","ED [ARRIVAL-DEPARTURE] TIME")=""
"RTN","SYNQLDM",33,0)
 S @G@(MAP,"CODE","1748006","VTE COMFIRMED")=""
"RTN","SYNQLDM",34,0)
 S @G@(MAP,"CODE","10378005","TIME DECISION TO ADMIT MADE")=""
"RTN","SYNQLDM",35,0)
 S @G@(MAP,"CODE","225337009","SUICIDE RISK ASSESSMENT")=""
"RTN","SYNQLDM",36,0)
 S @G@(MAP,"CODE","428191000124101","DOCUMENTATION OF CURRENT MEDS")=""
"RTN","SYNQLDM",37,0)
 S @G@(MAP,"CODE","371530004","CLINICAL CONSULTATION REPORT")=""
"RTN","SYNQLDM",38,0)
 S @G@(MAP,"CODE","428171000124102","ADOLESCENT DEPRESSION SCREEN NEGATIVE")=""
"RTN","SYNQLDM",39,0)
 S @G@(MAP,"CODE","428231000124106","MATERNAL POSTPARTUM DEPRESSION CARE")=""
"RTN","SYNQLDM",40,0)
 S @G@(MAP,"CODE","428341000124108","MACULAR EDEMA ABSENT")=""
"RTN","SYNQLDM",41,0)
 S @G@(MAP,"CODE","193350004","MACULAR EDEMA PRESENT")=""
"RTN","SYNQLDM",42,0)
 S @G@(MAP,"CODE","417886001","TREATMENT ADJUSTED PER PROTOCOL")=""
"RTN","SYNQLDM",43,0)
 S @G@(MAP,"CODE","105480006","WRITTEN INFORMATION NOT GIVEN")=""
"RTN","SYNQLDM",44,0)
 S @G@(MAP,"CODE","413318004","WRITTEN INFORMATION GIVEN")=""
"RTN","SYNQLDM",45,0)
 S @G@(MAP,"CODE","226789007","BREAST MILK ADMINISTERED")=""
"RTN","SYNQLDM",46,0)
 S @G@(MAP,"CODE","105480006","PATIENT REFUSED TREATMENT")=""
"RTN","SYNQLDM",47,0)
 S @G@(MAP,"CODE","428171000124102","ADULT DEPRESSION SCREEN")=""
"RTN","SYNQLDM",48,0)
 S @G@(MAP,"CODE","183932001","PROCEDURE CONTRAINDICATED")=""
"RTN","SYNQLDM",49,0)
 ; Health Factors - LOINC
"RTN","SYNQLDM",50,0)
 S @G@(MAP,"CODE","38208-5","STANDARD PAIN ASSMNT TOOL")=""
"RTN","SYNQLDM",51,0)
 S @G@(MAP,"CODE","44249-1","PHQ-9 RESULT")=""
"RTN","SYNQLDM",52,0)
 S @G@(MAP,"CODE","71955-9","PROMIS-29: ")=""
"RTN","SYNQLDM",53,0)
 S @G@(MAP,"CODE","71938-5","MLHFQ")=""
"RTN","SYNQLDM",54,0)
 S @G@(MAP,"CODE","71955-9","PROMIS-29")=""
"RTN","SYNQLDM",55,0)
 S @G@(MAP,"CODE","58151-2","BIMS SCORE")=""
"RTN","SYNQLDM",56,0)
 S @G@(MAP,"CODE","73830-2","FALL RISK ASSESSMENT")=""
"RTN","SYNQLDM",57,0)
 S @G@(MAP,"CODE","73831-0","ADOLESCENT DEPRESSION SCREEN")=""
"RTN","SYNQLDM",58,0)
 S @G@(MAP,"CODE","73832-8","ADULT DEPRESSION SCREEN")=""
"RTN","SYNQLDM",59,0)
 S @G@(MAP,"CODE","69981-9","ASTHMA ACTION PLAN")=""
"RTN","SYNQLDM",60,0)
 ; Encounters - SNOMED
"RTN","SYNQLDM",61,0)
 S MAP="encounters"
"RTN","SYNQLDM",62,0)
 ;S @G@(MAP,"CODE","183452005","IP")=""
"RTN","SYNQLDM",63,0)
 S @G@(MAP,"CODE","185349003","OP")=""
"RTN","SYNQLDM",64,0)
 ;S @G@(MAP,"CODE","4525004","ER")=""
"RTN","SYNQLDM",65,0)
 ;S @G@(MAP,"CODE","10197000","PS")=""
"RTN","SYNQLDM",66,0)
 ;S @G@(MAP,"CODE","10378005","IP")=""
"RTN","SYNQLDM",67,0)
 S @G@(MAP,"CODE","108313002","OP")=""
"RTN","SYNQLDM",68,0)
 ;S @G@(MAP,"CODE","171047005","IO")=""
"RTN","SYNQLDM",69,0)
 ;S @G@(MAP,"CODE","32485007","IP")=""
"RTN","SYNQLDM",70,0)
 ;S @G@(MAP,"CODE","305351004","ICU")=""
"RTN","SYNQLDM",71,0)
 ;S @G@(MAP,"CODE","112689000","IP")=""
"RTN","SYNQLDM",72,0)
 ;S @G@(MAP,"CODE","8715000","IP")=""
"RTN","SYNQLDM",73,0)
 ; Encounters - CPT
"RTN","SYNQLDM",74,0)
 S @G@(MAP,"CODE","92002","OP")=""
"RTN","SYNQLDM",75,0)
 ;S @G@(MAP,"CODE","96150","PS")=""
"RTN","SYNQLDM",76,0)
 S @G@(MAP,"CODE","99201","OP")=""
"RTN","SYNQLDM",77,0)
 ;S @G@(MAP,"CODE","99285","ER")=""
"RTN","SYNQLDM",78,0)
 ;S @G@(MAP,"CODE","90791","PS")=""
"RTN","SYNQLDM",79,0)
 S @G@(MAP,"CODE","99202","OP")=""
"RTN","SYNQLDM",80,0)
 ;S @G@(MAP,"CODE","99285","ER")=""
"RTN","SYNQLDM",81,0)
 S @G@(MAP,"CODE","99381","OP")=""
"RTN","SYNQLDM",82,0)
 ; location
"RTN","SYNQLDM",83,0)
 S MAP="location"
"RTN","SYNQLDM",84,0)
 ;S @G@(MAP,"CODE","OP","CLINIC A")=""
"RTN","SYNQLDM",85,0)
 ;S @G@(MAP,"CODE","OP","VISTA HEALTH CARE")=""
"RTN","SYNQLDM",86,0)
 S @G@(MAP,"CODE","OP","GENERAL MEDICINE")=""
"RTN","SYNQLDM",87,0)
 S @G@(MAP,"CODE","ER","EMERGENCY DEPT")=""
"RTN","SYNQLDM",88,0)
 S @G@(MAP,"CODE","IP","CERT MED SURG")=""
"RTN","SYNQLDM",89,0)
 S @G@(MAP,"CODE","ICU","CERT ICU")=""
"RTN","SYNQLDM",90,0)
 S @G@(MAP,"CODE","PS","CLINIC A")=""
"RTN","SYNQLDM",91,0)
 ; roombed
"RTN","SYNQLDM",92,0)
 S MAP="roombed"
"RTN","SYNQLDM",93,0)
 S @G@(MAP,"CODE","IP","M1-A")=""
"RTN","SYNQLDM",94,0)
 S @G@(MAP,"CODE","ICU","1-A")=""
"RTN","SYNQLDM",95,0)
 S @G@(MAP,"CODE","PS","CLINIC PSYCHIATRY")=""
"RTN","SYNQLDM",96,0)
 ; provider
"RTN","SYNQLDM",97,0)
 S MAP="provider"
"RTN","SYNQLDM",98,0)
 ;S @G@(MAP,"CODE","OP","CQM,HISTORICAL MD")=""
"RTN","SYNQLDM",99,0)
 ;S @G@(MAP,"CODE","OP","USER,THREE")=""
"RTN","SYNQLDM",100,0)
 S @G@(MAP,"CODE","OP","9990000348")=""
"RTN","SYNQLDM",101,0)
 S @G@(MAP,"CODE","ER","CQM,HISTORICAL MD")=""
"RTN","SYNQLDM",102,0)
 S @G@(MAP,"CODE","IP","CQM,HISTORICAL MD")=""
"RTN","SYNQLDM",103,0)
 S @G@(MAP,"CODE","ICU","CQM,HISTORICAL MD")=""
"RTN","SYNQLDM",104,0)
 S @G@(MAP,"CODE","PS","CQM,HISTORICAL MD")=""
"RTN","SYNQLDM",105,0)
 ; admitting regulation
"RTN","SYNQLDM",106,0)
 S MAP="regs"
"RTN","SYNQLDM",107,0)
 S @G@(MAP,"CODE","IP","OBSERVATION (AND) EXAMINATION")=""
"RTN","SYNQLDM",108,0)
 S @G@(MAP,"CODE","ICU","OBSERVATION (AND) EXAMINATION")=""
"RTN","SYNQLDM",109,0)
 ; facility treating speciality
"RTN","SYNQLDM",110,0)
 S MAP="facilityTreatingSpeciality"
"RTN","SYNQLDM",111,0)
 S @G@(MAP,"CODE","IP","MEDICAL OBSERVATION")=""
"RTN","SYNQLDM",112,0)
 S @G@(MAP,"CODE","ICU","MEDICAL OBSERVATION")=""
"RTN","SYNQLDM",113,0)
 ; discharge type
"RTN","SYNQLDM",114,0)
 S MAP="dischargeType"
"RTN","SYNQLDM",115,0)
 S @G@(MAP,"CODE","10161009","DISCHARGE TO HOME OR POLICE CU")=""
"RTN","SYNQLDM",116,0)
 ; vitals
"RTN","SYNQLDM",117,0)
 S MAP="vitals"
"RTN","SYNQLDM",118,0)
 S @G@(MAP,"CODE","8462-4","BLOOD PRESSURE")=""
"RTN","SYNQLDM",119,0)
 S @G@(MAP,"CODE","8480-6","BLOOD PRESSURE")=""
"RTN","SYNQLDM",120,0)
 S @G@(MAP,"CODE","39156-5","BMI")=""
"RTN","SYNQLDM",121,0)
 ; VPatientEd
"RTN","SYNQLDM",122,0)
 S MAP="vPatientEd"
"RTN","SYNQLDM",123,0)
 S @G@(MAP,"CODE","11816003","DIET EDUCATION")=""
"RTN","SYNQLDM",124,0)
 S @G@(MAP,"CODE","171047005","DRUGS OF ADDICTION EDUCATION")=""
"RTN","SYNQLDM",125,0)
 ; consults
"RTN","SYNQLDM",126,0)
 S MAP="consults"
"RTN","SYNQLDM",127,0)
 S @G@(MAP,"CODE","103697008","DENTAL")=""
"RTN","SYNQLDM",128,0)
 S @G@(MAP,"CODE","171047005","PHYSICAL REHAB")=""
"RTN","SYNQLDM",129,0)
 ; rad orders - LOINC
"RTN","SYNQLDM",130,0)
 S MAP="rad"
"RTN","SYNQLDM",131,0)
 S @G@(MAP,"CODE","24533-2","ABDOMINAL VESSELS MRI ANGIOGRAM W/CON  IV")=""
"RTN","SYNQLDM",132,0)
 S @G@(MAP,"CODE","24604-1","BREAST MAMMOGRAM DIAGNOSTIC LIMITED")=""
"RTN","SYNQLDM",133,0)
 S @G@(MAP,"CODE","25031-6","BONE SCAN")=""
"RTN","SYNQLDM",134,0)
 S @G@(MAP,"CODE","24665-2","SACRUM AND COCCYX X-RAY")=""
"RTN","SYNQLDM",135,0)
 ; rad orders - SNOMED
"RTN","SYNQLDM",136,0)
 S @G@(MAP,"CODE","113094008","DIAGNOSTIC RADIOGRAPHY OF CHEST, LATERAL")=""
"RTN","SYNQLDM",137,0)
 S @G@(MAP,"CODE","168731009","CHEST XRAY")=""
"RTN","SYNQLDM",138,0)
 S @G@(MAP,"CODE","1748006","VTE Confirmed.")=""
"RTN","SYNQLDM",139,0)
 ; immunizations - CVX
"RTN","SYNQLDM",140,0)
 S MAP="immunizations"
"RTN","SYNQLDM",141,0)
 S @G@(MAP,"CODE","3","MEASLES,MUMPS,RUBELLA (MMR)")=""
"RTN","SYNQLDM",142,0)
 S @G@(MAP,"CODE","8","HEPATITIS B")=""
"RTN","SYNQLDM",143,0)
 S @G@(MAP,"CODE","10","POLIOMYELITIS")=""
"RTN","SYNQLDM",144,0)
 S @G@(MAP,"CODE","20","DIP-TET-a/PERT")=""
"RTN","SYNQLDM",145,0)
 S @G@(MAP,"CODE","21","VARICELLA")=""
"RTN","SYNQLDM",146,0)
 S @G@(MAP,"CODE","33","PNEUMOCOCCAL CONJUGATE PCV23")=""
"RTN","SYNQLDM",147,0)
 S @G@(MAP,"CODE","48","HIB,PRP-T")=""
"RTN","SYNQLDM",148,0)
 S @G@(MAP,"CODE","83","HEPA,PED/ADOL-2")=""
"RTN","SYNQLDM",149,0)
 S @G@(MAP,"CODE","104","HEPA/HEPB ADULT")=""
"RTN","SYNQLDM",150,0)
 S @G@(MAP,"CODE","111","FLU,NASAL")=""
"RTN","SYNQLDM",151,0)
 S @G@(MAP,"CODE","116","ROTOVIRUS,ORAL")=""
"RTN","SYNQLDM",152,0)
 S @G@(MAP,"CODE","140","INFLUENZA")=""
"RTN","SYNQLDM",153,0)
 ; immunizations - SNOMED
"RTN","SYNQLDM",154,0)
 S @G@(MAP,"CODE","442333005","INFLUENZA")=""
"RTN","SYNQLDM",155,0)
 ; VExam LOINC
"RTN","SYNQLDM",156,0)
 S MAP="vExam"
"RTN","SYNQLDM",157,0)
 S @G@(MAP,"CODE","24604-1","MAMMOGRAM")=""
"RTN","SYNQLDM",158,0)
 S @G@(MAP,"CODE","32451-7","MACULAR EXAM")=""
"RTN","SYNQLDM",159,0)
 S @G@(MAP,"CODE","44249-1","PHQ-9 RESULT")=""
"RTN","SYNQLDM",160,0)
 S @G@(MAP,"CODE","54108-6","NEONATAL HEARING EXAM")=""
"RTN","SYNQLDM",161,0)
 S @G@(MAP,"CODE","54109-4","NEONATAL HEARING EXAM")=""
"RTN","SYNQLDM",162,0)
 S @G@(MAP,"CODE","57254-5","FALL RISK ASSESSMENT")=""
"RTN","SYNQLDM",163,0)
 S @G@(MAP,"CODE","58151-2","BIMS SCORE")=""
"RTN","SYNQLDM",164,0)
 S @G@(MAP,"CODE","65853-4","CARDIOVASCULAR RISK")=""
"RTN","SYNQLDM",165,0)
 S @G@(MAP,"CODE","71484-0","CUP TO DISK RATIO EXAM")=""
"RTN","SYNQLDM",166,0)
 S @G@(MAP,"CODE","71486-5","OPTIC DISK EXAM")=""
"RTN","SYNQLDM",167,0)
 S @G@(MAP,"CODE","71938-5","MLHFQ")=""
"RTN","SYNQLDM",168,0)
 S @G@(MAP,"CODE","71955-9","PROMIS-29:")=""
"RTN","SYNQLDM",169,0)
 S @G@(MAP,"CODE","73831-0","ADOLESCENT DEPRESSION SCREEN NEGATIVE")=""
"RTN","SYNQLDM",170,0)
 ; VExam - SNOMED
"RTN","SYNQLDM",171,0)
 S @G@(MAP,"CODE","225337009","SUICIDE RISK ASSESSMENT")=""
"RTN","SYNQLDM",172,0)
 S @G@(MAP,"CODE","91161007","PULSE FOOT EXAM")=""
"RTN","SYNQLDM",173,0)
 S @G@(MAP,"CODE","134388005","DIABETIC FOOT EXAM")=""
"RTN","SYNQLDM",174,0)
 S @G@(MAP,"CODE","252779009","DILATED EYE EXAM")=""
"RTN","SYNQLDM",175,0)
 S @G@(MAP,"CODE","401191002","DIABETIC FOOT CHECK")=""
"RTN","SYNQLDM",176,0)
 S @G@(MAP,"CODE","419775003","VISION EXAM")=""
"RTN","SYNQLDM",177,0)
 S @G@(MAP,"CODE","412726003","LENGTH OF GESTATION AT BIRTH")=""
"RTN","SYNQLDM",178,0)
 S @G@(MAP,"CODE","44413500","ESTIMATED FETAL GESTATIONAL AGE")=""
"RTN","SYNQLDM",179,0)
 S @G@(MAP,"CODE","417491009","NEONATAL HEARING EXAM")=""
"RTN","SYNQLDM",180,0)
 ; VCPT - CPT
"RTN","SYNQLDM",181,0)
 S MAP="vCPT"
"RTN","SYNQLDM",182,0)
 S @G@(MAP,"CODE","99201","OP")=""
"RTN","SYNQLDM",183,0)
 S @G@(MAP,"CODE","90791","PS")=""
"RTN","SYNQLDM",184,0)
 S @G@(MAP,"CODE","99202","OP")=""
"RTN","SYNQLDM",185,0)
 S @G@(MAP,"CODE","99381","OP")=""
"RTN","SYNQLDM",186,0)
 ; VCPT - SNOMED
"RTN","SYNQLDM",187,0)
 S MAP="sct2cpt"
"RTN","SYNQLDM",188,0)
 ;S @G@(MAP,"CODE","394701000","99241")=""
"RTN","SYNQLDM",189,0)
 ;S @G@(MAP,"CODE","170258001","99382")=""
"RTN","SYNQLDM",190,0)
 ;S @G@(MAP,"CODE","371883000","99201")=""
"RTN","SYNQLDM",191,0)
 ;S @G@(MAP,"CODE","185347001","99201")=""
"RTN","SYNQLDM",192,0)
 ;S @G@(MAP,"COD,E""183478001","99381")=""
"RTN","SYNQLDM",193,0)
 ;S @G@(MAP,"CODE","308646001","99238")=""
"RTN","SYNQLDM",194,0)
 S @G@(MAP,"CODE","424441002","59426")=""
"RTN","SYNQLDM",195,0)
 S @G@(MAP,"CODE","183460006","99218")=""
"RTN","SYNQLDM",196,0)
 S @G@(MAP,"CODE","698314001","99241")=""
"RTN","SYNQLDM",197,0)
 S @G@(MAP,"CODE","424619006","59425")=""
"RTN","SYNQLDM",198,0)
 ;S @G@(MAP,"CODE","50849002","99281")=""
"RTN","SYNQLDM",199,0)
 ;S @G@(MAP,"CODE","185345009","99213")=""
"RTN","SYNQLDM",200,0)
 ;S @G@(MAP,"CODE","170258001","99383")=""
"RTN","SYNQLDM",201,0)
 S @G@(MAP,"CODE","10492003","55810")=""
"RTN","SYNQLDM",202,0)
 S @G@(MAP,"CODE","84755001","77427")=""
"RTN","SYNQLDM",203,0)
 S @G@(MAP,"CODE","234723000","D1206")=""
"RTN","SYNQLDM",204,0)
 S @G@(MAP,"CODE","10745001","59400")=""
"RTN","SYNQLDM",205,0)
 S @G@(MAP,"CODE","10178000","66840")=""
"RTN","SYNQLDM",206,0)
 S @G@(MAP,"CODE","105355005","99408")=""
"RTN","SYNQLDM",207,0)
 S @G@(MAP,"CODE","12350003","44388")=""
"RTN","SYNQLDM",208,0)
 S @G@(MAP,"CODE","15163009","27130")=""
"RTN","SYNQLDM",209,0)
 S @G@(MAP,"CODE","177184002","59409")=""
"RTN","SYNQLDM",210,0)
 S @G@(MAP,"CODE","179344006","27447")=""
"RTN","SYNQLDM",211,0)
 S @G@(MAP,"CODE","13767004","65235")=""
"RTN","SYNQLDM",212,0)
 S @G@(MAP,"CODE","108241001","90937")=""
"RTN","SYNQLDM",213,0)
 ;S @G@(MAP,"CODE","185349003","99202")=""
"RTN","SYNQLDM",214,0)
 S @G@(MAP,"CODE","442333005","90653")=""
"RTN","SYNQLDM",215,0)
 S @G@(MAP,"CODE","444783004","45378")=""
"RTN","SYNQLDM",216,0)
 S @G@(MAP,"CODE","4525004","99285")=""
"RTN","SYNQLDM",217,0)
 ;S @G@(MAP,"CODE","185349003","99381")=""
"RTN","SYNQLDM",218,0)
 ; labs
"RTN","SYNQLDM",219,0)
 S MAP="labs"
"RTN","SYNQLDM",220,0)
 S @G@(MAP,"CODE","2085-9","HDL CHOLESTEROL")=""
"RTN","SYNQLDM",221,0)
 S @G@(MAP,"CODE","34714-6","PT/INR")=""
"RTN","SYNQLDM",222,0)
 S @G@(MAP,"CODE","2093-3","CHOLESTEROL, TOTAL")=""
"RTN","SYNQLDM",223,0)
 S @G@(MAP,"CODE","12773-8","LDL CHOLESTEROL")=""
"RTN","SYNQLDM",224,0)
 S @G@(MAP,"CODE","13457-7","LDL CHOLESTEROL")=""
"RTN","SYNQLDM",225,0)
 S @G@(MAP,"CODE","13056-7","PLATELET COUNT")=""
"RTN","SYNQLDM",226,0)
 S @G@(MAP,"CODE","10524-7","PAP TEST")=""
"RTN","SYNQLDM",227,0)
 S @G@(MAP,"CODE","17856-6","HEMOGLOBIN A1C")=""
"RTN","SYNQLDM",228,0)
 S @G@(MAP,"CODE","17855-8","HEMOGLOBIN A1C")=""
"RTN","SYNQLDM",229,0)
 S @G@(MAP,"CODE","10508-0","PSA")=""
"RTN","SYNQLDM",230,0)
 S @G@(MAP,"CODE","10351-5","HIV 1 RNA")=""
"RTN","SYNQLDM",231,0)
 S @G@(MAP,"CODE","35266-6","GLEASON SCORE")=""
"RTN","SYNQLDM",232,0)
 S @G@(MAP,"CODE","24467-3","CD4 COUNT")=""
"RTN","SYNQLDM",233,0)
 S @G@(MAP,"CODE","20447-9","HIV 1 RNA")=""
"RTN","SYNQLDM",234,0)
 S @G@(MAP,"CODE","19080-1","PREGNANCY TEST")=""
"RTN","SYNQLDM",235,0)
 S @G@(MAP,"CODE","10674-0","HEPATITIS B SURFACE ANTIGEN")=""
"RTN","SYNQLDM",236,0)
 S @G@(MAP,"CODE","2093-3","CHOLESTEROL, TOTAL")=""
"RTN","SYNQLDM",237,0)
 S @G@(MAP,"CODE","12951-0","TRIGLYCERIDES")=""
"RTN","SYNQLDM",238,0)
 S @G@(MAP,"CODE","11268-0","STREPTOZYME")=""
"RTN","SYNQLDM",239,0)
 S @G@(MAP,"CODE","13217-5","CHLAMYDIA CULTURE")=""
"RTN","SYNQLDM",240,0)
 S @G@(MAP,"CODE","14463-4","CHLAMYDIA CULTURE")=""
"RTN","SYNQLDM",241,0)
 ; gmr allergies snomed to vuid
"RTN","SYNQLDM",242,0)
 S MAP="gmr-allergies"
"RTN","SYNQLDM",243,0)
 S @G@(MAP,"CODE",419474003,4636980)=""
"RTN","SYNQLDM",244,0)
 S @G@(MAP,"CODE",232347008,4637420)=""
"RTN","SYNQLDM",245,0)
 S @G@(MAP,"CODE",419263009,4636804)=""
"RTN","SYNQLDM",246,0)
 S @G@(MAP,"CODE",418689008,4637448)=""
"RTN","SYNQLDM",247,0)
 ;S @G@(MAP,"CODE",232350006) ; MITE POLEN
"RTN","SYNQLDM",248,0)
 S @G@(MAP,"CODE",300913006,4636953)=""
"RTN","SYNQLDM",249,0)
 S @G@(MAP,"CODE",424213003,4637407)=""
"RTN","SYNQLDM",250,0)
 S @G@(MAP,"CODE",91935009,4636971)=""
"RTN","SYNQLDM",251,0)
 S @G@(MAP,"CODE",91934008,4636976)=""
"RTN","SYNQLDM",252,0)
 S @G@(MAP,"CODE",417532002,4637301)=""
"RTN","SYNQLDM",253,0)
 S @G@(MAP,"CODE",300916003,4538971)=""
"RTN","SYNQLDM",254,0)
 S @G@(MAP,"CODE",91930004,4637287)=""
"RTN","SYNQLDM",255,0)
 S @G@(MAP,"CODE",420174000,4637435)=""
"RTN","SYNQLDM",256,0)
 S @G@(MAP,"CODE",425525006,4636665)=""
"RTN","SYNQLDM",257,0)
 S @G@(MAP,"CODE",714035009,4636951)=""
"RTN","SYNQLDM",258,0)
 ; rxnorm to vuid
"RTN","SYNQLDM",259,0)
 S MAP="rxnorm"
"RTN","SYNQLDM",260,0)
 S @G@(MAP,"CODE",1000097,4002480)=""
"RTN","SYNQLDM",261,0)
 S @G@(MAP,"CODE",313585,4012182)=""
"RTN","SYNQLDM",262,0)
 S @G@(MAP,"CODE",314153,4013783)=""
"RTN","SYNQLDM",263,0)
 S @G@(MAP,"CODE",692876,4025906)=""
"RTN","SYNQLDM",264,0)
 S @G@(MAP,"CODE",577154,4025018)=""
"RTN","SYNQLDM",265,0)
 S @G@(MAP,"CODE",860215,4003764)=""
"RTN","SYNQLDM",266,0)
 S @G@(MAP,"CODE",860221,4003765)=""
"RTN","SYNQLDM",267,0)
 S @G@(MAP,"CODE",151226,4024528)=""
"RTN","SYNQLDM",268,0)
 S @G@(MAP,"CODE",198029,4010104)=""
"RTN","SYNQLDM",269,0)
 S @G@(MAP,"CODE",198030,4010106)=""
"RTN","SYNQLDM",270,0)
 S @G@(MAP,"CODE",198031,4010105)=""
"RTN","SYNQLDM",271,0)
 S @G@(MAP,"CODE",198045,4001216)=""
"RTN","SYNQLDM",272,0)
 S @G@(MAP,"CODE",198046,4001218)=""
"RTN","SYNQLDM",273,0)
 S @G@(MAP,"CODE",198047,4001215)=""
"RTN","SYNQLDM",274,0)
 S @G@(MAP,"CODE",199888,4013030)=""
"RTN","SYNQLDM",275,0)
 S @G@(MAP,"CODE",199889,4013031)=""
"RTN","SYNQLDM",276,0)
 S @G@(MAP,"CODE",199890,4013032)=""
"RTN","SYNQLDM",277,0)
 S @G@(MAP,"CODE",205315,4013343)=""
"RTN","SYNQLDM",278,0)
 S @G@(MAP,"CODE",205316,4013342)=""
"RTN","SYNQLDM",279,0)
 S @G@(MAP,"CODE",250983,4013568)=""
"RTN","SYNQLDM",280,0)
 S @G@(MAP,"CODE",311975,4005637)=""
"RTN","SYNQLDM",281,0)
 S @G@(MAP,"CODE",312036,4001214)=""
"RTN","SYNQLDM",282,0)
 S @G@(MAP,"CODE",314119,4005636)=""
"RTN","SYNQLDM",283,0)
 S @G@(MAP,"CODE",317136,4001217)=""
"RTN","SYNQLDM",284,0)
 S @G@(MAP,"CODE",359817,4016739)=""
"RTN","SYNQLDM",285,0)
 S @G@(MAP,"CODE",359818,4016738)=""
"RTN","SYNQLDM",286,0)
 S @G@(MAP,"CODE",636671,4025534)=""
"RTN","SYNQLDM",287,0)
 S @G@(MAP,"CODE",636676,4025535)=""
"RTN","SYNQLDM",288,0)
 S @G@(MAP,"CODE",749289,4025532)=""
"RTN","SYNQLDM",289,0)
 S @G@(MAP,"CODE",749788,4025533)=""
"RTN","SYNQLDM",290,0)
 S @G@(MAP,"CODE",896100,4010112)=""
"RTN","SYNQLDM",291,0)
 S @G@(MAP,"CODE",966531,4017048)=""
"RTN","SYNQLDM",292,0)
 S @G@(MAP,"CODE",993503,4016940)=""
"RTN","SYNQLDM",293,0)
 S @G@(MAP,"CODE",993518,4017073)=""
"RTN","SYNQLDM",294,0)
 S @G@(MAP,"CODE",993536,4024749)=""
"RTN","SYNQLDM",295,0)
 S @G@(MAP,"CODE",993541,4026567)=""
"RTN","SYNQLDM",296,0)
 S @G@(MAP,"CODE",993550,4029871)=""
"RTN","SYNQLDM",297,0)
 S @G@(MAP,"CODE",993557,4026568)=""
"RTN","SYNQLDM",298,0)
 S @G@(MAP,"CODE",993567,4029870)=""
"RTN","SYNQLDM",299,0)
 S @G@(MAP,"CODE",993681,4029872)=""
"RTN","SYNQLDM",300,0)
 S @G@(MAP,"CODE",998671,4002473)=""
"RTN","SYNQLDM",301,0)
 S @G@(MAP,"CODE",998675,4002474)=""
"RTN","SYNQLDM",302,0)
 S @G@(MAP,"CODE",998679,4002475)=""
"RTN","SYNQLDM",303,0)
 N ZI
"RTN","SYNQLDM",304,0)
 S ZI=""
"RTN","SYNQLDM",305,0)
 F  S ZI=$O(@G@(ZI)) Q:ZI=""  D  ;
"RTN","SYNQLDM",306,0)
 . N ZJ S ZJ=""
"RTN","SYNQLDM",307,0)
 . F  S ZJ=$O(@G@(ZI,"CODE",ZJ)) Q:ZJ=""  D  ;
"RTN","SYNQLDM",308,0)
 . . N VAL
"RTN","SYNQLDM",309,0)
 . . S VAL=$O(@G@(ZI,"CODE",ZJ,""))
"RTN","SYNQLDM",310,0)
 . . S @G@(ZI,"VALUE",VAL,ZJ)=""
"RTN","SYNQLDM",311,0)
 . . S @G@("CODE",ZJ,VAL,ZI)=""
"RTN","SYNQLDM",312,0)
 . . S @G@("VALUE",VAL,ZJ,ZI)=""
"RTN","SYNQLDM",313,0)
 Q
"RTN","SYNQLDM",314,0)
 ;
"RTN","SYNQLDM",315,0)
MAP(CDE,MAP)    ; extrinsic returns the Value for the Code in map MAP, which is optional
"RTN","SYNQLDM",316,0)
 N RTN
"RTN","SYNQLDM",317,0)
 N GN S GN=$NA(^XTMP("SYNQLD","MAPS"))
"RTN","SYNQLDM",318,0)
 I '$D(@GN) D INITMAPS
"RTN","SYNQLDM",319,0)
 I $G(CDE)="" Q ""
"RTN","SYNQLDM",320,0)
 I $G(MAP)="" D  Q RTN
"RTN","SYNQLDM",321,0)
 . S RTN=$O(@GN@("CODE",CDE,""))
"RTN","SYNQLDM",322,0)
 I '$D(@GN@(MAP)) S RTN="" Q RTN  ;
"RTN","SYNQLDM",323,0)
 S RTN=$O(@GN@(MAP,"CODE",CDE,""))
"RTN","SYNQLDM",324,0)
 I $O(@GN@(MAP,"CODE",CDE,RTN))'="" S RTN=-1 ; more than one match
"RTN","SYNQLDM",325,0)
 Q RTN
"RTN","SYNQLDM",326,0)
 ;
"RTN","SYNQLDM",327,0)
UNMAP(VAL,MAP)  ; extrinsic returns the Value for the Code in map MAP, which is optional
"RTN","SYNQLDM",328,0)
 N RTN
"RTN","SYNQLDM",329,0)
 N GN S GN=$NA(^XTMP("SYNQLD","MAPS"))
"RTN","SYNQLDM",330,0)
 I '$D(MAP) D  Q RTN
"RTN","SYNQLDM",331,0)
 . S RTN=$O(@GN@("VALUE",VAL,""))
"RTN","SYNQLDM",332,0)
 I '$D(@GN@(MAP)) S RTN="" Q  ;
"RTN","SYNQLDM",333,0)
 S RTN=$O(@GN@(MAP,"VALUE",VAL,""))
"RTN","SYNQLDM",334,0)
 I $O(@GN@(MAP,"VALUE",VAL,RTN))'="" S RTN=-1 ; more than one match
"RTN","SYNQLDM",335,0)
 Q RTN
"RTN","SYNQLDM",336,0)
 ;
"RTN","SYNQLDM",337,0)
GETMAP(RTN,MAP) ; returns an array of the MAP. if MAP is not specified, it returns an
"RTN","SYNQLDM",338,0)
 ; array of the names of all the maps
"RTN","SYNQLDM",339,0)
 N GN S GN=$NA(^XTMP("SYNQLD","MAPS"))
"RTN","SYNQLDM",340,0)
 I '$D(MAP) D  Q  ;
"RTN","SYNQLDM",341,0)
 . N ZI S ZI=""
"RTN","SYNQLDM",342,0)
 . F  S ZI=$O(@GN@(ZI)) Q:ZI=""  D  ;
"RTN","SYNQLDM",343,0)
 . . Q:ZI="CODE"
"RTN","SYNQLDM",344,0)
 . . Q:ZI="VALUE"
"RTN","SYNQLDM",345,0)
 . . S @RTN@(ZI)=""
"RTN","SYNQLDM",346,0)
 I $D(@GN@(MAP)) M @RTN=@GN@(MAP)
"RTN","SYNQLDM",347,0)
 Q
"RTN","SYNQLDM",348,0)
 ;
"RTN","SYNQLDM",349,0)
MAPERR(CDE,MAP,CMT) ; add the map error to the mapping-errors graph
"RTN","SYNQLDM",350,0)
 n meroot s meroot=$$setroot^%wd("mapping-errors") 
"RTN","SYNQLDM",351,0)
 q:meroot=""
"RTN","SYNQLDM",352,0)
 n meien
"RTN","SYNQLDM",353,0)
 s meien=$o(@meroot@("errors","B",CDE,""))
"RTN","SYNQLDM",354,0)
 i meien="" d  ;
"RTN","SYNQLDM",355,0)
 . s meien=$o(@meroot@("errors"," "),-1)+1
"RTN","SYNQLDM",356,0)
 . s @meroot@("errors",meien,"code")=CDE
"RTN","SYNQLDM",357,0)
 . s @meroot@("errors","B",CDE,meien)=""
"RTN","SYNQLDM",358,0)
 s @meroot@("errors",meien,"map")=$g(MAP)
"RTN","SYNQLDM",359,0)
 i $g(CMT)'="" s @meroot@("errors",meien,"comment")=CMT
"RTN","SYNQLDM",360,0)
 s @meroot@("errors",meien,"count")=$g(@meroot@("errors",meien,"count"))+1
"RTN","SYNQLDM",361,0)
 q
"RTN","SYNQLDM",362,0)
 ;
"RTN","SYNQOS5")
0^75^B31765838
"RTN","SYNQOS5",1,0)
SYNQOS5 ;ven/gpl - fhir loader utilities ;2018-08-17  3:28 PM
"RTN","SYNQOS5",2,0)
 ;;0.1;VISTA SYNTHETIC DATA LOADER;;Aug 17, 2018;Build 53
"RTN","SYNQOS5",3,0)
 ;
"RTN","SYNQOS5",4,0)
 ; Authored by George P. Lilly 2017-2018
"RTN","SYNQOS5",5,0)
 ;
"RTN","SYNQOS5",6,0)
 q
"RTN","SYNQOS5",7,0)
 ;
"RTN","SYNQOS5",8,0)
 ; this routine initializes the Snomed to OS5 code map
"RTN","SYNQOS5",9,0)
 ; it assumes that the graph for the OS5 codes is in graph "OS5procedureCodes"
"RTN","SYNQOS5",10,0)
 ; it will break and not continue if that graph is not found
"RTN","SYNQOS5",11,0)
 ;
"RTN","SYNQOS5",12,0)
ctrl ; ingest mappings
"RTN","SYNQOS5",13,0)
 ;
"RTN","SYNQOS5",14,0)
 n mapfil
"RTN","SYNQOS5",15,0)
 s mapfil=$na(^SYN("2002.030","sct2os5"))
"RTN","SYNQOS5",16,0)
 k @mapfil
"RTN","SYNQOS5",17,0)
 d init1
"RTN","SYNQOS5",18,0)
 d build
"RTN","SYNQOS5",19,0)
 d init2
"RTN","SYNQOS5",20,0)
 d build
"RTN","SYNQOS5",21,0)
 q
"RTN","SYNQOS5",22,0)
 ;
"RTN","SYNQOS5",23,0)
init1 ; initiate variables
"RTN","SYNQOS5",24,0)
 s n=0,U="^"
"RTN","SYNQOS5",25,0)
 s root=$$setroot^%wd("procedure-codes")
"RTN","SYNQOS5",26,0)
 b:root=""
"RTN","SYNQOS5",27,0)
 s root=$na(@root@("procedure-codes"))
"RTN","SYNQOS5",28,0)
 s map="sct2os5" ; map identifier
"RTN","SYNQOS5",29,0)
 s mapfil=$na(^SYN("2002.030",map))
"RTN","SYNQOS5",30,0)
 ;
"RTN","SYNQOS5",31,0)
 ; initiate mapping file data 
"RTN","SYNQOS5",32,0)
 ;k @mapfil@("direct"),@mapfil@("inverse")
"RTN","SYNQOS5",33,0)
 q
"RTN","SYNQOS5",34,0)
 ;
"RTN","SYNQOS5",35,0)
init2 ; initiate variables
"RTN","SYNQOS5",36,0)
 s n=0,U="^"
"RTN","SYNQOS5",37,0)
 s root=$$setroot^%wd("visit-codes")
"RTN","SYNQOS5",38,0)
 b:root=""
"RTN","SYNQOS5",39,0)
 s root=$na(@root@("visit-codes"))
"RTN","SYNQOS5",40,0)
 s map="sct2os5" ; map identifier
"RTN","SYNQOS5",41,0)
 s mapfil=$na(^SYN("2002.030",map))
"RTN","SYNQOS5",42,0)
 ;
"RTN","SYNQOS5",43,0)
 ; initiate mapping file data 
"RTN","SYNQOS5",44,0)
 ;k @mapfil@("direct"),@mapfil@("inverse")
"RTN","SYNQOS5",45,0)
 q
"RTN","SYNQOS5",46,0)
 ;
"RTN","SYNQOS5",47,0)
build ; build maps from raw data file
"RTN","SYNQOS5",48,0)
 f  s n=$o(@root@(n)) q:+n=0  d  ;
"RTN","SYNQOS5",49,0)
 . s sct=$g(@root@(n,"sct"))
"RTN","SYNQOS5",50,0)
 . s os5=$g(@root@(n,"os5"))
"RTN","SYNQOS5",51,0)
 . s name=$g(@root@(n,"text"))
"RTN","SYNQOS5",52,0)
 .q:sct=""
"RTN","SYNQOS5",53,0)
 .q:os5=""
"RTN","SYNQOS5",54,0)
 .s @mapfil@("direct",sct,os5,n)=name
"RTN","SYNQOS5",55,0)
 .s @mapfil@("inverse",os5,sct,n)=name
"RTN","SYNQOS5",56,0)
 q
"RTN","SYNQOS5",57,0)
 ;
"RTN","SYNQOS5",58,0)
idprocs ; build graphs of all the procedure codes 
"RTN","SYNQOS5",59,0)
 ;
"RTN","SYNQOS5",60,0)
 n outroot s outroot=$$setroot^%wd("procedure-codes")
"RTN","SYNQOS5",61,0)
 s outroot=$na(@outroot@("procedure-codes"))
"RTN","SYNQOS5",62,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNQOS5",63,0)
 ;
"RTN","SYNQOS5",64,0)
 n zi,zj,json
"RTN","SYNQOS5",65,0)
 s zi=""
"RTN","SYNQOS5",66,0)
 f  s zi=$o(@root@(zi)) q:zi=" "  d  ;
"RTN","SYNQOS5",67,0)
 . d getIntakeFhir^SYNFHIR("json",,"Procedure",zi,1)
"RTN","SYNQOS5",68,0)
 . s zj=""
"RTN","SYNQOS5",69,0)
 . f  s zj=$o(json("entry",zj)) q:zj=""  d  ;
"RTN","SYNQOS5",70,0)
 . . n rroot s rroot=$na(json("entry",zj,"resource"))
"RTN","SYNQOS5",71,0)
 . . n cde,txt,sys
"RTN","SYNQOS5",72,0)
 . . s cde=$g(@rroot@("code","coding",1,"code"))
"RTN","SYNQOS5",73,0)
 . . s sys=$g(@rroot@("code","coding",1,"system"))
"RTN","SYNQOS5",74,0)
 . . s txt=$g(@rroot@("code","text"))
"RTN","SYNQOS5",75,0)
 . . q:cde=""
"RTN","SYNQOS5",76,0)
 . . q:$d(@outroot@("sct",cde))
"RTN","SYNQOS5",77,0)
 . . n os5
"RTN","SYNQOS5",78,0)
 . . s os5=$$genos5^SYNFUTL(cde)
"RTN","SYNQOS5",79,0)
 . . i $d(@outroot@("os5",os5)) d  b  ;
"RTN","SYNQOS5",80,0)
 . . . w !,"Error, duplication os5 code: ",os5
"RTN","SYNQOS5",81,0)
 . . n pien s pien=$o(@outroot@(" "),-1)+1
"RTN","SYNQOS5",82,0)
 . . s @outroot@(pien,"sct")=cde
"RTN","SYNQOS5",83,0)
 . . s @outroot@(pien,"text")=txt
"RTN","SYNQOS5",84,0)
 . . s @outroot@(pien,"system")=sys
"RTN","SYNQOS5",85,0)
 . . s @outroot@(pien,"os5")=os5
"RTN","SYNQOS5",86,0)
 . . s @outroot@("sct",cde,pien)=""
"RTN","SYNQOS5",87,0)
 . . s @outroot@("os5",os5,pien)=""
"RTN","SYNQOS5",88,0)
 q
"RTN","SYNQOS5",89,0)
 ;
"RTN","SYNQOS5",90,0)
idvisits ; build graphs of all the visit codes 
"RTN","SYNQOS5",91,0)
 ;
"RTN","SYNQOS5",92,0)
 n outroot s outroot=$$setroot^%wd("visit-codes")
"RTN","SYNQOS5",93,0)
 s outroot=$na(@outroot@("visit-codes"))
"RTN","SYNQOS5",94,0)
 n root s root=$$setroot^%wd("fhir-intake")
"RTN","SYNQOS5",95,0)
 ;
"RTN","SYNQOS5",96,0)
 n zi,zj,json
"RTN","SYNQOS5",97,0)
 s zi=""
"RTN","SYNQOS5",98,0)
 f  s zi=$o(@root@(zi)) q:zi=" "  d  ;
"RTN","SYNQOS5",99,0)
 . d getIntakeFhir^SYNFHIR("json",,"Encounter",zi,1)
"RTN","SYNQOS5",100,0)
 . s zj=""
"RTN","SYNQOS5",101,0)
 . f  s zj=$o(json("entry",zj)) q:zj=""  d  ;
"RTN","SYNQOS5",102,0)
 . . n rroot s rroot=$na(json("entry",zj,"resource"))
"RTN","SYNQOS5",103,0)
 . . n cde,txt,sys
"RTN","SYNQOS5",104,0)
 . . s cde=$g(@rroot@("type",1,"coding",1,"code"))
"RTN","SYNQOS5",105,0)
 . . s sys=$g(@rroot@("type",1,"coding",1,"system"))
"RTN","SYNQOS5",106,0)
 . . s txt=$g(@rroot@("type",1,"text"))
"RTN","SYNQOS5",107,0)
 . . q:cde=""
"RTN","SYNQOS5",108,0)
 . . q:$d(@outroot@("sct",cde))
"RTN","SYNQOS5",109,0)
 . . n os5
"RTN","SYNQOS5",110,0)
 . . s os5=$$genos5^SYNFUTL(cde)
"RTN","SYNQOS5",111,0)
 . . i $d(@outroot@("os5",os5)) d  b  ;
"RTN","SYNQOS5",112,0)
 . . . w !,"Error, duplication os5 code: ",os5
"RTN","SYNQOS5",113,0)
 . . n pien s pien=$o(@outroot@(" "),-1)+1
"RTN","SYNQOS5",114,0)
 . . s @outroot@(pien,"sct")=cde
"RTN","SYNQOS5",115,0)
 . . s @outroot@(pien,"text")=txt
"RTN","SYNQOS5",116,0)
 . . s @outroot@(pien,"system")=sys
"RTN","SYNQOS5",117,0)
 . . s @outroot@(pien,"os5")=os5
"RTN","SYNQOS5",118,0)
 . . s @outroot@("sct",cde,pien)=""
"RTN","SYNQOS5",119,0)
 . . s @outroot@("os5",os5,pien)=""
"RTN","SYNQOS5",120,0)
 q
"RTN","SYNQOS5",121,0)
 ;
"RTN","SYNQOS5",122,0)
testicd9 ;
"RTN","SYNQOS5",123,0)
 n root s root=$$setroot^%wd("mapping-errors")
"RTN","SYNQOS5",124,0)
 n zi s zi=""
"RTN","SYNQOS5",125,0)
 n cnt s cnt=0
"RTN","SYNQOS5",126,0)
 f  s zi=$o(@root@("errors",zi)) q:+zi=0  d  ;
"RTN","SYNQOS5",127,0)
 . n zmap,sct
"RTN","SYNQOS5",128,0)
 . s sct=@root@("errors",zi,"code")
"RTN","SYNQOS5",129,0)
 . s zmap=$$MAP^SYNDHPMP("sct2icdnine",sct)
"RTN","SYNQOS5",130,0)
 . i +zmap'=-1 d  ;
"RTN","SYNQOS5",131,0)
 . . s cnt=cnt+1
"RTN","SYNQOS5",132,0)
 . . s @root@("errors",zi,"fixed")=1
"RTN","SYNQOS5",133,0)
 w !,"fixed count= ",cnt
"RTN","SYNQOS5",134,0)
 q
"RTN","SYNQOS5",135,0)
 ;
"RTN","SYNQOS5",136,0)
addicd9(icd9,sct,txt) ; adds a sct to icd9 mapping
"RTN","SYNQOS5",137,0)
 ; returns -1 if already there
"RTN","SYNQOS5",138,0)
 n root s root=$na(^SYN("2002.030","sct2icdnine"))
"RTN","SYNQOS5",139,0)
 i $d(@root@("direct",sct)) q -1
"RTN","SYNQOS5",140,0)
 s @root@("direct",sct,icd9)=$g(txt)
"RTN","SYNQOS5",141,0)
 s @root@("indirect",icd9,sct)=$g(txt)
"RTN","SYNQOS5",142,0)
 q "ok"
"RTN","SYNQOS5",143,0)
 ;
"RTN","SYNQOS5",144,0)
addnancy ; add Nancy's mappings
"RTN","SYNQOS5",145,0)
 N G
"RTN","SYNQOS5",146,0)
 S G(461.9,444814009,"Viral sinusitis")=""
"RTN","SYNQOS5",147,0)
 S G("V22",404684003,"Normal Pregnancy")=""
"RTN","SYNQOS5",148,0)
 s G(790.21,15777000,"Prediabetes")=""
"RTN","SYNQOS5",149,0)
 S G(473.9,40055000,"Chronic sinusitis (disorder)")=""
"RTN","SYNQOS5",150,0)
 S G(401.9,38341003,"Hypertensive Disorder")=""
"RTN","SYNQOS5",151,0)
 S G(314.01,192127007,"Child attention deficit disorder")=""
"RTN","SYNQOS5",152,0)
 S G(493.9,195967001,"Asthma or Airway hyperreactivity")=""
"RTN","SYNQOS5",153,0)
 S G(462,195662009,"Acute viral pharyngitis")=""
"RTN","SYNQOS5",154,0)
 S G(461,36971009,"Sinusitis")=""
"RTN","SYNQOS5",155,0)
 ;S G(,308335008,"Patient encounter (procedure)")=""
"RTN","SYNQOS5",156,0)
 N ZI,ICD9,SCT,TXT
"RTN","SYNQOS5",157,0)
 S ZI=""
"RTN","SYNQOS5",158,0)
 F  S ZI=$O(G(ZI)) Q:ZI=""  D  ;
"RTN","SYNQOS5",159,0)
 . S ICD9=ZI
"RTN","SYNQOS5",160,0)
 . S SCT=$O(G(ICD9,""))
"RTN","SYNQOS5",161,0)
 . S TXT=$O(G(ICD9,SCT,""))
"RTN","SYNQOS5",162,0)
 . S OK=$$addicd9(ICD9,SCT,TXT)
"RTN","SYNQOS5",163,0)
 Q
"RTN","SYNQOS5",164,0)
 ;
"RTN","SYNRGMON")
0^46^B2282303
"RTN","SYNRGMON",1,0)
SYNRGMON ; AFHIL/fjf - HealthConcourse - REST server monitor ; 17-July-2018
"RTN","SYNRGMON",2,0)
 ;;1.0;Health Concourse;;Jan 17, 2017;Build 53
"RTN","SYNRGMON",3,0)
 ;;
"RTN","SYNRGMON",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNRGMON",5,0)
 ; 
"RTN","SYNRGMON",6,0)
 ; RGNETTCP
"RTN","SYNRGMON",7,0)
 ; Monitor REST server RGNETTCP - the REST server for the Perspecta FHIR resource GETters 
"RTN","SYNRGMON",8,0)
 ; and if it is stopped restart it
"RTN","SYNRGMON",9,0)
 ; this is a keep alive necessitated because some external
"RTN","SYNRGMON",10,0)
 ; unidentifiable event repeatedly crashed RGNETTCP 
"RTN","SYNRGMON",11,0)
 ; 
"RTN","SYNRGMON",12,0)
 ; The monitor is started by running 'START' in this routine.
"RTN","SYNRGMON",13,0)
 ; The monitor is stopped by running 'STOP' in this routine.
"RTN","SYNRGMON",14,0)
 ;
"RTN","SYNRGMON",15,0)
 ;   note: this routine makes use of Intersystems proprietary technology
"RTN","SYNRGMON",16,0)
 ;         and is unlikely to run well on other M implementations
"RTN","SYNRGMON",17,0)
 ;
"RTN","SYNRGMON",18,0)
CTRL ; 
"RTN","SYNRGMON",19,0)
 S $ZT="^ZTER"
"RTN","SYNRGMON",20,0)
 S U="^"
"RTN","SYNRGMON",21,0)
 F  D  I $G(^SYNRGERR("STATE"))="HALT" Q
"RTN","SYNRGMON",22,0)
 .HANG 5
"RTN","SYNRGMON",23,0)
 .D MONITOR
"RTN","SYNRGMON",24,0)
 Q
"RTN","SYNRGMON",25,0)
 ;
"RTN","SYNRGMON",26,0)
MONITOR ; This 
"RTN","SYNRGMON",27,0)
 ;
"RTN","SYNRGMON",28,0)
 ; build job array
"RTN","SYNRGMON",29,0)
 s $znspace="%SYS"
"RTN","SYNRGMON",30,0)
 D BUILDold^SS
"RTN","SYNRGMON",31,0)
 ;
"RTN","SYNRGMON",32,0)
 ; scan JOB array checking for routine RGNETTCP
"RTN","SYNRGMON",33,0)
 s RGNETTCP="not running"
"RTN","SYNRGMON",34,0)
 s jobidx=""
"RTN","SYNRGMON",35,0)
 f  s jobidx=$o(JOB(0,jobidx)) q:jobidx=""  q:RGNETTCP="running"  d
"RTN","SYNRGMON",36,0)
 .s jobno=JOB(0,jobidx)
"RTN","SYNRGMON",37,0)
 .s jobinfo=$$JobVw^SS(jobno)
"RTN","SYNRGMON",38,0)
 .i $p(jobinfo,U,6)="RGNETTCP" s RGNETTCP="running"
"RTN","SYNRGMON",39,0)
 ;
"RTN","SYNRGMON",40,0)
 s $znspace="VEHU"
"RTN","SYNRGMON",41,0)
 ;
"RTN","SYNRGMON",42,0)
 ; if server isn't running restart it
"RTN","SYNRGMON",43,0)
 i RGNETTCP="not running" d STARTALL^RGNETTCP
"RTN","SYNRGMON",44,0)
 q
"RTN","SYNRGMON",45,0)
 ;
"RTN","SYNRGMON",46,0)
START ;
"RTN","SYNRGMON",47,0)
 S ^SYNRGERR("STATE")="RUN"
"RTN","SYNRGMON",48,0)
 J ^SYNRGMON
"RTN","SYNRGMON",49,0)
 Q
"RTN","SYNRGMON",50,0)
 ;
"RTN","SYNRGMON",51,0)
STOP ;
"RTN","SYNRGMON",52,0)
 S ^SYNRGERR("STATE")="HALT"
"RTN","SYNRGMON",53,0)
 Q
"RTN","SYNRGMON",54,0)
 
"RTN","SYNRGMON1")
0^47^B1845138
"RTN","SYNRGMON1",1,0)
SYNRGMON1 ; AFHIL/fjf - HealthConcourse - REST server monitor
"RTN","SYNRGMON1",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNRGMON1",3,0)
 ;;
"RTN","SYNRGMON1",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNRGMON1",5,0)
 ;
"RTN","SYNRGMON1",6,0)
 ; Monitor REST server RGNETTCP
"RTN","SYNRGMON1",7,0)
 ; If it is stopped restart it
"RTN","SYNRGMON1",8,0)
 ; 
"RTN","SYNRGMON1",9,0)
 ;Q
"RTN","SYNRGMON1",10,0)
 ;
"RTN","SYNRGMON1",11,0)
 ;
"RTN","SYNRGMON1",12,0)
CTRL1 ;
"RTN","SYNRGMON1",13,0)
 S $ZT="^ZTER"
"RTN","SYNRGMON1",14,0)
 S U="^"
"RTN","SYNRGMON1",15,0)
 K ^ZZFFER
"RTN","SYNRGMON1",16,0)
 F  D  I $G(^SYNRGERR("STOP"))="HALT" Q
"RTN","SYNRGMON1",17,0)
 .HANG 5
"RTN","SYNRGMON1",18,0)
 .D MONITOR
"RTN","SYNRGMON1",19,0)
 Q
"RTN","SYNRGMON1",20,0)
 ;
"RTN","SYNRGMON1",21,0)
 ;
"RTN","SYNRGMON1",22,0)
MONITOR ;
"RTN","SYNRGMON1",23,0)
 ;
"RTN","SYNRGMON1",24,0)
 ;build job array
"RTN","SYNRGMON1",25,0)
 s $znspace="%SYS"
"RTN","SYNRGMON1",26,0)
 D BUILDold^SS
"RTN","SYNRGMON1",27,0)
 ;scan JOB array checking for routine RGNETTCP
"RTN","SYNRGMON1",28,0)
 s RGNETTCP="not running"
"RTN","SYNRGMON1",29,0)
 s jobidx=""
"RTN","SYNRGMON1",30,0)
 f  s jobidx=$o(JOB(0,jobidx),1,jobno) q:jobidx=""  q:RGNETTCP="running"  d
"RTN","SYNRGMON1",31,0)
 .s jobinfo=$$JobVw^SS(jobno)
"RTN","SYNRGMON1",32,0)
 .i $p(jobinfo,U,6)="RGNETTCP" s RGNETTCP="running"
"RTN","SYNRGMON1",33,0)
 s $znspace="VEHU"
"RTN","SYNRGMON1",34,0)
 i RGNETTCP="not running" d STARTALL^RGNETTCP
"RTN","SYNRGMON1",35,0)
 q
"RTN","SYNRGMON1",36,0)
 ;
"RTN","SYNRGMON1",37,0)
 ;
"RTN","SYNRGMON1",38,0)
START ;
"RTN","SYNRGMON1",39,0)
 J ^SYNRGMON1
"RTN","SYNRGMON1",40,0)
 Q
"RTN","SYNRGMON1",41,0)
 ;
"RTN","SYNTSTAPI")
0^117^B11160876
"RTN","SYNTSTAPI",1,0)
SYNTSTAPI ; HC/art - HealthConcourse - run in code unit tests ;05/07/2019
"RTN","SYNTSTAPI",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNTSTAPI",3,0)
 ;;
"RTN","SYNTSTAPI",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNTSTAPI",5,0)
 ;
"RTN","SYNTSTAPI",6,0)
 QUIT
"RTN","SYNTSTAPI",7,0)
 ;
"RTN","SYNTSTAPI",8,0)
EN ;Run unit tests
"RTN","SYNTSTAPI",9,0)
 ;
"RTN","SYNTSTAPI",10,0)
 N STARTTM S STARTTM=$$NOW^XLFDT()
"RTN","SYNTSTAPI",11,0)
 ;
"RTN","SYNTSTAPI",12,0)
 W !!,"----- Patient Vitals",!!
"RTN","SYNTSTAPI",13,0)
 D T1^SYNDHP01
"RTN","SYNTSTAPI",14,0)
 D T2^SYNDHP01
"RTN","SYNTSTAPI",15,0)
 W !!,"----- Patient Immunizations",!!
"RTN","SYNTSTAPI",16,0)
 D T1^SYNDHP02
"RTN","SYNTSTAPI",17,0)
 D T2^SYNDHP02
"RTN","SYNTSTAPI",18,0)
 W !!,"----- Patient Conditions",!!
"RTN","SYNTSTAPI",19,0)
 D T1^SYNDHP03
"RTN","SYNTSTAPI",20,0)
 W !!,"----- Patients with a Condition",!!
"RTN","SYNTSTAPI",21,0)
 D T2^SYNDHP03
"RTN","SYNTSTAPI",22,0)
 D T3^SYNDHP03
"RTN","SYNTSTAPI",23,0)
 W !!,"----- Patient Procedures",!!
"RTN","SYNTSTAPI",24,0)
 D T1^SYNDHP04
"RTN","SYNTSTAPI",25,0)
 W !!,"----- Patient Diagnostic Reports",!!
"RTN","SYNTSTAPI",26,0)
 D T1^SYNDHP05
"RTN","SYNTSTAPI",27,0)
 D T2^SYNDHP05
"RTN","SYNTSTAPI",28,0)
 W !!,"----- Institution Details for Hospital Location",!!
"RTN","SYNTSTAPI",29,0)
 D T1^SYNDHP06
"RTN","SYNTSTAPI",30,0)
 D T2^SYNDHP06
"RTN","SYNTSTAPI",31,0)
 W !!,"----- Patient Nursing Care Plan Goals",!!
"RTN","SYNTSTAPI",32,0)
 D T1^SYNDHP07
"RTN","SYNTSTAPI",33,0)
 D T2^SYNDHP07
"RTN","SYNTSTAPI",34,0)
 W !!,"----- Patient Flags",!!
"RTN","SYNTSTAPI",35,0)
 D T1^SYNDHP08
"RTN","SYNTSTAPI",36,0)
 D T2^SYNDHP08
"RTN","SYNTSTAPI",37,0)
 W !!,"----- Patient Health Factors",!!
"RTN","SYNTSTAPI",38,0)
 D T1^SYNDHP09
"RTN","SYNTSTAPI",39,0)
 D T2^SYNDHP09
"RTN","SYNTSTAPI",40,0)
 ;D HLFTEST0^SYNDHP09
"RTN","SYNTSTAPI",41,0)
 ;D HLFTEST1^SYNDHP09
"RTN","SYNTSTAPI",42,0)
 W !!,"----- Patient Encounters",!!
"RTN","SYNTSTAPI",43,0)
 D T1^SYNDHP40
"RTN","SYNTSTAPI",44,0)
 W !!,"----- Patient Appointments",!!
"RTN","SYNTSTAPI",45,0)
 D T1^SYNDHP41
"RTN","SYNTSTAPI",46,0)
 W !!,"----- validate patient",!!
"RTN","SYNTSTAPI",47,0)
 D TESTP^SYNDHP43
"RTN","SYNTSTAPI",48,0)
 D TESTF1^SYNDHP43
"RTN","SYNTSTAPI",49,0)
 D TESTF2^SYNDHP43
"RTN","SYNTSTAPI",50,0)
 D TESTF3^SYNDHP43
"RTN","SYNTSTAPI",51,0)
 D TESTF4^SYNDHP43
"RTN","SYNTSTAPI",52,0)
 D TESTF5^SYNDHP43
"RTN","SYNTSTAPI",53,0)
 D T3^SYNDHP43
"RTN","SYNTSTAPI",54,0)
 W !!,"----- Patient Demographics",!!
"RTN","SYNTSTAPI",55,0)
 D T1^SYNDHP47
"RTN","SYNTSTAPI",56,0)
 D T2^SYNDHP47
"RTN","SYNTSTAPI",57,0)
 D T3^SYNDHP47
"RTN","SYNTSTAPI",58,0)
 D T4^SYNDHP47
"RTN","SYNTSTAPI",59,0)
 ;D T5^SYNDHP47
"RTN","SYNTSTAPI",60,0)
 D DEMTEST0^SYNDHP47
"RTN","SYNTSTAPI",61,0)
 W !!,"----- Patient Medication Statement",!!
"RTN","SYNTSTAPI",62,0)
 ;D T1^SYNDHP48
"RTN","SYNTSTAPI",63,0)
 D T6^SYNDHP48
"RTN","SYNTSTAPI",64,0)
 W !!,"----- Patient Medication Dispense",!!
"RTN","SYNTSTAPI",65,0)
 ;D T2^SYNDHP48
"RTN","SYNTSTAPI",66,0)
 D T5^SYNDHP48
"RTN","SYNTSTAPI",67,0)
 W !!,"----- Patient Medication Administration",!!
"RTN","SYNTSTAPI",68,0)
 ;D T3^SYNDHP48
"RTN","SYNTSTAPI",69,0)
 D T4^SYNDHP48
"RTN","SYNTSTAPI",70,0)
 W !!,"----- Patient Providers for Encounters",!!
"RTN","SYNTSTAPI",71,0)
 D T1^SYNDHP54
"RTN","SYNTSTAPI",72,0)
 D T2^SYNDHP54
"RTN","SYNTSTAPI",73,0)
 W !!,"----- Patient Observations",!!
"RTN","SYNTSTAPI",74,0)
 D T1^SYNDHP56
"RTN","SYNTSTAPI",75,0)
 W !!,"----- Patient Allergies",!!
"RTN","SYNTSTAPI",76,0)
 D T1^SYNDHP57
"RTN","SYNTSTAPI",77,0)
 D T2^SYNDHP57
"RTN","SYNTSTAPI",78,0)
 D ALLTEST0^SYNDHP57
"RTN","SYNTSTAPI",79,0)
 ;D PROTEST^SYNDHP57
"RTN","SYNTSTAPI",80,0)
 W !!,"----- Care Team",!!
"RTN","SYNTSTAPI",81,0)
 D T1^SYNDHP58
"RTN","SYNTSTAPI",82,0)
 D T2^SYNDHP58
"RTN","SYNTSTAPI",83,0)
 W !!,"----- Care Teams",!!
"RTN","SYNTSTAPI",84,0)
 D T3^SYNDHP58
"RTN","SYNTSTAPI",85,0)
 D T4^SYNDHP58
"RTN","SYNTSTAPI",86,0)
 W !!,"----- Patient Care Plans",!!
"RTN","SYNTSTAPI",87,0)
 D T1^SYNDHP59
"RTN","SYNTSTAPI",88,0)
 D T2^SYNDHP59
"RTN","SYNTSTAPI",89,0)
 W !!,"----- Patient Care Plan for a Visit",!!
"RTN","SYNTSTAPI",90,0)
 D T3^SYNDHP59
"RTN","SYNTSTAPI",91,0)
 D T4^SYNDHP59
"RTN","SYNTSTAPI",92,0)
 W !!,"----- Patient TIU Notes",!!
"RTN","SYNTSTAPI",93,0)
 D T1^SYNDHP67
"RTN","SYNTSTAPI",94,0)
 D T2^SYNDHP67
"RTN","SYNTSTAPI",95,0)
 D T3^SYNDHP67
"RTN","SYNTSTAPI",96,0)
 W !!,"----- M Unit Test",!!
"RTN","SYNTSTAPI",97,0)
 ;D T1^SYNDHP69
"RTN","SYNTSTAPI",98,0)
 W !!,"----- VistA Record by Resource ID",!!
"RTN","SYNTSTAPI",99,0)
 D T1^SYNDHP99
"RTN","SYNTSTAPI",100,0)
 ;
"RTN","SYNTSTAPI",101,0)
 N ENDTM S ENDTM=$$NOW^XLFDT()
"RTN","SYNTSTAPI",102,0)
 N ELAPSED S ELAPSED=$$FMDIFF^XLFDT(ENDTM,STARTTM,3)
"RTN","SYNTSTAPI",103,0)
 ;
"RTN","SYNTSTAPI",104,0)
 W !!,"Start time:   ",$$FMTE^XLFDT(STARTTM,7),!
"RTN","SYNTSTAPI",105,0)
 W "End time:     ",$$FMTE^XLFDT(ENDTM,7),!
"RTN","SYNTSTAPI",106,0)
 W "Elapsed time: ",ELAPSED,!
"RTN","SYNTSTAPI",107,0)
 ;
"RTN","SYNTSTAPI",108,0)
 QUIT
"RTN","SYNTSTAPI",109,0)
 ;
"RTN","SYNTSTRS")
0^113^B106021021
"RTN","SYNTSTRS",1,0)
SYNTSTRS ; HC/art - HealthConcourse - test rest services ;05/08/2019
"RTN","SYNTSTRS",2,0)
 ;;1.0;DHP;;Jan 17, 2017;Build 53
"RTN","SYNTSTRS",3,0)
 ;;
"RTN","SYNTSTRS",4,0)
 ;;Original routine authored by Andrew Thompson & Ferdinand Frankson of Perspecta 2017-2019
"RTN","SYNTSTRS",5,0)
 ;
"RTN","SYNTSTRS",6,0)
 QUIT
"RTN","SYNTSTRS",7,0)
 ;
"RTN","SYNTSTRS",8,0)
EN ;Run service tests
"RTN","SYNTSTRS",9,0)
 ;
"RTN","SYNTSTRS",10,0)
 W #,!,?10,"HealthConcourse Get VistA Data REST Services Unit Tests",!
"RTN","SYNTSTRS",11,0)
 ;
"RTN","SYNTSTRS",12,0)
 N X,Y,DIR,DTOUT,DUOUT,DIRUT,DIROUT
"RTN","SYNTSTRS",13,0)
 S DIR(0)="SO^G:General Service Tests;I:ICN Batch Tests;U:Unit Tests"
"RTN","SYNTSTRS",14,0)
 S DIR("A")="Type"
"RTN","SYNTSTRS",15,0)
 ;S DIR("B")=""
"RTN","SYNTSTRS",16,0)
 D ^DIR
"RTN","SYNTSTRS",17,0)
 I $D(DTOUT)!$D(DUOUT)!$D(DIRUT)!$D(DIROUT) QUIT
"RTN","SYNTSTRS",18,0)
 N TYPE S TYPE=Y
"RTN","SYNTSTRS",19,0)
 ;
"RTN","SYNTSTRS",20,0)
 I TYPE="U" D UT
"RTN","SYNTSTRS",21,0)
 I TYPE="G" D UI
"RTN","SYNTSTRS",22,0)
 I TYPE="I" D
"RTN","SYNTSTRS",23,0)
 . N X,Y,DIR,DTOUT,DUOUT,DIRUT,DIROUT
"RTN","SYNTSTRS",24,0)
 . S DIR(0)="NAO^0:99999999"
"RTN","SYNTSTRS",25,0)
 . S DIR("A")="Number of ICNs, 0 for All: "
"RTN","SYNTSTRS",26,0)
 . ;S DIR("B")=""